<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype (Code 9 UI + Upgrades)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* ===== RESET ===== */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, rgba(30,41,59,.85) 0, transparent 45%),
        radial-gradient(circle at 80% 0%, rgba(15,118,110,.45) 0, transparent 45%),
        radial-gradient(circle at 50% 100%, rgba(30,64,175,.35) 0, transparent 50%),
        #050b16;
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    .card{
      width:min(520px, 100%);
      border-radius:28px;
      background:linear-gradient(180deg, rgba(2,6,23,.55), rgba(2,6,23,.35));
      border:1px solid rgba(148,163,184,.16);
      box-shadow:0 20px 70px rgba(0,0,0,.45);
      padding:18px;
    }

    .hdr{
      text-align:center;
      padding:8px 6px 10px;
    }
    .hdr h1{
      font-weight:800;
      letter-spacing:.5px;
      font-size:34px;
      color:#8dd6ff;
      text-shadow:0 0 20px rgba(56,189,248,.15);
    }
    .hdr .sub{
      margin-top:6px;
      font-size:13px;
      line-height:1.45;
      opacity:.85;
    }

    .ethic{
      margin:14px 0;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid rgba(234,179,8,.22);
      background:rgba(2,6,23,.35);
      color:#facc15;
      font-size:13.5px;
      line-height:1.5;
      text-align:center;
    }

    .pill{
      margin:14px 0 16px;
      text-align:center;
      padding:14px 16px;
      border-radius:999px;
      background:linear-gradient(90deg, rgba(56,189,248,.35), rgba(20,184,166,.25));
      border:1px solid rgba(148,163,184,.18);
      font-weight:800;
      letter-spacing:.7px;
      color:#cfefff;
    }

    .panel{
      border-radius:22px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.35);
      padding:16px;
    }

    .topRow{
      display:flex;
      justify-content:flex-start;
      gap:12px;
      align-items:center;
      margin-bottom:12px;
    }

    .btn{
      border:1px solid rgba(148,163,184,.18);
      background:rgba(15,23,42,.65);
      color:#e5e7eb;
      padding:11px 14px;
      border-radius:18px;
      cursor:pointer;
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(56,189,248,.35)}
    .btn:active{transform:translateY(0px);opacity:.95}
    .btnSmall{padding:8px 12px;border-radius:14px;font-size:12px}
    .danger{border-color:rgba(239,68,68,.35)}
    .danger:hover{border-color:rgba(239,68,68,.55)}

    #btnOptions{
      display:flex;align-items:center;gap:10px;
      padding:12px 16px;
      border-radius:999px;
      min-width:140px;
    }
    .gear{opacity:.9}

    /* FIX: options menu selector */
    #optionsMenu{
      display:none;
      margin-top:10px;
      padding:14px;
      border-radius:20px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.25);
    }
    .menuGrid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
    }
    .menuItem{
      border-radius:16px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(15,23,42,.55);
      padding:12px 10px;
      text-align:center;
      cursor:pointer;
      transition:.15s ease;
      display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;
      min-height:70px;
    }
    .menuItem:hover{transform:translateY(-1px);border-color:rgba(56,189,248,.35)}
    .miTop{display:flex;gap:10px;align-items:center;font-weight:700}
    .miPill{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.14);
      opacity:.95;
    }
    .pillOn{background:rgba(34,197,94,.14);border-color:rgba(34,197,94,.25)}
    .pillOff{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.20)}
    .pillOpen{background:rgba(14,165,233,.12);border-color:rgba(14,165,233,.25)}
    .pillNone{background:rgba(244,63,94,.10);border-color:rgba(244,63,94,.22)}
    @media(max-width:420px){
      .menuGrid{grid-template-columns:repeat(3,1fr)}
      .hdr h1{font-size:30px}
    }

    .console{
      margin-top:14px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.35);
      padding:12px;
      min-height:230px;
      max-height:330px;
      overflow:auto;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:13px;
      line-height:1.55;
      color:#dbeafe;
    }
    .line{white-space:pre-wrap}
    .you{color:#f1f5f9}
    .aura{color:#a7f3d0}
    .ts{opacity:.7}

    .stats{
      margin-top:14px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.35);
      padding:12px 14px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:13px;
      opacity:.95;
    }

    .inputRow{
      margin-top:12px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    #userInput{
      flex:1;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(15,23,42,.55);
      color:#e5e7eb;
      padding:12px 14px;
      border-radius:999px;
      outline:none;
    }
    #btnSend{
      padding:12px 18px;
      border-radius:999px;
      background:linear-gradient(90deg, rgba(56,189,248,.55), rgba(20,184,166,.35));
      border:1px solid rgba(56,189,248,.28);
      font-weight:800;
      color:#e6fbff;
    }

    .formula{
      margin-top:10px;
      text-align:center;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:13px;
      opacity:.85;
    }

    /* ===== Modals ===== */
    .modalOverlay{
      position:fixed;inset:0;
      display:none;
      align-items:flex-end;
      justify-content:center;
      background:rgba(0,0,0,.45);
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(560px, 100%);
      border-radius:22px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.92);
      box-shadow:0 30px 90px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px 12px;
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      border-bottom:1px solid rgba(148,163,184,.12);
    }
    .modalTitle{font-weight:900;font-size:16px}
    .modalSub{font-size:12.5px;opacity:.78;margin-top:2px}
    .closeX{cursor:pointer;opacity:.8;font-size:18px}
    .modalBody{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    textarea, input[type="text"]{
      width:100%;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(15,23,42,.65);
      color:#e5e7eb;
      padding:12px 12px;
      border-radius:16px;
      outline:none;
      min-height:110px;
      resize:vertical;
    }
    .hint{opacity:.75;font-size:12px;margin-top:8px}

    /* BM modal layout */
    .bmWrap{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:520px){.bmWrap{grid-template-columns:1fr}}
    .bmLeft,.bmRight{
      border:1px solid rgba(148,163,184,.12);
      background:rgba(15,23,42,.35);
      border-radius:18px;
      padding:12px;
      min-height:180px;
    }
    .bmList{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .bmItem{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.12);
      background:rgba(2,6,23,.35);
      cursor:pointer;
    }
    .bmItem:hover{border-color:rgba(56,189,248,.30)}
    .bmTitle{font-weight:800;font-size:13px}
    .bmMeta{font-size:12px;opacity:.75;margin-top:2px}
    .bmRight .bmTop{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .bmRight .bmSub{font-size:12px;opacity:.8;margin:6px 0 10px}
    .bmBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    /* BM date filter + evidence */
    .bmTools{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0 6px}
    .inp{background:rgba(15,23,42,.85);border:1px solid rgba(148,163,184,.18);color:#e2e8f0;border-radius:12px;padding:10px 12px}
    .bmAttachBar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    .bmFiles{margin-top:8px;display:flex;flex-direction:column;gap:10px}
    .fileRow{border:1px solid rgba(148,163,184,.14);background:rgba(2,6,23,.45);border-radius:14px;padding:10px}
    .fileName{font-size:13px;color:#e2e8f0}
    .fileType{opacity:.7;font-size:12px}
    .fileActions{display:flex;gap:8px;margin-top:8px}
    .filePreview{margin-top:10px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(148,163,184,.18);border-radius:999px;padding:2px 8px;font-size:11px;opacity:.9}
    .badge.lock{background:rgba(14,165,233,.10)}
    .badge.file{background:rgba(34,197,94,.10)}
    .bmTitleRow{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .bmBadges{display:flex;gap:6px;flex-wrap:wrap}
  </style>
</head>

<body>
  <div class="card">
    <div class="hdr">
      <h1>AURA-X Œ©</h1>
      <div class="sub">
        Offline emotional continuity engine (prototype)<br/>
        TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory.
      </div>
    </div>

    <div class="ethic">
      <b>Universal ethic:</b> avoid actions that grow negative emotions in you or others.
      Move gently toward choices that increase shared positive feeling for everyone.
    </div>

    <div class="pill">EMOTIONAL CONTINUITY ENGINE ‚Äî ACTIVE</div>

    <div class="panel">
      <div class="topRow">
        <button class="btn" id="btnOptions"><span class="gear">‚öôÔ∏è</span> Options</button>
      </div>

      <div id="optionsMenu">
        <div class="menuGrid">
          <div class="menuItem" id="miVoice">
            <div class="miTop"><span>üéôÔ∏è</span> <span>Voice</span></div>
            <div class="miPill pillOn" id="pillVoice">on</div>
          </div>
          <div class="menuItem" id="miIntel">
            <div class="miTop"><span>üß†</span> <span>Intelligence</span></div>
            <div class="miPill pillOpen" id="pillIntel">open</div>
          </div>
          <div class="menuItem" id="miLearning">
            <div class="miTop"><span>üìö</span> <span>Learning</span></div>
            <div class="miPill pillOn" id="pillLearning">on</div>
          </div>

          <div class="menuItem" id="miFeed">
            <div class="miTop"><span>üå±</span> <span>Feed</span></div>
            <div class="miPill pillOpen" id="pillFeed">open</div>
          </div>
          <div class="menuItem" id="miFaith">
            <div class="miTop"><span>üïäÔ∏è</span> <span>Faith</span></div>
            <div class="miPill pillNone" id="pillFaith">none</div>
          </div>
          <div class="menuItem" id="miIdentity">
            <div class="miTop"><span>ü™™</span> <span>Identity</span></div>
            <div class="miPill pillOpen" id="pillIdentity">open</div>
          </div>

          <div class="menuItem" id="miLLM">
            <div class="miTop"><span>üóÇÔ∏è</span> <span>LLM</span></div>
            <div class="miPill pillOpen" id="pillLLM">open</div>
          </div>
          <div class="menuItem" id="miBM">
            <div class="miTop"><span>üìò</span> <span>BM Recall</span></div>
            <div class="miPill pillOpen" id="pillBM">open</div>
          </div>
          <div class="menuItem" id="miHistory">
            <div class="miTop"><span>üìú</span> <span>History</span></div>
            <div class="miPill pillOpen" id="pillHistory">open</div>
          </div>
        </div>
      </div>

      <div class="console" id="consoleBox"></div>

      <div class="stats">
        <span id="statE0">E0: 0.000</span>
        <span id="statTM">TM: 0.00</span>
        <span id="statBM">BM: 0.00</span>
        <span id="statC">C: 0.850</span>
      </div>

      <div class="inputRow">
        <input id="userInput" type="text" autocomplete="off" placeholder="Talk to AURA-X Œ©‚Ä¶ (TM = your inputs)" />
        <button class="btn" id="btnSend">Send</button>
      </div>

      <div class="formula">
        E‚ÇÄ = tanh( R(TM,BM) + I(TM) + I<sub>intel</sub> + I<sub>LLM</sub> ‚àí D + Œª<sub>faith</sub> + Œª<sub>sys</sub> + Œª<sub>trc</sub> )
      </div>
    </div>
  </div>

  <!-- ===== Modals ===== -->

  <!-- Intelligence -->
  <div class="modalOverlay" id="modalIntel">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="modalTitle">Intelligence (local)</div>
          <div class="modalSub">Learned Q ‚Üí A pairs stored on your device.</div>
        </div>
        <div class="closeX" data-close="modalIntel">‚úï</div>
      </div>
      <div class="modalBody">
        <div class="row">
          <button class="btn btnSmall" id="btnExportIntel">Export JSON</button>
          <button class="btn btnSmall danger" id="btnClearIntel">Clear (double confirm)</button>
        </div>
        <div class="hint" id="intelCountHint"></div>
        <textarea id="intelArea" spellcheck="false"></textarea>
      </div>
    </div>
  </div>

  <!-- Feed the seed -->
  <div class="modalOverlay" id="modalSeed">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="modalTitle">üå± Feed the seed (protected)</div>
          <div class="modalSub"></div>
        </div>
        <div class="closeX" data-close="modalSeed">‚úï</div>
      </div>
      <div class="modalBody">
        <textarea id="seedTextArea" spellcheck="false"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn btnSmall" id="btnParseSeed">Parse block</button>
          <button class="btn btnSmall" id="btnSaveSeed">Save to seed</button>
          <button class="btn btnSmall danger" id="btnDiscardSeed">Discard</button>
        </div>
        <div class="hint" id="seedHint"></div>
      </div>
    </div>
  </div>

  <!-- Faith lenses -->
  <div class="modalOverlay" id="modalFaith">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="modalTitle">AURA-X Œ© options</div>
          <div class="modalSub">Optional faith lens for encouragement lines.</div>
        </div>
        <div class="closeX" data-close="modalFaith">‚úï</div>
      </div>
      <div class="modalBody">
        <div class="hint">Universal ethics are always active. You can optionally pick one or more faith lenses. Nothing is sent to any server.</div>
        <div class="row" style="margin-top:10px" id="faithButtons"></div>
      </div>
    </div>
  </div>

  <!-- Identity -->
  <div class="modalOverlay" id="modalIdentity">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="modalTitle">Identity (local)</div>
          <div class="modalSub">Your profile stays on your device.</div>
        </div>
        <div class="closeX" data-close="modalIdentity">‚úï</div>
      </div>
      <div class="modalBody">
        <textarea id="identityArea" spellcheck="false"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn btnSmall" id="btnSaveIdentity">Save</button>
          <button class="btn btnSmall danger" id="btnClearIdentity">Clear (double confirm)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- LLM -->
  <div class="modalOverlay" id="modalLLM">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="modalTitle">LLM</div>
          <div class="modalSub">This prototype runs local memory + simple continuity math first.</div>
        </div>
        <div class="closeX" data-close="modalLLM">‚úï</div>
      </div>
      <div class="modalBody">
        <div class="hint">
          If seed/intelligence do not match, you can later connect a real offline model (WebGPU) or an API. This build keeps everything local by default.
        </div>
      </div>
    </div>
  </div>

  <!-- BM Recall -->
  <div class="modalOverlay" id="modalBM">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="modalTitle">BM Recall</div>
          <div class="modalSub">Long memory (BM) saved locally with date + lock + evidence files.</div>
        </div>
        <div class="closeX" data-close="modalBM">‚úï</div>
      </div>
      <div class="modalBody">
        <div class="bmWrap">
          <div class="bmLeft">
            <div class="row">
              <button class="btn btnSmall" id="btnExportBM">Export</button>
              <button class="btn btnSmall danger" id="btnClearBM">Clear all (double confirm)</button>
            </div>

            <div class="bmTools">
              <input type="date" id="bmDateFilter" class="inp" />
              <button class="btn btnSmall" id="btnBMFilter">Filter</button>
              <button class="btn btnSmall" id="btnBMShowAll">Show all</button>
            </div>

            <div class="bmList" id="bmList"></div>
          </div>

          <div class="bmRight" id="bmViewer" style="display:none">
            <div class="bmTop">
              <div class="modalTitle" id="bmTitle">BM Prompt</div>
              <div id="bmLockIcon">üîí</div>
            </div>
            <div class="bmSub" id="bmMeta"></div>

            <div class="bmAttachBar">
              <input type="file" id="bmFileInput" accept="image/*,video/*,audio/*" />
              <button class="btn btnSmall" id="btnAddBMFile">Add evidence</button>
            </div>
            <div class="bmFiles" id="bmFiles"></div>

            <textarea id="bmTextArea" spellcheck="false"></textarea>

            <div class="bmBtns">
              <button class="btn btnSmall" id="btnCopyPrompt">Copy</button>
              <button class="btn btnSmall" id="btnAutoGen">Send to input</button>
              <button class="btn btnSmall" id="btnUnlockBM">Unlock</button>
              <button class="btn btnSmall danger" id="btnDeletePrompt">Delete</button>
            </div>
          </div>
        </div>
        <div class="hint">Tip: BM stores prompts by date. You can filter by date like ‚Äú2025-01-12‚Äù. Evidence files are saved in IndexedDB.</div>
      </div>
    </div>
  </div>

  <!-- History -->
  <div class="modalOverlay" id="modalHistory">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="modalTitle">Conversation History (TM)</div>
          <div class="modalSub">Temporary memory with auto-decay rules.</div>
        </div>
        <div class="closeX" data-close="modalHistory">‚úï</div>
      </div>
      <div class="modalBody">
        <div class="row">
          <button class="btn btnSmall" id="btnExportHistory">Export</button>
          <button class="btn btnSmall danger" id="btnClearHistory">Delete all (double confirm)</button>
        </div>
        <textarea id="historyArea" spellcheck="false"></textarea>
        <div class="hint" id="historyHint"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== Helpers =====
    const el = (id)=>document.getElementById(id);
    const nowTS = ()=>new Date().toLocaleTimeString([], {hour12:false});
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const escapeHTML = (s)=>String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

    function loadJSON(key, fallback){
      try{
        const v = localStorage.getItem(key);
        if(!v) return fallback;
        return JSON.parse(v);
      }catch(e){ return fallback; }
    }
    function saveJSON(key, val){
      localStorage.setItem(key, JSON.stringify(val));
    }

    // ===== IndexedDB (for BM evidence files) =====
    const DB_NAME = "aurax_db";
    const DB_VER  = 1;
    function openDB(){
      return new Promise((resolve,reject)=>{
        const req = indexedDB.open(DB_NAME, DB_VER);
        req.onupgradeneeded = ()=>{
          const db = req.result;
          if(!db.objectStoreNames.contains("bm_files")){
            db.createObjectStore("bm_files",{keyPath:"id"});
          }
        };
        req.onsuccess = ()=>resolve(req.result);
        req.onerror = ()=>reject(req.error);
      });
    }
    async function dbPut(storeName, obj){
      const db = await openDB();
      return new Promise((resolve,reject)=>{
        const tx = db.transaction(storeName,"readwrite");
        tx.objectStore(storeName).put(obj);
        tx.oncomplete = ()=>resolve(true);
        tx.onerror = ()=>reject(tx.error);
      });
    }
    async function dbGet(storeName, id){
      const db = await openDB();
      return new Promise((resolve,reject)=>{
        const tx = db.transaction(storeName,"readonly");
        const req = tx.objectStore(storeName).get(id);
        req.onsuccess = ()=>resolve(req.result||null);
        req.onerror = ()=>reject(req.error);
      });
    }
    async function dbDelete(storeName, id){
      const db = await openDB();
      return new Promise((resolve,reject)=>{
        const tx = db.transaction(storeName,"readwrite");
        tx.objectStore(storeName).delete(id);
        tx.oncomplete = ()=>resolve(true);
        tx.onerror = ()=>reject(tx.error);
      });
    }
    function fileToDataURL(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=>resolve(String(r.result||""));
        r.onerror = ()=>reject(r.error);
        r.readAsDataURL(file);
      });
    }

    // ===== Storage Keys =====
    const KEY_CFG      = "aurax_cfg_v9";
    const KEY_INT      = "aurax_intelligence_v9";
    const KEY_BM       = "aurax_bm_v9";
    const KEY_HIST     = "aurax_history_v9";
    const KEY_ID       = "aurax_identity_v9";
    const KEY_FAITH    = "aurax_faith_v9";

    // ===== Default Config =====
    const cfg = Object.assign({
      voiceOn:true,
      learningOn:true,
      bmOn:true,
      bmMinChars:18,
      decayHours:48
    }, loadJSON(KEY_CFG, {}));

    // ===== Basic seed Q/A (always available) =====
    const SEED_QA = [
      {q:"hello", a:"Hello! I am AURA-X Œ©. How can I help today?"},
      {q:"hi", a:"Hi! I am AURA-X Œ©. What would you like to talk about?"},
      {q:"how are you", a:"I am running well. How are you feeling right now?"},
      {q:"who created you", a:"I am AURA-X Œ©, created as a prototype by Alim ul Haq."},
      {q:"what is aura x omega", a:"AURA-X Œ© is an offline emotional continuity prototype that uses local memory + simple continuity math."},
    ];

    // ===== Load local data =====
    let intelligence = loadJSON(KEY_INT,[]);
    let bm = loadJSON(KEY_BM,[]);
    let historyArr = loadJSON(KEY_HIST,[]);
    let identityText = loadJSON(KEY_ID,"");
    let faithSel = loadJSON(KEY_FAITH, ["None"]);

    // ===== Elements =====
    const consoleBox = el("consoleBox");
    const userInput  = el("userInput");
    const btnSend    = el("btnSend");

    const btnOptions = el("btnOptions");
    const optionsMenu= el("optionsMenu");

    const miVoice = el("miVoice");
    const miIntel = el("miIntel");
    const miLearning = el("miLearning");
    const miFeed = el("miFeed");
    const miFaith = el("miFaith");
    const miIdentity = el("miIdentity");
    const miLLM = el("miLLM");
    const miBM = el("miBM");
    const miHistory = el("miHistory");

    const pillVoice = el("pillVoice");
    const pillLearning = el("pillLearning");
    const pillFaith = el("pillFaith");

    const statE0 = el("statE0");
    const statTM = el("statTM");
    const statBM = el("statBM");
    const statC  = el("statC");

    // Modals
    const modalIntel = el("modalIntel");
    const modalSeed = el("modalSeed");
    const modalFaith = el("modalFaith");
    const modalIdentity = el("modalIdentity");
    const modalLLM = el("modalLLM");
    const modalBM = el("modalBM");
    const modalHistory = el("modalHistory");

    // Intel modal
    const intelArea = el("intelArea");
    const intelCountHint = el("intelCountHint");
    const btnExportIntel = el("btnExportIntel");
    const btnClearIntel  = el("btnClearIntel");

    // Seed modal
    const seedTextArea = el("seedTextArea");
    const btnParseSeed = el("btnParseSeed");
    const btnSaveSeed  = el("btnSaveSeed");
    const btnDiscardSeed = el("btnDiscardSeed");
    const seedHint = el("seedHint");

    // Faith modal
    const faithButtons = el("faithButtons");

    // Identity modal
    const identityArea = el("identityArea");
    const btnSaveIdentity = el("btnSaveIdentity");
    const btnClearIdentity = el("btnClearIdentity");

    // BM modal
    const bmList = el("bmList");
    const bmDateFilter = el("bmDateFilter");
    const btnBMFilter  = el("btnBMFilter");
    const btnBMShowAll = el("btnBMShowAll");
    const bmFileInput  = el("bmFileInput");
    const btnAddBMFile = el("btnAddBMFile");
    const bmFiles      = el("bmFiles");

    const bmViewer = el("bmViewer");
    const bmTitle  = el("bmTitle");
    const bmMeta   = el("bmMeta");
    const bmLockIcon = el("bmLockIcon");
    const bmTextArea = el("bmTextArea");
    const btnCopyPrompt = el("btnCopyPrompt");
    const btnAutoGen = el("btnAutoGen");
    const btnUnlockBM = el("btnUnlockBM");
    const btnDeletePrompt = el("btnDeletePrompt");
    const btnExportBM = el("btnExportBM");
    const btnClearBM  = el("btnClearBM");

    // History modal
    const historyArea = el("historyArea");
    const historyHint = el("historyHint");
    const btnExportHistory = el("btnExportHistory");
    const btnClearHistory  = el("btnClearHistory");

    // ===== UI helpers =====
    function openModal(m){ m.style.display="flex"; }
    function closeModal(m){ m.style.display="none"; }

    document.querySelectorAll("[data-close]").forEach(x=>{
      x.addEventListener("click", ()=>{
        const id = x.getAttribute("data-close");
        closeModal(el(id));
      });
    });
    document.querySelectorAll(".modalOverlay").forEach(ov=>{
      ov.addEventListener("click", (e)=>{
        if(e.target===ov) closeModal(ov);
      });
    });

    // ===== Voice =====
    function speakAnswer(text){
      try{
        if(!cfg.voiceOn) return;
        if(!("speechSynthesis" in window)) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(String(text||""));
        u.rate = 1; u.pitch = 1; u.volume = 1;
        const voices = window.speechSynthesis.getVoices?.() || [];
        const v = voices.find(x=>/en/i.test(x.lang)) || voices[0];
        if(v) u.voice = v;
        window.speechSynthesis.speak(u);
      }catch(e){}
    }
    // prime voices list (some browsers need this)
    try{ window.speechSynthesis.getVoices?.(); }catch(e){}

    // ===== Options Menu Toggle =====
    btnOptions.onclick = ()=>{
      const isOpen = optionsMenu.style.display==="block";
      optionsMenu.style.display = isOpen ? "none" : "block";
    };

    function refreshPills(){
      pillVoice.className = "miPill " + (cfg.voiceOn ? "pillOn":"pillOff");
      pillVoice.textContent = cfg.voiceOn ? "on":"off";

      pillLearning.className = "miPill " + (cfg.learningOn ? "pillOn":"pillOff");
      pillLearning.textContent = cfg.learningOn ? "on":"off";

      const f = (faithSel && faithSel.length) ? faithSel[0] : "None";
      pillFaith.className = "miPill " + (f==="None" ? "pillNone":"pillOpen");
      pillFaith.textContent = (f||"none").toLowerCase();
    }
    refreshPills();

    miVoice.onclick = ()=>{
      cfg.voiceOn = !cfg.voiceOn;
      saveJSON(KEY_CFG,cfg);
      refreshPills();
    };
    miLearning.onclick = ()=>{
      cfg.learningOn = !cfg.learningOn;
      saveJSON(KEY_CFG,cfg);
      refreshPills();
    };

    miIntel.onclick = ()=>{ renderIntel(); openModal(modalIntel); };
    miFeed.onclick  = ()=>{ seedHint.textContent=""; openModal(modalSeed); };
    miFaith.onclick = ()=>{ renderFaithButtons(); openModal(modalFaith); };
    miIdentity.onclick = ()=>{ identityArea.value = identityText || ""; openModal(modalIdentity); };
    miLLM.onclick = ()=>openModal(modalLLM);
    miBM.onclick  = ()=>{ renderBMList(); bmViewer.style.display="none"; openModal(modalBM); };
    miHistory.onclick = ()=>{ renderHistory(); openModal(modalHistory); };

    // ===== Conversation rendering (NO boot messages) =====
    function logLine(role, text){
      const div = document.createElement("div");
      div.className = "line " + (role==="YOU" ? "you":"aura");
      const ts = nowTS();
      div.innerHTML = `<span class="ts">[${ts}]</span> <b>${role}:</b> ${escapeHTML(text)}`;
      consoleBox.appendChild(div);
      consoleBox.scrollTop = consoleBox.scrollHeight;
    }

    function renderHistoryBox(){
      consoleBox.innerHTML = "";
      historyArr.forEach(it=>{
        logLine(it.role, it.text);
      });
    }

    function initHistoryWelcome(){
      // Start with a clean screen (no SYS boot messages).
      renderHistoryBox();
    }

    // ===== Decay (TM) =====
    function pruneHistory(){
      const now = Date.now();
      const maxAge = cfg.decayHours * 3600 * 1000;
      historyArr = historyArr.filter(it => (now - it.t) <= maxAge);
      saveJSON(KEY_HIST, historyArr);
    }

    function addToHistory(role, text){
      pruneHistory();
      historyArr.push({role, text, t: Date.now()});
      saveJSON(KEY_HIST, historyArr);
    }

    // ===== Intelligence matching =====
    function normalize(s){
      return String(s||"").trim().toLowerCase()
        .replace(/[^\p{L}\p{N}\s]+/gu," ")
        .replace(/\s+/g," ")
        .trim();
    }

    function findIntelAnswer(q){
      const nq = normalize(q);
      if(!nq) return null;
      // simple best match: contains or overlap
      let best = null, bestScore = 0;
      for(const item of intelligence){
        const iq = normalize(item.q);
        if(!iq) continue;
        let score = 0;
        if(nq===iq) score = 10;
        else{
          if(nq.includes(iq) || iq.includes(nq)) score = 6;
          const a = new Set(nq.split(" "));
          const b = new Set(iq.split(" "));
          let inter = 0;
          for(const w of a){ if(b.has(w)) inter++; }
          score += inter;
        }
        if(score>bestScore){
          bestScore = score;
          best = item;
        }
      }
      return (bestScore>=3) ? best : null;
    }

    // ===== Learning correction flow =====
    let pendingCorrection = null; // {q, a_guess}
    function startCorrectionFlow(q, a_guess){
      pendingCorrection = {q, a_guess};
      return `If that answer is incorrect, reply: *incorrect*.\nThen I will ask for the correct answer and store it locally.`;
    }

    function handleCorrectionInput(text){
      if(!pendingCorrection) return null;
      const t = normalize(text);
      if(t==="incorrect"){
        return "Okay. Please type the correct answer for that question.";
      }
      // if waiting for correct answer
      if(pendingCorrection && pendingCorrection.awaitingCorrect){
        const correct = text.trim();
        if(!correct) return "Please type a valid answer.";
        pendingCorrection.correct = correct;
        pendingCorrection.awaitingConfirm = true;
        return `Got it. Save this as learned?\nQ: "${pendingCorrection.q}"\nA: "${correct}"\nReply: yes / no`;
      }
      return null;
    }

    // We will implement a clear 3-step correction:
    // 1) user says "incorrect" -> set awaitingCorrect
    // 2) user provides correct answer -> ask yes/no
    // 3) confirm yes -> save
    function updateCorrectionState(userText){
      if(!pendingCorrection) return null;
      const t = normalize(userText);

      if(t==="incorrect" && !pendingCorrection.awaitingCorrect && !pendingCorrection.awaitingConfirm){
        pendingCorrection.awaitingCorrect = true;
        return "Okay. Please type the correct answer for that question.";
      }

      if(pendingCorrection.awaitingCorrect && !pendingCorrection.awaitingConfirm){
        const correct = userText.trim();
        if(!correct) return "Please type the correct answer.";
        pendingCorrection.correct = correct;
        pendingCorrection.awaitingCorrect = false;
        pendingCorrection.awaitingConfirm = true;
        return `Save this learned answer?\nReply: yes / no`;
      }

      if(pendingCorrection.awaitingConfirm){
        if(t==="yes" || t==="y"){
          // save
          intelligence.unshift({
            q: pendingCorrection.q,
            a: pendingCorrection.correct,
            meta:{t:Date.now(), source:"correction"}
          });
          saveJSON(KEY_INT, intelligence);
          pendingCorrection = null;
          return "Saved locally. ‚úÖ";
        }
        if(t==="no" || t==="n"){
          pendingCorrection = null;
          return "Not saved.";
        }
        return "Please reply yes or no.";
      }
      return null;
    }

    // ===== Seed parsing (LaTeX-like blocks) =====
    // Expect lines: \item Question ... \textbf{A:} Answer ...
    let parsedSeed = [];
    function parseSeedBlock(txt){
      parsedSeed = [];
      const lines = txt.split("\n");
      let curQ = null, curA = null;
      for(const line of lines){
        const l = line.trim();
        if(l.startsWith("\\item")){
          if(curQ && curA){
            parsedSeed.push({q:curQ, a:curA});
          }
          curQ = l.replace(/^\\item\s*/,"").trim();
          curA = null;
        }else if(l.includes("\\textbf{A:}")){
          curA = l.split("\\textbf{A:}")[1].trim();
        }else{
          // allow multi-line answers
          if(curA!==null && l){
            curA += " " + l;
          }
        }
      }
      if(curQ && curA){
        parsedSeed.push({q:curQ, a:curA});
      }
      return parsedSeed;
    }

    btnParseSeed.onclick = ()=>{
      const txt = seedTextArea.value || "";
      const out = parseSeedBlock(txt);
      seedHint.textContent = out.length ? `Parsed ${out.length} Q/A items.` : "No valid items found.";
    };

    btnSaveSeed.onclick = ()=>{
      if(!parsedSeed.length){
        seedHint.textContent = "Parse first (or paste a valid block).";
        return;
      }
      // Save into intelligence (protected seed)
      for(const it of parsedSeed){
        intelligence.unshift({q:it.q, a:it.a, meta:{t:Date.now(), source:"seed"}});
      }
      saveJSON(KEY_INT, intelligence);
      seedTextArea.value = "";
      parsedSeed = [];
      seedHint.textContent = "Saved to intelligence. ‚úÖ";
      refreshIntelCount();
    };

    btnDiscardSeed.onclick = ()=>{
      seedTextArea.value = "";
      parsedSeed = [];
      seedHint.textContent = "Discarded.";
    };

    // ===== Faith lenses =====
    const FAITHS = ["None","Islam","Christianity","Hinduism","Buddhism","Sikhism","Judaism","Atheism / Humanism","Other / Mixed","Indigenous / Traditional","Eastern / Chinese"];
    function renderFaithButtons(){
      faithButtons.innerHTML = "";
      FAITHS.forEach(name=>{
        const b = document.createElement("button");
        b.className="btn btnSmall";
        b.textContent = name;
        const active = faithSel && faithSel[0]===name;
        if(active) b.style.borderColor="rgba(56,189,248,.55)";
        b.onclick=()=>{
          faithSel = [name];
          saveJSON(KEY_FAITH, faithSel);
          refreshPills();
          closeModal(modalFaith);
        };
        faithButtons.appendChild(b);
      });
    }

    function faithLine(){
      const f = (faithSel && faithSel[0]) || "None";
      if(f==="None") return "";
      // gentle, non-judgmental, encouragement
      return ` (encouragement ¬∑ ${f} lens)`;
    }

    // ===== Identity =====
    btnSaveIdentity.onclick = ()=>{
      identityText = identityArea.value || "";
      saveJSON(KEY_ID, identityText);
      closeModal(modalIdentity);
    };
    btnClearIdentity.onclick = ()=>{
      if(!confirm("Clear identity?")) return;
      if(!confirm("Final confirmation: clear now?")) return;
      identityText = "";
      saveJSON(KEY_ID, identityText);
      identityArea.value="";
    };

    // ===== BM (Bold Memory) =====
    function todayYMD(){
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${d.getFullYear()}-${m}-${day}`;
    }

    let bmFilterDate = "";
    function renderBMList(){
      bmList.innerHTML = "";
      const list = bmFilterDate ? bm.filter(x=>x.date===bmFilterDate) : bm;
      if(!list.length){
        bmList.innerHTML = '<div class="hint">No BM items for this date.</div>';
        return;
      }
      list.forEach((item,localIdx)=>{
        const realIdx = bm.indexOf(item);
        const div = document.createElement("div");
        div.className = "bmItem";
        const hasFiles = Array.isArray(item.files) && item.files.length;
        div.innerHTML = `
          <div class="bmTitleRow">
            <span class="bmTitle">${escapeHTML(item.title||("BM "+(item.date||"")))} </span>
            <span class="bmBadges">
              ${item.locked?'<span class="badge lock">locked</span>':''}
              ${hasFiles?`<span class="badge file">${item.files.length} file</span>`:''}
            </span>
          </div>
          <div class="bmMeta">${escapeHTML(item.date||"")}</div>
        `;
        div.onclick = ()=>showBMItem(realIdx);
        bmList.appendChild(div);
      });
    }
    btnBMFilter.onclick = ()=>{
      bmFilterDate = bmDateFilter.value || "";
      renderBMList();
      bmViewer.style.display = "none";
    };
    btnBMShowAll.onclick = ()=>{
      bmFilterDate = "";
      bmDateFilter.value = "";
      renderBMList();
      bmViewer.style.display = "none";
    };

    async function renderBMFiles(idx){
      const item = bm[idx];
      bmFiles.innerHTML = "";
      const files = (item && Array.isArray(item.files)) ? item.files : [];
      if(!files.length){
        bmFiles.innerHTML = '<div class="hint">No evidence files attached.</div>';
        return;
      }
      for(const fid of files){
        const rec = await dbGet("bm_files", fid);
        if(!rec) continue;
        const row = document.createElement("div");
        row.className = "fileRow";
        const isImg = rec.type.startsWith("image/");
        const isVid = rec.type.startsWith("video/");
        const isAud = rec.type.startsWith("audio/");
        row.innerHTML = `
          <div class="fileName">${escapeHTML(rec.name)} <span class="fileType">(${escapeHTML(rec.type)})</span></div>
          <div class="fileActions">
            <button class="btn btnSmall" data-act="open">Open</button>
            <button class="btn btnSmall danger" data-act="del">Delete</button>
          </div>
          <div class="filePreview"></div>
        `;
        const preview = row.querySelector(".filePreview");
        row.querySelector('[data-act="open"]').onclick = ()=>{
          preview.innerHTML = "";
          if(isImg){
            const img = document.createElement("img");
            img.src = rec.dataURL;
            img.style.maxWidth="100%";
            img.style.borderRadius="12px";
            preview.appendChild(img);
          }else if(isVid){
            const v = document.createElement("video");
            v.src = rec.dataURL; v.controls=true; v.style.maxWidth="100%"; v.style.borderRadius="12px";
            preview.appendChild(v);
          }else if(isAud){
            const a = document.createElement("audio");
            a.src = rec.dataURL; a.controls=true; a.style.width="100%";
            preview.appendChild(a);
          }else{
            const a = document.createElement("a");
            a.href = rec.dataURL; a.download = rec.name; a.textContent = "Download file";
            preview.appendChild(a);
          }
        };
        row.querySelector('[data-act="del"]').onclick = async ()=>{
          if(!confirm("Delete this attached file?")) return;
          if(!confirm("Final confirmation: delete now?")) return;
          await dbDelete("bm_files", rec.id);
          item.files = (item.files||[]).filter(x=>x!==rec.id);
          saveJSON(KEY_BM,bm);
          renderBMFiles(idx);
          renderBMList();
        };
        bmFiles.appendChild(row);
      }
    }

    function showBMItem(idx){
      const item = bm[idx];
      if(!item) return;
      bmViewer.style.display="block";
      bmTitle.textContent = item.title || "BM Prompt";
      bmMeta.textContent  = `Date: ${item.date||""} ¬∑ ${item.locked? "Locked":"Unlocked"}`;
      bmLockIcon.textContent = item.locked? "üîí" : "üîì";

      bmTextArea.value = item.text || "";
      bmTextArea.readOnly = true;

      btnUnlockBM.style.display = item.locked? "inline-block":"none";
      btnUnlockBM.onclick = ()=>{
        if(!confirm("Unlock this BM prompt for editing?")) return;
        item.locked = false;
        saveJSON(KEY_BM,bm);
        showBMItem(idx);
        renderBMList();
      };

      btnCopyPrompt.onclick = ()=>navigator.clipboard?.writeText(item.text||"");

      btnAutoGen.onclick = ()=>{
        userInput.value = item.text || "";
        closeModal(modalBM);
        userInput.focus();
      };

      btnAddBMFile.onclick = async ()=>{
        const f = bmFileInput.files && bmFileInput.files[0];
        if(!f){ alert("Choose a file first."); return; }
        const id = "f_"+Date.now()+"_"+Math.random().toString(16).slice(2);
        const dataURL = await fileToDataURL(f);
        await dbPut("bm_files",{
          id,
          name: f.name,
          type: f.type || "application/octet-stream",
          size: f.size || 0,
          createdAt: new Date().toISOString(),
          dataURL
        });
        item.files = item.files || [];
        item.files.unshift(id);
        saveJSON(KEY_BM,bm);
        bmFileInput.value = "";
        await renderBMFiles(idx);
        renderBMList();
      };

      btnDeletePrompt.onclick = ()=>{
        if(!confirm("Delete this BM prompt?")) return;
        if(!confirm("Final confirmation: delete now?")) return;
        bm.splice(idx,1);
        saveJSON(KEY_BM,bm);
        renderBMList();
        bmViewer.style.display="none";
      };

      renderBMFiles(idx);
    }

    btnExportBM.onclick = ()=>{
      const blob = new Blob([JSON.stringify(bm,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "AURA_BM.json";
      a.click();
      URL.revokeObjectURL(a.href);
    };
    btnClearBM.onclick = ()=>{
      if(!confirm("Clear ALL BM items?")) return;
      if(!confirm("Final confirmation: clear now?")) return;
      bm = [];
      saveJSON(KEY_BM,bm);
      renderBMList();
      bmViewer.style.display="none";
    };

    // ===== Intelligence modal =====
    function refreshIntelCount(){
      intelCountHint.textContent = `Items: ${intelligence.length}`;
    }
    function renderIntel(){
      refreshIntelCount();
      intelArea.value = JSON.stringify(intelligence,null,2);
    }
    btnExportIntel.onclick = ()=>{
      const blob = new Blob([JSON.stringify(intelligence,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "AURA_Intelligence.json";
      a.click();
      URL.revokeObjectURL(a.href);
    };
    btnClearIntel.onclick = ()=>{
      if(!confirm("Clear learned intelligence?")) return;
      if(!confirm("Final confirmation: clear now?")) return;
      intelligence = [];
      saveJSON(KEY_INT, intelligence);
      renderIntel();
      refreshIntelCount();
    };

    // ===== History modal =====
    function renderHistory(){
      pruneHistory();
      historyArea.value = JSON.stringify(historyArr,null,2);
      historyHint.textContent = `TM auto-decay: ${cfg.decayHours} hours (unless moved to BM by rules).`;
    }
    btnExportHistory.onclick = ()=>{
      const blob = new Blob([JSON.stringify(historyArr,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "AURA_History_TM.json";
      a.click();
      URL.revokeObjectURL(a.href);
    };
    btnClearHistory.onclick = ()=>{
      if(!confirm("Delete ALL conversation history?")) return;
      if(!confirm("Final confirmation: delete now?")) return;
      historyArr = [];
      saveJSON(KEY_HIST, historyArr);
      renderHistoryBox();
      renderHistory();
    };

    // ===== Continuity Math =====
    // simplified (stable) scalars for UI
    let TM = 0.00, BMv = 0.00, C = 0.85, E0 = 0.0;
    function compute(){
      // rough contributions
      const R = (TM * 0.45) + (BMv * 0.55);
      const I_TM = TM * 0.25;
      const I_intel = Math.min(0.35, intelligence.length * 0.002);
      const I_llm = 0.00; // placeholder
      const D = 0.06;
      const lam_faith = (faithSel && faithSel[0] && faithSel[0]!=="None") ? 0.06 : 0.00;
      const lam_sys = 0.04;
      const lam_trc = 0.04;
      const x = R + I_TM + I_intel + I_llm - D + lam_faith + lam_sys + lam_trc;
      E0 = Math.tanh(x);
      statE0.textContent = "E0: " + E0.toFixed(3);
      statTM.textContent = "TM: " + TM.toFixed(2);
      statBM.textContent = "BM: " + BMv.toFixed(2);
      statC.textContent  = "C: "  + C.toFixed(3);
    }

    // ===== Main reply pipeline =====
    function makeReply(userText){
      const text = userText.trim();
      let answer = "";
      let seedUsed = false;
      // 1) Basic seed Q/A
      for(const it of SEED_QA){
        if(text.toLowerCase().includes(it.q)){
          answer = it.a;
          seedUsed = true;
          break;
        }
      }

      // correction handler (if active)
      const corr = updateCorrectionState(text);
      if(corr){
        return corr;
      }

      // 2) Learned intelligence
      let intelHit = null;
      if(!answer){
        intelHit = findIntelAnswer(text);
        if(intelHit){
          answer = intelHit.a;
        }
      }

      // 3) Fallback (prototype placeholder)
      if(!answer){
        answer = `Prototype reply (local only). I heard: "${text}". Right now I am using saved intelligence + simple continuity math, not a full LLM.` +
                 faithLine();
        // Offer correction flow
        if(cfg.learningOn){
          answer += "\n\n" + startCorrectionFlow(text, answer);
          // set correction state for "incorrect"
          pendingCorrection = {q:text, a_guess:answer, awaitingCorrect:false, awaitingConfirm:false};
        }
      }

      return answer;
    }

    function maybeStoreBM(text){
      if(!cfg.bmOn) return;
      const t = String(text||"").trim();
      if(t.length < cfg.bmMinChars) return;

      // store only user prompts as BM candidates (you can modify rule)
      bm.unshift({
        title: (t.length>42 ? (t.slice(0,42)+"‚Ä¶") : t),
        text: t,
        date: todayYMD(),
        locked: true,
        files: []
      });
      saveJSON(KEY_BM,bm);
      BMv = clamp(bm.length * 0.01, 0, 1);
    }

    function handleSend(){
      const text = userInput.value.trim();
      if(!text) return;

      // YOU
      logLine("YOU", text);
      addToHistory("YOU", text);

      // update TM
      TM = clamp(TM + 0.05, 0, 1);

      // BM store rule
      if(cfg.learningOn){
        maybeStoreBM(text);
      }

      // AURA
      const reply = makeReply(text);
      logLine("AURA", reply);
      addToHistory("AURA", reply);

      // Speak
      speakAnswer(reply);

      userInput.value = "";
      compute();
    }

    btnSend.onclick = handleSend;
    userInput.addEventListener("keydown", (e)=>{
      if(e.key==="Enter") handleSend();
    });

    // ===== Init =====
    (function init(){
      pruneHistory();
      renderHistoryBox();
      initHistoryWelcome();
      identityArea.value = identityText || "";
      compute();
    })();
  </script>
</body>
</html>