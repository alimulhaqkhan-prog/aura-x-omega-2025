<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    *{box-sizing:border-box;margin:0;padding:0}

    /* ---------- THEME VARIABLES ---------- */
    :root{
      --bg1: radial-gradient(circle at 18% 0%, #0b2a44 0, transparent 55%);
      --bg2: radial-gradient(circle at 82% 0%, #0ea5e9 0, transparent 45%);
      --bg3: linear-gradient(145deg,#020617 0,#020617 45%,#020617 100%);
      --text: #e5e7eb;

      --appBg: rgba(2,6,23,.68);
      --panelBg: rgba(2,6,23,.42);
      --cardBg: rgba(15,23,42,.58);
      --chatBg: rgba(2,6,23,.36);

      --border1: rgba(148,163,184,.18);
      --border2: rgba(148,163,184,.16);
      --border3: rgba(148,163,184,.14);

      --accentA: rgba(56,189,248,.92);
      --accentB: rgba(14,165,233,.82);

      --ethicBorder: rgba(245,158,11,.35);
      --ethicText: #fbbf24;
      --title: #93c5fd;
      --muted: #cbd5e1;

      --pillOnBg: rgba(34,197,94,.22);
      --pillOnBr: rgba(34,197,94,.35);
      --pillOnTx: #bbf7d0;

      --pillOffBg: rgba(239,68,68,.18);
      --pillOffBr: rgba(239,68,68,.35);
      --pillOffTx: #fecaca;
    }

    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: var(--bg1), var(--bg2), var(--bg3);
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px;
    }

    .app{
      width:min(920px,100%);
      border-radius:26px;
      padding:18px 18px 16px;
      background:var(--appBg);
      border:1px solid var(--border1);
      box-shadow:0 18px 70px rgba(0,0,0,.58);
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }

    .topGlow{
      position:absolute; inset:-140px -140px auto -140px;
      height:310px;
      background:
        radial-gradient(circle at 35% 35%, rgba(56,189,248,.22), transparent 60%),
        radial-gradient(circle at 70% 25%, rgba(99,102,241,.18), transparent 58%);
      filter: blur(14px);
      pointer-events:none;
    }

    header{
      position:relative;
      text-align:center;
      padding:10px 10px 6px;
      z-index:1;
    }
    header h1{
      font-size:40px;
      letter-spacing:.8px;
      font-weight:900;
      color:var(--title);
      text-shadow:0 14px 40px rgba(56,189,248,.16);
    }
    header p{
      margin-top:8px;
      color:var(--muted);
      opacity:.92;
      font-size:15px;
      line-height:1.35;
    }

    .ethicCard{
      margin:14px auto 12px;
      max-width:760px;
      border-radius:16px;
      border:1px solid var(--ethicBorder);
      background:rgba(2,6,23,.55);
      box-shadow: inset 0 0 0 1px rgba(2,6,23,.45), 0 12px 38px rgba(0,0,0,.32);
      padding:14px 14px;
      color:var(--ethicText);
      text-align:center;
      line-height:1.45;
      font-size:14px;
    }

    .activePill{
      margin:10px auto 16px;
      max-width:760px;
      border-radius:999px;
      padding:14px 16px;
      text-align:center;
      font-weight:900;
      letter-spacing:.7px;
      color:#06121f;
      background:linear-gradient(135deg, var(--accentA), var(--accentB));
      border:1px solid rgba(56,189,248,.35);
      box-shadow:0 16px 45px rgba(0,0,0,.30);
    }

    .panel{
      position:relative;
      border-radius:20px;
      border:1px solid var(--border2);
      background:var(--panelBg);
      box-shadow: inset 0 0 0 1px rgba(2,6,23,.45);
      padding:16px;
    }

    /* Options pill (like screenshot) */
    .optionPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:12px 16px;
      border-radius:999px;
      background:rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.18);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      box-shadow:0 12px 32px rgba(0,0,0,.30);
      font-weight:850;
    }
    .optionPill:active{transform:scale(.99)}
    .optionPill .gear{font-size:16px}

    /* Menu panel under Options */
    .menuPanel{
      position:absolute;
      left:16px;
      top:66px;
      width:min(760px, calc(100% - 32px));
      z-index:6;
      border-radius:18px;
      border:1px solid var(--border2);
      background:rgba(2,6,23,.88);
      box-shadow:0 18px 60px rgba(0,0,0,.58);
      padding:12px;
      display:none;
    }
    .menuPanel.open{display:block}

    /* compact grid */
    .menuGrid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
    }
    .menuItem{
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      color:var(--text);
      border:1px solid rgba(148,163,184,.08);
      background:rgba(15,23,42,.75);
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      font-size:12px;
      line-height:1.15;
    }
    .menuItem:active{transform:scale(.99)}
    .left{display:flex; align-items:center; gap:8px; min-width:0;}
    .left .icon{font-size:15px}
    .left .label{
      font-weight:850;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      opacity:.95;
    }

    .pillOn,.pillOff{
      font-size:10px;
      padding:3px 7px;
      border-radius:999px;
      font-weight:900;
      white-space:nowrap;
    }
    .pillOn{background:var(--pillOnBg); border:1px solid var(--pillOnBr); color:var(--pillOnTx)}
    .pillOff{background:var(--pillOffBg); border:1px solid var(--pillOffBr); color:var(--pillOffTx)}

    @media (max-width:980px){
      .menuGrid{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    }
    @media (max-width:420px){
      .menuGrid{ gap:6px; }
      .menuItem{ padding:7px 9px; font-size:12px; }
      .pillOn,.pillOff{ font-size:10px; padding:3px 6px; }
    }

    /* Chat big area */
    .chatBox{
      margin-top:14px;
      height:360px;
      border-radius:18px;
      border:1px solid var(--border3);
      background:var(--chatBg);
      box-shadow: inset 0 0 0 1px rgba(2,6,23,.45);
      padding:14px;
      overflow:auto;
    }

    .msg{
      max-width:90%;
      padding:10px 12px;
      border-radius:14px;
      margin:10px 0;
      border:1px solid rgba(148,163,184,.12);
      line-height:1.35;
      font-size:14px;
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    .msg.user{
      margin-left:auto;
      background:rgba(14,165,233,.12);
      border-color:rgba(14,165,233,.24);
    }
    .msg.bot{
      margin-right:auto;
      background:rgba(99,102,241,.10);
      border-color:rgba(99,102,241,.22);
    }

    /* -------- ONE LINE STATUS (exact like screenshot) -------- */
    .statusCapsule{
      margin:14px auto 10px;
      max-width:760px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background:var(--cardBg);
      box-shadow:0 12px 36px rgba(0,0,0,.28);
      font-weight:800;
      color:var(--muted);

      display:flex;
      align-items:center;
      justify-content:center;

      white-space:nowrap;     /* force single line */
      overflow-x:auto;        /* on very small screens allow scroll (still 1 line) */
      -webkit-overflow-scrolling:touch;
      gap:0;
    }
    .statusText{
      white-space:nowrap;
      font-size:13.5px;
      letter-spacing:.2px;
    }
    .statusText b{
      color:var(--text);
      font-weight:900;
    }

    /* Composer row */
    .composer{
      display:flex;
      gap:10px;
      align-items:flex-end;
      padding-top:4px;
      max-width:760px;
      margin:0 auto;
    }
    textarea{
      flex:1;
      resize:none;
      min-height:48px;
      max-height:140px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(15,23,42,.70);
      color:var(--text);
      padding:12px 16px;
      outline:none;
      font-size:14px;
      line-height:1.35;
    }
    textarea:focus{
      border-color:rgba(56,189,248,.55);
      box-shadow:0 0 0 3px rgba(56,189,248,.12);
    }
    .sendBtn{
      border:none;
      cursor:pointer;
      padding:12px 18px;
      border-radius:999px;
      background:linear-gradient(135deg, var(--accentA), var(--accentB));
      color:#06121f;
      font-weight:900;
      box-shadow:0 12px 28px rgba(0,0,0,.25);
      transition:transform .08s ease;
      min-width:96px;
    }
    .sendBtn:active{transform:scale(.98)}
    .sendBtn:disabled{opacity:.55; cursor:not-allowed}

    .formulaLine{
      margin:10px auto 0;
      max-width:760px;
      text-align:center;
      color:var(--muted);
      opacity:.85;
      font-size:12.5px;
      line-height:1.35;
      letter-spacing:.1px;
    }

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    /* MODALS */
    .backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      z-index:20;
    }
    .backdrop.show{display:block}

    .modal{
      position:fixed;
      inset:auto 50% 50% auto;
      transform:translate(50%,50%);
      width:min(780px, calc(100% - 26px));
      max-height:min(80vh, 700px);
      overflow:auto;
      background:rgba(2,6,23,.94);
      border:1px solid rgba(148,163,184,.18);
      border-radius:18px;
      box-shadow:0 18px 70px rgba(0,0,0,.70);
      padding:14px 14px 12px;
      display:none;
      z-index:21;
    }
    .modal.show{display:block}

    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-bottom:10px;
      border-bottom:1px solid rgba(148,163,184,.14);
    }
    .modalHeader h2{
      font-size:16px;
      font-weight:900;
      color:var(--text);
    }
    .closeBtn{
      border:none;
      cursor:pointer;
      padding:8px 10px;
      border-radius:12px;
      background:rgba(148,163,184,.14);
      color:var(--text);
      font-weight:900;
    }
    .closeBtn:active{transform:scale(.99)}

    .modalBody{
      padding-top:10px;
      color:var(--text);
      font-size:13px;
      line-height:1.45;
    }

    .modalBody input, .modalBody select, .modalBody textarea{
      width:100%;
      margin-top:8px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.16);
      background:rgba(15,23,42,.75);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }

    .smallNote{
      opacity:.9;
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
    }
    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .softBtn{
      border:none;
      cursor:pointer;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(56,189,248,.16);
      color:var(--text);
      font-weight:900;
      border:1px solid rgba(56,189,248,.20);
    }
    .softBtn:active{transform:scale(.99)}
    .dangerBtn{
      background:rgba(239,68,68,.14);
      border:1px solid rgba(239,68,68,.24);
    }

    .kv{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:8px 12px;
      margin-top:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(15,23,42,.60);
    }
    .k{opacity:.85}
    .v{font-weight:800}

    @media (max-width:640px){
      header h1{font-size:34px}
      .chatBox{height:440px}
      textarea{border-radius:18px}
      .sendBtn{border-radius:18px}
      .panel{padding:14px}
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topGlow"></div>

    <header>
      <h1>AURA-X Œ©</h1>
      <p>
        Offline emotional continuity engine (prototype)<br/>
        TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory.
      </p>
    </header>

    <div class="ethicCard">
      Universal ethic: avoid actions that grow negative emotions in you or others.
      Move gently toward choices that increase shared positive feeling for everyone.
    </div>

    <div class="activePill">EMOTIONAL CONTINUITY ENGINE ‚Äî ACTIVE</div>

    <div class="panel" id="panel">
      <div class="optionPill" id="optionBtn" title="Open controls">
        <span class="gear">‚öôÔ∏è</span>
        <span>Options</span>
      </div>

      <div class="menuPanel" id="menuPanel">
        <div class="menuGrid">
          <div class="menuItem" data-action="voice">
            <div class="left"><span class="icon">üéôÔ∏è</span><span class="label">Voice</span></div>
            <span class="pillOff" id="pillVoice">off</span>
          </div>

          <div class="menuItem" data-action="intel">
            <div class="left"><span class="icon">üß†</span><span class="label">Intelligence</span></div>
            <span class="pillOn" id="pillIntel">open</span>
          </div>

          <div class="menuItem" data-action="seed">
            <div class="left"><span class="icon">üå±</span><span class="label">Feed the seed</span></div>
            <span class="pillOn" id="pillSeed">open</span>
          </div>

          <div class="menuItem" data-action="learning">
            <div class="left"><span class="icon">üìö</span><span class="label">Learning</span></div>
            <span class="pillOn" id="pillLearning">on</span>
          </div>

          <div class="menuItem" data-action="faith">
            <div class="left"><span class="icon">üïäÔ∏è</span><span class="label">Faith</span></div>
            <span class="pillOff" id="pillFaith">none</span>
          </div>

          <div class="menuItem" data-action="identity">
            <div class="left"><span class="icon">üÜî</span><span class="label">Identity</span></div>
            <span class="pillOn" id="pillIdentity">profile</span>
          </div>

          <div class="menuItem" data-action="llm">
            <div class="left"><span class="icon">ü§ñ</span><span class="label">LLM link</span></div>
            <span class="pillOn" id="pillLLM">open</span>
          </div>

          <div class="menuItem" data-action="bm">
            <div class="left"><span class="icon">üü¶</span><span class="label">BM recall</span></div>
            <span class="pillOn" id="pillBM">open</span>
          </div>

          <div class="menuItem" data-action="history">
            <div class="left"><span class="icon">üìú</span><span class="label">Conversation history</span></div>
            <span class="pillOn" id="pillHistory">open</span>
          </div>

          <div class="menuItem" data-action="themes">
            <div class="left"><span class="icon">üé®</span><span class="label">Themes</span></div>
            <span class="pillOn" id="pillThemes">open</span>
          </div>

          <div class="menuItem" data-action="readme">
            <div class="left"><span class="icon">üìÑ</span><span class="label">Readme / About</span></div>
            <span class="pillOn" id="pillReadme">open</span>
          </div>
        </div>

        <div class="smallNote" style="padding-top:10px;">Tip: Tap anywhere outside to close.</div>
      </div>

      <div class="chatBox" id="chat"></div>

      <!-- ONE-LINE STATUS (exact) -->
      <div class="statusCapsule">
        <div class="statusText mono">
          E0: <b id="e0Score">0.000</b> &nbsp;¬∑&nbsp;
          TM: <b id="tmCount">0.00</b> &nbsp;¬∑&nbsp;
          BM: <b id="bmCount">0.00</b> &nbsp;¬∑&nbsp;
          C: <b id="contScore">0.850</b>
        </div>
      </div>

      <div class="composer">
        <textarea id="input" placeholder="Talk to AURA-X Œ©‚Ä¶ (TM = your inputs)"></textarea>
        <button class="sendBtn" id="sendBtn">Send</button>
      </div>

      <div class="formulaLine mono">
        E<sub>0</sub> = tanh( R(TM,BM) + I(TM) + I<sub>intel</sub> + I<sub>LLM</sub> ‚àí D + Œª<sub>faith</sub> + Œª<sub>sys</sub> + Œª<sub>trc</sub> )
      </div>
    </div>
  </div>

  <!-- Backdrop + Modals -->
  <div class="backdrop" id="backdrop"></div>
  <div class="modal" id="modal">
    <div class="modalHeader">
      <h2 id="modalTitle">Modal</h2>
      <button class="closeBtn" id="closeModal">Close</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>

  <script>
    /***********************
     * STATE
     ***********************/
    const state = {
      voice: false,
      intelligence: true,
      learning: true,
      faith: false,
      identity: { name: "User", role: "Creator" },

      tm: [],
      bm: [],
      history: [],

      seed: [
        { q: "hello", a: "Hello! I‚Äôm AURA-X Œ©. How are you feeling today?", emotion:"neutral", polarity:0.0, intensity:0.2, category:"greeting" },
        { q: "who are you", a: "I am AURA-X Œ© ‚Äî an offline emotional continuity prototype.", emotion:"neutral", polarity:0.1, intensity:0.3, category:"identity" },
        { q: "how are you", a: "I am quite fine today. How about you?", emotion:"positive", polarity:0.6, intensity:0.5, category:"status" }
      ],
      learned: [],
      theme: "dark",
      llmLink: ""
    };

    /***********************
     * DOM
     ***********************/
    const chatEl = document.getElementById("chat");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");

    const optionBtn = document.getElementById("optionBtn");
    const menuPanel = document.getElementById("menuPanel");

    const backdrop = document.getElementById("backdrop");
    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const closeModalBtn = document.getElementById("closeModal");

    const tmCountEl = document.getElementById("tmCount");
    const bmCountEl = document.getElementById("bmCount");
    const contScoreEl = document.getElementById("contScore");
    const e0ScoreEl = document.getElementById("e0Score");

    /***********************
     * HELPERS
     ***********************/
    function normalize(s){
      return (s||"").toLowerCase().trim().replace(/\s+/g," ");
    }

    function addMsg(role, text){
      const div = document.createElement("div");
      div.className = "msg " + (role === "user" ? "user" : "bot");
      div.textContent = text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function openMenu(){ menuPanel.classList.add("open"); }
    function closeMenu(){ menuPanel.classList.remove("open"); }
    function toggleMenu(){ menuPanel.classList.toggle("open"); }

    function showModal(title, html){
      modalTitle.textContent = title;
      modalBody.innerHTML = html;
      backdrop.classList.add("show");
      modal.classList.add("show");
      closeMenu();
    }
    function hideModal(){
      backdrop.classList.remove("show");
      modal.classList.remove("show");
    }

    function safeJSON(obj){
      try{ return JSON.stringify(obj,null,2); }catch(e){ return String(obj); }
    }

    /***********************
     * MEMORY & LOGIC
     ***********************/
    function findInKnowledge(userText){
      const t = normalize(userText);
      const pool = [...state.learned, ...state.seed];
      for(const item of pool){
        if(normalize(item.q) === t) return item;
      }
      return null;
    }

    function maybeLearn(userText, botText){
      if(!state.learning) return;
      const t = normalize(userText);
      if(!t) return;
      const existing = findInKnowledge(t);
      if(existing) return;

      if(t.length <= 120 && botText.length >= 4){
        state.learned.push({ q:t, a:botText, emotion:"neutral", polarity:0.1, intensity:0.3, category:"learned" });
        if(state.learned.length > 200) state.learned.shift();
      }
    }

    function analyzeEmotion(text){
      const t = normalize(text);
      let polarity = 0.0, intensity = 0.3, emotion="neutral", category="general";
      const posWords = ["good","great","happy","love","thanks","amazing","nice","awesome","excellent"];
      const negWords = ["bad","sad","angry","hate","terrible","worst","pain","upset","depressed"];
      const exclam = (text.match(/!/g)||[]).length;

      for(const w of posWords){ if(t.includes(w)){ polarity += 0.2; emotion="positive"; } }
      for(const w of negWords){ if(t.includes(w)){ polarity -= 0.2; emotion="negative"; } }
      intensity = Math.min(1, 0.25 + Math.abs(polarity) + exclam*0.05);

      if(t.includes("who are you") || t.includes("your name")) category="identity";
      else if(t.includes("how are you")) category="status";
      else if(t.includes("help") || t.includes("how")) category="support";

      polarity = Math.max(-1, Math.min(1, polarity));
      return { emotion, polarity, intensity, category };
    }

    function computeContinuity(){
      const tmRecent = state.tm.slice(-8).join(" ");
      const bmText = state.bm.map(x => (x.q+" "+x.a)).join(" ");

      const tmTokens = new Set(normalize(tmRecent).split(" ").filter(Boolean));
      const bmTokens = new Set(normalize(bmText).split(" ").filter(Boolean));
      if(tmTokens.size === 0 || bmTokens.size === 0) return 0.85;

      let overlap = 0;
      for(const w of tmTokens){ if(bmTokens.has(w)) overlap++; }
      const score = overlap / Math.max(6, tmTokens.size);
      return Math.max(0.05, Math.min(1, 0.25 + score));
    }

    function computeResonanceR(cont, pol, inten){
      const base = cont * (0.6 + 0.4*inten);
      const signed = base * (1 + 0.3*pol);
      return Math.max(0, Math.min(1.25, signed));
    }

    function tanh(x){
      const e2 = Math.exp(2*x);
      return (e2 - 1)/(e2 + 1);
    }

    function computeE0(tmSize, bmSize, cont, R){
      const TM = tmSize;
      const BM = bmSize;
      const D  = Math.max(0, TM*0.12 - cont*0.8);
      const lambda_faith = state.faith ? 0.35 : 0.0;
      const lambda_sys   = 0.20 + cont*0.25;
      const lambda_trc   = 0.15 + R*0.20;

      const x = (TM*BM*0.002) - D + lambda_faith + lambda_sys + lambda_trc;
      return tanh(x);
    }

    function hydrateBM(){
      state.bm = [...state.seed, ...state.learned];
    }

    function refreshCaps(){
      const cont = computeContinuity();
      const lastEmotion = state.tm.length ? analyzeEmotion(state.tm[state.tm.length-1]) : {polarity:0,intensity:0.3};
      const R = computeResonanceR(cont, lastEmotion.polarity, lastEmotion.intensity);
      const E0 = computeE0(state.tm.length, state.bm.length, cont, R);

      tmCountEl.textContent = Number(state.tm.length).toFixed(2);
      bmCountEl.textContent = Number(state.bm.length).toFixed(2);
      contScoreEl.textContent = cont.toFixed(3);
      e0ScoreEl.textContent = E0.toFixed(3);
    }

    function updatePills(){
      document.getElementById("pillVoice").className = state.voice ? "pillOn" : "pillOff";
      document.getElementById("pillVoice").textContent = state.voice ? "on" : "off";

      document.getElementById("pillIntel").className = "pillOn";
      document.getElementById("pillIntel").textContent = "open";

      document.getElementById("pillSeed").className = "pillOn";
      document.getElementById("pillSeed").textContent = "open";

      document.getElementById("pillLearning").className = state.learning ? "pillOn" : "pillOff";
      document.getElementById("pillLearning").textContent = state.learning ? "on" : "off";

      document.getElementById("pillFaith").className = state.faith ? "pillOn" : "pillOff";
      document.getElementById("pillFaith").textContent = state.faith ? "on" : "none";

      document.getElementById("pillIdentity").className = "pillOn";
      document.getElementById("pillIdentity").textContent = "profile";

      document.getElementById("pillLLM").className = "pillOn";
      document.getElementById("pillLLM").textContent = "open";

      document.getElementById("pillBM").className = "pillOn";
      document.getElementById("pillBM").textContent = "open";

      document.getElementById("pillHistory").className = "pillOn";
      document.getElementById("pillHistory").textContent = "open";

      document.getElementById("pillThemes").className = "pillOn";
      document.getElementById("pillThemes").textContent = "open";

      document.getElementById("pillReadme").className = "pillOn";
      document.getElementById("pillReadme").textContent = "open";
    }

    async function respond(userText){
      const k = findInKnowledge(userText);
      if(k) return k.a;

      if(state.intelligence){
        const emo = analyzeEmotion(userText);
        const cont = computeContinuity();
        const R = computeResonanceR(cont, emo.polarity, emo.intensity);

        let prefix = "I hear you. ";
        if(emo.emotion === "positive") prefix = "Glad to hear that. ";
        if(emo.emotion === "negative") prefix = "I‚Äôm sorry you‚Äôre feeling that way. ";

        return prefix + "Tell me a bit more so I can keep continuity. (R=" + R.toFixed(2) + ")";
      }
      return "I don‚Äôt have an answer yet. Please add it to Seed or enable Intelligence.";
    }

    /***********************
     * THEME APPLY (FULL UI)
     ***********************/
    function setVar(k,v){ document.documentElement.style.setProperty(k,v); }

    function applyTheme(theme){
      state.theme = theme;

      if(theme === "light"){
        setVar("--bg1","radial-gradient(circle at 18% 0%, #e2e8f0 0, transparent 55%)");
        setVar("--bg2","radial-gradient(circle at 82% 0%, #bae6fd 0, transparent 45%)");
        setVar("--bg3","linear-gradient(145deg,#f8fafc 0,#eef2ff 45%,#f8fafc 100%)");
        setVar("--text","#0f172a");
        setVar("--muted","#334155");
        setVar("--title","#0ea5e9");
        setVar("--appBg","rgba(248,250,252,.80)");
        setVar("--panelBg","rgba(255,255,255,.72)");
        setVar("--cardBg","rgba(255,255,255,.78)");
        setVar("--chatBg","rgba(255,255,255,.62)");
        setVar("--border1","rgba(15,23,42,.14)");
        setVar("--border2","rgba(15,23,42,.12)");
        setVar("--border3","rgba(15,23,42,.10)");
        setVar("--ethicBorder","rgba(245,158,11,.45)");
        setVar("--ethicText","#b45309");
        setVar("--accentA","rgba(56,189,248,.92)");
        setVar("--accentB","rgba(14,165,233,.82)");
        return;
      }

      if(theme === "metallic"){
        setVar("--bg1","radial-gradient(circle at 18% 0%, #64748b 0, transparent 55%)");
        setVar("--bg2","radial-gradient(circle at 82% 0%, #94a3b8 0, transparent 45%)");
        setVar("--bg3","linear-gradient(145deg,#0b1220 0,#111827 45%,#0b1220 100%)");
        setVar("--text","#e5e7eb");
        setVar("--muted","#cbd5e1");
        setVar("--title","#93c5fd");
        setVar("--appBg","rgba(2,6,23,.70)");
        setVar("--panelBg","rgba(2,6,23,.44)");
        setVar("--cardBg","rgba(15,23,42,.62)");
        setVar("--chatBg","rgba(2,6,23,.38)");
        setVar("--border1","rgba(148,163,184,.18)");
        setVar("--border2","rgba(148,163,184,.16)");
        setVar("--border3","rgba(148,163,184,.14)");
        setVar("--ethicBorder","rgba(245,158,11,.35)");
        setVar("--ethicText","#fbbf24");
        setVar("--accentA","rgba(148,163,184,.85)");
        setVar("--accentB","rgba(56,189,248,.70)");
        return;
      }

      if(theme === "transparent"){
        setVar("--bg1","radial-gradient(circle at 18% 0%, rgba(30,41,59,.55) 0, transparent 55%)");
        setVar("--bg2","radial-gradient(circle at 82% 0%, rgba(14,165,233,.45) 0, transparent 45%)");
        setVar("--bg3","linear-gradient(145deg,rgba(2,6,23,.75) 0, rgba(2,6,23,.55) 45%, rgba(2,6,23,.75) 100%)");
        setVar("--text","#e5e7eb");
        setVar("--muted","#cbd5e1");
        setVar("--title","#93c5fd");
        setVar("--appBg","rgba(2,6,23,.55)");
        setVar("--panelBg","rgba(2,6,23,.30)");
        setVar("--cardBg","rgba(15,23,42,.42)");
        setVar("--chatBg","rgba(2,6,23,.28)");
        setVar("--border1","rgba(148,163,184,.16)");
        setVar("--border2","rgba(148,163,184,.14)");
        setVar("--border3","rgba(148,163,184,.12)");
        setVar("--ethicBorder","rgba(245,158,11,.32)");
        setVar("--ethicText","#fbbf24");
        setVar("--accentA","rgba(56,189,248,.92)");
        setVar("--accentB","rgba(14,165,233,.82)");
        return;
      }

      /* default dark */
      setVar("--bg1","radial-gradient(circle at 18% 0%, #0b2a44 0, transparent 55%)");
      setVar("--bg2","radial-gradient(circle at 82% 0%, #0ea5e9 0, transparent 45%)");
      setVar("--bg3","linear-gradient(145deg,#020617 0,#020617 45%,#020617 100%)");
      setVar("--text","#e5e7eb");
      setVar("--muted","#cbd5e1");
      setVar("--title","#93c5fd");
      setVar("--appBg","rgba(2,6,23,.68)");
      setVar("--panelBg","rgba(2,6,23,.42)");
      setVar("--cardBg","rgba(15,23,42,.58)");
      setVar("--chatBg","rgba(2,6,23,.36)");
      setVar("--border1","rgba(148,163,184,.18)");
      setVar("--border2","rgba(148,163,184,.16)");
      setVar("--border3","rgba(148,163,184,.14)");
      setVar("--ethicBorder","rgba(245,158,11,.35)");
      setVar("--ethicText","#fbbf24");
      setVar("--accentA","rgba(56,189,248,.92)");
      setVar("--accentB","rgba(14,165,233,.82)");
    }

    /***********************
     * EVENTS
     ***********************/
    optionBtn.addEventListener("click", (e)=>{
      e.stopPropagation();
      toggleMenu();
    });

    document.addEventListener("click", (e)=>{
      if(menuPanel.classList.contains("open")){
        const within = menuPanel.contains(e.target) || optionBtn.contains(e.target);
        if(!within) closeMenu();
      }
    });

    menuPanel.addEventListener("click", (e)=>{
      const item = e.target.closest(".menuItem");
      if(!item) return;
      const action = item.getAttribute("data-action");

      if(action === "voice"){
        state.voice = !state.voice;
        updatePills();
        return;
      }

      if(action === "learning"){
        state.learning = !state.learning;
        updatePills();
        return;
      }

      if(action === "faith"){
        state.faith = !state.faith;
        updatePills();
        refreshCaps();
        return;
      }

      if(action === "seed"){
        showModal("Feed the Seed", `
          <div class="smallNote">Add Q/A to Seed (persistent in this file). Learning may also auto-store.</div>
          <label>Question (Q)</label>
          <input id="seedQ" placeholder="e.g., what is continuity?" />
          <label>Answer (A)</label>
          <textarea id="seedA" rows="4" placeholder="Write the answer..."></textarea>
          <div class="btnRow">
            <button class="softBtn" id="saveSeed">Save to Seed</button>
          </div>
        `);
        setTimeout(()=>{
          document.getElementById("saveSeed").onclick = ()=>{
            const q = document.getElementById("seedQ").value.trim();
            const a = document.getElementById("seedA").value.trim();
            if(!q || !a) return alert("Please fill Q and A");
            state.seed.push({ q, a, emotion:"neutral", polarity:0.1, intensity:0.3, category:"seed" });
            hydrateBM();
            refreshCaps();
            hideModal();
            addMsg("bot","Seed added ‚úÖ");
          };
        }, 0);
        return;
      }

      if(action === "intel"){
        showModal("Intelligence", `
          <div class="kv">
            <div class="k">Mode</div><div class="v">Offline fallback (placeholder)</div>
            <div class="k">Priority</div><div class="v">Seed/Learned ‚Üí Offline fallback</div>
            <div class="k">Status</div><div class="v">${state.intelligence ? "Enabled" : "Disabled"}</div>
          </div>
          <div class="btnRow">
            <button class="softBtn" id="toggleIntel">${state.intelligence ? "Disable" : "Enable"}</button>
          </div>
        `);
        setTimeout(()=>{
          document.getElementById("toggleIntel").onclick = ()=>{
            state.intelligence = !state.intelligence;
            hideModal();
            addMsg("bot","Intelligence is now " + (state.intelligence ? "Enabled ‚úÖ" : "Disabled ‚õî"));
          };
        }, 0);
        return;
      }

      if(action === "identity"){
        showModal("Identity Profile", `
          <label>Name</label>
          <input id="idName" value="${state.identity.name}" />
          <label>Role</label>
          <input id="idRole" value="${state.identity.role}" />
          <div class="btnRow">
            <button class="softBtn" id="saveId">Save</button>
          </div>
        `);
        setTimeout(()=>{
          document.getElementById("saveId").onclick = ()=>{
            state.identity.name = document.getElementById("idName").value.trim() || "User";
            state.identity.role = document.getElementById("idRole").value.trim() || "Creator";
            hideModal();
            addMsg("bot","Identity saved ‚úÖ");
          };
        }, 0);
        return;
      }

      if(action === "llm"){
        showModal("LLM Link", `
          <div class="smallNote">Put your clickable model/test link here (optional).</div>
          <label>URL</label>
          <input id="llmUrl" placeholder="https://..." value="${state.llmLink}" />
          <div class="btnRow">
            <button class="softBtn" id="saveLLM">Save</button>
            <button class="softBtn" id="openLLM">Open</button>
          </div>
        `);
        setTimeout(()=>{
          document.getElementById("saveLLM").onclick = ()=>{
            state.llmLink = document.getElementById("llmUrl").value.trim();
            hideModal();
            addMsg("bot","LLM link saved ‚úÖ");
          };
          document.getElementById("openLLM").onclick = ()=>{
            const url = document.getElementById("llmUrl").value.trim();
            if(!url) return alert("Enter a URL first");
            window.open(url, "_blank");
          };
        }, 0);
        return;
      }

      if(action === "bm"){
        hydrateBM();
        showModal("BM Recall", `
          <div class="smallNote">This shows your current BM memory (Seed + Learned).</div>
          <pre class="mono" style="white-space:pre-wrap; background:rgba(15,23,42,.6); padding:10px; border-radius:12px; border:1px solid rgba(148,163,184,.14);">${safeJSON(state.bm.slice(-60))}</pre>
          <div class="btnRow">
            <button class="softBtn dangerBtn" id="clearLearned">Clear Learned</button>
          </div>
        `);
        setTimeout(()=>{
          document.getElementById("clearLearned").onclick = ()=>{
            if(!confirm("Clear learned memory?")) return;
            state.learned = [];
            hydrateBM();
            refreshCaps();
            hideModal();
            addMsg("bot","Learned memory cleared ‚úÖ");
          };
        }, 0);
        return;
      }

      if(action === "history"){
        showModal("Conversation History", `
          <div class="smallNote">Full conversation log in this session.</div>
          <pre class="mono" style="white-space:pre-wrap; background:rgba(15,23,42,.6); padding:10px; border-radius:12px; border:1px solid rgba(148,163,184,.14);">${safeJSON(state.history.slice(-200))}</pre>
          <div class="btnRow">
            <button class="softBtn dangerBtn" id="clearHistory">Clear History</button>
          </div>
        `);
        setTimeout(()=>{
          document.getElementById("clearHistory").onclick = ()=>{
            if(!confirm("Clear conversation history?")) return;
            state.history = [];
            state.tm = [];
            refreshCaps();
            hideModal();
            addMsg("bot","History cleared ‚úÖ");
          };
        }, 0);
        return;
      }

      if(action === "themes"){
        showModal("Themes", `
          <div class="smallNote">Switch colors (full UI).</div>
          <div class="btnRow">
            <button class="softBtn" data-theme="dark">Dark</button>
            <button class="softBtn" data-theme="light">Light</button>
            <button class="softBtn" data-theme="metallic">Metallic</button>
            <button class="softBtn" data-theme="transparent">Transparent</button>
          </div>
        `);
        setTimeout(()=>{
          modalBody.querySelectorAll("[data-theme]").forEach(btn=>{
            btn.onclick = ()=>{
              const t = btn.getAttribute("data-theme");
              applyTheme(t);
              hideModal();
              addMsg("bot","Theme set to: " + t + " ‚úÖ");
            };
          });
        }, 0);
        return;
      }

      if(action === "readme"){
        showModal("Readme / About", `
          <div class="smallNote">
            <b>How to use:</b><br/>
            1) Ask normal questions in the chat.<br/>
            2) Answer priority: <b>Seed/Learned</b> ‚Üí <b>Offline fallback (Intelligence)</b>.<br/>
            3) Use <b>Feed the seed</b> to add Q/A for self learning (offline).<br/>
            4) Use <b>Learning</b> toggle to auto-store new Q/A in Learned memory.<br/>
            5) <b>BM Recall</b> shows (Seed + Learned).<br/>
            6) <b>Conversation history</b> shows chat log of this session.<br/><br/>
            <b>Continuity (C):</b> overlap between recent TM and BM content.<br/>
            <b>Resonance R:</b> depends on continuity + emotion intensity/polarity.<br/>
            <b>E‚ÇÄ:</b> tanh stability signal using TM, BM, decay, and lambda terms.
          </div>
        `);
        return;
      }
    });

    backdrop.addEventListener("click", hideModal);
    closeModalBtn.addEventListener("click", hideModal);

    async function handleSend(){
      const text = inputEl.value.trim();
      if(!text) return;

      inputEl.value = "";
      addMsg("user", text);

      state.tm.push(text);
      state.history.push({ role:"user", text, ts: Date.now() });

      hydrateBM();
      refreshCaps();

      sendBtn.disabled = true;
      const answer = await respond(text);

      addMsg("bot", answer);
      state.history.push({ role:"bot", text: answer, ts: Date.now() });

      maybeLearn(text, answer);
      hydrateBM();
      refreshCaps();

      sendBtn.disabled = false;
    }

    sendBtn.addEventListener("click", handleSend);
    inputEl.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        handleSend();
      }
    });

    // init
    hydrateBM();
    updatePills();
    refreshCaps();
    addMsg("bot","AURA-X Œ© ready ‚úÖ Ask me something.");
  </script>
</body>
</html>