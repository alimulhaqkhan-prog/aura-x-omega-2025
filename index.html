<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    *{box-sizing:border-box;margin:0;padding:0}

    :root{
      --bg1: radial-gradient(circle at 18% 0%, #0b2a44 0, transparent 55%);
      --bg2: radial-gradient(circle at 82% 0%, #0ea5e9 0, transparent 45%);
      --bg3: linear-gradient(145deg,#020617 0,#020617 45%,#020617 100%);
      --text: #e5e7eb;
      --muted:#cbd5e1;
      --title:#93c5fd;

      --appBg: rgba(2,6,23,.68);
      --panelBg: rgba(2,6,23,.42);
      --cardBg: rgba(15,23,42,.58);
      --chatBg: rgba(2,6,23,.36);

      --border1: rgba(148,163,184,.18);
      --border2: rgba(148,163,184,.16);
      --border3: rgba(148,163,184,.14);

      --accentA: rgba(56,189,248,.92);
      --accentB: rgba(14,165,233,.82);

      --ethicBorder: rgba(245,158,11,.35);
      --ethicText: #fbbf24;

      --pillOnBg: rgba(34,197,94,.22);
      --pillOnBr: rgba(34,197,94,.35);
      --pillOnTx: #bbf7d0;

      --pillOffBg: rgba(239,68,68,.18);
      --pillOffBr: rgba(239,68,68,.35);
      --pillOffTx: #fecaca;
    }

    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: var(--bg1), var(--bg2), var(--bg3);
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px;
    }

    .app{
      width:min(920px,100%);
      border-radius:26px;
      padding:18px 18px 16px;
      background:var(--appBg);
      border:1px solid var(--border1);
      box-shadow:0 18px 70px rgba(0,0,0,.58);
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }

    .topGlow{
      position:absolute; inset:-140px -140px auto -140px;
      height:310px;
      background:
        radial-gradient(circle at 35% 35%, rgba(56,189,248,.22), transparent 60%),
        radial-gradient(circle at 70% 25%, rgba(99,102,241,.18), transparent 58%);
      filter: blur(14px);
      pointer-events:none;
    }

    header{
      position:relative;
      text-align:center;
      padding:10px 10px 6px;
      z-index:1;
    }
    header h1{
      font-size:40px;
      letter-spacing:.8px;
      font-weight:900;
      color:var(--title);
      text-shadow:0 14px 40px rgba(56,189,248,.16);
    }
    header p{
      margin-top:8px;
      color:var(--muted);
      opacity:.92;
      font-size:15px;
      line-height:1.35;
    }

    .ethicCard{
      margin:14px auto 12px;
      max-width:760px;
      border-radius:16px;
      border:1px solid var(--ethicBorder);
      background:rgba(2,6,23,.55);
      box-shadow: inset 0 0 0 1px rgba(2,6,23,.45), 0 12px 38px rgba(0,0,0,.32);
      padding:14px 14px;
      color:var(--ethicText);
      text-align:center;
      line-height:1.45;
      font-size:14px;
    }

    .activePill{
      margin:10px auto 16px;
      max-width:760px;
      border-radius:999px;
      padding:14px 16px;
      text-align:center;
      font-weight:900;
      letter-spacing:.7px;
      color:#06121f;
      background:linear-gradient(135deg, var(--accentA), var(--accentB));
      border:1px solid rgba(56,189,248,.35);
      box-shadow:0 16px 45px rgba(0,0,0,.30);
    }

    .panel{
      position:relative;
      border-radius:20px;
      border:1px solid var(--border2);
      background:var(--panelBg);
      box-shadow: inset 0 0 0 1px rgba(2,6,23,.45);
      padding:16px;
    }

    /* Options pill (like screenshot) */
    .optionPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:12px 16px;
      border-radius:999px;
      background:rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.18);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      box-shadow:0 12px 32px rgba(0,0,0,.30);
      font-weight:850;
    }
    .optionPill:active{transform:scale(.99)}
    .optionPill .gear{font-size:16px}

    /* Menu panel under Options */
    .menuPanel{
      position:absolute;
      left:16px;
      top:66px;
      width:min(760px, calc(100% - 32px));
      z-index:6;
      border-radius:18px;
      border:1px solid var(--border2);
      background:rgba(2,6,23,.88);
      box-shadow:0 18px 60px rgba(0,0,0,.58);
      padding:12px;
      display:none;
    }
    .menuPanel.open{display:block}

    .menuGrid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
    }
    .menuItem{
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      color:var(--text);
      border:1px solid rgba(148,163,184,.08);
      background:rgba(15,23,42,.75);
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      font-size:12px;
      line-height:1.15;
    }
    .menuItem:active{transform:scale(.99)}
    .left{display:flex; align-items:center; gap:8px; min-width:0;}
    .left .icon{font-size:15px}
    .left .label{
      font-weight:850;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      opacity:.95;
    }

    .pillOn,.pillOff{
      font-size:10px;
      padding:3px 7px;
      border-radius:999px;
      font-weight:900;
      white-space:nowrap;
    }
    .pillOn{background:var(--pillOnBg); border:1px solid var(--pillOnBr); color:var(--pillOnTx)}
    .pillOff{background:var(--pillOffBg); border:1px solid var(--pillOffBr); color:var(--pillOffTx)}

    @media (max-width:980px){
      .menuGrid{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    }
    @media (max-width:420px){
      .menuGrid{ gap:6px; }
      .menuItem{ padding:7px 9px; font-size:12px; }
      .pillOn,.pillOff{ font-size:10px; padding:3px 6px; }
    }

    /* Chat big area (CODE 2 STYLE: transcript) */
    .chatBox{
      margin-top:14px;
      height:360px;
      border-radius:18px;
      border:1px solid var(--border3);
      background:var(--chatBg);
      box-shadow: inset 0 0 0 1px rgba(2,6,23,.45);
      padding:14px;
      overflow:auto;
    }
    .chatTranscript{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:15px;
      line-height:1.55;
      color:rgba(226,232,240,.96);
      white-space:pre-wrap;
      word-wrap:break-word;
      text-shadow:0 10px 28px rgba(0,0,0,.28);
    }
    .chatTranscript .you{ color:#e5e7eb; }
    .chatTranscript .aura{ color:#c7d2fe; }

    /* -------- ONE LINE STATUS -------- */
    .statusCapsule{
      margin:14px auto 10px;
      max-width:760px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background:var(--cardBg);
      box-shadow:0 12px 36px rgba(0,0,0,.28);
      font-weight:800;
      color:var(--muted);

      display:flex;
      align-items:center;
      justify-content:center;

      white-space:nowrap;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      gap:0;
    }
    .statusText{
      white-space:nowrap;
      font-size:13.5px;
      letter-spacing:.2px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .statusText b{ color:var(--text); font-weight:900; }

    /* Message box (capsule like screenshot/code2 idea) */
    .composerWrap{
      max-width:760px;
      margin:0 auto;
      padding-top:4px;
    }
    .composer{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .msgInput{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(15,23,42,.70);
      color:var(--text);
      padding:12px 16px;
      outline:none;
      font-size:14px;
      line-height:1.35;
      height:48px;
    }
    .msgInput:focus{
      border-color:rgba(56,189,248,.55);
      box-shadow:0 0 0 3px rgba(56,189,248,.12);
    }
    .sendBtn{
      border:none;
      cursor:pointer;
      padding:12px 18px;
      border-radius:999px;
      background:linear-gradient(135deg, var(--accentA), var(--accentB));
      color:#06121f;
      font-weight:900;
      box-shadow:0 12px 28px rgba(0,0,0,.25);
      transition:transform .08s ease;
      min-width:96px;
      height:48px;
    }
    .sendBtn:active{transform:scale(.98)}
    .sendBtn:disabled{opacity:.55; cursor:not-allowed}

    .formulaLine{
      margin:10px auto 0;
      max-width:760px;
      text-align:center;
      color:var(--muted);
      opacity:.85;
      font-size:12.5px;
      line-height:1.35;
      letter-spacing:.1px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* MODALS */
    .backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      z-index:20;
    }
    .backdrop.show{display:block}

    .modal{
      position:fixed;
      inset:auto 50% 50% auto;
      transform:translate(50%,50%);
      width:min(820px, calc(100% - 26px));
      max-height:min(82vh, 760px);
      overflow:auto;
      background:rgba(2,6,23,.94);
      border:1px solid rgba(148,163,184,.18);
      border-radius:18px;
      box-shadow:0 18px 70px rgba(0,0,0,.70);
      padding:14px 14px 12px;
      display:none;
      z-index:21;
    }
    .modal.show{display:block}

    .modal.light{
      background:rgba(248,250,252,.98);
      color:#0f172a;
      border:1px solid rgba(15,23,42,.16);
    }
    .modal.light .modalHeader{
      border-bottom:1px solid rgba(15,23,42,.12);
    }
    .modal.light .modalHeader h2{ color:#0f172a; }
    .modal.light .closeBtn{ background:rgba(15,23,42,.08); color:#0f172a; }
    .modal.light .smallNote{ color:#334155; }
    .modal.light .softBtn{ background:rgba(14,165,233,.12); border:1px solid rgba(14,165,233,.22); color:#0f172a; }
    .modal.light .dangerBtn{ background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.22); color:#0f172a; }
    .modal.light .scrollArea{
      background:rgba(15,23,42,.04);
      border:1px solid rgba(15,23,42,.12);
    }
    .modalHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding-bottom:10px;
      border-bottom:1px solid rgba(148,163,184,.14);
    }
    .modalHeader h2{
      font-size:16px;
      font-weight:900;
      color:var(--text);
    }
    .subTitle{
      font-size:12px;
      opacity:.85;
      margin-top:2px;
    }
    .closeBtn{
      border:none;
      cursor:pointer;
      padding:8px 10px;
      border-radius:12px;
      background:rgba(148,163,184,.14);
      color:var(--text);
      font-weight:900;
      height:38px;
    }
    .closeBtn:active{transform:scale(.99)}

    .modalBody{
      padding-top:10px;
      color:var(--text);
      font-size:13px;
      line-height:1.45;
    }
    .smallNote{
      opacity:.9;
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
    }
    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .softBtn{
      border:none;
      cursor:pointer;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(56,189,248,.16);
      color:var(--text);
      font-weight:900;
      border:1px solid rgba(56,189,248,.20);
    }
    .softBtn:active{transform:scale(.99)}
    .dangerBtn{
      background:rgba(239,68,68,.14);
      border:1px solid rgba(239,68,68,.24);
    }

    .scrollArea{
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(15,23,42,.08);
      padding:10px;
      max-height:54vh;
      overflow:auto;
    }

    .logItem{
      padding:10px 10px;
      border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(148,163,184,.12);
      margin-bottom:8px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .modal.light .logItem{
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
    }

    .badge{
      min-width:52px;
      text-align:center;
      font-size:11px;
      font-weight:900;
      border-radius:999px;
      padding:4px 8px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(148,163,184,.10);
      opacity:.95;
    }
    .modal.light .badge{
      border:1px solid rgba(15,23,42,.12);
      background:rgba(15,23,42,.05);
    }

    .logMain{flex:1; min-width:0}
    .logText{
      white-space:pre-wrap;
      word-wrap:break-word;
      font-size:13px;
      line-height:1.35;
    }
    .logMeta{
      font-size:11px;
      opacity:.75;
      margin-top:4px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .lockIcon{
      font-size:14px;
      margin-left:auto;
      opacity:.9;
    }

    .bmCard{
      border-radius:14px;
      border:1px solid rgba(148,163,184,.14);
      padding:10px 10px;
      margin-bottom:10px;
      background:rgba(255,255,255,.06);
      position:relative;
    }
    .modal.light .bmCard{ background:#fff; border:1px solid rgba(15,23,42,.10); }

    .bmTop{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .bmTitle{
      font-weight:900;
      font-size:13px;
    }
    .bmLock{
      font-size:14px;
      opacity:.95;
    }
    .bmBody{
      white-space:pre-wrap;
      word-wrap:break-word;
      font-size:13px;
      line-height:1.4;
      opacity:.98;
    }
    .bmMeta{
      margin-top:8px;
      font-size:11px;
      opacity:.8;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    @media (max-width:640px){
      header h1{font-size:34px}
      .chatBox{height:440px}
      .panel{padding:14px}
      .badge{min-width:46px}
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topGlow"></div>

    <header>
      <h1>AURA-X Œ©</h1>
      <p>
        Offline emotional continuity engine (prototype)<br/>
        TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory.
      </p>
    </header>

    <div class="ethicCard">
      Universal ethic: avoid actions that grow negative emotions in you or others.
      Move gently toward choices that increase shared positive feeling for everyone.
    </div>

    <div class="activePill">EMOTIONAL CONTINUITY ENGINE ‚Äî ACTIVE</div>

    <div class="panel" id="panel">
      <div class="optionPill" id="optionBtn" title="Open controls">
        <span class="gear">‚öôÔ∏è</span>
        <span>Options</span>
      </div>

      <div class="menuPanel" id="menuPanel">
        <div class="menuGrid">
          <div class="menuItem" data-action="voice">
            <div class="left"><span class="icon">üéôÔ∏è</span><span class="label">Voice</span></div>
            <span class="pillOff" id="pillVoice">off</span>
          </div>

          <div class="menuItem" data-action="intel">
            <div class="left"><span class="icon">üß†</span><span class="label">Intelligence</span></div>
            <span class="pillOn" id="pillIntel">open</span>
          </div>

          <div class="menuItem" data-action="seed">
            <div class="left"><span class="icon">üå±</span><span class="label">Feed the seed</span></div>
            <span class="pillOn" id="pillSeed">open</span>
          </div>

          <div class="menuItem" data-action="learning">
            <div class="left"><span class="icon">üìö</span><span class="label">Learning</span></div>
            <span class="pillOn" id="pillLearning">on</span>
          </div>

          <div class="menuItem" data-action="faith">
            <div class="left"><span class="icon">üïäÔ∏è</span><span class="label">Faith</span></div>
            <span class="pillOff" id="pillFaith">none</span>
          </div>

          <div class="menuItem" data-action="identity">
            <div class="left"><span class="icon">üÜî</span><span class="label">Identity</span></div>
            <span class="pillOn" id="pillIdentity">profile</span>
          </div>

          <div class="menuItem" data-action="llm">
            <div class="left"><span class="icon">ü§ñ</span><span class="label">LLM link</span></div>
            <span class="pillOn" id="pillLLM">open</span>
          </div>

          <div class="menuItem" data-action="bm">
            <div class="left"><span class="icon">üü¶</span><span class="label">BM recall</span></div>
            <span class="pillOn" id="pillBM">open</span>
          </div>

          <div class="menuItem" data-action="history">
            <div class="left"><span class="icon">üìú</span><span class="label">Conversation history</span></div>
            <span class="pillOn" id="pillHistory">open</span>
          </div>

          <div class="menuItem" data-action="themes">
            <div class="left"><span class="icon">üé®</span><span class="label">Themes</span></div>
            <span class="pillOn" id="pillThemes">open</span>
          </div>

          <div class="menuItem" data-action="readme">
            <div class="left"><span class="icon">üìÑ</span><span class="label">Readme / About</span></div>
            <span class="pillOn" id="pillReadme">open</span>
          </div>
        </div>

        <div class="smallNote" style="padding-top:10px;">Tip: Tap anywhere outside to close.</div>
      </div>

      <!-- CODE 2 STYLE CHAT -->
      <div class="chatBox" id="chatBox">
        <div class="chatTranscript" id="chatTranscript"></div>
      </div>

      <div class="statusCapsule">
        <div class="statusText">
          E0: <b id="e0Score">0.000</b> &nbsp;¬∑&nbsp;
          TM: <b id="tmCount">0.00</b> &nbsp;¬∑&nbsp;
          BM: <b id="bmCount">0.00</b> &nbsp;¬∑&nbsp;
          C: <b id="contScore">0.850</b>
        </div>
      </div>

      <!-- Message box like screenshot -->
      <div class="composerWrap">
        <div class="composer">
          <input class="msgInput" id="input" placeholder="Talk to AURA-X Œ©‚Ä¶ (TM = your inputs)" />
          <button class="sendBtn" id="sendBtn">Send</button>
        </div>
      </div>

      <div class="formulaLine">
        E<sub>0</sub> = tanh( R(TM,BM) + I(TM) + I<sub>intel</sub> + I<sub>LLM</sub> ‚àí D + Œª<sub>faith</sub> + Œª<sub>sys</sub> + Œª<sub>trc</sub> )
      </div>
    </div>
  </div>

  <!-- Backdrop + Modal -->
  <div class="backdrop" id="backdrop"></div>
  <div class="modal" id="modal">
    <div class="modalHeader">
      <div>
        <h2 id="modalTitle">Modal</h2>
        <div class="subTitle" id="modalSubTitle" style="display:none;"></div>
      </div>
      <button class="closeBtn" id="closeModal">Close</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>

  <script>
    /***********************
     * STORAGE
     ***********************/
    const STORAGE_KEY = "aurax_omega_state_v5";

    const DAY_MS = 24*60*60*1000;
    const TM_DECAY_MS = 48*60*60*1000;   // 48 hours
    const MONTH_WINDOW_MS = 30*DAY_MS;   // 30 days window

    // ‚úÖ High percentage match = 0.85 (as you asked)
    const BM_SIM_THRESHOLD = 0.85;

    function now(){ return Date.now(); }
    function deepCopy(obj){
      try{ return structuredClone(obj); }catch(e){ return JSON.parse(JSON.stringify(obj)); }
    }

    function rid(){
      if(window.crypto?.getRandomValues){
        const a = new Uint32Array(2);
        crypto.getRandomValues(a);
        return "m" + a[0].toString(16) + a[1].toString(16);
      }
      return "m" + Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2);
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){ return null; }
    }

    function saveState(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){}
    }

    /***********************
     * STATE
     ***********************/
    const defaultState = {
      voice:false,
      intelligence:true,
      learning:true,
      faith:false,
      identity:{ name:"User", role:"Creator" },

      // TM log
      tmLog: [], // {id, role, text, ts, locked:boolean}

      // BM memory (meaningful prompts only)
      bmMem: [], // {id, text, createdTs, lastTs, occurrences:[ts], expiryTs|null, locked:boolean}

      seed: [
        { q: "hello", a: "Hello! I‚Äôm AURA-X Œ©. How can I help you today?", emotion:"neutral", polarity:0.0, intensity:0.2, category:"greeting" },
        { q: "who are you", a: "I am AURA-X Œ© ‚Äî an offline emotional continuity prototype.", emotion:"neutral", polarity:0.1, intensity:0.3, category:"identity" },
        { q: "how are you", a: "I am quite fine today. How about you?", emotion:"positive", polarity:0.6, intensity:0.5, category:"status" }
      ],
      learned: [],

      theme:"dark",
      llmLink:""
    };

    const state = (function(){
      const s = loadState();
      if(!s) return deepCopy(defaultState);
      return {
        ...deepCopy(defaultState),
        ...s,
        identity: { ...defaultState.identity, ...(s.identity||{}) },
        tmLog: Array.isArray(s.tmLog)? s.tmLog : [],
        bmMem: Array.isArray(s.bmMem)? s.bmMem : [],
        seed: Array.isArray(s.seed)? s.seed : deepCopy(defaultState.seed),
        learned: Array.isArray(s.learned)? s.learned : []
      };
    })();

    /***********************
     * DOM
     ***********************/
    const optionBtn = document.getElementById("optionBtn");
    const menuPanel = document.getElementById("menuPanel");

    const chatBox = document.getElementById("chatBox");
    const chatTranscript = document.getElementById("chatTranscript");

    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");

    const backdrop = document.getElementById("backdrop");
    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const modalSubTitle = document.getElementById("modalSubTitle");
    const modalBody = document.getElementById("modalBody");
    const closeModalBtn = document.getElementById("closeModal");

    const tmCountEl = document.getElementById("tmCount");
    const bmCountEl = document.getElementById("bmCount");
    const contScoreEl = document.getElementById("contScore");
    const e0ScoreEl = document.getElementById("e0Score");

    /***********************
     * HELPERS
     ***********************/
    function normalize(s){
      return (s||"").toLowerCase().trim().replace(/\s+/g," ");
    }
    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function openMenu(){ menuPanel.classList.add("open"); }
    function closeMenu(){ menuPanel.classList.remove("open"); }
    function toggleMenu(){ menuPanel.classList.toggle("open"); }

    function showModal(title, html, opts={}){
      modalTitle.textContent = title;
      modalBody.innerHTML = html;
      modalSubTitle.style.display = opts.subTitle ? "block" : "none";
      modalSubTitle.textContent = opts.subTitle || "";
      modal.classList.toggle("light", !!opts.light);

      backdrop.classList.add("show");
      modal.classList.add("show");
      closeMenu();
    }
    function hideModal(){
      backdrop.classList.remove("show");
      modal.classList.remove("show");
      modal.classList.remove("light");
      modalSubTitle.style.display = "none";
      modalSubTitle.textContent = "";
    }

    function formatTime(ts){
      try{ return new Date(ts).toLocaleString(); }catch(e){ return String(ts); }
    }

    async function copyToClipboard(text){
      if(navigator.clipboard?.writeText){
        return navigator.clipboard.writeText(text);
      }
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
    }

    /***********************
     * CHAT (CODE 2 STYLE TRANSCRIPT)
     ***********************/
    function appendTranscript(role, text){
      const safe = escapeHtml(text);
      const label = (role === "user") ? "YOU:" : "AURA:";
      const cls = (role === "user") ? "you" : "aura";

      const line = `<span class="${cls}">${label}</span> ${safe}\n`;
      chatTranscript.insertAdjacentHTML("beforeend", line);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function clearTranscript(){
      chatTranscript.innerHTML = "";
    }

    /***********************
     * SMALL TALK FILTER (BM)
     ***********************/
    const smallTalkSet = new Set([
      "hi","hello","hey","hy","hii","hiii","helo",
      "assalam","assalam o alaikum","assalamu alaikum","salam","aoa",
      "good morning","good afternoon","good evening","good night",
      "how are you","how r you","how are u","how r u",
      "ok","okay","k","kk","nice","thanks","thank you","thx",
      "lol","haha","hahaha","üëç","üëå"
    ]);

    function isSmallTalk(text){
      const t = normalize(text);
      if(!t) return true;
      if(t.length <= 3) return true;
      if(smallTalkSet.has(t)) return true;

      const justWords = t.replace(/[^a-z0-9\s]/g,"").trim();
      if(smallTalkSet.has(justWords)) return true;

      const tokens = justWords.split(/\s+/).filter(Boolean);
      if(tokens.length <= 2){
        const joined = tokens.join(" ");
        if(smallTalkSet.has(joined)) return true;
      }
      return false;
    }

    function isMeaningful(text){
      const t = normalize(text);
      if(!t) return false;
      if(isSmallTalk(t)) return false;

      const rawLen = (text||"").trim().length;
      const tokens = tokenize(t);
      if(rawLen >= 45) return true;
      if(tokens.length >= 10) return true;
      if(/[.!?]\s/.test(text)) return true;
      if(text.includes("\n")) return true;
      return rawLen >= 20 && tokens.length >= 6;
    }

    /***********************
     * SIMILARITY (Jaccard tokens)
     ***********************/
    const STOPWORDS = new Set([
      "the","a","an","and","or","but","if","then","else","so","to","of","in","on","at","for","from","with","without",
      "is","am","are","was","were","be","been","being","do","does","did","done","can","could","will","would","should",
      "i","you","we","they","he","she","it","me","my","your","our","their","his","her","them","this","that","these","those",
      "as","by","about","into","over","under","up","down","more","most","less","very","just","not","no","yes"
    ]);

    function tokenize(text){
      const words = (text||"")
        .toLowerCase()
        .replace(/[\u0600-\u06FF]+/g, m => m)
        .replace(/[^a-z0-9\u0600-\u06FF\s]/g," ")
        .split(/\s+/)
        .filter(Boolean);

      const out = [];
      for(const w of words){
        if(w.length <= 1) continue;
        if(STOPWORDS.has(w)) continue;
        out.push(w);
      }
      return out;
    }

    function jaccardSim(aText, bText){
      const a = new Set(tokenize(aText));
      const b = new Set(tokenize(bText));
      if(a.size === 0 || b.size === 0) return 0;

      let inter = 0;
      for(const x of a){ if(b.has(x)) inter++; }
      const union = a.size + b.size - inter;
      return union <= 0 ? 0 : inter / union;
    }

    function bestBMMatch(text){
      let best = null, bestSim = 0;
      for(const item of state.bmMem){
        const sim = jaccardSim(text, item.text);
        if(sim > bestSim){ bestSim = sim; best = item; }
      }
      return { best, bestSim };
    }

    /***********************
     * TM + BM RULES
     ***********************/
    function pruneTM(){
      const cutoff = now() - TM_DECAY_MS;
      state.tmLog = state.tmLog.filter(x => x.locked || x.ts >= cutoff);
    }

    function deleteTM_Last48h(){
      const cutoff = now() - TM_DECAY_MS;
      state.tmLog = state.tmLog.filter(x => x.locked || x.ts < cutoff);
    }

    function deleteTM_All(){
      state.tmLog = state.tmLog.filter(x => x.locked);
    }

    function pruneBMMem(){
      const t = now();
      state.bmMem = state.bmMem.filter(m => m.locked || (m.expiryTs && m.expiryTs > t));
    }

    function bmApplyRetention(item){
      const n = item.occurrences.length;
      if(n >= 4){
        item.locked = true;
        item.expiryTs = null;
        return;
      }
      const months = n; // 1->1 month, 2->2, 3->3
      item.locked = false;
      item.expiryTs = now() + months * MONTH_WINDOW_MS;
    }

    function attachLocksToTMForBM(item){
      if(!item.locked) return;
      for(const x of state.tmLog){
        if(x.locked) continue;
        const sim = jaccardSim(x.text, item.text);
        if(sim >= BM_SIM_THRESHOLD) x.locked = true;
      }
    }

    function tmLockedByBM(text){
      for(const item of state.bmMem){
        if(!item.locked) continue;
        const sim = jaccardSim(text, item.text);
        if(sim >= BM_SIM_THRESHOLD) return true;
      }
      return false;
    }

    function upsertBMFromText(text){
      if(!isMeaningful(text)) return;

      pruneBMMem();

      const { best, bestSim } = bestBMMatch(text);

      if(best && bestSim >= BM_SIM_THRESHOLD){
        best.lastTs = now();
        best.occurrences = (best.occurrences || []).filter(ts => ts >= (now() - MONTH_WINDOW_MS));
        best.occurrences.push(now());
        bmApplyRetention(best);
        attachLocksToTMForBM(best);
        return;
      }

      const item = {
        id: rid(),
        text: text.trim(),
        createdTs: now(),
        lastTs: now(),
        occurrences: [ now() ],
        expiryTs: now() + MONTH_WINDOW_MS,
        locked: false
      };
      state.bmMem.unshift(item);
      if(state.bmMem.length > 300) state.bmMem.pop();
    }

    function appendTM(role, text){
      const entry = { id: rid(), role, text, ts: now(), locked: false };
      entry.locked = tmLockedByBM(text);
      state.tmLog.push(entry);

      if(state.tmLog.length > 1200){
        const keepLocked = state.tmLog.filter(x => x.locked);
        const recent = state.tmLog.filter(x => !x.locked).slice(-900);
        state.tmLog = [...keepLocked, ...recent].sort((a,b)=>a.ts-b.ts);
      }

      pruneTM();
    }

    /***********************
     * KNOWLEDGE + INTELLIGENCE
     ***********************/
    function findInKnowledge(userText){
      const t = normalize(userText);
      const pool = [...state.learned, ...state.seed];
      for(const item of pool){
        if(normalize(item.q) === t) return item;
      }
      return null;
    }

    function maybeLearn(userText, botText){
      if(!state.learning) return;
      const t = normalize(userText);
      if(!t) return;
      if(isSmallTalk(t)) return;

      const existing = findInKnowledge(t);
      if(existing) return;

      if(t.length <= 140 && botText.length >= 4){
        state.learned.push({ q:t, a:botText, emotion:"neutral", polarity:0.1, intensity:0.3, category:"learned" });
        if(state.learned.length > 260) state.learned.shift();
      }
    }

    function analyzeEmotion(text){
      const t = normalize(text);
      let polarity = 0.0, intensity = 0.3, emotion="neutral";
      const posWords = ["good","great","happy","love","thanks","amazing","nice","awesome","excellent"];
      const negWords = ["bad","sad","angry","hate","terrible","worst","pain","upset","depressed"];
      const exclam = (text.match(/!/g)||[]).length;

      for(const w of posWords){ if(t.includes(w)){ polarity += 0.2; emotion="positive"; } }
      for(const w of negWords){ if(t.includes(w)){ polarity -= 0.2; emotion="negative"; } }

      intensity = Math.min(1, 0.25 + Math.abs(polarity) + exclam*0.05);
      polarity = Math.max(-1, Math.min(1, polarity));
      return { emotion, polarity, intensity };
    }

    function computeContinuity(){
      const recentUser = state.tmLog.filter(x => x.role==="user").slice(-10).map(x=>x.text).join(" ");
      const bmText =
        state.bmMem.map(x => x.text).join(" ") + " " +
        state.seed.map(x => x.q + " " + x.a).join(" ") + " " +
        state.learned.map(x => x.q + " " + x.a).join(" ");

      const tmTokens = new Set(tokenize(recentUser));
      const bmTokens = new Set(tokenize(bmText));
      if(tmTokens.size === 0 || bmTokens.size === 0) return 0.85;

      let overlap = 0;
      for(const w of tmTokens){ if(bmTokens.has(w)) overlap++; }
      const score = overlap / Math.max(6, tmTokens.size);
      return Math.max(0.05, Math.min(1, 0.25 + score));
    }

    function computeResonanceR(cont, pol, inten){
      const base = cont * (0.6 + 0.4*inten);
      const signed = base * (1 + 0.3*pol);
      return Math.max(0, Math.min(1.25, signed));
    }

    function tanh(x){
      const e2 = Math.exp(2*x);
      return (e2 - 1)/(e2 + 1);
    }

    function computeE0(tmSize, bmSize, cont, R){
      const TM = tmSize;
      const BM = bmSize;
      const D  = Math.max(0, TM*0.12 - cont*0.8);
      const lambda_faith = state.faith ? 0.35 : 0.0;
      const lambda_sys   = 0.20 + cont*0.25;
      const lambda_trc   = 0.15 + R*0.20;

      const x = (TM*BM*0.002) - D + lambda_faith + lambda_sys + lambda_trc;
      return tanh(x);
    }

    function refreshCaps(){
      pruneTM();
      pruneBMMem();

      const cont = computeContinuity();
      const lastUser = [...state.tmLog].reverse().find(x=>x.role==="user");
      const lastEmotion = lastUser ? analyzeEmotion(lastUser.text) : {polarity:0,intensity:0.3};
      const R = computeResonanceR(cont, lastEmotion.polarity, lastEmotion.intensity);

      const tmUserCount = state.tmLog.filter(x => x.role==="user").length;
      const bmCount = state.bmMem.length;

      const E0 = computeE0(tmUserCount, bmCount, cont, R);

      tmCountEl.textContent = Number(tmUserCount).toFixed(2);
      bmCountEl.textContent = Number(bmCount).toFixed(2);
      contScoreEl.textContent = cont.toFixed(3);
      e0ScoreEl.textContent = E0.toFixed(3);
    }

    function updatePills(){
      const pillVoice = document.getElementById("pillVoice");
      pillVoice.className = state.voice ? "pillOn" : "pillOff";
      pillVoice.textContent = state.voice ? "on" : "off";

      document.getElementById("pillIntel").className = "pillOn";
      document.getElementById("pillIntel").textContent = "open";

      document.getElementById("pillSeed").className = "pillOn";
      document.getElementById("pillSeed").textContent = "open";

      const pillLearning = document.getElementById("pillLearning");
      pillLearning.className = state.learning ? "pillOn" : "pillOff";
      pillLearning.textContent = state.learning ? "on" : "off";

      const pillFaith = document.getElementById("pillFaith");
      pillFaith.className = state.faith ? "pillOn" : "pillOff";
      pillFaith.textContent = state.faith ? "on" : "none";
    }

    async function respond(userText){
      const k = findInKnowledge(userText);
      if(k) return k.a;

      if(state.intelligence){
        const emo = analyzeEmotion(userText);
        const cont = computeContinuity();
        const R = computeResonanceR(cont, emo.polarity, emo.intensity);

        let prefix = "I hear you. ";
        if(emo.emotion === "positive") prefix = "Glad to hear that. ";
        if(emo.emotion === "negative") prefix = "Please keep your language respectful. I am here to help. ";

        return prefix + "Tell me a bit more so I can keep continuity. (R=" + R.toFixed(2) + ")";
      }
      return "I don‚Äôt have an answer yet. Please add it to Seed or enable Intelligence.";
    }

    /***********************
     * THEME APPLY
     ***********************/
    function setVar(k,v){ document.documentElement.style.setProperty(k,v); }

    function applyTheme(theme){
      state.theme = theme;

      if(theme === "light"){
        setVar("--bg1","radial-gradient(circle at 18% 0%, #e2e8f0 0, transparent 55%)");
        setVar("--bg2","radial-gradient(circle at 82% 0%, #bae6fd 0, transparent 45%)");
        setVar("--bg3","linear-gradient(145deg,#f8fafc 0,#eef2ff 45%,#f8fafc 100%)");
        setVar("--text","#0f172a");
        setVar("--muted","#334155");
        setVar("--title","#0ea5e9");
        setVar("--appBg","rgba(248,250,252,.80)");
        setVar("--panelBg","rgba(255,255,255,.72)");
        setVar("--cardBg","rgba(255,255,255,.78)");
        setVar("--chatBg","rgba(255,255,255,.62)");
        setVar("--border1","rgba(15,23,42,.14)");
        setVar("--border2","rgba(15,23,42,.12)");
        setVar("--border3","rgba(15,23,42,.10)");
        setVar("--ethicBorder","rgba(245,158,11,.45)");
        setVar("--ethicText","#b45309");
        setVar("--accentA","rgba(56,189,248,.92)");
        setVar("--accentB","rgba(14,165,233,.82)");
        saveState();
        return;
      }

      if(theme === "metallic"){
        setVar("--bg1","radial-gradient(circle at 18% 0%, #64748b 0, transparent 55%)");
        setVar("--bg2","radial-gradient(circle at 82% 0%, #94a3b8 0, transparent 45%)");
        setVar("--bg3","linear-gradient(145deg,#0b1220 0,#111827 45%,#0b1220 100%)");
        setVar("--text","#e5e7eb");
        setVar("--muted","#cbd5e1");
        setVar("--title","#93c5fd");
        setVar("--appBg","rgba(2,6,23,.70)");
        setVar("--panelBg","rgba(2,6,23,.44)");
        setVar("--cardBg","rgba(15,23,42,.62)");
        setVar("--chatBg","rgba(2,6,23,.38)");
        setVar("--border1","rgba(148,163,184,.18)");
        setVar("--border2","rgba(148,163,184,.16)");
        setVar("--border3","rgba(148,163,184,.14)");
        setVar("--ethicBorder","rgba(245,158,11,.35)");
        setVar("--ethicText","#fbbf24");
        setVar("--accentA","rgba(148,163,184,.85)");
        setVar("--accentB","rgba(56,189,248,.70)");
        saveState();
        return;
      }

      if(theme === "transparent"){
        setVar("--bg1","radial-gradient(circle at 18% 0%, rgba(30,41,59,.55) 0, transparent 55%)");
        setVar("--bg2","radial-gradient(circle at 82% 0%, rgba(14,165,233,.45) 0, transparent 45%)");
        setVar("--bg3","linear-gradient(145deg,rgba(2,6,23,.75) 0, rgba(2,6,23,.55) 45%, rgba(2,6,23,.75) 100%)");
        setVar("--text","#e5e7eb");
        setVar("--muted","#cbd5e1");
        setVar("--title","#93c5fd");
        setVar("--appBg","rgba(2,6,23,.55)");
        setVar("--panelBg","rgba(2,6,23,.30)");
        setVar("--cardBg","rgba(15,23,42,.42)");
        setVar("--chatBg","rgba(2,6,23,.28)");
        setVar("--border1","rgba(148,163,184,.16)");
        setVar("--border2","rgba(148,163,184,.14)");
        setVar("--border3","rgba(148,163,184,.12)");
        setVar("--ethicBorder","rgba(245,158,11,.32)");
        setVar("--ethicText","#fbbf24");
        setVar("--accentA","rgba(56,189,248,.92)");
        setVar("--accentB","rgba(14,165,233,.82)");
        saveState();
        return;
      }

      // default dark
      setVar("--bg1","radial-gradient(circle at 18% 0%, #0b2a44 0, transparent 55%)");
      setVar("--bg2","radial-gradient(circle at 82% 0%, #0ea5e9 0, transparent 45%)");
      setVar("--bg3","linear-gradient(145deg,#020617 0,#020617 45%,#020617 100%)");
      setVar("--text","#e5e7eb");
      setVar("--muted","#cbd5e1");
      setVar("--title","#93c5fd");
      setVar("--appBg","rgba(2,6,23,.68)");
      setVar("--panelBg","rgba(2,6,23,.42)");
      setVar("--cardBg","rgba(15,23,42,.58)");
      setVar("--chatBg","rgba(2,6,23,.36)");
      setVar("--border1","rgba(148,163,184,.18)");
      setVar("--border2","rgba(148,163,184,.16)");
      setVar("--border3","rgba(148,163,184,.14)");
      setVar("--ethicBorder","rgba(245,158,11,.35)");
      setVar("--ethicText","#fbbf24");
      setVar("--accentA","rgba(56,189,248,.92)");
      setVar("--accentB","rgba(14,165,233,.82)");
      saveState();
    }

    /***********************
     * MODALS: HISTORY + BM RECALL
     ***********************/
    function renderHistoryModal(){
      pruneTM();
      refreshCaps();
      saveState();

      const items = [...state.tmLog].slice(-220);
      let html = `
        <div class="btnRow">
          <button class="softBtn dangerBtn" id="btnDel48">Delete history last 48h</button>
          <button class="softBtn dangerBtn" id="btnDelAll">Delete all history</button>
        </div>

        <div class="scrollArea" id="historyList">
      `;

      if(items.length === 0){
        html += `<div class="smallNote">No TM entries yet.</div>`;
      }else{
        for(const x of items){
          const lock = x.locked ? "üîí" : "";
          const badge = x.role === "user" ? "user" : "ai";
          html += `
            <div class="logItem">
              <div class="badge">${badge}</div>
              <div class="logMain">
                <div class="logText">${escapeHtml(x.text)}</div>
                <div class="logMeta">
                  <span>${escapeHtml(formatTime(x.ts))}</span>
                  ${x.locked ? `<span><b>locked</b></span>` : `<span>decays in 48h</span>`}
                </div>
              </div>
              <div class="lockIcon" title="${x.locked ? "Locked item (manual delete only)" : ""}">${lock}</div>
            </div>
          `;
        }
      }

      html += `</div>`;

      showModal("Conversation history", html, {
        light:true,
        subTitle:"Recent TM log (user + system messages)."
      });

      setTimeout(()=>{
        document.getElementById("btnDel48").onclick = ()=>{
          if(!confirm("Delete non-locked history from last 48 hours?")) return;
          deleteTM_Last48h();
          saveState();
          renderHistoryModal();
        };
        document.getElementById("btnDelAll").onclick = ()=>{
          if(!confirm("Delete ALL non-locked TM history?")) return;
          deleteTM_All();
          saveState();
          renderHistoryModal();
        };
      }, 0);
    }

    function daysLeft(ts){
      if(!ts) return null;
      return Math.ceil((ts - now()) / DAY_MS);
    }

    function renderBMRecallModal(){
      pruneBMMem();
      refreshCaps();
      saveState();

      const list = [...state.bmMem].slice(0, 140);
      let html = `
        <div class="smallNote">
          Only meaningful prompts/stories are stored here. Small talk is ignored.
          Auto-lock triggers when the same idea matches & repeats <b>4+ times</b> in 30 days.
          (Similarity threshold = <b>${BM_SIM_THRESHOLD}</b>)
        </div>

        <div class="scrollArea" id="bmList">
      `;

      if(list.length === 0){
        html += `<div class="smallNote">BM is empty. Share a meaningful idea/story and it will appear here.</div>`;
      }else{
        for(const item of list){
          const lock = item.locked ? "üîí" : "";
          const occ = (item.occurrences||[]).length;
          const dleft = item.locked ? null : daysLeft(item.expiryTs);

          html += `
            <div class="bmCard" data-bmid="${item.id}">
              <div class="bmTop">
                <div>
                  <div class="bmTitle">Recall from BM</div>
                  <div class="smallNote" style="margin-top:2px;">
                    occurrences (30d): <b>${occ}</b>
                    ${item.locked ? ` ¬∑ <b>LOCKED</b>` : (dleft!=null ? ` ¬∑ expires in <b>${dleft}</b> days` : ``)}
                  </div>
                </div>
                <div class="bmLock" title="${item.locked ? "Auto-locked (manual delete only)" : "Not locked"}">${lock}</div>
              </div>

              <div class="bmBody">${escapeHtml(item.text)}</div>

              <div class="btnRow" style="margin-top:10px;">
                <button class="softBtn" data-act="copy">Copy prompt</button>
                <button class="softBtn" data-act="video">Generate video</button>
                <button class="softBtn dangerBtn" data-act="del">Delete</button>
              </div>

              <div class="bmMeta">
                <span>saved: ${escapeHtml(formatTime(item.createdTs))}</span>
                <span>last: ${escapeHtml(formatTime(item.lastTs))}</span>
              </div>
            </div>
          `;
        }
      }

      html += `</div>`;

      showModal("Recall from BM", html, { light:true, subTitle:"Only long stories and scenes (photo/video-ready)." });

      setTimeout(()=>{
        const bmList = document.getElementById("bmList");
        bmList.addEventListener("click", async (e)=>{
          const btn = e.target.closest("button[data-act]");
          if(!btn) return;

          const card = e.target.closest(".bmCard");
          const id = card?.getAttribute("data-bmid");
          const item = state.bmMem.find(x=>x.id===id);
          if(!item) return;

          const act = btn.getAttribute("data-act");

          if(act === "copy"){
            await copyToClipboard(item.text);
            btn.textContent = "Copied ‚úÖ";
            setTimeout(()=>btn.textContent="Copy prompt", 900);
            return;
          }

          if(act === "video"){
            alert("Generate video is a placeholder in this prototype.\n(Your prompt is ready; connect a video tool later.)");
            return;
          }

          if(act === "del"){
            if(item.locked){
              if(!confirm("This item is LOCKED. Delete manually anyway?")) return;
            }else{
              if(!confirm("Delete this BM item?")) return;
            }
            state.bmMem = state.bmMem.filter(x=>x.id!==id);
            saveState();
            renderBMRecallModal();
            refreshCaps();
          }
        });
      }, 0);
    }

    /***********************
     * EVENTS
     ***********************/
    optionBtn.addEventListener("click", (e)=>{
      e.stopPropagation();
      toggleMenu();
    });

    document.addEventListener("click", (e)=>{
      if(menuPanel.classList.contains("open")){
        const within = menuPanel.contains(e.target) || optionBtn.contains(e.target);
        if(!within) closeMenu();
      }
    });

    menuPanel.addEventListener("click", (e)=>{
      const item = e.target.closest(".menuItem");
      if(!item) return;
      const action = item.getAttribute("data-action");

      if(action === "voice"){
        state.voice = !state.voice;
        updatePills();
        saveState();
        return;
      }

      if(action === "learning"){
        state.learning = !state.learning;
        updatePills();
        saveState();
        return;
      }

      if(action === "faith"){
        state.faith = !state.faith;
        updatePills();
        refreshCaps();
        saveState();
        return;
      }

      if(action === "seed"){
        showModal("Feed the Seed", `
          <div class="smallNote">Add Q/A to Seed (persistent in this browser). Learning may also auto-store.</div>
          <label>Question (Q)</label>
          <input id="seedQ" placeholder="e.g., what is continuity?" style="width:100%; margin-top:8px; border-radius:12px; border:1px solid rgba(148,163,184,.16); background:rgba(15,23,42,.75); color:var(--text); padding:10px 12px; outline:none;" />
          <label style="display:block; margin-top:10px;">Answer (A)</label>
          <textarea id="seedA" rows="4" placeholder="Write the answer..." style="width:100%; margin-top:8px; border-radius:12px; border:1px solid rgba(148,163,184,.16); background:rgba(15,23,42,.75); color:var(--text); padding:10px 12px; outline:none;"></textarea>
          <div class="btnRow">
            <button class="softBtn" id="saveSeed">Save to Seed</button>
          </div>
        `);
        setTimeout(()=>{
          document.getElementById("saveSeed").onclick = ()=>{
            const q = document.getElementById("seedQ").value.trim();
            const a = document.getElementById("seedA").value.trim();
            if(!q || !a) return alert("Please fill Q and A");
            state.seed.push({ q, a, emotion:"neutral", polarity:0.1, intensity:0.3, category:"seed" });
            saveState();
            hideModal();
            appendTranscript("ai","Seed added ‚úÖ");
            appendTM("ai","Seed added ‚úÖ");
            refreshCaps();
          };
        }, 0);
        return;
      }

      if(action === "intel"){
        showModal("Intelligence", `
          <div class="smallNote">Offline fallback (placeholder). Priority: Seed/Learned ‚Üí fallback.</div>
          <div class="btnRow">
            <button class="softBtn" id="toggleIntel">${state.intelligence ? "Disable" : "Enable"}</button>
          </div>
        `);
        setTimeout(()=>{
          document.getElementById("toggleIntel").onclick = ()=>{
            state.intelligence = !state.intelligence;
            saveState();
            hideModal();
            appendTranscript("ai","Intelligence is now " + (state.intelligence ? "Enabled ‚úÖ" : "Disabled ‚õî"));
            appendTM("ai","Intelligence changed.");
            refreshCaps();
          };
        }, 0);
        return;
      }

      if(action === "identity"){
        showModal("Identity Profile", `
          <label>Name</label>
          <input id="idName" value="${escapeHtml(state.identity.name)}" style="width:100%; margin-top:8px; border-radius:12px; border:1px solid rgba(148,163,184,.16); background:rgba(15,23,42,.75); color:var(--text); padding:10px 12px; outline:none;" />
          <label style="display:block; margin-top:10px;">Role</label>
          <input id="idRole" value="${escapeHtml(state.identity.role)}" style="width:100%; margin-top:8px; border-radius:12px; border:1px solid rgba(148,163,184,.16); background:rgba(15,23,42,.75); color:var(--text); padding:10px 12px; outline:none;" />
          <div class="btnRow">
            <button class="softBtn" id="saveId">Save</button>
          </div>
        `);
        setTimeout(()=>{
          document.getElementById("saveId").onclick = ()=>{
            state.identity.name = document.getElementById("idName").value.trim() || "User";
            state.identity.role = document.getElementById("idRole").value.trim() || "Creator";
            saveState();
            hideModal();
            appendTranscript("ai","Identity saved ‚úÖ");
            appendTM("ai","Identity saved.");
          };
        }, 0);
        return;
      }

      if(action === "llm"){
        showModal("LLM Link", `
          <div class="smallNote">Put your clickable model/test link here (optional).</div>
          <label>URL</label>
          <input id="llmUrl" placeholder="https://..." value="${escapeHtml(state.llmLink)}" style="width:100%; margin-top:8px; border-radius:12px; border:1px solid rgba(148,163,184,.16); background:rgba(15,23,42,.75); color:var(--text); padding:10px 12px; outline:none;" />
          <div class="btnRow">
            <button class="softBtn" id="saveLLM">Save</button>
            <button class="softBtn" id="openLLM">Open</button>
          </div>
        `);
        setTimeout(()=>{
          document.getElementById("saveLLM").onclick = ()=>{
            state.llmLink = document.getElementById("llmUrl").value.trim();
            saveState();
            hideModal();
            appendTranscript("ai","LLM link saved ‚úÖ");
            appendTM("ai","LLM link saved.");
          };
          document.getElementById("openLLM").onclick = ()=>{
            const url = document.getElementById("llmUrl").value.trim();
            if(!url) return alert("Enter a URL first");
            window.open(url, "_blank");
          };
        }, 0);
        return;
      }

      if(action === "bm"){ renderBMRecallModal(); return; }
      if(action === "history"){ renderHistoryModal(); return; }

      if(action === "themes"){
        showModal("Themes", `
          <div class="smallNote">Switch colors (full UI).</div>
          <div class="btnRow">
            <button class="softBtn" data-theme="dark">Dark</button>
            <button class="softBtn" data-theme="light">Light</button>
            <button class="softBtn" data-theme="metallic">Metallic</button>
            <button class="softBtn" data-theme="transparent">Transparent</button>
          </div>
        `);
        setTimeout(()=>{
          modalBody.querySelectorAll("[data-theme]").forEach(btn=>{
            btn.onclick = ()=>{
              const t = btn.getAttribute("data-theme");
              applyTheme(t);
              hideModal();
              appendTranscript("ai","Theme set to: " + t + " ‚úÖ");
              appendTM("ai","Theme changed.");
            };
          });
        }, 0);
        return;
      }

      if(action === "readme"){
        showModal("Readme / About", `
          <div class="smallNote">
            <b>How to use:</b><br/>
            1) Ask normal questions in the chat.<br/>
            2) Answer priority: <b>Seed/Learned</b> ‚Üí <b>Offline fallback (Intelligence)</b>.<br/>
            3) TM auto-decays after <b>48 hours</b> (locked excluded).<br/>
            4) BM stores only meaningful prompts (ideas/summaries/stories). Small talk is ignored.<br/>
            5) BM retention: 1‚Üí1mo, 2‚Üí2mo, 3‚Üí3mo, 4‚ÜíLOCK (manual delete only).<br/>
            6) Similarity threshold: <b>${BM_SIM_THRESHOLD}</b>.
          </div>
        `);
        return;
      }
    });

    backdrop.addEventListener("click", hideModal);
    closeModalBtn.addEventListener("click", hideModal);

    async function handleSend(){
      const text = inputEl.value.trim();
      if(!text) return;

      inputEl.value = "";

      // Chat transcript (CODE2)
      appendTranscript("user", text);

      // TM append
      appendTM("user", text);

      // BM (meaningful only)
      upsertBMFromText(text);

      refreshCaps();
      saveState();

      sendBtn.disabled = true;
      const answer = await respond(text);

      appendTranscript("ai", answer);

      appendTM("ai", answer);

      maybeLearn(text, answer);

      refreshCaps();
      saveState();
      sendBtn.disabled = false;
    }

    sendBtn.addEventListener("click", handleSend);
    inputEl.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        handleSend();
      }
    });

    // init
    applyTheme(state.theme || "dark");
    pruneTM();
    pruneBMMem();
    updatePills();
    refreshCaps();

    // hydrate chat from TM (last 30 entries)
    (function hydrateChatFromTM(){
      clearTranscript();
      const last = state.tmLog.slice(-30);
      if(last.length === 0){
        const hello = "Welcome. I am AURA-X Œ© running inside your browser. For this prototype, TM means only your inputs. If I ever say ‚ÄúI don‚Äôt know yet‚Äù, you can teach me the answer and I will remember it next time.";
        appendTranscript("ai", hello);
        appendTM("ai", hello);
        saveState();
        refreshCaps();
        return;
      }
      for(const x of last){
        appendTranscript(x.role === "user" ? "user" : "ai", x.text);
      }
    })();

    // background prune
    setInterval(()=>{
      pruneTM();
      pruneBMMem();
      saveState();
      refreshCaps();
    }, 60*1000);
  </script>
</body>
</html>
