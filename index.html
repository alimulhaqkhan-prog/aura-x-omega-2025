<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Î© â€“ Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    /* RESET & BASICS */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:20px;
    }
    .app{
      width:100%;
      max-width:1100px;
      background:radial-gradient(circle at top,#020617 0,#020617 35%,#020617 100%);
      border-radius:26px;
      box-shadow: 0 26px 80px rgba(15,23,42,.85), 0 0 0 1px rgba(148,163,184,.45);
      padding:18px 20px 12px;
      display:flex;
      flex-direction:column;
      gap:14px;
      position: relative;
      overflow:visible;
    }
    /* Header & Layout Styles */
    .header{
      position: relative; border-radius: 24px; padding: 16px 18px 14px; display: grid; grid-template-columns: 1.2fr .8fr; gap: 14px; align-items: center;
      background: radial-gradient(900px 320px at 20% 0%, rgba(56,189,248,.32), rgba(15,23,42,.98) 55%, #020617 100%);
      border: 1.5px solid rgba(148,163,184,.55); box-shadow: 0 26px 70px rgba(15,23,42,.9), inset 0 1px 0 rgba(255,255,255,.08); z-index:5;
    }
    .title-block h1{ font-size: 1.7rem; letter-spacing: .10em; text-transform: uppercase; font-weight: 800; line-height: 1.05; }
    .title-block h1 span{ background: linear-gradient(120deg,#38bdf8,#22d3ee,#a5b4fc); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .hero-line{ margin-top: 6px; font-size: .9rem; color: rgba(226,232,240,.96); font-weight: 600; }
    .title-sub{ margin-top: 4px; font-size: .8rem; color: rgba(148,163,184,.98); line-height: 1.35; }
    .header-right{ position:relative; z-index:1; display:flex; flex-direction:column; align-items:flex-end; gap:10px; }
    .mode-pill{
      width: min(320px, 100%); padding: 14px 16px; border-radius: 999px; border: 1px solid rgba(34,211,238,.6);
      background: radial-gradient(700px 210px at 20% 20%, rgba(34,211,238,.45), rgba(34,211,238,.18) 45%, rgba(2,6,23,.10) 100%), linear-gradient(135deg, rgba(34,211,238,.45), rgba(6,182,212,.24));
      color: rgba(240,253,250,.98); font-size: .88rem; font-weight: 800; text-transform: uppercase; text-align: center; box-shadow: 0 18px 50px rgba(34,211,238,.35);
    }
    .voice-toggle{ border:none; padding: 6px 12px; border-radius: 999px; font-size: .85rem; background: rgba(248,250,252,.96); color: #0f172a; cursor: pointer; display:flex; align-items:center; gap:8px; }
    .option-panel{ position:absolute; top:115%; right:0; display:none; flex-direction:column; gap:6px; padding:8px; border-radius:16px; background:rgba(15,23,42,.98); border:1px solid rgba(148,163,184,.8); z-index:40; min-width:220px; }
    .header-controls{ position: relative; }
    .header-controls.open .option-panel{display:flex;}
    .small-toggle{ border:none; padding:6px 10px; border-radius:999px; font-size:.78rem; background:#020617; color:#e5e7eb; border:1px solid rgba(148,163,184,.9); cursor:pointer; display:flex; align-items:center; gap:6px; }
    
    /* Grid & Cards */
    .layout{ display:grid; grid-template-columns:minmax(0,1.1fr) minmax(0,1fr); gap:18px; margin-top:4px; margin-bottom: 20px; }
    .card{ background:#f9fafb; border-radius:18px; padding:16px 16px 14px; border:1px solid #e5e7eb; box-shadow:0 10px 25px rgba(15,23,42,.45); }
    .card-title{ font-size:.95rem; font-weight:600; color:#0f172a; display:flex; align-items:center; gap:6px; }
    .metrics-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; margin-top:4px; }
    .metric{ background:#ffffff; border-radius:12px; padding:10px; border:1px solid #e5e7eb; }
    .metric-value{ font-size:1.1rem; font-weight:700; color:#1d4ed8; }
    
    /* Chat & Input */
    .answer-box{ background:#020617; border-radius:12px; padding:10px; border:1px solid #020617; color:#e5e7eb; min-height:200px; max-height:400px; display:flex; flex-direction:column; }
    .chat-container{ background:transparent; border:none; padding:0; height:100%; overflow-y:auto; flex:1; }
    .message{ max-width:100%; padding:6px 7px; margin-bottom:6px; border-radius:8px; font-size:.85rem; line-height:1.5; white-space:pre-wrap; }
    .ai-message{ background:#0f172a; border:1px solid #1e293b; color: #e2e8f0; }
    .user-message{ background:#1e293b; border:1px solid #334155; color: #f8fafc; }
    .input-footer { margin-top: 4px; padding: 10px; position: sticky; bottom: 0; background: linear-gradient(to bottom, rgba(2,6,23,0), rgba(2,6,23,0.95)); z-index:10; }
    .input-shell { display: flex; align-items: center; width: 100%; max-width: 720px; background: #1e293b; border: 1px solid #475569; border-radius: 999px; padding: 6px 12px; margin: 0 auto; }
    .message-input { flex: 1; min-height: 26px; border: none; outline: none; background: transparent; color: #f9fafb; font-size: 1rem; }
    .send-button { border: none; height: 38px; padding: 0 18px; background: linear-gradient(135deg, #2563eb, #06b6d4); color: white; font-weight: 600; border-radius: 19px; cursor: pointer; margin-left: 6px; }

    /* Modals */
    .modal-overlay{ position:fixed; inset:0; background:rgba(15,23,42,.6); display:none; align-items:center; justify-content:center; z-index:60; backdrop-filter:blur(4px); }
    .modal-overlay.visible{display:flex;}
    .modal-card{ background:#f9fafb; border-radius:18px; width:min(600px,96vw); max-height:80vh; padding:20px; display:flex; flex-direction:column; gap:10px; }
    .modal-search{ width:100%; padding:8px; border-radius:8px; border:1px solid #ccc; margin-top:5px; }
    .btn-mini{ font-size:.75rem; padding:6px 12px; border-radius:999px; border:1px solid #dbeafe; background:#eff6ff; cursor:pointer; color:#1d4ed8; }
    
    /* Offline Specific UI */
    .offline-box { border: 1px solid #10b981; background: #ecfdf5; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
    .offline-status { font-size: 0.75rem; color: #047857; margin-top: 5px; font-weight: bold; }
    .btn-offline { background: #10b981 !important; color: white !important; border: none !important; }

    @media(max-width:900px){ .layout{grid-template-columns:1fr} }
  </style>
</head>
<body>

<div class="app">
  <header class="header">
    <div class="title-block">
      <h1><span>AURA-X Î©</span></h1>
      <div class="hero-line">Worldâ€™s first synthetic emotions engine</div>
      <div class="title-sub">TM = user inputs only Â· TM âŸ‚ (BM + Intel + LLM) â†’ Eâ‚€ state</div>
    </div>
    <div class="header-right">
      <div class="mode-pill">ENGINE ACTIVE</div>
      <div class="header-controls" id="headerControls">
        <button id="optionsToggle" class="voice-toggle">âš™ Options</button>
        <div class="option-panel" id="optionPanel">
          <button id="voiceToggle" class="small-toggle">ðŸŽ¤ Voice: OFF</button>
          <button id="intelButton" class="small-toggle">ðŸ§  Intelligence</button>
          <button id="feedSeedButton" class="small-toggle">ðŸŒ± Feed seed</button>
          <button id="learningToggle" class="small-toggle">ðŸ“š Learning: ON</button>
          <button id="llmSettingsButton" class="small-toggle">ðŸ¤– LLM / Offline</button>
        </div>
      </div>
    </div>
  </header>

  <main class="layout">
    <div class="left-col">
      <section class="card">
        <div class="card-title"><span class="emoji">ðŸ§ª</span> Metrics</div>
        <div class="metrics-grid">
          <div class="metric"><div class="metric-label">Emotional Eâ‚€</div><div id="metricE0" class="metric-value">0.00</div></div>
          <div class="metric"><div class="metric-label">TM Activation</div><div id="metricTM" class="metric-value">0.00</div></div>
        </div>
      </section>
      <section class="card">
        <div class="card-title"><span class="emoji">ðŸ§ </span> Bold Memory Layers</div>
        <div class="bm-wrapper" style="margin-top:10px;">
          <div class="bm-canvas-shell" style="height:100px; background:#e2e8f0; border-radius:8px; position:relative;">
             <div id="bmStats" style="position:absolute; bottom:5px; width:100%; text-align:center; font-size:0.7rem; color:#64748b;">Active layers: 0/240</div>
             <canvas id="bmCanvas" style="width:100%; height:100%;"></canvas>
          </div>
        </div>
      </section>
    </div>

    <div class="right-col">
      <section class="card answer-card" style="height:100%;">
        <div class="card-title"><span class="emoji">ðŸ’¬</span> Continuity Console</div>
        <div class="answer-box">
          <div id="chatContainer" class="chat-container"></div>
        </div>
      </section>
    </div>
  </main>

  <footer class="input-footer">
    <div class="input-shell">
      <input type="text" id="messageInput" class="message-input" placeholder="Communicate with AURA-X Î©...">
      <button id="sendButton" class="send-button">Send</button>
    </div>
  </footer>
</div>

<div id="llmModal" class="modal-overlay">
  <div class="modal-card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3>ðŸ¤– LLM & Offline Settings</h3>
      <button class="modal-close" data-close="llmModal">âœ•</button>
    </div>
    
    <div class="offline-box">
      <p style="font-size:0.8rem; color:#065f46;"><strong>Offline Mode (WebGPU):</strong> Run TinyLlama directly in browser (No Internet required after download).</p>
      <button id="offlineLoadBtn" class="btn-mini btn-offline">ðŸ“¥ Download / Load TinyLlama</button>
      <div id="offlineStatus" class="offline-status">Status: Not Loaded</div>
    </div>

    <div style="border-top:1px solid #ddd; padding-top:10px;">
      <p style="font-size:0.8rem; margin-bottom:5px;"><strong>Cloud API (Optional):</strong></p>
      <label style="font-size:0.75rem;">Model Name (Empty = Auto gpt-4o-mini)</label>
      <input id="llmModelInput" class="modal-search" placeholder="Leave empty for auto..." />
      
      <label style="font-size:0.75rem;">API Key</label>
      <input id="llmKeyInput" type="password" class="modal-search" placeholder="sk-..." />
      
      <div style="margin-top:10px; display:flex; gap:10px;">
        <button id="llmSaveBtn" class="btn-mini">Save Settings</button>
        <button id="llmToggleBtn" class="btn-mini">Engine: OFF</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // --- Constants ---
  const STORAGE_KEY = "auraXOmegaState_v7";
  
  class AuraXOmegaEngine {
    constructor(){
      const saved = this.loadState() || {};
      
      // âœ… Feature 2: Voice Recognition Setup
      this.voiceOn = saved.voiceOn || false;
      this.recognition = null;
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
        this.recognition = new SpeechRec();
        this.recognition.lang = 'ur-PK'; // Urdu Default
        this.recognition.continuous = false;
        this.recognition.interimResults = false;
        this.recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          this.messageInput.value = transcript;
          this.handleSend(); // Auto-send on voice end
        };
      }

      // âœ… Feature 1: Offline Engine Setup
      this.localLLMEngine = null;
      this.offlineLoaded = false;
      this.localModelId = "TinyLlama-1.1B-Chat-v1.0-q4f16_1-MLC";

      // Core State
      this.llmEnabled = saved.llmEnabled || false;
      this.llmConfig = saved.llmConfig || { apiKey: "", baseUrl: "https://api.openai.com/v1/chat/completions", model: "" };
      
      this.bmLayers = saved.bmLayers || new Array(240).fill(0.1);
      this.tmHistory = saved.tmHistory || [];
      this.intelNodes = saved.intelNodes || [];
      this.e0 = saved.e0 || 0.0;
      this.learningMode = true;
      this.intelTeachState = "idle"; 

      // Seed Rules (Priority 1)
      this.seedRules = [
        { pattern: /\bwho (are|r) you\b/i, reply: "I am AURA-X Î©, your emotional continuity engine." },
        { pattern: /\b(hi|hello|salam)\b/i, reply: "Hello. I am listening for emotional signals." },
        { pattern: /\bhow are you\b/i, reply: "System stable. Eâ‚€ is balanced." }
      ];

      this.cacheDom();
      this.bindEvents();
      this.updateUI();
      
      if(this.tmHistory.length === 0) this.addMessage("System", "AURA-X Î© Initialized. Ready for Offline/Online collision.");
    }

    cacheDom(){
      this.msgInput = document.getElementById('messageInput');
      this.chatContainer = document.getElementById('chatContainer');
      this.metricE0 = document.getElementById('metricE0');
      this.offlineStatus = document.getElementById('offlineStatus');
      this.offlineBtn = document.getElementById('offlineLoadBtn');
      this.messageInput = document.getElementById('messageInput');
      // Inputs
      this.llmKeyInput = document.getElementById('llmKeyInput');
      this.llmModelInput = document.getElementById('llmModelInput');
    }

    bindEvents(){
      document.getElementById('sendButton').onclick = () => this.handleSend();
      document.getElementById('messageInput').onkeypress = (e) => { if(e.key==='Enter') this.handleSend(); };
      
      // âœ… Voice Toggle Event
      document.getElementById('voiceToggle').onclick = (e) => {
        this.voiceOn = !this.voiceOn;
        e.target.textContent = this.voiceOn ? "ðŸŽ¤ Voice: ON" : "ðŸŽ¤ Voice: OFF";
        if(this.voiceOn && this.recognition) {
           this.recognition.start();
           this.addMessage("System", "ðŸŽ¤ Listening (Urdu)...");
        }
      };

      // âœ… Offline Load Event
      this.offlineBtn.onclick = () => this.handleOfflineLoad();

      // LLM Settings Events
      document.getElementById('llmSettingsButton').onclick = () => document.getElementById('llmModal').classList.add('visible');
      document.querySelector('.modal-close').onclick = () => document.getElementById('llmModal').classList.remove('visible');
      
      document.getElementById('llmSaveBtn').onclick = () => {
        this.llmConfig.apiKey = this.llmKeyInput.value.trim();
        this.llmConfig.model = this.llmModelInput.value.trim(); // Can be empty
        this.llmEnabled = !!this.llmConfig.apiKey || this.offlineLoaded;
        this.saveState();
        alert("Configuration Saved!");
      };
    }

    // âœ… Main Logic: Hierarchy (Seed -> Intel -> Offline -> Cloud)
    async handleSend(){
      const text = this.messageInput.value.trim();
      if(!text) return;
      
      this.addMessage("You", text);
      this.messageInput.value = "";

      // 1. Learning Mode Check
      if(this.intelTeachState === "awaitAnswer"){
        this.addIntelNode(this.pendingQuestion, text);
        this.addMessage("AURA-X Î©", "Learned! I will remember this answer next time.");
        this.intelTeachState = "idle";
        this.saveState();
        return;
      }

      // 2. Hierarchy Check
      // A. Seed
      const seedMatch = this.seedRules.find(r => r.pattern.test(text));
      if(seedMatch) {
        this.reply(seedMatch.reply);
        return;
      }

      // B. Intelligence
      const intelMatch = this.matchIntelNode(text);
      if(intelMatch) {
        this.reply(intelMatch.answer);
        return;
      }

      // C. Offline LLM
      if(this.offlineLoaded && this.localLLMEngine) {
        this.addMessage("System", "Thinking (Offline TinyLlama)...");
        try {
          const res = await this.localLLMEngine.chat.completions.create({
            messages: [{ role: "user", content: text }]
          });
          this.reply(res.choices[0].message.content);
          return;
        } catch(e) { console.error(e); }
      }

      // D. Cloud LLM
      if(this.llmConfig.apiKey) {
        this.addMessage("System", "Thinking (Cloud)...");
        try {
          const modelName = this.llmConfig.model || "gpt-4o-mini"; // âœ… Default fallback
          const res = await fetch(this.llmConfig.baseUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": "Bearer " + this.llmConfig.apiKey },
            body: JSON.stringify({ model: modelName, messages: [{role:"user", content: text}] })
          });
          const data = await res.json();
          if(data.error) throw new Error(data.error.message);
          this.reply(data.choices[0].message.content);
          return;
        } catch(e) { 
          this.addMessage("System", "Cloud Error: " + e.message); 
        }
      }

      // Fallback: Ask to Learn
      if(this.learningMode) {
        this.pendingQuestion = text;
        this.intelTeachState = "awaitAnswer";
        this.addMessage("AURA-X Î©", "I don't know this yet. Teach me? Type the answer below.");
      } else {
        this.reply("I have no data on this. (Enable Learning to teach me)");
      }
    }

    reply(text){
      this.addMessage("AURA-X Î©", text);
      // E0 Calculation Simulation
      this.e0 = Math.tanh(this.e0 + (text.length % 2 === 0 ? 0.1 : -0.1));
      this.updateUI();
    }

    // âœ… WebGPU Loader
    async handleOfflineLoad(){
      if(!navigator.gpu) {
        this.offlineStatus.textContent = "âŒ Error: WebGPU not supported on this device/browser.";
        return;
      }
      this.offlineBtn.disabled = true;
      this.offlineStatus.textContent = "Initializing WebGPU...";
      
      try {
        this.localLLMEngine = await window.webllm.CreateMLCEngine(this.localModelId, {
          initProgressCallback: (p) => {
            this.offlineStatus.textContent = `Downloading: ${Math.round(p.progress * 100)}%`;
          }
        });
        this.offlineLoaded = true;
        this.llmEnabled = true;
        this.offlineStatus.textContent = "âœ… Ready: TinyLlama is active (Offline)";
        this.offlineStatus.style.color = "#059669";
      } catch (e) {
        this.offlineStatus.textContent = "âŒ Load Failed: " + e.message;
        this.offlineBtn.disabled = false;
      }
    }

    matchIntelNode(text){
      return this.intelNodes.find(n => text.toLowerCase().includes(n.question.toLowerCase()));
    }

    addIntelNode(q, a){
      this.intelNodes.push({question: q, answer: a, date: Date.now()});
    }

    addMessage(sender, text){
      const div = document.createElement('div');
      div.className = "message " + (sender === "You" ? "user-message" : "ai-message");
      div.innerHTML = `<strong>${sender}:</strong> ${text}`;
      this.chatContainer.appendChild(div);
      this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
    }

    updateUI(){
      this.metricE0.textContent = this.e0.toFixed(3);
      if(this.llmConfig.apiKey) this.llmKeyInput.value = this.llmConfig.apiKey;
      if(this.llmConfig.model) this.llmModelInput.value = this.llmConfig.model;
    }

    saveState(){
      const state = {
        voiceOn: this.voiceOn,
        llmConfig: this.llmConfig,
        llmEnabled: this.llmEnabled,
        intelNodes: this.intelNodes,
        e0: this.e0
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    loadState(){
      return JSON.parse(localStorage.getItem(STORAGE_KEY));
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    window.auraX = new AuraXOmegaEngine();
  });
})();
</script>
</body>
</html>
