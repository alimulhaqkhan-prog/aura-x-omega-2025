<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Ω – Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* ---------- RESET ---------- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      height: 100%;
    }

    /* ---------- BODY & APP LAYOUT ---------- */
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg, #020617 0, #020617 40%, #020617 100%);
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
    }

    .app {
      width: 100%;
      max-width: 1200px;
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #020617 100%);
      border-radius: 24px;
      box-shadow: 0 28px 80px rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 18px 20px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* ---------- HEADER ---------- */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 14px;
    }
    .title-block {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .orb {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, #e0f2fe 0, #0ea5e9 35%, #1d4ed8 70%, #020617 100%);
      box-shadow:
        0 0 18px rgba(56, 189, 248, 0.75),
        0 0 48px rgba(79, 70, 229, 0.7);
    }
    .title-main {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }
    .title-main h1 {
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: 0.09em;
      text-transform: uppercase;
    }
    .title-main span {
      font-size: 0.82rem;
      color: #9ca3af;
    }

    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .ethics-pill {
      font-size: 0.7rem;
      background: rgba(15, 23, 42, 0.85);
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid rgba(234, 179, 8, 0.65);
      color: #fbbf24;
      max-width: 380px;
      text-align: right;
      box-shadow: 0 0 18px rgba(250, 204, 21, 0.25);
    }

    .status-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.72rem;
    }
    .status-pill {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.85);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #f97316;
      box-shadow: 0 0 10px rgba(249, 115, 22, 0.7);
    }
    .status-dot.ready {
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
    }

    .btn-xs {
      border-radius: 999px;
      border: none;
      padding: 5px 9px;
      font-size: 0.7rem;
      background: #0ea5e9;
      color: #0b1120;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-xs:active {
      transform: scale(0.98);
    }

    #offlineStatusText {
      font-size: 0.7rem;
      color: #9ca3af;
      max-width: 220px;
      text-align: right;
    }

    /* ---------- MAIN GRID ---------- */
    .main-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.6fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-right {
        align-items: flex-start;
      }
    }

    /* ---------- LEFT COLUMN (FORMULA + TM/BM) ---------- */
    .panel {
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9) 0, rgba(15, 23, 42, 0.9) 50%, rgba(15, 23, 42, 0.9) 100%);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }
    .panel-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #9ca3af;
    }
    .chip {
      font-size: 0.7rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    /* Formula area */
    .formula-block {
      background: radial-gradient(circle at top, #020617 0, #020617 45%, #020617 100%);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 10px 12px 8px;
      position: relative;
      overflow: hidden;
    }
    .formula-main {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
      text-align: center;
      color: #e5e7eb;
      margin-bottom: 6px;
    }
    .formula-main span.lambda {
      color: #fde047;
    }
    .formula-sub {
      font-size: 0.7rem;
      color: #9ca3af;
      text-align: center;
    }

    /* Answer reactor box overlapping formula area */
    .reactor-box {
      margin-top: 10px;
      background: linear-gradient(145deg, #020617 0, #020617 50%, #0f172a 100%);
      border-radius: 16px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 8px 10px;
      min-height: 70px;
      max-height: 140px;
      overflow: auto;
      font-size: 0.8rem;
      line-height: 1.4;
      box-shadow: 0 0 30px rgba(8, 47, 73, 0.7);
    }
    .reactor-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #38bdf8;
      margin-bottom: 3px;
    }
    #reactorText {
      color: #e5e7eb;
      white-space: pre-wrap;
    }

    /* TM/BM panels inside left column */
    .tm-bm-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 10px;
    }
    @media (max-width: 600px) {
      .tm-bm-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .tm-panel, .bm-panel {
      background: rgba(15, 23, 42, 0.98);
      border-radius: 14px;
      border: 1px solid rgba(75, 85, 99, 0.8);
      padding: 8px 9px 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.75rem;
    }
    .tm-panel h3, .bm-panel h3 {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .tm-list, .bm-list {
      max-height: 120px;
      overflow: auto;
      padding-right: 4px;
    }
    .tm-item, .bm-item {
      padding: 4px 5px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.8);
      margin-bottom: 4px;
    }
    .tm-meta, .bm-meta {
      font-size: 0.65rem;
      color: #9ca3af;
      margin-bottom: 2px;
    }
    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }
    .tag {
      font-size: 0.6rem;
      padding: 2px 5px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }
    .tag.pos {
      border-color: rgba(34, 197, 94, 0.9);
      color: #bbf7d0;
    }
    .tag.neg {
      border-color: rgba(248, 113, 113, 0.9);
      color: #fecaca;
    }
    .tag.neu {
      border-color: rgba(148, 163, 184, 0.9);
      color: #e5e7eb;
    }

    /* ---------- RIGHT COLUMN (CHAT) ---------- */
    .chat-panel {
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98) 0, rgba(15, 23, 42, 0.98) 50%, rgba(15, 23, 42, 0.98) 100%);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 360px;
      position: relative;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.74rem;
      margin-bottom: 4px;
    }

    .mode-pill {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      gap: 5px;
      align-items: center;
      font-size: 0.7rem;
    }
    .mode-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
    }

    .chat-body {
      flex: 1;
      padding: 6px 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
      scroll-behavior: smooth;
    }

    .msg {
      max-width: 82%;
      padding: 7px 9px;
      border-radius: 12px;
      font-size: 0.78rem;
      line-height: 1.4;
      position: relative;
      border: 1px solid rgba(51, 65, 85, 0.8);
      white-space: pre-wrap;
    }
    .msg.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #22c55e 0, #16a34a 45%, #166534 100%);
      color: #ecfdf5;
      border-color: rgba(22, 163, 74, 0.9);
    }
    .msg.bot {
      align-self: flex-start;
      background: linear-gradient(145deg, #020617 0, #020617 60%, #020617 100%);
      color: #e5e7eb;
    }

    .msg-source {
      position: absolute;
      right: 8px;
      bottom: -13px;
      font-size: 0.6rem;
      opacity: 0.65;
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .msg-meta-top {
      font-size: 0.62rem;
      opacity: 0.8;
      margin-bottom: 2px;
    }

    /* ---------- INPUT AREA ---------- */
    .input-area {
      margin-top: 6px;
      border-radius: 16px;
      background: radial-gradient(circle at top, #020617 0, #020617 70%, #020617 100%);
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 8px 8px 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .input-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #6b7280;
    }
    .input-row {
      display: flex;
      gap: 6px;
      align-items: flex-end;
      margin-top: 2px;
    }
    #userInput {
      flex: 1;
      resize: none;
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 0.78rem;
      background: rgba(15, 23, 42, 0.98);
      color: #e5e7eb;
      outline: none;
    }
    #userInput::placeholder {
      color: #6b7280;
    }
    #sendBtn {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 0.78rem;
      background: #0ea5e9;
      color: #020617;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    #sendBtn:active {
      transform: scale(0.97);
    }

    .input-hint {
      font-size: 0.64rem;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
    }

    /* ---------- SCROLLBAR ---------- */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(75, 85, 99, 0.7);
      border-radius: 999px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.9);
    }

    /* ---------- SMALL HELP TEXT ---------- */
    .tiny {
      font-size: 0.6rem;
      color: #6b7280;
    }

  </style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <header class="header">
    <div class="title-block">
      <div class="orb"></div>
      <div class="title-main">
        <h1>AURA-X Ω · Emotional Reactor</h1>
        <span>TM × BM Resonance · Offline + Optional Online LLM</span>
      </div>
    </div>

    <div class="header-right">
      <div class="ethics-pill">
        Avoid actions that create negative emotions in you or others, and gently move toward actions that grow healthy positivity for everyone.
      </div>
      <div class="status-row">
        <div class="status-pill">
          <div id="offlineDot" class="status-dot"></div>
          <span style="font-size:0.7rem;">Offline LLM (WebLLM)</span>
        </div>
        <button id="loadOfflineBtn" class="btn-xs">
          ⚙ Load Offline LLM (WebLLM)
        </button>
      </div>
      <div id="offlineStatusText">
        Model not loaded yet. First load may take some time; later loads will be faster due to browser cache.
      </div>
    </div>
  </header>

  <!-- MAIN GRID -->
  <div class="main-grid">
    <!-- LEFT COLUMN -->
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">Grand Equation · Ω-TRC</div>
        <div class="chip">
          E₀ = tanh((TM × BM) − D + λ<span style="font-size:0.7rem;">faith</span> + λ<span style="font-size:0.7rem;">sys</span> + λ<span style="font-size:0.7rem;">trc</span>)
        </div>
      </div>

      <div class="formula-block">
        <div class="formula-main">
          E₀ = tanh(( <b>TM</b> × <b>BM</b> ) − D + 
          <span class="lambda">λ<sub>faith</sub></span> +
          <span class="lambda">λ<sub>sys</sub></span> +
          <span class="lambda">λ<sub>TRC</sub></span> )
        </div>
        <div class="formula-sub">
          TM = current conversational context, BM = stable long-term memory, D = noise/decay,
          λ = alignment forces (faith · system · truth-resonance).
        </div>

        <div class="reactor-box" id="reactorBox">
          <div class="reactor-label">Reactor Output (E₀ snapshot)</div>
          <div id="reactorText">
AURA-X Ω is idle. Ask something to generate a new emotional continuity state.
          </div>
        </div>
      </div>

      <div class="tm-bm-grid">
        <!-- TM PANEL -->
        <div class="tm-panel">
          <h3>Temporary Memory – TM</h3>
          <div class="tiny">Last turns + polarity & intensity estimation before LLM.</div>
          <div id="tmList" class="tm-list"></div>
        </div>

        <!-- BM PANEL -->
        <div class="bm-panel">
          <h3>Bold Memory – BM</h3>
          <div class="tiny">Only meaningful, resonant episodes are stored here.</div>
          <div id="bmList" class="bm-list"></div>
        </div>
      </div>
    </section>

    <!-- RIGHT COLUMN (CHAT) -->
    <section class="chat-panel">
      <div class="chat-header">
        <div class="mode-pill">
          <span class="mode-dot"></span>
          <span>AURA-X Ω · Dual Memory Chat</span>
        </div>
        <span class="tiny">
          Seed → TM analysis → (Optional) Offline LLM → Reactor
        </span>
      </div>

      <div id="chatBody" class="chat-body"></div>

      <div class="input-area">
        <div class="input-label">TM = user input + (offline LLM) answer</div>
        <div class="input-row">
          <textarea id="userInput" rows="2"
            placeholder="Type here... (e.g. 'How are you?' or ask about emotional continuity)"></textarea>
          <button id="sendBtn">
            Send
          </button>
        </div>
        <div class="input-hint">
          <span>Enter to send · TM will estimate polarity & intensity first.</span>
          <span>Seed answers beat LLM if a close match exists.</span>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- ---------- LOGIC + WEBLLM INTEGRATION ---------- -->
<script type="module">
  // ---------------- GLOBAL STATE ----------------
  const chatBody = document.getElementById("chatBody");
  const userInput = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");
  const tmList = document.getElementById("tmList");
  const bmList = document.getElementById("bmList");
  const reactorText = document.getElementById("reactorText");
  const offlineDot = document.getElementById("offlineDot");
  const loadOfflineBtn = document.getElementById("loadOfflineBtn");
  const offlineStatusText = document.getElementById("offlineStatusText");

  // TM/BM memory containers
  const tmHistory = [];  // {role, text, emotion, source}
  const bmEpisodes = []; // {text, emotion, time}

  // WebLLM engine
  let webllmEngine = null;
  let webllmModule = null;
  let engineReady = false;
  let engineLoading = false;

  // ---------------- SEED Q&A (Feed the Seed) ----------------
  // You can extend this array with LaTeX Q&A later.
  const seedQA = [
    {
      id: "how_are_you",
      qVariants: [
        "how are you",
        "how are u",
        "how r u",
        "how are you feeling",
        "how is your day",
        "how's your day",
        "whats up",
        "what's up",
        "kya haal",
        "kia haal"
      ],
      answer:
        "I am quite fine today, running a stable emotional continuity state. How about you?"
    },
    {
      id: "who_are_you",
      qVariants: [
        "who are you",
        "what are you",
        "what is your name",
        "introduce yourself",
        "who r u"
      ],
      answer:
        "I am AURA-X Ω, an Artificial Unified Resonance Architecture for emotional continuity and dual-memory alignment, conceptually created by Alim ul Haq from Pakistan."
    },
    {
      id: "creation_time",
      qVariants: [
        "when were you created",
        "when you're created",
        "when you were created",
        "your creation date",
        "since when do you exist"
      ],
      answer:
        "I came into being conceptually in October 2025, and I keep evolving with every resonant interaction."
    }
  ];

  function findSeedAnswer(userText) {
    const text = userText.toLowerCase();
    let best = null;
    let bestScore = 0;

    for (const pair of seedQA) {
      let score = 0;
      for (const q of pair.qVariants) {
        if (text.includes(q)) {
          score += q.length; // simple overlap score
        }
      }
      if (score > bestScore) {
        bestScore = score;
        best = pair;
      }
    }
    return bestScore > 0 ? best : null;
  }

  // ---------------- SIMPLE EMOTION ANALYSIS (TM pre-processing) ----------------
  function analyzeEmotion(text) {
    const t = text.toLowerCase();
    let polarity = "neutral";
    let intensity = 0.35;
    let category = "neutral";

    const positiveRegex = /(shukriya|thank you|thanks|great|awesome|zabardast|happy|love|wonderful|amazing|nice)/i;
    const negativeRegex = /(problem|issue|tension|worry|worried|angry|sad|upset|depressed|frustrated|anxious)/i;
    const curiosityRegex = /(how|why|what|explain|samjha|meaning|kya|kia)/i;

    if (positiveRegex.test(t)) {
      polarity = "positive";
      intensity = 0.7;
      category = "gratitude/hope";
    } else if (negativeRegex.test(t)) {
      polarity = "negative";
      intensity = 0.8;
      category = "concern/stress";
    } else if (curiosityRegex.test(t)) {
      polarity = "neutral";
      intensity = 0.6;
      category = "curiosity/analysis";
    }

    // Adjust intensity by length a bit
    const lengthBoost = Math.min(text.length / 300, 0.25);
    intensity = Math.min(1, intensity + lengthBoost);

    return { polarity, intensity, category };
  }

  function polarityTagClass(polarity) {
    if (polarity === "positive") return "tag pos";
    if (polarity === "negative") return "tag neg";
    return "tag neu";
  }

  // ---------------- TM / BM UI UPDATES ----------------
  function updateTMList() {
    tmList.innerHTML = "";
    const lastItems = tmHistory.slice(-6); // show last 6
    for (const item of lastItems) {
      const div = document.createElement("div");
      div.className = "tm-item";

      const meta = document.createElement("div");
      meta.className = "tm-meta";
      meta.textContent = (item.role === "user" ? "User · " : "Aura-X Ω · ") +
        (item.source ? `source: ${item.source}` : "source: n/a");
      div.appendChild(meta);

      const textEl = document.createElement("div");
      textEl.textContent = item.text;
      div.appendChild(textEl);

      if (item.emotion) {
        const tagsRow = document.createElement("div");
        tagsRow.className = "tag-row";

        const pol = document.createElement("span");
        pol.className = polarityTagClass(item.emotion.polarity);
        pol.textContent = `Polarity: ${item.emotion.polarity}`;
        tagsRow.appendChild(pol);

        const inten = document.createElement("span");
        inten.className = "tag neu";
        inten.textContent = `Intensity: ${(item.emotion.intensity * 100).toFixed(0)}%`;
        tagsRow.appendChild(inten);

        const cat = document.createElement("span");
        cat.className = "tag neu";
        cat.textContent = `Category: ${item.emotion.category}`;
        tagsRow.appendChild(cat);

        div.appendChild(tagsRow);
      }

      tmList.appendChild(div);
    }
    tmList.scrollTop = tmList.scrollHeight;
  }

  function updateBMList() {
    bmList.innerHTML = "";
    const items = bmEpisodes.slice(-6);
    for (const ep of items) {
      const div = document.createElement("div");
      div.className = "bm-item";

      const meta = document.createElement("div");
      meta.className = "bm-meta";
      meta.textContent = ep.time;
      div.appendChild(meta);

      const textEl = document.createElement("div");
      textEl.textContent = ep.text;
      div.appendChild(textEl);

      if (ep.emotion) {
        const row = document.createElement("div");
        row.className = "tag-row";
        const pol = document.createElement("span");
        pol.className = polarityTagClass(ep.emotion.polarity);
        pol.textContent = ep.emotion.polarity;
        row.appendChild(pol);

        const inten = document.createElement("span");
        inten.className = "tag neu";
        inten.textContent = `Int: ${(ep.emotion.intensity * 100).toFixed(0)}%`;
        row.appendChild(inten);

        const cat = document.createElement("span");
        cat.className = "tag neu";
        cat.textContent = ep.emotion.category;
        row.appendChild(cat);

        div.appendChild(row);
      }

      bmList.appendChild(div);
    }
    bmList.scrollTop = bmList.scrollHeight;
  }

  function maybeSaveToBM(userText, emotion) {
    // Very simple BM rule: strong emotional intensity OR long meaningful message
    if (!emotion) return;
    const strongEmotion = emotion.intensity >= 0.75;
    const longEnough = userText.length > 200;

    if (strongEmotion || longEnough) {
      bmEpisodes.push({
        text: userText,
        emotion: { ...emotion },
        time: new Date().toLocaleString()
      });
      updateBMList();
    }
  }

  // ---------------- REACTOR (E₀) UPDATE ----------------
  function updateReactor(userText, botText, emotion) {
    const pol = emotion?.polarity ?? "neutral";
    const intVal = emotion?.intensity ?? 0.3;

    const polWord = pol === "positive"
      ? "slightly positive"
      : pol === "negative"
      ? "slightly negative"
      : "balanced";

    const reactorSummary =
`TM detected this turn as ${polWord} with intensity ≈ ${(intVal * 100).toFixed(0)}%.

• TM input: ${userText || "(none)"}
• Reactor answer: ${botText || "(none)"}

AURA-X Ω tries to keep E₀ stable by aligning Seed memory, TM context, BM episodes and the offline LLM output.`;

    reactorText.textContent = reactorSummary;
  }

  // ---------------- CHAT UI ----------------
  function addMessageToChat(role, text, source = "") {
    const msg = document.createElement("div");
    msg.className = "msg " + (role === "user" ? "user" : "bot");

    const meta = document.createElement("div");
    meta.className = "msg-meta-top";
    meta.textContent = role === "user" ? "User" : "AURA-X Ω";
    msg.appendChild(meta);

    const content = document.createElement("div");
    content.textContent = text;
    msg.appendChild(content);

    if (source && role === "bot") {
      const srcLabel = document.createElement("div");
      srcLabel.className = "msg-source";
      srcLabel.textContent = source;
      msg.appendChild(srcLabel);
    }

    chatBody.appendChild(msg);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  // ---------------- TM SUMMARY FOR LLM CONTEXT ----------------
  function tmSummaryText(limit = 6) {
    const slice = tmHistory.slice(-limit);
    return slice
      .map(item =>
        (item.role === "user" ? "User: " : "Aura: ") +
        item.text
      )
      .join("\n");
  }

  function bmSummaryText(limit = 4) {
    if (bmEpisodes.length === 0) return "No bold memory episodes stored yet.";
    const slice = bmEpisodes.slice(-limit);
    return slice.map(ep => `[${ep.time}] ${ep.text}`).join("\n");
  }

  // ---------------- OFFLINE LLM (WEBLLM) INITIALIZATION ----------------
  async function initWebLLM() {
    if (engineReady || engineLoading) return;
    engineLoading = true;
    offlineStatusText.textContent = "Loading offline model (WebLLM)... this may take a while on first run.";
    offlineDot.classList.remove("ready");

    try {
      // Dynamic import from CDN (as recommended)
      webllmModule = await import("https://esm.run/@mlc-ai/web-llm");

      const selectedModel = "Llama-3.2-1B-Instruct-q4f16_1-MLC"; // lightweight but capable
      offlineStatusText.textContent = "Downloading model weights...";

      webllmEngine = await webllmModule.CreateMLCEngine(selectedModel, {
        initProgressCallback: (p) => {
          const pct = (p.progress * 100).toFixed(0);
          offlineStatusText.textContent =
            `Model loading: ${pct}% – ${p.text || ""}`;
        },
        logLevel: "INFO"
      });

      engineReady = true;
      offlineDot.classList.add("ready");
      offlineStatusText.textContent =
        "Offline LLM ready ✔. All replies now pass through Seed → TM → WebLLM → Reactor (when no Seed hit).";
    } catch (err) {
      console.error("WebLLM init error:", err);
      offlineStatusText.textContent =
        "Error loading offline model: " + (err?.message || String(err));
      engineReady = false;
      webllmEngine = null;
      offlineDot.classList.remove("ready");
    } finally {
      engineLoading = false;
    }
  }

  async function askOfflineLLM(prompt) {
    if (!engineReady || !webllmEngine) return null;

    const systemPrompt =
"You are AURA-X Ω, an emotionally aware assistant built on dual memory (TM/BM) and truth-resonance (TRC). " +
"Answer concisely but clearly. Respect universal ethics: avoid negative emotional harm and gently point toward healthier actions. " +
"Never claim to be the user; always speak as AURA-X Ω.";

    const messages = [
      { role: "system", content: systemPrompt },
      {
        role: "user",
        content:
          "User message:\n" + prompt +
          "\n\nRecent TM summary:\n" + tmSummaryText() +
          "\n\nImportant BM episodes:\n" + bmSummaryText()
      }
    ];

    // Non-streaming for simplicity
    const reply = await webllmEngine.chat.completions.create({
      messages,
      temperature: 0.7
    });

    const message = reply?.choices?.[0]?.message?.content || "";
    return message.trim();
  }

  // ---------------- FALLBACK ANSWER (when no LLM) ----------------
  function fallbackAnswer(userText) {
    if (!userText) return "I did not receive any text. Could you type again?";
    if (userText.length < 16) {
      return "I see your short input. Can you tell me a bit more so I can process the emotional continuity better?";
    }
    return "I have registered your message into TM and estimated its polarity and intensity. " +
      "Right now the offline LLM is not ready, but AURA-X Ω still keeps the continuity and BM structure in place.";
  }

  // ---------------- MAIN HANDLER ----------------
  async function handleUserSubmit() {
    const text = userInput.value.trim();
    if (!text) return;

    userInput.value = "";
    addMessageToChat("user", text);

    // TM analysis BEFORE LLM
    const emotion = analyzeEmotion(text);

    // Store user turn in TM
    tmHistory.push({
      role: "user",
      text,
      emotion,
      source: "user"
    });
    updateTMList();

    // Possibly update BM
    maybeSaveToBM(text, emotion);

    // 1) Try Seed
    let finalAnswer = "";
    let source = "";

    const seed = findSeedAnswer(text);
    if (seed) {
      finalAnswer = seed.answer;
      source = "Seed / Feed-the-Seed";
    } else if (engineReady) {
      // 2) Use Offline LLM (WebLLM)
      try {
        finalAnswer = await askOfflineLLM(text);
        source = "Offline LLM (WebLLM)";
      } catch (err) {
        console.error("Offline LLM error:", err);
        finalAnswer = fallbackAnswer(text);
        source = "Fallback (LLM error)";
      }
    } else {
      // 3) Fallback only
      finalAnswer = fallbackAnswer(text);
      source = "Fallback (no LLM)";
    }

    // Store bot turn in TM
    tmHistory.push({
      role: "bot",
      text: finalAnswer,
      emotion: null,
      source
    });
    updateTMList();

    // Update reactor E₀
    updateReactor(text, finalAnswer, emotion);

    // Show in chat
    addMessageToChat("bot", finalAnswer, source);
  }

  // ---------------- EVENT LISTENERS ----------------
  sendBtn.addEventListener("click", handleUserSubmit);

  userInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleUserSubmit();
    }
  });

  loadOfflineBtn.addEventListener("click", () => {
    initWebLLM();
  });

  // ---------------- INITIAL GREETING ----------------
  (function initGreeting() {
    const text =
"Assalamualaikum, I am AURA-X Ω.\n\n" +
"This prototype uses:\n" +
"• Seed Q&A for very common questions (like 'How are you?').\n" +
"• TM layer to estimate polarity & intensity BEFORE sending anything to the LLM.\n" +
"• Optional offline WebLLM model as the main intelligence layer.\n" +
"• BM episodes for longer or emotionally strong messages.\n\n" +
"Click “Load Offline LLM (WebLLM)” if you want the real local model to answer instead of the simple fallback.";
    addMessageToChat("bot", text, "System");
  })();
</script>
</body>
</html>