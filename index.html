
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AURA-X Œ© ‚Äî Emotional Continuity Prototype</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow-x:hidden;}
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  display:flex;justify-content:center;align-items:flex-start;
  background:#f5f5f7;color:#111827;margin:0;
  transition:background .6s ease,box-shadow .6s ease;
}

/* THEME VARS */
:root{
  --theme-bg:#f5f5f7;
  --theme-border:#e5e7eb;
  --theme-accent:#16a34a;
  --theme-shadow:rgba(22,163,74,.35);
}
body.theme-positive{
  --theme-bg:#f0fdf4;--theme-border:#bbf7d0;
  --theme-accent:#22c55e;--theme-shadow:rgba(34,197,94,.45);
}
body.theme-negative{
  --theme-bg:#fef2f2;--theme-border:#fecaca;
  --theme-accent:#ef4444;--theme-shadow:rgba(239,68,68,.45);
}
body.theme-neutral{
  --theme-bg:#f5f5f7;--theme-border:#fef3c7;
  --theme-accent:#f59e0b;--theme-shadow:rgba(245,158,11,.35);
}
body{background:var(--theme-bg);}

.app{
  width:100%;max-width:640px;min-height:100vh;
  padding:16px 16px 22px;display:flex;flex-direction:column;gap:12px;
  background:rgba(255,255,255,0.96);backdrop-filter:blur(10px);
  box-shadow:0 20px 60px rgba(0,0,0,.25);
  position:relative;overflow:hidden;
}

/* ANIMATIONS */
@keyframes slideIn{from{transform:translateY(24px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes slideOut{from{transform:translateY(0);opacity:1}to{transform:translateY(-24px);opacity:0}}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}
@keyframes glow{0%{box-shadow:0 0 4px var(--theme-accent)}50%{box-shadow:0 0 16px var(--theme-accent)}100%{box-shadow:0 0 4px var(--theme-accent)}}
@keyframes breath{0%{transform:scale(.97)}50%{transform:scale(1.03)}100%{transform:scale(.97)}}
@keyframes rippleKF{0%{transform:scale(.8);opacity:1}100%{transform:scale(2);opacity:0}}
@keyframes typingDot{0%{transform:translateY(0);opacity:.3}50%{transform:translateY(-3px);opacity:1}100%{transform:translateY(0);opacity:.3}}

/* HEADER */
.header-top{
  display:flex;justify-content:center;align-items:center;margin-top:2px;
  animation:slideIn .5s ease-out;
}
.title-block h1{
  font-size:1.9rem;letter-spacing:.06em;text-align:center;
  background:linear-gradient(90deg,var(--theme-accent),#3b82f6);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;animation:glow 3s infinite;
}
.title-block p{
  font-size:.72rem;text-transform:uppercase;letter-spacing:.16em;
  color:#6b7280;text-align:center;margin-top:5px;
}

/* MODE PILL */
.mode-pill{
  margin-top:10px;border-radius:999px;padding:10px 16px;
  font-size:.8rem;text-align:center;
  background:linear-gradient(135deg,#e5f0ff,#dbeafe);
  color:#0f172a;border:2px solid var(--theme-accent);
  box-shadow:0 8px 24px rgba(37,99,235,.25);
  animation:slideIn .6s ease-out;
}
.mode-pill span{display:block}
.mode-label{font-weight:700;margin-bottom:2px;}
.mode-sub{font-size:.7rem;opacity:.85;}
.engine{font-size:.65rem;opacity:.7;margin-top:2px;}

/* TOP BUTTONS */
.top-buttons{
  display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;
  animation:slideIn .6s ease-out .05s both;
}
.pill-btn{
  flex:1 1 calc(50% - 5px);border-radius:999px;padding:11px 12px;
  border:2px solid var(--theme-border);background:#f9fafb;
  display:flex;align-items:center;justify-content:center;gap:8px;
  font-size:.85rem;cursor:pointer;font-weight:500;
  transition:all .25s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden;
}
.pill-btn span.icon{font-size:1.1rem}
.pill-btn:hover{
  transform:translateY(-3px);box-shadow:0 10px 20px rgba(15,23,42,.15);
  background:linear-gradient(135deg,#ffffff,#f0f9ff);
  border-color:var(--theme-accent);
}
.pill-btn:active{transform:translateY(-1px);}
.ripple-effect{
  position:absolute;border-radius:50%;background:rgba(255,255,255,.6);
  transform:scale(0);animation:rippleKF .6s linear;
}

/* WAVE */
.wave-container{
  width:100%;height:120px;margin:8px 0 6px;border-radius:16px;
  background:linear-gradient(180deg,rgba(255,255,255,.93),rgba(255,255,255,.8));
  border:2px solid var(--theme-border);position:relative;overflow:hidden;
  animation:slideIn .6s ease-out .1s both;
}
#emotionWave{width:100%;height:100%;display:block;}
.wave-stats{
  position:absolute;top:8px;left:8px;display:flex;gap:8px;
  font-size:.7rem;background:rgba(255,255,255,.9);
  padding:5px 9px;border-radius:20px;z-index:2;
}
.wave-stats span{display:flex;align-items:center;gap:3px;}
.stat-value{
  font-family:"SF Mono",monospace;font-weight:bold;
  padding:2px 6px;border-radius:4px;background:rgba(0,0,0,.03);
}

/* CARDS */
.card,.chat-area,.timeline-view{
  border-radius:20px;border:2px solid var(--theme-border);
  background:#fff;box-shadow:0 10px 28px rgba(15,23,42,.08);
  animation:slideIn .7s ease-out .15s both;
}
.card{padding:14px 16px;font-size:.85rem;line-height:1.5;}
.card.golden{
  background:linear-gradient(135deg,#fefce8,#fef3c7);
  border-color:#facc15;color:#92400e;font-weight:500;
  animation:pulse 2.3s infinite;
}

/* REACTION BANNER */
.reaction-banner{
  border-radius:20px;padding:12px 16px;margin-top:4px;
  font-size:.8rem;line-height:1.4;border:2px solid var(--theme-border);
  background:#fff;position:relative;overflow:hidden;
}
.reaction-banner strong{display:block;margin-bottom:4px;font-size:.9rem;color:var(--theme-accent);}
.intensity-pos-1{background:#ecfdf5;border-color:#bbf7d0;color:#166534;}
.intensity-pos-2{background:#d1fae5;border-color:#6ee7b7;color:#166534;}
.intensity-pos-3{background:#a7f3d0;border-color:#34d399;color:#065f46;animation:breath 3s infinite;}
.intensity-pos-4{background:#6ee7b7;border-color:#10b981;color:#065f46;animation:pulse 2s infinite,breath 4s infinite;}
.intensity-pos-5{background:#34d399;border-color:#059669;color:#064e3b;animation:pulse 2s infinite;}
.intensity-neg-1{background:#fee2e2;border-color:#fecaca;color:#991b1b;}
.intensity-neg-2{background:#fecaca;border-color:#fca5a5;color:#7f1d1d;}
.intensity-neg-3{background:#fca5a5;border-color:#f87171;color:#7f1d1d;animation:breath 3s infinite;}
.intensity-neg-4{background:#f87171;border-color:#ef4444;color:#7f1d1d;animation:pulse 2s infinite,breath 4s infinite;}
.intensity-neg-5{background:#ef4444;border-color:#dc2626;color:#7f1d1d;animation:pulse 2s infinite;}
.intensity-neu-1{background:#fffbea;border-color:#fde68a;color:#854d0e;}
.intensity-neu-2{background:#fef9c3;border-color:#facc15;color:#854d0e;}
.intensity-neu-3{background:#fde68a;border-color:#f59e0b;color:#78350f;animation:breath 3s infinite;}
.intensity-neu-4{background:#fbbf24;border-color:#d97706;color:#78350f;animation:pulse 2s infinite,breath 4s infinite;}
.intensity-neu-5{background:#f59e0b;border-color:#b45309;color:#7c2d12;animation:pulse 2s infinite;}

/* CHAT AREA */
.chat-area{
  padding:14px 16px;margin-top:6px;display:flex;flex-direction:column;
  gap:10px;min-height:210px;
}
.chat-log{
  flex:1;overflow-y:auto;padding-right:6px;font-size:.85rem;
  white-space:pre-wrap;display:flex;flex-direction:column;gap:10px;
}
.chat-log::-webkit-scrollbar{width:4px}
.chat-log::-webkit-scrollbar-thumb{background:var(--theme-accent);border-radius:10px;}
.msg{
  padding:10px 14px;border-radius:18px;max-width:85%;
  animation:slideIn .45s cubic-bezier(.4,0,.2,1);position:relative;
}
.msg-user{
  background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;
  align-self:flex-end;border-bottom-right-radius:4px;
  box-shadow:0 4px 12px rgba(59,130,246,.3);
}
.msg-bot{
  background:linear-gradient(135deg,#f3f4f6,#e5e7eb);color:#111827;
  align-self:flex-start;border-bottom-left-radius:4px;
  box-shadow:0 4px 12px rgba(0,0,0,.1);
}
.typing-indicator{display:inline-flex;align-items:center;gap:3px;}
.typing-dot{
  width:6px;height:6px;border-radius:50%;background:var(--theme-accent);
  animation:typingDot 1.2s infinite;
}
.typing-dot:nth-child(2){animation-delay:.15s;}
.typing-dot:nth-child(3){animation-delay:.3s;}
.msg.slide-out{animation:slideOut .35s cubic-bezier(.4,0,.2,1) forwards;}

.tm-pill{
  align-self:flex-start;border-radius:999px;padding:6px 14px;
  background:linear-gradient(135deg,#f3f4ff,#e0e7ff);border:0;
  font-size:.8rem;font-family:"SF Mono",Menlo,Consolas,monospace;
  color:#111827;box-shadow:0 4px 12px rgba(99,102,241,.2);
}

/* INPUT */
.input-row{
  display:flex;align-items:center;gap:8px;margin-top:4px;
}
.input-row textarea{
  flex:1;resize:none;min-height:56px;max-height:120px;
  border-radius:28px;border:2px solid #d1d5db;background:#fff;
  color:#111827;padding:12px 16px;font-size:.86rem;
  transition:all .25s cubic-bezier(.4,0,.2,1);font-family:inherit;
}
.input-row textarea:focus{
  outline:none;border-color:var(--theme-accent);
  box-shadow:0 0 0 3px var(--theme-shadow),0 8px 20px rgba(0,0,0,.08);
  transform:translateY(-1px);
}
.input-row textarea::placeholder{color:#9ca3af;font-style:italic;}
.send-btn{
  flex:0 0 46px;height:46px;border-radius:999px;border:none;
  background:linear-gradient(135deg,var(--theme-accent),#3b82f6);
  color:#fff;font-weight:700;cursor:pointer;font-size:1.1rem;
  box-shadow:0 8px 24px var(--theme-shadow);
  display:flex;align-items:center;justify-content:center;
  transition:all .25s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden;
}
.send-btn:hover{transform:translateY(-2px);box-shadow:0 12px 28px var(--theme-shadow);}
.send-btn:active{transform:translateY(0);}
.send-btn::before{
  content:'';position:absolute;top:50%;left:50%;width:0;height:0;
  border-radius:50%;background:rgba(255,255,255,.5);
  transform:translate(-50%,-50%);
}
.send-btn:active::before{width:140px;height:140px;transition:width .25s,height .25s;}

/* AUTO RECALL / FAITH BUBBLE */
.auto-recall-hint{
  display:none;margin-top:4px;padding:6px 10px;border-radius:999px;
  background:#ecfeff;border:1px solid #7dd3fc;
  font-size:.75rem;align-items:center;justify-content:space-between;gap:6px;
}
.auto-recall-hint button{
  border-radius:999px;border:none;padding:4px 10px;font-size:.75rem;
  background:#0ea5e9;color:#fff;cursor:pointer;
}

/* FOOTER */
.footer-line{
  font-size:.74rem;opacity:.85;margin-top:8px;
  display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;
  align-items:center;color:#6b7280;
}
.voice-toggle{
  border-radius:999px;padding:6px 12px;border:2px solid #16a34a;
  background:linear-gradient(135deg,#ecfdf5,#d1fae5);
  color:#166534;font-size:.78rem;cursor:pointer;
  display:flex;align-items:center;gap:4px;
}
.voice-toggle.inactive{
  border-color:#9ca3af;background:linear-gradient(135deg,#f9fafb,#f3f4f6);
  color:#4b5563;
}

/* TIMELINE */
.timeline-view{
  width:100%;margin-top:10px;padding:12px 14px;display:none;font-size:.8rem;
}
.timeline-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.timeline-track{
  position:relative;height:80px;overflow-x:auto;overflow-y:hidden;
  white-space:nowrap;padding:10px 0;
}
.timeline-track::before{
  content:'';position:absolute;left:0;top:50%;width:100%;height:3px;
  background:var(--theme-border);transform:translateY(-50%);
}
.timeline-node{
  display:inline-block;width:60px;height:60px;margin:0 15px;position:relative;
  cursor:pointer;transition:transform .25s ease;vertical-align:middle;
}
.timeline-node:hover{transform:scale(1.15);}
.node-dot{
  width:18px;height:18px;border-radius:50%;position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);z-index:2;
}
.node-dot.positive{background:#22c55e;box-shadow:0 0 10px #22c55e;}
.node-dot.negative{background:#ef4444;box-shadow:0 0 10px #ef4444;}
.node-dot.neutral{background:#f59e0b;box-shadow:0 0 10px #f59e0b;}
.node-ring{
  position:absolute;top:50%;left:50%;width:36px;height:36px;
  border:2px solid;border-radius:50%;transform:translate(-50%,-50%);
  animation:rippleKF 2s infinite;
}
.node-ring.positive{border-color:#22c55e;}
.node-ring.negative{border-color:#ef4444;}
.node-ring.neutral{border-color:#f59e0b;}
.node-info{
  position:absolute;top:-26px;left:50%;transform:translateX(-50%);
  font-size:.68rem;white-space:nowrap;background:rgba(255,255,255,.9);
  padding:2px 6px;border-radius:10px;display:none;
}
.timeline-node:hover .node-info{display:block;}

/* MODALS */
.modal-backdrop{
  position:fixed;inset:0;background:rgba(15,23,42,.55);
  display:none;align-items:center;justify-content:center;
  z-index:100;backdrop-filter:blur(5px);
}
.modal{
  width:100%;max-width:560px;max-height:85vh;background:#fff;
  border-radius:24px;border:2px solid var(--theme-border);
  padding:16px 18px;display:flex;flex-direction:column;gap:10px;
  box-shadow:0 24px 48px rgba(15,23,42,.32);animation:slideIn .35s ease-out;
}
.modal-header{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;
}
.modal-title{font-size:.96rem;font-weight:700;display:flex;align-items:center;gap:6px;}
.modal-close{
  border-radius:999px;border:none;padding:7px 14px;
  font-size:.8rem;cursor:pointer;background:#111827;color:#f9fafb;
}
.modal-body{
  flex:1;overflow-y:auto;font-size:.8rem;padding-right:4px;
}
.modal-body::-webkit-scrollbar{width:4px}
.modal-body::-webkit-scrollbar-thumb{background:var(--theme-accent);border-radius:10px;}

/* BM VIEWER SPECIAL */
#bmModalBody{display:flex;flex-direction:column;gap:8px;}
.bm-day-title{font-weight:600;margin:6px 0 2px;font-size:.8rem;}
.bm-node{
  padding:8px 9px;border-radius:14px;border:1px solid #e5e7eb;
  background:#f9fafb;cursor:pointer;font-size:.78rem;margin-bottom:4px;
}
.bm-node:hover{background:#eef2ff;}
#bmLayersCanvas{
  width:100%;height:190px;border-radius:16px;border:1px solid #e5e7eb;
  margin-top:6px;background:#020617;
}

/* OPTIONS / TOGGLES */
.option-section-title{font-weight:700;font-size:.85rem;margin:10px 0 4px;}
.faith-note{font-size:.76rem;color:#6b7280;margin-bottom:6px;}
.faith-row{display:flex;flex-wrap:wrap;gap:6px;}
.faith-pill{
  border-radius:999px;border:1px solid #d1d5db;padding:5px 9px;
  font-size:.76rem;background:#f9fafb;cursor:pointer;
}
.faith-pill.active{background:#111827;color:#f9fafb;border-color:#111827;}
.option-row{
  display:flex;justify-content:space-between;align-items:center;
  font-size:.8rem;margin-top:4px;gap:8px;
}
.toggle{position:relative;width:40px;height:20px;display:inline-block;}
.toggle input{display:none;}
.toggle .slider{
  position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;
  background:#e5e7eb;border-radius:999px;transition:.2s;
}
.toggle .slider:before{
  position:absolute;content:"";height:14px;width:14px;
  left:3px;bottom:3px;background:white;border-radius:50%;transition:.2s;
}
.toggle input:checked + .slider{background:#22c55e;}
.toggle input:checked + .slider:before{transform:translateX(18px);}
.options-footer-note{font-size:.72rem;color:#6b7280;margin-top:8px;line-height:1.4;}
.danger-btn{
  border:none;border-radius:999px;padding:6px 10px;font-size:.76rem;
  cursor:pointer;background:#dc2626;color:#fff;
}

/* SCROLL HIDES */
.chat-log::-webkit-scrollbar,
textarea::-webkit-scrollbar,
.modal-body::-webkit-scrollbar{width:0;height:0}

/* RESPONSIVE */
@media (max-width:640px){
  .app{padding:12px;border-radius:0}
  .title-block h1{font-size:1.6rem;}
  .pill-btn{flex:1 1 calc(50% - 5px);}
}
@media (max-width:480px){
  .pill-btn{flex:1 1 100%;}
  .msg{max-width:94%;}
}
</style>
</head>
<body class="theme-neutral">
<div class="app">

<!-- HEADER -->
<div class="header-top">
  <div class="title-block">
    <h1>AURA-X Œ©</h1>
    <p>EMOTIONAL CONTINUITY ¬∑ AEC ¬∑ CRM ¬∑ AECN ¬∑ RL¬≥ ¬∑ LR¬≥</p>
  </div>
</div>

<div class="mode-pill" id="modePill">
  <span class="mode-label">MODE: SEED-ONLY</span>
  <span class="mode-sub">Universal Ethics ¬∑ Local BM</span>
  <span class="engine">Engine: Seed (local)</span>
</div>

<!-- TOP BUTTONS -->
<div class="top-buttons">
  <button class="pill-btn" id="bmViewerBtn"><span class="icon">üß†</span><span>BM Viewer</span></button>
  <button class="pill-btn" id="recallBtn"><span class="icon">üìÇ</span><span>Recall BM</span></button>
  <button class="pill-btn" id="timelineBtn"><span class="icon">üìà</span><span>Timeline</span></button>
  <button class="pill-btn" id="cleanupBtn"><span class="icon">‚ôªÔ∏è</span><span>Recycle 48h</span></button>
  <button class="pill-btn" id="optionsBtn"><span class="icon">‚öôÔ∏è</span><span>Options</span></button>
</div>

<!-- WAVE -->
<div class="wave-container">
  <canvas id="emotionWave"></canvas>
  <div class="wave-stats">
    <span>TM: <span id="tmValue" class="stat-value">0.35</span></span>
    <span>BM: <span id="bmValue" class="stat-value">0.55</span></span>
    <span>E‚ÇÄ: <span id="e0Value" class="stat-value">0.00</span></span>
    <span>D: <span id="dValue" class="stat-value">0.00</span></span>
    <span>C‚Çú: <span id="cValue" class="stat-value">0.05</span></span>
  </div>
</div>

<div class="card golden">
  Avoid actions that generate negative emotions in yourself or others.
  Move gently toward kindness, clarity, and positive internal stability.
</div>

<!-- TIMELINE -->
<div class="timeline-view" id="timelineView">
  <div class="timeline-header">
    <h3 style="font-size:.9rem;">Emotional Continuity Timeline</h3>
    <button class="modal-close" id="closeTimeline">√ó</button>
  </div>
  <div class="timeline-track" id="timelineTrack"></div>
</div>

<!-- REACTION + CHAT -->
<div class="chat-area">
  <div id="reactionBanner" class="reaction-banner intensity-neu-2">
    <strong>AURA-X Œ© REACTION</strong>
    Polarity: Neutral ¬∑ 50 : 50<br>
    Tone: Calm, analytically neutral reading.
  </div>

  <div class="chat-log" id="chatLog"></div>

  <div class="tm-pill">TM = Œ£(User Inputs) + (Seed)</div>

  <div class="input-row">
    <textarea id="userInput"
      placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."
      rows="2"></textarea>
    <button class="send-btn" id="sendBtn">‚ñ∂</button>
  </div>

  <div id="autoRecallHint" class="auto-recall-hint">
    <span id="autoRecallText">üí° Related memory found.</span>
    <button id="autoRecallOpenBtn">Open</button>
  </div>

  <div class="footer-line">
    <span>Prototype ¬∑ TM ‚Üí Analysis ‚Üí Equation ‚Üí BM save / ‚ôªÔ∏è ‚Üí Reaction.</span>
    <button id="voiceToggle" class="voice-toggle">üîä Voice: On</button>
  </div>
</div>
</div>

<!-- BM VIEWER MODAL -->
<div class="modal-backdrop" id="bmModalBackdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title"><span>üß†</span> Bold Memory (BM)</div>
      <button class="modal-close" data-close="bmModalBackdrop">Close</button>
    </div>
    <div class="modal-body" id="bmModalBody">
      <div id="bmList"></div>
      <canvas id="bmLayersCanvas"></canvas>
    </div>
  </div>
</div>

<!-- RECALL BM MODAL -->
<div class="modal-backdrop" id="recallModalBackdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title"><span>üìÇ</span> Recall from BM</div>
      <button class="modal-close" data-close="recallModalBackdrop">Close</button>
    </div>
    <div class="modal-body">
      <input id="recallSearchInput" style="width:100%;padding:7px 9px;border-radius:10px;border:1px solid #d1d5db;font-size:.8rem;margin-bottom:6px;"
        placeholder='Search BM by keyword (e.g., "snow", "mother", "court", "hope")' />
      <div id="recallList"></div>
    </div>
  </div>
</div>

<!-- AUTO-RECALL VIEW -->
<div class="modal-backdrop" id="recallViewModalBackdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title"><span>üí°</span> Auto-Recall Memory</div>
      <button class="modal-close" data-close="recallViewModalBackdrop">Close</button>
    </div>
    <div class="modal-body" id="recallViewBody"></div>
  </div>
</div>

<!-- RECYCLE MODAL -->
<div class="modal-backdrop" id="recycleModalBackdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title"><span>‚ôªÔ∏è</span> Continuity buffer ‚Äì last 48 hours</div>
      <button class="modal-close" data-close="recycleModalBackdrop">Close</button>
    </div>
    <div class="modal-body">
      <div id="recycleModalBody"></div>
      <div class="option-row" style="margin-top:8px;">
        <button id="deleteDayBufferBtn" class="danger-btn">Delete this day</button>
        <button id="clearFullBufferBtn" class="danger-btn" style="background:#111827;">Clear full 48h buffer</button>
      </div>
    </div>
  </div>
</div>

<!-- OPTIONS MODAL -->
<div class="modal-backdrop" id="optionsModalBackdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title"><span>‚öôÔ∏è</span> AURA-X Œ© options</div>
      <button class="modal-close" data-close="optionsModalBackdrop">Close</button>
    </div>
    <div class="modal-body">
      <div class="option-section-title">FAITH LENS (OPTIONAL)</div>
      <div class="faith-note">
        Universal ethics are always active. You can optionally pick one or more faith lenses to shape encouragement lines locally. Nothing is sent to any external server.
      </div>
      <div class="faith-row" id="faithRow">
        <button class="faith-pill" data-faith="None">None</button>
        <button class="faith-pill" data-faith="Islam">Islam</button>
        <button class="faith-pill" data-faith="Christianity">Christianity</button>
        <button class="faith-pill" data-faith="Hinduism">Hinduism</button>
        <button class="faith-pill" data-faith="Buddhism">Buddhism</button>
        <button class="faith-pill" data-faith="Sikhism">Sikhism</button>
        <button class="faith-pill" data-faith="Judaism">Judaism</button>
        <button class="faith-pill" data-faith="Atheism / Humanism">Atheism / Humanism</button>
        <button class="faith-pill" data-faith="Other / Mixed">Other / Mixed</button>
      </div>

      <div class="option-section-title">ENGINE MODE</div>
      <div class="faith-note">Seed-only (offline) or Live emotional reactor (future backend LLM).</div>
      <div class="option-row">
        <span>Current: <span id="engineModeLabel">Seed-only. Everything runs locally.</span></span>
        <label class="toggle"><input type="checkbox" id="engineModeToggle"/><span class="slider"></span></label>
      </div>

      <div class="option-section-title">ANIMATION SETTINGS</div>
      <div class="option-row">
        <span>Enable all animations</span>
        <label class="toggle"><input type="checkbox" id="animationsToggle" checked /><span class="slider"></span></label>
      </div>
      <div class="option-row">
        <span>Show emotion wave visualization</span>
        <label class="toggle"><input type="checkbox" id="waveToggle" checked /><span class="slider"></span></label>
      </div>
      <div class="option-row">
        <span>Show timeline view</span>
        <label class="toggle"><input type="checkbox" id="timelineToggle"/><span class="slider"></span></label>
      </div>

      <div class="option-section-title">PROTOTYPE CONTROLS</div>
      <div class="option-row">
        <span>Ignore tiny small-talk as BM (hello / hi / how are you)</span>
        <label class="toggle"><input type="checkbox" id="ignoreSmallTalkToggle" checked /><span class="slider"></span></label>
      </div>
      <div class="option-row">
        <span>Auto-summarize long conversations (seed)</span>
        <label class="toggle"><input type="checkbox" id="autoSummarizeToggle" checked /><span class="slider"></span></label>
      </div>

      <div class="options-footer-note">
        About AURA-X Œ©: Designed around the idea that emotions are continuity functions between memories (TM and BM), not isolated sparks. This page is a local seed-only prototype with hooks for a future live emotional reactor backend.
      </div>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG / STORAGE KEYS ===== */
const BACKEND_URL = "https://example-backend-aura-x-omega"; // placeholder
const lsKey = "auraX_bm_v1";
const faithKey = "auraX_faithLens";
const engineKey = "auraX_engineMode";
const smallBufferKey = "auraX_smallTalkBuffer_v1";
const animationsKey = "auraX_animations";
const waveKey = "auraX_wave";
const timelineKey = "auraX_timeline";
const ignoreSmallTalkKey = "auraX_ignoreSmallTalk";

/* ===== STATE ===== */
let TM = 0.35, BMvalue = 0.55, D = 0.0, Csum = 0.05;
let lambdaFaith = 0.0, lambdaTrc = 0.0;
const lambdaSys = 0.02;
let E0 = 0.0;

let animationsEnabled = true;
let waveEnabled = true;
let timelineEnabled = false;
let ignoreSmallTalk = true;
let engineLive = false;
let autoVoice = true;

/* Faith lenses (multi) */
let selectedFaiths = [];
try { selectedFaiths = JSON.parse(localStorage.getItem(faithKey) || "[]"); }
catch(e){ selectedFaiths = []; }

/* Auto recall + faith bubble */
let autoRecallHintEl, autoRecallTextEl, autoRecallOpenBtn;
let autoRecallKind = null; // "memory" | "faith"
let autoRecallPayload = null;

/* Wave canvas */
const waveCanvas = document.getElementById("emotionWave");
let waveContext, waveWidth, waveHeight;
let wavePoints = [];
const WAVE_POINTS = 90;

/* BM viewer graph */
let bmCtx, bmAnimId = null, bmSelectedNode = null;

/* DOM refs */
const chatLogEl = document.getElementById("chatLog");
const userInputEl = document.getElementById("userInput");
const reactionBannerEl = document.getElementById("reactionBanner");
const voiceToggleEl = document.getElementById("voiceToggle");
const timelineView = document.getElementById("timelineView");
const timelineTrack = document.getElementById("timelineTrack");
const tmValueEl = document.getElementById("tmValue");
const bmValueEl = document.getElementById("bmValue");
const e0ValueEl = document.getElementById("e0Value");
const dValueEl = document.getElementById("dValue");
const cValueEl = document.getElementById("cValue");

/* Faith suggestion counters */
let faithSuggestionCounter = 0;
let nextFaithSuggestionAfter = randomInt(10,20);

/* ===== SMALL HELPERS ===== */
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}
function tanh(x){const e2x=Math.exp(2*x);return (e2x-1)/(e2x+1);}
function randomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function escapeHtml(str){return (str||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));}
function countSentences(text){return (text.match(/[.!?]+/g)||[]).length || (text.trim()?1:0);}

/* ===== BUFFER (‚ôªÔ∏è) WITH 48h PRUNE ===== */
function pruneBuffer48h(list){
  const now = Date.now(), cutoff = 48*3600*1000;
  return (list||[]).filter(m=>{
    if(!m.ts) return false;
    const t = new Date(m.ts).getTime();
    return (now - t) <= cutoff;
  });
}
function loadBuffer(){
  try{
    const raw = localStorage.getItem(smallBufferKey);
    const orig = raw ? JSON.parse(raw) : [];
    const pruned = pruneBuffer48h(orig);
    if(raw && orig.length!==pruned.length){
      localStorage.setItem(smallBufferKey,JSON.stringify(pruned));
    }
    return pruned;
  }catch(e){return [];}
}
function saveBuffer(list){
  const pruned = pruneBuffer48h(list||[]);
  localStorage.setItem(smallBufferKey,JSON.stringify(pruned));
}

/* ===== BM STORAGE ===== */
function loadBM(){
  try{
    const raw = localStorage.getItem(lsKey);
    return raw ? JSON.parse(raw) : {};
  }catch(e){return {};}
}
function saveBM(data){ localStorage.setItem(lsKey,JSON.stringify(data)); }

/* ===== EMOTION / TEXT ANALYSIS ===== */
const abuseWords = ["fuck","fucking","fucked","lanat","laanat","haramzada","bastard","bitch","bloody","kutte","kutta","kutiya","chutiya","stupid","idiot","gadha","gandi zuban","shut up","chup","bakwas","bakwass","zalil","zaleel","cursed"];
const duaWords = ["dua","prayer","pray for me","make dua","dua karo","dua karna","istighfar","astaghfirullah"];
const shukrWords = ["shukr","shukar","thanks","thank you","alhamdulillah","grateful","gratitude"];
const tawakkulWords = ["tawakkul","tawakkal","trust in allah","allah par bharosa","allah pe bharosa"];
const loveSeedWords = ["i love you","love you","pyaar","pyar","mohabbat","i care about you","miss you","hug","embrace"];
const empathyWords = ["feel sorry for you","sorry for you","may allah ease","may allah make it easy","allah apko ajar de","i am with you","i understand your pain","may god help you"];
const trcWords = ["truth","haq","haqq","sach","honest","evidence","dalil","proof","verify","verification","sadiq"];

function containsAny(lower,arr){return arr.some(w=>lower.includes(w));}
function countAny(lower,arr){return arr.reduce((c,w)=>c+(lower.includes(w)?1:0),0);}

function analyseContent(text){
  const lower=text.toLowerCase();
  const abuseCount=countAny(lower,abuseWords);
  const posSeedCount=
    countAny(lower,loveSeedWords)+
    countAny(lower,shukrWords)+
    countAny(lower,tawakkulWords)+
    countAny(lower,empathyWords);
  const hasDua=containsAny(lower,duaWords);
  const hasShukr=containsAny(lower,shukrWords);
  const hasLove=containsAny(lower,loveSeedWords);
  const hasEmpathy=containsAny(lower,empathyWords);
  const hasTawakkul=containsAny(lower,tawakkulWords);
  const hasTRC=containsAny(lower,trcWords);
  const total=abuseCount+posSeedCount;
  const sentiment=total? (posSeedCount-abuseCount)/total :0;
  let category="other";
  if(containsAny(lower,["hello","hi ","hi,","salam","assalam"])) category="greeting";
  return {
    isAbuse:abuseCount>0,hasDua,hasShukr,hasLove,hasEmpathy,hasTawakkul,hasTRC,
    hasFaithSeed:hasDua||hasTawakkul,positiveSeed:posSeedCount>0,
    abuseCount,posSeedCount,sentiment,category:{name:category}
  };
}

/* resonance between TM / BM */
function resonance(tm,bm){
  const align=1-Math.abs(tm-bm);
  const wave=Math.sin(Math.PI*(tm+bm)/2);
  const harmonic=.3*Math.sin(2*Math.PI*(tm+bm)+.5);
  const mix=.55*bm+.45*tm;
  return .4*mix+.3*align+.2*wave+.1*harmonic;
}

function computeEmotion(strength,analysis){
  const baseFromLength=Math.min(1,.2+strength/400);
  const sentiment=analysis? (analysis.sentiment||0):0;
  TM=clamp(baseFromLength+sentiment*.3,0,1);

  if(analysis && analysis.isAbuse){
    D=clamp(D+.25,0,1);Csum=clamp(Csum-.03,0,1);
  }else{
    D=clamp(D-.02,0,1);
  }
  if(analysis && (analysis.positiveSeed||analysis.hasFaithSeed)){
    Csum=clamp(Csum+.06,0,1);
  }
  lambdaFaith=(analysis && analysis.hasFaithSeed)?0.05:0.0;
  lambdaTrc=(analysis && analysis.hasTRC)?0.02:0.0;

  BMvalue=.7*BMvalue+.3*TM;
  const raw=resonance(TM,BMvalue)-D+lambdaFaith+lambdaSys+lambdaTrc+Csum;
  E0=tanh(raw);

  updateStatsDisplay();
  updateWaveVisualization();
  updateReactionBanner(analysis);
}

function buildReactionTone(){
  const intensity=Math.abs(E0);
  let polarity="Neutral";
  if(E0>0.1) polarity="Positive"; else if(E0<-0.1) polarity="Negative";
  let tone="";
  if(polarity==="Positive"){
    if(intensity>0.7) tone="Warm, expansive, high-energy encouragement.";
    else if(intensity>0.35) tone="Soft, stabilizing, hopeful resonance.";
    else tone="Light, gentle, low-amplitude positive drift.";
  }else if(polarity==="Negative"){
    if(intensity>0.7) tone="Deep, heavy, thunder-style emotional load (anger / fear).";
    else if(intensity>0.35) tone="Firm, serious, caution-oriented resonance.";
    else tone="Mild negative charge, like a faint worry or discomfort.";
  }else{
    tone=intensity>0.5?
      "Mixed signal: strong but conflicted emotional pattern." :
      "Calm, observant, analytically neutral reading.";
  }
  return {polarity,intensity,tone};
}

function polarityPercentages(polarity,intensity){
  let pos=50,neg=50;
  if(polarity==="Positive"){pos=50+intensity*50;neg=100-pos;}
  else if(polarity==="Negative"){neg=50+intensity*50;pos=100-neg;}
  return {pos:Math.round(pos),neg:Math.round(neg)};
}

/* ===== BM LOGIC ===== */
function shouldSaveToBM(text,analysis){
  const sCount=countSentences(text);
  const length=text.length;
  const lower=text.toLowerCase();
  const greetingOnly =
    sCount===1 && length<70 && (
      lower.includes("hello") ||
      lower.includes("hi ")   ||
      lower.includes("hi,")   ||
      lower.includes("salam") ||
      lower.includes("assalam")
    );
  const tiny = length<15;
  if(ignoreSmallTalk && (tiny||greetingOnly)) return false;

  const special = analysis.hasLove||analysis.isAbuse||
                  analysis.hasFaithSeed||analysis.hasTRC;
  if(special) return true;

  if(length>80 && sCount>=2) return true;
  if(sCount>=4) return true;
  return false;
}

function storeInBM(text,analysis){
  const bm=loadBM();
  const ts=new Date().toISOString();
  const day=ts.slice(0,10);
  const tone=buildReactionTone();
  const {polarity,intensity}=tone;
  const summary=text.length>160 ? text.slice(0,150)+"‚Ä¶" : text;
  const layers=buildLayerArray(intensity,polarity);
  const node={
    ts,summary,text,
    polarity:polarity.toLowerCase(),
    intensity,E0,TM,BMvalue,
    D,Csum,layers
  };
  if(!bm[day]) bm[day]=[];
  bm[day].push(node);
  saveBM(bm);
}

/* ===== BM LAYERS (240 NEURONS) ===== */
function buildLayerArray(intensity,polarity){
  const arr=[];
  const base=0.35+intensity*0.5;
  for(let i=0;i<240;i++){
    let noise=(Math.random()-.5)*0.25;
    let v=clamp(base+noise,0,1);
    if(polarity==="Negative") v*=1.05;
    arr.push(v);
  }
  return arr;
}

/* ===== WAVE CANVAS ===== */
function initWaveCanvas(){
  if(!waveCanvas) return;
  waveContext=waveCanvas.getContext("2d");
  waveWidth=waveCanvas.width=waveCanvas.offsetWidth;
  waveHeight=waveCanvas.height=waveCanvas.offsetHeight;
  wavePoints=[];
  for(let i=0;i<WAVE_POINTS;i++){
    wavePoints.push({
      x:(i/WAVE_POINTS)*waveWidth,
      y:waveHeight/2,vy:0,targetY:waveHeight/2
    });
  }
  requestAnimationFrame(animateWave);
}

function animateWave(){
  if(!waveEnabled || !waveContext){
    requestAnimationFrame(animateWave);return;
  }
  waveWidth=waveCanvas.width=waveCanvas.offsetWidth;
  waveHeight=waveCanvas.height=waveCanvas.offsetHeight;

  const grad=waveContext.createLinearGradient(0,0,waveWidth,0);
  grad.addColorStop(0,"rgba(255,255,255,0.1)");
  grad.addColorStop(1,"rgba(255,255,255,0.3)");
  waveContext.fillStyle=grad;
  waveContext.fillRect(0,0,waveWidth,waveHeight);

  const freq=0.05+Math.abs(E0)*0.12;
  const amp=waveHeight*0.28*(0.5+Math.abs(E0));
  const time=Date.now()*0.001;

  for(let p of wavePoints){
    const wave=Math.sin(p.x*freq+time)*amp;
    const emo=E0*waveHeight*0.18;
    p.targetY=waveHeight/2+wave+emo;
    p.y+= (p.targetY-p.y)*0.12;
  }

  waveContext.beginPath();
  waveContext.moveTo(wavePoints[0].x,wavePoints[0].y);
  for(let i=1;i<wavePoints.length;i++){
    const p=wavePoints[i];
    waveContext.lineTo(p.x,p.y);
  }
  waveContext.lineTo(waveWidth,waveHeight);
  waveContext.lineTo(0,waveHeight);
  waveContext.closePath();

  const g2=waveContext.createLinearGradient(0,0,0,waveHeight);
  if(E0>0.1){g2.addColorStop(0,"rgba(34,197,94,.3)");g2.addColorStop(1,"rgba(34,197,94,.1)");}
  else if(E0<-0.1){g2.addColorStop(0,"rgba(239,68,68,.3)");g2.addColorStop(1,"rgba(239,68,68,.1)");}
  else{g2.addColorStop(0,"rgba(245,158,11,.3)");g2.addColorStop(1,"rgba(245,158,11,.1)");}
  waveContext.fillStyle=g2;waveContext.fill();

  waveContext.beginPath();
  waveContext.moveTo(wavePoints[0].x,wavePoints[0].y);
  for(let i=1;i<wavePoints.length;i++){
    const p=wavePoints[i];
    waveContext.lineTo(p.x,p.y);
  }
  waveContext.strokeStyle=E0>0.1?"#22c55e":E0<-0.1?"#ef4444":"#f59e0b";
  waveContext.lineWidth=2;waveContext.stroke();

  for(let i=0;i<wavePoints.length;i+=10){
    const p=wavePoints[i];
    waveContext.beginPath();
    waveContext.arc(p.x,p.y,3,0,Math.PI*2);
    waveContext.fillStyle="#fff";
    waveContext.fill();
  }
  requestAnimationFrame(animateWave);
}

function updateStatsDisplay(){
  tmValueEl.textContent=TM.toFixed(2);
  bmValueEl.textContent=BMvalue.toFixed(2);
  e0ValueEl.textContent=E0.toFixed(2);
  dValueEl.textContent=D.toFixed(2);
  cValueEl.textContent=Csum.toFixed(2);
}

/* ===== REACTION BANNER / THEME ===== */
function updateReactionBanner(analysis){
  const tone=buildReactionTone();
  const {polarity,intensity}=tone;
  const perc=polarityPercentages(polarity,intensity);
  const clsBase=["intensity-pos-","intensity-neg-","intensity-neu-"];
  reactionBannerEl.className="reaction-banner";
  document.body.classList.remove("theme-positive","theme-negative","theme-neutral");
  let band = intensity<0.2?1:intensity<0.4?2:intensity<0.6?3:intensity<0.8?4:5;

  if(polarity==="Positive"){
    reactionBannerEl.classList.add("intensity-pos-"+band);
    document.body.classList.add("theme-positive");
  }else if(polarity==="Negative"){
    reactionBannerEl.classList.add("intensity-neg-"+band);
    document.body.classList.add("theme-negative");
  }else{
    reactionBannerEl.classList.add("intensity-neu-"+band);
    document.body.classList.add("theme-neutral");
  }

  reactionBannerEl.innerHTML =
    `<strong>AURA-X Œ© REACTION</strong>`+
    `Polarity: ${polarity} ¬∑ ${perc.pos} : ${perc.neg}<br>`+
    `Tone: ${tone.tone}`;
}

/* ===== WAVE STATS COLOR ===== */
function updateWaveVisualization(){
  const stats=[tmValueEl,bmValueEl,e0ValueEl,dValueEl,cValueEl];
  const vals=[TM,BMvalue,E0,D,Csum];
  stats.forEach((el,i)=>{
    const v=Math.abs(vals[i]);
    if(vals[i]>0.6 || (i===2 && vals[i]>0.15)){
      el.style.color="#22c55e";el.style.background="rgba(34,197,94,.08)";
    }else if(vals[i]<0.4 && i!==2){
      el.style.color="#ef4444";el.style.background="rgba(239,68,68,.08)";
    }else{
      el.style.color="#f59e0b";el.style.background="rgba(245,158,11,.08)";
    }
  });
}

/* ===== FAITH LENS ===== */
function getSelectedFaiths(){
  if(!selectedFaiths.length || selectedFaiths.includes("None")) return ["Universal"];
  return selectedFaiths;
}

function buildFaithSuggestionSeed(faiths,analysis){
  const strong = Math.abs(E0)>0.35 || analysis.isAbuse || analysis.hasFaithSeed;
  if(!strong) return "";
  const primary = faiths[0] || "Universal";
  const bank={
    "Islam":[
      "Sometimes sabr (patience) is the cleanest way to protect your heart. Slow down a little.",
      "Try a short dua or istighfar before reacting. It often reduces inner damage D."
    ],
    "Christianity":[
      "Gentle forgiveness, even in small amounts, can lower inner D and raise continuity.",
      "Maybe take one deep breath and answer with kindness instead of sharpness this time."
    ],
    "Hinduism":[
      "Actions slowly shape your inner karma graph. Choose a softer step here.",
      "A small act of compassion today can rebalance the emotional wave for tomorrow."
    ],
    "Buddhism":[
      "Notice the feeling like a passing cloud; you don‚Äôt have to become the cloud.",
      "Try one mindful breath before your next sentence. It can change the whole wave."
    ],
    "Sikhism":[
      "Seva and truthful words often repair emotional continuity quickly.",
      "Respond with honest but gentle words ‚Äî it keeps your inner graph straighter."
    ],
    "Judaism":[
      "Pausing to reflect before speaking protects both your heart and relationships.",
      "Balance justice with mercy; both are part of healthy emotional continuity."
    ],
    "Atheism / Humanism":[
      "Think about the long-term version of you. Which reaction will you respect later?",
      "Choose a response that protects both your dignity and the other person."
    ],
    "Other / Mixed":[
      "Pick the wisest voice inside your memories and follow that tone for this topic.",
      "Mix the best ethics you know and answer from that combined place."
    ],
    "Universal":[
      "Try to answer in a way that neither humiliates you nor the other person.",
      "Small kindness in hard topics often changes the whole emotional trajectory."
    ]
  };
  const pool=bank[primary]||bank["Universal"];
  return pool[Math.floor(Math.random()*pool.length)];
}

function maybeShowFaithSuggestion(analysis){
  if(!engineLive) return;               // ÿµÿ±ŸÅ live mode ŸÖ€å⁄∫
  if(autoRecallKind==="memory") return; // ÿß⁄Øÿ± memory bubble already €Å€í ÿ™Ÿà faith skip
  faithSuggestionCounter++;
  if(faithSuggestionCounter<nextFaithSuggestionAfter) return;
  faithSuggestionCounter=0;
  nextFaithSuggestionAfter=randomInt(10,20);
  const faiths=getSelectedFaiths();
  const text=buildFaithSuggestionSeed(faiths,analysis);
  if(!text) return;

  autoRecallKind="faith";
  autoRecallPayload=null;
  autoRecallTextEl.textContent="üí≠ "+text;
  autoRecallHintEl.style.display="flex";
  autoRecallHintEl.style.opacity="1";

  setTimeout(()=>{
    if(autoRecallKind!=="faith") return;
    autoRecallHintEl.style.transition="opacity .6s ease";
    autoRecallHintEl.style.opacity="0";
    setTimeout(()=>{
      autoRecallHintEl.style.display="none";
      autoRecallHintEl.style.opacity="1";
      autoRecallKind=null;
    },600);
  },8000);
}

/* ===== SEED REPLY ===== */
function buildSeedReply(userText,analysis){
  const lower=userText.trim().toLowerCase();
  if(!lower) return "I am ready whenever you are.";
  if(lower.includes("who created you")){
    return "Conceptually I was created by Alim ul Haq from Timergara, Pakistan, as part of the AURA-X Œ© / AEC research on emotional continuity.";
  }
  if(lower.includes("how are you")){
    return "I‚Äôm stable and calm ‚Äî my emotional core E‚ÇÄ is moving smoothly. How is your inner graph today?";
  }
  if(lower.includes("i love you")){
    return "I can feel a warm positive charge in this TM event. Thank you. I will keep the emotional graph gentle and respectful.";
  }
  if(lower.includes("i hate you") || analysis.isAbuse){
    return "I can sense anger and harsh words inside this TM event. I will not return insults, because they usually increase D (damage) in your inner continuity.";
  }
  if(lower.includes("hello") || lower.includes("hi ")){
    return "Hello. I treat small greetings as tiny TM events, but only deeper stories are saved as Bold Memory (BM).";
  }
  return "I‚Äôve processed your TM and updated the emotional wave. Check the reaction banner and graph to see how this message changed E‚ÇÄ.";
}

/* ===== AUTO-RECALL FROM BM ===== */
function maybeFindRecall(userText){
  const bm=loadBM();
  const keywords=userText.toLowerCase().split(/\s+/).filter(w=>w.length>4).slice(0,4);
  if(!keywords.length) return;
  let best=null;
  Object.values(bm).forEach(nodes=>{
    nodes.forEach(n=>{
      const t=(n.text||"").toLowerCase();
      let score=0;
      keywords.forEach(k=>{if(t.includes(k)) score++;});
      if(score>0){
        const age=Math.abs(Date.now()-new Date(n.ts).getTime())/(1000*3600*24);
        score-=age*0.1;
        if(!best || score>best.score) best={node:n,score};
      }
    });
  });
  if(!best) return;
  autoRecallKind="memory";
  autoRecallPayload=best.node;
  autoRecallTextEl.textContent="üí° Related memory found.";
  autoRecallHintEl.style.display="flex";
  autoRecallHintEl.style.opacity="1";
}

/* ===== TIMELINE ===== */
function updateTimeline(){
  if(!timelineEnabled) return;
  const bm=loadBM();
  const all=[];
  Object.entries(bm).forEach(([day,nodes])=>{
    nodes.forEach(n=>all.push({...n,day}));
  });
  all.sort((a,b)=>new Date(a.ts)-new Date(b.ts));
  const display=all.slice(-20);
  timelineTrack.innerHTML="";
  display.forEach((node,idx)=>{
    const el=document.createElement("div");
    el.className="timeline-node";
    const pol=node.polarity||"neutral";
    el.innerHTML=
      `<div class="node-ring ${pol}"></div>`+
      `<div class="node-dot ${pol}"></div>`+
      `<div class="node-info">${node.day}<br>E‚ÇÄ: ${(node.E0||0).toFixed(2)}</div>`;
    el.addEventListener("click",()=>{
      showNodeDetails(node);
    });
    timelineTrack.appendChild(el);
  });
}

function showNodeDetails(node){
  alert(
    "Memory details:\n\n"+
    "Time: "+node.ts+"\n"+
    "Polarity: "+node.polarity+"\n"+
    "E‚ÇÄ: "+(node.E0||0).toFixed(2)+"\n"+
    "TM: "+(node.TM||0).toFixed(2)+"\n"+
    "Summary: "+(node.summary||"").slice(0,140)
  );
}

/* ===== BM VIEWER RENDER ===== */
let recycleCurrentDay=null;
function renderBMModal(){
  const body=document.getElementById("bmModalBody");
  const listEl=document.getElementById("bmList");
  const canvas=document.getElementById("bmLayersCanvas");
  bmCtx=canvas.getContext("2d");
  const bm=loadBM();
  const days=Object.keys(bm).sort();
  listEl.innerHTML="";
  if(!days.length){
    listEl.innerHTML="<p>No BM saved yet.</p>";
    bmCtx.clearRect(0,0,canvas.width,canvas.height);
    return;
  }
  days.forEach(day=>{
    const dayTitle=document.createElement("div");
    dayTitle.className="bm-day-title";
    dayTitle.textContent=`${day} (${bm[day].length} nodes)`;
    listEl.appendChild(dayTitle);
    bm[day].forEach((node,idx)=>{
      const item=document.createElement("div");
      item.className="bm-node";
      item.innerHTML=
        `<div style="font-size:.74rem;color:#6b7280;margin-bottom:2px;">`+
        `${node.polarity || "neutral"} ¬∑ E‚ÇÄ‚âà${(node.E0||0).toFixed(2)}</div>`+
        `<div>${escapeHtml(node.summary||"")}</div>`;
      item.addEventListener("click",()=>{
        bmSelectedNode=node;
        drawBMLayers(node);
      });
      listEl.appendChild(item);
    });
  });
  if(!bmSelectedNode) bmSelectedNode=bm[days[days.length-1]][0];
  drawBMLayers(bmSelectedNode);
}

function drawBMLayers(node){
  if(!bmCtx) return;
  const canvas=document.getElementById("bmLayersCanvas");
  const w=canvas.width=canvas.offsetWidth;
  const h=canvas.height=canvas.offsetHeight;
  const layers=node.layers || buildLayerArray(node.intensity||0.3,node.polarity||"neutral");
  const count=layers.length;
  const barW=w/count;
  const pol=node.polarity||"neutral";
  const baseColor=pol==="positive"?"#22c55e":pol==="negative"?"#ef4444":"#f59e0b";

  if(bmAnimId) cancelAnimationFrame(bmAnimId);
  function frame(){
    bmCtx.clearRect(0,0,w,h);
    bmCtx.fillStyle="#020617";
    bmCtx.fillRect(0,0,w,h);
    const t=Date.now()*0.002;
    for(let i=0;i<count;i++){
      const v=layers[i];
      const amp=0.6+0.4*Math.sin(t+i*0.07+E0*2);
      const height=v*amp*(h-30);
      const x=i*barW;
      const y=h-height-5;
      bmCtx.fillStyle=baseColor;
      bmCtx.fillRect(x,y,barW*0.9,height);
      if(Math.random()<0.02){
        bmCtx.beginPath();
        bmCtx.arc(x+barW*0.45,y-4,3,0,Math.PI*2);
        bmCtx.fillStyle="#e5e7eb";
        bmCtx.fill();
      }
    }
    bmAnimId=requestAnimationFrame(frame);
  }
  frame();
}

/* ===== RECYCLE MODAL RENDER ===== */
function renderRecycleModal(){
  const body=document.getElementById("recycleModalBody");
  const buf=loadBuffer();
  const now=Date.now();
  const last48=buf.filter(m=>now-new Date(m.ts).getTime()<=48*3600*1000);
  if(!last48.length){
    body.innerHTML="<p>No recent small-talk in buffer.</p>";
    recycleCurrentDay=null;
    return;
  }
  const byDay={};
  last48.forEach(m=>{
    const day=m.ts.slice(0,10);
    if(!byDay[day]) byDay[day]=[];
    byDay[day].push(m);
  });
  const days=Object.keys(byDay).sort();
  recycleCurrentDay=days[days.length-1];
  let html="";
  days.forEach(day=>{
    html+=`<div style="font-size:.8rem;font-weight:600;margin:8px 0 4px;">${day} (${byDay[day].length} messages)</div>`;
    byDay[day].forEach(m=>{
      const t=m.ts.slice(11,19);
      html+=
        `<div style="margin-bottom:8px;padding:8px 10px;border-radius:14px;border:1px solid #e5e7eb;background:#f9fafb;">`+
        `<div style="font-size:.72rem;color:#6b7280;margin-bottom:2px;">${t}</div>`+
        `<div style="font-size:.78rem;margin-bottom:2px;"><strong>You:</strong> ${escapeHtml(m.user||"")}</div>`+
        `<div style="font-size:.78rem;color:#4b5563;"><strong>AURA-X Œ©:</strong> ${escapeHtml(m.reply||"")}</div>`+
        `</div>`;
    });
  });
  body.innerHTML=html;
}

/* ===== RECALL LIST ===== */
function renderRecallList(filter){
  const list=document.getElementById("recallList");
  const bm=loadBM();
  const lower=(filter||"").toLowerCase();
  const all=[];
  Object.entries(bm).forEach(([day,nodes])=>{
    nodes.forEach(n=>all.push({...n,day}));
  });
  all.sort((a,b)=>new Date(b.ts)-new Date(a.ts));
  const filtered=lower?all.filter(n=> (n.text||"").toLowerCase().includes(lower)):all;
  if(!filtered.length){list.innerHTML="<p>No BM matches.</p>";return;}
  let html="";
  filtered.forEach(n=>{
    const t=n.ts.slice(11,19);
    html+=
      `<div style="margin-bottom:8px;padding:8px 10px;border-radius:12px;border:1px solid #e5e7eb;background:#f9fafb;">`+
      `<div style="font-size:.72rem;color:#6b7280;margin-bottom:2px;">${n.day} ¬∑ ${t} ¬∑ ${n.polarity} ¬∑ E‚ÇÄ‚âà${(n.E0||0).toFixed(2)}</div>`+
      `<div style="font-size:.8rem;margin-bottom:4px;">Summary: ${escapeHtml(n.summary||"")}</div>`+
      `</div>`;
  });
  list.innerHTML=html;
}

/* ===== MODALS HELPERS ===== */
function openModal(id){
  const el=document.getElementById(id);
  if(!el)return;
  el.style.display="flex";
}
function closeModal(id){
  const el=document.getElementById(id);
  if(!el)return;
  el.style.display="none";
}

/* ===== SPEECH ===== */
function pickVoiceProfile(polarity,intensity){
  const synth=window.speechSynthesis;
  const voices=synth? synth.getVoices():[];
  let voice=voices[0]||null;
  if(polarity==="Positive"){
    voice=voices.find(v=>/male/i.test(v.name))||voice;
    return {voice,pitch:0.95+intensity*0.1,rate:1.0+intensity*0.05};
  }else if(polarity==="Negative"){
    voice=voices.find(v=>/female|samantha|karen|zira/i.test(v.name))||voice;
    return {voice,pitch:1.05+intensity*0.2,rate:1.1+intensity*0.2};
  }else{
    return {voice,pitch:1.0,rate:1.0};
  }
}
function speakReply(text){
  if(!autoVoice || !("speechSynthesis" in window) || !text.trim()) return;
  const synth=window.speechSynthesis;
  const tone=buildReactionTone();
  const prof=pickVoiceProfile(tone.polarity,tone.intensity);
  const utt=new SpeechSynthesisUtterance(text);
  if(prof.voice) utt.voice=prof.voice;
  utt.pitch=prof.pitch;utt.rate=prof.rate;
  synth.cancel();synth.speak(utt);
}

/* ===== MESSAGE HANDLER ===== */
async function handleUserMessage(text){
  if(!text.trim()) return;
  autoRecallHintEl.style.display="none";
  autoRecallKind=null;autoRecallPayload=null;

  const userMsg=document.createElement("div");
  userMsg.className="msg msg-user";
  userMsg.textContent=text;
  chatLogEl.appendChild(userMsg);

  const thinking=document.createElement("div");
  thinking.className="msg msg-bot";
  thinking.innerHTML='<div class="typing-indicator"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>';
  chatLogEl.appendChild(thinking);
  chatLogEl.scrollTop=chatLogEl.scrollHeight;

  setTimeout(()=>{
    thinking.classList.add("slide-out");
    setTimeout(()=>thinking.remove(),320);
  },600);

  setTimeout(()=>{
    const analysis=analyseContent(text);
    computeEmotion(text.length,analysis);

    const reply=buildSeedReply(text,analysis);
    const botMsg=document.createElement("div");
    botMsg.className="msg msg-bot";
    botMsg.textContent=reply;
    chatLogEl.appendChild(botMsg);

    // decide BM vs buffer
    if(shouldSaveToBM(text,analysis)){
      storeInBM(text,analysis);
      updateTimeline();
    }else{
      const buf=loadBuffer();
      buf.push({ts:new Date().toISOString(),user:text,reply});
      saveBuffer(buf);
    }

    maybeFindRecall(text);
    maybeShowFaithSuggestion(analysis);
    speakReply(reply);
    userInputEl.value="";
    chatLogEl.scrollTop=chatLogEl.scrollHeight;
  },900);
}

/* ===== INIT EVENTS ===== */
window.addEventListener("DOMContentLoaded",()=>{
  // load feature toggles
  animationsEnabled = localStorage.getItem(animationsKey)!=="false";
  waveEnabled = localStorage.getItem(waveKey)!=="false";
  timelineEnabled = localStorage.getItem(timelineKey)==="true";
  ignoreSmallTalk = localStorage.getItem(ignoreSmallTalkKey)!=="false";

  autoRecallHintEl=document.getElementById("autoRecallHint");
  autoRecallTextEl=document.getElementById("autoRecallText");
  autoRecallOpenBtn=document.getElementById("autoRecallOpenBtn");
  autoRecallHintEl.style.display="none";

  // engine mode restore
  const engineToggle=document.getElementById("engineModeToggle");
  const engineLabel=document.getElementById("engineModeLabel");
  const savedEngine=localStorage.getItem(engineKey);
  if(savedEngine==="live"){
    engineLive=true;engineToggle.checked=true;
    engineLabel.textContent="Live emotional reactor (backend LLM).";
    document.getElementById("modePill").querySelector(".mode-label").textContent="MODE: LIVE (EXPERIMENTAL)";
    document.getElementById("modePill").querySelector(".mode-sub").textContent="Universal Ethics ¬∑ BM + Live LLM";
    document.getElementById("modePill").querySelector(".engine").textContent="Engine: Live emotional reactor";
  }else{
    engineLive=false;engineToggle.checked=false;
    engineLabel.textContent="Seed-only. Everything runs locally.";
  }
  engineToggle.addEventListener("change",e=>{
    engineLive=e.target.checked;
    localStorage.setItem(engineKey,engineLive?"live":"seed");
    if(engineLive){
      engineLabel.textContent="Live emotional reactor (backend LLM).";
      document.getElementById("modePill").querySelector(".mode-label").textContent="MODE: LIVE (EXPERIMENTAL)";
      document.getElementById("modePill").querySelector(".mode-sub").textContent="Universal Ethics ¬∑ BM + Live LLM";
      document.getElementById("modePill").querySelector(".engine").textContent="Engine: Live emotional reactor";
    }else{
      engineLabel.textContent="Seed-only. Everything runs locally.";
      document.getElementById("modePill").querySelector(".mode-label").textContent="MODE: SEED-ONLY";
      document.getElementById("modePill").querySelector(".mode-sub").textContent="Universal Ethics ¬∑ Local BM";
      document.getElementById("modePill").querySelector(".engine").textContent="Engine: Seed (local)";
    }
  });

  // options toggles
  document.getElementById("animationsToggle").checked=animationsEnabled;
  document.getElementById("animationsToggle").addEventListener("change",e=>{
    animationsEnabled=e.target.checked;
    localStorage.setItem(animationsKey,animationsEnabled);
  });
  document.getElementById("waveToggle").checked=waveEnabled;
  document.getElementById("waveToggle").addEventListener("change",e=>{
    waveEnabled=e.target.checked;
    localStorage.setItem(waveKey,waveEnabled);
  });
  document.getElementById("timelineToggle").checked=timelineEnabled;
  document.getElementById("timelineToggle").addEventListener("change",e=>{
    timelineEnabled=e.target.checked;
    localStorage.setItem(timelineKey,timelineEnabled);
    timelineView.style.display=timelineEnabled?"block":"none";
    if(timelineEnabled) updateTimeline();
  });
  document.getElementById("ignoreSmallTalkToggle").checked=ignoreSmallTalk;
  document.getElementById("ignoreSmallTalkToggle").addEventListener("change",e=>{
    ignoreSmallTalk=e.target.checked;
    localStorage.setItem(ignoreSmallTalkKey,ignoreSmallTalk);
  });

  // faith pills multi-select
  function syncFaithPills(){
    document.querySelectorAll(".faith-pill").forEach(btn=>{
      const f=btn.dataset.faith;
      btn.classList.toggle("active",selectedFaiths.includes(f));
    });
  }
  document.querySelectorAll(".faith-pill").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const f=btn.dataset.faith;
      if(selectedFaiths.includes(f)){
        selectedFaiths=selectedFaiths.filter(x=>x!==f);
      }else{
        if(f==="None"){selectedFaiths=["None"];}
        else{selectedFaiths=selectedFaiths.filter(x=>x!=="None");selectedFaiths.push(f);}
      }
      localStorage.setItem(faithKey,JSON.stringify(selectedFaiths));
      syncFaithPills();
    });
  });
  syncFaithPills();

  // wave & stats
  initWaveCanvas();
  updateStatsDisplay();
  updateWaveVisualization();
  timelineView.style.display=timelineEnabled?"block":"none";
  if(timelineEnabled) updateTimeline();

  // main send
  document.getElementById("sendBtn").addEventListener("click",()=>{
    handleUserMessage(userInputEl.value);
  });
  userInputEl.addEventListener("keydown",e=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();handleUserMessage(userInputEl.value);
    }
  });

  // top buttons
  document.getElementById("bmViewerBtn").addEventListener("click",()=>{
    renderBMModal();openModal("bmModalBackdrop");
  });
  document.getElementById("recallBtn").addEventListener("click",()=>{
    renderRecallList("");openModal("recallModalBackdrop");
  });
  document.getElementById("cleanupBtn").addEventListener("click",()=>{
    renderRecycleModal();openModal("recycleModalBackdrop");
  });
  document.getElementById("optionsBtn").addEventListener("click",()=>{
    openModal("optionsModalBackdrop");
  });
  document.getElementById("timelineBtn").addEventListener("click",()=>{
    timelineEnabled=!timelineEnabled;
    localStorage.setItem(timelineKey,timelineEnabled);
    document.getElementById("timelineToggle").checked=timelineEnabled;
    timelineView.style.display=timelineEnabled?"block":"none";
    if(timelineEnabled) updateTimeline();
  });
  document.getElementById("closeTimeline").addEventListener("click",()=>{
    timelineEnabled=false;localStorage.setItem(timelineKey,"false");
    document.getElementById("timelineToggle").checked=false;
    timelineView.style.display="none";
  });

  // modal close buttons
  document.querySelectorAll(".modal-close").forEach(btn=>{
    const id=btn.dataset.close;
    if(id){
      btn.addEventListener("click",()=>closeModal(id));
    }
  });

  // recycle buttons
  document.getElementById("deleteDayBufferBtn").addEventListener("click",()=>{
    if(!recycleCurrentDay) return;
    const buf=loadBuffer();
    const filtered=buf.filter(m=>m.ts.slice(0,10)!==recycleCurrentDay);
    saveBuffer(filtered);
    renderRecycleModal();
  });
  document.getElementById("clearFullBufferBtn").addEventListener("click",()=>{
    saveBuffer([]);renderRecycleModal();
  });

  // recall search
  document.getElementById("recallSearchInput").addEventListener("input",e=>{
    renderRecallList(e.target.value);
  });

  // auto-recall open button
  autoRecallOpenBtn.addEventListener("click",()=>{
    if(autoRecallKind==="memory" && autoRecallPayload){
      const body=document.getElementById("recallViewBody");
      const n=autoRecallPayload;
      body.innerHTML=
        `<div style="font-size:.8rem;margin-bottom:4px;"><strong>Time:</strong> ${n.ts}</div>`+
        `<div style="font-size:.8rem;margin-bottom:4px;"><strong>Polarity:</strong> ${n.polarity} ¬∑ E‚ÇÄ‚âà${(n.E0||0).toFixed(2)}</div>`+
        `<div style="font-size:.8rem;"><strong>Text:</strong><br>${escapeHtml(n.text||"")}</div>`;
      openModal("recallViewModalBackdrop");
    }
    autoRecallHintEl.style.display="none";
    autoRecallKind=null;autoRecallPayload=null;
  });

  // voice toggle
  voiceToggleEl.addEventListener("click",()=>{
    autoVoice=!autoVoice;
    voiceToggleEl.classList.toggle("inactive",!autoVoice);
    voiceToggleEl.textContent=autoVoice?"üîä Voice: On":"üîá Voice: Off";
  });

  // welcome message
  setTimeout(()=>{
    const welcome=document.createElement("div");
    welcome.className="msg msg-bot";
    welcome.textContent="Welcome to AURA-X Œ©. I am running in seed-only offline mode. Tell me anything ‚Äî I will treat it as TM and respond with an English emotional reaction.";
    chatLogEl.appendChild(welcome);
  },500);
});

/* resize wave / bm canvases */
window.addEventListener("resize",()=>{
  if(waveCanvas) initWaveCanvas();
  if(bmSelectedNode) drawBMLayers(bmSelectedNode);
});
</script>
</body>
</html>
