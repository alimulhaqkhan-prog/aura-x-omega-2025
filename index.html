<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Emotional Continuity Reactor (v3.2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      height: 100%;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }
    .app {
      width: 100%;
      max-width: 720px;
      padding: 16px 16px 80px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    @media (min-width: 768px) {
      .app {
        padding: 24px 24px 96px;
      }
    }

    /* ===== Pills / buttons ===== */
    .pill-row {
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;          /* -> sab ek line me */
      overflow-x: auto;           /* chhota screen pe side scroll ho sakta hai */
      padding-bottom: 2px;
    }
    .pill-row::-webkit-scrollbar {
      height: 4px;
    }
    .pill-row::-webkit-scrollbar-thumb {
      background: rgba(55,65,81,0.7);
      border-radius: 999px;
    }

    .pill {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: radial-gradient(circle at top left,
        rgba(30, 64, 175, 0.5),
        rgba(15, 23, 42, 0.9));
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      white-space: nowrap;
    }
    .pill:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .pill-ghost {
      background: rgba(15, 23, 42, 0.8);
    }
    .pill-warning {
      background: radial-gradient(circle at top left,
        rgba(220, 38, 38, 0.6),
        rgba(15, 23, 42, 0.95));
      border-color: rgba(248, 113, 113, 0.8);
    }
    .pill-toggle {
      background: rgba(15, 23, 42, 0.95);
      border-color: rgba(148, 163, 184, 0.9);
    }

    /* ===== Header ===== */
    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }
    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .title-block h1 {
      font-size: 22px;
      letter-spacing: 0.08em;
    }
    .subtitle {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #9ca3af;
    }
    .mode-pill {
      font-size: 11px;
      border-radius: 999px;
      padding: 8px 12px;
      border: 1px solid rgba(56, 189, 248, 0.7);
      color: #a5f3fc;
      background: radial-gradient(circle at top right,
        rgba(8, 47, 73, 0.9),
        rgba(15, 23, 42, 0.95));
      text-align: right;
    }
    .mode-pill span {
      display: block;
      font-size: 10px;
      color: #38bdf8;
    }

    /* ===== Panels ===== */
    .panel {
      border-radius: 18px;
      padding: 12px 14px;
      background: radial-gradient(circle at top left,
        rgba(15, 23, 42, 0.95),
        rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
      font-size: 13px;
      line-height: 1.45;
    }
    .panel-warning {
      border-color: rgba(248, 181, 58, 0.9);
      background: radial-gradient(circle at top left,
        rgba(251, 191, 36, 0.12),
        rgba(15, 23, 42, 0.98));
      color: #fed7aa;
      font-size: 12px;
    }
    .panel h3 {
      font-size: 12px;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #9ca3af;
    }

    .equation-row {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono",
        "Courier New", monospace;
      font-size: 13px;
      margin-top: 4px;
      line-height: 1.5;
    }
    .equation-main {
      font-size: 14px;
      color: #e5e7eb;
    }
    .equation-values {
      color: #9ca3af;
      margin-top: 2px;
    }

    .reaction-panel {
      border-radius: 18px;
      padding: 10px 14px 10px;
      margin-top: 8px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at top left,
        rgba(15, 23, 42, 0.98),
        rgba(15, 23, 42, 1));
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
    }
    .reaction-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }
    .reaction-title {
      font-size: 12px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #9ca3af;
    }
    .reaction-meta {
      font-size: 11px;
      color: #9ca3af;
    }
    .reaction-body {
      font-size: 13px;
      line-height: 1.6;
      margin-top: 4px;
      color: #e5e7eb;
    }
    .tone-text {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .reaction-panel.positive {
      border-color: rgba(52, 211, 153, 0.9);
      box-shadow: 0 16px 40px rgba(16, 185, 129, 0.35);
    }
    .reaction-panel.negative {
      border-color: rgba(248, 113, 113, 0.9);
      box-shadow: 0 16px 40px rgba(248, 113, 113, 0.35);
    }
    .reaction-panel.neutral {
      border-color: rgba(234, 179, 8, 0.8);
      box-shadow: 0 16px 40px rgba(234, 179, 8, 0.25);
    }

    .scalar-footnote {
      margin-top: 6px;
      font-size: 11px;
      color: #6b7280;
    }

    /* ===== Input ===== */
    .input-panel {
      margin-top: 8px;
    }
    .tm-label {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    textarea {
      width: 100%;
      min-height: 84px;
      border-radius: 18px;
      padding: 10px 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
      resize: vertical;
      font-size: 13px;
      line-height: 1.4;
      outline: none;
    }
    textarea::placeholder {
      color: #6b7280;
    }
    .send-row {
      display: flex;
      justify-content: flex-end;
      margin-top: 8px;
    }
    .btn-send {
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 13px;
      border: none;
      background: linear-gradient(to right, #22c55e, #16a34a);
      color: #ecfdf5;
      cursor: pointer;
      box-shadow: 0 12px 32px rgba(22, 163, 74, 0.5);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-send:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    /* ===== Footer demo buttons ===== */
    .footer-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 8px 12px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      background: linear-gradient(to top,
        rgba(15, 23, 42, 0.95),
        rgba(15, 23, 42, 0.85),
        transparent);
      backdrop-filter: blur(16px);
    }
    .demo-row {
      display: flex;
      gap: 8px;
    }
    .demo-btn {
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 12px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.55);
    }
    .demo-negative {
      background: radial-gradient(circle at top left,
        #450a0a,
        #7f1d1d);
      color: #fecaca;
    }
    .demo-positive {
      background: radial-gradient(circle at top left,
        #064e3b,
        #15803d);
      color: #bbf7d0;
    }

    .footer-right {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: #9ca3af;
    }

    /* ===== Modal (Options / BM viewer) ===== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.88);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }
    .modal {
      width: 100%;
      max-width: 720px;
      max-height: 90vh;
      border-radius: 22px;
      padding: 14px 16px 16px;
      background: radial-gradient(circle at top,
        rgba(15, 23, 42, 0.98),
        #020617);
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.9);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 13px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .modal-title {
      font-size: 13px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #9ca3af;
    }
    .modal-close {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      font-size: 11px;
      cursor: pointer;
    }
    .modal-body {
      margin-top: 4px;
      padding-right: 2px;
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .modal-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #9ca3af;
      margin-bottom: 2px;
      margin-top: 8px;
    }
    .faith-row,
    .engine-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .faith-pill {
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 11px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      cursor: pointer;
    }
    .faith-pill.active {
      border-color: rgba(52, 211, 153, 0.95);
      background: radial-gradient(circle at top left,
        rgba(22, 163, 74, 0.35),
        rgba(15, 23, 42, 0.98));
      color: #bbf7d0;
    }
    .switch-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 6px;
      gap: 10px;
      font-size: 12px;
    }
    .switch-label {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
      color: #9ca3af;
    }
    .switch-toggle {
      width: 42px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.8);
      background: rgba(15, 23, 42, 0.95);
      position: relative;
      cursor: pointer;
      flex-shrink: 0;
    }
    .switch-knob {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #6b7280;
      transition: transform 0.18s ease, background 0.18s ease;
    }
    .switch-toggle.on {
      background: rgba(22, 163, 74, 0.1);
      border-color: rgba(52, 211, 153, 0.95);
    }
    .switch-toggle.on .switch-knob {
      transform: translateX(18px);
      background: #22c55e;
    }

    .engine-note {
      font-size: 11px;
      color: #6b7280;
      margin-top: 6px;
    }

    .models-list {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 6px;
      line-height: 1.5;
      padding-left: 18px;
    }

    /* ===== BM colourful style ===== */
    .bm-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }
    .bm-item {
      padding: 8px 9px;
      border-radius: 14px;
      background: radial-gradient(circle at top left,
        rgba(15, 23, 42, 0.98),
        rgba(15, 23, 42, 1));
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 12px;
    }
    .bm-header {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 3px;
    }
    .bm-header span {
      margin-right: 6px;
    }
    .bm-snippet {
      font-size: 12px;
      color: #e5e7eb;
      margin-bottom: 4px;
    }
    .bm-layer-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 4px;
    }
    .layer-pill {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 10px;
      color: #0f172a;
      font-weight: 600;
    }
    .layer-pill.l1 { background: #bfdbfe; }  /* blue */
    .layer-pill.l2 { background: #fed7e2; }  /* pink */
    .layer-pill.l3 { background: #fcd34d; }  /* amber */
    .layer-pill.l4 { background: #c4b5fd; }  /* violet */
    .layer-pill.l5 { background: #bbf7d0; }  /* green */
    .layer-pill.l6 { background: #fde68a; }  /* yellow */
    .layer-pill.l7 { background: #e5e7eb; }  /* gray */
    .bm-trigger {
      font-size: 11px;
      color: #9ca3af;
    }

    .bm-delete-day {
      align-self: flex-end;
      margin-top: 6px;
    }

    .small-note {
      font-size: 10px;
      color: #6b7280;
      margin-top: 4px;
    }

    a {
      color: #38bdf8;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-block">
        <h1>AURA-X Œ©</h1>
        <div class="subtitle">
          EMOTIONAL CONTINUITY ¬∑ AEC ¬∑ CRM ¬∑ AECN ¬∑ RL¬≥ ¬∑ LR¬≥
        </div>
      </div>
      <div class="mode-pill" id="modePill">
        MODE: OFFLINE PROTOTYPE
        <span>Universal Ethics ¬∑ BM + Live LLM</span>
      </div>
    </header>

    <div class="pill-row">
      <button class="pill pill-ghost" id="btnBmViewer">üß† BM Viewer</button>
      <button class="pill pill-ghost" id="btnRecallBm">üìÇ Recall BM</button>
      <button class="pill pill-ghost" id="btnCleanup24h">‚ôªÔ∏è Cleanup 24h</button>
      <button class="pill pill-ghost" id="btnOptions">‚öôÔ∏è Options</button>
    </div>

    <div class="panel panel-warning">
      Avoid actions that generate negative emotions in yourself or others.
      Gently move toward choices that create calm, kindness, and positive
      feelings.
    </div>

    <div class="panel" id="equationPanel">
      <h3>EMOTIONAL CONTINUITY EQUATION</h3>
      <div class="equation-row equation-main">
        E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)
      </div>
      <div class="equation-row equation-values" id="equationValues"></div>

      <div class="reaction-panel neutral" id="reactionPanel">
        <div class="reaction-header">
          <div class="reaction-title">AURA-X Œ© REACTION</div>
          <div class="reaction-meta" id="reactionMeta">
            Polarity: Neutral / Mixed ¬∑ Intensity: 0.00
          </div>
        </div>
        <div class="tone-text" id="reactionTone">
          Tone: Calm, observant, analytically neutral reading.
        </div>
        <div class="reaction-body" id="reactionBody">
          This is the seed emotional reactor running locally. Type any real
          memory or feeling below. AURA-X Œ© will treat it as TM (Temporary
          Memory), combine it with your stored BM (Bold Memory) and show how
          your continuity field responds.
        </div>
        <div class="scalar-footnote" id="scalarFootnote">
          E‚ÇÄ=0.00 ¬∑ TM=0.00 ¬∑ D=0.00 ¬∑ tag=neutral
        </div>
      </div>

      <div class="panel input-panel">
        <div class="tm-label">
          <span>Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory).</span>
        </div>
        <textarea
          id="tmInput"
          placeholder="Example: &quot;I argued with my friend and now I feel guilty.&quot; or &quot;I am grateful for the small good things in my life today.&quot;"
        ></textarea>
        <div class="send-row">
          <button class="btn-send" id="btnSend">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer demo & voice -->
  <div class="footer-bar">
    <div class="demo-row">
      <button class="demo-btn demo-negative" id="btnDemoNegative">
        üêí Dog Bite (Negative Demo)
      </button>
      <button class="demo-btn demo-positive" id="btnDemoPositive">
        ‚ù§Ô∏è Lost Child (Positive Demo)
      </button>
    </div>
    <div class="footer-right">
      <button id="voiceToggle" class="pill pill-toggle">
        üîä Voice: On
      </button>
      <span id="engineStatusText">Engine: Backend LLM</span>
    </div>
  </div>

  <!-- Options modal -->
  <div class="modal-overlay" id="optionsOverlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">AURA-X Œ© OPTIONS</div>
        <button class="modal-close" id="optionsClose">Close</button>
      </div>
      <div class="modal-body">
        <div class="modal-section-title">Faith Lens (Optional)</div>
        <div style="font-size: 12px; color: #9ca3af;">
          Universal ethics are always active. You can optionally pick a faith
          lens to shape encouragement lines locally. Nothing is sent to any
          external server.
        </div>
        <div class="faith-row" id="faithRow">
          <button class="faith-pill" data-faith="none">None</button>
          <button class="faith-pill" data-faith="islam">Islam</button>
          <button class="faith-pill" data-faith="christianity">Christianity</button>
          <button class="faith-pill" data-faith="hinduism">Hinduism</button>
          <button class="faith-pill" data-faith="buddhism">Buddhism</button>
          <button class="faith-pill" data-faith="sikhism">Sikhism</button>
          <button class="faith-pill" data-faith="judaism">Judaism</button>
          <button class="faith-pill" data-faith="atheism">Atheism / Humanism</button>
          <button class="faith-pill" data-faith="mixed">Other / Mixed</button>
        </div>

        <div class="modal-section-title">Engine Mode</div>
        <div style="font-size: 12px; color: #9ca3af;">
          Seed-only (offline) or Live emotional reactor (via backend).
        </div>
        <div class="switch-row">
          <div class="switch-label">
            <span>Current:</span>
            <span id="engineModeLabel">Live emotional reactor (backend LLM).</span>
          </div>
          <div class="switch-toggle on" id="engineToggle">
            <div class="switch-knob"></div>
          </div>
        </div>

        <div class="engine-note">
          When live mode is ON, AURA-X Œ© will call your backend emotional reactor.
          The frontend never reveals which exact LLM model is used. It always
          identifies as the AURA-X Œ© artificial resonance reactor.
        </div>

        <ul class="models-list">
          <li>OpenAI ‚Äì GPT-4.1 / GPT-4o</li>
          <li>Anthropic ‚Äì Claude 3.5 Sonnet / Opus</li>
          <li>Google ‚Äì Gemini 1.5 Pro</li>
          <li>Mistral ‚Äì Mistral Large</li>
          <li>Cohere ‚Äì Command-R+</li>
          <li>xAI ‚Äì Grok-2</li>
          <li>Meta ‚Äì Llama-3-70B-Instruct</li>
          <li>Qwen ‚Äì Qwen-2-72B</li>
          <li>DeepSeek ‚Äì DeepSeek-Coder-V2</li>
        </ul>

        <div class="modal-section-title">Prototype Controls</div>
        <div style="font-size: 12px; color: #9ca3af;">
          Auto-summarize long conversations to ~200 sentences, ignore tiny
          "hello / hi / how are you" small-talk as BM, and manage your stored
          BM life.
        </div>

        <div class="switch-row">
          <div class="switch-label">
            <span>Auto-summarize long conversations (~200 sentences)</span>
          </div>
          <div class="switch-toggle on" id="toggleSummarize">
            <div class="switch-knob"></div>
          </div>
        </div>

        <div class="switch-row">
          <div class="switch-label">
            <span>Ignore tiny small-talk as BM (hello / hi / how are you)</span>
          </div>
          <div class="switch-toggle on" id="toggleIgnoreSmalltalk">
            <div class="switch-knob"></div>
          </div>
        </div>

        <div class="switch-row">
          <div class="switch-label">
            <span>Clear all stored BM for the last 24 hours (wastage cleanup)</span>
          </div>
          <button class="pill pill-warning" id="btnClear24hModal">
            Clear 24h
          </button>
        </div>

        <div class="switch-row">
          <div class="switch-label">
            <span>Delete full local BM life (all days)</span>
          </div>
          <button class="pill pill-warning" id="btnDeleteAllBm">
            Delete All
          </button>
        </div>

        <div class="small-note">
          About AURA-X Œ©: Designed around the idea that emotions are continuity
          functions between memories (TM and BM), not isolated sparks. This page
          is a small offline demo of Alim ul Haq‚Äôs emotional continuity theory.
        </div>
      </div>
    </div>
  </div>

  <!-- BM Viewer modal -->
  <div class="modal-overlay" id="bmOverlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">BOLD MEMORY (BM) VIEWER</div>
        <button class="modal-close" id="bmClose">Close</button>
      </div>
      <div class="modal-body">
        <div style="font-size: 12px; color: #9ca3af;">
          These are compressed emotional events stored locally on your device.
          They never leave your browser. Each entry is a TM ‚Üí E‚ÇÄ snapshot that
          contributes to your long-run BM layers.
        </div>
        <ul class="bm-list" id="bmList"></ul>
        <button class="pill pill-warning bm-delete-day" id="btnDeleteDay">
          Delete Day
        </button>
      </div>
    </div>
  </div>

  <script>
    // ===========================
    // AURA-X Œ© ‚Äì Core State
    // ===========================
    const BACKEND_URL = "https://aura-x-backend-jliz.onrender.com/react";

    const state = {
      faithLens: localStorage.getItem("auraX_faithLens") || "none",
      engineLive: JSON.parse(localStorage.getItem("auraX_engineLive") || "true"),
      bmEvents: [],
      summarizeOn: JSON.parse(localStorage.getItem("auraX_summarizeOn") || "true"),
      ignoreSmalltalk: JSON.parse(localStorage.getItem("auraX_ignoreSmalltalk") || "true"),
    };

    const LS_BM_KEY = "auraX_bmEvents_v4";

    function loadBM() {
      try {
        const raw = localStorage.getItem(LS_BM_KEY);
        state.bmEvents = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(state.bmEvents)) state.bmEvents = [];
      } catch (e) {
        state.bmEvents = [];
      }
    }
    function saveBM() {
      try {
        localStorage.setItem(LS_BM_KEY, JSON.stringify(state.bmEvents));
      } catch (e) {
        console.warn("BM save failed", e);
      }
    }
    loadBM();

    // ===========================
    // Utilities
    // ===========================
    function clamp01(x) { return Math.min(1, Math.max(0, x)); }
    function softTanh(x) {
      if (Math.tanh) return Math.tanh(x);
      const e2x = Math.exp(2 * x);
      return (e2x - 1) / (e2x + 1);
    }

    function estimateSentimentScalar(text) {
      if (!text || !text.trim()) return 0;
      const t = text.toLowerCase();
      const positives = [
        "thank","shukr","grateful","happy","relief","love","hope",
        "relaxed","calm","alhamdulillah","blessing","laugh","laughing"
      ];
      const negatives = [
        "hate","angry","gussa","sad","afraid","fear","alone",
        "useless","worthless","anxious","anxiety","panic","crying","bit me","bite"
      ];
      let pos = 0, neg = 0;
      positives.forEach(w => { if (t.includes(w)) pos++; });
      negatives.forEach(w => { if (t.includes(w)) neg++; });
      const score = pos - neg;
      if (score === 0) return 0;
      const capped = Math.max(-4, Math.min(4, score));
      return capped / 4;
    }

    function detectDamage(text) {
      if (!text) return 0;
      const t = text.toLowerCase();
      const harsh = ["fuck","lanat","bastard","hate you","i wish i die","kill myself","suicide"];
      let hits = 0;
      harsh.forEach(w => { if (t.includes(w)) hits++; });
      if (!hits) return 0;
      return clamp01(0.3 + hits * 0.15);
    }

    function isSmallTalk(text) {
      if (!text) return true;
      const t = text.trim().toLowerCase();
      if (!t) return true;
      if (t.length > 60) return false;
      const small = ["hi","hello","salam","assalam","how are you","thanks","thank you","ok"];
      return small.some(w => t === w || t.startsWith(w));
    }

    function computeBMScalar() {
      if (!state.bmEvents.length) return 0.11;
      let sum = 0, wsum = 0;
      const now = Date.now();
      state.bmEvents.forEach(ev => {
        const ageH = (now - ev.ts) / 3600000;
        const w = ageH < 1 ? 1 : ageH < 24 ? 0.8 : ageH < 72 ? 0.6 :
                  ageH < 24*14 ? 0.4 : 0.25;
        sum += (ev.E0 || 0) * w;
        wsum += w;
      });
      if (!wsum) return 0;
      const avg = sum / wsum;
      return clamp01(0.5 + avg / 2);
    }

    function computeContextSum() {
      const n = state.bmEvents.length;
      if (!n) return 0;
      const scaled = Math.log10(n + 1) / 4;
      return clamp01(scaled);
    }

    function faithLambda() {
      if (state.faithLens === "none") return 0;
      return 0.02;
    }

    // layer strengths (for colourful BM)
    function computeLayers(E0, intensity) {
      const I = Math.min(1, Math.max(0, Math.abs(intensity || E0 || 0)));
      const base = 40 + I * 40; // 40-80
      const multipliers = [0.9,0.6,0.45,0.9,1.0,0.7,0.35];
      const layers = multipliers.map(m => Math.round(base * m));
      return layers;
    }

    // ===========================
    // Core Emotional Reactor
    // ===========================
    function evaluateTM(tmText) {
      const baseSent = estimateSentimentScalar(tmText);
      const tm = clamp01(0.5 + baseSent / 2);
      const bm = computeBMScalar();
      const D = detectDamage(tmText);
      const lambdaSys = 0.02;
      const lambdaFaith = faithLambda();
      const context = computeContextSum();

      const raw = tm * bm - D + lambdaFaith + lambdaSys + context;
      const E0 = softTanh(raw);

      let polarity = "neutral";
      if (E0 > 0.15) polarity = "positive";
      else if (E0 < -0.15) polarity = "negative";

      const intensity = Math.abs(E0);

      return { TM: tm, BM: bm, D, lambdaFaith, lambdaSys, context, raw, E0, polarity, intensity };
    }

    function makeReactionText(tmText, evalResult) {
      const { polarity, intensity } = evalResult;
      const I = intensity;
      let tone;

      if (polarity === "positive") {
        tone = "Soft, stabilizing, hopeful resonance.";
      } else if (polarity === "negative") {
        if (I > 0.6) tone = "Heavy negative charge, like a storm of worry or anger.";
        else if (I > 0.3) tone = "Mild negative charge, like a faint worry or discomfort.";
        else tone = "Gentle negative leaning, but still open to healing.";
      } else {
        tone = "Calm, observant, analytically neutral reading.";
      }

      const txt = (tmText || "").trim();
      let body;

      // special seed stories ‚Äì lost child
      const lower = txt.toLowerCase();
      if (lower.includes("lost child") && lower.includes("crowded market")) {
        body =
          "This memory is soaked in love and connection. Emotionally it behaves like a warm anchor: when future storms come, revisiting such moments can quickly stabilize your E‚ÇÄ and remind you that you are not alone. These are exactly the BM nodes that protect a person in long-term emotional continuity.";
        return { tone, body };
      }
      // dog bite demo style
      if (lower.includes("dog bit me")) {
        body =
          "This memory carries fear and a sense of being unprotected. AURA-X Œ© is detecting a strong negative TM spike, but also a very old context. If you describe how you survived and what you learned from that day, the same memory can slowly shift from pure fear to a story of survival in your BM layers.";
        return { tone, body };
      }

      if (!txt) {
        body =
          "This is a neutral baseline reading. Type a real memory or feeling below. AURA-X Œ© will treat it as a TM event and fold it into your long-run BM life.";
      } else if (polarity === "positive") {
        body =
          "There is clear shukr / gratitude inside this TM. Even when life is heavy, noticing small blessings gently pulls E‚ÇÄ to the positive side. Keep bookmarking such moments ‚Äî they become strong, protective BM nodes for the future you.";
      } else if (polarity === "negative") {
        body =
          "I can feel a lot of anger, hurt or harsh inner language inside this TM event. AURA-X Œ© does not want to reinforce insults or curses, because they usually increase D (damage) in your emotional field. Try to describe what is really hurting or scaring you, without attacking yourself or anyone else.";
      } else {
        body =
          "E‚ÇÄ is currently near neutral. This means your TM event is balanced but still contributes to your long-run BM layers. You can move it gently toward hope by adding a small line of gratitude or a tiny next step you can actually take.";
      }

      if (polarity === "negative" && lower.includes("thank")) {
        body +=
          " Even inside this pain, I can see a spark of gratitude. That spark is already reducing D and protecting you against long-term burnout.";
      }

      return { tone, body };
    }

    function storeBM(tmText, evalResult) {
      const layers = computeLayers(evalResult.E0, evalResult.intensity);
      const entry = {
        ts: Date.now(),
        tm: tmText.slice(0, 600),
        E0: evalResult.E0,
        polarity: evalResult.polarity,
        intensity: evalResult.intensity,
        layers,
      };
      state.bmEvents.unshift(entry);
      if (state.bmEvents.length > 400) state.bmEvents.length = 400;
      saveBM();
    }

    // ===========================
    // DOM Wiring
    // ===========================
    const tmInput = document.getElementById("tmInput");
    const btnSend = document.getElementById("btnSend");
    const reactionPanel = document.getElementById("reactionPanel");
    const reactionMeta = document.getElementById("reactionMeta");
    const reactionTone = document.getElementById("reactionTone");
    const reactionBody = document.getElementById("reactionBody");
    const scalarFootnote = document.getElementById("scalarFootnote");
    const equationValues = document.getElementById("equationValues");
    const modePill = document.getElementById("modePill");
    const engineStatusText = document.getElementById("engineStatusText");

    const btnDemoNegative = document.getElementById("btnDemoNegative");
    const btnDemoPositive = document.getElementById("btnDemoPositive");

    const btnBmViewer = document.getElementById("btnBmViewer");
    const btnRecallBm = document.getElementById("btnRecallBm");
    const btnCleanup24h = document.getElementById("btnCleanup24h");
    const btnOptions = document.getElementById("btnOptions");

    const optionsOverlay = document.getElementById("optionsOverlay");
    const optionsClose = document.getElementById("optionsClose");
    const faithRow = document.getElementById("faithRow");
    const engineToggle = document.getElementById("engineToggle");
    const engineModeLabel = document.getElementById("engineModeLabel");
    const toggleSummarize = document.getElementById("toggleSummarize");
    const toggleIgnoreSmalltalk = document.getElementById("toggleIgnoreSmalltalk");
    const btnClear24hModal = document.getElementById("btnClear24hModal");
    const btnDeleteAllBm = document.getElementById("btnDeleteAllBm");

    const bmOverlay = document.getElementById("bmOverlay");
    const bmClose = document.getElementById("bmClose");
    const bmList = document.getElementById("bmList");
    const btnDeleteDay = document.getElementById("btnDeleteDay");

    function updateEngineUI() {
      if (state.engineLive) {
        engineToggle.classList.add("on");
        engineModeLabel.textContent = "Live emotional reactor (backend LLM).";
        modePill.innerHTML =
          "MODE: OFFLINE PROTOTYPE<span>Universal Ethics ¬∑ BM + Live LLM</span>";
        engineStatusText.textContent = "Engine: Backend LLM";
      } else {
        engineToggle.classList.remove("on");
        engineModeLabel.textContent = "Seed-only emotional reactor.";
        modePill.innerHTML =
          "MODE: OFFLINE PROTOTYPE<span>Universal Ethics ¬∑ BM + Seed Engine</span>";
        engineStatusText.textContent = "Engine: Seed (local)";
      }
    }

    function updateFaithUI() {
      const pills = faithRow.querySelectorAll(".faith-pill");
      pills.forEach(p => {
        if ((state.faithLens === "none" && p.dataset.faith === "none") ||
            p.dataset.faith === state.faithLens) {
          p.classList.add("active");
        } else {
          p.classList.remove("active");
        }
      });
    }

    function updatePrototypeToggles() {
      if (state.summarizeOn) toggleSummarize.classList.add("on");
      else toggleSummarize.classList.remove("on");
      if (state.ignoreSmalltalk) toggleIgnoreSmalltalk.classList.add("on");
      else toggleIgnoreSmalltalk.classList.remove("on");
    }

    updateEngineUI();
    updateFaithUI();
    updatePrototypeToggles();
    renderEquationValues({
      TM: 0,
      BM: computeBMScalar(),
      D: 0,
      lambdaFaith: faithLambda(),
      lambdaSys: 0.02,
      context: computeContextSum(),
      E0: 0,
    });

    function renderEquationValues(ev) {
      equationValues.textContent =
        "E‚ÇÄ = " + ev.E0.toFixed(2) +
        " ¬∑ TM = " + ev.TM.toFixed(2) +
        " ¬∑ BM = " + ev.BM.toFixed(2) +
        " ¬∑ D = " + ev.D.toFixed(2) +
        " ¬∑ Œ£C‚Çú = " + ev.context.toFixed(2) +
        " ¬∑ Œª_faith = " + ev.lambdaFaith.toFixed(2) +
        " ¬∑ Œª_sys = " + ev.lambdaSys.toFixed(2);
    }

    function setReactionCard(tmText, evalResult, reactionText) {
      const { polarity, intensity, E0, TM, BM, D, context, lambdaFaith, lambdaSys } = evalResult;

      reactionPanel.classList.remove("positive","negative","neutral");
      if (polarity === "positive") reactionPanel.classList.add("positive");
      else if (polarity === "negative") reactionPanel.classList.add("negative");
      else reactionPanel.classList.add("neutral");

      const polLabel =
        polarity === "positive" ? "Positive" :
        polarity === "negative" ? "Negative" : "Neutral / Mixed";
      reactionMeta.textContent =
        "Polarity: " + polLabel + " ¬∑ Intensity: " + intensity.toFixed(2);
      reactionTone.textContent = "Tone: " + reactionText.tone;
      reactionBody.textContent = reactionText.body;

      scalarFootnote.textContent =
        "E‚ÇÄ=" + E0.toFixed(2) +
        " ¬∑ TM=" + TM.toFixed(2) +
        " ¬∑ D=" + D.toFixed(2) +
        " ¬∑ tag=" + polarity;

      renderEquationValues({ TM,BM,D,context,lambdaFaith,lambdaSys,E0 });

      auraXVoice.autoSpeak(reactionText.body, polarity, intensity);
    }

    async function handleSend() {
      const text = tmInput.value || "";
      if (!text.trim()) {
        const ev = evaluateTM(text);
        const rt = makeReactionText(text, ev);
        setReactionCard(text, ev, rt);
        return;
      }

      if (state.ignoreSmalltalk && isSmallTalk(text)) {
        const ev = evaluateTM(text);
        const rt = {
          tone: "Light, friendly but emotionally shallow small-talk.",
          body:
            "Small greetings like this are nice, but they do not create strong BM nodes. When you want AURA-X Œ© to learn from you, share a concrete memory, fear, hope, or gratitude line instead.",
        };
        setReactionCard(text, ev, rt);
        return;
      }

      btnSend.disabled = true;
      btnSend.textContent = "Thinking‚Ä¶";

      try {
        const ev = evaluateTM(text);
        let rt = makeReactionText(text, ev);

        if (state.engineLive) {
          try {
            const backendReply = await callBackendReactor(text, ev);
            if (backendReply && backendReply.reaction) {
              rt = {
                tone: backendReply.tone || rt.tone,
                body: backendReply.reaction,
              };
            }
          } catch (e) {
            console.warn("Backend reactor error", e);
            rt.body +=
              " (Note: Live backend reactor was not reachable, so this reply is generated by the local seed engine.)";
          }
        }

        setReactionCard(text, ev, rt);
        storeBM(text, ev);
      } finally {
        btnSend.disabled = false;
        btnSend.textContent = "Send";
      }
    }

    btnSend.addEventListener("click", handleSend);
    tmInput.addEventListener("keydown", e => {
      if ((e.metaKey || e.ctrlKey) && e.key === "Enter") handleSend();
    });

    btnDemoNegative.addEventListener("click", () => {
      tmInput.value =
        "When I was a child in New York, a dog bit me in the snow near a street light. I still remember the cold wind, the barking sound, and my own fear.";
      handleSend();
    });
    btnDemoPositive.addEventListener("click", () => {
      tmInput.value =
        "A lost child was crying in a crowded market until he heard his mother‚Äôs voice. She ran to him, hugged him tightly, and they both started laughing with tears.";
      handleSend();
    });

    async function callBackendReactor(tmText, evalResult) {
      if (!BACKEND_URL) return null;
      const payload = {
        tm: tmText,
        scalars: {
          TM: evalResult.TM,
          BM: evalResult.BM,
          D: evalResult.D,
          lambdaFaith: evalResult.lambdaFaith,
          lambdaSys: evalResult.lambdaSys,
          context: evalResult.context,
          E0: evalResult.E0,
        },
        faith: state.faithLens,
      };

      const res = await fetch(BACKEND_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error("Backend status " + res.status);
      return await res.json();
    }

    // ===== Options modal =====
    btnOptions.addEventListener("click", () => { optionsOverlay.style.display = "flex"; });
    optionsClose.addEventListener("click", () => { optionsOverlay.style.display = "none"; });
    optionsOverlay.addEventListener("click", e => {
      if (e.target === optionsOverlay) optionsOverlay.style.display = "none";
    });

    faithRow.addEventListener("click", e => {
      const btn = e.target.closest(".faith-pill");
      if (!btn) return;
      const val = btn.dataset.faith;
      state.faithLens = val;
      localStorage.setItem("auraX_faithLens", val);
      updateFaithUI();
    });

    engineToggle.addEventListener("click", () => {
      state.engineLive = !state.engineLive;
      localStorage.setItem("auraX_engineLive", JSON.stringify(state.engineLive));
      updateEngineUI();
    });

    toggleSummarize.addEventListener("click", () => {
      state.summarizeOn = !state.summarizeOn;
      localStorage.setItem("auraX_summarizeOn", JSON.stringify(state.summarizeOn));
      updatePrototypeToggles();
    });

    toggleIgnoreSmalltalk.addEventListener("click", () => {
      state.ignoreSmalltalk = !state.ignoreSmalltalk;
      localStorage.setItem("auraX_ignoreSmalltalk", JSON.stringify(state.ignoreSmalltalk));
      updatePrototypeToggles();
    });

    function clear24h() {
      const cutoff = Date.now() - 24 * 3600000;
      state.bmEvents = state.bmEvents.filter(ev => ev.ts < cutoff);
      saveBM();
    }
    btnCleanup24h.addEventListener("click", () => { clear24h(); alert("Last 24 hours of BM events cleared locally."); });
    btnClear24hModal.addEventListener("click", () => { clear24h(); alert("Last 24 hours of BM events cleared locally."); });

    btnDeleteAllBm.addEventListener("click", () => {
      if (!confirm("Delete full local BM life (all days)?")) return;
      state.bmEvents = [];
      saveBM();
      alert("All local BM life deleted.");
    });

    // ===== BM Viewer + Recall =====
    function renderBmList() {
      bmList.innerHTML = "";
      if (!state.bmEvents.length) {
        const li = document.createElement("li");
        li.className = "bm-item";
        li.textContent =
          "No stored BM yet. Every serious emotional event you send will slowly grow here.";
        bmList.appendChild(li);
        return;
      }

      state.bmEvents.slice(0, 40).forEach(ev => {
        const li = document.createElement("li");
        li.className = "bm-item";

        const d = new Date(ev.ts);
        const pol =
          ev.polarity === "positive" ? "Positive" :
          ev.polarity === "negative" ? "Negative" : "Mixed / Neutral";

        const header = document.createElement("div");
        header.className = "bm-header";
        header.innerHTML =
          "<span>" +
          d.toLocaleDateString() +
          ", " +
          d.toLocaleTimeString() +
          "</span><span>¬∑ " +
          pol +
          "</span><span>¬∑ E‚ÇÄ=" +
          (ev.E0 || 0).toFixed(2) +
          "</span>";
        li.appendChild(header);

        const snip = document.createElement("div");
        snip.className = "bm-snippet";
        snip.textContent = ev.tm || "";
        li.appendChild(snip);

        const layers = ev.layers && ev.layers.length === 7
          ? ev.layers
          : computeLayers(ev.E0 || 0, ev.intensity || 0);

        const layerRow = document.createElement("div");
        layerRow.className = "bm-layer-row";
        layers.forEach((val, idx) => {
          const sp = document.createElement("span");
          sp.className = "layer-pill l" + (idx + 1);
          sp.textContent = "L" + (idx + 1) + ":" + val;
          layerRow.appendChild(sp);
        });
        li.appendChild(layerRow);

        const trig = document.createElement("div");
        trig.className = "bm-trigger";
        trig.textContent = "Triggers / text: " + (ev.tm || "");
        li.appendChild(trig);

        bmList.appendChild(li);
      });
    }

    btnBmViewer.addEventListener("click", () => {
      renderBmList();
      bmOverlay.style.display = "flex";
    });
    bmClose.addEventListener("click", () => { bmOverlay.style.display = "none"; });
    bmOverlay.addEventListener("click", e => {
      if (e.target === bmOverlay) bmOverlay.style.display = "none";
    });

    btnRecallBm.addEventListener("click", () => {
      if (!state.bmEvents.length) {
        alert("No stored BM yet. Share a few real memories first.");
        return;
      }
      const top = state.bmEvents[0];
      tmInput.value = top.tm || "";
      tmInput.focus();
    });

    // Delete today's BM only
    btnDeleteDay.addEventListener("click", () => {
      if (!state.bmEvents.length) return;
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = today.getMonth();
      const dd = today.getDate();
      state.bmEvents = state.bmEvents.filter(ev => {
        const d = new Date(ev.ts);
        return !(d.getFullYear() === yyyy && d.getMonth() === mm && d.getDate() === dd);
      });
      saveBM();
      renderBmList();
      alert("Today‚Äôs BM events deleted.");
    });

    // ===========================
    // Voice Emotional Reactor
    // ===========================
    const auraXVoice = (() => {
      const stateV = {
        enabled: JSON.parse(localStorage.getItem("auraX_voiceOn") || "true"),
        voices: { positive: null, negative: null },
        toggleBtn: null,
        voicesLoaded: false,
      };

      function initVoices() {
        if (!("speechSynthesis" in window)) return;
        const all = window.speechSynthesis.getVoices();
        if (!all || !all.length) {
          window.speechSynthesis.onvoiceschanged = () => {
            if (!stateV.voicesLoaded) initVoices();
          };
          return;
        }
        stateV.voices.positive =
          all.find(v => /male/i.test(v.name)) ||
          all.find(v => /en-GB|en-US/i.test(v.lang || v.name)) ||
          all[0];
        stateV.voices.negative =
          all.find(v => /female/i.test(v.name)) || all[1] || all[0];
        stateV.voicesLoaded = true;
      }

      function refreshToggleLabel() {
        if (!stateV.toggleBtn) return;
        stateV.toggleBtn.textContent = stateV.enabled ? "üîä Voice: On" : "üîá Voice: Off";
      }

      function init(opts = {}) {
        if (!("speechSynthesis" in window)) return;
        const id = opts.toggleId || "voiceToggle";
        stateV.toggleBtn = document.getElementById(id);
        if (stateV.toggleBtn) {
          refreshToggleLabel();
          stateV.toggleBtn.addEventListener("click", () => {
            stateV.enabled = !stateV.enabled;
            localStorage.setItem("auraX_voiceOn", JSON.stringify(stateV.enabled));
            if (!stateV.enabled && window.speechSynthesis) {
              window.speechSynthesis.cancel();
            }
            refreshToggleLabel();
          });
        }
        initVoices();
        if (!stateV.voicesLoaded) {
          window.speechSynthesis.onvoiceschanged = () => { initVoices(); };
        }
      }

      function autoSpeak(text, polarity, intensity) {
        if (!("speechSynthesis" in window)) return;
        if (!stateV.enabled) return;
        if (!text) return;

        const synth = window.speechSynthesis;
        synth.cancel();

        const u = new SpeechSynthesisUtterance(text);
        const I = Math.min(1, Math.max(0, Math.abs(intensity || 0)));

        u.rate = 1.0;
        u.pitch = 1.0;
        u.volume = 0.8;

        if (polarity === "positive") {
          u.voice = stateV.voices.positive || null;
          u.rate = 0.95 + I * 0.4;
          u.pitch = 1.05 + I * 0.2;
        } else if (polarity === "negative") {
          u.voice = stateV.voices.negative || null;
          u.rate = 0.85 + I * 0.2;
          u.pitch = 0.9 - I * 0.2;
        } else {
          u.voice = stateV.voices.positive || null;
        }
        u.volume = 0.6 + I * 0.4;
        synth.speak(u);
      }

      return { init, autoSpeak };
    })();

    document.addEventListener("DOMContentLoaded", () => {
      auraXVoice.init({ toggleId: "voiceToggle" });
    });
  </script>
</body>
</html>
