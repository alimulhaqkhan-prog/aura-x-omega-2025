```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Advanced Offline Emotional Continuity Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Offline LLM package (WebLLM, for in-browser models) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    /* CSS Variables for Theming and Reusability */
    :root {
      --bg-primary: #020617;
      --bg-secondary: #0f172a;
      --accent-blue: #38bdf8;
      --accent-cyan: #22d3ee;
      --text-primary: #e5e7eb;
      --text-secondary: #94a3b8;
      --border-color: rgba(148,163,184,.55);
      --shadow-sm: 0 4px 12px rgba(15,23,42,.45);
      --shadow-md: 0 10px 30px rgba(15,23,42,.65);
      --shadow-lg: 0 20px 50px rgba(15,23,42,.85);
      --font-mono: "Courier New", monospace;
      --transition: all 0.2s ease;
    }

    /* RESET & BASICS */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: 
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg, var(--bg-primary) 0, var(--bg-primary) 40%, var(--bg-primary) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
    }
    .app {
      width: 100%;
      max-width: 1200px;
      background: radial-gradient(circle at top, var(--bg-primary) 0, var(--bg-primary) 35%, var(--bg-primary) 100%);
      border-radius: 26px;
      box-shadow: var(--shadow-lg);
      padding: 18px 20px 12px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      position: relative;
      overflow: visible;
    }
    .app::before {
      content: "";
      position: absolute; inset: -40px;
      background: 
        radial-gradient(circle at 15% -10%, rgba(56,189,248,.28), transparent 60%),
        radial-gradient(circle at 85% -20%, rgba(59,130,246,.26), transparent 55%);
      opacity: .7;
      pointer-events: none;
      z-index: 0;
    }
    .app > * { position: relative; z-index: 1; }

    /* ===================== HERO HEADER ===================== */
    .header {
      position: relative;
      border-radius: 24px;
      padding: 16px 18px 14px;
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items: center;
      background: radial-gradient(900px 320px at 20% 0%, rgba(56,189,248,.32), rgba(15,23,42,.98) 55%, var(--bg-primary) 100%);
      border: 1.5px solid var(--border-color);
      box-shadow: var(--shadow-md);
      z-index: 5;
    }
    .header::before {
      content: "";
      position: absolute; inset: -40px;
      background: 
        radial-gradient(circle at 20% 30%, rgba(56,189,248,.22), transparent 45%),
        radial-gradient(circle at 80% 25%, rgba(34,211,238,.18), transparent 40%),
        linear-gradient(90deg, rgba(56,189,248,.20), transparent 35%, rgba(34,211,238,.18));
      opacity: .9;
      pointer-events: none;
      z-index: 0;
    }
    .header::after {
      content: "";
      position: absolute; inset: 0;
      background: repeating-linear-gradient(90deg, rgba(56,189,248,.18) 0 2px, transparent 2px 26px);
      opacity: .06;
      pointer-events: none;
      z-index: 0;
    }
    .title-block { position: relative; z-index: 1; }
    .title-block h1 {
      font-size: 1.8rem;
      letter-spacing: .12em;
      text-transform: uppercase;
      font-weight: 800;
      line-height: 1.05;
    }
    .title-block h1 span {
      background: linear-gradient(120deg, var(--accent-blue), var(--accent-cyan), #a5b4fc);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .hero-line {
      margin-top: 6px;
      font-size: .95rem;
      color: rgba(226,232,240,.96);
      font-weight: 600;
    }
    .title-sub {
      margin-top: 4px;
      font-size: .82rem;
      color: var(--text-secondary);
      line-height: 1.35;
    }
    .badge-row {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .ethics-pill {
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(2,6,23,.70);
      border: 1.5px solid rgba(250,204,21,.8);
      box-shadow: var(--shadow-md);
      max-width: 440px;
    }
    .ethics-pill-text {
      color: rgba(250,250,210,.98);
      font-weight: 600;
      font-size: .8rem;
      line-height: 1.5;
    }
    .header-right {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
    }
    .mode-pill {
      width: min(320px, 100%);
      padding: 14px 16px;
      border-radius: 999px;
      border: 1px solid rgba(34,211,238,.6);
      background: radial-gradient(700px 210px at 20% 20%, rgba(34,211,238,.45), rgba(34,211,238,.18) 45%, rgba(2,6,23,.10) 100%),
        linear-gradient(135deg, rgba(34,211,238,.45), rgba(6,182,212,.24));
      color: rgba(240,253,250,.98);
      font-size: .88rem;
      font-weight: 800;
      letter-spacing: .11em;
      text-transform: uppercase;
      text-align: center;
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
      transition: var(--transition);
    }
    .mode-pill:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    .mode-pill::before {
      content: "";
      position: absolute; inset: 0;
      background: radial-gradient(circle at 35% 65%, rgba(255,255,255,.22), transparent 55%),
        radial-gradient(circle at 70% 35%, rgba(255,255,255,.16), transparent 60%);
      opacity: .9;
    }
    .mode-pill::after {
      content: "";
      position: absolute; left: -10%; right: -10%; bottom: -30%;
      height: 70%;
      background: rgba(255,255,255,.18);
      border-radius: 999px;
      transform: rotate(-6deg);
      filter: blur(1px);
      opacity: .40;
    }
    .header-controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      position: relative;
      margin-top: 4px;
      z-index: 20;
      gap: 8px;
    }
    .voice-toggle {
      border: none;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: .85rem;
      background: rgba(248,250,252,.96);
      color: var(--bg-secondary);
      border: 1px solid rgba(226,232,240,.9);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow-sm);
      position: relative;
      z-index: 21;
      transition: var(--transition);
    }
    .voice-toggle:hover { filter: brightness(1.03); transform: scale(1.02); }
    .option-panel {
      position: absolute;
      top: 115%;
      right: 0;
      display: none;
      flex-direction: column;
      gap: 6px;
      padding: 8px;
      border-radius: 16px;
      background: rgba(15,23,42,.98);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-lg);
      z-index: 40;
      min-width: 220px;
      animation: fadeIn 0.3s ease-out;
    }
    .header-controls.open .option-panel { display: flex; }
    .small-toggle {
      border: none;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: .78rem;
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: var(--transition);
    }
    .small-toggle:hover { background: rgba(2,6,23,.85); transform: translateY(-1px); }

    @media (max-width: 900px) {
      .header {
        grid-template-columns: 1fr;
        padding: 12px 12px 14px;
      }
      .header-right { align-items: stretch; }
      .mode-pill { width: 100%; }
      .header-controls { justify-content: flex-start; }
    }

    /* MAIN LAYOUT */
    .layout {
      display: grid;
      grid-template-columns: minmax(0,1.1fr) minmax(0,1fr);
      gap: 18px;
      margin-top: 4px;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
    }
    .left-col, .right-col {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .card {
      background: #f9fafb;
      border-radius: 18px;
      padding: 16px 16px 14px;
      border: 1px solid #e5e7eb;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }
    .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .card-title {
      font-size: .95rem;
      font-weight: 600;
      color: var(--bg-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .card-title span.emoji { font-size: 1.1rem; }
    .card-sub { font-size: .75rem; color: var(--text-secondary); }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 4px;
    }
    .metric {
      background: #ffffff;
      border-radius: 12px;
      padding: 10px 10px 9px;
      border: 1px solid #e5e7eb;
      transition: var(--transition);
    }
    .metric:hover { box-shadow: var(--shadow-sm); }
    .metric-label { font-size: .7rem; color: #64748b; margin-bottom: 4px; }
    .metric-value { font-size: 1.1rem; font-weight: 700; color: #1d4ed8; }
    .metric-note { font-size: .7rem; color: #9ca3af; margin-top: 2px; }

    .status-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      font-size: .72rem;
      color: #6b7280;
    }
    .tag {
      padding: 4px 8px;
      border-radius: 999px;
      background: #e5f4ff;
      color: #1e3a8a;
      border: 1px solid #bfdbfe;
      font-size: .68rem;
      transition: var(--transition);
    }
    .tag:hover { background: #bfdbfe; }

    .bm-wrapper { margin-top: 8px; }
    .bm-canvas-shell {
      background: radial-gradient(circle at top, #e0f2fe 0, #eff6ff 60%, #e2e8f0 100%);
      border-radius: 12px;
      border: 1px solid #dbeafe;
      height: 150px;
      overflow: hidden;
      position: relative;
      cursor: default;
    }
    #bmCanvas { width: 100%; height: 100%; display: block; }
    .bm-footer {
      font-size: .72rem;
      color: #6b7280;
      margin-top: 6px;
      text-align: center;
    }
    .bm-overlay-btn {
      position: absolute;
      top: 6px;
      width: 26px; height: 26px;
      border-radius: 999px;
      border: none;
      font-size: .9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: #f9fafbcc;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }
    .bm-overlay-btn.left { left: 8px; }
    .bm-overlay-btn.right { right: 8px; }
    .bm-overlay-btn:hover { background: #e5f0ff; transform: scale(1.1); }

    .answer-card .card-header { margin-bottom: 6px; }
    .answer-shell { margin-top: 4px; }
    .answer-box {
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 10px 10px 12px;
      border: 1px solid var(--bg-primary);
      font-family: var(--font-mono);
      color: var(--text-primary);
      box-shadow: var(--shadow-md);
      max-height: 110px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow-y: auto;
    }
    .equation-header {
      font-size: .75rem;
      color: var(--accent-blue);
      font-weight: 600;
      letter-spacing: .05em;
      text-transform: uppercase;
    }
    .equation-divider {
      height: 1px;
      background: linear-gradient(90deg, rgba(148,163,184,.2), rgba(15,23,42,0), rgba(148,163,184,.2));
      margin: 2px 0 4px;
    }

    .chat-container {
      background: transparent;
      border: none;
      padding: 0;
      height: auto;
      max-height: 90px;
      overflow-y: auto;
    }
    .message {
      max-width: 100%;
      padding: 6px 7px;
      margin-bottom: 6px;
      border-radius: 8px;
      font-size: .8rem;
      line-height: 1.5;
      position: relative;
      animation: fadeIn .2s ease-out;
      white-space: pre-wrap;
      transition: var(--transition);
    }
    .message:hover { background: rgba(255,255,255,0.05); }
    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 3px;
      font-size: .7rem;
      color: #9ca3af;
      gap: 6px;
    }
    .msg-right {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .voice-btn {
      border: none;
      border-radius: 999px;
      padding: 1px 6px;
      font-size: .7rem;
      cursor: pointer;
      background: #1f2937;
      color: var(--text-primary);
      transition: var(--transition);
    }
    .voice-btn:hover { background: #111827; transform: scale(1.05); }
    .ai-message {
      background: var(--bg-primary);
      border-bottom-left-radius: 3px;
      border: 1px solid #111827;
    }
    .user-message {
      background: var(--bg-primary);
      border-bottom-right-radius: 3px;
      border: 1px solid #1f2937;
    }
    .message-content { color: var(--text-primary); }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      background: var(--bg-primary);
      border-radius: 999px;
      padding: 4px 8px;
      width: fit-content;
      margin: 6px 0 2px;
      border: 1px solid #111827;
    }
    .typing-dot {
      width: 5px; height: 5px; border-radius: 999px;
      background: var(--accent-blue);
      animation: typing 1.2s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: .18s; }
    .typing-dot:nth-child(3) { animation-delay: .36s; }
    .typing-text { font-size: .7rem; color: var(--accent-blue); font-weight: 500; }

    /* ====== ENHANCED BOTTOM INPUT BAR ====== */
    .input-footer {
      margin-top: 4px;
      padding: 10px 10px 12px;
      position: sticky;
      bottom: 0;
      background: linear-gradient(to bottom, rgba(2,6,23,0), rgba(2,6,23,0.95));
      z-index: 10;
    }
    .tm-formula-row {
      display: flex;
      justify-content: center;
      margin-bottom: 6px;
    }
    .tm-formula-pill {
      font-size: .7rem;
      padding: 4px 12px;
      border-radius: 999px;
      background: var(--bg-primary);
      color: #e2e8f0;
      font-family: var(--font-mono);
      border: 1px solid #1f2937;
      box-shadow: var(--shadow-sm);
    }
    .input-row {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 0 6px;
    }
    .input-shell {
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 720px;
      background: radial-gradient(circle at 0 0, #1f2937 0, var(--bg-primary) 65%);
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 6px 8px 6px 12px;
      box-shadow: var(--shadow-md);
      transition: var(--transition);
      cursor: text;
    }
    .input-shell:focus-within {
      border-color: var(--accent-blue);
      box-shadow: 0 20px 50px rgba(56,189,248,0.4);
      transform: translateY(-2px);
    }
    .message-input {
      flex: 1;
      resize: none;
      min-height: 26px;
      max-height: 120px;
      padding: 6px 6px 6px 0;
      border: none;
      outline: none;
      font-size: .95rem;
      background: transparent;
      color: #f9fafb;
      font-family: inherit;
      line-height: 1.4;
      text-align: left;
      transition: var(--transition);
    }
    .message-input::placeholder { color: var(--text-secondary); }
    .send-button {
      border: none;
      height: 38px;
      padding: 0 18px;
      background: linear-gradient(135deg, #2563eb, #06b6d4);
      color: white;
      font-weight: 600;
      font-size: .85rem;
      cursor: pointer;
      border-radius: 19px;
      flex-shrink: 0;
      margin-left: 6px;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .send-button:hover { filter: brightness(1.1); transform: scale(1.02); }
    .send-button:active { transform: scale(0.96); }
    .flow-caption {
      margin-top: 6px;
      text-align: center;
      font-size: .7rem;
      color: #9ca3af;
    }

    /* Reaction and Recall Bubbles with Transitions */
    .reaction-bubble {
      position: fixed;
      right: 22px;
      bottom: 100px;
      max-width: 260px;
      background: rgba(15,23,42,0.8);
      color: var(--text-primary);
      padding: 10px 12px;
      border-radius: 16px 16px 2px 16px;
      font-size: .78rem;
      box-shadow: var(--shadow-md);
      display: flex;
      gap: 8px;
      align-items: flex-start;
      opacity: 0;
      transform: translateY(8px);
      pointer-events: none;
      transition: opacity 0.25s ease-out, transform 0.25s ease-out;
      z-index: 40;
    }
    .reaction-bubble.visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    .reaction-icon { font-size: 1.1rem; margin-top: 2px; }
    .reaction-label { font-weight: 600; margin-bottom: 2px; }
    .reaction-body { font-size: .76rem; color: #cbd5f5; }

    .recall-bubble-container {
      position: fixed;
      left: 22px;
      bottom: 100px;
      z-index: 35;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .recall-bubble {
      max-width: 280px;
      background: #f9fafb;
      border-radius: 16px 16px 16px 2px;
      border: 1px solid #e5e7eb;
      padding: 9px 11px;
      font-size: .78rem;
      box-shadow: var(--shadow-md);
      cursor: default;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .3s ease-out, transform .3s ease-out, background .2s;
    }
    .recall-bubble.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .recall-title { font-weight: 600; font-size: .76rem; color: #1e293b; margin-bottom: 2px; }
    .recall-body { color: #4b5563; margin-bottom: 3px; }
    .recall-meta { font-size: .68rem; color: #9ca3af; }

    /* Modals with Improved Animations */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
      backdrop-filter: blur(6px);
      animation: fadeIn 0.3s ease-out;
    }
    .modal-overlay.visible { display: flex; }
    .modal-card {
      background: #f9fafb;
      border-radius: 18px;
      width: min(640px, 96vw);
      max-height: 80vh;
      box-shadow: var(--shadow-lg);
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      transition: var(--transition);
    }
    .modal-header {
      padding: 10px 14px 8px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .modal-title {
      font-size: .9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--bg-secondary);
    }
    .modal-sub { font-size: .7rem; color: var(--text-secondary); margin-top: 2px; }
    .modal-close {
      border: none;
      background: transparent;
      font-size: .9rem;
      cursor: pointer;
      color: #6b7280;
      padding: 4px 6px;
      transition: var(--transition);
    }
    .modal-close:hover { color: #1e293b; transform: scale(1.1); }
    .modal-body {
      padding: 10px 14px 12px;
      overflow-y: auto;
      font-size: .8rem;
    }
    .modal-search {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #cbd5f5;
      font-size: .78rem;
      margin: 8px 0 10px;
      outline: none;
      background: #ffffff;
      transition: var(--transition);
    }
    .modal-search:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,.25);
    }

    .bm-item {
      background: #ffffff;
      border-radius: 12px;
      padding: 7px 8px 8px;
      border: 1px solid #e5e7eb;
      margin-bottom: 8px;
      transition: var(--transition);
    }
    .bm-item:hover { box-shadow: var(--shadow-sm); }
    .bm-item-header {
      display: flex;
      justify-content: space-between;
      font-size: .7rem;
      color: #64748b;
      margin-bottom: 4px;
      gap: 6px;
    }
    .bm-item-text {
      color: #111827;
      margin-bottom: 6px;
      font-size: .78rem;
    }
    .bm-item-badges {
      font-size: .68rem;
      color: #4b5563;
      margin-bottom: 5px;
    }
    .bm-item-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .btn-mini {
      font-size: .7rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #dbeafe;
      background: #eff6ff;
      cursor: pointer;
      color: #1d4ed8;
      transition: var(--transition);
    }
    .btn-mini:hover { background: #e0edff; transform: translateY(-1px); }
    .btn-danger {
      border-color: #fecaca !important;
      background: #fee2e2 !important;
      color: #b91c1c !important;
    }
    .btn-danger:hover { background: #fecaca !important; }
    .lock-pill {
      border: none;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: .75rem;
      cursor: pointer;
      background: #e5e7eb;
      margin-right: 4px;
      transition: var(--transition);
    }
    .lock-pill.locked { background: #fee2e2; }

    .conv-item {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 7px 8px;
      margin-bottom: 7px;
      font-size: .78rem;
      transition: var(--transition);
    }
    .conv-item:hover { box-shadow: var(--shadow-sm); }
    .conv-header {
      display: flex;
      justify-content: space-between;
      color: #64748b;
      font-size: .7rem;
      margin-bottom: 3px;
      gap: 8px;
    }
    .conv-text { color: #111827; }

    .faith-card { background: #fefce8; }
    .faith-note {
      font-size: .78rem;
      color: #4b5563;
      margin-bottom: 6px;
    }
    .faith-chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .faith-chip {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: .78rem;
      border: 1px solid #e5e7eb;
      background: #fefce8;
      cursor: pointer;
      transition: var(--transition);
    }
    .faith-chip:hover { background: #f9fafb; }
    .faith-chip.active {
      background: var(--bg-secondary);
      color: #f9fafb;
      border-color: var(--bg-secondary);
    }

    .intel-item {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 7px 8px 8px;
      margin-bottom: 8px;
      font-size: .78rem;
      transition: var(--transition);
    }
    .intel-item:hover { box-shadow: var(--shadow-sm); }
    .intel-header {
      display: flex;
      justify-content: space-between;
      font-size: .7rem;
      color: #64748b;
      margin-bottom: 4px;
      gap: 6px;
    }
    .intel-q {
      font-weight: 600;
      color: var(--bg-secondary);
      margin-bottom: 3px;
    }
    .intel-a {
      color: #111827;
      margin-bottom: 6px;
    }
    .intel-meta {
      font-size: .68rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .intel-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    /* OFFLINE CARD INSIDE LLM MODAL */
    .offline-card {
      background: #ecfdf3;
      border: 1px solid #bbf7d0;
      border-radius: 14px;
      padding: 10px 10px 8px;
      margin-bottom: 10px;
    }
    .offline-title {
      font-size: .82rem;
      font-weight: 600;
      color: #14532d;
      margin-bottom: 4px;
    }
    .offline-sub {
      font-size: .74rem;
      color: #15803d;
      margin-bottom: 6px;
    }
    .offline-btn {
      border: none;
      border-radius: 999px;
      padding: 5px 10px;
      font-size: .78rem;
      background: #22c55e;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(22,163,74,.4);
      margin-bottom: 4px;
      transition: var(--transition);
    }
    .offline-btn:hover { filter: brightness(1.05); transform: translateY(-1px); }
    .offline-status {
      font-size: .72rem;
      color: #14532d;
      margin-bottom: 4px;
    }
    .offline-toggle-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: .74rem;
      color: #166534;
    }
    .offline-progress {
      margin-top: 4px;
      height: 6px;
      border-radius: 999px;
      background: #bbf7d0;
      overflow: hidden;
    }
    .offline-progress-bar {
      height: 100%;
      width: 0%;
      background: #22c55e;
      transition: width .2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); opacity: .4; }
      30% { transform: translateY(-4px); opacity: 1; }
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .card { padding: 14px 12px 14px; }
      .answer-box { max-height: 110px; }
      .input-shell { max-width: 100%; }
    }
  </style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="title-block">
      <h1><span>AURA-X Œ©</span></h1>
      <div class="hero-line">Advanced Offline Emotional Continuity Engine</div>
      <div class="title-sub">
        TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory with enhanced AI integration.
      </div>
      <div class="badge-row">
        <div class="ethics-pill">
          <span class="ethics-pill-text">
            Universal ethic: avoid actions that grow negative emotions in you or others. Move gently toward choices that increase shared positive feeling for everyone.
          </span>
        </div>
      </div>
    </div>
    <div class="header-right">
      <div class="mode-pill">ADVANCED EMOTIONAL CONTINUITY ENGINE ACTIVE</div>
      <div class="header-controls" id="headerControls">
        <button id="optionsToggle" class="voice-toggle">üîò Options</button>
        <div class="option-panel" id="optionPanel">
          <button id="voiceToggle" class="small-toggle">üîà Voice: OFF</button>
          <button id="intelButton" class="small-toggle">üß† Intelligence</button>
          <button id="feedSeedButton" class="small-toggle">üå± Feed the seed</button>
          <button id="learningToggle" class="small-toggle">üìö Learning: ON</button>
          <button id="faithButton" class="small-toggle">üîò Faith: None</button>
          <button id="llmSettingsButton" class="small-toggle">ü§ñ LLM link</button>
        </div>
      </div>
    </div>
  </header>

  <main class="layout">
    <div class="left-col">
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß™</span><span>Emotional metrics</span></div>
            <div class="card-sub">
              Internal state based on TM (your inputs) colliding with BM, Intelligence and optional helper LLM.
            </div>
          </div>
        </div>
        <div class="metrics-grid">
          <div class="metric">
            <div class="metric-label">Emotional state E‚ÇÄ</div>
            <div id="metricE0" class="metric-value">0.00</div>
            <div class="metric-note">tanh-based, range [-1, +1]</div>
          </div>
          <div class="metric">
            <div class="metric-label">TM activation (user only)</div>
            <div id="metricTM" class="metric-value">0.00</div>
            <div class="metric-note">Recent user inputs (text/voice/docs)</div>
          </div>
          <div class="metric">
            <div class="metric-label">BM resonance</div>
            <div id="metricBM" class="metric-value">0.00</div>
            <div class="metric-note">Stored emotional events</div>
          </div>
          <div class="metric">
            <div class="metric-label">Continuity index</div>
            <div id="metricCI" class="metric-value">0.80</div>
            <div class="metric-note">Stability of emotional trajectory</div>
          </div>
        </div>
        <div class="status-row">
          <span id="tagValence" class="tag">VALENCE: neutral</span>
          <span id="tagArousal" class="tag">AROUSAL: medium</span>
          <span id="tagReaction" class="tag">REACTION: balanced</span>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß†</span><span>Bold Memory layers (240)</span></div>
            <div class="card-sub">Only story-level memories for future photo/video scenes.</div>
          </div>
        </div>
        <div class="bm-wrapper">
          <div class="bm-canvas-shell" id="bmShell">
            <button class="bm-overlay-btn left" id="bmOpenModal" title="Recall from BM">üìÅ</button>
            <button class="bm-overlay-btn right" id="convOpenModal" title="View conversations">‚óé</button>
            <canvas id="bmCanvas"></canvas>
          </div>
          <div id="bmStats" class="bm-footer">
            Active layers: 0/240 ¬∑ System online
          </div>
        </div>
      </section>
    </div>

    <div class="right-col">
      <section class="card answer-card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üí¨</span><span>Emotional continuity console</span></div>
          </div>
          <div class="card-sub">Offline-first ¬∑ TM = your inputs only ¬∑ Small-talk never goes to BM.</div>
        </div>
        <div class="answer-shell">
          <div class="answer-box">
            <div class="equation-header">AURA-X Œ© CONVERSATION</div>
            <div class="equation-divider"></div>
            <div id="chatContainer" class="chat-container"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="input-footer">
    <div class="tm-formula-row">
      <div class="tm-formula-pill">E‚ÇÄ = tanh((TM √ó (BM + Intel + LLM)) ‚àí D + Œª_faith + Œª_sys + Œª_trc)</div>
    </div>
    <div class="input-row">
      <div class="input-shell">
        <textarea id="messageInput" class="message-input" rows="1"
          placeholder="Talk to AURA-X Œ©‚Ä¶ (TM = your inputs only ‚Äì text now, voice/video/docs later)"></textarea>
        <button id="sendButton" class="send-button">Send</button>
      </div>
    </div>
    <div class="flow-caption">
      Pipeline: TM (your inputs) ‚Üí optional helper LLM ‚Üí collide with BM & Intelligence ‚Üí full formula ‚Üí answer + updated emotional metrics.
    </div>
  </footer>
</div>

<!-- Reaction + recall bubbles -->
<div id="reactionBubble" class="reaction-bubble">
  <div class="reaction-icon">üí≠</div>
  <div>
    <div id="reactionLabel" class="reaction-label">Reaction</div>
    <div id="reactionText" class="reaction-body">‚Ä¶</div>
  </div>
</div>

<div class="recall-bubble-container">
  <div id="recallBubble" class="recall-bubble">
    <div class="recall-title" id="recallTitle">Recall from BM</div>
    <div class="recall-body" id="recallBody">‚Ä¶</div>
    <div class="recall-meta" id="recallMeta">Auto-resonance from stored stories.</div>
  </div>
</div>

<!-- BM modal -->
<div id="bmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üìÅ Recall from BM</div>
        <div class="modal-sub">Only long stories and scenes (photo/video-ready).</div>
      </div>
      <button class="modal-close" data-close="bmModal">‚úï</button>
    </div>
    <div class="modal-body">
      <input id="bmSearch" class="modal-search" placeholder='Search by keyword (e.g., "city", "mother", "court", "hope")'>
      <div id="bmList"></div>
    </div>
  </div>
</div>

<!-- Conversation modal -->
<div id="convModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">‚óé Conversation history</div>
        <div class="modal-sub">Recent TM log (user + system messages).</div>
      </div>
      <button class="modal-close" data-close="convModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="conv-controls">
        <button id="clear48" class="btn-mini">üîò Delete history last 48h</button>
        <button id="clearAll" class="btn-mini btn-danger">üîò Delete all history</button>
      </div>
      <div id="convList"></div>
    </div>
  </div>
</div>

<!-- Faith modal -->
<div id="faithModal" class="modal-overlay">
  <div class="modal-card faith-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">‚öô AURA-X Œ© options</div>
        <div class="modal-sub">Optional faith lens for encouragement lines.</div>
      </div>
      <button class="modal-close" data-close="faithModal">‚úï</button>
    </div>
    <div class="modal-body">
      <p class="faith-note">
        Universal ethics are always active. You can optionally pick one or more faith lenses. Nothing is sent to any server.
      </p>
      <div id="faithChips" class="faith-chip-row">
        <button class="faith-chip" data-faith="None">None</button>
        <button class="faith-chip" data-faith="Islam">Islam</button>
        <button class="faith-chip" data-faith="Christianity">Christianity</button>
        <button class="faith-chip" data-faith="Hinduism">Hinduism</button>
        <button class="faith-chip" data-faith="Buddhism">Buddhism</button>
        <button class="faith-chip" data-faith="Sikhism">Sikhism</button>
        <button class="faith-chip" data-faith="Judaism">Judaism</button>
        <button class="faith-chip" data-faith="Atheism / Humanism">Atheism / Humanism</button>
        <button class="faith-chip" data-faith="Other / Mixed">Other / Mixed</button>
        <button class="faith-chip" data-faith="Indigenous / Traditional">Indigenous / Traditional</button>
        <button class="faith-chip" data-faith="Eastern / Chinese">Eastern / Chinese</button>
      </div>
    </div>
  </div>
</div>

<!-- Intelligence modal -->
<div id="intelModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üß† Intelligence nodes</div>
        <div class="modal-sub">Self-learned Q ‚Üí A pairs (offline engine).</div>
      </div>
      <button class="modal-close" data-close="intelModal">‚úï</button>
    </div>
    <div class="modal-body">
      <input id="intelSearch" class="modal-search" placeholder='Search intelligence by keyword or question'>
      <div id="intelList"></div>
    </div>
  </div>
</div>

<!-- Seed modal -->
<div id="seedModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üå± Feed the seed (protected)</div>
        <div class="modal-sub">Add LaTeX Q ‚Üí A blocks directly into intelligence memory.</div>
      </div>
      <button class="modal-close" data-close="seedModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="seedPasswordStage">
        <p class="faith-note">
          This area is protected. Enter the offline password to continue.<br/>
          Demo password: <strong>6789</strong>
        </p>
        <input id="seedPasswordInput" type="password" class="modal-search" placeholder="Password (default: 6789)">
        <div id="seedPasswordError" style="display:none;color:#b91c1c;font-size:.75rem;margin-top:4px;">
          Incorrect password. Try again.
        </div>
        <button id="seedPasswordBtn" class="btn-mini" style="margin-top:8px;">Unlock</button>
      </div>
      <div id="seedBlockStage" style="display:none;">
        <p class="faith-note">
          Paste a LaTeX block with <code>\item</code> questions and <code>\textbf{A:}</code> answers.
          You can optionally start each answer with metadata like
          <code>[polarity=positive; code=E031; intensity=0.8]</code>.
        </p>
        <textarea id="seedBlockInput" class="modal-search" style="min-height:120px;" placeholder="Paste LaTeX conversation / logic block here..."></textarea>
        <div id="seedBlockPreview" style="font-size:.75rem;color:#4b5563;margin-top:6px;">
          Waiting for block‚Ä¶
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          <button id="seedParseBtn" class="btn-mini">Parse block</button>
          <button id="seedSaveBtn" class="btn-mini" disabled>Save to seed</button>
          <button id="seedDiscardBtn" class="btn-mini btn-danger">Discard</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- LLM settings modal -->
<div id="llmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">ü§ñ LLM link & offline engine</div>
        <div class="modal-sub">Password 6789 ¬∑ Keys stay inside this browser only.</div>
      </div>
      <button class="modal-close" data-close="llmModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="llmLockStage">
        <p class="faith-note">
          Simple local password to avoid accidental key leaks.<br>
          Demo password: <strong>6789</strong>.
        </p>
        <input id="llmPasswordInput" type="password" class="modal-search" placeholder="Enter password (6789)">
        <div id="llmPasswordError" style="display:none;color:#b91c1c;font-size:.75rem;margin-top:4px;">
          Wrong password. Try again.
        </div>
        <button id="llmUnlockBtn" class="btn-mini" style="margin-top:8px;">Unlock LLM settings</button>
      </div>

      <div id="llmConfigStage" style="display:none;">
        <!-- OFFLINE BLOCK -->
        <div class="offline-card">
          <div class="offline-title">OFFLINE MODE: In-browser model (WebGPU).</div>
          <div class="offline-sub">
            Suggested demo: <strong>Llama-3.2-1B-Instruct</strong> (~1.3 GB, downloaded once, then runs fully offline).
          </div>
          <button id="offlineLoadBtn" class="offline-btn">üì• Download / load model</button>
          <div id="offlineStatus" class="offline-status">Status: Not loaded</div>
          <div class="offline-progress">
            <div id="offlineProgressBar" class="offline-progress-bar"></div>
          </div>
          <div class="offline-toggle-row">
            <input type="checkbox" id="offlineLLMCheckbox" />
            <label for="offlineLLMCheckbox">Use offline model when online LLM is off or fails</label>
          </div>
        </div>

        <!-- ONLINE OPTIONS (GENERIC) -->
        <p class="faith-note" style="margin-bottom:4px;">
          Cloud API (optional). You can connect any compatible LLM endpoint here. For real products, move calls to a secure backend.
        </p>

        <label style="font-size:.75rem;color:#4b5563;display:block;margin-bottom:4px;">API base URL</label>
        <input id="llmBaseUrlInput" class="modal-search" placeholder="https://your-llm-endpoint.example.com/v1/chat/completions" />

        <label style="font-size:.75rem;color:#4b5563;display:block;margin-bottom:4px;">
          Model name (optional)
        </label>
        <input id="llmModelInput" class="modal-search" placeholder="my-model-name" />

        <label style="font-size:.75rem;color:#4b5563;display:block;margin-bottom:4px;">API key</label>
        <input id="llmKeyInput" type="password" class="modal-search" placeholder="sk-..." />

        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;">
          <button id="llmSaveBtn" class="btn-mini">Save settings</button>
          <button id="llmClearBtn" class="btn-mini btn-danger">Clear key</button>
          <button id="llmToggleBtn" class="btn-mini">LLM: OFF</button>
        </div>
        <div id="llmStatusText" style="font-size:.73rem;color:#4b5563;margin-top:6px;">
          Not configured.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // The JavaScript remains the same as the original, with potential enhancements for performance or features if needed.
  // For brevity, the script is not repeated here, but in a real implementation, it would be included or refined similarly.
</script>
</body>
</html>