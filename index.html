<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Ω – Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Optional: offline LLM library (for future use) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    /* ----------------- RESET & LAYOUT ----------------- */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#e0f2ff 0,#f5f7fb 40%,#eef1f7 100%);
      color:#0f172a;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:20px;
    }
    .app{
      width:100%;
      max-width:1120px;
      background:#ffffffee;
      border-radius:24px;
      box-shadow:0 24px 60px rgba(15,23,42,.12);
      padding:20px 20px 24px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    /* ----------------- TOP BAR ----------------- */
    .top-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-orb{
      width:38px;height:38px;
      border-radius:999px;
      background:conic-gradient(from 210deg,#0ea5e9,#6366f1,#a855f7,#f97316,#0ea5e9);
      position:relative;
      box-shadow:0 10px 25px rgba(15,23,42,.35);
    }
    .logo-orb::after{
      content:"";
      position:absolute;
      inset:5px;
      border-radius:inherit;
      background:radial-gradient(circle at 30% 20%,#ffffffaa 0,#e5e7eb33 45%,#02061799 100%);
    }
    .brand-title{
      font-size:1rem;
      font-weight:600;
      letter-spacing:.02em;
    }
    .brand-subtitle{
      font-size:.78rem;
      color:#6b7280;
    }

    .controls{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill-btn{
      border-radius:999px;
      border:none;
      padding:6px 14px;
      font-size:.78rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
      transition:background .15s ease,box-shadow .15s ease,transform .08s ease,color .15s ease;
    }
    .pill-btn:active{
      transform:translateY(1px);
      box-shadow:none;
    }
    .pill-soft{
      background:#eef2ff;
      color:#4338ca;
      box-shadow:0 6px 12px rgba(79,70,229,.18);
    }
    .pill-soft:hover{background:#e0e7ff;}
    .pill-ghost{
      background:transparent;
      color:#6b7280;
      border:1px solid #e5e7eb;
    }
    .pill-ghost:hover{background:#f9fafb;}

    .pill-badge{
      font-size:.7rem;
      padding:3px 8px;
      border-radius:999px;
      background:#e5e7eb;
      color:#374151;
    }
    .pill-muted{
      background:#f3f4f6;
      color:#6b7280;
    }

    /* Active state for toggles */
    .pill-active{
      background:#e0f2fe !important;
      color:#0369a1 !important;
      box-shadow:0 0 0 1px rgba(56,189,248,.5);
    }

    /* ----------------- ETHICS BANNER ----------------- */
    .ethics-banner{
      margin-top:4px;
      padding:8px 12px;
      border-radius:999px;
      background:linear-gradient(90deg,#fefce8,#fffbeb);
      border:1px solid #facc15;
      display:flex;
      gap:6px;
      align-items:center;
      font-size:.78rem;
    }
    .ethics-label{
      font-weight:600;
      color:#b8860b; /* golden-ish */
    }
    .ethics-text{
      color:#92400e;
    }

    /* ----------------- MAIN LAYOUT ----------------- */
    .layout{
      display:flex;
      gap:16px;
      margin-top:10px;
      align-items:flex-start;
    }
    @media(max-width:900px){
      .layout{flex-direction:column;}
    }
    .conversation-panel{
      flex:1.1;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .reactor-panel{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .card{
      background:#f9fafb;
      border-radius:18px;
      padding:14px 14px 16px;
      border:1px solid #e5e7eb;
      box-shadow:0 10px 30px rgba(15,23,42,.04);
      transition:box-shadow .2s ease,border-color .2s ease;
    }
    .card-title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }
    .card-title{
      font-size:.9rem;
      font-weight:600;
      letter-spacing:.02em;
    }

    /* Highlight when Options button focuses LLM card */
    .card-highlight{
      box-shadow:0 0 0 1px rgba(129,140,248,.9),0 0 0 4px rgba(199,210,254,.9);
      border-color:#4f46e5;
    }

    /* ----------------- CHAT / TM ----------------- */
    .chat-card{
      min-height:320px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .chat-log{
      flex:1;
      border-radius:12px;
      background:#ffffff;
      border:1px solid #e5e7eb;
      padding:10px;
      overflow-y:auto;
      max-height:420px;
    }
    .msg{
      margin-bottom:8px;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .msg-meta{
      font-size:.7rem;
      color:#9ca3af;
    }
    .msg-text{
      display:inline-block;
      padding:8px 11px;
      border-radius:12px;
      font-size:.82rem;
      line-height:1.35;
      max-width:100%;
      white-space:pre-wrap;
    }
    .msg.user .msg-text{
      background:#e0f2fe;
      align-self:flex-end;
    }
    .msg.aura .msg-text{
      background:#f5f3ff;
      align-self:flex-start;
    }

    .message-form{
      display:flex;
      gap:8px;
      align-items:flex-end;
      margin-top:4px;
    }
    .message-input{
      flex:1;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#ffffff;
      padding:8px 14px;
      font-size:.82rem;
      resize:none;
      outline:none;
    }
    .message-input::placeholder{
      color:#9ca3af;
    }
    .send-btn{
      border-radius:999px;
      border:none;
      padding:8px 16px;
      font-size:.82rem;
      font-weight:500;
      background:#0f766e;
      color:#ecfeff;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(15,118,110,.32);
      transition:background .15s ease,transform .08s ease,box-shadow .1s ease;
      white-space:nowrap;
    }
    .send-btn:hover{background:#115e59;}
    .send-btn:active{
      transform:translateY(1px);
      box-shadow:none;
    }

    .bm-summary{
      font-size:.8rem;
      color:#4b5563;
      line-height:1.4;
    }

    /* ----------------- FORMULA CARD ----------------- */
    .formula-card{
      position:relative;
      overflow:hidden;
    }
    .formula-card::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at top,#e5e7eb 0,transparent 55%);
      opacity:.6;
      pointer-events:none;
    }
    .formula-main{
      position:relative;
      font-family:ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:.88rem;
      margin-bottom:6px;
    }
    .formula-sub{
      position:relative;
      font-size:.72rem;
      color:#6b7280;
      margin-bottom:10px;
    }
    .formula-grid{
      position:relative;
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
      margin-bottom:8px;
    }
    .field-group{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .field-label{
      font-size:.72rem;
      color:#6b7280;
    }
    .field-input{
      border-radius:999px;
      border:1px solid #e5e7eb;
      padding:5px 10px;
      font-size:.78rem;
      background:#ffffffcc;
      outline:none;
    }
    .field-input:focus{
      border-color:#6366f1;
      box-shadow:0 0 0 1px rgba(129,140,248,.4);
    }
    .formula-output{
      position:relative;
      font-size:.8rem;
      margin-top:2px;
      padding-top:4px;
      border-top:1px dashed #e5e7eb;
    }

    /* ----------------- METRICS CARD ----------------- */
    .metrics-card{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .metric-row{
      display:grid;
      grid-template-columns:80px 40px 1fr;
      align-items:center;
      gap:6px;
      font-size:.75rem;
    }
    .metric-label{
      color:#6b7280;
    }
    .metric-value{
      text-align:right;
      font-variant-numeric:tabular-nums;
    }
    .meter{
      width:100%;
      height:6px;
      border-radius:999px;
      background:#e5e7eb;
      overflow:hidden;
    }
    .meter-fill{
      height:100%;
      width:0%;
      border-radius:inherit;
      background:linear-gradient(90deg,#22c55e,#a3e635);
      transition:width .18s ease-out;
    }
    .meter-fill.bm{
      background:linear-gradient(90deg,#f97316,#fb7185);
    }
    .meter-fill.intensity{
      background:linear-gradient(90deg,#38bdf8,#6366f1);
    }
    .metric-caption{
      font-size:.72rem;
      color:#6b7280;
      margin-top:4px;
    }

    /* ----------------- LLM CARD ----------------- */
    .llm-card{
      font-size:.78rem;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .llm-hint{
      font-size:.7rem;
      color:#9ca3af;
      margin-top:2px;
    }
  </style>
</head>
<body>
<div class="app">
  <!-- TOP BAR -->
  <header class="top-bar">
    <div class="brand">
      <div class="logo-orb"></div>
      <div>
        <div class="brand-title">AURA-X Ω · Emotional Continuity</div>
        <div class="brand-subtitle">Artificial Unified Resonance Architecture</div>
      </div>
    </div>
    <div class="controls">
      <button type="button" id="faithBtn" class="pill-btn pill-soft">Faith lens</button>
      <button type="button" id="filterBtn" class="pill-btn pill-soft">Small-talk filter</button>
      <button type="button" id="optionsBtn" class="pill-btn pill-ghost">Options</button>
    </div>
  </header>

  <!-- UNIVERSAL ETHICS -->
  <div class="ethics-banner">
    <span class="ethics-label">Universal Ethics:</span>
    <span class="ethics-text">
      Avoid actions that create negative emotions in you or others, and gently move toward what creates shared positivity.
    </span>
  </div>

  <!-- MAIN LAYOUT -->
  <main class="layout">
    <!-- LEFT: TM / CONVERSATION -->
    <section class="conversation-panel">
      <div class="card chat-card">
        <div class="card-title-row">
          <h3 class="card-title">TM – Conversation Window</h3>
          <span class="pill-badge">TM = user input + LLM answer</span>
        </div>
        <div id="chatLog" class="chat-log">
          <div class="msg aura">
            <div class="msg-meta">AURA-X Ω</div>
            <div class="msg-text">
Welcome to the AURA-X Ω offline prototype.
I will read each TM input, analyse its polarity & intensity, and update our continuity state E₀.
            </div>
          </div>
        </div>
        <form id="messageForm" class="message-form">
          <textarea
            id="tmInput"
            class="message-input"
            rows="2"
            placeholder="Type your TM input here…"
          ></textarea>
          <button type="submit" class="send-btn">Send</button>
        </form>
      </div>

      <div class="card">
        <div class="card-title-row">
          <h3 class="card-title">BM Episode Digest (today)</h3>
        </div>
        <p id="bmSummary" class="bm-summary">
          No episodes yet — start talking and I will begin forming a continuity trace in BM.
        </p>
      </div>
    </section>

    <!-- RIGHT: EMOTIONAL REACTOR / EQUATION / LLM -->
    <section class="reactor-panel">
      <!-- GRAND EQUATION -->
      <div class="card formula-card">
        <div class="card-title-row">
          <h3 class="card-title">Grand Emotional Continuity Equation</h3>
        </div>
        <div class="formula-main">
          E₀ = tanh((TM × BM) − D + λ<sub>faith</sub> + λ<sub>sys</sub> + λ<sub>trc</sub>)
        </div>
        <p class="formula-sub">
          TM = conversation window (user input + LLM answer),&nbsp;
          BM = bold memory continuity layer,&nbsp;
          D = disruption / fatigue,&nbsp;
          λ terms = faith, system, and truth-resonance corrections.
        </p>

        <div class="formula-grid">
          <div class="field-group">
            <label for="lambdaFaith" class="field-label">λ<sub>faith</sub></label>
            <input id="lambdaFaith" class="field-input" type="number" step="0.1" value="0.0" />
          </div>
          <div class="field-group">
            <label for="lambdaSys" class="field-label">λ<sub>sys</sub></label>
            <input id="lambdaSys" class="field-input" type="number" step="0.1" value="0.0" />
          </div>
          <div class="field-group">
            <label for="lambdaTrc" class="field-label">λ<sub>trc</sub></label>
            <input id="lambdaTrc" class="field-input" type="number" step="0.1" value="0.0" />
          </div>
          <div class="field-group">
            <label for="dFatigue" class="field-label">D (disruption)</label>
            <input id="dFatigue" class="field-input" type="number" step="0.1" value="0.2" />
          </div>
        </div>

        <div class="formula-output">
          <span>E₀ (continuity level): </span>
          <strong id="e0Value">0.00</strong>
        </div>
      </div>

      <!-- EMOTIONAL METRICS -->
      <div class="card metrics-card">
        <div class="card-title-row">
          <h3 class="card-title">Emotional Metrics (per TM input)</h3>
        </div>

        <div class="metric-row">
          <span class="metric-label">TM polarity</span>
          <span id="tmPolarityText" class="metric-value">0.00</span>
          <div class="meter"><div id="tmPolarityBar" class="meter-fill"></div></div>
        </div>

        <div class="metric-row">
          <span class="metric-label">BM polarity</span>
          <span id="bmPolarityText" class="metric-value">0.00</span>
          <div class="meter"><div id="bmPolarityBar" class="meter-fill bm"></div></div>
        </div>

        <div class="metric-row">
          <span class="metric-label">Intensity</span>
          <span id="intensityText" class="metric-value">0.00</span>
          <div class="meter"><div id="intensityBar" class="meter-fill intensity"></div></div>
        </div>

        <div class="metric-row">
          <span class="metric-label">E₀</span>
          <span id="continuityText" class="metric-value">0.00</span>
          <div class="meter"><div class="meter-fill" id="e0Bar"></div></div>
        </div>

        <p id="categoryText" class="metric-caption">
          Category: neutral
        </p>
      </div>

      <!-- LLM CONFIG -->
      <div id="llmCard" class="card llm-card">
        <div class="card-title-row">
          <h3 class="card-title">LLM Engine (optional)</h3>
          <span id="llmStatus" class="pill-badge pill-muted">
            Offline heuristics only
          </span>
        </div>

        <label for="providerSelect" class="field-label">Provider</label>
        <select id="providerSelect" class="field-input">
          <option value="">None (offline only)</option>
          <option value="offline">Offline micro-engine</option>
          <option value="openai">OpenAI (custom)</option>
          <option value="xai">xAI (custom)</option>
          <option value="deepseek">DeepSeek (custom)</option>
        </select>

        <label for="apiBase" class="field-label">API base URL (optional)</label>
        <input
          id="apiBase"
          class="field-input"
          type="text"
          placeholder="e.g. your proxy URL or custom endpoint"
        />

        <label for="apiModel" class="field-label">Model name (optional)</label>
        <input
          id="apiModel"
          class="field-input"
          type="text"
          placeholder="You will fill this yourself (no default here)"
        />

        <p class="llm-hint">
          This prototype already works fully offline using a simple emotional micro-engine
          for polarity &amp; intensity. If you want real LLM replies (OpenAI / xAI / DeepSeek),
          attach your own backend/API — the UI is ready but all model names are intentionally left blank.
        </p>
      </div>
    </section>
  </main>
</div>

<script>
(function(){
  const chatLog          = document.getElementById('chatLog');
  const messageForm      = document.getElementById('messageForm');
  const tmInput          = document.getElementById('tmInput');

  const tmPolarityText   = document.getElementById('tmPolarityText');
  const bmPolarityText   = document.getElementById('bmPolarityText');
  const intensityText    = document.getElementById('intensityText');
  const continuityText   = document.getElementById('continuityText');
  const categoryText     = document.getElementById('categoryText');

  const tmPolarityBar    = document.getElementById('tmPolarityBar');
  const bmPolarityBar    = document.getElementById('bmPolarityBar');
  const intensityBar     = document.getElementById('intensityBar');
  const e0Bar            = document.getElementById('e0Bar');
  const e0Value          = document.getElementById('e0Value');
  const bmSummary        = document.getElementById('bmSummary');

  const lambdaFaithInput = document.getElementById('lambdaFaith');
  const lambdaSysInput   = document.getElementById('lambdaSys');
  const lambdaTrcInput   = document.getElementById('lambdaTrc');
  const dFatigueInput    = document.getElementById('dFatigue');

  const providerSelect   = document.getElementById('providerSelect');
  const llmStatus        = document.getElementById('llmStatus');

  const faithBtn         = document.getElementById('faithBtn');
  const filterBtn        = document.getElementById('filterBtn');
  const optionsBtn       = document.getElementById('optionsBtn');
  const llmCard          = document.getElementById('llmCard');
  const ethicsText       = document.querySelector('.ethics-text');

  let bmState = {
    polarity: 0,
    intensity: 0,
    count: 0
  };

  let faithOn  = false;
  let filterOn = false;

  /* --------- TOP BUTTONS BEHAVIOUR --------- */
  faithBtn.addEventListener('click', () => {
    faithOn = !faithOn;
    faithBtn.classList.toggle('pill-active', faithOn);
    faithBtn.textContent = faithOn ? 'Faith lens: On' : 'Faith lens';
    updateEthicsLine();
  });

  filterBtn.addEventListener('click', () => {
    filterOn = !filterOn;
    filterBtn.classList.toggle('pill-active', filterOn);
    filterBtn.textContent = filterOn ? 'Small-talk filter: On' : 'Small-talk filter';
    updateEthicsLine();
  });

  optionsBtn.addEventListener('click', () => {
    if (!llmCard) return;
    llmCard.scrollIntoView({behavior:'smooth', block:'start'});
    llmCard.classList.add('card-highlight');
    setTimeout(() => llmCard.classList.remove('card-highlight'), 1200);
  });

  function updateEthicsLine(){
    let base =
      'Avoid actions that create negative emotions in you or others, ' +
      'and gently move toward what creates shared positivity.';
    if (faithOn && filterOn) {
      base += ' · Faith lens active · Small-talk filter active.';
    } else if (faithOn) {
      base += ' · Faith lens is gently active.';
    } else if (filterOn) {
      base += ' · Small-talk filter is active (casual noise reduced).';
    }
    if (ethicsText) ethicsText.textContent = base;
  }

  /* --------- LLM PROVIDER STATUS --------- */
  providerSelect.addEventListener('change', () => {
    const v = providerSelect.value;
    if (!v) {
      llmStatus.textContent = 'Offline heuristics only';
    } else if (v === 'offline') {
      llmStatus.textContent = 'Using local micro-engine (no internet)';
    } else {
      llmStatus.textContent = 'Needs your custom backend / API key';
    }
  });

  /* --------- MAIN MESSAGE HANDLER --------- */
  messageForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = (tmInput.value || '').trim();
    if (!text) return;

    tmInput.value = '';
    appendMessage('user', text);

    // 1) Analyse TM emotionally (offline micro-engine)
    const analysis = analyseEmotion(text);

    // 2) Update BM continuity state
    updateBM(analysis);

    // 3) Recompute E0 from equation
    const e0 = recomputeE0(analysis);

    // 4) Render everything in UI
    renderMetrics(analysis, e0);

    // 5) Generate AURA-X Ω style reply (offline template)
    const reply = await generateAuraReply(text, analysis, e0);
    appendMessage('aura', reply);
  });

  function appendMessage(role, text){
    const msg = document.createElement('div');
    msg.className = 'msg ' + (role === 'user' ? 'user' : 'aura');

    const meta = document.createElement('div');
    meta.className = 'msg-meta';
    meta.textContent = role === 'user' ? 'You' : 'AURA-X Ω';

    const body = document.createElement('div');
    body.className = 'msg-text';
    body.textContent = text;

    msg.appendChild(meta);
    msg.appendChild(body);
    chatLog.appendChild(msg);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  /* --------- EMOTIONAL MICRO-ENGINE --------- */
  function analyseEmotion(text){
    const lower = text.toLowerCase();

    const positiveWords = [
      'happy','good','great','alhamdulillah','grateful','excited',
      'hope','love','shukr','fine','peace','calm','greatful'
    ];
    const negativeWords = [
      'sad','angry','upset','tired','hurt','fear','anxious',
      'depressed','frustrated','stress','worried','pain'
    ];

    let score = 0;
    positiveWords.forEach(w => { if (lower.includes(w)) score += 1; });
    negativeWords.forEach(w => { if (lower.includes(w)) score -= 1; });

    const polarity = Math.max(-1, Math.min(1, score / 5));
    const intensity = Math.min(1, Math.max(0.15, Math.abs(score) / 5));

    let category = 'neutral';
    if (polarity > 0.2) {
      category = intensity > 0.6 ? 'joy / excitement' : 'hope / gentle positivity';
    } else if (polarity < -0.2) {
      category = intensity > 0.6 ? 'anger / fear' : 'sadness / worry';
    }

    return {
      polarity,
      intensity,
      category,
      rawScore: score
    };
  }

  function updateBM(analysis){
    bmState.count += 1;
    const n = bmState.count;

    bmState.polarity  = ((bmState.polarity  * (n - 1)) + analysis.polarity)  / n;
    bmState.intensity = ((bmState.intensity * (n - 1)) + analysis.intensity) / n;

    bmSummary.textContent = describeBM();
  }

  function describeBM(){
    if (bmState.count === 0) {
      return 'No episodes yet — BM is waiting for the first meaningful event.';
    }
    const tone =
      bmState.polarity >  0.2 ? 'leaning positive' :
      bmState.polarity < -0.2 ? 'leaning negative' :
                                'balanced';
    const energy =
      bmState.intensity > 0.6 ? 'high energy' :
      bmState.intensity < 0.3 ? 'soft / low energy' :
                                'medium energy';
    return `BM has ${bmState.count} emotional episodes stored, currently ${tone} with ${energy}.`;
  }

  function recomputeE0(analysis){
    const tmPol = analysis.polarity;
    const bmPol = bmState.polarity || 0;

    const D  = parseFloat(dFatigueInput.value || '0') || 0;
    const lf = parseFloat(lambdaFaithInput.value || '0') || 0;
    const ls = parseFloat(lambdaSysInput.value   || '0') || 0;
    const lt = parseFloat(lambdaTrcInput.value   || '0') || 0;

    const x = (tmPol * bmPol) - D + lf + ls + lt;
    const e0 = Math.tanh(x);

    e0Value.textContent = e0.toFixed(2);
    return e0;
  }

  function renderMetrics(analysis, e0){
    const tmPol = analysis.polarity;
    const bmPol = bmState.polarity || 0;
    const intensity = analysis.intensity;

    tmPolarityText.textContent = tmPol.toFixed(2);
    bmPolarityText.textContent = bmPol.toFixed(2);
    intensityText.textContent  = intensity.toFixed(2);
    continuityText.textContent = e0.toFixed(2);
    categoryText.textContent   = 'Category: ' + analysis.category;

    setMeter(tmPolarityBar, (tmPol + 1) / 2);
    setMeter(bmPolarityBar, (bmPol + 1) / 2);
    setMeter(intensityBar, intensity);
    setMeter(e0Bar, (e0 + 1) / 2);
  }

  function setMeter(el, value){
    const v = Math.max(0, Math.min(1, value || 0));
    el.style.width = (v * 100).toFixed(0) + '%';
  }

  async function generateAuraReply(text, analysis, e0){
    const provider = providerSelect.value;

    const polarityWord =
      analysis.polarity >  0.2 ? 'gently positive' :
      analysis.polarity < -0.2 ? 'slightly heavy' :
                                 'quite balanced / neutral';

    const continuityWord =
      e0 > 0.6 ? 'strong and coherent' :
      e0 > 0.2 ? 'present but delicate' :
                 'weak, so I will stay extra gentle';

    let base =
      `I heard you say:\n“${text}”\n\n` +
      `Emotionally it feels ${polarityWord} with a ${analysis.category} tone.\n` +
      `Your continuity level E₀ is around ${e0.toFixed(2)}, ` +
      `which means the emotional thread is ${continuityWord}.\n\n` +
      `I will respond in a way that avoids actions that create negative emotions ` +
      `in you or others, and gently move toward what creates shared positivity.`;

    if (!provider || provider === 'offline') {
      return base + `\n\n(Mode: offline emotional micro-engine, no external LLM needed.)`;
    } else {
      return base +
        `\n\n(LLM provider “${provider}” is selected. ` +
        `This prototype expects your own backend / API key; all model names are intentionally left blank.)`;
    }
  }

  // Initial render
  renderMetrics({polarity:0,intensity:0,category:'neutral'},0);
  updateEthicsLine();

})();
</script>
</body>
</html>