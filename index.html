<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:20px;
    }
    .app{
      width:100%;
      max-width:1100px;
      background:#020617;
      border-radius:26px;
      box-shadow:
        0 26px 80px rgba(15,23,42,.85),
        0 0 0 1px rgba(148,163,184,.45);
      padding:18px 20px 12px;
      display:flex;
      flex-direction:column;
      gap:16px;
      position: relative;
    }

    /* HEADER */
    .header{
      position: relative;
      border-radius: 24px;
      padding: 16px 18px 14px;
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items: center;
      background:
        radial-gradient(900px 320px at 20% 0%, rgba(56,189,248,.32), rgba(15,23,42,.98) 55%, #020617 100%);
      border: 1.5px solid rgba(148,163,184,.55);
      box-shadow:
        0 26px 70px rgba(15,23,42,.9),
        inset 0 1px 0 rgba(255,255,255,.08);
      z-index:5;
    }
    .title-block h1{
      font-size: 1.7rem;
      letter-spacing: .10em;
      text-transform: uppercase;
      font-weight: 800;
      line-height: 1.05;
    }
    .title-block h1 span{
      background: linear-gradient(120deg,#38bdf8,#22d3ee,#a5b4fc);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .hero-line{
      margin-top: 6px;
      font-size: .9rem;
      color: rgba(226,232,240,.96);
      font-weight: 600;
    }
    .title-sub{
      margin-top: 4px;
      font-size: .8rem;
      color: rgba(148,163,184,.98);
      line-height: 1.35;
    }
    .ethics-pill{
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(2,6,23,.70);
      border: 1.5px solid rgba(250,204,21,.8);
      box-shadow:
        0 18px 40px rgba(15,23,42,.85),
        0 0 0 1px rgba(251,191,36,.35);
      max-width: 440px;
      margin-top:10px;
    }
    .ethics-pill-text{
      color: rgba(250,250,210,.98);
      font-weight: 600;
      font-size: .8rem;
      line-height: 1.5;
    }

    .header-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:10px;
      position:relative;
      z-index:10;
    }
    .mode-pill{
      width: min(320px, 100%);
      padding: 14px 16px;
      border-radius: 999px;
      border: 1px solid rgba(34,211,238,.6);
      background:
        radial-gradient(700px 210px at 20% 20%, rgba(34,211,238,.45), rgba(34,211,238,.18) 45%, rgba(2,6,23,.10) 100%),
        linear-gradient(135deg, rgba(34,211,238,.45), rgba(6,182,212,.24));
      color: rgba(240,253,250,.98);
      font-size: .88rem;
      font-weight: 800;
      letter-spacing: .11em;
      text-transform: uppercase;
      text-align: center;
      box-shadow: 0 18px 50px rgba(34,211,238,.35);
      position: relative;
      overflow:hidden;
    }
    .header-controls{
      display:flex;
      flex-wrap:wrap;
      justify-content:flex-end;
      position:relative;
    }
    .voice-toggle{
      border:none;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: .85rem;
      background: rgba(248,250,252,.96);
      color: #0f172a;
      border: 1px solid rgba(226,232,240,.9);
      cursor: pointer;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 10px 26px rgba(2,6,23,.6);
    }
    .option-panel{
      position:absolute;
      top:115%;
      right:0;
      display:none;
      flex-direction:column;
      gap:6px;
      padding:8px;
      border-radius:16px;
      background:rgba(15,23,42,.98);
      border:1px solid rgba(148,163,184,.8);
      box-shadow:0 20px 46px rgba(15,23,42,.9);
      z-index:50;
      min-width:220px;
    }
    .header-controls.open .option-panel{display:flex;}
    .small-toggle{
      border:none;
      padding:6px 10px;
      border-radius:999px;
      font-size:.78rem;
      background:#020617;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.9);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }

    @media(max-width:900px){
      .header{grid-template-columns:1fr}
      .header-right{align-items:stretch}
      .mode-pill{width:100%}
      .header-controls{justify-content:flex-start}
    }

    /* MAIN LAYOUT */
    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
      gap:18px;
      margin-bottom:12px;
    }
    @media(max-width:900px){
      .layout{grid-template-columns:1fr}
    }

    .card{
      background:#f9fafb;
      border-radius:18px;
      padding:16px 16px 14px;
      border:1px solid #e5e7eb;
      box-shadow:0 10px 25px rgba(15,23,42,.45);
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .card-title{
      font-size:.95rem;
      font-weight:600;
      color:#0f172a;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .card-title span.emoji{font-size:1.1rem;}
    .card-sub{font-size:.75rem;color:#94a3b8;}

    .metrics-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      margin-top:4px;
    }
    .metric{
      background:#ffffff;
      border-radius:12px;
      padding:10px 10px 9px;
      border:1px solid #e5e7eb;
    }
    .metric-label{font-size:.7rem;color:#64748b;margin-bottom:4px;}
    .metric-value{font-size:1.1rem;font-weight:700;color:#1d4ed8;}
    .metric-note{font-size:.7rem;color:#9ca3af;margin-top:2px;}

    .status-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
      font-size:.72rem;
      color:#6b7280;
    }
    .tag{
      padding:4px 8px;
      border-radius:999px;
      background:#e5f4ff;
      color:#1e3a8a;
      border:1px solid #bfdbfe;
      font-size:.68rem;
    }

    .bm-canvas-shell{
      background:radial-gradient(circle at top,#e0f2fe 0,#eff6ff 60%,#e2e8f0 100%);
      border-radius:12px;
      border:1px solid #dbeafe;
      height:150px;
      overflow:hidden;
      position:relative;
    }
    #bmCanvas{width:100%;height:100%;display:block;}
    .bm-footer{
      font-size:.72rem;
      color:#6b7280;
      margin-top:6px;
      text-align:center;
    }
    .bm-overlay-btn{
      position:absolute;
      top:6px;
      width:26px;height:26px;
      border-radius:999px;
      border:none;
      font-size:.9rem;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      background:#f9fafbcc;
      box-shadow:0 6px 14px rgba(15,23,42,.25);
    }
    .bm-overlay-btn.left{left:8px;}
    .bm-overlay-btn.right{right:8px;}

    .answer-box{
      background:#020617;
      border-radius:12px;
      padding:10px 10px 12px;
      border:1px solid #020617;
      font-family:"Courier New",monospace;
      color:#e5e7eb;
      max-height:140px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .equation-header{
      font-size:.75rem;
      color:#60a5fa;
      font-weight:600;
      letter-spacing:.05em;
      text-transform:uppercase;
    }
    .equation-divider{
      height:1px;
      background:linear-gradient(90deg,rgba(148,163,184,.2),rgba(15,23,42,0),rgba(148,163,184,.2));
      margin:2px 0 4px;
    }
    .chat-container{
      background:transparent;
      border:none;
      padding:0;
      height:auto;
      max-height:110px;
      overflow-y:auto;
    }
    .message{
      max-width:100%;
      padding:6px 7px;
      margin-bottom:6px;
      border-radius:8px;
      font-size:.8rem;
      line-height:1.5;
      white-space:pre-wrap;
      animation:fadeIn .2s ease-out;
    }
    .message-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:3px;
      font-size:.7rem;
      color:#9ca3af;
      gap:6px;
    }
    .ai-message{
      background:#020617;
      border-bottom-left-radius:3px;
      border:1px solid #111827;
    }
    .user-message{
      background:#020617;
      border-bottom-right-radius:3px;
      border:1px solid #1f2937;
    }
    .message-content{color:#e5e7eb;}

    .voice-btn{
      border:none;
      border-radius:999px;
      padding:1px 6px;
      font-size:.7rem;
      cursor:pointer;
      background:#1f2937;
      color:#e5e7eb;
    }

    .typing-indicator{
      display:flex;
      align-items:center;
      gap:4px;
      background:#020617;
      border-radius:999px;
      padding:4px 8px;
      width:fit-content;
      margin:6px 0 2px;
      border:1px solid #111827;
    }
    .typing-dot{
      width:5px;height:5px;border-radius:999px;
      background:#38bdf8;
      animation:typing 1.2s infinite;
    }
    .typing-dot:nth-child(2){animation-delay:.18s}
    .typing-dot:nth-child(3){animation-delay:.36s}
    .typing-text{font-size:.7rem;color:#38bdf8;font-weight:500;}

    /* INPUT BAR (fixed) */
    .input-footer {
      margin-top: 4px;
      padding: 10px 10px 12px;
      position: sticky;
      bottom: 0;
      background: linear-gradient(to bottom, rgba(2,6,23,0), rgba(2,6,23,0.95));
      z-index:10;
    }
    .tm-formula-row {
      display: flex;
      justify-content: center;
      margin-bottom: 6px;
    }
    .tm-formula-pill {
      font-size: .7rem;
      padding: 4px 12px;
      border-radius: 999px;
      background: #020617;
      color: #e2e8f0;
      font-family: "Courier New", monospace;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 25px rgba(15,23,42,.8);
    }
    .input-row {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 0 6px;
    }
    .input-shell {
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 720px;
      background: radial-gradient(circle at 0 0, #1f2937 0, #020617 65%);
      border: 1px solid rgba(148,163,184,.85);
      border-radius: 999px;
      padding: 6px 8px 6px 12px;
      box-shadow: 0 18px 45px rgba(15,23,42,.9);
      cursor:text;
    }
    .input-shell:focus-within {
      border-color: #38bdf8;
      box-shadow: 0 20px 50px rgba(56,189,248,0.4);
      transform: translateY(-2px);
    }
    .message-input {
      flex: 1;
      resize: none;
      min-height: 26px;
      max-height: 120px;
      padding: 6px 6px 6px 0;
      border: none;
      outline: none;
      font-size: .95rem;
      background: transparent;
      color: #f9fafb;
      font-family: inherit;
      line-height: 1.4;
      text-align:left;
    }
    .send-button {
      border: none;
      height: 38px;
      padding: 0 18px;
      background: linear-gradient(135deg, #2563eb, #06b6d4);
      color: white;
      font-weight: 600;
      font-size: .85rem;
      cursor: pointer;
      border-radius: 19px;
      flex-shrink: 0;
      margin-left: 6px;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }
    .flow-caption{
      margin-top:6px;
      text-align:center;
      font-size:.7rem;
      color:#9ca3af;
    }

    /* MODALS */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
      backdrop-filter:blur(6px);
    }
    .modal-overlay.visible{display:flex;}
    .modal-card{
      background:#f9fafb;
      border-radius:18px;
      width:min(640px,96vw);
      max-height:80vh;
      box-shadow:0 24px 60px rgba(15,23,42,.6);
      border:1px solid #e5e7eb;
      display:flex;
      flex-direction:column;
    }
    .modal-header{
      padding:10px 14px 8px;
      border-bottom:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .modal-title{
      font-size:.9rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
      color:#0f172a;
    }
    .modal-sub{font-size:.7rem;color:#94a3b8;margin-top:2px;}
    .modal-close{
      border:none;
      background:transparent;
      font-size:.9rem;
      cursor:pointer;
      color:#6b7280;
      padding:4px 6px;
    }
    .modal-body{
      padding:10px 14px 12px;
      overflow-y:auto;
      font-size:.8rem;
    }
    .modal-search{
      width:100%;
      padding:7px 9px;
      border-radius:10px;
      border:1px solid #cbd5f5;
      font-size:.78rem;
      margin:8px 0 10px;
      outline:none;
      background:#ffffff;
    }

    .bm-item{
      background:#ffffff;
      border-radius:12px;
      padding:7px 8px 8px;
      border:1px solid #e5e7eb;
      margin-bottom:8px;
      font-size:.78rem;
    }
    .bm-item-header{
      display:flex;
      justify-content:space-between;
      font-size:.7rem;
      color:#64748b;
      margin-bottom:4px;
      gap:6px;
    }
    .bm-item-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .btn-mini{
      font-size:.7rem;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #dbeafe;
      background:#eff6ff;
      cursor:pointer;
      color:#1d4ed8;
    }
    .btn-mini.btn-danger{
      border-color:#fecaca;
      background:#fee2e2;
      color:#b91c1c;
    }

    .conv-item{
      background:#ffffff;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:7px 8px;
      margin-bottom:7px;
      font-size:.78rem;
    }
    .conv-header{
      display:flex;
      justify-content:space-between;
      color:#64748b;
      font-size:.7rem;
      margin-bottom:3px;
      gap:8px;
    }

    /* FAITH */
    .faith-chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .faith-chip{
      border-radius:999px;
      padding:6px 10px;
      font-size:.78rem;
      border:1px solid #e5e7eb;
      background:#fefce8;
      cursor:pointer;
    }
    .faith-chip.active{
      background:#0f172a;
      color:#f9fafb;
      border-color:#0f172a;
    }

    /* INTEL LIST */
    .intel-item{
      background:#ffffff;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:7px 8px 8px;
      margin-bottom:8px;
      font-size:.78rem;
    }
    .intel-header{
      display:flex;
      justify-content:space-between;
      font-size:.7rem;
      color:#64748b;
      margin-bottom:4px;
      gap:6px;
    }

    /* SEED MODAL */
    .seed-mode-row{
      display:flex;
      gap:6px;
      margin:4px 0 8px;
      flex-wrap:wrap;
    }
    .seed-mode-chip{
      font-size:.75rem;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #dbeafe;
      background:#eff6ff;
      cursor:pointer;
      color:#1e293b;
    }
    .seed-mode-chip.active{
      background:#0f172a;
      color:#f9fafb;
      border-color:#0f172a;
    }

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(6px)}
      to{opacity:1;transform:translateY(0)}
    }
    @keyframes typing{
      0%,60%,100%{transform:translateY(0);opacity:.4}
      30%{transform:translateY(-4px);opacity:1}
    }
  </style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="title-block">
      <h1><span>AURA-X Œ©</span></h1>
      <div class="hero-line">World‚Äôs first synthetic emotions engine (prototype)</div>
      <div class="title-sub">
        TM = user inputs only ¬∑ TM ‚üÇ (BM + Intelligence) ‚Üí E‚ÇÄ emotional state
      </div>
      <div class="ethics-pill">
        <span class="ethics-pill-text">
          Universal ethic: Avoid actions that grow negative emotions in you or others. Choose paths that gently increase shared positive emotion for everyone.
        </span>
      </div>
    </div>
    <div class="header-right">
      <div class="mode-pill">EMOTIONAL CONTINUITY ENGINE ACTIVE</div>
      <div class="header-controls" id="headerControls">
        <button id="optionsToggle" class="voice-toggle">üîò Options</button>
        <div class="option-panel" id="optionPanel">
          <button id="voiceToggle" class="small-toggle">üîà Voice: OFF</button>
          <button id="intelButton" class="small-toggle">üß† Intelligence</button>
          <button id="feedSeedButton" class="small-toggle">üå± Feed the seed</button>
          <button id="learningToggle" class="small-toggle">üìö Learning: ON</button>
          <button id="faithButton" class="small-toggle">üîò Faith: None</button>
          <button id="convButton" class="small-toggle">‚óé Conversation log</button>
        </div>
      </div>
    </div>
  </header>

  <main class="layout">
    <div>
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß™</span><span>Emotional Metrics</span></div>
            <div class="card-sub">Synthetic state E‚ÇÄ from TM colliding with BM + Intelligence.</div>
          </div>
        </div>
        <div class="metrics-grid">
          <div class="metric">
            <div class="metric-label">Emotional state E‚ÇÄ</div>
            <div id="metricE0" class="metric-value">0.00</div>
            <div class="metric-note">tanh-based, range [-1, +1]</div>
          </div>
          <div class="metric">
            <div class="metric-label">TM activation</div>
            <div id="metricTM" class="metric-value">0.00</div>
            <div class="metric-note">Recent user inputs only</div>
          </div>
          <div class="metric">
            <div class="metric-label">BM resonance</div>
            <div id="metricBM" class="metric-value">0.00</div>
            <div class="metric-note">Stored emotional stories</div>
          </div>
          <div class="metric">
            <div class="metric-label">Continuity index</div>
            <div id="metricCI" class="metric-value">0.80</div>
            <div class="metric-note">Stability over time</div>
          </div>
        </div>
        <div class="status-row">
          <span id="tagValence" class="tag">VALENCE: neutral</span>
          <span id="tagArousal" class="tag">AROUSAL: medium</span>
          <span id="tagReaction" class="tag">REACTION: balanced</span>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß†</span><span>Bold Memory Layers (240)</span></div>
            <div class="card-sub">Only story-level memories for photo/video generation.</div>
          </div>
        </div>
        <div class="bm-canvas-shell" id="bmShell">
          <button class="bm-overlay-btn left" id="bmOpenModal" title="Recall from BM">üìÅ</button>
          <button class="bm-overlay-btn right" id="convOpenModal" title="Conversation log">‚óé</button>
          <canvas id="bmCanvas"></canvas>
        </div>
        <div id="bmStats" class="bm-footer">
          Active layers: 0/240 ¬∑ System Online
        </div>
      </section>
    </div>

    <div>
      <section class="card answer-card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üí¨</span><span>Emotional Continuity Console</span></div>
          </div>
          <div class="card-sub">Offline-first ¬∑ TM = your inputs only.</div>
        </div>
        <div class="answer-box">
          <div class="equation-header">AURA-X Œ© SYNTHETIC EMOTION CONSOLE</div>
          <div class="equation-divider"></div>
          <div id="chatContainer" class="chat-container"></div>
        </div>
      </section>
    </div>
  </main>

  <footer class="input-footer">
    <div class="tm-formula-row">
      <div class="tm-formula-pill">E‚ÇÄ = tanh((TM √ó (BM + Intel)) ‚àí D + Œª_faith + Œª_sys + Œª_trc)</div>
    </div>
    <div class="input-row">
      <div class="input-shell">
        <textarea id="messageInput" class="message-input" rows="1"
          placeholder="Write to AURA-X Œ©‚Ä¶ (TM = your inputs only)"></textarea>
        <button id="sendButton" class="send-button">Send</button>
      </div>
    </div>
    <div class="flow-caption">
      Pipeline: TM (user inputs) ‚Üí collide with BM & Intelligence ‚Üí emotional answer with E‚ÇÄ.
    </div>
  </footer>
</div>

<!-- BM modal -->
<div id="bmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üìÅ Recall from BM</div>
        <div class="modal-sub">Only long stories & scenes (photo/video-ready).</div>
      </div>
      <button class="modal-close" data-close="bmModal">‚úï</button>
    </div>
    <div class="modal-body">
      <input id="bmSearch" class="modal-search" placeholder='Search BM by keyword (e.g., "city", "mother", "court")'>
      <div id="bmList"></div>
    </div>
  </div>
</div>

<!-- Conversation modal -->
<div id="convModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">‚óé Conversation history</div>
        <div class="modal-sub">Recent TM log (user + system messages).</div>
      </div>
      <button class="modal-close" data-close="convModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
        <button id="clear48" class="btn-mini btn-danger">Delete last 48h</button>
        <button id="clearAll" class="btn-mini btn-danger">Delete all (unlocked)</button>
      </div>
      <div id="convList"></div>
    </div>
  </div>
</div>

<!-- Faith modal -->
<div id="faithModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üîò Faith lens (optional)</div>
        <div class="modal-sub">Only affects encouragement lines, never core logic.</div>
      </div>
      <button class="modal-close" data-close="faithModal">‚úï</button>
    </div>
    <div class="modal-body">
      <p style="font-size:.78rem;color:#4b5563;margin-bottom:6px;">
        Universal ethics are always active. You can optionally pick one or more faith lenses. Nothing is sent to any server.
      </p>
      <div id="faithChips" class="faith-chip-row">
        <button class="faith-chip" data-faith="None">None</button>
        <button class="faith-chip" data-faith="Islam">Islam</button>
        <button class="faith-chip" data-faith="Christianity">Christianity</button>
        <button class="faith-chip" data-faith="Hinduism">Hinduism</button>
        <button class="faith-chip" data-faith="Buddhism">Buddhism</button>
        <button class="faith-chip" data-faith="Sikhism">Sikhism</button>
        <button class="faith-chip" data-faith="Humanism">Humanism</button>
      </div>
    </div>
  </div>
</div>

<!-- Intelligence modal -->
<div id="intelModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üß† Intelligence nodes</div>
        <div class="modal-sub">Self-learned Q ‚Üí A pairs (offline engine).</div>
      </div>
      <button class="modal-close" data-close="intelModal">‚úï</button>
    </div>
    <div class="modal-body">
      <input id="intelSearch" class="modal-search" placeholder='Search by question or answer'>
      <div id="intelList"></div>
    </div>
  </div>
</div>

<!-- Seed modal (Q/A + Identity) -->
<div id="seedModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üå± Feed the seed</div>
        <div class="modal-sub">Add Q/A blocks or Identity profile lines.</div>
      </div>
      <button class="modal-close" data-close="seedModal">‚úï</button>
    </div>
    <div class="modal-body">
      <p style="font-size:.78rem;color:#4b5563;margin-bottom:4px;">
        Mode:
      </p>
      <div class="seed-mode-row">
        <button id="seedModeQA" class="seed-mode-chip active">Q/A block</button>
        <button id="seedModeIdentity" class="seed-mode-chip">Identity block</button>
      </div>
      <textarea id="seedBlockInput" class="modal-search" style="min-height:120px;"
        placeholder="Q/A mode: paste LaTeX-style block with \item and \textbf{A:} ...&#10;Identity mode: lines like 'Name: Alim ul Haq' etc."></textarea>
      <div id="seedBlockPreview" style="font-size:.75rem;color:#4b5563;margin-top:6px;">
        Waiting for block‚Ä¶
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
        <button id="seedParseBtn" class="btn-mini">Parse block</button>
        <button id="seedSaveBtn" class="btn-mini" disabled>Save to memory</button>
        <button id="seedDiscardBtn" class="btn-mini btn-danger">Discard</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const STORAGE_KEY = "auraXOmega_simple_v1";

  class AuraX {
    constructor(){
      this.state = this.loadState() || {
        tmHistory: [],
        bmEntries: [],
        bmLayers: new Array(240).fill(0.3),
        intelNodes: [],
        identityFacts: [],
        e0: 0.2,
        lastE0: 0.2,
        continuityIndex: 0.8,
        voiceOn: false,
        learning: true,
        faiths: []
      };
      this.seedMode = "qa";          // "qa" or "identity"
      this.seedPanelQAs = [];
      this.seedPanelIdentities = [];

      this.cacheDom();
      this.bindEvents();
      this.updateAllUI();
      this.startBMAnimation();

      if(!this.state.tmHistory.length){
        this.bootstrapWelcome();
      }else{
        this.state.tmHistory.forEach(m=>{
          this.renderMessage(m.role,m.text,m.role==="ai",m.sentiment);
        });
      }
    }

    /* ---------- STORAGE ---------- */
    loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      }catch(e){return null;}
    }
    saveState(){
      try{ localStorage.setItem(STORAGE_KEY,JSON.stringify(this.state)); }catch(e){}
    }

    /* ---------- DOM ---------- */
    cacheDom(){
      this.metricE0 = document.getElementById("metricE0");
      this.metricTM = document.getElementById("metricTM");
      this.metricBM = document.getElementById("metricBM");
      this.metricCI = document.getElementById("metricCI");
      this.tagValence = document.getElementById("tagValence");
      this.tagArousal = document.getElementById("tagArousal");
      this.tagReaction = document.getElementById("tagReaction");

      this.bmCanvas = document.getElementById("bmCanvas");
      this.bmCtx = this.bmCanvas.getContext("2d");
      this.bmShell = document.getElementById("bmShell");
      this.bmStats = document.getElementById("bmStats");

      this.chatContainer = document.getElementById("chatContainer");
      this.messageInput = document.getElementById("messageInput");
      this.sendButton = document.getElementById("sendButton");

      this.optionsToggle = document.getElementById("optionsToggle");
      this.headerControls = document.getElementById("headerControls");
      this.optionPanel = document.getElementById("optionPanel");
      this.voiceToggle = document.getElementById("voiceToggle");
      this.learningToggle = document.getElementById("learningToggle");
      this.faithButton = document.getElementById("faithButton");
      this.intelButton = document.getElementById("intelButton");
      this.feedSeedButton = document.getElementById("feedSeedButton");
      this.convButton = document.getElementById("convButton");

      this.bmModal = document.getElementById("bmModal");
      this.bmSearch = document.getElementById("bmSearch");
      this.bmList = document.getElementById("bmList");
      this.bmOpenModal = document.getElementById("bmOpenModal");
      this.convOpenModal = document.getElementById("convOpenModal");

      this.convModal = document.getElementById("convModal");
      this.convList = document.getElementById("convList");
      this.clear48Btn = document.getElementById("clear48");
      this.clearAllBtn = document.getElementById("clearAll");

      this.faithModal = document.getElementById("faithModal");
      this.faithChips = document.getElementById("faithChips");

      this.intelModal = document.getElementById("intelModal");
      this.intelSearch = document.getElementById("intelSearch");
      this.intelList = document.getElementById("intelList");

      this.seedModal = document.getElementById("seedModal");
      this.seedModeQA = document.getElementById("seedModeQA");
      this.seedModeIdentity = document.getElementById("seedModeIdentity");
      this.seedBlockInput = document.getElementById("seedBlockInput");
      this.seedBlockPreview = document.getElementById("seedBlockPreview");
      this.seedParseBtn = document.getElementById("seedParseBtn");
      this.seedSaveBtn = document.getElementById("seedSaveBtn");
      this.seedDiscardBtn = document.getElementById("seedDiscardBtn");

      this.resizeCanvas();
      window.addEventListener("resize",()=>this.resizeCanvas());
    }

    bindEvents(){
      if(this.sendButton){
        this.sendButton.addEventListener("click",()=>this.handleSend());
      }
      if(this.messageInput){
        this.messageInput.addEventListener("keydown",(e)=>{
          if(e.key==="Enter" && !e.shiftKey){
            e.preventDefault();
            this.handleSend();
          }
        });
        this.messageInput.addEventListener("input", function(){
          this.style.height="auto";
          this.style.height=this.scrollHeight+"px";
        });
      }

      if(this.optionsToggle && this.headerControls){
        this.optionsToggle.addEventListener("click",(e)=>{
          e.stopPropagation();
          this.headerControls.classList.toggle("open");
        });
        document.addEventListener("click",(e)=>{
          if(!this.headerControls.contains(e.target)){
            this.headerControls.classList.remove("open");
          }
        });
      }

      if(this.voiceToggle){
        this.voiceToggle.addEventListener("click",()=>{
          this.state.voiceOn = !this.state.voiceOn;
          this.updateVoiceLabel();
          this.saveState();
        });
      }
      if(this.learningToggle){
        this.learningToggle.addEventListener("click",()=>{
          this.state.learning = !this.state.learning;
          this.learningToggle.textContent = this.state.learning ? "üìö Learning: ON" : "üìö Learning: OFF";
          this.saveState();
        });
      }
      if(this.faithButton){
        this.faithButton.addEventListener("click",()=>this.openModal(this.faithModal));
      }
      if(this.intelButton){
        this.intelButton.addEventListener("click",()=>{
          this.renderIntelList();
          this.openModal(this.intelModal);
        });
      }
      if(this.feedSeedButton){
        this.feedSeedButton.addEventListener("click",()=>{
          this.updateSeedModeUI();
          this.openModal(this.seedModal);
        });
      }
      if(this.convButton){
        this.convButton.addEventListener("click",()=>{
          this.renderConvList();
          this.openModal(this.convModal);
        });
      }

      if(this.bmOpenModal){
        this.bmOpenModal.addEventListener("click",(e)=>{
          e.stopPropagation();
          this.renderBMList();
          this.openModal(this.bmModal);
        });
      }
      if(this.convOpenModal){
        this.convOpenModal.addEventListener("click",(e)=>{
          e.stopPropagation();
          this.renderConvList();
          this.openModal(this.convModal);
        });
      }

      document.querySelectorAll(".modal-close").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const id = btn.dataset.close;
          const modal = document.getElementById(id);
          if(modal) modal.classList.remove("visible");
        });
      });
      [this.bmModal,this.convModal,this.faithModal,this.intelModal,this.seedModal].forEach(modal=>{
        if(!modal) return;
        modal.addEventListener("click",(e)=>{
          if(e.target===modal) modal.classList.remove("visible");
        });
      });

      if(this.bmSearch){
        this.bmSearch.addEventListener("input",()=>this.renderBMList());
      }

      if(this.clear48Btn){
        this.clear48Btn.addEventListener("click",()=>this.clearTMByHours(48));
      }
      if(this.clearAllBtn){
        this.clearAllBtn.addEventListener("click",()=>{
          this.state.tmHistory = this.state.tmHistory.filter(m=>m.locked);
          this.renderConvList();
          this.updateMetrics();
          this.saveState();
        });
      }

      if(this.faithChips){
        this.faithChips.addEventListener("click",(e)=>{
          const chip = e.target.closest(".faith-chip");
          if(!chip) return;
          const f = chip.dataset.faith;
          if(f==="None"){
            this.state.faiths = [];
          }else{
            if(this.state.faiths.includes(f)){
              this.state.faiths = this.state.faiths.filter(x=>x!==f);
            }else{
              this.state.faiths.push(f);
            }
          }
          this.updateFaithUI();
          this.saveState();
        });
      }

      if(this.intelSearch){
        this.intelSearch.addEventListener("input",()=>this.renderIntelList());
      }
      if(this.intelList){
        this.intelList.addEventListener("click",(e)=>{
          const btn = e.target.closest("button[data-action]");
          if(!btn) return;
          const id = btn.dataset.id;
          const action = btn.dataset.action;
          const node = this.state.intelNodes.find(n=>n.id===id);
          if(!node) return;
          if(action==="use"){
            this.messageInput.value = node.question;
            this.messageInput.focus();
          }else if(action==="copy"){
            if(navigator.clipboard&&navigator.clipboard.writeText){
              navigator.clipboard.writeText(node.answer).catch(()=>alert(node.answer));
            }else alert(node.answer);
          }else if(action==="delete"){
            if(confirm("Delete this learned Q/A?")){
              this.state.intelNodes = this.state.intelNodes.filter(n=>n.id!==id);
              this.renderIntelList();
              this.saveState();
            }
          }
        });
      }

      if(this.seedModeQA){
        this.seedModeQA.addEventListener("click",()=>{this.seedMode="qa";this.updateSeedModeUI();});
      }
      if(this.seedModeIdentity){
        this.seedModeIdentity.addEventListener("click",()=>{this.seedMode="identity";this.updateSeedModeUI();});
      }
      if(this.seedParseBtn){
        this.seedParseBtn.addEventListener("click",()=>this.handleSeedParse());
      }
      if(this.seedSaveBtn){
        this.seedSaveBtn.addEventListener("click",()=>this.handleSeedSave());
      }
      if(this.seedDiscardBtn){
        this.seedDiscardBtn.addEventListener("click",()=>this.handleSeedDiscard());
      }
    }

    openModal(modal){
      if(!modal) return;
      modal.classList.add("visible");
    }

    updateVoiceLabel(){
      if(this.voiceToggle){
        this.voiceToggle.textContent = this.state.voiceOn ? "üîä Voice: ON" : "üîà Voice: OFF";
      }
    }
    updateFaithUI(){
      if(this.faithButton){
        const f = this.state.faiths;
        const label = !f.length ? "üîò Faith: None"
          : f.length===1 ? "üîò Faith: "+f[0]
          : "üîò Faith: "+f[0]+" +"+(f.length-1);
        this.faithButton.textContent = label;
      }
      if(this.faithChips){
        this.faithChips.querySelectorAll(".faith-chip").forEach(ch=>{
          const f = ch.dataset.faith;
          if(f==="None"){
            ch.classList.toggle("active",this.state.faiths.length===0);
          }else{
            ch.classList.toggle("active",this.state.faiths.includes(f));
          }
        });
      }
    }
    updateSeedModeUI(){
      if(this.seedModeQA && this.seedModeIdentity){
        this.seedModeQA.classList.toggle("active",this.seedMode==="qa");
        this.seedModeIdentity.classList.toggle("active",this.seedMode==="identity");
      }
      if(this.seedBlockPreview){
        this.seedBlockPreview.textContent = this.seedMode==="qa"
          ? "Q/A mode: paste LaTeX block with \\item question and \\textbf{A:} answer."
          : "Identity mode: lines like 'Name: Alim ul Haq', 'Father name: Fazal Haq', 'Village: Lajbok' etc.";
      }
      if(this.seedSaveBtn) this.seedSaveBtn.disabled = true;
    }

    updateAllUI(){
      this.updateVoiceLabel();
      if(this.learningToggle){
        this.learningToggle.textContent = this.state.learning ? "üìö Learning: ON" : "üìö Learning: OFF";
      }
      this.updateFaithUI();
      this.updateMetrics();
      this.renderBMList();
      this.renderConvList();
      this.renderIntelList();
    }

    /* ---------- METRICS ---------- */
    updateMetrics(){
      this.metricE0.textContent = this.state.e0.toFixed(3);
      const userCount = this.state.tmHistory.filter(m=>m.role==="user").length;
      this.metricTM.textContent = Math.min(1,userCount/40).toFixed(2);
      this.metricBM.textContent = Math.min(1,this.state.bmEntries.length/80).toFixed(2);
      this.metricCI.textContent = this.state.continuityIndex.toFixed(3);

      const v = this.state.e0;
      const val = v>0.25?"positive":v<-0.25?"negative":"neutral";
      this.tagValence.textContent = "VALENCE: "+val;
      this.tagArousal.textContent = "AROUSAL: medium";
      this.tagReaction.textContent = "REACTION: "+(val==="negative"?"tense":"balanced");

      const active = this.state.bmLayers.filter(x=>x>0.6).length;
      this.bmStats.textContent = `Active layers: ${active}/${this.state.bmLayers.length} ¬∑ System Online`;
    }

    /* ---------- BM CANVAS ---------- */
    resizeCanvas(){
      const rect = this.bmShell.getBoundingClientRect();
      const dpr = window.devicePixelRatio||1;
      this.bmCanvas.width = rect.width*dpr;
      this.bmCanvas.height = rect.height*dpr;
      this.bmCtx.setTransform(dpr,0,0,dpr,0,0);
    }
    startBMAnimation(){
      const loop=()=>{
        this.drawBMLayers();
        requestAnimationFrame(loop);
      };
      loop();
    }
    drawBMLayers(){
      const ctx = this.bmCtx;
      const w = this.bmCanvas.width/(window.devicePixelRatio||1);
      const h = this.bmCanvas.height/(window.devicePixelRatio||1);
      ctx.clearRect(0,0,w,h);
      const grad = ctx.createLinearGradient(0,0,0,h);
      grad.addColorStop(0,"#e0f2fe");
      grad.addColorStop(1,"#e5e7eb");
      ctx.fillStyle = grad;
      ctx.fillRect(0,0,w,h);

      const bands = ["Pain","Fear","Love","Identity","Belief","Hope","Wisdom"];
      const colors = [
        [239,68,68],[249,115,22],[34,197,94],
        [14,165,233],[99,102,241],[234,179,8],[168,85,247]
      ];
      const barW = w/this.state.bmLayers.length;
      const bandSize = this.state.bmLayers.length/bands.length;
      for(let i=0;i<this.state.bmLayers.length;i++){
        this.state.bmLayers[i] += (Math.random()-0.5)*0.01;
        if(this.state.bmLayers[i]<0.05)this.state.bmLayers[i]=0.05;
        if(this.state.bmLayers[i]>0.95)this.state.bmLayers[i]=0.95;
        const bh = this.state.bmLayers[i]*h*0.8;
        const x = i*barW;
        const y = h-bh;
        let bi = Math.floor(i/bandSize);
        if(bi>=bands.length) bi=bands.length-1;
        const [r,g,b] = colors[bi];
        const alpha = 0.25 + this.state.bmLayers[i]*0.5;
        ctx.fillStyle = `rgba(${r},${g},${b},${alpha})`;
        ctx.fillRect(x,y,barW,bh);
      }
    }

    /* ---------- CHAT ---------- */
    bootstrapWelcome(){
      const txt =
        "Welcome. I am AURA-X Œ©, running offline in this browser.\n\n"+
        "‚Ä¢ TM = your inputs only (text now, voice/docs later).\n"+
        "‚Ä¢ BM = long emotional stories that later can become photo/video prompts.\n"+
        "‚Ä¢ Intelligence = Q/A seeds you teach me.\n\n"+
        "You can also open üå± Feed the seed:\n"+
        "  ‚Äì Q/A block: paste LaTeX with \\item and \\textbf{A:}.\n"+
        "  ‚Äì Identity block: basic profile lines (name, father, village, brothers, sisters‚Ä¶).";
      const s = this.analyzeSentiment(txt);
      this.pushTM("ai",txt,s);
      this.renderMessage("ai",txt,true,s);
      this.updateMetrics();
      this.saveState();
    }

    pushTM(role,text,sentiment){
      this.state.tmHistory.push({
        id:"tm_"+Math.random().toString(36).slice(2),
        role,text,
        sentiment,
        timestamp:new Date().toISOString(),
        locked:false
      });
    }

    renderMessage(role,text,isAI,sentiment){
      const wrap = document.createElement("div");
      wrap.className = "message "+(role==="ai"?"ai-message":"user-message");

      const header = document.createElement("div");
      header.className="message-header";
      const left = document.createElement("span");
      left.textContent = role==="ai"?"AURA-X Œ©":"You";
      const right = document.createElement("div");
      if(isAI){
        const btn = document.createElement("button");
        btn.className="voice-btn";
        btn.textContent="üîä";
        btn.addEventListener("click",()=>this.speak(text,sentiment));
        right.appendChild(btn);
      }
      header.appendChild(left);
      header.appendChild(right);

      const body = document.createElement("div");
      body.className="message-content";
      body.textContent = text;

      wrap.appendChild(header);
      wrap.appendChild(body);
      this.chatContainer.appendChild(wrap);
      this.chatContainer.scrollTop = this.chatContainer.scrollHeight;

      if(isAI && this.state.voiceOn){
        this.speak(text,sentiment);
      }
    }

    speak(text,sentiment){
      if(!("speechSynthesis" in window)) return;
      let clean = text.replace(/<[^>]+>/g,"");
      try{
        const emojiRegex=/[\u{1F300}-\u{1FAFF}\u{1F1E6}-\u{1F1FF}]/gu;
        clean = clean.replace(emojiRegex,"");
      }catch(e){
        clean = clean.replace(/[\uD800-\uDFFF]/g,"");
      }
      const u = new SpeechSynthesisUtterance(clean);
      if(sentiment && sentiment.polarity==="positive") u.pitch=1.1;
      if(sentiment && sentiment.polarity==="negative") u.pitch=0.9;
      window.speechSynthesis.speak(u);
    }

    showTyping(){
      const id="typing_"+Math.random().toString(36).slice(2);
      const wrap=document.createElement("div");
      wrap.id=id;
      wrap.className="typing-indicator";
      wrap.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div><span class="typing-text">Aura is thinking‚Ä¶</span>';
      this.chatContainer.appendChild(wrap);
      this.chatContainer.scrollTop=this.chatContainer.scrollHeight;
      return id;
    }
    hideTyping(id){
      const el=document.getElementById(id);
      if(el) el.remove();
    }

    /* ---------- SENTIMENT ---------- */
    analyzeSentiment(text){
      const lower=text.toLowerCase();
      const words=lower.split(/\s+/);
      const lex={
        positive:["love","good","great","happy","peace","hope","kind","beautiful","amazing","thanks"],
        negative:["bad","hate","sad","hurt","pain","angry","anger","awful","terrible","stupid"],
        anger:["hate","angry","rage","stupid","idiot"],
        fear:["afraid","scared","terrified","anxious","worry"],
        sadness:["sad","cry","lonely","alone","broken"],
        love:["love","care","affection"],
        hope:["hope","dream","future","faith","trust"],
        wisdom:["truth","wisdom","meaning"]
      };
      let pos=0,neg=0,anger=0,fear=0,sad=0,love=0,hope=0,wisdom=0;
      for(const w of words){
        if(lex.positive.includes(w))pos++;
        if(lex.negative.includes(w))neg++;
        if(lex.anger.includes(w))anger++;
        if(lex.fear.includes(w))fear++;
        if(lex.sadness.includes(w))sad++;
        if(lex.love.includes(w))love++;
        if(lex.hope.includes(w))hope++;
        if(lex.wisdom.includes(w))wisdom++;
      }
      const total=pos+neg||1;
      let valence=(pos-neg)/total;
      let polarity="neutral";
      if(valence>0.25)polarity="positive";
      else if(valence<-0.25)polarity="negative";
      let category="neutral";
      if(anger>0)category="anger";
      else if(sad>0)category="sadness";
      else if(fear>0)category="fear";
      else if(love>0)category="love";
      else if(hope>0)category="hope";
      else if(wisdom>0)category="wisdom";
      let intensity=Math.min(1,(anger+fear+sad+love+hope+wisdom)/3+text.length/200);
      return {polarity,valence,category,intensity};
    }

    /* ---------- INTEL MATCH (‚âà90%) ---------- */
    textSimilarity(a,b){
      const sa=new Set(a.split(/\W+/).filter(Boolean));
      const sb=new Set(b.split(/\W+/).filter(Boolean));
      if(!sa.size || !sb.size) return 0;
      let inter=0;
      sa.forEach(x=>{if(sb.has(x))inter++;});
      const uni=new Set([...sa,...sb]).size||1;
      return inter/uni;
    }
    matchIntel(text){
      if(!this.state.intelNodes.length) return null;
      const q=text.toLowerCase();
      let best=null,bestScore=0;
      this.state.intelNodes.forEach(n=>{
        const sim=this.textSimilarity(q,n.question.toLowerCase());
        if(sim>bestScore){bestScore=sim;best=n;}
      });
      return bestScore>=0.9?best:null; // 90% rule
    }

    /* ---------- IDENTITY ---------- */
    parseIdentityBlock(text){
      const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const list=[];
      for(const line of lines){
        const parts=line.split(/[:=]/);
        if(parts.length<2) continue;
        const label=parts[0].trim();
        const value=parts.slice(1).join(":").trim();
        if(!label||!value) continue;
        const type=this.detectIdentityType(label,value);
        list.push({
          id:"id_"+Math.random().toString(36).slice(2),
          label,value,type,
          confirmedCount:4,
          createdAt:new Date().toISOString()
        });
      }
      return list;
    }
    detectIdentityType(label,value){
      const l=label.toLowerCase();
      if(l.includes("name") && !l.includes("father") && !l.includes("uncle")) return "self_name";
      if(l.includes("father")) return "father";
      if(l.includes("brother")) return "brother";
      if(l.includes("sister")) return "sister";
      if(l.includes("village")||l.includes("gaon")) return "village";
      if(l.includes("district")) return "district";
      if(l.includes("dob")||l.includes("birth")) return "dob";
      return "other";
    }
    upsertIdentity(fact){
      const key=(fact.label||"").toLowerCase();
      const val=(fact.value||"").toLowerCase();
      const existing=this.state.identityFacts.find(f=>
        (f.label||"").toLowerCase()===key &&
        (f.value||"").toLowerCase()===val
      );
      if(existing){
        existing.confirmedCount=Math.min((existing.confirmedCount||1)+1,10);
        existing.createdAt=new Date().toISOString();
      }else{
        this.state.identityFacts.push(fact);
      }
    }
    answerFromIdentity(text){
      const lower=text.toLowerCase();
      const get=(types)=>{
        const f=this.state.identityFacts.find(x=>types.includes(x.type));
        return f?f.value:null;
      };
      if(lower.includes("my name")){
        const v=get(["self_name"]);
        if(v) return "Your name in my identity memory is: "+v+".";
      }
      if(lower.includes("my father")){
        const v=get(["father"]);
        if(v) return "Your father‚Äôs name is stored as: "+v+".";
      }
      if(lower.includes("my village")||lower.includes("which village")){
        const v=get(["village"]);
        if(v) return "Your village is stored as: "+v+".";
      }
      return null;
    }

    /* ---------- SEED (Q/A + IDENTITY) ---------- */
    parseLaTeXBlock(text){
      const parts=text.split(/\\item/).slice(1);
      const out=[];
      for(const raw of parts){
        let part=raw.trim();
        if(!part) continue;
        let q="",a="";
        const idxBack=part.indexOf("\\\\");
        const idxA=part.indexOf("\\textbf{A:}");
        if(idxBack!==-1) q=part.slice(0,idxBack);
        else if(idxA!==-1) q=part.slice(0,idxA);
        if(idxA!==-1){
          let ans=part.slice(idxA+"\\textbf{A:}".length);
          ans=ans.replace(/^[\\s:\\\\]+/,"");
          a=ans;
        }
        q=q.replace(/[\r\n]+/g," ").trim();
        a=a.replace(/[\r\n]+/g," ").trim();
        q=q.replace(/^Q\\d*[:.)-]\\s*/i,"").trim();
        a=a.replace(/\\end\{[a-zA-Z*]+\}.*$/,"").trim();
        if(q&&a) out.push({question:q,answer:a});
      }
      return out;
    }
    handleSeedParse(){
      const raw=(this.seedBlockInput.value||"").trim();
      if(!raw){
        this.seedBlockPreview.textContent="Paste some content first.";
        this.seedSaveBtn.disabled=true;
        return;
      }
      if(this.seedMode==="qa"){
        const qas=this.parseLaTeXBlock(raw);
        if(!qas.length){
          this.seedBlockPreview.textContent="No Q/A pairs found. Make sure you use \\item and \\textbf{A:}.";
          this.seedSaveBtn.disabled=true;
          this.seedPanelQAs=[];
          return;
        }
        this.seedPanelQAs=qas;
        this.seedPanelIdentities=[];
        const ex=qas[0];
        this.seedBlockPreview.textContent=
          `Found ${qas.length} Q/A pairs.\nExample:\nQ: ${ex.question}\nA: ${ex.answer}`;
        this.seedSaveBtn.disabled=false;
      }else{
        const facts=this.parseIdentityBlock(raw);
        if(!facts.length){
          this.seedBlockPreview.textContent="No identity facts found. Use lines like 'Name: ...', 'Father name: ...'.";
          this.seedSaveBtn.disabled=true;
          this.seedPanelIdentities=[];
          return;
        }
        this.seedPanelIdentities=facts;
        this.seedPanelQAs=[];
        const ex=facts[0];
        this.seedBlockPreview.textContent=
          `Found ${facts.length} identity facts.\nExample:\n${ex.label}: ${ex.value}`;
        this.seedSaveBtn.disabled=false;
      }
    }
    handleSeedSave(){
      if(this.seedMode==="qa"){
        if(!this.seedPanelQAs.length){
          this.seedBlockPreview.textContent="Nothing to save yet.";
          return;
        }
        this.seedPanelQAs.forEach(p=>{
          this.state.intelNodes.push({
            id:"intel_"+Math.random().toString(36).slice(2),
            question:p.question,
            answer:p.answer,
            createdAt:new Date().toISOString()
          });
        });
        this.seedBlockPreview.textContent=`Saved ${this.seedPanelQAs.length} Q/A pairs into Intelligence.`;
        this.seedPanelQAs=[];
        this.seedSaveBtn.disabled=true;
        this.seedBlockInput.value="";
        this.renderIntelList();
        this.saveState();
      }else{
        if(!this.seedPanelIdentities.length){
          this.seedBlockPreview.textContent="Nothing to save yet.";
          return;
        }
        this.seedPanelIdentities.forEach(f=>this.upsertIdentity(f));
        this.seedBlockPreview.textContent=`Saved ${this.seedPanelIdentities.length} identity facts into Identity memory.`;
        this.seedPanelIdentities=[];
        this.seedSaveBtn.disabled=true;
        this.seedBlockInput.value="";
        this.saveState();
      }
    }
    handleSeedDiscard(){
      this.seedPanelQAs=[];
      this.seedPanelIdentities=[];
      this.seedBlockInput.value="";
      this.updateSeedModeUI();
    }

    /* ---------- BM / CONV / INTEL LISTS ---------- */
    escapeHtml(str){
      return String(str).replace(/[&<>"']/g,ch=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[ch]));
    }
    renderBMList(){
      if(!this.bmList) return;
      const q=(this.bmSearch.value||"").toLowerCase();
      this.bmList.innerHTML="";
      if(!this.state.bmEntries.length){
        this.bmList.textContent="No bold memories yet. Only long emotional stories are stored here.";
        return;
      }
      const filtered=this.state.bmEntries.filter(e=>e.text.toLowerCase().includes(q));
      filtered.forEach(e=>{
        const div=document.createElement("div");
        div.className="bm-item";
        const date=new Date(e.timestampMs||Date.now()).toISOString().slice(0,10);
        div.innerHTML=`
          <div class="bm-item-header">
            <span>${date}</span>
            <span>${e.polarity||"neutral"} ¬∑ E‚ÇÄ‚âà${(e.e0||0).toFixed(2)}</span>
          </div>
          <div style="margin-bottom:6px;">${this.escapeHtml(e.text.slice(0,200))}...</div>
          <div class="bm-item-buttons">
            <button class="btn-mini" data-action="copy" data-id="${e.id}">Copy</button>
            <button class="btn-mini btn-danger" data-action="delete" data-id="${e.id}">Delete</button>
          </div>
        `;
        this.bmList.appendChild(div);
      });
      this.bmList.addEventListener("click",(ev)=>{
        const btn=ev.target.closest("button[data-action]");
        if(!btn) return;
        const id=btn.dataset.id;
        const action=btn.dataset.action;
        const entry=this.state.bmEntries.find(x=>x.id===id);
        if(!entry) return;
        if(action==="copy"){
          if(navigator.clipboard&&navigator.clipboard.writeText){
            navigator.clipboard.writeText(entry.text).catch(()=>alert(entry.text));
          }else alert(entry.text);
        }else if(action==="delete"){
          if(confirm("Delete this BM story?")){
            this.state.bmEntries=this.state.bmEntries.filter(x=>x.id!==id);
            this.renderBMList();
            this.updateMetrics();
            this.saveState();
          }
        }
      },{once:true});
    }
    renderConvList(){
      if(!this.convList) return;
      this.convList.innerHTML="";
      this.state.tmHistory.slice(-60).forEach(m=>{
        const div=document.createElement("div");
        div.className="conv-item";
        const t=new Date(m.timestamp).toLocaleTimeString();
        div.innerHTML=`
          <div class="conv-header">
            <span>${m.role}</span>
            <span>${t}</span>
          </div>
          <div>${this.escapeHtml(m.text)}</div>
        `;
        this.convList.appendChild(div);
      });
    }
    renderIntelList(){
      if(!this.intelList) return;
      const q=(this.intelSearch.value||"").toLowerCase();
      this.intelList.innerHTML="";
      if(!this.state.intelNodes.length){
        this.intelList.textContent="No intelligence nodes yet. When I don't know an answer and Learning is ON, you can teach me.";
        return;
      }
      const filtered=this.state.intelNodes.filter(n=>
        n.question.toLowerCase().includes(q) || n.answer.toLowerCase().includes(q)
      );
      filtered.forEach(n=>{
        const div=document.createElement("div");
        const date=new Date(n.createdAt).toISOString().slice(0,10);
        div.className="intel-item";
        div.innerHTML=`
          <div class="intel-header">
            <span>${date}</span><span>Learned</span>
          </div>
          <div><strong>Q:</strong> ${this.escapeHtml(n.question)}</div>
          <div><strong>A:</strong> ${this.escapeHtml(n.answer)}</div>
          <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;">
            <button class="btn-mini" data-action="use" data-id="${n.id}">Use question</button>
            <button class="btn-mini" data-action="copy" data-id="${n.id}">Copy answer</button>
            <button class="btn-mini btn-danger" data-action="delete" data-id="${n.id}">Delete</button>
          </div>
        `;
        this.intelList.appendChild(div);
      });
    }

    clearTMByHours(h){
      const cutoff=Date.now()-h*3600000;
      this.state.tmHistory=this.state.tmHistory.filter(m=>{
        if(m.locked) return true;
        const t=new Date(m.timestamp).getTime();
        return t<cutoff;
      });
      this.renderConvList();
      this.updateMetrics();
      this.saveState();
    }

    /* ---------- MAIN HANDLER ---------- */
    async handleSend(){
      const raw=this.messageInput.value;
      const text=(raw||"").trim();
      if(!text) return;
      this.messageInput.value="";
      this.messageInput.style.height="auto";

      const sentiment=this.analyzeSentiment(text);
      this.pushTM("user",text,sentiment);
      this.renderMessage("user",text,false,sentiment);

      const typingId=this.showTyping();
      setTimeout(()=>{
        this.hideTyping(typingId);
        const reply=this.generateReply(text,sentiment);
        const rs=this.analyzeSentiment(reply);
        this.pushTM("ai",reply,rs);
        this.renderMessage("ai",reply,true,rs);
        this.updateStateFromInteraction(text,sentiment);
        this.updateMetrics();
        this.renderBMList();
        this.renderConvList();
        this.saveState();
      },400+Math.random()*500);
    }

    generateReply(text,sentiment){
      const intel=this.matchIntel(text);
      const idAns=this.answerFromIdentity(text);
      if(intel) return intel.answer;
      if(idAns) return idAns;

      // Learning off ‚Üí explanation
      if(!this.state.learning){
        return "I read your TM input with polarity "+sentiment.polarity+
          " (category: "+sentiment.category+").\n\n"+
          "Right now learning mode is OFF, so I only adjust my emotional metrics and BM layers.\n"+
          "If you enable Learning, I can store Q/A seeds and answer this more precisely next time.";
      }

      // Default: emotional reflection + teaching invitation
      return "I read your TM input as "+sentiment.polarity+
        " (category: "+sentiment.category+").\n\n"+
        "I will keep only emotionally meaningful parts in BM (longer stories), and ignore small-talk for storage.\n\n"+
        "If you want, you can open üå± Feed the seed and add a Q/A block for this kind of question, or an Identity block so I know you better.";
    }

    updateStateFromInteraction(text,sentiment){
      const now=Date.now();
      const longStory=text.length>=80;
      if(longStory){
        this.state.bmEntries.push({
          id:"bm_"+Math.random().toString(36).slice(2),
          text,
          timestampMs:now,
          polarity:sentiment.polarity,
          valence:sentiment.valence,
          category:sentiment.category,
          e0:this.state.e0
        });
      }

      const tmMag=Math.min(1,0.4+0.6*sentiment.intensity);
      const bmMag=Math.min(1,0.3+0.7*Math.min(1,this.state.bmEntries.length/80));
      const TMxBM=tmMag*bmMag;
      const D=0.2;
      const faithBoost=this.state.faiths.length?0.08:0;
      const lambdaSys=0.1;
      const lambdaTrc=["love","hope","wisdom"].includes(sentiment.category)?0.06:0;
      const raw=TMxBM-D+faithBoost+lambdaSys+lambdaTrc;
      const e0=Math.tanh(raw);
      const diff=Math.abs(e0-this.state.e0);
      this.state.e0=e0;
      this.state.continuityIndex=this.state.continuityIndex*0.85+(1-diff)*0.15;

      const sign=sentiment.valence>=0?1:-1;
      for(let i=0;i<this.state.bmLayers.length;i++){
        if(Math.random()<0.2){
          this.state.bmLayers[i]+=sign*0.1*sentiment.intensity;
          if(this.state.bmLayers[i]<0.05)this.state.bmLayers[i]=0.05;
          if(this.state.bmLayers[i]>0.95)this.state.bmLayers[i]=0.95;
        }
      }
    }
  }

  window.addEventListener("DOMContentLoaded",()=>{
    window.auraX = new AuraX();
  });
})();
</script>
</body>
</html>