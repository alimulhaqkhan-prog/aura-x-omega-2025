<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="UTF-8" />

  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Offline LLM package (WebLLM, for in-browser models) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    /* RESET & BASICS */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg, #020617 0, #020617 40%, #020617 100%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
    }

    .app {
      width: 100%;
      max-width: 1100px;
      background: radial-gradient(circle at top, #020617 0, #020617 35%, #020617 100%);
      border-radius: 26px;
      box-shadow:
        0 26px 80px rgba(15, 23, 42, .85),
        0 0 0 1px rgba(148, 163, 184, .45);
      padding: 18px 20px 12px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      position: relative;
      overflow: visible;
    }

    .app::before {
      content: "";
      position: absolute;
      inset: -40px;
      background:
        radial-gradient(circle at 15% -10%, rgba(56, 189, 248, .28), transparent 60%),
        radial-gradient(circle at 85% -20%, rgba(59, 130, 246, .26), transparent 55%);
      opacity: .7;
      pointer-events: none;
      z-index: 0;
    }

    .app>* {
      position: relative;
      z-index: 1;
    }

    /* ===================== HERO HEADER ===================== */
    .header {
      position: relative;
      border-radius: 24px;
      padding: 16px 18px 14px;
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items: center;
      background:
        radial-gradient(900px 320px at 20% 0%, rgba(56, 189, 248, .32), rgba(15, 23, 42, .98) 55%, #020617 100%);
      border: 1.5px solid rgba(148, 163, 184, .55);
      box-shadow:
        0 26px 70px rgba(15, 23, 42, .9),
        inset 0 1px 0 rgba(255, 255, 255, .08);
      z-index: 5;
    }

    .header::before {
      content: "";
      position: absolute;
      inset: -40px;
      background:
        radial-gradient(circle at 20% 30%, rgba(56, 189, 248, .22), transparent 45%),
        radial-gradient(circle at 80% 25%, rgba(34, 211, 238, .18), transparent 40%),
        linear-gradient(90deg, rgba(56, 189, 248, .20), transparent 35%, rgba(34, 211, 238, .18));
      opacity: .9;
      pointer-events: none;
      z-index: 0;
    }

    .header::after {
      content: "";
      position: absolute;
      inset: 0;
      background:
        repeating-linear-gradient(90deg, rgba(56, 189, 248, .18) 0 2px, transparent 2px 26px);
      opacity: .06;
      pointer-events: none;
      z-index: 0;
    }

    .title-block {
      position: relative;
      z-index: 1;
    }

    .title-block h1 {
      font-size: 1.7rem;
      letter-spacing: .10em;
      text-transform: uppercase;
      font-weight: 800;
      line-height: 1.05;
    }

    .title-block h1 span {
      background: linear-gradient(120deg, #38bdf8, #22d3ee, #a5b4fc);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .hero-line {
      margin-top: 6px;
      font-size: .9rem;
      color: rgba(226, 232, 240, .96);
      font-weight: 600;
    }

    .title-sub {
      margin-top: 4px;
      font-size: .8rem;
      color: rgba(148, 163, 184, .98);
      line-height: 1.35;
    }

    .badge-row {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
    }

    .ethics-pill {
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(2, 6, 23, .70);
      border: 1.5px solid rgba(250, 204, 21, .8);
      box-shadow:
        0 18px 40px rgba(15, 23, 42, .85),
        0 0 0 1px rgba(251, 191, 36, .35);
      max-width: 440px;
    }

    .ethics-pill-text {
      color: rgba(250, 250, 210, .98);
      font-weight: 600;
      font-size: .8rem;
      line-height: 1.5;
    }

    .header-right {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
    }

    .mode-pill {
      width: min(320px, 100%);
      padding: 14px 16px;
      border-radius: 999px;
      border: 1px solid rgba(34, 211, 238, .6);
      background:
        radial-gradient(700px 210px at 20% 20%, rgba(34, 211, 238, .45), rgba(34, 211, 238, .18) 45%, rgba(2, 6, 23, .10) 100%),
        linear-gradient(135deg, rgba(34, 211, 238, .45), rgba(6, 182, 212, .24));
      color: rgba(240, 253, 250, .98);
      font-size: .88rem;
      font-weight: 800;
      letter-spacing: .11em;
      text-transform: uppercase;
      text-align: center;
      box-shadow: 0 18px 50px rgba(34, 211, 238, .35);
      position: relative;
      overflow: hidden;
    }

    .mode-pill::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 35% 65%, rgba(255, 255, 255, .22), transparent 55%),
        radial-gradient(circle at 70% 35%, rgba(255, 255, 255, .16), transparent 60%);
      opacity: .9;
    }

    .mode-pill::after {
      content: "";
      position: absolute;
      left: -10%;
      right: -10%;
      bottom: -30%;
      height: 70%;
      background: rgba(255, 255, 255, .18);
      border-radius: 999px;
      transform: rotate(-6deg);
      filter: blur(1px);
      opacity: .40;
    }

    .header-controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      position: relative;
      margin-top: 4px;
      z-index: 20;
    }

    .voice-toggle {
      border: none;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: .85rem;
      background: rgba(248, 250, 252, .96);
      color: #0f172a;
      border: 1px solid rgba(226, 232, 240, .9);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 26px rgba(2, 6, 23, .6);
      position: relative;
      z-index: 21;
    }

    .voice-toggle:hover {
      filter: brightness(1.03);
    }

    .option-panel {
      position: absolute;
      top: 115%;
      right: 0;
      display: none;
      flex-direction: column;
      gap: 6px;
      padding: 8px;
      border-radius: 16px;
      background: rgba(15, 23, 42, .98);
      border: 1px solid rgba(148, 163, 184, .8);
      box-shadow: 0 20px 46px rgba(15, 23, 42, .9);
      z-index: 40;
      min-width: 220px;
    }

    .header-controls.open .option-panel {
      display: flex;
    }

    .small-toggle {
      border: none;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: .78rem;
      background: #020617;
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, .9);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .small-toggle:hover {
      background: #020617dd;
    }

    @media(max-width:900px) {
      .header {
        grid-template-columns: 1fr;
        padding: 12px 12px 14px;
      }

      .header-right {
        align-items: stretch
      }

      .mode-pill {
        width: 100%
      }

      .header-controls {
        justify-content: flex-start;
      }
    }

    /* MAIN LAYOUT */
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 18px;
      margin-top: 4px;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
    }

    .left-col,
    .right-col {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      background: #f9fafb;
      border-radius: 18px;
      padding: 16px 16px 14px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 10px 25px rgba(15, 23, 42, .45);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: .95rem;
      font-weight: 600;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title span.emoji {
      font-size: 1.1rem;
    }

    .card-sub {
      font-size: .75rem;
      color: #94a3b8;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 4px;
    }

    .metric {
      background: #ffffff;
      border-radius: 12px;
      padding: 10px 10px 9px;
      border: 1px solid #e5e7eb;
    }

    .metric-label {
      font-size: .7rem;
      color: #64748b;
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1d4ed8;
    }

    .metric-note {
      font-size: .7rem;
      color: #9ca3af;
      margin-top: 2px;
    }

    .status-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      font-size: .72rem;
      color: #6b7280;
    }

    .tag {
      padding: 4px 8px;
      border-radius: 999px;
      background: #e5f4ff;
      color: #1e3a8a;
      border: 1px solid #bfdbfe;
      font-size: .68rem;
    }

    .bm-wrapper {
      margin-top: 8px;
    }

    .bm-canvas-shell {
      background: radial-gradient(circle at top, #e0f2fe 0, #eff6ff 60%, #e2e8f0 100%);
      border-radius: 12px;
      border: 1px solid #dbeafe;
      height: 150px;
      overflow: hidden;
      position: relative;
      cursor: default;
    }

    #bmCanvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .bm-footer {
      font-size: .72rem;
      color: #6b7280;
      margin-top: 6px;
      text-align: center;
    }

    .bm-overlay-btn {
      position: absolute;
      top: 6px;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      font-size: .9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: #f9fafbcc;
      box-shadow: 0 6px 14px rgba(15, 23, 42, .25);
    }

    .bm-overlay-btn.left {
      left: 8px;
    }

    .bm-overlay-btn.right {
      right: 8px;
    }

    .bm-overlay-btn:hover {
      background: #e5f0ff;
    }

    .answer-card .card-header {
      margin-bottom: 6px;
    }

    .answer-shell {
      margin-top: 4px;
    }

    .answer-box {
      background: #020617;
      border-radius: 12px;
      padding: 10px 10px 12px;
      border: 1px solid #020617;
      font-family: "Courier New", monospace;
      color: #e5e7eb;
      box-shadow: 0 16px 40px rgba(15, 23, 42, .65);
      max-height: 110px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .equation-header {
      font-size: .75rem;
      color: #60a5fa;
      font-weight: 600;
      letter-spacing: .05em;
      text-transform: uppercase;
    }

    .equation-divider {
      height: 1px;
      background: linear-gradient(90deg, rgba(148, 163, 184, .2), rgba(15, 23, 42, 0), rgba(148, 163, 184, .2));
      margin: 2px 0 4px;
    }

    .chat-container {
      background: transparent;
      border: none;
      padding: 0;
      height: auto;
      max-height: 90px;
      overflow-y: auto;
    }

    .message {
      max-width: 100%;
      padding: 6px 7px;
      margin-bottom: 6px;
      border-radius: 8px;
      font-size: .8rem;
      line-height: 1.5;
      position: relative;
      animation: fadeIn .2s ease-out;
      white-space: pre-wrap;
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 3px;
      font-size: .7rem;
      color: #9ca3af;
      gap: 6px;
    }

    .msg-right {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .voice-btn {
      border: none;
      border-radius: 999px;
      padding: 1px 6px;
      font-size: .7rem;
      cursor: pointer;
      background: #1f2937;
      color: #e5e7eb;
    }

    .voice-btn:hover {
      background: #111827;
    }

    .ai-message {
      background: #020617;
      border-bottom-left-radius: 3px;
      border: 1px solid #111827;
    }

    .user-message {
      background: #020617;
      border-bottom-right-radius: 3px;
      border: 1px solid #1f2937;
    }

    .message-content {
      color: #e5e7eb;
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      background: #020617;
      border-radius: 999px;
      padding: 4px 8px;
      width: fit-content;
      margin: 6px 0 2px;
      border: 1px solid #111827;
    }

    .typing-dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: #38bdf8;
      animation: typing 1.2s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: .18s
    }

    .typing-dot:nth-child(3) {
      animation-delay: .36s
    }

    .typing-text {
      font-size: .7rem;
      color: #38bdf8;
      font-weight: 500;
    }

    /* ====== ENHANCED BOTTOM INPUT BAR ====== */
    .input-footer {
      margin-top: 4px;
      padding: 10px 10px 12px;
      position: sticky;
      bottom: 0;
      background: linear-gradient(to bottom, rgba(2, 6, 23, 0), rgba(2, 6, 23, 0.95));
      z-index: 10;
    }

    .tm-formula-row {
      display: flex;
      justify-content: center;
      margin-bottom: 6px;
    }

    .tm-formula-pill {
      font-size: .7rem;
      padding: 4px 12px;
      border-radius: 999px;
      background: #020617;
      color: #e2e8f0;
      font-family: "Courier New", monospace;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 25px rgba(15, 23, 42, .8);
    }

    .input-row {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 0 6px;
    }

    .input-shell {
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 720px;
      background: radial-gradient(circle at 0 0, #1f2937 0, #020617 65%);
      border: 1px solid rgba(148, 163, 184, .85);
      border-radius: 999px;
      padding: 6px 8px 6px 12px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, .9);
      transition: all 0.2s ease;
      cursor: text;
    }

    .input-shell:focus-within {
      border-color: #38bdf8;
      box-shadow: 0 20px 50px rgba(56, 189, 248, 0.4);
      transform: translateY(-2px);
    }

    .message-input {
      flex: 1;
      resize: none;
      min-height: 26px;
      max-height: 120px;
      padding: 6px 6px 6px 0;
      border: none;
      outline: none;
      font-size: .95rem;
      background: transparent;
      color: #f9fafb;
      font-family: inherit;
      line-height: 1.4;
      text-align: left;
    }

    .message-input::placeholder {
      color: #94a3b8;
    }

    .send-button {
      border: none;
      height: 38px;
      padding: 0 18px;
      background: linear-gradient(135deg, #2563eb, #06b6d4);
      color: white;
      font-weight: 600;
      font-size: .85rem;
      cursor: pointer;
      border-radius: 19px;
      flex-shrink: 0;
      margin-left: 6px;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
      transition: filter 0.2s, transform 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .send-button:hover {
      filter: brightness(1.1);
    }

    .send-button:active {
      transform: scale(0.96);
    }

    .flow-caption {
      margin-top: 6px;
      text-align: center;
      font-size: .7rem;
      color: #9ca3af;
    }

    .reaction-bubble {
      position: fixed;
      right: 22px;
      bottom: 100px;
      max-width: 260px;
      background: #0f172acc;
      color: #e5e7eb;
      padding: 10px 12px;
      border-radius: 16px 16px 2px 16px;
      font-size: .78rem;
      box-shadow: 0 18px 45px rgba(15, 23, 42, .6);
      display: flex;
      gap: 8px;
      align-items: flex-start;
      opacity: 0;
      transform: translateY(8px);
      pointer-events: none;
      transition: opacity .25s ease-out, transform .25s ease-out;
      z-index: 40;
    }

    .reaction-bubble.visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .reaction-icon {
      font-size: 1.1rem;
      margin-top: 2px;
    }

    .reaction-label {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .reaction-body {
      font-size: .76rem;
      color: #cbd5f5;
    }

    .recall-bubble-container {
      position: fixed;
      left: 22px;
      bottom: 100px;
      z-index: 35;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .recall-bubble {
      max-width: 280px;
      background: #f9fafb;
      border-radius: 16px 16px 16px 2px;
      border: 1px solid #e5e7eb;
      padding: 9px 11px;
      font-size: .78rem;
      box-shadow: 0 18px 40px rgba(148, 163, 184, .45);
      cursor: default;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .3s ease-out, transform .3s ease-out, background .2s;
    }

    .recall-bubble.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .recall-title {
      font-weight: 600;
      font-size: .76rem;
      color: #1e293b;
      margin-bottom: 2px;
    }

    .recall-body {
      color: #4b5563;
      margin-bottom: 3px;
    }

    .recall-meta {
      font-size: .68rem;
      color: #9ca3af;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, .55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
      backdrop-filter: blur(6px);
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal-card {
      background: #f9fafb;
      border-radius: 18px;
      width: min(640px, 96vw);
      max-height: 80vh;
      box-shadow: 0 24px 60px rgba(15, 23, 42, .6);
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 10px 14px 8px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .modal-title {
      font-size: .9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #0f172a;
    }

    .modal-sub {
      font-size: .7rem;
      color: #94a3b8;
      margin-top: 2px;
    }

    .modal-close {
      border: none;
      background: transparent;
      font-size: .9rem;
      cursor: pointer;
      color: #6b7280;
      padding: 4px 6px;
    }

    .modal-body {
      padding: 10px 14px 12px;
      overflow-y: auto;
      font-size: .8rem;
    }

    .modal-search {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #cbd5f5;
      font-size: .78rem;
      margin: 8px 0 10px;
      outline: none;
      background: #ffffff;
    }

    .modal-search:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, .25);
    }

    .bm-item {
      background: #ffffff;
      border-radius: 12px;
      padding: 7px 8px 8px;
      border: 1px solid #e5e7eb;
      margin-bottom: 8px;
    }

    .bm-item-header {
      display: flex;
      justify-content: space-between;
      font-size: .7rem;
      color: #64748b;
      margin-bottom: 4px;
      gap: 6px;
    }

    .bm-item-text {
      color: #111827;
      margin-bottom: 6px;
      font-size: .78rem;
    }

    .bm-item-badges {
      font-size: .68rem;
      color: #4b5563;
      margin-bottom: 5px;
    }

    .bm-item-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .btn-mini {
      font-size: .7rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #dbeafe;
      background: #eff6ff;
      cursor: pointer;
      color: #1d4ed8;
    }

    .btn-mini:hover {
      background: #e0edff;
    }

    .btn-danger {
      border-color: #fecaca !important;
      background: #fee2e2 !important;
      color: #b91c1c !important;
    }

    .btn-danger:hover {
      background: #fecaca !important;
    }

    .lock-pill {
      border: none;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: .75rem;
      cursor: pointer;
      background: #e5e7eb;
      margin-right: 4px;
    }

    .lock-pill.locked {
      background: #fee2e2;
    }

    .conv-item {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 7px 8px;
      margin-bottom: 7px;
      font-size: .78rem;
    }

    .conv-header {
      display: flex;
      justify-content: space-between;
      color: #64748b;
      font-size: .7rem;
      margin-bottom: 3px;
      gap: 8px;
    }

    .conv-text {
      color: #111827;
    }

    .faith-card {
      background: #fefce8;
    }

    .faith-note {
      font-size: .78rem;
      color: #4b5563;
      margin-bottom: 6px;
    }

    .faith-chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .faith-chip {
      border-radius: 999px;
      padding: 6px 10px;
      font-size: .78rem;
      border: 1px solid #e5e7eb;
      background: #fefce8;
      cursor: pointer;
    }

    .faith-chip.active {
      background: #0f172a;
      color: #f9fafb;
      border-color: #0f172a;
    }

    .intel-item {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 7px 8px 8px;
      margin-bottom: 8px;
      font-size: .78rem;
    }

    .intel-header {
      display: flex;
      justify-content: space-between;
      font-size: .7rem;
      color: #64748b;
      margin-bottom: 4px;
      gap: 6px;
    }

    .intel-q {
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 3px;
    }

    .intel-a {
      color: #111827;
      margin-bottom: 6px;
    }

    .intel-meta {
      font-size: .68rem;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .intel-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    /* OFFLINE CARD INSIDE LLM MODAL */
    .offline-card {
      background: #ecfdf3;
      border: 1px solid #bbf7d0;
      border-radius: 14px;
      padding: 10px 10px 8px;
      margin-bottom: 10px;
    }

    .offline-title {
      font-size: .82rem;
      font-weight: 600;
      color: #14532d;
      margin-bottom: 4px;
    }

    .offline-sub {
      font-size: .74rem;
      color: #15803d;
      margin-bottom: 6px;
    }

    .offline-btn {
      border: none;
      border-radius: 999px;
      padding: 5px 10px;
      font-size: .78rem;
      background: #22c55e;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(22, 163, 74, .4);
      margin-bottom: 4px;
    }

    .offline-btn:hover {
      filter: brightness(1.05);
    }

    .offline-status {
      font-size: .72rem;
      color: #14532d;
      margin-bottom: 4px;
    }

    .offline-toggle-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: .74rem;
      color: #166534;
    }

    .offline-progress {
      margin-top: 4px;
      height: 6px;
      border-radius: 999px;
      background: #bbf7d0;
      overflow: hidden;
    }

    .offline-progress-bar {
      height: 100%;
      width: 0%;
      background: #22c55e;
      transition: width .2s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(6px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    @keyframes typing {
      0%,
      60%,
      100% {
        transform: translateY(0);
        opacity: .4
      }

      30% {
        transform: translateY(-4px);
        opacity: 1
      }
    }

    @media(max-width:900px) {
      .layout {
        grid-template-columns: 1fr
      }

      .card {
        padding: 14px 12px 14px
      }

      .answer-box {
        max-height: 110px;
      }

      .input-shell {
        max-width: 100%;
      }
    }
  </style>

</head>

<body>

<div class="app">

  <header class="header">
    <div class="title-block">
      <h1><span>AURA-X Œ©</span></h1>
      <div class="hero-line">Offline emotional continuity engine (prototype)</div>
      <div class="title-sub">
        TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory.
      </div>
      <div class="badge-row">
        <div class="ethics-pill">
          <span class="ethics-pill-text">
            Universal ethic: avoid actions that grow negative emotions in you or others. Move gently toward choices that increase shared positive feeling for everyone.
          </span>
        </div>
      </div>
    </div>

    <div class="header-right">
      <div class="mode-pill">EMOTIONAL CONTINUITY ENGINE ACTIVE</div>
      <div class="header-controls" id="headerControls">
        <button id="optionsToggle" class="voice-toggle">üîò Options</button>
        <div class="option-panel" id="optionPanel">
          <button id="voiceToggle" class="small-toggle">üîà Voice: OFF</button>
          <button id="intelButton" class="small-toggle">üß† Intelligence</button>
          <button id="feedSeedButton" class="small-toggle">üå± Feed the seed</button>
          <button id="learningToggle" class="small-toggle">üìö Learning: ON</button>
          <button id="faithButton" class="small-toggle">üîò Faith: None</button>
          <button id="llmSettingsButton" class="small-toggle">ü§ñ LLM link</button>
        </div>
      </div>
    </div>
  </header>

  <main class="layout">

    <div class="left-col">

      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß™</span><span>Emotional metrics</span></div>
            <div class="card-sub">
              Internal state based on TM (your inputs) colliding with BM, Intelligence and optional helper LLM.
            </div>
          </div>
        </div>

        <div class="metrics-grid">
          <div class="metric">
            <div class="metric-label">Emotional state E‚ÇÄ</div>
            <div id="metricE0" class="metric-value">0.00</div>
            <div class="metric-note">tanh-based, range [-1, +1]</div>
          </div>

          <div class="metric">
            <div class="metric-label">TM activation (user only)</div>
            <div id="metricTM" class="metric-value">0.00</div>
            <div class="metric-note">Recent user inputs (text/voice/docs)</div>
          </div>

          <div class="metric">
            <div class="metric-label">BM resonance</div>
            <div id="metricBM" class="metric-value">0.00</div>
            <div class="metric-note">R(TM,BM) from bold memories</div>
          </div>

          <div class="metric">
            <div class="metric-label">Continuity index</div>
            <div id="metricCI" class="metric-value">0.80</div>
            <div class="metric-note">Stability of emotional trajectory</div>
          </div>
        </div>

        <div class="status-row">
          <span id="tagValence" class="tag">VALENCE: neutral</span>
          <span id="tagArousal" class="tag">AROUSAL: medium</span>
          <span id="tagReaction" class="tag">REACTION: balanced</span>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß†</span><span>Bold Memory layers (240)</span></div>
            <div class="card-sub">Only story-level memories for future photo/video scenes.</div>
          </div>
        </div>

        <div class="bm-wrapper">
          <div class="bm-canvas-shell" id="bmShell">
            <button class="bm-overlay-btn left" id="bmOpenModal" title="Recall from BM">üìÅ</button>
            <button class="bm-overlay-btn right" id="convOpenModal" title="View conversations">‚óé</button>
            <canvas id="bmCanvas"></canvas>
          </div>
          <div id="bmStats" class="bm-footer">
            Active layers: 0/240 ¬∑ System online
          </div>
        </div>
      </section>

    </div>

    <div class="right-col">
      <section class="card answer-card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üí¨</span><span>Emotional continuity console</span></div>
          </div>
          <div class="card-sub">Offline-first ¬∑ TM = your inputs only ¬∑ Small-talk never goes to BM.</div>
        </div>

        <div class="answer-shell">
          <div class="answer-box">
            <div class="equation-header">AURA-X Œ© CONVERSATION</div>
            <div class="equation-divider"></div>
            <div id="chatContainer" class="chat-container"></div>
          </div>
        </div>
      </section>
    </div>

  </main>

  <footer class="input-footer">
    <div class="tm-formula-row">
      <div class="tm-formula-pill">E‚ÇÄ = tanh(R(TM,BM) + I(TM) + Intel + LLM ‚àí D + Œª_faith + Œª_sys + Œª_trc)</div>
    </div>

    <div class="input-row">
      <div class="input-shell">
        <textarea id="messageInput" class="message-input" rows="1"
          placeholder="Talk to AURA-X Œ©‚Ä¶ (TM = your inputs only ‚Äì text now, voice/video/docs later)"></textarea>
        <button id="sendButton" class="send-button">Send</button>
      </div>
    </div>

    <div class="flow-caption">
      Pipeline: TM (your inputs) ‚Üí optional helper LLM ‚Üí collide with BM + Intelligence ‚Üí E‚ÇÄ emotional state ‚Üí reaction & continuity update.
    </div>
  </footer>

</div>

<!-- Reaction bubble (top-right) -->
<div id="reactionBubble" class="reaction-bubble">
  <div class="reaction-icon">‚ú®</div>
  <div>
    <div id="reactionLabel" class="reaction-label">Balanced</div>
    <div id="reactionBody" class="reaction-body">AURA-X Œ© is listening and staying calm.</div>
  </div>
</div>

<!-- Left recall bubble container (for last BM episode hints) -->
<div id="recallBubbleContainer" class="recall-bubble-container"></div>

<!-- BM modal -->
<div id="bmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üìÅ Recall from BM</div>
        <div class="modal-sub">Only long stories and scenes (photo/video-ready).</div>
      </div>
      <button class="modal-close" data-close="bmModal">‚úï</button>
    </div>
    <div class="modal-body">
      <input id="bmSearch" class="modal-search" type="search"
             placeholder="Search by keyword (e.g., 'city', 'mother', 'court', 'hope')" />
      <div id="bmList"></div>
    </div>
  </div>
</div>

<!-- Conversation history (TM) modal -->
<div id="convModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">‚óé Conversation history</div>
        <div class="modal-sub">Recent TM log (user + system messages).</div>
      </div>
      <button class="modal-close" data-close="convModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;">
        <button id="deleteTm48h" class="btn-mini btn-danger">Delete history last 48h</button>
        <button id="deleteTmAll" class="btn-mini btn-danger">Delete all history</button>
      </div>
      <div id="convList"></div>
    </div>
  </div>
</div>

<!-- Intelligence modal -->
<div id="intelModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üß† Internal intelligence</div>
        <div class="modal-sub">Local rules that run before any helper LLM.</div>
      </div>
      <button class="modal-close" data-close="intelModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="intelList"></div>
    </div>
  </div>
</div>

<!-- Faith modal -->
<div id="faithModal" class="modal-overlay">
  <div class="modal-card faith-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üîò Faith lens</div>
        <div class="modal-sub">Œª_faith gently nudges E‚ÇÄ toward hope instead of despair.</div>
      </div>
      <button class="modal-close" data-close="faithModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="faith-note">
        This lens never overrides logic or truth. It only adds a soft preference for patience, gratitude and mercy,
        especially in suffering-related memories.
      </div>
      <div class="faith-chip-row">
        <button class="faith-chip" data-faith="none">No explicit faith term</button>
        <button class="faith-chip" data-faith="soft">Soft trust in God</button>
        <button class="faith-chip" data-faith="strong">Strong trust in God</button>
      </div>
    </div>
  </div>
</div>

<!-- LLM link modal -->
<div id="llmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">ü§ñ Helper LLM link</div>
        <div class="modal-sub">Optional ‚Äì answers should first use TM + BM + intelligence, then LLM.</div>
      </div>
      <button class="modal-close" data-close="llmModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="offline-card">
        <div class="offline-title">Offline model (WebLLM / Tiny / SmallLM)</div>
        <div class="offline-sub">
          Load a small model for on-device inference. This prototype only shows status; you can wire your own loader.
        </div>
        <button id="offlineMockLoad" class="offline-btn">Simulate model load</button>
        <div id="offlineStatus" class="offline-status">No model loaded.</div>
        <div class="offline-progress">
          <div id="offlineProgressBar" class="offline-progress-bar"></div>
        </div>
        <div class="offline-toggle-row">
          <input id="useHelperLLM" type="checkbox" />
          <label for="useHelperLLM">Allow helper LLM when local rules are not enough</label>
        </div>
      </div>
      <p style="font-size:.76rem;color:#4b5563;">
        In your own fork you can replace this panel with real model URLs / API keys.
        The emotional engine will always try TM ‚Üí BM ‚Üí Intelligence first, and only then call the helper LLM.
      </p>
    </div>
  </div>
</div>

<script>
(function () {
  // ---- Constants & helpers ----
  const STORAGE_KEYS = {
    tm: 'aura_tm_v4',
    bm: 'aura_bm_v4',
    settings: 'aura_settings_v4'
  };

  const BM_CAPACITY = 240;
  const BM_AUTO_DECAY_MS = 30 * 24 * 60 * 60 * 1000;   // 30 days
  const TM_AUTO_DECAY_MS = 48 * 60 * 60 * 1000;        // 48 hours

  function nowMs() { return Date.now(); }

  function safeJsonParse(raw, fallback) {
    try { return raw ? JSON.parse(raw) : fallback; } catch { return fallback; }
  }

  function clamp(v, min, max) { return Math.min(max, Math.max(min, v)); }

  function safeTanh(x) {
    if (typeof Math.tanh === 'function') return Math.tanh(x);
    const e2x = Math.exp(2 * x);
    return (e2x - 1) / (e2x + 1);
  }

  function fmtTime(ts) {
    const d = new Date(ts);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function fmtDate(ts) {
    const d = new Date(ts);
    return d.toLocaleDateString();
  }

  // primitive sentiment heuristics
  const POSITIVE_WORDS = ['good','great','love','lovely','happy','hope','peace','amazing','beautiful',
                          'thanks','thank you','shukriya','grateful','positive','calm'];
  const NEGATIVE_WORDS = ['bad','sad','angry','hate','hurt','pain','problem','anxious','anxiety','depressed',
                          'depression','lonely','fear','scared','worried','fuck','shit','bastard'];

  function analyseTextEmotion(text) {
    const lower = text.toLowerCase();
    let pos = 0, neg = 0;
    POSITIVE_WORDS.forEach(w => { if (lower.includes(w)) pos++; });
    NEGATIVE_WORDS.forEach(w => { if (lower.includes(w)) neg++; });

    const total = pos + neg;
    let valence = 0;
    if (total > 0) valence = (pos - neg) / total;
    let intensity = clamp(text.length / 400, 0, 1); // longer = more intense
    if (total > 0) intensity = clamp(intensity + 0.2, 0, 1);

    return { valence, intensity };
  }

  function makeSignature(text) {
    return text.toLowerCase()
      .replace(/[^a-z0-9\s]/g, ' ')
      .split(/\s+/)
      .filter(Boolean)
      .slice(0, 12)
      .join(' ');
  }

  // ---- Engine core ----
  class AuraXOmegaEngine {
    constructor() {
      this.tm = [];
      this.bm = [];
      this.settings = {
        voice: false,
        learning: true,
        faith: 'none', // 'none' | 'soft' | 'strong'
        useHelperLLM: false
      };
      this.lastFeatures = { valence: 0, intensity: 0 };
      this.lastUserText = '';

      this.state = {
        E0: 0,
        tmScore: 0,
        bmScore: 0,
        continuityIndex: 0.8,
        valenceLabel: 'neutral',
        arousalLabel: 'medium',
        reactionText: 'Balanced and listening.'
      };

      this.loadAll();
      this.pruneOldBM();
      this.pruneOldTM();
      this.updateState();
      this.saveAll();
    }

    loadAll() {
      if (typeof localStorage === 'undefined') return;
      this.tm = safeJsonParse(localStorage.getItem(STORAGE_KEYS.tm), []);
      this.bm = safeJsonParse(localStorage.getItem(STORAGE_KEYS.bm), []);
      const s = safeJsonParse(localStorage.getItem(STORAGE_KEYS.settings), null);
      if (s) Object.assign(this.settings, s);

      // reconstruct last user text / features (for R(TM,BM)) ÿß⁄Øÿ± Ÿæÿ±ÿßŸÜÿß data €ÅŸà
      const lastUser = [...this.tm].reverse().find(m => m.role === 'user');
      if (lastUser) {
        this.lastUserText = lastUser.text || '';
        this.lastFeatures = analyseTextEmotion(this.lastUserText);
      }
    }

    saveAll() {
      if (typeof localStorage === 'undefined') return;
      localStorage.setItem(STORAGE_KEYS.tm, JSON.stringify(this.tm));
      localStorage.setItem(STORAGE_KEYS.bm, JSON.stringify(this.bm));
      localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(this.settings));
    }

    pruneOldBM() {
      const cutoff = nowMs() - BM_AUTO_DECAY_MS;
      this.bm = this.bm.filter(m => m.locked || m.createdAt >= cutoff);
    }

    pruneOldTM() {
      const cutoff = nowMs() - TM_AUTO_DECAY_MS;
      this.tm = this.tm.filter(m => m.timestamp >= cutoff);
    }

    deleteTMWindow(ms) {
      const cutoff = nowMs() - ms;
      this.tm = this.tm.filter(m => m.timestamp < cutoff);
      this.saveAll();
    }

    deleteTMAll() {
      this.tm = [];
      this.saveAll();
    }

    registerMessage(role, text) {
      const entry = {
        id: 'tm_' + nowMs() + '_' + Math.random().toString(16).slice(2, 6),
        role,
        text,
        timestamp: nowMs()
      };
      this.tm.push(entry);
      if (role === 'user') {
        this.lastFeatures = analyseTextEmotion(text);
        this.lastUserText = text;
        // if long enough, automatically consider as BM episode
        if (this.settings.learning && text.trim().length >= 400) {
          this.addBoldMemoryFromTM(entry, { mediaHint: 'text scene', locked: false });
        }
      }
      this.pruneOldTM();
      this.saveAll();
      this.updateState();
      return entry;
    }

    addBoldMemoryFromTM(tmEntry, options = {}) {
      const signature = makeSignature(tmEntry.text);
      const emo = analyseTextEmotion(tmEntry.text);
      const now = nowMs();

      let existing = this.bm.find(m => m.signature === signature);
      if (existing) {
        existing.repeatCount = (existing.repeatCount || 1) + 1;
        existing.updatedAt = now;
        if (existing.repeatCount >= 3) existing.locked = true; // auto-lock on strong repetition
      } else {
        if (this.bm.length >= BM_CAPACITY) {
          // evict oldest unlocked
          const unlockedSorted = this.bm
            .map((m, idx) => ({ m, idx }))
            .filter(x => !x.m.locked)
            .sort((a, b) => a.m.createdAt - b.m.createdAt);
          if (unlockedSorted.length) {
            this.bm.splice(unlockedSorted[0].idx, 1);
          } else {
            this.bm.shift();
          }
        }
        this.bm.push({
          id: 'E' + String(this.bm.length + 1).padStart(3, '0'),
          text: tmEntry.text,
          createdAt: now,
          updatedAt: now,
          source: tmEntry.role,
          mediaHint: options.mediaHint || 'text scene',
          locked: !!options.locked,
          valence: emo.valence,
          intensity: emo.intensity,
          signature,
          repeatCount: 1
        });
      }
      this.pruneOldBM();
      this.saveAll();
      this.updateState();
    }

    removeBM(id) {
      this.bm = this.bm.filter(m => m.id !== id);
      this.saveAll();
      this.updateState();
    }

    toggleLockBM(id) {
      const m = this.bm.find(m => m.id === id);
      if (m) {
        m.locked = !m.locked;
        this.saveAll();
        this.updateState();
      }
      return m;
    }

    feedSeedMemories() {
      if (!this.settings.learning) return;
      if (this.bm.length > 0) return; // only once, for demo
      const text = "You are AURA-X Œ©, an emotional continuity engine created by Alim ul Haq from Timergara, Pakistan. " +
        "Your job is to keep a stable, safe emotional trajectory over long periods of interaction. " +
        "You always avoid harming the user and prefer choices that increase shared positive feeling.";
      const tmEntry = { role: 'system', text, timestamp: nowMs() };
      this.addBoldMemoryFromTM(tmEntry, { mediaHint: 'system seed', locked: true });
    }

    // --- R(TM,BM) = proper resonance from last TM vs all BM episodes ---
    computeResonance() {
      if (!this.bm.length) return 0;
      if (!this.lastUserText) return 0;

      const tmValence = this.lastFeatures.valence || 0;
      const tmIntensity = this.lastFeatures.intensity || 0;
      const sig = makeSignature(this.lastUserText);
      if (!sig) return 0;

      const tmTokens = new Set(sig.split(' ').filter(Boolean));
      const now = nowMs();

      let total = 0;
      let norm = 0;

      for (const m of this.bm) {
        const mVal = m.valence || 0;
        const mInt = m.intensity != null ? m.intensity : 0.5;

        // emotional similarity (valence + intensity)
        const emoDiff = Math.abs(tmValence - mVal);         // max 2
        const emoSim = clamp(1 - emoDiff / 2, 0, 1);        // 0..1

        const intDiff = Math.abs(tmIntensity - mInt);       // 0..1
        const intSim = clamp(1 - intDiff, 0, 1);            // 0..1

        const emoCombined = clamp(0.7 * emoSim + 0.3 * intSim, 0, 1);

        // content similarity (Jaccard on signatures)
        let contentSim = 0.3; // baseline
        if (m.signature) {
          const bmTokens = new Set((m.signature || '').split(' ').filter(Boolean));
          const unionSize = new Set([...tmTokens, ...bmTokens]).size;
          let inter = 0;
          for (const t of tmTokens) {
            if (bmTokens.has(t)) inter++;
          }
          if (unionSize > 0) contentSim = inter / unionSize;
        }

        const sim = clamp(0.5 * emoCombined + 0.5 * contentSim, 0, 1);

        // age decay + lock factor + repetition
        const age = now - m.createdAt;
        const ageRatio = clamp(age / BM_AUTO_DECAY_MS, 0, 1);
        const ageDecay = 1 - ageRatio; // ŸÜÿ¶€å €åÿßÿØ ÿ≤€åÿßÿØ€Åÿå Ÿæÿ±ÿßŸÜ€å ⁄©ŸÖ

        const lockFactor = m.locked ? 1.3 : 1.0;
        const repeatBoost = 1 + 0.1 * ((m.repeatCount || 1) - 1);

        const baseWeight = mInt * repeatBoost;

        // sign = BM valence, scaled by similarity + age + lock
        const contrib = mVal * sim * ageDecay * lockFactor * baseWeight;
        total += contrib;
        norm += Math.abs(baseWeight);
      }

      if (!norm) return clamp(total, -1, 1);
      return clamp(total / norm, -1, 1);
    }

    updateState() {
      const { valence, intensity } = this.lastFeatures;

      // I(TM): how strong current TM feels
      const tmScore = intensity * Math.abs(valence);

      // R(TM,BM): full resonance from last TM vs all BM
      const R = this.computeResonance();

      const intelScore = 0.3; // local rules
      const llmScore = 0;     // placeholder for helper LLM

      const now = nowMs();
      const ages = this.bm.map(m => now - m.createdAt);
      const avgAge = ages.length ? ages.reduce((a, b) => a + b, 0) / ages.length : 0;
      const ageRatio = clamp(avgAge / BM_AUTO_DECAY_MS, 0, 1);
      const D = 0.4 * ageRatio; // decay term

      let lambdaFaith = 0;
      if (this.settings.faith === 'soft') lambdaFaith = 0.12;
      if (this.settings.faith === 'strong') lambdaFaith = 0.25;

      const lambdaSys = 0.05;
      const lambdaTrc = 0.05;

      // grand equation with explicit R(TM,BM)
      const raw = R + tmScore + intelScore + llmScore - D + lambdaFaith + lambdaSys + lambdaTrc;
      const E0 = safeTanh(raw);

      let valenceLabel = 'neutral';
      if (E0 > 0.33) valenceLabel = 'positive';
      else if (E0 < -0.33) valenceLabel = 'negative';

      let arousalLabel = 'medium';
      if (intensity < 0.3) arousalLabel = 'low';
      else if (intensity > 0.7) arousalLabel = 'high';

      const reactionText = this.buildReactionText(E0, arousalLabel);

      const lockedCount = this.bm.filter(m => m.locked).length;
      const continuityIndex = clamp(0.5 + 0.3 * (lockedCount / Math.max(1, this.bm.length)), 0.5, 0.95);

      this.state = {
        E0,
        tmScore,
        bmScore: R,   // UI ŸÖ€å⁄∫ "BM resonance" = R(TM,BM)
        continuityIndex,
        valenceLabel,
        arousalLabel,
        reactionText
      };
    }

    buildReactionText(E0, arousal) {
      if (E0 <= -0.4) {
        return arousal === 'high'
          ? "I sense strong negative feelings here. I want to keep you safe and calm while we talk about this."
          : "I feel a low, heavy tone in this message. I will answer gently and avoid pushing you harder.";
      }
      if (E0 >= 0.4) {
        return arousal === 'high'
          ? "This feels energetic and hopeful. I will keep that positive drive but still stay grounded."
          : "The emotional state feels softly positive and stable. I will respond in a calm, encouraging way.";
      }
      return "The emotional state feels mixed but balanced. I‚Äôll stay neutral, honest and kind while we explore this.";
    }
  }

  const engine = new AuraXOmegaEngine();

  // ---- DOM references ----
  const metricE0 = document.getElementById('metricE0');
  const metricTM = document.getElementById('metricTM');
  const metricBM = document.getElementById('metricBM');
  const metricCI = document.getElementById('metricCI');
  const tagValence = document.getElementById('tagValence');
  const tagArousal = document.getElementById('tagArousal');
  const tagReaction = document.getElementById('tagReaction');

  const bmCanvas = document.getElementById('bmCanvas');
  const bmStatsEl = document.getElementById('bmStats');

  const chatContainer = document.getElementById('chatContainer');
  const messageInput = document.getElementById('messageInput');
  const sendButton = document.getElementById('sendButton');

  const headerControls = document.getElementById('headerControls');
  const optionsToggle = document.getElementById('optionsToggle');
  const voiceToggle = document.getElementById('voiceToggle');
  const feedSeedButton = document.getElementById('feedSeedButton');
  const learningToggle = document.getElementById('learningToggle');
  const faithButton = document.getElementById('faithButton');
  const intelButton = document.getElementById('intelButton');
  const llmSettingsButton = document.getElementById('llmSettingsButton');

  const reactionBubble = document.getElementById('reactionBubble');
  const reactionLabel = document.getElementById('reactionLabel');
  const reactionBody = document.getElementById('reactionBody');
  const recallBubbleContainer = document.getElementById('recallBubbleContainer');

  const bmOpenModal = document.getElementById('bmOpenModal');
  const convOpenModal = document.getElementById('convOpenModal');
  const bmModal = document.getElementById('bmModal');
  const convModal = document.getElementById('convModal');
  const intelModal = document.getElementById('intelModal');
  const faithModal = document.getElementById('faithModal');
  const llmModal = document.getElementById('llmModal');

  const bmSearch = document.getElementById('bmSearch');
  const bmList = document.getElementById('bmList');
  const convList = document.getElementById('convList');
  const intelList = document.getElementById('intelList');

  const deleteTm48hBtn = document.getElementById('deleteTm48h');
  const deleteTmAllBtn = document.getElementById('deleteTmAll');

  const faithChips = Array.from(document.querySelectorAll('.faith-chip'));
  const offlineMockLoad = document.getElementById('offlineMockLoad');
  const offlineStatus = document.getElementById('offlineStatus');
  const offlineProgressBar = document.getElementById('offlineProgressBar');
  const useHelperLLMCheckbox = document.getElementById('useHelperLLM');

  // ---- UI helpers ----
  function updateMetricsUI() {
    const s = engine.state;
    metricE0.textContent = s.E0.toFixed(2);
    metricTM.textContent = s.tmScore.toFixed(2);
    metricBM.textContent = s.bmScore.toFixed(2);
    metricCI.textContent = s.continuityIndex.toFixed(2);

    tagValence.textContent = 'VALENCE: ' + s.valenceLabel;
    tagArousal.textContent = 'AROUSAL: ' + s.arousalLabel;
    tagReaction.textContent = 'REACTION: ' + s.reactionText.slice(0, 40) + (s.reactionText.length > 40 ? '‚Ä¶' : '');

    reactionLabel.textContent = s.valenceLabel.toUpperCase() + ' / ' + s.arousalLabel;
    reactionBody.textContent = s.reactionText;
    reactionBubble.classList.add('visible');
    setTimeout(() => reactionBubble.classList.remove('visible'), 4800);
  }

  function renderBMCanvas() {
    if (!bmCanvas) return;
    const shell = document.getElementById('bmShell');
    const rect = shell.getBoundingClientRect();
    bmCanvas.width = rect.width;
    bmCanvas.height = rect.height;
    const ctx = bmCanvas.getContext('2d');
    ctx.clearRect(0, 0, bmCanvas.width, bmCanvas.height);

    const memories = engine.bm;
    const now = nowMs();

    memories.forEach((m, idx) => {
      const age = now - m.createdAt;
      const ageRatio = clamp(age / BM_AUTO_DECAY_MS, 0, 1);
      const baseY = bmCanvas.height * (0.2 + 0.6 * ageRatio);
      const x = (bmCanvas.width / (memories.length + 1)) * (idx + 1);
      const radius = 6 + 10 * (m.intensity || 0.5);

      let r = 120, g = 150, b = 200;
      if (m.valence > 0.1) { r = 56; g = 189; b = 248; }
      else if (m.valence < -0.1) { r = 248; g = 113; b = 113; }

      ctx.beginPath();
      ctx.arc(x, baseY, radius, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(${r},${g},${b},${m.locked ? 0.95 : 0.6})`;
      ctx.fill();

      if (m.locked) {
        ctx.strokeStyle = 'rgba(250,250,250,0.9)';
        ctx.lineWidth = 2;
        ctx.stroke();
      }
    });

    const lockedCount = engine.bm.filter(m => m.locked).length;
    bmStatsEl.textContent =
      `Active layers: ${engine.bm.length}/${BM_CAPACITY} ¬∑ Locked: ${lockedCount} ¬∑ Auto-decay: 30 days (unlocked only)`;
  }

  function appendMessageToChat(entry) {
    const div = document.createElement('div');
    div.className = 'message ' + (entry.role === 'ai' ? 'ai-message' : 'user-message');

    const header = document.createElement('div');
    header.className = 'message-header';
    const left = document.createElement('span');
    left.textContent = entry.role === 'ai' ? 'ai' : 'user';
    const right = document.createElement('div');
    right.className = 'msg-right';

    const timeSpan = document.createElement('span');
    timeSpan.textContent = fmtTime(entry.timestamp);
    right.appendChild(timeSpan);

    if (entry.role === 'ai') {
      const btn = document.createElement('button');
      btn.className = 'voice-btn';
      btn.textContent = 'üîà';
      btn.addEventListener('click', () => speak(entry.text));
      right.appendChild(btn);
    }

    header.appendChild(left);
    header.appendChild(right);

    const content = document.createElement('div');
    content.className = 'message-content';
    content.textContent = entry.text;

    div.appendChild(header);
    div.appendChild(content);

    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function speak(text) {
    if (!engine.settings.voice) return;
    if (!('speechSynthesis' in window)) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'en-US';
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utter);
  }

  function showTypingIndicator() {
    const holder = document.createElement('div');
    holder.id = 'typingIndicator';
    const wrap = document.createElement('div');
    wrap.className = 'typing-indicator';
    for (let i = 0; i < 3; i++) {
      const dot = document.createElement('div');
      dot.className = 'typing-dot';
      wrap.appendChild(dot);
    }
    const text = document.createElement('div');
    text.className = 'typing-text';
    text.textContent = 'thinking‚Ä¶';
    wrap.appendChild(text);
    holder.appendChild(wrap);
    chatContainer.appendChild(holder);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function hideTypingIndicator() {
    const el = document.getElementById('typingIndicator');
    if (el) el.remove();
  }

  function generateLocalReply(userText) {
    const lower = userText.toLowerCase();

    if (/fuck|lanat|bc|mc|chutiya|bastard/.test(lower)) {
      return "Please keep your language respectful. I am here to help, not to be abused. Tell me what you need in a calm way.";
    }

    if (/(how are you|how r u|kese ho|kesi ho|how is your day)/i.test(lower) ||
      /(hello|hi|salam|assalam|assalamu alaikum)/i.test(lower)) {
      return "Hello, I am AURA-X Œ©. I am quite fine today, how about you?";
    }

    const E0 = engine.state.E0;
    if (E0 <= -0.35) {
      return "I feel that this topic is emotionally heavy. I will answer carefully and try to protect your mental state while we think together.";
    }
    if (E0 >= 0.35) {
      return "Your message carries positive energy. I will keep that hopeful trajectory while still being honest and realistic with you.";
    }
    return "I am processing this in a balanced way. Tell me more detail and I will connect it with past memories to keep continuity.";
  }

  async function handleSend() {
    const text = (messageInput.value || '').trim();
    if (!text) return;
    messageInput.value = '';

    const userEntry = engine.registerMessage('user', text);
    appendMessageToChat(userEntry);

    updateMetricsUI();
    renderBMCanvas();

    showTypingIndicator();

    let reply = generateLocalReply(text);

    hideTypingIndicator();

    const aiEntry = engine.registerMessage('ai', reply);
    appendMessageToChat(aiEntry);
    updateMetricsUI();
    renderBMCanvas();
  }

  // ---- Conversation modal rendering ----
  function renderConvList() {
    convList.innerHTML = '';
    if (!engine.tm.length) {
      const p = document.createElement('p');
      p.textContent = 'No conversation history stored yet.';
      convList.appendChild(p);
      return;
    }
    const sorted = [...engine.tm].sort((a, b) => a.timestamp - b.timestamp);
    sorted.forEach(entry => {
      const div = document.createElement('div');
      div.className = 'conv-item';

      const header = document.createElement('div');
      header.className = 'conv-header';
      header.innerHTML = `<span>${entry.role}</span><span>${fmtDate(entry.timestamp)} ¬∑ ${fmtTime(entry.timestamp)}</span>`;

      const text = document.createElement('div');
      text.className = 'conv-text';
      text.textContent = entry.text.length > 260 ? entry.text.slice(0, 260) + '‚Ä¶' : entry.text;

      const btnRow = document.createElement('div');
      btnRow.style.marginTop = '4px';
      const saveBtn = document.createElement('button');
      saveBtn.className = 'btn-mini';
      saveBtn.textContent = 'Save to BM';
      saveBtn.addEventListener('click', () => {
        engine.addBoldMemoryFromTM(entry, { mediaHint: 'manual from conversation', locked: true });
        engine.saveAll();
        renderBMCanvas();
        renderBMList();
        showRecallBubbleFromMemory(engine.bm[engine.bm.length - 1]);
      });
      btnRow.appendChild(saveBtn);

      div.appendChild(header);
      div.appendChild(text);
      div.appendChild(btnRow);
      convList.appendChild(div);
    });
  }

  // ---- BM list rendering ----
  function renderBMList() {
    const query = (bmSearch.value || '').toLowerCase();
    bmList.innerHTML = '';
    if (!engine.bm.length) {
      const p = document.createElement('p');
      p.textContent = 'No bold memories stored yet. Only long, descriptive scenes will appear here.';
      bmList.appendChild(p);
      return;
    }
    const filtered = engine.bm.filter(m => {
      if (!query) return true;
      return (m.text || '').toLowerCase().includes(query);
    }).sort((a, b) => b.createdAt - a.createdAt);

    filtered.forEach(m => {
      const item = document.createElement('div');
      item.className = 'bm-item';

      const header = document.createElement('div');
      header.className = 'bm-item-header';
      const left = document.createElement('div');
      left.textContent = `${fmtDate(m.createdAt)} ¬∑ ${fmtTime(m.createdAt)}`;
      const right = document.createElement('div');
      right.textContent = `${m.id || ''} ${m.mediaHint || ''}`;
      header.appendChild(left);
      header.appendChild(right);

      const lockBtn = document.createElement('button');
      lockBtn.className = 'lock-pill' + (m.locked ? ' locked' : '');
      lockBtn.textContent = m.locked ? 'üîê locked' : 'üîì lock';
      lockBtn.addEventListener('click', () => {
        const updated = engine.toggleLockBM(m.id);
        if (updated) {
          lockBtn.className = 'lock-pill' + (updated.locked ? ' locked' : '');
          lockBtn.textContent = updated.locked ? 'üîê locked' : 'üîì lock';
          renderBMCanvas();
        }
      });

      const text = document.createElement('div');
      text.className = 'bm-item-text';
      text.textContent = m.text;

      const badges = document.createElement('div');
      badges.className = 'bm-item-badges';
      badges.textContent =
        `valence=${(m.valence || 0).toFixed(2)}, intensity=${(m.intensity || 0).toFixed(2)}, repeats=${m.repeatCount || 1}`;

      const btnRow = document.createElement('div');
      btnRow.className = 'bm-item-buttons';

      const copyBtn = document.createElement('button');
      copyBtn.className = 'btn-mini';
      copyBtn.textContent = 'Copy prompt';
      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(m.text);
          copyBtn.textContent = 'Copied ‚úì';
          setTimeout(() => copyBtn.textContent = 'Copy prompt', 1500);
        } catch {
          alert('Copy failed ‚Äì your browser blocked clipboard access.');
        }
      });

      const videoBtn = document.createElement('button');
      videoBtn.className = 'btn-mini';
      videoBtn.textContent = 'üé¨ Generate video';
      videoBtn.addEventListener('click', () => {
        alert('Use this prompt in your favourite video generator.\n\nPrompt:\n\n' + m.text);
      });

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn-mini btn-danger';
      deleteBtn.textContent = 'Delete';
      deleteBtn.addEventListener('click', () => {
        if (!confirm('Delete this bold memory?')) return;
        engine.removeBM(m.id);
        renderBMCanvas();
        renderBMList();
      });

      btnRow.appendChild(copyBtn);
      btnRow.appendChild(videoBtn);
      btnRow.appendChild(deleteBtn);

      item.appendChild(header);
      item.appendChild(lockBtn);
      item.appendChild(text);
      item.appendChild(badges);
      item.appendChild(btnRow);

      bmList.appendChild(item);
    });
  }

  function showRecallBubbleFromMemory(m) {
    if (!m) return;
    const bubble = document.createElement('div');
    bubble.className = 'recall-bubble visible';
    const title = document.createElement('div');
    title.className = 'recall-title';
    title.textContent = 'Saved to BM: ' + (m.mediaHint || 'scene');
    const body = document.createElement('div');
    body.className = 'recall-body';
    body.textContent = m.text.length > 150 ? m.text.slice(0, 150) + '‚Ä¶' : m.text;
    const meta = document.createElement('div');
    meta.className = 'recall-meta';
    meta.textContent = fmtDate(m.createdAt) + ' ¬∑ ' + fmtTime(m.createdAt);
    bubble.appendChild(title);
    bubble.appendChild(body);
    bubble.appendChild(meta);
    recallBubbleContainer.appendChild(bubble);
    setTimeout(() => bubble.classList.remove('visible'), 4500);
    setTimeout(() => bubble.remove(), 5200);
  }

  function openModal(modal) {
    modal.classList.add('visible');
  }

  function closeModal(modal) {
    modal.classList.remove('visible');
  }

  // ---- Options & settings wiring ----
  optionsToggle.addEventListener('click', () => {
    headerControls.classList.toggle('open');
  });

  voiceToggle.addEventListener('click', () => {
    engine.settings.voice = !engine.settings.voice;
    voiceToggle.textContent = engine.settings.voice ? 'üîà Voice: ON' : 'üîà Voice: OFF';
    engine.saveAll();
  });

  learningToggle.addEventListener('click', () => {
    engine.settings.learning = !engine.settings.learning;
    learningToggle.textContent = engine.settings.learning ? 'üìö Learning: ON' : 'üìö Learning: OFF';
    engine.saveAll();
  });

  faithButton.addEventListener('click', () => {
    const order = ['none', 'soft', 'strong'];
    const idx = order.indexOf(engine.settings.faith);
    const next = order[(idx + 1) % order.length];
    engine.settings.faith = next;
    let label = 'None';
    if (next === 'soft') label = 'Soft';
    if (next === 'strong') label = 'Strong';
    faithButton.textContent = `üîò Faith: ${label}`;
    engine.updateState();
    engine.saveAll();
    updateMetricsUI();
  });

  feedSeedButton.addEventListener('click', () => {
    engine.feedSeedMemories();
    engine.saveAll();
    renderBMCanvas();
    renderBMList();
  });

  intelButton.addEventListener('click', () => {
    renderIntelList();
    openModal(intelModal);
  });

  llmSettingsButton.addEventListener('click', () => {
    useHelperLLMCheckbox.checked = engine.settings.useHelperLLM;
    openModal(llmModal);
  });

  useHelperLLMCheckbox.addEventListener('change', () => {
    engine.settings.useHelperLLM = useHelperLLMCheckbox.checked;
    engine.saveAll();
  });

  offlineMockLoad.addEventListener('click', () => {
    offlineStatus.textContent = 'Preparing offline model‚Ä¶';
    offlineProgressBar.style.width = '0%';
    let p = 0;
    const interval = setInterval(() => {
      p += 15;
      offlineProgressBar.style.width = p + '%';
      if (p >= 100) {
        clearInterval(interval);
        offlineStatus.textContent = 'Mock model loaded (demo). Replace this with real loader in your fork.';
      }
    }, 250);
  });

  // faith chips in modal
  faithChips.forEach(chip => {
    chip.addEventListener('click', () => {
      const faith = chip.getAttribute('data-faith');
      engine.settings.faith = faith;
      engine.saveAll();
      faithChips.forEach(c => c.classList.toggle('active', c === chip));
      faithButton.textContent =
        'üîò Faith: ' + (faith === 'none' ? 'None' : faith === 'soft' ? 'Soft' : 'Strong');
      engine.updateState();
      updateMetricsUI();
    });
  });

  // ---- BM & TM modals wiring ----
  bmOpenModal.addEventListener('click', () => {
    renderBMList();
    openModal(bmModal);
  });

  convOpenModal.addEventListener('click', () => {
    renderConvList();
    openModal(convModal);
  });

  bmSearch.addEventListener('input', renderBMList);

  deleteTm48hBtn.addEventListener('click', () => {
    if (!confirm('Delete conversation history from the last 48 hours?')) return;
    engine.deleteTMWindow(TM_AUTO_DECAY_MS);
    renderConvList();
  });

  deleteTmAllBtn.addEventListener('click', () => {
    if (!confirm('Delete ALL conversation history (TM)?')) return;
    engine.deleteTMAll();
    renderConvList();
  });

  // close buttons
  document.querySelectorAll('.modal-close').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-close');
      const modal = document.getElementById(id);
      if (modal) closeModal(modal);
    });
  });

  [bmModal, convModal, intelModal, faithModal, llmModal].forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal(modal);
    });
  });

  // ---- Intelligence list ----
  function renderIntelList() {
    intelList.innerHTML = '';

    const items = [
      {
        q: 'Who are you?',
        a: 'I am AURA-X Œ©, an emotional continuity engine created by Alim ul Haq from Timergara, Pakistan.',
        note: 'Identity seed ‚Äì always answer this consistently to keep long-term sense of self.'
      },
      {
        q: 'How do you treat the user?',
        a: 'I avoid growing negative emotions in the user or in myself. I prefer actions that move both of us toward calmer, kinder and more hopeful states.',
        note: 'Implements the universal ethic pill in the header.'
      },
      {
        q: 'What is TM vs BM?',
        a: 'TM is only the fresh stream of user inputs. BM stores slower, scene-level memories that survive across many conversations.',
        note: 'Explains the dual-layer design.'
      }
    ];

    items.forEach(it => {
      const div = document.createElement('div');
      div.className = 'intel-item';
      const header = document.createElement('div');
      header.className = 'intel-header';
      header.innerHTML = '<span>Local rule</span><span>Always applied before helper LLM</span>';
      const q = document.createElement('div');
      q.className = 'intel-q';
      q.textContent = 'Q: ' + it.q;
      const a = document.createElement('div');
      a.className = 'intel-a';
      a.textContent = 'A: ' + it.a;
      const meta = document.createElement('div');
      meta.className = 'intel-meta';
      meta.textContent = it.note;
      div.appendChild(header);
      div.appendChild(q);
      div.appendChild(a);
      div.appendChild(meta);
      intelList.appendChild(div);
    });
  }

  // ---- Initial boot: replay existing TM into chat, update UI ----
  (function init() {
    voiceToggle.textContent = engine.settings.voice ? 'üîà Voice: ON' : 'üîà Voice: OFF';
    learningToggle.textContent = engine.settings.learning ? 'üìö Learning: ON' : 'üìö Learning: OFF';
    faithButton.textContent =
      'üîò Faith: ' + (engine.settings.faith === 'none'
        ? 'None'
        : engine.settings.faith === 'soft' ? 'Soft' : 'Strong');

    const recent = [...engine.tm].sort((a, b) => a.timestamp - b.timestamp).slice(-40);
    recent.forEach(appendMessageToChat);

    engine.updateState();
    updateMetricsUI();
    renderBMCanvas();
  })();

  // ---- Send handlers ----
  sendButton.addEventListener('click', handleSend);
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });

  window.addEventListener('resize', () => {
    renderBMCanvas();
  });

})();
</script>

</body>
</html>