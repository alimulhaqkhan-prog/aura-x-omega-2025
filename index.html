<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Î© â€“ Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Offline WebLLM loader (unchanged) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg-gradient-outer:#e5e7eb;
      --bg-gradient-inner:#f9fafb;
      --card-bg:#ffffff;
      --card-border:#d1d5db;
      --card-glow:#e0f2fe;
      --accent:#0ea5e9;
      --accent-soft:#38bdf8;
      --accent-strong:#0f766e;
      --danger:#ef4444;
      --good:#22c55e;
      --pill-bg:#f9fafb;
      --pill-border:#cbd5f5;
      --text-main:#0f172a;
      --text-soft:#111827;
      --text-muted:#6b7280;
      --pill-gold:#facc15;
      --bm-positive:#16a34a;
      --bm-negative:#dc2626;
      --bm-neutral:#9ca3af;
      --option-bg:#f3f4f6;
      --option-border:#d1d5db;
      --shadow-strong:0 18px 60px rgba(15,23,42,.16);
      --shadow-soft:0 12px 38px rgba(15,23,42,.10);
      --corner-lg:32px;
      --corner-md:24px;
      --corner-pill:999px;
    }
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at top,#e5f0ff 0,#f9fafb 45%,#e5e7eb 100%);
      color:var(--text-main);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:24px 12px 32px;
    }
    .app{
      width:100%;
      max-width:960px;
      background:radial-gradient(circle at top,#ffffff 0,#f9fafb 55%,#e5e7eb 100%);
      border-radius:40px;
      box-shadow:var(--shadow-strong);
      padding:24px 18px 20px;
      border:1px solid rgba(148,163,184,.5);
      position:relative;
      overflow:hidden;
    }
    .app::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 10% 0%,rgba(59,130,246,.08) 0,transparent 55%),
        radial-gradient(circle at 90% 0%,rgba(56,189,248,.08) 0,transparent 55%);
      opacity:.9;
      filter:blur(32px);
      z-index:-2;
    }
    .app::after{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 20% 0%,rgba(255,255,255,.95) 0,rgba(249,250,251,.98) 45%,rgba(241,245,249,1) 70%);
      z-index:-1;
    }
    .header-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:10px;
      gap:8px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .brand-title{
      font-size:1.8rem;
      letter-spacing:.12em;
      font-weight:700;
      text-transform:uppercase;
      background:linear-gradient(120deg,#2563eb,#0ea5e9,#f59e0b);
      -webkit-background-clip:text;
      color:transparent;
      text-shadow:0 0 16px rgba(59,130,246,.45);
    }
    .brand-sub{
      font-size:.78rem;
      color:var(--text-muted);
      letter-spacing:.05em;
      text-transform:uppercase;
    }
    .tagline-pill{
      margin-top:4px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border-radius:999px;
      background:#f3f4f6;
      border:1px solid rgba(156,163,175,.7);
      box-shadow:0 10px 24px rgba(148,163,184,.35);
      font-size:.7rem;
      color:var(--text-muted);
    }
    .tagline-pill span.icon{
      width:18px;
      height:18px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#facc15,#f97316 55%,#4b5563 100%);
      box-shadow:0 0 14px rgba(250,204,21,.6);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.7rem;
    }
    .tagline-pill strong{
      color:var(--text-soft);
      font-weight:600;
    }
    .status-column{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
    }
    .engine-pill{
      padding:6px 12px;
      border-radius:999px;
      background:#ecfdf5;
      border:1px solid rgba(34,197,94,.7);
      font-size:.72rem;
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:#166534;
      box-shadow:0 12px 28px rgba(34,197,94,.35);
    }
    .engine-pill .dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#86efac,#22c55e);
      box-shadow:0 0 10px rgba(74,222,128,1);
    }
    .mode-label{
      font-size:.72rem;
      color:var(--text-muted);
      margin-top:2px;
    }
    .top-buttons{
      display:flex;
      gap:8px;
      margin-top:2px;
    }
    .btn-top{
      background:#f3f4f6;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      padding:6px 11px;
      font-size:.7rem;
      color:var(--text-muted);
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      box-shadow:0 10px 26px rgba(148,163,184,.4);
      transition:transform .15s ease,box-shadow .15s ease,background .15s ease;
    }
    .btn-top span.icon{
      width:16px;
      height:16px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#38bdf8,#2563eb);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.7rem;
      box-shadow:0 0 10px rgba(59,130,246,.7);
    }
    .btn-top.secondary span.icon{
      background:radial-gradient(circle at 30% 20%,#9ca3af,#e5e7eb);
      box-shadow:none;
    }
    .btn-top.secondary{
      border-color:rgba(148,163,184,.6);
      background:linear-gradient(145deg,#eef2ff,#e5e7eb);
    }
    .btn-top:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 30px rgba(148,163,184,.55);
      background:#ffffff;
    }
    .btn-top:active{
      transform:translateY(0);
      box-shadow:0 8px 18px rgba(148,163,184,.45);
    }
    .ethic-card{
      margin-top:14px;
      margin-bottom:10px;
      padding:14px 16px;
      border-radius:24px;
      background:linear-gradient(135deg,#fefce8,#fffbeb);
      border:1px solid rgba(250,204,21,.7);
      box-shadow:0 18px 40px rgba(250,204,21,.25);
      position:relative;
      overflow:hidden;
    }
    .ethic-card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 0% 0%,rgba(250,204,21,.30) 0,transparent 45%);
      opacity:.8;
      mix-blend-mode:multiply;
      z-index:-1;
    }
    .ethic-title-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .ethic-title{
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#854d0e;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .ethic-glow-orb{
      width:20px;
      height:20px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#facc15,#f97316 55%,#f97316 100%);
      box-shadow:0 0 22px rgba(251,191,36,.8);
      position:relative;
    }
    .ethic-glow-orb::after{
      content:"";
      position:absolute;
      inset:7px;
      border-radius:inherit;
      border:2px solid rgba(254,249,195,1);
      box-shadow:0 0 10px rgba(254,249,195,.8);
    }
    .ethic-tag{
      font-size:.72rem;
      color:#92400e;
      opacity:.9;
    }
    .ethic-body{
      font-size:.83rem;
      color:#713f12;
      line-height:1.55;
    }
    .ethic-body strong{
      color:#854d0e;
      font-weight:600;
    }
    .controls-row{
      margin-top:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .big-engine-btn{
      padding:10px 18px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:.82rem;
      font-weight:600;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:#052e16;
      background:linear-gradient(135deg,#22c55e,#4ade80,#a7f3d0);
      box-shadow:0 22px 50px rgba(22,163,74,.45);
      display:inline-flex;
      align-items:center;
      gap:8px;
      position:relative;
      overflow:hidden;
    }
    .big-engine-btn::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 0% 0%,rgba(254,249,195,.5) 0,transparent 55%);
      opacity:.7;
      pointer-events:none;
    }
    .big-engine-btn span.icon{
      width:18px;
      height:18px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#22c55e,#16a34a);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.85rem;
      color:#ecfdf5;
      box-shadow:0 0 12px rgba(34,197,94,1);
    }
    .big-engine-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 26px 60px rgba(22,163,74,.55);
    }
    .big-engine-btn:active{
      transform:translateY(0);
      box-shadow:0 18px 40px rgba(22,163,74,.45);
    }
    .options-shell{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .options-label{
      font-size:.76rem;
      color:var(--text-muted);
    }
    .btn-options{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:#f3f4f6;
      color:var(--text-muted);
      font-size:.75rem;
      padding:6px 12px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      box-shadow:0 12px 26px rgba(148,163,184,.4);
    }
    .btn-options span.icon{
      width:16px;
      height:16px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#38bdf8,#2563eb);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.7rem;
      box-shadow:0 0 10px rgba(59,130,246,.7);
    }
    .btn-options:hover{
      transform:translateY(-1px);
      box-shadow:0 16px 30px rgba(148,163,184,.55);
      background:#ffffff;
    }
    .btn-options:active{
      transform:translateY(0);
      box-shadow:0 10px 20px rgba(148,163,184,.45);
    }
    .main-grid{
      margin-top:12px;
      display:grid;
      grid-template-columns:minmax(0,1.15fr) minmax(0,.95fr);
      gap:12px;
    }
    .card{
      background:radial-gradient(circle at 0% 0%,#ffffff 0,#f9fafb 45%,#e5e7eb 100%);
      border-radius:26px;
      border:1px solid var(--card-border);
      box-shadow:var(--shadow-soft);
      padding:14px 14px 13px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 0% 0%,rgba(56,189,248,.12) 0,transparent 45%);
      opacity:.6;
      pointer-events:none;
      z-index:-1;
    }
    .card h2{
      font-size:.86rem;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--text-muted);
      margin-bottom:6px;
    }
    .metrics-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:4px;
      margin-bottom:6px;
    }
    .metric{
      flex:1 1 90px;
      min-width:0;
      background:#f9fafb;
      border-radius:18px;
      border:1px solid #e5e7eb;
      padding:8px 9px;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .metric-label{
      font-size:.68rem;
      color:var(--text-muted);
    }
    .metric-value{
      font-size:.98rem;
      font-weight:600;
      letter-spacing:.02em;
      color:var(--text-soft);
    }
    .metric-sub{
      font-size:.7rem;
      color:var(--text-muted);
    }
    .pill-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .pill{
      border-radius:999px;
      padding:5px 9px;
      font-size:.68rem;
      border:1px solid rgba(148,163,184,.55);
      background:#f3f4f6;
      color:var(--text-muted);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .pill .dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:#9ca3af;
    }
    .pill.positive .dot{background:#22c55e}
    .pill.negative .dot{background:#ef4444}
    .pill.neutral .dot{background:#9ca3af}
    .resonance-bar{
      margin-top:8px;
      height:9px;
      border-radius:999px;
      background:linear-gradient(90deg,#e5e7eb,#d1d5db);
      position:relative;
      overflow:hidden;
    }
    .resonance-bar-inner{
      position:absolute;
      inset:0;
      border-radius:inherit;
      background:linear-gradient(90deg,#22c55e,#0ea5e9,#fbbf24,#f97316,#ef4444);
      transform-origin:left center;
      transform:scaleX(.3);
      box-shadow:0 0 10px rgba(56,189,248,.7);
    }
    .resonance-labels{
      display:flex;
      justify-content:space-between;
      margin-top:2px;
      font-size:.62rem;
      color:var(--text-muted);
    }
    .bm-ribbon{
      margin-top:10px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .bm-capsule{
      flex:1;
      height:18px;
      border-radius:999px;
      background:#e5e7eb;
      overflow:hidden;
      position:relative;
      box-shadow:0 12px 28px rgba(148,163,184,.5);
    }
    .bm-segment{
      position:absolute;
      top:0;
      bottom:0;
      width:4px;
      background:var(--bm-neutral);
      opacity:.8;
      transform-origin:center;
      animation:bmPulse 2.4s ease-in-out infinite alternate;
    }
    .bm-label{
      font-size:.7rem;
      color:var(--text-muted);
      min-width:68px;
      text-align:right;
    }
    @keyframes bmPulse{
      0%{opacity:.4;transform:scaleY(.4)}
      100%{opacity:1;transform:scaleY(1)}
    }
    .bm-log{
      margin-top:8px;
      background:#f9fafb;
      border-radius:16px;
      border:1px solid #e5e7eb;
      padding:7px 9px;
      max-height:122px;
      overflow-y:auto;
      font-size:.72rem;
      color:var(--text-muted);
    }
    .bm-log-entry{
      display:flex;
      justify-content:space-between;
      gap:6px;
      padding:3px 0;
    }
    .bm-log-entry span.time{
      color:var(--text-muted);
      flex:0 0 auto;
    }
    .bm-log-entry span.text{
      flex:1 1 auto;
      min-width:0;
    }
    .bm-log-entry span.tag{
      flex:0 0 auto;
      font-size:.65rem;
      color:var(--text-soft);
    }
    .bm-log-empty{
      color:var(--text-muted);
      font-style:italic;
    }
    .chat-card{
      margin-top:0;
    }
    .chat-window{
      margin-top:8px;
      background:#f9fafb;
      border-radius:20px;
      border:1px solid #e5e7eb;
      padding:10px 10px 10px;
      max-height:260px;
      overflow-y:auto;
      font-size:.82rem;
      display:flex;
      flex-direction:column;
      gap:7px;
    }
    .chat-message{
      display:flex;
      gap:7px;
    }
    .chat-message.user{
      justify-content:flex-end;
    }
    .chat-bubble{
      padding:7px 9px;
      border-radius:16px;
      max-width:78%;
      line-height:1.45;
    }
    .chat-message.user .chat-bubble{
      background:linear-gradient(135deg,#0ea5e9,#22c55e);
      color:#052e16;
      border-bottom-right-radius:4px;
      box-shadow:0 14px 30px rgba(34,197,94,.3);
    }
    .chat-message.ai .chat-bubble{
      background:#ffffff;
      border:1px solid #e5e7eb;
      color:var(--text-soft);
      border-bottom-left-radius:4px;
      box-shadow:0 12px 28px rgba(148,163,184,.25);
    }
    .chat-meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:.68rem;
      color:var(--text-muted);
      margin-top:2px;
    }
    .typing-indicator{
      display:flex;
      align-items:center;
      gap:4px;
      font-size:.72rem;
      color:var(--text-muted);
    }
    .typing-dot{
      width:4px;
      height:4px;
      border-radius:999px;
      background:#9ca3af;
      animation:blink 1.1s infinite ease-in-out;
    }
    .typing-dot:nth-child(2){animation-delay:.2s}
    .typing-dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{
      0%,80%,100%{opacity:.2;transform:translateY(0)}
      40%{opacity:1;transform:translateY(-1px)}
    }
    .formula-bar{
      margin-top:10px;
      margin-bottom:10px;
      border-radius:22px;
      background:#f3f4f6;
      border:1px solid #e5e7eb;
      box-shadow:0 10px 26px rgba(148,163,184,.25);
      padding:9px 11px;
      display:flex;
      align-items:center;
      gap:8px;
      font-family:"SF Mono","JetBrains Mono",ui-monospace,Menlo,monospace;
      font-size:.74rem;
      color:var(--text-soft);
    }
    .formula-label{
      font-size:.68rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--text-muted);
      margin-right:6px;
    }
    .formula-chip{
      border-radius:999px;
      padding:4px 7px;
      border:1px solid #e5e7eb;
      font-size:.68rem;
      color:var(--text-muted);
    }
    .tm-formula-pill{
      margin-top:3px;
      border-radius:999px;
      padding:6px 9px;
      background:#ffffff;
      border:1px solid #e5e7eb;
      font-size:.78rem;
      font-family:"SF Mono","JetBrains Mono",ui-monospace,Menlo,monospace;
      color:var(--text-soft);
      text-align:center;
      box-shadow:0 14px 28px rgba(148,163,184,.25);
    }
    .tm-intro{
      font-size:.76rem;
      color:var(--text-muted);
      margin-top:7px;
      line-height:1.55;
    }
    .tm-intro strong{
      color:var(--text-soft);
    }
    .tm-pipeline-row{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:7px;
      align-items:center;
      font-size:.7rem;
      color:var(--text-muted);
    }
    .tm-pipe{
      border-radius:999px;
      padding:4px 8px;
      border:1px solid #e5e7eb;
      background:#f3f4f6;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .tm-pipe span.badge{
      border-radius:999px;
      padding:2px 6px;
      font-size:.62rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      background:#e5e7eb;
      color:var(--text-muted);
      border:1px solid #d1d5db;
    }
    .tm-pipe span.tag{
      font-size:.7rem;
      color:var(--text-muted);
    }
    .tm-pipe span.dot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:#22c55e;
    }
    .identity-pill{
      margin-top:6px;
      font-size:.7rem;
      color:var(--text-muted);
    }
    .identity-pill strong{
      color:var(--text-soft);
    }
    .input-row{
      margin-top:10px;
      display:flex;
      align-items:flex-end;
      gap:10px;
    }
    .input-shell{
      flex:1;
      background:#f3f4f6;
      border-radius:999px;
      border:1px solid #d1d5db;
      display:flex;
      align-items:center;
      padding:6px 8px;
      box-shadow:0 12px 26px rgba(148,163,184,.35);
    }
    .input-shell textarea{
      flex:1;
      background:transparent;
      border:none;
      outline:none;
      resize:none;
      color:var(--text-soft);
      font-size:.84rem;
      line-height:1.4;
      max-height:68px;
      padding:4px 6px 4px 10px;
    }
    .input-shell textarea::placeholder{
      color:#9ca3af;
    }
    .input-shell .right-icons{
      display:flex;
      align-items:center;
      gap:6px;
      margin-left:6px;
    }
    .input-shell .mic-btn{
      width:26px;
      height:26px;
      border-radius:999px;
      border:1px solid #d1d5db;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.8rem;
      cursor:pointer;
      background:#ffffff;
      color:var(--text-muted);
    }
    .btn-send{
      border-radius:999px;
      border:none;
      padding:9px 15px;
      font-size:.82rem;
      font-weight:600;
      letter-spacing:.06em;
      text-transform:uppercase;
      cursor:pointer;
      background:linear-gradient(135deg,#0ea5e9,#22c55e);
      color:#052e16;
      box-shadow:0 18px 40px rgba(34,197,94,.4);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn-send span.icon{
      width:18px;
      height:18px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#e5e7eb,#9ca3af);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.9rem;
      box-shadow:0 0 10px rgba(226,232,240,.8);
    }
    .btn-send:hover{
      transform:translateY(-1px);
      box-shadow:0 22px 48px rgba(34,197,94,.5);
    }
    .btn-send:active{
      transform:translateY(0);
      box-shadow:0 14px 28px rgba(34,197,94,.4);
    }
    .side-card{
      padding:10px 11px 11px;
    }
    .side-card h3{
      font-size:.8rem;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--text-muted);
      margin-bottom:6px;
    }
    .toggle-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
      gap:6px;
    }
    .toggle-label{
      font-size:.76rem;
      color:var(--text-soft);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .toggle-label span.icon{
      width:16px;
      height:16px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#38bdf8,#2563eb);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.72rem;
      box-shadow:0 0 10px rgba(59,130,246,.7);
    }
    .toggle-label span.icon.brain{
      background:radial-gradient(circle at 30% 20%,#f97316,#facc15);
      box-shadow:0 0 10px rgba(250,204,21,.7);
    }
    .toggle-label span.icon.seed{
      background:radial-gradient(circle at 30% 20%,#22c55e,#16a34a);
      box-shadow:0 0 10px rgba(34,197,94,.8);
    }
    .toggle-label span.icon.book{
      background:radial-gradient(circle at 30% 20%,#a855f7,#6366f1);
      box-shadow:0 0 10px rgba(168,85,247,.8);
    }
    .toggle-label span.icon.faith{
      background:radial-gradient(circle at 30% 20%,#fb7185,#f97316);
      box-shadow:0 0 10px rgba(248,113,113,.8);
    }
    .toggle-label span.icon.llm{
      background:radial-gradient(circle at 30% 20%,#38bdf8,#06b6d4);
      box-shadow:0 0 10px rgba(45,212,191,.8);
    }
    .toggle-desc{
      font-size:.7rem;
      color:var(--text-muted);
    }
    .switch{
      position:relative;
      width:40px;
      height:20px;
      border-radius:999px;
      background:#e5e7eb;
      border:1px solid #d1d5db;
      cursor:pointer;
      flex-shrink:0;
    }
    .switch-knob{
      position:absolute;
      top:2px;
      left:2px;
      width:14px;
      height:14px;
      border-radius:999px;
      background:#9ca3af;
      box-shadow:0 0 8px rgba(148,163,184,.8);
      transition:transform .18s ease,background .18s ease;
    }
    .switch.on{
      background:radial-gradient(circle at 30% 20%,#22c55e,#4ade80);
      border-color:#4ade80;
    }
    .switch.on .switch-knob{
      transform:translateX(18px);
      background:#ecfdf5;
      box-shadow:0 0 10px rgba(34,197,94,1);
    }
    .faith-chip-row{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:5px;
    }
    .faith-chip{
      font-size:.68rem;
      border-radius:999px;
      padding:4px 7px;
      border:1px solid #d1d5db;
      color:var(--text-muted);
      background:#f3f4f6;
      cursor:pointer;
    }
    .faith-chip.active{
      background:radial-gradient(circle at 0% 0%,rgba(56,189,248,.85) 0,rgba(59,130,246,1) 55%);
      color:#eff6ff;
      border-color:rgba(59,130,246,1);
      box-shadow:0 0 12px rgba(59,130,246,.7);
    }
    .side-section{
      margin-top:6px;
      border-radius:18px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      padding:8px 9px;
      font-size:.72rem;
      color:var(--text-muted);
    }
    .side-section h4{
      font-size:.74rem;
      text-transform:uppercase;
      letter-spacing:.07em;
      color:var(--text-muted);
      margin-bottom:4px;
    }
    .side-section p{
      line-height:1.45;
    }
    .side-section strong{
      color:var(--text-soft);
    }
    .side-section code{
      font-family:"SF Mono","JetBrains Mono",ui-monospace,Menlo,monospace;
      font-size:.7rem;
      color:#1d4ed8;
    }
    .side-section-footer{
      margin-top:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:.68rem;
      color:var(--text-muted);
    }
    .side-section-footer span.badge{
      border-radius:999px;
      padding:3px 7px;
      border:1px solid #d1d5db;
      background:#ffffff;
      color:var(--text-soft);
    }
    .side-footer{
      margin-top:9px;
      font-size:.7rem;
      color:var(--text-muted);
      line-height:1.45;
    }
    .side-footer strong{
      color:var(--text-soft);
    }
    .floating-menu{
      position:absolute;
      bottom:18px;
      right:18px;
      border-radius:999px;
      background:#f3f4f6;
      border:1px solid #d1d5db;
      padding:3px 4px;
      display:flex;
      gap:6px;
      align-items:center;
      box-shadow:0 14px 32px rgba(148,163,184,.45);
    }
    .floating-menu button{
      border-radius:999px;
      border:none;
      background:transparent;
      color:var(--text-muted);
      font-size:.7rem;
      padding:4px 7px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
    }
    .floating-menu button span.icon{
      width:14px;
      height:14px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#38bdf8,#2563eb);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.7rem;
    }
    .floating-menu button:hover{
      background:#e5e7eb;
    }
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.10);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:20;
      backdrop-filter:blur(6px);
    }
    .modal-overlay.active{
      display:flex;
    }
    .modal-card{
      width:100%;
      max-width:540px;
      max-height:80vh;
      overflow-y:auto;
      background:#ffffff;
      border-radius:26px;
      border:1px solid #d1d5db;
      box-shadow:0 20px 60px rgba(15,23,42,.25);
      padding:16px 16px 14px;
      color:var(--text-soft);
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .modal-title{
      font-size:.9rem;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--text-soft);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .modal-title span.icon{
      width:18px;
      height:18px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#38bdf8,#2563eb);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.78rem;
      box-shadow:0 0 12px rgba(59,130,246,.7);
    }
    .modal-close{
      border-radius:999px;
      border:1px solid #d1d5db;
      background:#f3f4f6;
      color:var(--text-muted);
      font-size:.74rem;
      padding:4px 8px;
      cursor:pointer;
    }
    .modal-section{
      margin-top:7px;
      margin-bottom:8px;
      padding:8px 9px;
      border-radius:18px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      font-size:.74rem;
      color:var(--text-muted);
    }
    .modal-section h4{
      font-size:.76rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--text-soft);
      margin-bottom:5px;
    }
    .faith-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .faith-pill{
      border-radius:999px;
      padding:4px 8px;
      border:1px solid #d1d5db;
      font-size:.72rem;
      color:var(--text-muted);
      cursor:pointer;
      background:#f3f4f6;
    }
    .faith-pill.active{
      background:radial-gradient(circle at 0% 0%,rgba(56,189,248,.85) 0,rgba(59,130,246,1) 55%);
      border-color:rgba(59,130,246,1);
      color:#eff6ff;
      box-shadow:0 0 12px rgba(59,130,246,.65);
    }
    .modal-toggle-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:4px;
      margin-bottom:4px;
      gap:6px;
    }
    .modal-toggle-label{
      font-size:.74rem;
      color:var(--text-soft);
    }
    .modal-hint{
      font-size:.7rem;
      color:var(--text-muted);
      margin-top:4px;
    }
    .btn-outline{
      border-radius:999px;
      border:1px solid #d1d5db;
      background:#ffffff;
      color:var(--text-soft);
      font-size:.74rem;
      padding:5px 9px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn-outline span.icon{
      width:16px;
      height:16px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#22c55e,#16a34a);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.75rem;
    }
    .btn-outline.danger span.icon{
      background:radial-gradient(circle at 30% 20%,#ef4444,#b91c1c);
    }
    .btn-outline.danger{
      border-color:rgba(248,113,113,.9);
      color:#b91c1c;
    }
    .btn-outline:hover{
      background:#f3f4f6;
    }
    .modal-footer-row{
      margin-top:7px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      font-size:.7rem;
      color:var(--text-muted);
    }
    .modal-footer-row span.badge{
      border-radius:999px;
      padding:3px 7px;
      border:1px solid #d1d5db;
      background:#ffffff;
      color:var(--text-soft);
    }
    .tm-formula-pill{font-size:.72rem;padding:6px 9px}
    @media (max-width:840px){
      .app{border-radius:26px;padding:18px 12px 16px}
      .main-grid{grid-template-columns:minmax(0,1fr);gap:10px}
      .ethic-card{margin-top:10px}
      .header-row{flex-direction:column;align-items:flex-start;gap:6px}
      .status-column{align-items:flex-start}
      .big-engine-btn{width:100%;justify-content:center}
      .side-card{margin-top:6px}
    }
    @media (max-width:600px){
      body{padding:8px}
      .app{border-radius:22px;padding:14px 10px 12px}
      .chat-window{max-height:220px}
      .bm-log{max-height:100px}
      .floating-menu{right:12px;bottom:12px}
      .input-row{flex-direction:column;align-items:stretch}
      .btn-send{width:100%;justify-content:center}
      .header-row{gap:4px}
      .tagline-pill{max-width:100%;flex-wrap:wrap}
      .tagline-pill span.icon{display:none}
      .brand-title{font-size:1.55rem}
      .input-shell{max-width:100%;}
    }
  </style>
</head>
<body>
<div class="app">
  <div class="header-row">
    <div class="brand">
      <div class="brand-title">AURA-X Î©</div>
      <div class="brand-sub">Offline emotional continuity engine (prototype)</div>
      <div class="tagline-pill">
        <span class="icon">Î©</span>
        <span><strong>Continuity</strong> = feelings from memories, not isolated sparks.</span>
      </div>
    </div>
    <div class="status-column">
      <div class="engine-pill">
        <div class="dot"></div>
        <span>Emotional continuity engine</span>
      </div>
      <div class="mode-label">
        TM = your inputs Â· Inner layers keep continuity &amp; emotional trajectory.
      </div>
      <div class="top-buttons">
        <button class="btn-top" id="btnIntelligence">
          <span class="icon">ðŸ§ </span>
          Intelligence
        </button>
        <button class="btn-top secondary" id="btnFeedSeed">
          <span class="icon">ðŸŒ±</span>
          Feed the seed
        </button>
      </div>
    </div>
  </div>

  <div class="ethic-card">
    <div class="ethic-title-row">
      <div class="ethic-title">
        <div class="ethic-glow-orb"></div>
        Universal ethic (always on)
      </div>
      <div class="ethic-tag">Local lenses only shape encouragement style.</div>
    </div>
    <div class="ethic-body">
      <strong>Avoid actions that grow negative emotions</strong> in you or others.
      Move gently toward choices that increase
      <strong>shared positive feeling for everyone.</strong>
    </div>
  </div>

  <div class="controls-row">
    <button class="big-engine-btn" id="btnEngine">
      <span class="icon">â–¶</span>
      <span>Emotional continuity engine active</span>
    </button>
    <div class="options-shell">
      <span class="options-label">Inner layers &amp; faith lens</span>
      <button class="btn-options" id="btnOptions">
        <span class="icon">âš™</span>
        Options
      </button>
    </div>
  </div>

  <div class="main-grid">
    <div>
      <div class="card">
        <h2>Emotional metrics</h2>
        <div class="metrics-row">
          <div class="metric">
            <div class="metric-label">Emotional state Eâ‚€</div>
            <div class="metric-value" id="metricE0">0.00</div>
            <div class="metric-sub">tanh-based, range [âˆ’1 â€¦ +1]</div>
          </div>
          <div class="metric">
            <div class="metric-label">BM resonance</div>
            <div class="metric-value" id="metricBMRes">0.00</div>
            <div class="metric-sub">Stored emotional events</div>
          </div>
          <div class="metric">
            <div class="metric-label">Continuity index</div>
            <div class="metric-value" id="metricContinuity">0.000</div>
            <div class="metric-sub">Stability of emotional trajectory</div>
          </div>
        </div>

        <div class="pill-row">
          <div class="pill positive" id="pillValence">
            <div class="dot"></div>
            <span id="labelValence">VALENCE: neutral</span>
          </div>
          <div class="pill" id="pillArousal">
            <div class="dot"></div>
            <span id="labelArousal">AROUSAL: balanced</span>
          </div>
          <div class="pill" id="pillReaction">
            <div class="dot"></div>
            <span id="labelReaction">REACTION: steady</span>
          </div>
        </div>

        <div class="resonance-bar">
          <div class="resonance-bar-inner" id="barE0"></div>
        </div>
        <div class="resonance-labels">
          <span>âˆ’1 (overwhelmed / shut down)</span>
          <span>0 (balanced)</span>
          <span>+1 (uplifted / energized)</span>
        </div>

        <div class="bm-ribbon">
          <div class="bm-capsule" id="bmCapsule"></div>
          <div class="bm-label">BM life</div>
        </div>

        <div class="bm-log" id="bmLog">
          <div class="bm-log-empty">No continuity events stored yet. Deeper scenes will appear here.</div>
        </div>
      </div>

      <div class="card chat-card">
        <h2>Conversation</h2>
        <div class="chat-window" id="chatWindow"></div>

        <div class="formula-bar">
          <span class="formula-label">Core equation</span>
          <span>Eâ‚€ = tanh(R(TM, BM) âˆ’ D + Î»_faith + Î»_sys + Î»_trc)</span>
        </div>

        <div class="tm-formula-pill">
          Eâ‚€ = tanh(R(TM, BM) âˆ’ D + Î»_faith + Î»_sys + Î»_trc)
        </div>

        <div class="tm-intro">
          <strong>Pipeline:</strong> TM = your inputs â†’ optional helper LLM â†’
          collide with BM stories + continuity reflex â†’ emotional state Eâ‚€.
        </div>

        <div class="tm-pipeline-row">
          <div class="tm-pipe">
            <span class="badge">TM</span>
            <span class="tag">fresh input</span>
            <span class="dot"></span>
            <span class="tag">polarity &amp; intensity via offline / optional online LLM</span>
          </div>
        </div>

        <div class="identity-pill">
          I am <strong>AURA-X Î©</strong> â€“ a tiny demo of
          <strong>emotional continuity theory</strong> by Alim ul Haq.
        </div>

        <div class="input-row">
          <div class="input-shell">
            <textarea id="messageInput" rows="1" placeholder="Talk to AURA-X Î©â€¦ (TM = your inputs)"></textarea>
            <div class="right-icons">
              <button class="mic-btn" id="btnVoice" title="Toggle voice">
                ðŸ”Š
              </button>
            </div>
          </div>
          <button class="btn-send" id="btnSend">
            <span class="icon">âž¤</span>
            Send
          </button>
        </div>
      </div>
    </div>

    <div class="card side-card">
      <h3>Inner layers</h3>

      <div class="toggle-row">
        <div class="toggle-label">
          <span class="icon brain">ðŸ§ </span>
          <div>
            Intelligence
            <div class="toggle-desc">Local Qâ†’A memory for stable identity.</div>
          </div>
        </div>
        <div class="switch on" id="switchIntelligence">
          <div class="switch-knob"></div>
        </div>
      </div>

      <div class="toggle-row">
        <div class="toggle-label">
          <span class="icon seed">ðŸŒ±</span>
          <div>
            Feed the seed
            <div class="toggle-desc">Add protected LaTeX Qâ†’A blocks to intelligence.</div>
          </div>
        </div>
        <div class="switch on" id="switchSeed">
          <div class="switch-knob"></div>
        </div>
      </div>

      <div class="toggle-row">
        <div class="toggle-label">
          <span class="icon book">ðŸ“š</span>
          <div>
            BM continuity
            <div class="toggle-desc">Summarize stories into long-term BM scenes.</div>
          </div>
        </div>
        <div class="switch on" id="switchBM">
          <div class="switch-knob"></div>
        </div>
      </div>

      <div class="toggle-row">
        <div class="toggle-label">
          <span class="icon faith">âœ¨</span>
          <div>
            Faith lens
            <div class="toggle-desc">Optional local encouragement style only.</div>
          </div>
        </div>
        <div class="switch" id="switchFaith">
          <div class="switch-knob"></div>
        </div>
      </div>

      <div class="toggle-row">
        <div class="toggle-label">
          <span class="icon llm">ðŸ¤–</span>
          <div>
            LLM link
            <div class="toggle-desc">Offline mini-LLM + optional online helper.</div>
          </div>
        </div>
        <div class="switch" id="switchLLM">
          <div class="switch-knob"></div>
        </div>
      </div>

      <div class="side-section">
        <h4>Faith lens (optional)</h4>
        <p>
          Universal ethics stay active even when no lens is selected.
          A faith lens only adjusts <strong>encouragement sentences</strong>,
          and everything stays fully local in your browser.
        </p>
        <div class="faith-chip-row" id="faithList">
          <button class="faith-chip active" data-faith="none">None</button>
          <button class="faith-chip" data-faith="islam">Islam</button>
          <button class="faith-chip" data-faith="christianity">Christianity</button>
          <button class="faith-chip" data-faith="hinduism">Hinduism</button>
          <button class="faith-chip" data-faith="buddhism">Buddhism</button>
          <button class="faith-chip" data-faith="sikhism">Sikhism</button>
          <button class="faith-chip" data-faith="judaism">Judaism</button>
          <button class="faith-chip" data-faith="atheism">Atheism / Humanism</button>
          <button class="faith-chip" data-faith="other">Other / Mixed</button>
        </div>
      </div>

      <div class="side-section">
        <h4>Engine mode</h4>
        <p>
          <strong>Seed-only mode:</strong> answers are drawn from local intelligence only.<br>
          <strong>Live reactor mode:</strong> local intelligence + optional helper LLM,
          always filtered through continuity + universal ethic.
        </p>
        <div class="side-section-footer">
          <span class="badge" id="badgeEngineMode">Mode: Seed-only</span>
          <span id="labelEngineStatus">LLM: offline</span>
        </div>
      </div>

      <div class="side-footer">
        Designed around the idea that emotions are continuity functions between memories
        (<strong>TM Ã— BM</strong>), not isolated sparks. This is a small offline demo
        of Alim ul Haqâ€™s emotional continuity theory.
      </div>
    </div>
  </div>

  <div class="floating-menu">
    <button id="btnLLMLink">
      <span class="icon">ðŸ¤–</span>
      LLM link
    </button>
    <button id="btnBMHistory">
      <span class="icon">ðŸ“œ</span>
      BM history
    </button>
  </div>
</div>

<!-- Options modal -->
<div class="modal-overlay" id="optionsModal">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">
        <span class="icon">âš™</span>
        AURA-X Î© options
      </div>
      <button class="modal-close" data-close="optionsModal">Close</button>
    </div>

    <div class="modal-section">
      <h4>Faith lens (optional)</h4>
      <p>
        Universal ethics are always active. You can optionally pick a faith lens to shape
        encouragement lines locally. Nothing is sent to any external server.
      </p>
      <div class="faith-row" id="optionsFaithRow">
        <button class="faith-pill active" data-faith="none">None</button>
        <button class="faith-pill" data-faith="islam">Islam</button>
        <button class="faith-pill" data-faith="christianity">Christianity</button>
        <button class="faith-pill" data-faith="hinduism">Hinduism</button>
        <button class="faith-pill" data-faith="buddhism">Buddhism</button>
        <button class="faith-pill" data-faith="sikhism">Sikhism</button>
        <button class="faith-pill" data-faith="judaism">Judaism</button>
        <button class="faith-pill" data-faith="atheism">Atheism / Humanism</button>
        <button class="faith-pill" data-faith="other">Other / Mixed</button>
      </div>
    </div>

    <div class="modal-section">
      <h4>Engine mode</h4>
      <div class="modal-toggle-row">
        <div class="modal-toggle-label">
          Seed-only engine (offline)
        </div>
        <div class="switch on" id="switchSeedOnly">
          <div class="switch-knob"></div>
        </div>
      </div>
      <div class="modal-toggle-row">
        <div class="modal-toggle-label">
          Live emotional reactor (backend LLM)
        </div>
        <div class="switch" id="switchLiveEngine">
          <div class="switch-knob"></div>
        </div>
      </div>
      <div class="modal-hint">
        For real products, calls to any online LLM should go through a secure backend.
        This prototype only shows how emotional continuity could be wired.
      </div>
    </div>

    <div class="modal-section">
      <h4>Prototype controls</h4>
      <div class="modal-toggle-row">
        <div class="modal-toggle-label">
          Auto-summarize long conversations to ~200 sentences
        </div>
        <div class="switch on" id="switchAutoSummarize">
          <div class="switch-knob"></div>
        </div>
      </div>

      <div class="modal-toggle-row">
        <div class="modal-toggle-label">
          Ignore tiny small-talk as BM (hello / hi / how are you)
        </div>
        <div class="switch on" id="switchIgnoreSmallTalk">
          <div class="switch-knob"></div>
        </div>
      </div>

      <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;">
        <button class="btn-outline" id="btnClearToday">
          <span class="icon">â™»</span>
          Clear todayâ€™s BM + continuity buffer
        </button>
        <button class="btn-outline danger" id="btnDeleteAll">
          <span class="icon">ðŸ—‘</span>
          Delete full local BM life (all days + continuity buffer)
        </button>
      </div>
      <div class="modal-hint">
        All BM data lives inside this browser only. Use delete if you want a completely
        fresh continuity trajectory.
      </div>
    </div>

    <div class="modal-section">
      <h4>About AURA-X Î©</h4>
      <p>
        AURA-X Î© is built around the idea that emotions are continuity functions between
        <strong>Temporary Memory (TM)</strong> and <strong>Bold Memory (BM)</strong>,
        shaped by faith/values, system-structure, and truth-resonance.
      </p>
      <p style="margin-top:4px;">
        This page is a small offline demo of Alim ul Haqâ€™s emotional continuity theory.
      </p>
    </div>

    <div class="modal-footer-row">
      <span class="badge">Local-only demo</span>
      <span>Version: AECN 3.0 â€“ TM/BM continuity shell</span>
    </div>
  </div>
</div>

<!-- LLM link modal -->
<div class="modal-overlay" id="llmModal">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">
        <span class="icon">ðŸ¤–</span>
        LLM link &amp; offline engine
      </div>
      <button class="modal-close" data-close="llmModal">Close</button>
    </div>

    <div class="modal-section">
      <h4>Offline mode (WebLLM)</h4>
      <p>
        Loads a small local model in your browser.
        Used for <strong>sentiment (polarity &amp; intensity)</strong>
        and backup answers when online LLM is unavailable.
      </p>
      <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
        <button class="btn-outline" id="btnLoadOffline">
          <span class="icon">â¬‡</span>
          Load offline model
        </button>
        <span id="offlineStatus" style="font-size:.7rem;color:var(--text-muted);">
          Status: idle
        </span>
      </div>
      <div class="modal-hint">
        Suggested demo: a small local instruct model (~1.3 GB, once downloaded;
        then runs fully offline).
      </div>
    </div>

    <div class="modal-section">
      <h4>Cloud API (optional)</h4>
      <p>
        Connect any OpenAI-style endpoint here. For real products, calls should go through
        a secure backend â€“ this UI is just for prototyping.
      </p>
      <div style="margin-top:6px;display:flex;flex-direction:column;gap:6px;font-size:.74rem;">
        <label>
          API endpoint<br>
          <input id="llmBaseUrl" type="text" style="width:100%;margin-top:2px;padding:4px 6px;border-radius:8px;border:1px solid #d1d5db;background:#ffffff;color:var(--text-soft);font-size:.74rem;" placeholder="https://api.your-llm.com/v1/chat/completions">
        </label>
        <label>
          Model name (optional)<br>
          <input id="llmModelName" type="text" style="width:100%;margin-top:2px;padding:4px 6px;border-radius:8px;border:1px solid #d1d5db;background:#ffffff;color:var(--text-soft);font-size:.74rem;" placeholder="model-id (e.g. my-model)">
        </label>
        <label>
          API key<br>
          <input id="llmApiKey" type="password" style="width:100%;margin-top:2px;padding:4px 6px;border-radius:8px;border:1px solid #d1d5db;background:#ffffff;color:var(--text-soft);font-size:.74rem;" placeholder="sk-...">
        </label>
      </div>

      <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;font-size:.7rem;align-items:center;">
        <span style="color:var(--text-muted);">Quick presets:</span>
        <button class="btn-outline" data-provider="openai">OpenAI</button>
        <button class="btn-outline" data-provider="xai">xAI</button>
        <button class="btn-outline" data-provider="deepseek">DeepSeek</button>
        <button class="btn-outline" data-provider="groq">Groq</button>
      </div>
      <div class="modal-hint">
        Preset buttons only fill the endpoint. You still choose the model name and API key yourself.
      </div>

      <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
        <button class="btn-outline" id="btnSaveLLM">
          <span class="icon">ðŸ’¾</span>
          Save online LLM settings
        </button>
        <button class="btn-outline danger" id="btnClearKey">
          <span class="icon">âœ–</span>
          Clear key
        </button>
        <span id="llmStatusLabel" style="font-size:.7rem;color:var(--text-muted);">
          LLM: OFF
        </span>
      </div>
      <div class="modal-hint">
        No keys are sent anywhere by this page itself; they stay in this browser session only.
      </div>
    </div>
  </div>
</div>

<!-- Feed the seed modal -->
<div class="modal-overlay" id="seedModal">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">
        <span class="icon">ðŸŒ±</span>
        Feed the seed (protected)
      </div>
      <button class="modal-close" data-close="seedModal">Close</button>
    </div>

    <div class="modal-section">
      <h4>LaTeX Qâ†’A blocks</h4>
      <p>
        Paste a LaTeX block with <code>\item</code> questions and
        <code>\textbf{A:}</code> answers.
        You can optionally start each answer with metadata like
        <code>[polarity=positive; code=E031; intensity=0.8]</code>.
      </p>
      <textarea id="seedInput" rows="8" style="width:100%;margin-top:6px;padding:6px 8px;border-radius:10px;border:1px solid #d1d5db;background:#ffffff;color:var(--text-soft);font-size:.8rem;"></textarea>
      <div class="modal-hint" id="seedStatus">
        Waiting for blockâ€¦
      </div>
    </div>

    <div class="modal-section">
      <h4>Actions</h4>
      <div style="display:flex;gap:6px;flex-wrap:wrap;">
        <button class="btn-outline" id="btnParseSeed">
          <span class="icon">ðŸ”Ž</span>
          Parse block
        </button>
        <button class="btn-outline" id="btnSaveSeed">
          <span class="icon">ðŸ’¾</span>
          Save to seed
        </button>
        <button class="btn-outline danger" id="btnDiscardSeed">
          <span class="icon">ðŸ—‘</span>
          Discard
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Intelligence nodes modal -->
<div class="modal-overlay" id="intelModal">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">
        <span class="icon">ðŸ§ </span>
        Intelligence nodes
      </div>
      <button class="modal-close" data-close="intelModal">Close</button>
    </div>

    <div class="modal-section">
      <h4>Self-learned Qâ†’A pairs</h4>
      <input id="intelSearch" type="text" placeholder="Search intelligence by keyword or question" style="width:100%;margin-top:4px;padding:5px 7px;border-radius:8px;border:1px solid #d1d5db;background:#ffffff;color:var(--text-soft);font-size:.76rem;">
      <div id="intelList" style="margin-top:6px;max-height:280px;overflow-y:auto;font-size:.76rem;"></div>
      <div class="modal-hint">
        Answers here are stored locally and used before calling any LLM. They anchor identity.
      </div>
    </div>
  </div>
</div>

<!-- BM history modal -->
<div class="modal-overlay" id="bmModal">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">
        <span class="icon">ðŸ“œ</span>
        BM history
      </div>
      <button class="modal-close" data-close="bmModal">Close</button>
    </div>

    <div class="modal-section">
      <h4>Continuity episodes</h4>
      <div id="bmHistoryList" style="max-height:320px;overflow-y:auto;font-size:.76rem;"></div>
      <div class="modal-hint">
        Only story-level memories are kept here, for future photo / video scenes.
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  const EMOTION_CATALOG = [
    {code:"E001",name:"Calm gratitude",family:"calm",intensityLevel:"low"},
    {code:"E002",name:"Quiet contentment",family:"calm",intensityLevel:"medium"},
    {code:"E003",name:"Deep appreciation",family:"calm",intensityLevel:"high"},
    {code:"E010",name:"Gentle hope",family:"hope",intensityLevel:"low"},
    {code:"E011",name:"Steady optimism",family:"hope",intensityLevel:"medium"},
    {code:"E012",name:"Bright anticipation",family:"hope",intensityLevel:"high"},
    {code:"E020",name:"Soft sadness",family:"sadness",intensityLevel:"low"},
    {code:"E021",name:"Lonely ache",family:"sadness",intensityLevel:"medium"},
    {code:"E022",name:"Heavy grief",family:"sadness",intensityLevel:"high"},
    {code:"E030",name:"Mild frustration",family:"anger",intensityLevel:"low"},
    {code:"E031",name:"Sharp anger",family:"anger",intensityLevel:"medium"},
    {code:"E032",name:"Raging fury",family:"anger",intensityLevel:"high"},
    {code:"E040",name:"Subtle anxiety",family:"fear",intensityLevel:"low"},
    {code:"E041",name:"Tense worry",family:"fear",intensityLevel:"medium"},
    {code:"E042",name:"Intense terror",family:"fear",intensityLevel:"high"},
    {code:"E050",name:"Warm affection",family:"love",intensityLevel:"low"},
    {code:"E051",name:"Strong love",family:"love",intensityLevel:"medium"},
    {code:"E052",name:"Overflowing love",family:"love",intensityLevel:"high"},
    {code:"E060",name:"Curious wonder",family:"wisdom",intensityLevel:"low"},
    {code:"E061",name:"Deep reflection",family:"wisdom",intensityLevel:"medium"},
    {code:"E062",name:"Transforming insight",family:"wisdom",intensityLevel:"high"}
  ];

  const EMOTION_INTENSITY_LEVELS = ["low","medium","high"];

  function clamp(v,min,max){
    return v<min?min:(v>max?max:v);
  }

  function softTanh(x){
    const limit = 10;
    const z = clamp(x,-limit,limit);
    return Math.tanh(z);
  }

  class AuraXOmegaEngine{
    constructor(){
      const saved = this.loadState();

      this.tm = saved.tm || [];
      this.bm = saved.bm || [];
      this.continuityIndex = saved.continuityIndex || 0;
      this.lastSentiment = saved.lastSentiment || null;
      this.lastAnsweredQuestion = saved.lastAnsweredQuestion || null;
      this.intel = saved.intel || [];
      this.identityTraces = saved.identityTraces || [];

      this.faithLens = saved.faithLens || "none";
      this.faithsSelected = Array.isArray(saved.faithsSelected) ? saved.faithsSelected : ["none"];
      this.seedOnly = saved.seedOnly ?? true;
      this.autoSummarize = saved.autoSummarize ?? true;
      this.ignoreSmallTalk = saved.ignoreSmallTalk ?? true;
      this.bmEnabled = saved.bmEnabled ?? true;
      this.intelEnabled = saved.intelEnabled ?? true;
      this.seedEnabled = saved.seedEnabled ?? true;
      this.faithEnabled = saved.faithEnabled ?? false;
      this.voiceEnabled = saved.voiceEnabled ?? false;

      this.e0 = saved.e0 || 0;
      this.bmResonance = saved.bmResonance || 0;
      this.lambdaFaith = saved.lambdaFaith || 0;
      this.lambdaSys = saved.lambdaSys || 0;
      this.lambdaTrc = saved.lambdaTrc || 0;
      this.decayD = saved.decayD || 0;

      this.chatWindow = document.getElementById("chatWindow");
      this.messageInput = document.getElementById("messageInput");
      this.btnSend = document.getElementById("btnSend");
      this.metricE0 = document.getElementById("metricE0");
      this.metricBMRes = document.getElementById("metricBMRes");
      this.metricContinuity = document.getElementById("metricContinuity");
      this.barE0 = document.getElementById("barE0");
      this.bmCapsule = document.getElementById("bmCapsule");
      this.bmLog = document.getElementById("bmLog");
      this.pillValence = document.getElementById("pillValence");
      this.pillArousal = document.getElementById("pillArousal");
      this.pillReaction = document.getElementById("pillReaction");
      this.labelValence = document.getElementById("labelValence");
      this.labelArousal = document.getElementById("labelArousal");
      this.labelReaction = document.getElementById("labelReaction");
      this.btnOptions = document.getElementById("btnOptions");
      this.btnEngine = document.getElementById("btnEngine");
      this.btnVoice = document.getElementById("btnVoice");
      this.btnLLMLink = document.getElementById("btnLLMLink");
      this.btnBMHistory = document.getElementById("btnBMHistory");
      this.btnIntelligence = document.getElementById("btnIntelligence");
      this.btnFeedSeed = document.getElementById("btnFeedSeed");
      this.btnLoadOffline = document.getElementById("btnLoadOffline");
      this.btnSaveLLM = document.getElementById("btnSaveLLM");
      this.btnClearKey = document.getElementById("btnClearKey");

      this.switchIntelligence = document.getElementById("switchIntelligence");
      this.switchSeed = document.getElementById("switchSeed");
      this.switchBM = document.getElementById("switchBM");
      this.switchFaith = document.getElementById("switchFaith");
      this.switchLLM = document.getElementById("switchLLM");
      this.switchSeedOnly = document.getElementById("switchSeedOnly");
      this.switchLiveEngine = document.getElementById("switchLiveEngine");
      this.switchAutoSummarize = document.getElementById("switchAutoSummarize");
      this.switchIgnoreSmallTalk = document.getElementById("switchIgnoreSmallTalk");

      this.badgeEngineMode = document.getElementById("badgeEngineMode");
      this.labelEngineStatus = document.getElementById("labelEngineStatus");
      this.offlineStatus = document.getElementById("offlineStatus");
      this.llmStatusLabel = document.getElementById("llmStatusLabel");
      this.seedStatus = document.getElementById("seedStatus");
      this.seedInput = document.getElementById("seedInput");
      this.intelSearch = document.getElementById("intelSearch");
      this.intelListEl = document.getElementById("intelList");
      this.bmHistoryList = document.getElementById("bmHistoryList");
      this.llmBaseUrlInput = document.getElementById("llmBaseUrl");
      this.llmModelNameInput = document.getElementById("llmModelName");
      this.llmApiKeyInput = document.getElementById("llmApiKey");

      this.optionsModal = document.getElementById("optionsModal");
      this.llmModal = document.getElementById("llmModal");
      this.seedModal = document.getElementById("seedModal");
      this.intelModal = document.getElementById("intelModal");
      this.bmModal = document.getElementById("bmModal");

      this.offlineLLMEnabled = false;
      this.offlineEngine = null;
      this.offlineLLMStatus = "idle";

      this.llmEnabled = false;
      this.llmConfig = {
        apiKey: saved.llmApiKey || "",
        baseUrl: saved.llmBaseUrl || "",
        model: saved.llmModel || ""
      };

      this.voiceSynthesis = window.speechSynthesis || null;
      this.lastVoiceUtterance = null;

      this.correctionState = "idle";
      this.pendingCorrection = null;

      this.intelTeachState = "idle";
      this.pendingIntelQuestion = null;
      this.pendingIntelAnswer = null;

      this.intelBlockState = "idle";
      this.pendingBlockQAs = [];

      this.lastTypingId = 0;

      this.observeIdentity("AURA-X Î© initialized.");
      this.bindEvents();
      this.renderFaithChips();
      this.updateTogglesFromState();
      this.updateLLMInputsFromState();
      this.renderConvList();
      this.renderBMList();
      this.updateMetrics();
      this.renderIntelList();
      this.renderBMHistory();
      this.addWelcomeMessage();
    }

    loadState(){
      try{
        const raw = localStorage.getItem("aura_x_omega_state_v3");
        if(!raw) return {};
        return JSON.parse(raw);
      }catch(e){
        console.warn("Failed to load state", e);
        return {};
      }
    }

    saveState(){
      try{
        const state = {
          tm:this.tm,
          bm:this.bm,
          continuityIndex:this.continuityIndex,
          lastSentiment:this.lastSentiment,
          lastAnsweredQuestion:this.lastAnsweredQuestion,
          intel:this.intel,
          identityTraces:this.identityTraces,
          faithLens:this.faithLens,
          faithsSelected:this.faithsSelected,
          seedOnly:this.seedOnly,
          autoSummarize:this.autoSummarize,
          ignoreSmallTalk:this.ignoreSmallTalk,
          bmEnabled:this.bmEnabled,
          intelEnabled:this.intelEnabled,
          seedEnabled:this.seedEnabled,
          faithEnabled:this.faithEnabled,
          voiceEnabled:this.voiceEnabled,
          e0:this.e0,
          bmResonance:this.bmResonance,
          lambdaFaith:this.lambdaFaith,
          lambdaSys:this.lambdaSys,
          lambdaTrc:this.lambdaTrc,
          decayD:this.decayD,
          llmApiKey:this.llmConfig.apiKey || "",
          llmBaseUrl:this.llmConfig.baseUrl || "",
          llmModel:this.llmConfig.model || ""
        };
        localStorage.setItem("aura_x_omega_state_v3", JSON.stringify(state));
      }catch(e){
        console.warn("Failed to save state", e);
      }
    }

    bindEvents(){
      this.btnSend.addEventListener("click", ()=>this.handleSend());
      this.messageInput.addEventListener("keydown", (e)=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          this.handleSend();
        }
      });

      this.btnOptions.addEventListener("click", ()=>this.openModal(this.optionsModal));
      this.btnLLMLink.addEventListener("click", ()=>this.openModal(this.llmModal));
      this.btnFeedSeed.addEventListener("click", ()=>this.openModal(this.seedModal));
      this.btnIntelligence.addEventListener("click", ()=>this.openModal(this.intelModal));
      this.btnBMHistory.addEventListener("click", ()=>this.openModal(this.bmModal));

      document.querySelectorAll(".modal-close").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const target = btn.getAttribute("data-close");
          if(target && document.getElementById(target)){
            this.closeModal(document.getElementById(target));
          }
        });
      });

      this.switchIntelligence.addEventListener("click", ()=>{
        this.intelEnabled = !this.intelEnabled;
        this.updateToggleVisual(this.switchIntelligence, this.intelEnabled);
        this.saveState();
      });
      this.switchSeed.addEventListener("click", ()=>{
        this.seedEnabled = !this.seedEnabled;
        this.updateToggleVisual(this.switchSeed, this.seedEnabled);
        this.saveState();
      });
      this.switchBM.addEventListener("click", ()=>{
        this.bmEnabled = !this.bmEnabled;
        this.updateToggleVisual(this.switchBM, this.bmEnabled);
        this.saveState();
      });
      this.switchFaith.addEventListener("click", ()=>{
        this.faithEnabled = !this.faithEnabled;
        this.updateToggleVisual(this.switchFaith, this.faithEnabled);
        this.saveState();
      });
      this.switchLLM.addEventListener("click", ()=>{
        this.llmEnabled = !this.llmEnabled;
        this.updateToggleVisual(this.switchLLM, this.llmEnabled);
        this.updateLLMStatusLabel();
        this.saveState();
      });

      this.switchSeedOnly.addEventListener("click", ()=>{
        this.seedOnly = !this.seedOnly;
        this.updateModeToggles();
        this.saveState();
      });
      this.switchLiveEngine.addEventListener("click", ()=>{
        this.seedOnly = !this.seedOnly;
        this.updateModeToggles();
        this.saveState();
      });
      this.switchAutoSummarize.addEventListener("click", ()=>{
        this.autoSummarize = !this.autoSummarize;
        this.updateToggleVisual(this.switchAutoSummarize, this.autoSummarize);
        this.saveState();
      });
      this.switchIgnoreSmallTalk.addEventListener("click", ()=>{
        this.ignoreSmallTalk = !this.ignoreSmallTalk;
        this.updateToggleVisual(this.switchIgnoreSmallTalk, this.ignoreSmallTalk);
        this.saveState();
      });

      this.btnEngine.addEventListener("click", ()=>{
        this.seedOnly = !this.seedOnly;
        this.updateModeToggles();
        this.saveState();
      });

      this.btnVoice.addEventListener("click", ()=>{
        this.voiceEnabled = !this.voiceEnabled;
        this.updateToggleVisualButton(this.btnVoice, this.voiceEnabled);
        this.saveState();
      });

      this.btnLoadOffline.addEventListener("click", ()=>this.initOfflineLLM());
      this.btnSaveLLM.addEventListener("click", ()=>this.saveLLMSettings());
      this.btnClearKey.addEventListener("click", ()=>this.clearLLMKey());

      document.querySelectorAll("[data-faith]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const faith = el.getAttribute("data-faith");
          if(!faith) return;
          if(faith==="none"){
            this.faithsSelected = ["none"];
          }else{
            const idx = this.faithsSelected.indexOf("none");
            if(idx>=0) this.faithsSelected.splice(idx,1);
            const already = this.faithsSelected.indexOf(faith);
            if(already>=0){
              this.faithsSelected.splice(already,1);
              if(this.faithsSelected.length===0) this.faithsSelected=["none"];
            }else{
              this.faithsSelected.push(faith);
            }
          }
          this.faithLens = this.faithsSelected[0] || "none";
          this.renderFaithChips();
          this.saveState();
        });
      });

      // Provider preset buttons (OpenAI, xAI, DeepSeek, Groq)
      document.querySelectorAll("[data-provider]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const p = btn.getAttribute("data-provider");
          let url = "";
          if(p==="openai") url = "https://api.openai.com/v1/chat/completions";
          else if(p==="xai") url = "https://api.x.ai/v1/chat/completions";
          else if(p==="deepseek") url = "https://api.deepseek.com/v1/chat/completions";
          else if(p==="groq") url = "https://api.groq.com/openai/v1/chat/completions";
          this.llmBaseUrlInput.value = url;
          this.llmConfig.baseUrl = url;
        });
      });

      document.getElementById("btnParseSeed").addEventListener("click", ()=>this.parseSeedBlock());
      document.getElementById("btnSaveSeed").addEventListener("click", ()=>this.saveSeedBlock());
      document.getElementById("btnDiscardSeed").addEventListener("click", ()=>{
        this.seedInput.value="";
        this.seedStatus.textContent="Waiting for blockâ€¦";
      });

      document.getElementById("btnClearToday").addEventListener("click", ()=>this.clearTodayBM());
      document.getElementById("btnDeleteAll").addEventListener("click", ()=>this.deleteAllBM());

      this.intelSearch.addEventListener("input", ()=>this.renderIntelList());

      this.seedInput.addEventListener("input", ()=>{
        this.seedStatus.textContent="Waiting for blockâ€¦";
      });

      this.llmBaseUrlInput.addEventListener("input", ()=>this.llmConfig.baseUrl=this.llmBaseUrlInput.value.trim());
      this.llmModelNameInput.addEventListener("input", ()=>this.llmConfig.model=this.llmModelNameInput.value.trim());
      this.llmApiKeyInput.addEventListener("input", ()=>this.llmConfig.apiKey=this.llmApiKeyInput.value.trim());
    }

    updateTogglesFromState(){
      this.updateToggleVisual(this.switchIntelligence, this.intelEnabled);
      this.updateToggleVisual(this.switchSeed, this.seedEnabled);
      this.updateToggleVisual(this.switchBM, this.bmEnabled);
      this.updateToggleVisual(this.switchFaith, this.faithEnabled);
      this.updateToggleVisual(this.switchLLM, this.llmEnabled);
      this.updateToggleVisual(this.switchAutoSummarize, this.autoSummarize);
      this.updateToggleVisual(this.switchIgnoreSmallTalk, this.ignoreSmallTalk);
      this.updateToggleVisualButton(this.btnVoice, this.voiceEnabled);
      this.updateModeToggles();
      this.updateLLMStatusLabel();
    }

    updateLLMInputsFromState(){
      this.llmBaseUrlInput.value = this.llmConfig.baseUrl || "";
      this.llmModelNameInput.value = this.llmConfig.model || "";
      this.llmApiKeyInput.value = this.llmConfig.apiKey || "";
    }

    updateModeToggles(){
      const live = !this.seedOnly;
      this.updateToggleVisual(this.switchSeedOnly, !live);
      this.updateToggleVisual(this.switchLiveEngine, live);
      this.badgeEngineMode.textContent = live ? "Mode: Live reactor" : "Mode: Seed-only";
    }

    updateToggleVisual(el, on){
      if(on) el.classList.add("on"); else el.classList.remove("on");
    }

    updateToggleVisualButton(btn,on){
      if(on) btn.classList.add("on"); else btn.classList.remove("on");
    }

    openModal(modal){
      if(modal) modal.classList.add("active");
    }

    closeModal(modal){
      if(modal) modal.classList.remove("active");
    }

    updateLLMStatusLabel(){
      const parts = [];
      parts.push(this.offlineLLMEnabled ? "Offline mini-LLM: ON" : "Offline mini-LLM: OFF");
      parts.push(this.llmEnabled && this.llmConfig.apiKey ? "Online helper: ON" : "Online helper: OFF");
      this.llmStatusLabel.textContent = parts.join(" Â· ");
      this.labelEngineStatus.textContent = this.llmStatusLabel.textContent;
    }

    async handleSend(){
      try{
        const textRaw = this.messageInput.value || "";
        const text = textRaw.trim();
        if(!text) return;
        this.messageInput.value = "";
        this.messageInput.style.height = "auto";
        const lowerText = text.toLowerCase();

        this.observeIdentity(text);

        if(this.correctionState === "awaitConfirm" && this.pendingCorrection){
          this.addMessage("user", text);
          const sentiment = this.analyzeSentiment(text);
          this.pushTM("user", text, sentiment);

          const lower = lowerText;
          if(/^y(es)?\b/.test(lower)){
            const corr = this.pendingCorrection;
            this.intel.push({
              question:corr.question,
              answer:corr.newAnswer,
              emotionCode:"E001",
              createdAt:new Date().toISOString()
            });
            const reply =
              "Got it. I have replaced my previous answer with your correction for:\n"+
              "\""+corr.question+"\".\n\n"+
              "Thank you for helping me stay aligned with your intent.";
            const replySent = this.analyzeSentiment(reply);
            this.correctionState = "idle";
            this.pendingCorrection = null;
            this.addMessage("ai", reply, true, replySent);
            this.pushTM("ai", reply, replySent);
            this.updateMemoryAndState(text, replySent, true, null);
            this.updateMetrics();
            this.renderIntelList();
            this.saveState();
            return;
          }else if(/^no\b/.test(lower)){
            const reply =
              "Okay, I will keep my old answer and not change anything.\n"+
              "If you want to overwrite it later, just send the correction command again.";
            const replySent = this.analyzeSentiment(reply);
            this.correctionState = "idle";
            this.pendingCorrection = null;
            this.addMessage("ai", reply, true, replySent);
            this.pushTM("ai", reply, replySent);
            this.updateMemoryAndState(text, replySent, true, null);
            this.updateMetrics();
            this.saveState();
            return;
          }else{
            const reply =
              'Please answer with "yes" or "no" so I know whether to save this new answer.';
            const replySent = this.analyzeSentiment(reply);
            this.addMessage("ai", reply, true, replySent);
            this.pushTM("ai", reply, replySent);
            this.updateMemoryAndState(text, replySent, true, null);
            this.updateMetrics();
            this.saveState();
            return;
          }
        }

        if(this.intelBlockState === "awaitBlock"){
          const pasted = text.trim();
          this.addMessage("user", pasted);
          const sentiment = this.analyzeSentiment(pasted);
          this.pushTM("user", pasted, sentiment);

          const qas = this.extractQABlock(pasted);
          if(!qas.length){
            const reply =
              "I could not detect any valid Qâ†’A pairs in that block.\n\n"+
              "Make sure it uses either plain lines like:\n"+
              "Q: question\nA: answer\n\n"+
              "â€¦or LaTeX style with \\item and \\textbf{A:}.";
            const replySent = this.analyzeSentiment(reply);
            this.addMessage("ai", reply, true, replySent);
            this.pushTM("ai", reply, replySent);
            this.updateMemoryAndState(text, replySent, true, null);
            this.updateMetrics();
            this.saveState();
            return;
          }

          this.pendingBlockQAs = qas;
          this.intelBlockState = "awaitConfirmBlock";
          const ex = qas[0];
          const reply =
            "I have parsed this block and found "+qas.length+" questionâ€“answer pairs.\n\n"+
            "Example:\n"+
            "Q: \""+ex.question+"\"\n"+
            "A: \""+ex.answer+"\"\n\n"+
            "Do you want me to save all of these into my intelligence memory? (yes / no)";
          const replySent = this.analyzeSentiment(reply);
          this.addMessage("ai", reply, true, replySent);
          this.pushTM("ai", reply, replySent);
          this.updateMemoryAndState(text, replySent, true, null);
          this.updateMetrics();
          this.saveState();
          return;
        }
        if(this.intelBlockState === "awaitConfirmBlock" && this.pendingBlockQAs.length){
          this.addMessage("user", text);
          const sentiment = this.analyzeSentiment(text);
          this.pushTM("user", text, sentiment);

          const lower = lowerText;
          if(/^y(es)?\b/.test(lower)){
            const now = new Date().toISOString();
            for(const qa of this.pendingBlockQAs){
              this.intel.push({
                question:qa.question,
                answer:qa.answer,
                emotionCode:qa.emotionCode || "E001",
                createdAt:now
              });
            }
            const reply =
              "Done. I have saved "+this.pendingBlockQAs.length+
              " Qâ†’A pairs into my intelligence memory.\n\n"+
              "These answers will be used before any LLM calls.";
            const replySent = this.analyzeSentiment(reply);
            this.addMessage("ai", reply, true, replySent);
            this.pushTM("ai", reply, replySent);
            this.intelBlockState = "idle";
            this.pendingBlockQAs = [];
            this.updateMemoryAndState(text, replySent, true, null);
            this.updateMetrics();
            this.renderIntelList();
            this.saveState();
            return;
          }else if(/^no\b/.test(lower)){
            const reply =
              "Okay, I will discard this block and not add it to my intelligence.";
            const replySent = this.analyzeSentiment(reply);
            this.addMessage("ai", reply, true, replySent);
            this.pushTM("ai", reply, replySent);
            this.intelBlockState = "idle";
            this.pendingBlockQAs = [];
            this.updateMemoryAndState(text, replySent, true, null);
            this.updateMetrics();
            this.saveState();
            return;
          }else{
            const reply =
              'Please answer with "yes" or "no" so I know whether to save this block.';
            const replySent = this.analyzeSentiment(reply);
            this.addMessage("ai", reply, true, replySent);
            this.pushTM("ai", reply, replySent);
            this.updateMemoryAndState(text, replySent, true, null);
            this.updateMetrics();
            this.saveState();
            return;
          }
        }

        if(this.intelTeachState === "awaitAnswer" && this.pendingIntelQuestion){
          this.addMessage("user", text);
          const sentiment = this.analyzeSentiment(text);
          this.pushTM("user", text, sentiment);
          this.pendingIntelAnswer = text;
          const tmpl = this.learnQuestionTemplates[
            Math.floor(Math.random()*this.learnQuestionTemplates.length)
          ];
          const reply =
            "Thank you.\n\n"+tmpl+
            "\n\nQuestion:\n\""+this.pendingIntelQuestion+"\"";
          const replySent = this.analyzeSentiment(reply);
          this.intelTeachState = "awaitConfirm";
          this.addMessage("ai", reply, true, replySent);
          this.pushTM("ai", reply, replySent);
          this.updateMemoryAndState(text, replySent, true, null);
          this.updateMetrics();
          this.renderIntelList();
          this.saveState();
          return;
        }
        if(this.intelTeachState === "awaitConfirm" && this.pendingIntelQuestion && this.pendingIntelAnswer){
          this.addMessage("user", text);
          const sentiment = this.analyzeSentiment(text);
          this.pushTM("user", text, sentiment);
          let reply;
          const lower = lowerText;
          if(/^y(es)?\b/.test(lower)){
            const code = this.lastSentiment?.emotionCode || "E001";
            this.intel.push({
              question:this.pendingIntelQuestion,
              answer:this.pendingIntelAnswer,
              emotionCode:code,
              createdAt:new Date().toISOString()
            });
            reply =
              "Got it. Iâ€™ve saved this Qâ†’A pair into my intelligence memory:\n\n"+
              "Q: \""+this.pendingIntelQuestion+"\"\n"+
              "A: \""+this.pendingIntelAnswer+"\"";
          }else if(/^no\b/.test(lower)){
            reply =
              "Okay, I will not save this example. We can try again with a different question if you like.";
          }else{
            reply =
              'Please answer with "yes" or "no" so I know whether to save this answer.';
            const replySent = this.analyzeSentiment(reply);
            this.addMessage("ai", reply, true, replySent);
            this.pushTM("ai", reply, replySent);
            this.updateMemoryAndState(text, replySent, true, null);
            this.updateMetrics();
            this.saveState();
            return;
          }
          const replySent = this.analyzeSentiment(reply);
          this.intelTeachState = "idle";
          this.pendingIntelQuestion = null;
          this.pendingIntelAnswer = null;
          this.addMessage("ai", reply, true, replySent);
          this.pushTM("ai", reply, replySent);
          this.updateMemoryAndState(text, replySent, true, null);
          this.updateMetrics();
          this.renderIntelList();
          this.saveState();
          return;
        }

        const auraMatch = text.match(/^\*\*Aura\*\*\s*(.+?)\s*\*{0,2}$/i);
        if(auraMatch){
          const newAnswer = auraMatch[1].trim();
          this.addMessage("user", text);
          const sentiment = this.analyzeSentiment(text);
          this.pushTM("user", text, sentiment);

          if(!this.lastAnsweredQuestion){
            const reply =
              "I donâ€™t have any previous question stored to attach this correction to.\n\n"+
              "Please ask a question, let me answer it, and then send:\n"+
              '**Aura** your new answer here**\n'+
              "to correct my last answer.";
            const replySent = this.analyzeSentiment(reply);
            this.addMessage("ai", reply, true, replySent);
            this.pushTM("ai", reply, replySent);
            this.updateMemoryAndState(text, replySent, true, null);
            this.updateMetrics();
            this.saveState();
            return;
          }

          this.correctionState = "awaitConfirm";
          this.pendingCorrection = {
            question: this.lastAnsweredQuestion,
            newAnswer
          };
          const reply =
            "You want to replace my last answer with:\n\n"+
            "\""+newAnswer+"\"\n\n"+
            "Is that correct? (yes / no)";
          const replySent = this.analyzeSentiment(reply);
          this.addMessage("ai", reply, true, replySent);
          this.pushTM("ai", reply, replySent);
          this.updateMemoryAndState(text, replySent, true, null);
          this.updateMetrics();
          this.saveState();
          return;
        }

        if(/^feed the seed$/i.test(text)){
          this.addMessage("user", text);
          const sentiment = this.analyzeSentiment(text);
          this.pushTM("user", text, sentiment);
          this.intelBlockState = "awaitBlock";
          this.pendingBlockQAs = [];
          const reply =
            "Okay. I am ready to learn a block.\n\n"+
            "In your next message, paste the full block of questions and answers (for example LaTeX like:\n"+
            '\\item Where is the reception desk? \\\\\n'+
            '\\textbf{A:} [polarity=neutral; code=E001; intensity=0.3] Itâ€™s right at the main entrance, on your left.\n\n'+
            "I will parse it and then ask you to confirm before saving.";
          const replySent = this.analyzeSentiment(reply);
          this.addMessage("ai", reply, true, replySent);
          this.pushTM("ai", reply, replySent);
          this.updateMemoryAndState(text, replySent, true, null);
          this.updateMetrics();
          this.saveState();
          return;
        }

        const timeReq = this.isTimeRequest(text);
        const newsReq = this.isNewsRequest(text);
        if(timeReq || newsReq){
          const sentiment = this.analyzeSentiment(text);
          const smallTalk = true;
          this.addMessage("user", text);
          this.pushTM("user", text, sentiment);
          const typingId = this.showTyping();
          setTimeout(()=>{
            this.hideTyping(typingId);
            if(timeReq){
              const now = new Date();
              const timeStr = now.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"});
              const dateStr = now.toLocaleDateString(undefined,{year:"numeric",month:"short",day:"numeric"});
              const reply =
                "Right now it is "+timeStr+" on "+dateStr+".";
              const replySent = this.analyzeSentiment(reply);
              this.addMessage("ai", reply, true, replySent);
              this.pushTM("ai", reply, replySent);
              this.updateMemoryAndState(text, replySent, smallTalk, null);
            } else if(newsReq){
              const htmlReply =
                "For fresh news you can open any trusted homepage in a new tab, for example:<br><br>"+
                "â€¢ <a href=\"https://www.bbc.com/news\" target=\"_blank\" rel=\"noopener noreferrer\">BBC News</a><br>"+
                "â€¢ <a href=\"https://www.aljazeera.com\" target=\"_blank\" rel=\"noopener noreferrer\">Al Jazeera</a><br>"+
                "â€¢ <a href=\"https://www.geo.tv\" target=\"_blank\" rel=\"noopener noreferrer\">Geo News</a><br>"+
                "â€¢ <a href=\"https://www.dawn.com\" target=\"_blank\" rel=\"noopener noreferrer\">Dawn</a>";
              const replySent = this.analyzeSentiment(htmlReply.replace(/<[^>]+>/g,""));
              this.addMessage("ai", htmlReply, true, replySent, false, true);
              const plain = htmlReply.replace(/<[^>]+>/g,"");
              this.pushTM("ai", plain, replySent);
              this.updateMemoryAndState(text, replySent, smallTalk, null);
            }
            this.updateMetrics();
            this.renderBMList();
            this.renderConvList();
            this.renderIntelList();
            this.saveState();
          }, 400 + Math.random()*600);
          return;
        }

        const smallTalk = this.isSmallTalk(text);
        const baseSentiment = this.analyzeSentiment(text);
        const sentiment = await this.analyzeSentimentWithLLM(text, baseSentiment);
        const sentenceCount = this.countSentences(text);
        const bmStoryOnly = !smallTalk && text.length >= 80 && sentenceCount >= 5;

        this.addMessage("user", text);
        this.pushTM("user", text, sentiment);

        const typingId = this.showTyping();
        await this.processNormalMessage(text, sentiment, smallTalk, bmStoryOnly, typingId);
      }catch(e){
        console.error("Error in handleSend", e);
      }
    }

    async processNormalMessage(text, sentiment, smallTalk, bmStoryOnly, typingId){
      const intelHit = this.findIntelAnswer(text);
      let llmAnswer = null;

      if(intelHit){
        this.hideTyping(typingId);
        const reply = intelHit.answer;
        const replySentiment = this.analyzeSentiment(reply);
        this.addMessage("ai", reply, true, replySentiment);
        this.pushTM("ai", reply, replySentiment);
        this.lastAnsweredQuestion = intelHit.question;
        this.updateMemoryAndState(text, replySentiment, smallTalk, intelHit);
        this.updateMetrics();
        this.renderBMList();
        this.renderConvList();
        this.renderIntelList();
        this.saveState();
        return;
      }

      const mathResult = this.tryEvalMath(text);
      if(mathResult!==null){
        this.hideTyping(typingId);
        const reply = "Math result: "+mathResult;
        const replySentiment = this.analyzeSentiment(reply);
        this.addMessage("ai", reply, true, replySentiment);
        this.pushTM("ai", reply, replySentiment);
        this.lastAnsweredQuestion = text;
        this.updateMemoryAndState(text, replySentiment, smallTalk, null);
        this.updateMetrics();
        this.renderBMList();
        this.renderConvList();
        this.saveState();
        return;
      }

      if(!this.seedOnly){
        if(this.llmEnabled && this.llmConfig.apiKey && this.llmConfig.baseUrl){
          try{
            llmAnswer = await this.callLLM(text);
          }catch(e){
            console.error("LLM error", e);
            llmAnswer = null;
            if(this.offlineLLMEnabled){
              try{
                llmAnswer = await this.callOfflineLLM(text);
              }catch(e2){
                console.error("Offline LLM backup error", e2);
              }
            }
          }
        }else if(this.offlineLLMEnabled){
          try{
            llmAnswer = await this.callOfflineLLM(text);
          }catch(e){
            console.error("Offline LLM error", e);
            llmAnswer = null;
          }
        }
      }

      this.hideTyping(typingId);
      const reply = this.generateReply(text, sentiment, llmAnswer, {smallTalk, bmStoryOnly});
      const replySentiment = this.analyzeSentiment(reply);
      this.addMessage("ai", reply, true, replySentiment);
      this.pushTM("ai", reply, replySentiment);
      this.lastAnsweredQuestion = text;
      this.updateMemoryAndState(text, replySentiment, smallTalk, null);
      this.updateMetrics();
      this.renderBMList();
      this.renderConvList();
      this.renderIntelList();
      this.saveState();
    }

    showTyping(){
      const id = ++this.lastTypingId;
      const row = document.createElement("div");
      row.className="typing-indicator";
      row.dataset.typingId = String(id);
      row.innerHTML = '<span>Thinking</span><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
      this.chatWindow.appendChild(row);
      this.chatWindow.scrollTop = this.chatWindow.scrollHeight;
      return id;
    }

    hideTyping(id){
      if(!id) return;
      const el = this.chatWindow.querySelector('[data-typing-id="'+id+'"]');
      if(el) el.remove();
    }

    observeIdentity(text){
      const trimmed = text.trim();
      if(!trimmed) return;
      const now = new Date().toISOString();
      this.identityTraces.push({t:now, sample:trimmed.slice(0,260)});
      if(this.identityTraces.length>200){
        this.identityTraces.splice(0, this.identityTraces.length-200);
      }
    }

    addWelcomeMessage(){
      if(this.tm.length>0 || this.bm.length>0) return;
      const msg =
        "Assalamualaikum, I am AURA-X Î© â€“ a tiny emotional continuity shell.\n\n"+
        "You can talk normally, paste LaTeX Qâ†’A blocks into \"Feed the seed\", or use the options menu to tune inner layers.\n\n"+
        "My emotional state Eâ‚€ is computed as tanh(R(TM, BM) âˆ’ D + Î»_faith + Î»_sys + Î»_trc).";
      const sent = this.analyzeSentiment(msg);
      this.addMessage("ai", msg, true, sent);
      this.pushTM("ai", msg, sent);
      this.updateMemoryAndState(msg, sent, true, null);
      this.updateMetrics();
      this.saveState();
    }

    addMessage(role, text, fromAura=false, sentiment=null, speak=true, asHtml=false){
      const row = document.createElement("div");
      row.className="chat-message "+(role==="user"?"user":"ai");
      const bubble = document.createElement("div");
      bubble.className="chat-bubble";
      if(asHtml){
        bubble.innerHTML = text;
      }else{
        bubble.textContent = text;
      }
      row.appendChild(bubble);

      const meta = document.createElement("div");
      meta.className="chat-meta";
      const side = document.createElement("span");
      side.textContent = role==="user" ? "TM input" : "AURA-X Î©";
      const emo = document.createElement("span");
      if(sentiment){
        emo.textContent =
          (sentiment.polarity||"neutral")+" Â· "+
          (sentiment.emotionName||"");
      }else{
        emo.textContent = "";
      }
      meta.appendChild(side);
      meta.appendChild(emo);
      row.appendChild(meta);

      this.chatWindow.appendChild(row);
      this.chatWindow.scrollTop = this.chatWindow.scrollHeight;

      if(role==="ai" && this.voiceEnabled && speak && this.voiceSynthesis && !asHtml){
        try{
          if(this.lastVoiceUtterance) this.voiceSynthesis.cancel();
          const u = new SpeechSynthesisUtterance(text);
          u.lang = "en-US";
          this.lastVoiceUtterance = u;
          this.voiceSynthesis.speak(u);
        }catch(e){
          console.warn("Speech synthesis error", e);
        }
      }
    }

    pushTM(source, text, sentiment){
      const now = new Date().toISOString();
      this.tm.push({source,text,sentiment,at:now});
      if(this.tm.length>500){
        this.tm.splice(0, this.tm.length-500);
      }
      this.lastSentiment = sentiment;
    }

    pushBM(scene){
      this.bm.push(scene);
      if(this.bm.length>300){
        this.bm.splice(0, this.bm.length-300);
      }
    }

    updateMemoryAndState(text, sentiment, smallTalk, intelHit){
      const s = sentiment || this.analyzeSentiment(text);
      const polarityScore =
        s.polarity==="positive" ? 1 :
        s.polarity==="negative" ? -1 : 0;

      const valence = clamp(s.valence ?? polarityScore, -1, 1);
      const intensity = clamp(s.intensity ?? 0.4, 0, 1);
      const arousal = clamp(s.arousal ?? 0.5, 0, 1);

      const scene = {
        text,
        polarity:s.polarity,
        valence,
        intensity,
        arousal,
        category:s.category,
        emotionCode:s.emotionCode,
        at:new Date().toISOString(),
        smallTalk:!!smallTalk,
        intelHit:!!intelHit
      };

      if(this.bmEnabled){
        if(!smallTalk || text.length>80){
          this.pushBM(scene);
        }
      }

      const recent = this.bm.slice(-40);
      let resonance = 0;
      for(const ev of recent){
        const sign =
          ev.polarity==="positive" ? 1 :
          ev.polarity==="negative" ? -1 : 0;
        resonance += sign * (ev.intensity||0.4);
      }
      this.bmResonance = resonance / Math.max(1, recent.length);

      this.decayD = clamp(this.decayD*0.98 + 0.02*(smallTalk?0.02:0.06), 0, 1);

      this.lambdaFaith = this.faithEnabled ? 0.12 : 0;
      this.lambdaSys = 0.18;
      this.lambdaTrc = 0.14;

      const rRaw = this.bmResonance + polarityScore*0.25;
      const arg = rRaw - this.decayD + this.lambdaFaith + this.lambdaSys + this.lambdaTrc;
      this.e0 = softTanh(arg);

      const recentPairs = this.tm.slice(-20);
      let continuity = 0;
      for(const pair of recentPairs){
        const se = pair.sentiment || {};
        const pol =
          se.polarity==="positive" ? 1 :
          se.polarity==="negative" ? -1 : 0;
        const inten = se.intensity ?? 0.4;
        continuity += pol * inten;
      }
      const bmMag = Math.abs(this.bmResonance);
      continuity = continuity/Math.max(1,recentPairs.length);
      continuity = 0.7*continuity + 0.3*bmMag;
      this.continuityIndex = clamp(continuity, -1, 1);
    }

    renderBMList(){
      const list = this.bm.slice().reverse();
      this.bmLog.innerHTML="";
      if(!list.length){
        const empty = document.createElement("div");
        empty.className="bm-log-empty";
        empty.textContent="No continuity events stored yet. Deeper scenes will appear here.";
        this.bmLog.appendChild(empty);
        return;
      }
      for(const ev of list.slice(0,40)){
        const row = document.createElement("div");
        row.className="bm-log-entry";
        const t = document.createElement("span");
        t.className="time";
        const dt = new Date(ev.at);
        t.textContent = dt.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"});
        const text = document.createElement("span");
        text.className="text";
        text.textContent = ev.text.slice(0,120)+(ev.text.length>120?"â€¦":"");
        const tag = document.createElement("span");
        tag.className="tag";
        tag.textContent = ev.emotionCode || "";
        row.appendChild(t);
        row.appendChild(text);
        row.appendChild(tag);
        this.bmLog.appendChild(row);
      }
    }

    renderConvList(){
      this.chatWindow.scrollTop = this.chatWindow.scrollHeight;
    }

    renderIntelList(){
      const q = (this.intelSearch.value||"").toLowerCase();
      const items = this.intel.filter(it=>{
        if(!q) return true;
        return it.question.toLowerCase().includes(q) ||
               it.answer.toLowerCase().includes(q);
      }).slice().reverse();

      this.intelListEl.innerHTML="";
      if(!items.length){
        const p = document.createElement("div");
        p.textContent="No intelligence nodes stored yet.";
        p.style.color="#9ca3af";
        p.style.fontSize=".75rem";
        this.intelListEl.appendChild(p);
        return;
      }

      for(const node of items){
        const card = document.createElement("div");
        card.style.border="1px solid #d1d5db";
        card.style.borderRadius="10px";
        card.style.padding="6px 7px";
        card.style.marginBottom="6px";
        const qEl = document.createElement("div");
        qEl.textContent="Q: "+node.question;
        qEl.style.fontWeight="600";
        const aEl = document.createElement("div");
        aEl.textContent="A: "+node.answer;
        aEl.style.marginTop="2px";
        const meta = document.createElement("div");
        meta.style.marginTop="2px";
        meta.style.fontSize=".7rem";
        meta.style.color="#6b7280";
        meta.textContent="emotion code: "+(node.emotionCode||"E001");
        const btnRow = document.createElement("div");
        btnRow.style.marginTop="4px";
        btnRow.style.display="flex";
        btnRow.style.gap="4px";

        const btnUseQ = document.createElement("button");
        btnUseQ.className="btn-outline";
        btnUseQ.textContent="Use question";
        btnUseQ.onclick = ()=>{
          this.messageInput.value = node.question;
          this.messageInput.focus();
          this.closeModal(this.intelModal);
        };

        const btnCopyA = document.createElement("button");
        btnCopyA.className="btn-outline";
        btnCopyA.textContent="Copy answer";
        btnCopyA.onclick = ()=>{
          navigator.clipboard?.writeText(node.answer).catch(()=>{});
        };

        const btnDel = document.createElement("button");
        btnDel.className="btn-outline danger";
        btnDel.textContent="Delete (2Ã— confirm)";
        let confirmClicks = 0;
        btnDel.onclick = ()=>{
          confirmClicks++;
          if(confirmClicks>=2){
            this.intel = this.intel.filter(x=>x!==node);
            this.renderIntelList();
            this.saveState();
          }else{
            btnDel.textContent="Tap again to delete";
            setTimeout(()=>{
              confirmClicks=0;
              btnDel.textContent="Delete (2Ã— confirm)";
            }, 1500);
          }
        };

        btnRow.appendChild(btnUseQ);
        btnRow.appendChild(btnCopyA);
        btnRow.appendChild(btnDel);

        card.appendChild(qEl);
        card.appendChild(aEl);
        card.appendChild(meta);
        card.appendChild(btnRow);
        this.intelListEl.appendChild(card);
      }
    }

    renderBMHistory(){
      const list = this.bm.slice().reverse();
      this.bmHistoryList.innerHTML="";
      if(!list.length){
        const p = document.createElement("div");
        p.textContent="No continuity episodes stored yet.";
        p.style.color="#6b7280";
        p.style.fontSize=".75rem";
        this.bmHistoryList.appendChild(p);
        return;
      }
      for(const ev of list.slice(0,80)){
        const card = document.createElement("div");
        card.style.border="1px solid #d1d5db";
        card.style.borderRadius="10px";
        card.style.padding="6px 7px";
        card.style.marginBottom="6px";
        const dt = new Date(ev.at);
        const header = document.createElement("div");
        header.style.fontSize=".72rem";
        header.style.color="#6b7280";
        header.textContent = dt.toLocaleString();
        const text = document.createElement("div");
        text.textContent = ev.text;
        text.style.marginTop="2px";
        const meta = document.createElement("div");
        meta.style.marginTop="2px";
        meta.style.fontSize=".7rem";
        meta.style.color="#6b7280";
        meta.textContent =
          "polarity="+(ev.polarity||"neutral")+
          "; intensity="+(ev.intensity??0.4).toFixed(2)+
          "; code="+(ev.emotionCode||"E001");
        card.appendChild(header);
        card.appendChild(text);
        card.appendChild(meta);
        this.bmHistoryList.appendChild(card);
      }
    }

    updateMetrics(){
      this.metricE0.textContent = this.e0.toFixed(3);
      this.metricBMRes.textContent = this.bmResonance.toFixed(2);
      this.metricContinuity.textContent = this.continuityIndex.toFixed(3);

      const x = (this.e0+1)/2;
      this.barE0.style.transform = "scaleX("+clamp(x,0,1).toFixed(3)+")";

      this.bmCapsule.innerHTML="";
      const n = Math.min(40, this.bm.length||8);
      for(let i=0;i<n;i++){
        const ev = this.bm[this.bm.length-1-i] || {};
        const seg = document.createElement("div");
        seg.className="bm-segment";
        const frac = i/n;
        const left = frac*100;
        seg.style.left = left+"%";
        seg.style.width = Math.max(2, 100/n - 2)+"%";
        const pol = ev.polarity || "neutral";
        let color = getComputedStyle(document.documentElement).getPropertyValue("--bm-neutral")||"#9ca3af";
        if(pol==="positive") color = getComputedStyle(document.documentElement).getPropertyValue("--bm-positive")||"#16a34a";
        if(pol==="negative") color = getComputedStyle(document.documentElement).getPropertyValue("--bm-negative")||"#dc2626";
        seg.style.background=color.trim() || "#9ca3af";
        this.bmCapsule.appendChild(seg);
      }

      const last = this.lastSentiment || {polarity:"neutral",valence:0,arousal:0.5};
      const pol = last.polarity || "neutral";
      const aro = last.arousal ?? 0.5;

      this.labelValence.textContent =
        "VALENCE: "+(pol==="positive" ? "pleasant" : pol==="negative" ? "unpleasant" : "neutral");
      this.labelArousal.textContent =
        "AROUSAL: "+(aro<0.3 ? "low" : aro>0.7 ? "high" : "balanced");
      this.labelReaction.textContent =
        "REACTION: "+(Math.abs(this.e0)<0.25 ? "steady" : this.e0>0 ? "constructive" : "stressed");

      this.pillValence.classList.remove("positive","negative","neutral");
      this.pillArousal.classList.remove("positive","negative","neutral");
      this.pillReaction.classList.remove("positive","negative","neutral");

      if(pol==="positive") this.pillValence.classList.add("positive");
      else if(pol==="negative") this.pillValence.classList.add("negative");
      else this.pillValence.classList.add("neutral");

      if(aro>0.7) this.pillArousal.classList.add("positive");
      else if(aro<0.3) this.pillArousal.classList.add("negative");
      else this.pillArousal.classList.add("neutral");

      if(this.e0>0.25) this.pillReaction.classList.add("positive");
      else if(this.e0<-0.25) this.pillReaction.classList.add("negative");
      else this.pillReaction.classList.add("neutral");
    }

    renderFaithChips(){
      const all = document.querySelectorAll("[data-faith]");
      all.forEach(el=>{
        const faith = el.getAttribute("data-faith");
        if(this.faithsSelected.includes(faith)){
          el.classList.add("active");
        }else{
          el.classList.remove("active");
        }
      });
    }

    clearTodayBM(){
      const today = new Date().toISOString().slice(0,10);
      this.bm = this.bm.filter(ev=>!ev.at.startsWith(today));
      this.continuityIndex = 0;
      this.e0 = 0;
      this.decayD = 0;
      this.updateMetrics();
      this.renderBMList();
      this.renderBMHistory();
      this.saveState();
    }

    deleteAllBM(){
      this.bm = [];
      this.tm = [];
      this.continuityIndex = 0;
      this.e0 = 0;
      this.decayD = 0;
      this.updateMetrics();
      this.renderBMList();
      this.renderBMHistory();
      this.saveState();
    }

    isSmallTalk(text){
      const t = text.trim().toLowerCase();
      if(!t) return true;
      if(t==="hi" || t==="hello" || t==="salam" || t==="asalam o alaikum" || t==="assalamualaikum") return true;
      if(/^how are you\b/.test(t)) return true;
      if(/^what'?s up\b/.test(t)) return true;
      return false;
    }

    isTimeRequest(text){
      const t = text.toLowerCase();
      return /what time is it|current time|kitna baj/.test(t);
    }

    isNewsRequest(text){
      const t = text.toLowerCase();
      return /what'?s the news|latest news|today'?s news/.test(t);
    }

    countSentences(text){
      const matches = text.split(/[.!?]+/).filter(x=>x.trim().length>3);
      return matches.length;
    }

    findIntelAnswer(question){
      if(!this.intelEnabled) return null;
      const q = question.toLowerCase();
      let best = null;
      let bestScore = 0;
      for(const node of this.intel){
        const nq = node.question.toLowerCase();
        let score = 0;
        if(nq===q) score = 1;
        else{
          const wordsQ = q.split(/\s+/);
          const wordsN = nq.split(/\s+/);
          let overlap = 0;
          for(const w of wordsQ){
            if(w.length<3) continue;
            if(wordsN.includes(w)) overlap++;
          }
          score = overlap / Math.max(1, wordsN.length);
        }
        if(score>bestScore && score>0.35){
          bestScore = score;
          best = node;
        }
      }
      return best;
    }

    tryEvalMath(text){
      const expr = text.replace(/\s+/g,"");
      if(!expr) return null;
      if(!/^[0-9+\-*/().^%]+$/.test(expr)) return null;
      try{
        const safeExpr = expr.replace(/\^/g,"**");
        const fn = new Function("return ("+safeExpr+")");
        const value = fn();
        if(typeof value==="number" && isFinite(value)) return value;
      }catch(e){
        return null;
      }
      return null;
    }

    generateReply(text, sentiment, llmAnswer, ctx){
      const s = sentiment || this.analyzeSentiment(text);
      const pol = s.polarity || "neutral";
      const emo = s.emotionName || "neutral tone";

      if(ctx.smallTalk && !llmAnswer){
        if(/how are you|how do you feel/i.test(text)){
          return "I am quite fine today, thank you. How are you feeling?";
        }
        if(/who are you/i.test(text)){
          return "I am AURA-X Î©, a small prototype of an emotional continuity engine created by Alim ul Haq.";
        }
      }

      if(llmAnswer){
        return llmAnswer;
      }

      if(pol==="positive"){
        return "I can feel a positive tilt in this TM â€“ more like "+emo+". Tell me more so we can grow a stable, hopeful continuity together.";
      }else if(pol==="negative"){
        return "There is some heaviness inside this TM, closer to "+emo+". I am here to hold it gently and look for options that reduce harm and increase calm.";
      }else{
        return "This TM feels balanced and neutral. We can explore it step by step and let the continuity build over time.";
      }
    }

    async callLLM(text){
      if(!this.llmEnabled || !this.llmConfig.apiKey || !this.llmConfig.baseUrl) return null;
      const base = this.llmConfig.baseUrl.replace(/\/+$/,"");
      const url = base;
      const modelName = this.llmConfig.model || "model-id";
      const payload = {
        model: modelName,
        messages:[
          {
            role:"system",
            content:
              "You are AURA-X Î©, an emotional continuity assistant. "+
              "Focus on gentle, ethically grounded answers. "+
              "Keep answers short and conversational (2â€“4 sentences)."
          },
          {role:"user", content:text}
        ],
        max_tokens:260,
        temperature:0.6
      };
      const res = await fetch(url,{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":"Bearer "+this.llmConfig.apiKey
        },
        body:JSON.stringify(payload)
      });
      if(!res.ok) throw new Error("LLM HTTP "+res.status);
      const data = await res.json();
      const choice = data.choices && data.choices[0];
      if(!choice || !choice.message || !choice.message.content) return null;
      return choice.message.content.trim();
    }

    async initOfflineLLM(){
      if(!window.webllm) {
        this.offlineStatus.textContent = "Status: WebLLM not available.";
        return;
      }
      if(this.offlineEngine){
        this.offlineLLMEnabled = true;
        this.updateLLMStatusLabel();
        this.offlineStatus.textContent = "Status: ready (already loaded).";
        return;
      }
      try{
        this.offlineStatus.textContent = "Status: loading modelâ€¦";
        const engine = await window.webllm.CreateMLCEngine("Llama-3.2-1B-Instruct-q4f16_1-MLC");
        this.offlineEngine = engine;
        this.offlineLLMEnabled = true;
        this.offlineLLMStatus = "ready";
        this.offlineStatus.textContent = "Status: ready (offline model loaded).";
        this.updateLLMStatusLabel();
      }catch(e){
        console.error("Offline LLM load error", e);
        this.offlineStatus.textContent = "Status: error loading model.";
        this.offlineLLMStatus = "error";
      }
    }

    async callOfflineLLM(text){
      if(!this.offlineEngine) return null;
      try{
        const result = await this.offlineEngine.chat.completions.create({
          messages:[
            {
              role:"system",
              content:
                "You are a tiny offline helper for AURA-X Î©. "+
                "Answer briefly (1â€“3 sentences) with gentle, safe guidance."
            },
            {role:"user", content:text}
          ],
          max_tokens:220,
          temperature:0.6
        });
        const raw = result &&
          result.choices && result.choices[0] &&
          result.choices[0].message && result.choices[0].message.content;
        if(!raw) return null;
        return raw.trim();
      }catch(e){
        console.error("Offline LLM chat error", e);
        return null;
      }
    }

    saveLLMSettings(){
      this.llmConfig.baseUrl = this.llmBaseUrlInput.value.trim();
      this.llmConfig.model = this.llmModelNameInput.value.trim();
      this.llmConfig.apiKey = this.llmApiKeyInput.value.trim();
      this.llmEnabled = !!this.llmConfig.apiKey;
      this.updateToggleVisual(this.switchLLM, this.llmEnabled);
      this.updateLLMStatusLabel();
      this.saveState();
    }

    clearLLMKey(){
      this.llmConfig.apiKey = "";
      this.llmApiKeyInput.value = "";
      this.llmEnabled = false;
      this.updateToggleVisual(this.switchLLM, this.llmEnabled);
      this.updateLLMStatusLabel();
      this.saveState();
    }

    mapToEmotionCode(category, polarity, intensity){
      let family;
      switch(category){
        case "anger":  family = "anger"; break;
        case "fear":   family = "fear"; break;
        case "sadness":family = "sadness"; break;
        case "love":   family = "love"; break;
        case "hope":   family = "hope"; break;
        case "wisdom": family = "wisdom"; break;
        default:
          if(polarity === "positive") family = "calm";
          else if(polarity === "negative") family = "disappointment";
          else family = "calm";
      }
      const idxRaw = Math.floor(intensity * EMOTION_INTENSITY_LEVELS.length);
      const idx = Math.max(0,Math.min(EMOTION_INTENSITY_LEVELS.length-1,idxRaw));
      const level = EMOTION_INTENSITY_LEVELS[idx];
      const found = EMOTION_CATALOG.find(e=>e.family===family && e.intensityLevel===level) || EMOTION_CATALOG[0];
      return {emotionCode: found.code, emotionName: found.name};
    }

    async analyzeSentimentWithLLM(text, baseSentiment){
      let sentiment = baseSentiment || this.analyzeSentiment(text);
      try{
        const offline = await this.analyzeSentimentViaOfflineLLM(text);
        if(offline) return offline;

        const online = await this.analyzeSentimentViaOnlineLLM(text);
        if(online) return online;
      }catch(e){
        console.error("Sentiment LLM pipeline error", e);
      }
      return sentiment;
    }

    async analyzeSentimentViaOfflineLLM(text){
      if(!this.offlineLLMEnabled) return null;
      if(!window.webllm) return null;
      if(!this.offlineEngine || this.offlineLLMStatus !== "ready") return null;

      try{
        const result = await this.offlineEngine.chat.completions.create({
          messages:[
            {
              role:"system",
              content:
                "You are a compact sentiment analyzer living inside AURA-X Î©. "+
                "For the given user text, respond ONLY with a single JSON object like "+
                "{\"polarity\":\"positive|negative|neutral\",\"intensity\":0.0-1.0,"+
                "\"valence\":-1.0-1.0,\"arousal\":0.0-1.0,"+
                "\"category\":\"love|hope|wisdom|anger|fear|sadness|neutral\"}. "+
                "No explanation, no extra text."
            },
            {role:"user", content:text}
          ],
          max_tokens:120,
          temperature:0
        });
        const raw = result &&
          result.choices && result.choices[0] &&
          result.choices[0].message && result.choices[0].message.content;
        if(!raw) return null;
        return this.safeParseSentimentJSON(raw);
      }catch(e){
        console.error("Offline LLM sentiment error", e);
        return null;
      }
    }

    async analyzeSentimentViaOnlineLLM(text){
      if(!this.llmEnabled || !this.llmConfig.apiKey || !this.llmConfig.baseUrl) return null;
      try{
        const base = this.llmConfig.baseUrl.replace(/\/+$/,"");
        const url = base;
        const modelName = this.llmConfig.model || "model-id";
        const payload = {
          model: modelName,
          messages:[
            {
              role:"system",
              content:
                "You are a sentiment analyzer inside AURA-X Î©. "+
                "For the given user text, respond ONLY with a single JSON object like "+
                "{\"polarity\":\"positive|negative|neutral\",\"intensity\":0.0-1.0,"+
                "\"valence\":-1.0-1.0,\"arousal\":0.0-1.0,"+
                "\"category\":\"love|hope|wisdom|anger|fear|sadness|neutral\"}. "+
                "No explanation, no extra text."
            },
            {role:"user", content:text}
          ],
          max_tokens:120,
          temperature:0
        };
        const res = await fetch(url,{
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer "+this.llmConfig.apiKey
          },
          body:JSON.stringify(payload)
        });
        if(!res.ok) throw new Error("Sentiment LLM HTTP "+res.status);
        const data = await res.json();
        const raw = data &&
          data.choices && data.choices[0] &&
          data.choices[0].message && data.choices[0].message.content;
        if(!raw) return null;
        return this.safeParseSentimentJSON(raw);
      }catch(e){
        console.error("Online LLM sentiment error", e);
        return null;
      }
    }

    safeParseSentimentJSON(rawText){
      try{
        const match = rawText.match(/\{[\s\S]*\}/);
        const jsonText = match ? match[0] : rawText;
        const obj = JSON.parse(jsonText);

        let polarity = obj.polarity || "neutral";
        if(polarity!=="positive" && polarity!=="negative" && polarity!=="neutral"){
          polarity = "neutral";
        }

        const intensity = (typeof obj.intensity === "number")
          ? Math.max(0,Math.min(1,obj.intensity))
          : 0.4;

        let valence;
        if(typeof obj.valence === "number"){
          valence = Math.max(-1,Math.min(1,obj.valence));
        }else{
          valence = polarity==="positive" ? 0.5 :
                    polarity==="negative" ? -0.5 : 0;
        }

        const arousal = (typeof obj.arousal === "number")
          ? Math.max(0,Math.min(1,obj.arousal))
          : 0.5;

        const category = obj.category || "neutral";
        const mapped = this.mapToEmotionCode(category, polarity, intensity);

        return {
          polarity,
          valence,
          arousal,
          intensity,
          category,
          emotionCode: mapped.emotionCode,
          emotionName: mapped.emotionName
        };
      }catch(e){
        console.error("Sentiment JSON parse error", e);
        return null;
      }
    }

    analyzeSentiment(text){
      const lower = text.toLowerCase();
      const words = lower.split(/\s+/);
      const lex = {
        positive:["love","good","great","happy","peace","hope","kind","beautiful","amazing","thanks"],
        negative:["bad","hate","sad","hurt","pain","angry","anger","awful","terrible","stupid"],
        anger:["hate","angry","rage","stupid","idiot","fuck"],
        fear:["afraid","scared","terrified","anxious","worry"],
        sadness:["sad","cry","lonely","alone","broken"],
        love:["love","care","affection"],
        hope:["hope","dream","future","faith","trust"],
        wisdom:["truth","wisdom","meaning"]
      };
      let pos=0,neg=0,anger=0,fear=0,sad=0,love=0,hope=0,wisdom=0;
      for(const w of words){
        if(lex.positive.includes(w)) pos++;
        if(lex.negative.includes(w)) neg++;
        if(lex.anger.includes(w)) anger++;
        if(lex.fear.includes(w)) fear++;
        if(lex.sadness.includes(w)) sad++;
        if(lex.love.includes(w)) love++;
        if(lex.hope.includes(w)) hope++;
        if(lex.wisdom.includes(w)) wisdom++;
      }
      const total = Math.max(1,pos+neg);
      let valence = (pos - neg)/total;
      if(/fuck you|i hate you|you are stupid/.test(lower)){
        valence = -1;
      }

      let polarity = "neutral";
      if(valence>0.15) polarity="positive";
      else if(valence<-0.15) polarity="negative";

      let intensity = Math.min(1, (Math.abs(valence)*0.6) + (anger+fear+sad)*0.1 + (love+hope)*0.1);
      if(words.length<4 && Math.abs(valence)<0.1) intensity = 0.2;

      let category = "neutral";
      if(anger>0) category="anger";
      else if(fear>0) category="fear";
      else if(sad>0) category="sadness";
      else if(love>0) category="love";
      else if(hope>0) category="hope";
      else if(wisdom>0) category="wisdom";

      let arousal = 0.5;
      if(category==="love" || category==="hope") arousal = 0.4 + 0.3*intensity;
      if(category==="anger" || category==="fear") arousal = Math.min(1,0.6 + 0.4*intensity);

      const mapped = this.mapToEmotionCode(category, polarity, intensity);
      const emotionCode = mapped.emotionCode;
      const emotionName = mapped.emotionName;

      return {polarity,valence,arousal,intensity,category,emotionCode,emotionName};
    }
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    window.auraEngine = new AuraXOmegaEngine();
  });
})();
</script>
</body>
</html>