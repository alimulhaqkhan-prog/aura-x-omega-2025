<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AURA-X Î© â€“ Offline Emotional Continuity Engine (Prototype)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Offline LLM package (WebLLM, ready for future use) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    /* RESET & BASICS */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0f172a 0, transparent 45%),
        radial-gradient(circle at 0% 100%, #0b1120 0, transparent 55%),
        radial-gradient(circle at 100% 100%, #020617 0, transparent 55%),
        linear-gradient(160deg,#020617,#020617 30%,#020617 70%,#020617);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:16px;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:
        radial-gradient(circle at 10% 0%,rgba(56,189,248,.10),transparent 55%),
        radial-gradient(circle at 90% 0%,rgba(129,140,248,.12),transparent 55%),
        radial-gradient(circle at 10% 100%,rgba(52,211,153,.10),transparent 55%),
        radial-gradient(circle at 90% 100%,rgba(251,191,36,.10),transparent 55%);
      opacity:.65;
      pointer-events:none;
      z-index:-1;
    }

    /* MAIN SHELL */
    .shell{
      width:100%;
      max-width:900px;
      background:linear-gradient(145deg,rgba(15,23,42,.96),rgba(15,23,42,.98));
      border-radius:24px;
      box-shadow:
        0 0 0 1px rgba(148,163,184,.3),
        0 22px 60px rgba(15,23,42,.9);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .header{
      padding:16px 18px 8px;
      border-bottom:1px solid rgba(148,163,184,.35);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      backdrop-filter:blur(16px);
      background:
        linear-gradient(120deg,rgba(15,23,42,.92),rgba(15,23,42,.94)),
        radial-gradient(circle at 20% 0%,rgba(59,130,246,.15),transparent 55%);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .orb{
      width:32px;
      height:32px;
      border-radius:999px;
      background:
        conic-gradient(from 210deg,#22d3ee,#38bdf8,#6366f1,#a855f7,#22c55e,#facc15,#22d3ee);
      padding:1px;
      box-shadow:0 0 20px rgba(56,189,248,.6);
      position:relative;
    }
    .orb::after{
      content:"Î©";
      position:absolute;
      inset:2px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0%,#e5e7eb,#020617 55%);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:18px;
      color:#e5e7eb;
      text-shadow:0 0 10px rgba(15,23,42,.9);
    }
    .titleBlock{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .titleBlock h1{
      font-size:18px;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:800;
    }
    .titleBlock small{
      font-size:11px;
      opacity:.8;
    }
    .capsuleRow{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      padding:4px 10px;
      font-size:11px;
      display:flex;
      align-items:center;
      gap:6px;
      background:radial-gradient(circle at 0 0,rgba(148,163,184,.3),transparent 50%);
    }
    .pill span.val{
      font-weight:700;
      font-variant-numeric:tabular-nums;
    }
    .quickCapsule{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      padding:4px 8px;
      font-size:11px;
      display:flex;
      gap:6px;
      align-items:center;
      background:rgba(15,23,42,.8);
    }
    .quickCapsule .dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0%,#22c55e,#16a34a);
      box-shadow:0 0 10px rgba(34,197,94,.7);
    }

    .content{
      display:flex;
      flex-direction:column;
      height:580px;
    }
    @media (max-height:720px){
      .content{height:520px;}
    }

    .topRow{
      flex:1;
      display:flex;
      gap:14px;
      padding:14px 14px 10px;
    }
    .consoleBox{
      width:36%;
      min-width:0;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.45);
      background:radial-gradient(circle at 0 0,rgba(30,64,175,.45),transparent 60%),
                 radial-gradient(circle at 120% 0,rgba(8,47,73,.6),transparent 60%),
                 rgba(15,23,42,.95);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .consoleHeader{
      padding:8px 10px;
      font-size:11px;
      opacity:.85;
      border-bottom:1px solid rgba(148,163,184,.45);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .console{
      flex:1;
      padding:10px;
      font-size:12px;
      overflow:auto;
      line-height:1.45;
    }
    .console .line{
      opacity:.9;
      margin-bottom:3px;
    }

    .chatBox{
      flex:1;
      min-width:0;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.45);
      background:
        radial-gradient(circle at 0 0,rgba(59,130,246,.35),transparent 60%),
        radial-gradient(circle at 110% 0,rgba(236,72,153,.28),transparent 60%),
        rgba(15,23,42,.95);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      position:relative;
    }
    .chatHeader{
      padding:8px 10px;
      font-size:11px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(148,163,184,.45);
    }
    .optionsBtn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);
      padding:5px 9px;
      display:flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      cursor:pointer;
    }
    .optionsBtn span.icon{font-size:13px;}
    .optionsMenu{
      position:absolute;
      top:34px;
      left:10px;
      z-index:20;
      min-width:190px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.98);
      box-shadow:0 18px 40px rgba(15,23,42,.9);
      padding:6px;
      font-size:13px;
      display:none;
    }
    .optSectionTitle{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.09em;
      opacity:.6;
      margin:6px 6px 3px;
    }
    .optItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:4px 7px;
      border-radius:10px;
      cursor:pointer;
    }
    .optItem:hover{
      background:rgba(30,64,175,.35);
    }
    .optItem span.label{font-size:12px;}
    .optBadge{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      opacity:.85;
    }

    .chatScroll{
      flex:1;
      padding:10px 10px 8px;
      overflow:auto;
      font-size:13px;
      line-height:1.5;
    }

    .inputRow{
      border-top:1px solid rgba(148,163,184,.4);
      padding:8px;
      display:flex;
      gap:8px;
      align-items:flex-end;
      background:linear-gradient(180deg,rgba(15,23,42,.94),rgba(15,23,42,.98));
    }
    textarea#userInput{
      flex:1;
      min-height:40px;
      max-height:90px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.7);
      background:rgba(15,23,42,.97);
      padding:7px 9px;
      resize:vertical;
      color:#e5e7eb;
      font-size:13px;
      outline:none;
    }
    textarea#userInput::placeholder{opacity:.65;}
    button.btn{
      border:none;
      border-radius:999px;
      padding:7px 12px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btnBlue{
      background:linear-gradient(135deg,#38bdf8,#6366f1);
      color:white;
      box-shadow:0 0 18px rgba(56,189,248,.6);
    }
    .btnBlue:active{transform:translateY(1px);}
    .btnSubtle{
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.6);
    }
    .btnRed{
      background:linear-gradient(135deg,#f97373,#ef4444);
      color:white;
    }

    /* Faith bubble */
    .faithBubble{
      position:absolute;
      right:12px;
      bottom:86px;
      max-width:260px;
      border-radius:18px;
      border:1px solid rgba(190,242,100,.7);
      background:radial-gradient(circle at 0 0,rgba(190,242,100,.2),transparent 60%),
                 rgba(15,23,42,.98);
      padding:10px 10px 8px;
      font-size:12px;
      box-shadow:0 20px 40px rgba(22,101,52,.8);
      display:none;
      z-index:25;
    }
    .faithBubbleTitle{
      font-weight:700;
      margin-bottom:4px;
    }
    .faithBubbleMeta{
      font-size:11px;
      opacity:.8;
      margin-bottom:6px;
    }
    .faithBubbleClose{
      position:absolute;
      top:6px;
      right:8px;
      border:none;
      background:none;
      color:#e5e7eb;
      cursor:pointer;
      font-size:14px;
    }

    /* Modals */
    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.8);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
      padding:10px;
    }
    .modal{
      width:100%;
      max-width:680px;
      max-height:90vh;
      background:rgba(15,23,42,.98);
      border-radius:18px;
      border:1px solid rgba(148,163,184,.7);
      box-shadow:0 26px 60px rgba(15,23,42,.95);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .modalHeader{
      padding:10px 14px;
      border-bottom:1px solid rgba(148,163,184,.6);
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:14px;
      font-weight:600;
    }
    .modalHeader small{font-size:11px;font-weight:400;opacity:.8;}
    .modalBody{
      padding:12px 14px 12px;
      overflow:auto;
      font-size:13px;
      line-height:1.45;
    }
    .closeX{
      border:none;
      background:none;
      color:#e5e7eb;
      font-size:20px;
      cursor:pointer;
      padding:0 2px;
    }
    .chipRow{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .chip{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      padding:4px 9px;
      font-size:12px;
      cursor:pointer;
      background:rgba(15,23,42,.95);
    }
    .chip.active{
      background:linear-gradient(135deg,#22c55e,#a3e635);
      color:#022c22;
      border-color:transparent;
    }

    .bmCard{
      border-radius:14px;
      border:1px solid rgba(148,163,184,.55);
      padding:9px 10px;
      margin-top:8px;
      background:radial-gradient(circle at 0 0,rgba(59,130,246,.3),transparent 65%),
                 rgba(15,23,42,.97);
    }
    .bmTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:6px;
    }
    .bmTop .title{
      font-weight:700;
      font-size:14px;
    }
    .bmTop .meta{
      font-size:11px;
      opacity:.75;
    }
    .bmTop .actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .historyLine{
      border-radius:10px;
      border:1px solid rgba(148,163,184,.5);
      padding:6px 8px;
      margin-top:4px;
      font-size:12px;
      background:rgba(15,23,42,.96);
    }

    .fieldLabel{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      opacity:.7;
      margin-top:8px;
      margin-bottom:2px;
    }
    .fieldInput{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.6);
      padding:6px 8px;
      background:rgba(15,23,42,.96);
      color:#e5e7eb;
      font-size:13px;
    }
    .fieldInput[readonly]{
      opacity:.75;
    }

    @media (max-width:768px){
      body{padding:10px;}
      .shell{border-radius:20px;}
      .topRow{flex-direction:column;}
      .consoleBox{width:100%;height:170px;}
      .content{height:auto;max-height:none;}
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="brand">
        <div class="orb"></div>
        <div class="titleBlock">
          <h1>AURA-X Î©</h1>
          <small>Offline emotional continuity engine (prototype)</small>
        </div>
      </div>
      <div class="capsuleRow">
        <div class="quickCapsule">
          <div class="dot"></div>
          <span style="opacity:.8;font-size:11px;">TM = user inputs only Â· Internal layers keep continuity and emotional trajectory.</span>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="topRow">
        <!-- Console -->
        <div class="consoleBox">
          <div class="consoleHeader">
            <span>System console</span>
            <div style="display:flex;gap:6px;align-items:center;font-size:11px;">
              <span>TM</span><span class="val" id="cTM">0.00</span>
              <span>BM</span><span class="val" id="cBM">0.00</span>
              <span>C</span><span class="val" id="cCont">0.850</span>
              <span>Eâ‚€</span><span class="val" id="cE0">0.000</span>
            </div>
          </div>
          <div class="console" id="console"></div>
        </div>

        <!-- Chat -->
        <div class="chatBox">
          <div class="chatHeader">
            <span style="font-size:12px;opacity:.9;">Conversation between <strong>you</strong> and <strong>AURA-X Î©</strong></span>
            <button class="optionsBtn" id="btnOptions">
              <span class="icon">â˜°</span><span>Options</span>
            </button>
          </div>

          <div class="optionsMenu" id="optionsMenu">
            <div class="optSectionTitle">Core engine</div>
            <div class="optItem" id="miVoice">
              <span class="label">Voice output</span>
              <span class="optBadge" id="voicePill">off</span>
            </div>
            <div class="optItem" id="miLearn">
              <span class="label">Learning</span>
              <span class="optBadge" id="learnPill">on</span>
            </div>

            <div class="optSectionTitle">Knowledge layers</div>
            <div class="optItem" id="miIntel"><span class="label">Intelligence (Q/A memory)</span></div>
            <div class="optItem" id="miSeed"><span class="label">Feed the seed (LaTeX Q/A)</span></div>
            <div class="optItem" id="miBMRecall"><span class="label">BM recall (stories)</span></div>
            <div class="optItem" id="miHistory"><span class="label">Conversation history</span></div>

            <div class="optSectionTitle">Faith & identity</div>
            <div class="optItem" id="miFaith">
              <span class="label">Faith lens</span>
              <span class="optBadge" id="faithLabel">none</span>
            </div>
            <div class="optItem" id="miIdentity"><span class="label">Your identity</span></div>

            <div class="optSectionTitle">Helper LLM</div>
            <div class="optItem" id="miLLM"><span class="label">Online / offline helper</span></div>
          </div>

          <div class="chatScroll" id="chatScroll">
            <!-- conversation log is derived from history -->
          </div>

          <div class="inputRow">
            <textarea id="userInput" placeholder="Talk to AURA-X Î©â€¦ (if I ever say â€œI donâ€™t know yetâ€, teach me and Iâ€™ll remember next time.)"></textarea>
            <button class="btn btnBlue" id="sendBtn">
              <span>Send</span> <span>âž¤</span>
            </button>
          </div>

          <!-- Faith bubble -->
          <div class="faithBubble" id="faithBubble">
            <button class="faithBubbleClose" id="faithBubbleClose">Ã—</button>
            <div class="faithBubbleTitle" id="faithBubbleTitle"></div>
            <div class="faithBubbleMeta" id="faithBubbleMeta"></div>
            <div id="faithBubbleText" style="font-size:12px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Faith selection modal -->
  <div class="modalOverlay" id="modalFaith">
    <div class="modal">
      <div class="modalHeader">
        <div>Faith lens<br><small>Select how (or if) faith should colour reflections.</small></div>
        <button class="closeX" data-close="modalFaith">Ã—</button>
      </div>
      <div class="modalBody">
        <p style="font-size:13px;opacity:.8;margin-bottom:8px;">
          This prototype can optionally add a gentle, non-preachy faith-based reflection to some long stories.
          You stay in control; nothing here is a fatwa or replacement for scholars.
        </p>
        <div class="chipRow" id="faithChips"></div>
      </div>
    </div>
  </div>

  <!-- Faith article modal -->
  <div class="modalOverlay" id="modalFaithArticle">
    <div class="modal">
      <div class="modalHeader">
        <div id="faithArticleTitle">Faith reflection</div>
        <button class="closeX" data-close="modalFaithArticle">Ã—</button>
      </div>
      <div class="modalBody">
        <div style="font-size:11px;opacity:.75;margin-bottom:6px;" id="faithArticleMeta"></div>
        <div id="faithArticleText" style="white-space:pre-wrap;"></div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btnBlue" id="btnCopyFaithArticle">Copy reflection</button>
          <button class="btn btnSubtle" id="btnAddFaithToBM">Add to BM as story note</button>
          <button class="btn btnSubtle" id="btnSkipFaithBM">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Intelligence modal -->
  <div class="modalOverlay" id="modalIntel">
    <div class="modal">
      <div class="modalHeader">
        <div>Intelligence layer<br><small>Self-learning Q/A pairs saved on this device.</small></div>
        <button class="closeX" data-close="modalIntel">Ã—</button>
      </div>
      <div class="modalBody">
        <div class="fieldLabel">Search</div>
        <input id="intelSearch" class="fieldInput" placeholder="Search inside your saved questions & answersâ€¦">
        <div id="intelList" style="margin-top:6px;"></div>

        <div id="intelEditor" style="display:none;margin-top:10px;">
          <div class="fieldLabel">Edit question</div>
          <textarea id="intelEditQ" class="fieldInput" rows="2"></textarea>
          <div class="fieldLabel">Edit answer</div>
          <textarea id="intelEditA" class="fieldInput" rows="3"></textarea>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn btnBlue" id="btnIntelSave">Save</button>
            <button class="btn btnSubtle" id="btnIntelCancel">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Seed modal -->
  <div class="modalOverlay" id="modalSeed">
    <div class="modal">
      <div class="modalHeader">
        <div>ðŸŒ± Feed the seed<br><small>Add LaTeX Q â†’ A blocks and optional Logic Pack.</small></div>
        <button class="closeX" data-close="modalSeed">Ã—</button>
      </div>
      <div class="modalBody">
        <p style="font-size:13px;opacity:.8;margin-bottom:8px;">
          Paste a LaTeX block with \item questions and \textbf{A:} answers. You can optionally start each answer
          with [polarity=positive; code=E031; intensity=0.8].
        </p>
        <textarea id="seedBox" class="fieldInput" rows="6"
          placeholder="Paste LaTeX conversation / logic block hereâ€¦"></textarea>
        <div id="seedHint" style="font-size:12px;opacity:.8;margin-top:4px;">Waiting for blockâ€¦</div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btnBlue" id="btnParseSeed">Parse block</button>
          <button class="btn btnSubtle" id="btnSaveSeed">Save to seed</button>
          <button class="btn btnRed" id="btnDiscardSeed">Discard</button>
        </div>

        <hr style="border:none;border-top:1px solid rgba(148,163,184,.5);margin:14px 0 10px;">

        <div style="font-size:13px;font-weight:600;margin-bottom:4px;">ðŸ§© Logic Pack (JSON rules â€“ advanced)</div>
        <p style="font-size:12px;opacity:.8;margin-bottom:6px;">
          Each time you press Save, a new logic pack is stored with its own number.
          Saved logic packs never auto-delete; they can only be removed manually with double confirmation.
        </p>
        <textarea id="logicBox" class="fieldInput" rows="6" spellcheck="false"></textarea>
        <div id="logicHint" style="font-size:12px;opacity:.8;margin-top:4px;">Logic pack deleted.</div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btnSubtle" id="btnValidateLogic">Validate</button>
          <button class="btn btnBlue" id="btnSaveLogic">Save</button>
          <button class="btn btnSubtle" id="btnCopyLogic">Copy</button>
          <button class="btn btnRed" id="btnDeleteLogic">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- LLM modal -->
  <div class="modalOverlay" id="modalLLM">
    <div class="modal">
      <div class="modalHeader">
        <div>Helper LLM settings<br><small>Offline model (browser) and optional online API.</small></div>
        <button class="closeX" data-close="modalLLM">Ã—</button>
      </div>
      <div class="modalBody">
        <p style="font-size:13px;opacity:.8;margin-bottom:8px;">
          Offline LLM runs fully in your browser (WebGPU) using WebLLM. Online API is optional and can be used
          only when offline layers do not know the answer.
        </p>
        <div class="fieldLabel">Offline model status</div>
        <div id="offlineStatus" style="font-size:12px;opacity:.85;">Not loaded yet.</div>

        <hr style="border:none;border-top:1px solid rgba(148,163,184,.5);margin:12px 0;">

        <div class="fieldLabel">Online API endpoint</div>
        <input id="apiEndpoint" class="fieldInput" placeholder="https://api.openai.com/v1/chat/completions">
        <div class="fieldLabel">Model name</div>
        <input id="apiModel" class="fieldInput" placeholder="gpt-4.1-mini or similar">
        <div class="fieldLabel">API key</div>
        <input id="apiKey" class="fieldInput" type="password" placeholder="sk-â€¦ (stored only in this browser)">
        <div style="margin-top:8px;">
          <button class="btn btnBlue" id="btnSaveLLM">Save LLM config</button>
        </div>
      </div>
    </div>
  </div>

  <!-- BM Recall -->
  <div class="modalOverlay" id="modalBM">
    <div class="modal">
      <div class="modalHeader">
        <div>ðŸ“˜ Recall from BM<br><small>Long stories / scenes only.</small></div>
        <button class="closeX" data-close="modalBM">Ã—</button>
      </div>
      <div class="modalBody">
        <div style="font-size:13px;opacity:.75">
          Select a BM prompt. Locked prompts must be unlocked first. Delete needs double confirmation.
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <input type="date" id="bmFilterDate"
            style="flex:1;min-width:0;border-radius:12px;border:1px solid rgba(15,23,42,.18);padding:6px 10px;font-size:13px;outline:none;background:rgba(255,255,255,.9)" />
          <button class="btn btnBlue" id="btnFilterBM">Recall by date</button>
          <button class="btn" id="btnClearBMFilter">Clear</button>
        </div>
        <div id="bmSelectList"></div>
        <div class="bmCard" id="bmViewer" style="display:none;">
          <div class="bmTop">
            <div>
              <div class="title"><span id="bmLockIcon">ðŸ”“</span> <span id="bmTitle">Prompt</span></div>
              <div class="meta" id="bmMeta"></div>
            </div>
            <div class="actions">
              <button class="btn btnSubtle" id="btnUnlockBM">Unlock</button>
              <button class="btn btnSubtle" id="btnLiveBM">Live 12h: off</button>
              <button class="btn btnSubtle" id="btnCopyPrompt">Copy</button>
              <button class="btn btnSubtle" id="btnAutoGen">Auto-gen</button>
              <button class="btn btnRed" id="btnDeletePrompt">Delete</button>
            </div>
          </div>
          <textarea id="bmTextArea" class="fieldInput" rows="8"
            style="margin-top:4px;white-space:pre-wrap;"></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Conversation history -->
  <div class="modalOverlay" id="modalHistory">
    <div class="modal">
      <div class="modalHeader">
        <div>ðŸ•’ Conversation history<br><small>Recent TM log (user + system messages).</small></div>
        <button class="closeX" data-close="modalHistory">Ã—</button>
      </div>
      <div class="modalBody">
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px;">
          <button class="btn btnSubtle" id="btnDeleteRecent">Delete history last 48h</button>
          <button class="btn btnRed" id="btnDeleteAllHist">Delete all history</button>
          <button class="btn btnSubtle" id="btnCopyHistory">Copy all</button>
        </div>
        <div id="historyBox"></div>
      </div>
    </div>
  </div>

  <!-- Identity modal -->
  <div class="modalOverlay" id="modalIdentity">
    <div class="modal">
      <div class="modalHeader">
        <div>Your deep identity<br><small>Helps AURA-X Î© mirror your style & long-term meaning.</small></div>
        <button class="closeX" data-close="modalIdentity">Ã—</button>
      </div>
      <div class="modalBody">
        <p style="font-size:13px;opacity:.8;margin-bottom:6px;">
          These fields never leave this device. They are only used to shape how AURA-X Î© responds.
        </p>

        <div class="fieldLabel">Full name</div>
        <input id="uName" class="fieldInput" placeholder="Your full name">

        <div class="fieldLabel">Preferred short name / nickname</div>
        <input id="uNick" class="fieldInput" placeholder="What should I call you?">

        <div class="fieldLabel">Where are you coming from in life?</div>
        <textarea id="uOrigin" class="fieldInput" rows="2"
          placeholder="Key background (e.g., student of X, parent, entrepreneur, etc.)"></textarea>

        <div class="fieldLabel">Current place / city</div>
        <input id="uPlace" class="fieldInput" placeholder="City / country (optional)">

        <div class="fieldLabel">Main roles / profession</div>
        <textarea id="uProfession" class="fieldInput" rows="2"
          placeholder="What do you mainly do in life?"></textarea>

        <div class="fieldLabel">Emotional style</div>
        <textarea id="uEmotionalStyle" class="fieldInput" rows="2"
          placeholder="Calm, intense, humorous, analytical, etc."></textarea>

        <div class="fieldLabel">Key people / relationships</div>
        <textarea id="uKeyPeople" class="fieldInput" rows="3"
          placeholder="People you deeply care about (only what you are comfortable writing)."></textarea>

        <div class="fieldLabel">Legacy boundaries & rules</div>
        <textarea id="uLegacyRules" class="fieldInput" rows="3"
          placeholder="If one day this system speaks for you, which boundaries and rules must it follow?"></textarea>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btnBlue" id="btnSaveUserIdentity">Save</button>
          <button class="btn btnSubtle" id="btnEditIdentity">Edit mode</button>
          <button class="btn btnRed" id="btnDeleteUserIdentity">Delete identity</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const KEY_CFG   = "aurax_cfg_v12";
      const KEY_INT   = "aurax_intel_v11";
      const KEY_BM    = "aurax_bm_v11";
      const KEY_HIST  = "aurax_hist_v11";
      const KEY_USER  = "aurax_user_v11";
      const KEY_LOGIC = "aurax_logic_v12";
      const OFFLINE_MODEL_ID = "Llama-3-8B-Instruct-q4f32_1-MLC";

      const els = {
        console: document.getElementById("console"),
        btnOptions: document.getElementById("btnOptions"),
        optionsMenu: document.getElementById("optionsMenu"),
        miVoice: document.getElementById("miVoice"),
        miIntel: document.getElementById("miIntel"),
        miLearn: document.getElementById("miLearn"),
        miSeed: document.getElementById("miSeed"),
        miFaith: document.getElementById("miFaith"),
        miIdentity: document.getElementById("miIdentity"),
        miLLM: document.getElementById("miLLM"),
        miBMRecall: document.getElementById("miBMRecall"),
        miHistory: document.getElementById("miHistory"),
        voicePill: document.getElementById("voicePill"),
        learnPill: document.getElementById("learnPill"),
        faithLabel: document.getElementById("faithLabel"),
        cE0: document.getElementById("cE0"),
        cTM: document.getElementById("cTM"),
        cBM: document.getElementById("cBM"),
        cCont: document.getElementById("cCont"),
        userInput: document.getElementById("userInput"),
        sendBtn: document.getElementById("sendBtn"),
        faithBubble: document.getElementById("faithBubble"),
        faithBubbleTitle: document.getElementById("faithBubbleTitle"),
        faithBubbleMeta: document.getElementById("faithBubbleMeta"),
        faithBubbleClose: document.getElementById("faithBubbleClose"),
        modalFaith: document.getElementById("modalFaith"),
        faithChips: document.getElementById("faithChips"),
        modalFaithArticle: document.getElementById("modalFaithArticle"),
        faithArticleMeta: document.getElementById("faithArticleMeta"),
        faithArticleTitle: document.getElementById("faithArticleTitle"),
        faithArticleText: document.getElementById("faithArticleText"),
        btnCopyFaithArticle: document.getElementById("btnCopyFaithArticle"),
        btnAddFaithToBM: document.getElementById("btnAddFaithToBM"),
        btnSkipFaithBM: document.getElementById("btnSkipFaithBM"),
        modalIntel: document.getElementById("modalIntel"),
        intelSearch: document.getElementById("intelSearch"),
        intelList: document.getElementById("intelList"),
        intelEditor: document.getElementById("intelEditor"),
        intelEditQ: document.getElementById("intelEditQ"),
        intelEditA: document.getElementById("intelEditA"),
        btnIntelSave: document.getElementById("btnIntelSave"),
        btnIntelCancel: document.getElementById("btnIntelCancel"),
        modalSeed: document.getElementById("modalSeed"),
        seedBox: document.getElementById("seedBox"),
        seedHint: document.getElementById("seedHint"),
        btnParseSeed: document.getElementById("btnParseSeed"),
        btnSaveSeed: document.getElementById("btnSaveSeed"),
        btnDiscardSeed: document.getElementById("btnDiscardSeed"),
        logicBox: document.getElementById("logicBox"),
        logicHint: document.getElementById("logicHint"),
        btnValidateLogic: document.getElementById("btnValidateLogic"),
        btnSaveLogic: document.getElementById("btnSaveLogic"),
        btnCopyLogic: document.getElementById("btnCopyLogic"),
        btnDeleteLogic: document.getElementById("btnDeleteLogic"),
        modalLLM: document.getElementById("modalLLM"),
        offlineStatus: document.getElementById("offlineStatus"),
        apiEndpoint: document.getElementById("apiEndpoint"),
        apiModel: document.getElementById("apiModel"),
        apiKey: document.getElementById("apiKey"),
        btnSaveLLM: document.getElementById("btnSaveLLM"),
        modalBM: document.getElementById("modalBM"),
        bmSelectList: document.getElementById("bmSelectList"),
        bmViewer: document.getElementById("bmViewer"),
        bmFilterDate: document.getElementById("bmFilterDate"),
        btnFilterBM: document.getElementById("btnFilterBM"),
        btnClearBMFilter: document.getElementById("btnClearBMFilter"),
        bmLockIcon: document.getElementById("bmLockIcon"),
        bmTitle: document.getElementById("bmTitle"),
        bmMeta: document.getElementById("bmMeta"),
        bmTextArea: document.getElementById("bmTextArea"),
        btnLiveBM: document.getElementById("btnLiveBM"),
        btnCopyPrompt: document.getElementById("btnCopyPrompt"),
        btnAutoGen: document.getElementById("btnAutoGen"),
        btnDeletePrompt: document.getElementById("btnDeletePrompt"),
        modalHistory: document.getElementById("modalHistory"),
        historyBox: document.getElementById("historyBox"),
        btnDeleteRecent: document.getElementById("btnDeleteRecent"),
        btnDeleteAllHist: document.getElementById("btnDeleteAllHist"),
        btnCopyHistory: document.getElementById("btnCopyHistory"),
        modalIdentity: document.getElementById("modalIdentity"),
        btnSaveUserIdentity: document.getElementById("btnSaveUserIdentity"),
        btnEditIdentity: document.getElementById("btnEditIdentity"),
        btnDeleteUserIdentity: document.getElementById("btnDeleteUserIdentity"),
        uName: document.getElementById("uName"),
        uNick: document.getElementById("uNick"),
        uOrigin: document.getElementById("uOrigin"),
        uPlace: document.getElementById("uPlace"),
        uProfession: document.getElementById("uProfession"),
        uEmotionalStyle: document.getElementById("uEmotionalStyle"),
        uKeyPeople: document.getElementById("uKeyPeople"),
        uLegacyRules: document.getElementById("uLegacyRules")
      };

      const FAITH_OPTIONS = [
        { id: "none",        label: "None" },
        { id: "islam",       label: "Islam â˜ªï¸" },
        { id: "christianity",label: "Christianity âœï¸" },
        { id: "hinduism",    label: "Hinduism à¥" },
        { id: "buddhism",    label: "Buddhism â˜¸ï¸" },
        { id: "sikhism",     label: "Sikhism ðŸª¯" },
        { id: "judaism",     label: "Judaism âœ¡ï¸" },
        { id: "atheism",     label: "Atheism / Humanism" },
        { id: "mixed",       label: "Other / Mixed" },
        { id: "indigenous",  label: "Indigenous / Traditional" },
        { id: "eastern",     label: "Eastern / Chinese" }
      ];

      const FAITH_LIBRARY = {
        islam: [{
          id: "islam_generic",
          title: "Meaning of hardship and patience",
          short: "Trust, sabr and good opinion of Allah during hard stories.",
          content:
            "In Islamic reflection, hardship is often seen as a temporary test that polishes the heart. " +
            "Believers are invited toward sabr (patience), shukr (gratitude where possible), and husn-uz-zann " +
            "(a good opinion of Allah). You can ask: what quality is being trained in me here, and which door " +
            "of mercy may open later from this chapter of my life?"
        }]
      };

      let state = {
        voiceOn: false,
        learningOn: true,
        faithSelection: [],
        intelligence: [],
        bmPrompts: [],
        history: [],
        userIdentity: null,
        apiConfig: { endpoint: "", model: "", key: "" },
        offlineEngine: null,
        offlineLoading: false,
        offlineReady: false,
        lastAnswerSource: null,
        metrics: { TM:0, BM:0, C:0.85, E0:0 },
        parsedSeed: [],
        editingIntelId: null,
        lastStoryInput: null,
        lastStoryBMId: null,
        faithBubbleTimer: null,
        currentFaithArticle: null,
        logicPacks: [],
        logicActiveIndex: null,
        abuseCount: 0,
        cooldownUntil: 0,
        mode: "adult",
        logicFaithSoftener: true
      };

      function safeLoadJSON(key, fallback){
        try{
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : fallback;
        }catch{ return fallback; }
      }

      function logLine(text){
        const div = document.createElement("div");
        div.className = "line";
        div.textContent = text;
        els.console.appendChild(div);
        els.console.scrollTop = els.console.scrollHeight;
      }

      function scoreTM(t){
        const len = Math.min((t||"").length,600);
        return Number(Math.tanh(len/200).toFixed(2));
      }

      function recomputeBMMetric(){
        const count = state.bmPrompts.length || 0;
        state.metrics.BM = Number(Math.tanh(count/10).toFixed(2));
      }

      function recomputeE0(intelBoost, llmBoost){
        const TM = state.metrics.TM;
        const BM = state.metrics.BM;
        const R = TM * BM;
        const I_tm = 0.3 * TM;
        const D = 0.1;
        const lambdaFaith = state.faithSelection.length ? 0.15 : 0;
        const lambdaSys   = 0.05;
        const lambdaTrc   = 0.05;
        const raw = R + I_tm + intelBoost + llmBoost - D + lambdaFaith + lambdaSys + lambdaTrc;
        state.metrics.E0 = Number(Math.tanh(raw).toFixed(3));
      }

      function updateCapsule(){
        els.cTM.textContent = state.metrics.TM.toFixed(2);
        els.cBM.textContent = state.metrics.BM.toFixed(2);
        els.cCont.textContent = state.metrics.C.toFixed(3);
        els.cE0.textContent = state.metrics.E0.toFixed(3);
      }

      function saveCfg(){
        const cfg = {
          voiceOn: state.voiceOn,
          learningOn: state.learningOn,
          faithSelection: state.faithSelection,
          apiConfig: state.apiConfig,
          offlineReady: state.offlineReady
        };
        localStorage.setItem(KEY_CFG, JSON.stringify(cfg));
      }

      function loadCfg(){
        const cfg = safeLoadJSON(KEY_CFG,null);
        if(!cfg) return;
        state.voiceOn = !!cfg.voiceOn;
        state.learningOn = cfg.learningOn!==false;
        state.faithSelection = cfg.faithSelection||[];
        state.apiConfig = cfg.apiConfig || state.apiConfig;
        state.offlineReady = !!cfg.offlineReady;
      }

      function saveIntelligence(){
        localStorage.setItem(KEY_INT, JSON.stringify(state.intelligence||[]));
      }

      function loadIntelligence(){
        state.intelligence = safeLoadJSON(KEY_INT,[]);
      }

      function saveBM(){
        localStorage.setItem(KEY_BM, JSON.stringify(state.bmPrompts||[]));
      }

      function loadBM(){
        state.bmPrompts = safeLoadJSON(KEY_BM,[]);
      }

      function saveHistory(){
        localStorage.setItem(KEY_HIST, JSON.stringify(state.history||[]));
      }

      function loadHistory(){
        state.history = safeLoadJSON(KEY_HIST,[]);
      }

      function saveUserIdentity(){
        localStorage.setItem(KEY_USER, JSON.stringify(state.userIdentity||null));
      }

      function loadUserIdentity(){
        state.userIdentity = safeLoadJSON(KEY_USER,null);
      }

      function persistLogicState(){
        const payload = {
          packs: state.logicPacks||[],
          activeIndex: state.logicActiveIndex,
          logicFaithSoftener: state.logicFaithSoftener,
          mode: state.mode
        };
        localStorage.setItem(KEY_LOGIC, JSON.stringify(payload));
      }

      function loadLogicState(){
        const data = safeLoadJSON(KEY_LOGIC,null);
        if(!data) return;
        state.logicPacks = data.packs||[];
        state.logicActiveIndex = data.activeIndex;
        state.logicFaithSoftener = data.logicFaithSoftener!==false;
        state.mode = data.mode || "adult";
      }

      function copyText(text){
        navigator.clipboard.writeText(text).then(()=>{
          logLine("[clipboard] Copied.");
        }).catch(()=>{
          logLine("[clipboard] Failed to copy.");
        });
      }

      function showModal(id){
        const el = document.getElementById(id);
        if(!el) return;
        el.style.display="flex";
      }
      function hideModal(id){
        const el = document.getElementById(id);
        if(!el) return;
        el.style.display="none";
      }

      document.querySelectorAll(".closeX").forEach(btn=>{
        const id = btn.getAttribute("data-close");
        btn.addEventListener("click",()=>hideModal(id));
      });

      function renderFaithChips(){
        els.faithChips.innerHTML="";
        FAITH_OPTIONS.forEach(opt=>{
          const div=document.createElement("div");
          div.className="chip";
          if(state.faithSelection.includes(opt.id)) div.classList.add("active");
          div.textContent=opt.label;
          div.addEventListener("click",()=>{
            if(opt.id==="none"){
              state.faithSelection=[];
            }else{
              const idx=state.faithSelection.indexOf(opt.id);
              if(idx>=0) state.faithSelection.splice(idx,1);
              else state.faithSelection.push(opt.id);
              state.faithSelection=state.faithSelection.filter(x=>x!=="none");
            }
            if(!state.faithSelection.length) state.faithSelection=[];
            const label = state.faithSelection.length
              ? state.faithSelection.map(id=>FAITH_OPTIONS.find(o=>o.id===id)?.label||id).join(", ")
              : "none";
            els.faithLabel.textContent=label;
            saveCfg();
            renderFaithChips();
          });
          els.faithChips.appendChild(div);
        });
      }

      function addHistory(role,text){
        const item={role,text,ts:Date.now()};
        state.history.push(item);
        if(state.history.length>400) state.history=state.history.slice(-400);
        saveHistory();
        renderHistory();
      }

      function renderHistory(){
        els.historyBox.innerHTML="";
        const lines=state.history.slice().sort((a,b)=>a.ts-b.ts);
        if(!lines.length){
          els.historyBox.innerHTML=
            '<div style="margin-top:6px;font-size:12px;opacity:.7;">No history yet.</div>';
          return;
        }
        lines.forEach(h=>{
          const dt=new Date(h.ts).toLocaleString();
          const label=h.role==="user"?"user":(h.role==="aura"?"ai":"sys");
          const row=document.createElement("div");
          row.className="historyLine";
          row.textContent=`${dt} Â· ${label}: ${h.text}`;
          els.historyBox.appendChild(row);
        });
      }

      function renderChatFromHistory(){
        const scroll=document.getElementById("chatScroll");
        scroll.innerHTML="";
        state.history.forEach(h=>{
          const div=document.createElement("div");
          div.style.marginBottom="6px";
          div.style.fontSize="13px";
          div.style.opacity=.95;
          const who=h.role==="user"?"You":(h.role==="aura"?"AURA-X Î©":"System");
          div.textContent=`${who}: ${h.text}`;
          scroll.appendChild(div);
        });
        scroll.scrollTop=scroll.scrollHeight;
      }

      function renderIntelList(){
        els.intelList.innerHTML="";
        const q=(els.intelSearch.value||"").toLowerCase();
        const items=state.intelligence.filter(it=>{
          if(!q) return true;
          return it.q.toLowerCase().includes(q) || it.a.toLowerCase().includes(q);
        });
        if(!items.length){
          els.intelList.innerHTML=
            '<div style="margin-top:8px;font-size:12px;opacity:.6;">No intelligence saved yet.</div>';
          return;
        }
        items.forEach(it=>{
          const card=document.createElement("div");
          card.className="bmCard";
          const qEl=document.createElement("div");
          qEl.style.fontWeight="800";
          qEl.textContent="Q: "+it.q;
          const aEl=document.createElement("div");
          aEl.style.marginTop="4px";
          aEl.style.fontSize="13px";
          aEl.textContent="A: "+it.a;
          const meta=document.createElement("div");
          meta.style.fontSize="11px";
          meta.style.opacity=".7";
          meta.style.marginTop="4px";
          meta.textContent=it.meta||"";
          const row=document.createElement("div");
          row.style.display="flex";
          row.style.gap="8px";
          row.style.marginTop="8px";
          const btnE=document.createElement("button");
          btnE.className="btn btnBlue";
          btnE.textContent="Edit";
          btnE.addEventListener("click",()=>openIntelEditor(it));
          const btnD=document.createElement("button");
          btnD.className="btn btnRed";
          btnD.textContent="Delete";
          btnD.addEventListener("click",()=>deleteIntel(it.id));
          row.appendChild(btnE);row.appendChild(btnD);
          card.appendChild(qEl);card.appendChild(aEl);card.appendChild(meta);card.appendChild(row);
          els.intelList.appendChild(card);
        });
      }

      function openIntelEditor(it){
        state.editingIntelId=it.id;
        els.intelEditQ.value=it.q;
        els.intelEditA.value=it.a;
        els.intelEditor.style.display="block";
      }
      function closeIntelEditor(){
        state.editingIntelId=null;
        els.intelEditQ.value="";
        els.intelEditA.value="";
        els.intelEditor.style.display="none";
      }
      function deleteIntel(id){
        if(!confirm("Delete this intelligence pair?")) return;
        state.intelligence = state.intelligence.filter(x=>x.id!==id);
        saveIntelligence();
        renderIntelList();
      }

      function renderBMList(){
        els.bmSelectList.innerHTML = "";
        const list = state.bmPrompts.slice();
        if(!list.length){
          els.bmSelectList.innerHTML =
            '<div style="margin-top:8px;font-size:12px;opacity:.6;">No BM prompts yet.</div>';
          els.bmViewer.style.display = "none";
          return;
        }
        let filtered = list;
        const filterDate = els.bmFilterDate ? els.bmFilterDate.value : "";
        if(filterDate){
          filtered = list.filter(bm=>{
            const d = new Date(bm.ts);
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,"0");
            const da = String(d.getDate()).padStart(2,"0");
            const localStr = y+"-"+m+"-"+da;
            return localStr === filterDate;
          });
          if(!filtered.length){
            els.bmSelectList.innerHTML =
              '<div style="margin-top:8px;font-size:12px;opacity:.6;">No BM prompts for this date.</div>';
            els.bmViewer.style.display = "none";
            return;
          }
        }
        const now = Date.now();
        filtered.sort((a,b)=>b.ts-a.ts).forEach(bm=>{
          const card = document.createElement("div");
          card.className = "bmCard";
          card.style.cursor="pointer";
          const title = document.createElement("div");
          title.style.fontWeight="800";
          title.textContent = bm.title || "(untitled story)";
          const meta = document.createElement("div");
          meta.style.fontSize="11px";
          meta.style.opacity=".7";
          meta.style.marginTop="2px";
          let txt = new Date(bm.ts).toLocaleString() + (bm.locked?" Â· locked":" Â· editable");
          if(bm.live && bm.liveUntil){
            if(bm.liveUntil>now) txt += " Â· live";
            else txt += " Â· live expired";
          }
          meta.textContent = txt;
          card.appendChild(title);
          card.appendChild(meta);
          card.addEventListener("click",()=>openBM(bm.id));
          els.bmSelectList.appendChild(card);
        });
      }

      let currentBMId = null;
      function openBM(id){
        const bm = state.bmPrompts.find(x=>x.id===id);
        if(!bm) return;
        currentBMId=id;
        els.bmViewer.style.display="block";
        els.bmTitle.textContent = bm.title || "(untitled story)";
        const now = Date.now();
        let meta = new Date(bm.ts).toLocaleString() + (bm.locked?" Â· locked":" Â· editable");
        if(bm.live && bm.liveUntil){
          if(bm.liveUntil>now)
            meta += " Â· live until "+new Date(bm.liveUntil).toLocaleTimeString();
          else
            meta += " Â· live expired";
        }
        els.bmMeta.textContent=meta;
        els.bmLockIcon.textContent = bm.locked?"ðŸ”’":"ðŸ”“";
        els.bmTextArea.value = bm.text || "";
        els.bmTextArea.readOnly = bm.locked;
        els.btnUnlockBM.style.display = bm.locked?"inline-flex":"none";
        els.btnLiveBM.textContent = (bm.live && bm.liveUntil && bm.liveUntil>now)
          ? "Live 12h: on" : "Live 12h: off";
      }

      function ensureBMForLastStory(){
        if(!state.lastStoryInput) return null;
        if(state.lastStoryBMId) return state.lastStoryBMId;
        const id = "bm_"+Date.now();
        const obj = {
          id,
          title:"Story @ "+new Date().toLocaleString(),
          summary: state.lastStoryInput.slice(0,180),
          text: state.lastStoryInput,
          locked:true,
          ts:Date.now(),
          live:false,
          liveUntil:null
        };
        state.bmPrompts.push(obj);
        state.lastStoryBMId = id;
        saveBM();
        renderBMList();
        recomputeBMMetric();
        updateCapsule();
        return id;
      }

      function getActiveLiveBM(){
        const now=Date.now();
        const active=state.bmPrompts.filter(bm=>bm.live && bm.liveUntil && bm.liveUntil>now);
        if(!active.length) return null;
        active.sort((a,b)=>b.ts-a.ts);
        return active[0];
      }

      function maybeUpdateLiveBM(userText,answer){
        const bm=getActiveLiveBM();
        if(!bm) return;
        const trimmed=(userText||"").trim();
        if(!trimmed || trimmed.length<40) return;
        const stamp=new Date().toLocaleString();
        bm.text = (bm.text||"")+
          "\n\n[Update @ "+stamp+"]\nYou: "+userText+"\nAURA-X Î©: "+answer;
        bm.summary = bm.text.slice(0,180);
        bm.ts=Date.now();
        saveBM();
        renderBMList();
        if(currentBMId===bm.id) openBM(bm.id);
      }

      function parseSeedBlock(){
        const raw = els.seedBox.value||"";
        if(!raw.trim()){ els.seedHint.textContent="Nothing to parse."; return; }
        const items=[];
        const lines=raw.split("\n");
        let curQ="",curA="";
        for(const line of lines){
          if(line.trim().startsWith("\\item")){
            if(curQ || curA) items.push({q:curQ.trim(),a:curA.trim()});
            const q=line.replace("\\item","").trim();
            curQ=q;curA="";
          }else if(line.includes("\\textbf{A:")){
            const idx=line.indexOf("\\textbf{A:");
            const after=line.slice(idx).replace("\\textbf{A:","").replace("}","").trim();
            curA+=(after?" "+after:"");
          }else{
            curA+=" "+line;
          }
        }
        if(curQ || curA) items.push({q:curQ.trim(),a:curA.trim()});
        state.parsedSeed = items.filter(it=>it.q && it.a);
        els.seedHint.textContent = "Parsed "+state.parsedSeed.length+" Q/A pairs.";
      }

      function saveParsedSeed(){
        const items = state.parsedSeed||[];
        if(!items.length){ els.seedHint.textContent="No parsed pairs to save."; return; }
        items.forEach(it=>{
          state.intelligence.push({
            id:"intel_"+Date.now()+"_"+Math.random().toString(36).slice(2,6),
            q:it.q,
            a:it.a,
            meta:"Imported from LaTeX block"
          });
        });
        saveIntelligence();
        renderIntelList();
        els.seedHint.textContent="Saved "+items.length+" pairs into intelligence.";
      }

      function discardSeed(){
        state.parsedSeed=[];
        els.seedBox.value="";
        els.seedHint.textContent="Cleared.";
      }

      function refreshLogicUI(){
        const list=state.logicPacks||[];
        if(!list.length){
          els.logicHint.textContent="No logic pack loaded.";
          return;
        }
        const idx = state.logicActiveIndex==null ? (list.length-1) : state.logicActiveIndex;
        const pack=list[idx];
        els.logicHint.textContent="Active pack "+pack.serial+" ("+new Date(pack.ts).toLocaleString()+")";
      }

      function applyUIFromLogic(){
        const list=state.logicPacks||[];
        if(!list.length) return;
        const idx = state.logicActiveIndex==null ? (list.length-1) : state.logicActiveIndex;
        const pack=list[idx];
        const rules=pack.rules||{};
        if(rules.ui && rules.ui.theme==="golden"){
          document.body.style.setProperty("background-color","#020617","");
        }
      }

      function setIdentityEditable(on){
        const ro = !on;
        [els.uName,els.uNick,els.uOrigin,els.uPlace,els.uProfession,els.uEmotionalStyle,
         els.uKeyPeople,els.uLegacyRules].forEach(el=>{
          el.readOnly=ro;
        });
      }

      function readIdentityForm(){
        state.userIdentity = {
          name: els.uName.value||"",
          nick: els.uNick.value||"",
          origin: els.uOrigin.value||"",
          place: els.uPlace.value||"",
          profession: els.uProfession.value||"",
          style: els.uEmotionalStyle.value||"",
          people: els.uKeyPeople.value||"",
          rules: els.uLegacyRules.value||""
        };
        saveUserIdentity();
      }

      function loadIdentityForm(){
        const u = state.userIdentity;
        if(!u){
          els.uName.value="";
          els.uNick.value="";
          els.uOrigin.value="";
          els.uPlace.value="";
          els.uProfession.value="";
          els.uEmotionalStyle.value="";
          els.uKeyPeople.value="";
          els.uLegacyRules.value="";
          return;
        }
        els.uName.value=u.name||"";
        els.uNick.value=u.nick||"";
        els.uOrigin.value=u.origin||"";
        els.uPlace.value=u.place||"";
        els.uProfession.value=u.profession||"";
        els.uEmotionalStyle.value=u.style||"";
        els.uKeyPeople.value=u.people||"";
        els.uLegacyRules.value=u.rules||"";
      }

      function pushSystemGreeting(){
        if(state.history.length) return;
        const txt="Welcome. I am AURA-X Î© running inside your browser. For this prototype, TM means only your inputs (text now, voice/video/documents in the future). Inside the engine I keep a long-term emotional trajectory using TM, BM, Intelligence and optionally a helper LLM. You can just talk naturally. If I ever say â€œI donâ€™t know yetâ€, you can teach me the answer and I will remember it next time.";
        addHistory("aura",txt);
        renderChatFromHistory();
        logLine("[boot] Greeting added to history.");
      }

      function checkAbuse(text){
        const lc=text.toLowerCase();
        const words=["fuck","stfu","idiot","bastard"];
        if(words.some(w=>lc.includes(w))){
          state.abuseCount++;
          const pack=state.logicPacks[state.logicActiveIndex ?? (state.logicPacks.length-1)] || {};
          const rules=pack.rules||{};
          const cd=rules.cooldown || {hits:3,seconds:10};
          if(state.abuseCount>=cd.hits){
            state.cooldownUntil=Date.now()+cd.seconds*1000;
          }
          return true;
        }
        return false;
      }

      function handleUserMessage(){
        const now=Date.now();
        if(state.cooldownUntil && now<state.cooldownUntil){
          const secs=Math.ceil((state.cooldownUntil-now)/1000);
          logLine("[cooldown] Too much abuse. Wait "+secs+"s.");
          return;
        }

        const text=(els.userInput.value||"").trim();
        if(!text) return;
        els.userInput.value="";
        state.metrics.TM = scoreTM(text);
        recomputeBMMetric();
        recomputeE0(0,0);
        updateCapsule();

        const abusive = checkAbuse(text);
        addHistory("user",text);
        renderChatFromHistory();

        if(abusive){
          const reply="Please keep your language respectful. I am here to help, not to be abused. Tell me what you need in a calm way.";
          addHistory("aura",reply);
          renderChatFromHistory();
          logLine("[abuse] Warning reply used.");
          return;
        }

        let answer = null;
        let intelBoost = 0;
        let llmBoost = 0;

        const lower=text.toLowerCase();

        const intel=state.intelligence.find(it=>lower.includes(it.q.toLowerCase()));
        if(intel){
          answer=intel.a;
          state.lastAnswerSource="intelligence";
          intelBoost=0.1;
        }

        if(!answer && lower.includes("who created you")){
          answer="I am AURA-X Î©, designed conceptually by Alim ul Haq as an emotional continuity prototype. Right now I live only inside this browser page.";
          state.lastAnswerSource="seed";
          intelBoost=0.12;
        }

        if(!answer && lower.includes("hello")){
          answer="Hello, I am AURA-X Î©. I am quite fine today, how about you?";
          state.lastAnswerSource="seed";
        }

        if(!answer && state.offlineReady){
          answer="(Offline LLM stub) I will later call the in-browser model here.";
          state.lastAnswerSource="offline-llm";
          llmBoost=0.15;
        }

        if(!answer && state.apiConfig.endpoint && state.apiConfig.key){
          answer="(Online helper stub) In a real build this would call the remote LLM using your API key.";
          state.lastAnswerSource="online-llm";
          llmBoost=0.15;
        }

        if(!answer){
          answer="I donâ€™t know yet. You can teach me the correct answer, and Iâ€™ll remember it in the Intelligence layer.";
          state.lastAnswerSource="unknown";
        }

        recomputeE0(intelBoost,llmBoost);
        updateCapsule();

        addHistory("aura",answer);
        renderChatFromHistory();
        maybeUpdateLiveBM(text,answer);
      }

      function initFromStorage(){
        loadCfg();
        loadIntelligence();
        loadBM();
        loadHistory();
        loadUserIdentity();
        loadLogicState();

        els.voicePill.textContent = state.voiceOn?"on":"off";
        els.learnPill.textContent = state.learningOn?"on":"off";
        els.faithLabel.textContent = state.faithSelection.length
          ? state.faithSelection.map(id=>FAITH_OPTIONS.find(o=>o.id===id)?.label||id).join(", ")
          : "none";

        renderFaithChips();
        renderIntelList();
        renderBMList();
        renderHistory();
        renderChatFromHistory();

        state.metrics.TM=0;
        recomputeBMMetric();
        recomputeE0(0,0);
        updateCapsule();

        refreshLogicUI();
        applyUIFromLogic();
        loadIdentityForm();
        setIdentityEditable(false);

        pushSystemGreeting();
      }

      els.btnOptions.addEventListener("click",()=>{
        const visible = els.optionsMenu.style.display==="block";
        els.optionsMenu.style.display = visible?"none":"block";
      });

      document.addEventListener("click",(e)=>{
        if(e.target===els.btnOptions || els.optionsMenu.contains(e.target)) return;
        els.optionsMenu.style.display="none";
      });

      els.miVoice.addEventListener("click",()=>{
        state.voiceOn=!state.voiceOn;
        els.voicePill.textContent=state.voiceOn?"on":"off";
        saveCfg();
      });

      els.miLearn.addEventListener("click",()=>{
        state.learningOn=!state.learningOn;
        els.learnPill.textContent=state.learningOn?"on":"off";
        saveCfg();
      });

      els.miFaith.addEventListener("click",()=>showModal("modalFaith"));
      els.miIntel.addEventListener("click",()=>showModal("modalIntel"));
      els.miSeed.addEventListener("click",()=>showModal("modalSeed"));
      els.miLLM.addEventListener("click",()=>showModal("modalLLM"));
      els.miBMRecall.addEventListener("click",()=>showModal("modalBM"));
      els.miHistory.addEventListener("click",()=>showModal("modalHistory"));
      els.miIdentity.addEventListener("click",()=>{
        loadIdentityForm();
        setIdentityEditable(false);
        showModal("modalIdentity");
      });

      els.sendBtn.addEventListener("click",handleUserMessage);
      els.userInput.addEventListener("keydown",(e)=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          handleUserMessage();
        }
      });

      els.intelSearch.addEventListener("input",renderIntelList);
      els.btnIntelSave.addEventListener("click",()=>{
        if(!state.editingIntelId) return;
        const q=(els.intelEditQ.value||"").trim();
        const a=(els.intelEditA.value||"").trim();
        if(!q||!a){ alert("Question and answer required."); return; }
        const idx=state.intelligence.findIndex(x=>x.id===state.editingIntelId);
        if(idx>=0){
          state.intelligence[idx].q=q;
          state.intelligence[idx].a=a;
          saveIntelligence();
          renderIntelList();
        }
        closeIntelEditor();
      });
      els.btnIntelCancel.addEventListener("click",closeIntelEditor);

      els.btnParseSeed.addEventListener("click",parseSeedBlock);
      els.btnSaveSeed.addEventListener("click",saveParsedSeed);
      els.btnDiscardSeed.addEventListener("click",discardSeed);

      if(els.btnValidateLogic){
        els.btnValidateLogic.addEventListener("click",()=>{
          const raw=els.logicBox.value||"";
          if(!raw.trim()){ els.logicHint.textContent="Nothing to validate."; return; }
          try{
            const obj=JSON.parse(raw);
            const keys=Object.keys(obj||{});
            els.logicHint.textContent="Valid JSON with "+keys.length+" root key(s).";
          }catch(e){
            els.logicHint.textContent="Invalid JSON: "+e.message;
          }
        });
      }

      if(els.btnSaveLogic){
        els.btnSaveLogic.addEventListener("click",()=>{
          const raw=els.logicBox.value||"";
          if(!raw.trim()){ els.logicHint.textContent="Nothing to save.";return; }
          let obj;
          try{ obj=JSON.parse(raw); }
          catch(e){ els.logicHint.textContent="Invalid JSON: "+e.message;return; }
          if(!confirm("Save this logic pack? It will control behaviour until you delete it.")) return;
          const serial="LP-"+new Date().toISOString().replace(/[-:.TZ]/g,"").slice(0,14);
          const pack={ serial, rules:obj, ts:Date.now() };
          state.logicPacks = state.logicPacks || [];
          state.logicPacks.push(pack);
          state.logicActiveIndex = state.logicPacks.length-1;
          persistLogicState();
          refreshLogicUI();
          applyUIFromLogic();
          // Clear box after successful save so it is ready for next pack
          els.logicBox.value="";
          els.logicHint.textContent="Logic pack saved as "+serial+".";
        });
      }

      if(els.btnCopyLogic){
        els.btnCopyLogic.addEventListener("click",()=>{
          const list=state.logicPacks||[];
          if(list.length){
            const idx = state.logicActiveIndex==null ? (list.length-1) : state.logicActiveIndex;
            const pack=list[idx];
            copyText(JSON.stringify(pack,null,2));
          }
        });
      }

      if(els.btnDeleteLogic){
        els.btnDeleteLogic.addEventListener("click",()=>{
          const list=state.logicPacks||[];
          if(!list.length){ els.logicHint.textContent="No pack to delete."; return; }
          if(!confirm("Delete active logic pack?")) return;
          if(!confirm("Are you sure? This cannot be undone.")) return;
          const idx = state.logicActiveIndex==null ? (list.length-1) : state.logicActiveIndex;
          list.splice(idx,1);
          state.logicPacks=list;
          state.logicActiveIndex = list.length? (list.length-1):null;
          persistLogicState();
          els.logicHint.textContent="Logic pack deleted.";
        });
      }

      if(els.btnUnlockBM){
        els.btnUnlockBM.addEventListener("click",()=>{
          if(!currentBMId) return;
          if(!confirm("Unlock this BM prompt for editing?")) return;
          const bm=state.bmPrompts.find(x=>x.id===currentBMId);
          if(!bm) return;
          bm.locked=false;saveBM();openBM(currentBMId);
        });
      }

      if(els.btnLiveBM){
        els.btnLiveBM.addEventListener("click",()=>{
          if(!currentBMId) return;
          const bm=state.bmPrompts.find(x=>x.id===currentBMId);
          if(!bm) return;
          const now=Date.now();
          if(!bm.live || !bm.liveUntil || bm.liveUntil<=now){
            bm.live=true;bm.liveUntil=now+12*60*60*1000;
          }else{
            bm.live=false;bm.liveUntil=null;
          }
          saveBM();openBM(currentBMId);
        });
      }

      els.btnCopyPrompt.addEventListener("click",()=>{
        const txt=els.bmTextArea.value||""; if(!txt) return; copyText(txt);
      });
      els.btnAutoGen.addEventListener("click",()=>{
        logLine("[BM] Auto generation can be wired later.");
      });
      els.btnDeletePrompt.addEventListener("click",()=>{
        if(!currentBMId) return;
        if(!confirm("Delete this BM prompt?")) return;
        if(!confirm("Are you sure? This cannot be undone.")) return;
        state.bmPrompts = state.bmPrompts.filter(x=>x.id!==currentBMId);
        saveBM();renderBMList();els.bmViewer.style.display="none";currentBMId=null;
        recomputeBMMetric();updateCapsule();
      });

      if(els.btnFilterBM){
        els.btnFilterBM.addEventListener("click",()=>{
          renderBMList();
        });
      }

      if(els.btnClearBMFilter){
        els.btnClearBMFilter.addEventListener("click",()=>{
          if(els.bmFilterDate) els.bmFilterDate.value="";
          renderBMList();
        });
      }

      els.btnDeleteRecent.addEventListener("click",()=>{
        if(!confirm("Delete history for last 48h?")) return;
        state.history=[];saveHistory();renderHistory();renderChatFromHistory();
      });

      els.btnDeleteAllHist.addEventListener("click",()=>{
        if(!confirm("Delete ALL history?")) return;
        if(!confirm("Are you sure? This cannot be undone.")) return;
        state.history=[];saveHistory();renderHistory();renderChatFromHistory();
      });

      els.btnCopyHistory.addEventListener("click",()=>{
        const lines=state.history.map(h=>{
          const dt=new Date(h.ts).toISOString();
          const label=h.role==="user"?"You":(h.role==="aura"?"AURA-X Î©":h.role);
          return `[${dt}] ${label}: ${h.text}`;
        }).join("\n");
        if(!lines) return; copyText(lines);
      });

      els.btnEditIdentity.addEventListener("click",()=>setIdentityEditable(true));
      els.btnSaveUserIdentity.addEventListener("click",()=>{
        readIdentityForm();setIdentityEditable(false);logLine("[identity] Saved on this device.");
      });
      els.btnDeleteUserIdentity.addEventListener("click",()=>{
        if(!confirm("Delete stored identity?")) return;
        if(!confirm("Are you sure? This cannot be undone.")) return;
        state.userIdentity=null;saveUserIdentity();
        loadIdentityForm();setIdentityEditable(false);
      });

      els.faithBubbleClose.addEventListener("click",()=>{
        els.faithBubble.style.display="none";
      });

      function maybeShowFaithBubble(articleId){
        const articles = FAITH_LIBRARY.islam||[];
        const art = articles.find(a=>a.id===articleId) || articles[0];
        if(!art) return;
        state.currentFaithArticle=art;
        els.faithBubbleTitle.textContent=art.title;
        els.faithBubbleMeta.textContent=art.short;
        document.getElementById("faithBubbleText").textContent=art.content;
        els.faithBubble.style.display="block";
        if(state.faithBubbleTimer) clearTimeout(state.faithBubbleTimer);
        state.faithBubbleTimer=setTimeout(()=>{
          els.faithBubble.style.display="none";
        }, 25000);
      }

      els.btnCopyFaithArticle.addEventListener("click",()=>{
        if(!state.currentFaithArticle) return;
        copyText(state.currentFaithArticle.content);
      });
      els.btnAddFaithToBM.addEventListener("click",()=>{
        if(!state.currentFaithArticle) return;
        state.lastStoryInput = state.currentFaithArticle.content;
        ensureBMForLastStory();
        renderBMList();
        maybeShowFaithBubble(null);
      });
      els.btnSkipFaithBM.addEventListener("click",()=>{
        els.modalFaithArticle.style.display="none";
      });

      initFromStorage();
    });
  </script>
</body>
</html>