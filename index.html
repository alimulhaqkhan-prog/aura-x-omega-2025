<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline emotional continuity engine (4.9 + Sense)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Future-ready offline LLM (web-llm) ‚Äì optional -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}

    :root{
      --bg:#020617;
      --card:#020617;
      --card-soft:#020617;
      --border-soft:rgba(15,23,42,.8);
      --accent:#0ea5e9;
      --accent-soft:rgba(56,189,248,.24);
      --accent-strong:#38bdf8;
      --pill:#0ea5e9;
      --pill-soft:#0369a1;
      --text-main:#e5f2ff;
      --text-soft:#9fb4d8;
      --console-bg:rgba(15,23,42,.92);
      --ethic-bg:rgba(15,23,42,.9);
      --input-bg:#020617;
      --danger:#f97373;
      --ok:#4ade80;
    }

    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
      background:radial-gradient(circle at 0 0,#0ea5e911,transparent 55%),
                 radial-gradient(circle at 100% 100%,#22d3ee11,transparent 55%),
                 #020617;
      color:var(--text-main);
      min-height:100vh;
      padding:12px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .app{
      width:100%;
      max-width:960px;
      border-radius:32px;
      padding:18px 16px 18px;
      background:radial-gradient(circle at top,#0f172a,#020617 55%),
                  radial-gradient(circle at bottom,#020617,#020617 60%);
      box-shadow:0 24px 80px rgba(15,23,42,.9);
      border:1px solid rgba(15,23,42,.9);
    }

    .top{
      text-align:center;
      margin-bottom:18px;
    }

    .brand{
      font-size:26px;
      letter-spacing:.18em;
      font-weight:800;
      color:#e0f2fe;
      text-transform:uppercase;
    }

    .sub{
      margin-top:4px;
      font-size:13px;
      color:var(--text-soft);
    }

    .ethic{
      position:relative;
      margin:14px auto 10px;
      max-width:760px;
      border-radius:20px;
      padding:10px 40px 10px 18px;
      background:var(--ethic-bg);
      border:1px solid rgba(148,163,184,.55);
      text-align:left;
    }

    .ethicMain{
      font-size:13px;
      color:#fbbf24;
      line-height:1.35;
    }

    .ethicMeta{
      margin-top:4px;
      font-size:11px;
      color:#bfdbfe;
      opacity:.9;
    }

    .faithCfgBtn{
      position:absolute;
      right:10px;
      top:10px;
      width:20px;
      height:20px;
      border-radius:999px;
      border:none;
      background:#0f172a;
      color:#e5e7eb;
      cursor:pointer;
      font-size:11px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      margin-top:8px;
      padding:8px 20px;
      border-radius:999px;
      background:linear-gradient(to right,#0ea5e9,#22c55e);
      color:#0b1220;
      font-size:14px;
      font-weight:600;
      letter-spacing:.12em;
    }

    .main{
      margin-top:4px;
    }

    .row{
      display:grid;
      grid-template-columns:280px minmax(0,1fr);
      gap:14px;
    }

    .leftCol,.rightCol{
      min-width:0;
    }

    .card{
      border-radius:22px;
      padding:12px;
      background:radial-gradient(circle at top left,#0b1120,#020617 65%);
      border:1px solid rgba(30,64,175,.65);
      box-shadow:0 18px 40px rgba(15,23,42,.9);
    }

    .optionsBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.95);
      color:#e5e7eb;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }

    .optionsBtn:hover{
      border-color:#38bdf8;
      box-shadow:0 0 0 1px rgba(56,189,248,.45);
    }

    .gear{
      width:18px;
      height:18px;
    }

    .console{
      margin-top:10px;
      border-radius:18px;
      background:var(--console-bg);
      border:1px solid rgba(15,23,42,.9);
      height:260px;
      padding:10px 10px 8px;
      overflow-y:auto;
      font-size:13px;
      line-height:1.35;
    }

    .line{
      margin-bottom:6px;
      white-space:pre-wrap;
      word-break:break-word;
    }

    .line.user{
      color:#e5f2ff;
    }

    .line.aura{
      color:#bfdbfe;
    }

    .line.system{
      color:#a5b4fc;
      font-size:12px;
      opacity:.9;
    }

    .metrics{
      margin-top:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:12px;
      color:#cbd5f5;
      padding:8px 10px;
      border-radius:16px;
      background:rgba(15,23,42,.92);
      border:1px solid rgba(30,64,175,.7);
    }

    .metricLabel{
      color:#93c5fd;
    }

    .inputRow{
      margin-top:8px;
      display:flex;
      gap:8px;
    }

    #mainInput{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      padding:9px 14px;
      font-size:14px;
      background:var(--input-bg);
      color:#e5f2ff;
      outline:none;
    }

    #mainInput::placeholder{
      color:#6b7280;
    }

    .sendBtn{
      border:none;
      border-radius:999px;
      padding:0 20px;
      background:linear-gradient(to right,#0ea5e9,#22c55e);
      color:#020617;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      min-width:80px;
    }

    .reactionBar{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      font-size:18px;
      opacity:.9;
    }

    .reactionBar span{
      cursor:pointer;
      filter:grayscale(.1);
      transition:transform .12s ease,filter .12s ease;
    }

    .reactionBar span:hover{
      transform:translateY(-1px) scale(1.1);
      filter:none;
    }

    /* Options menu */

    .optionsMenu{
      position:relative;
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
      transition:opacity .15s ease,transform .15s ease;
    }

    .menuItem{
      border-radius:16px;
      padding:6px 6px;
      border:1px solid rgba(30,64,175,.7);
      background:radial-gradient(circle at top,#0f172a,#020617 70%);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      min-height:52px;
    }

    .menuItem:hover{
      border-color:#38bdf8;
      box-shadow:0 0 0 1px rgba(56,189,248,.35);
    }

    .menuIcon{
      width:26px;
      height:26px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(30,64,175,.7);
    }

    .menuLeft{
      font-size:11px;
      line-height:1.2;
    }

    .menuTitle{
      font-weight:600;
      color:#e5f2ff;
    }

    .menuSub{
      color:#9ca3af;
    }

    .pillOn,.pillOff,.pillMid{
      border-radius:999px;
      padding:4px 7px;
      font-size:10px;
      border:none;
      cursor:pointer;
    }

    .pillOn{
      background:rgba(16,185,129,.15);
      color:#6ee7b7;
    }

    .pillOff{
      background:rgba(248,113,113,.12);
      color:#fecaca;
    }

    .pillMid{
      background:rgba(59,130,246,.15);
      color:#bfdbfe;
    }

    .statusDot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 0 3px rgba(34,197,94,.22);
    }

    /* Modals */

    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.7);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
      padding:12px;
    }

    .modal{
      width:100%;
      max-width:560px;
      border-radius:22px;
      background:#020617;
      border:1px solid rgba(30,64,175,.9);
      box-shadow:0 24px 80px rgba(15,23,42,.95);
      padding:14px 16px 16px;
    }

    .modalHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:10px;
      font-size:14px;
      color:#e5f2ff;
    }

    .modalHeader small{
      color:#9ca3af;
      font-weight:400;
    }

    .modalBody{
      font-size:13px;
      color:#d1d5db;
      max-height:60vh;
      overflow-y:auto;
    }

    .closeX{
      border-radius:999px;
      width:22px;
      height:22px;
      border:1px solid rgba(148,163,184,.7);
      background:#020617;
      color:#e5e7eb;
      cursor:pointer;
      font-size:13px;
    }

    .btn{
      border-radius:999px;
      padding:6px 14px;
      font-size:12px;
      border:1px solid transparent;
      cursor:pointer;
      white-space:nowrap;
    }

    .btnBlue{
      background:rgba(37,99,235,.18);
      border-color:rgba(59,130,246,.7);
      color:#bfdbfe;
    }

    .btnRed{
      background:rgba(248,113,113,.12);
      border-color:rgba(248,113,113,.5);
      color:#fecaca;
    }

    .btnGhost{
      background:transparent;
      border-color:rgba(148,163,184,.6);
      color:#e5e7eb;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      padding:2px 8px;
      font-size:11px;
      gap:4px;
      color:#cbd5f5;
    }

    /* Dream bubble + image preview already used in 4.9 */

    #dreamBubble{
      margin-top:10px;
      border-radius:18px;
      padding:10px 12px;
      background:radial-gradient(circle at top,#0b1120,#020617 70%);
      border:1px dashed rgba(59,130,246,.6);
      display:none;
    }

    .dreamTitle{
      font-weight:800;
      font-size:18px;
      color:#e0f2fe;
    }

    .dreamSub{
      max-width:420px;
      font-size:13px;
      color:#bae6fd;
      opacity:.9;
    }

    .dreamMeta{
      margin-top:4px;
      font-size:11px;
      color:#93c5fd;
      opacity:.85;
    }

    @keyframes dreamPulse{
      0%{transform:translateY(0) scale(1);}
      50%{transform:translateY(-6px) scale(1.03);}
      100%{transform:translateY(0) scale(1);}
    }

    #dreamBubble.dreamActive{animation:dreamPulse 3.5s ease-in-out infinite;}

    #imagePreviewArea{
      display:none;
      margin:6px 2px 2px;
      text-align:center;
      font-size:10px;
      opacity:.8;
    }

    #imgPrev{
      max-height:90px;
      border-radius:10px;
      border:2px solid var(--accent);
      margin-bottom:2px;
    }

    /* Toast */

    #toast{
      position:fixed;
      bottom:16px;
      right:16px;
      left:16px;
      max-width:320px;
      margin:0 auto;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(15,23,42,.96);
      border:1px solid rgba(59,130,246,.7);
      color:#e5e7eb;
      font-size:12px;
      display:none;
      z-index:50;
      text-align:center;
    }

    @media (max-width:760px){
      .row{grid-template-columns:1fr}
      .console{height:240px}
      .optionsMenu{top:0}
    }

    @media (max-width:420px){
      .brand{font-size:22px}
      .pill{font-size:14px}
      .ethic{font-size:13px}
      .console{height:260px}
      .optionsMenu{
        gap:6px;
        padding:0;
        grid-template-columns:repeat(3,minmax(0,1fr));
      }
      .menuItem{min-height:52px;padding:6px 4px;}
      .menuLeft{font-size:11px}
      .pillOn,.pillOff,.pillMid{font-size:9.5px;padding:4px 6px;}
      .reactionBar{font-size:16px;gap:8px;}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="brand">AURA-X Œ©</div>
      <div class="sub">
        Offline emotional continuity engine (prototype)<br>
        TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory.
      </div>

      <div class="ethic" id="ethicBox">
        <div class="ethicMain" id="ethicMain">
          Universal ethic: avoid actions that grow negative emotions in you or others.
          Move gently toward choices that increase shared positive feeling for everyone.
        </div>
        <div class="ethicMeta" id="ethicMeta"></div>
        <button id="faithCfgBtn" class="faithCfgBtn" title="Faith live bar settings">üîò</button>
      </div>

      <div class="pill">EMOTIONAL CONTINUITY ENGINE ‚Äî ACTIVE</div>
    </div>

    <div class="main">
      <div class="row">
        <!-- LEFT -->
        <div class="leftCol">
          <div class="card">
            <div class="optionsBtn" id="btnOptions">
              <svg class="gear" viewBox="0 0 24 24" fill="none">
                <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"
                      stroke="#7dd3fc" stroke-width="2"/>
                <path d="M19.4 15a8.2 8.2 0 0 0 .1-2l2-1.5-2-3.5-2.4 1a8.5 8.5 0 0 0-1.7-1l-.4-2.6h-4l-.4 2.6a8.5 8.5 0 0 0-1.7 1l-2.4-1-2 3.5 2 1.5a8.2 8.2 0 0 0 .1 2L2.7 16.5l2 3.5 2.4-1a8.5 8.5 0 0 0 1.7 1l.4 2.6h4l.4-2.6a8.5 8.5 0 0 0 1.7-1l2.4 1 2-3.5L19.4 15Z"
                      stroke="#7dd3fc" stroke-width="1.6" opacity=".9"/>
              </svg>
              <span>Options</span>
            </div>

            <div class="optionsMenu" id="optionsMenu">
              <!-- Voice -->
              <div class="menuItem" data-open="modalVoice">
                <div class="menuIcon">üéôÔ∏è</div>
                <div class="menuLeft">
                  <div class="menuTitle">Voice</div>
                  <div class="menuSub">Read answers aloud.</div>
                </div>
                <button class="pillOff" id="pillVoice">off</button>
              </div>

              <!-- Intelligence -->
              <div class="menuItem" data-open="modalIntel">
                <div class="menuIcon">üß†</div>
                <div class="menuLeft">
                  <div class="menuTitle">Intelligence</div>
                  <div class="menuSub">Stored Q ‚Üí A.</div>
                </div>
                <button class="pillMid">open</button>
              </div>

              <!-- Learning -->
              <div class="menuItem" data-open="modalLearn">
                <div class="menuIcon">üìö</div>
                <div class="menuLeft">
                  <div class="menuTitle">Learning</div>
                  <div class="menuSub">Self-learning rules.</div>
                </div>
                <button class="pillOn" id="pillLearn">on</button>
              </div>

              <!-- Seed -->
              <div class="menuItem" data-open="modalSeed">
                <div class="menuIcon">üå±</div>
                <div class="menuLeft">
                  <div class="menuTitle">Feed</div>
                  <div class="menuSub">Seed LaTeX blocks.</div>
                </div>
                <button class="pillMid">open</button>
              </div>

              <!-- Faith -->
              <div class="menuItem" data-open="modalFaith">
                <div class="menuIcon">üïäÔ∏è</div>
                <div class="menuLeft">
                  <div class="menuTitle">Faith</div>
                  <div class="menuSub">Ethic + lens.</div>
                </div>
                <button class="pillMid" id="pillFaith">none</button>
              </div>

              <!-- Identity -->
              <div class="menuItem" data-open="modalId">
                <div class="menuIcon">ü™™</div>
                <div class="menuLeft">
                  <div class="menuTitle">Identity</div>
                  <div class="menuSub">User profile.</div>
                </div>
                <button class="pillMid">open</button>
              </div>

              <!-- LLM -->
              <div class="menuItem" data-open="modalLLM">
                <div class="menuIcon">ü§ñ</div>
                <div class="menuLeft">
                  <div class="menuTitle">LLM</div>
                  <div class="menuSub">API & model.</div>
                </div>
                <button class="pillMid">open</button>
              </div>

              <!-- BM Recall -->
              <div class="menuItem" data-open="modalBM">
                <div class="menuIcon">üìò</div>
                <div class="menuLeft">
                  <div class="menuTitle">BM Recall</div>
                  <div class="menuSub">Deep memory.</div>
                </div>
                <button class="pillMid">open</button>
              </div>

              <!-- History -->
              <div class="menuItem" data-open="modalHist">
                <div class="menuIcon">üìú</div>
                <div class="menuLeft">
                  <div class="menuTitle">History</div>
                  <div class="menuSub">Episodes.</div>
                </div>
                <button class="pillMid">open</button>
              </div>

              <!-- NEW: Sense (Camera + Mic) -->
              <div class="menuItem" data-open="modalSense">
                <div class="menuIcon">üëÅÔ∏è</div>
                <div class="menuLeft">
                  <div class="menuTitle">Sense</div>
                  <div class="menuSub">Camera + Mic ‚Üí BM.</div>
                </div>
                <div class="statusDot" id="senseDot" title="Idle"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="rightCol">
          <div class="card">
            <div id="console" class="console"></div>

            <div id="dreamBubble">
              <div class="dreamTitle">Dream mode ready</div>
              <div class="dreamSub">
                When you leave AURA-X Œ© idle, it can ‚Äúdream‚Äù over your BM prompts and
                generate gentle reflections to keep emotional continuity soft and alive.
              </div>
              <div class="dreamMeta" id="dreamMeta"></div>
            </div>

            <div id="imagePreviewArea">
              <img id="imgPrev" alt="preview">
              <div>Attached vision will influence BM and answer (developer can plug a vision API here).</div>
            </div>

            <div class="metrics">
              <div><span class="metricLabel">E0:</span> <span id="mE0">0.000</span></div>
              <div><span class="metricLabel">TM:</span> <span id="mTM">0.00</span></div>
              <div><span class="metricLabel">BM:</span> <span id="mBM">0.00</span></div>
              <div><span class="metricLabel">C:</span> <span id="mC">0.850</span></div>
            </div>

            <div class="inputRow">
              <input id="mainInput" autocomplete="off"
                     placeholder="Talk to AURA-X Œ©‚Ä¶ (TM = your inputs)" />
              <button class="sendBtn" id="btnSend">Send</button>
            </div>

            <div class="reactionBar" id="reactionBar">
              <span data-r="pos">üòä</span>
              <span data-r="calm">üòå</span>
              <span data-r="neutral">üòê</span>
              <span data-r="sad">üò¢</span>
              <span data-r="angry">üò°</span>
              <span data-r="think">ü§î</span>
            </div>

            <div style="margin-top:6px;font-size:11px;color:#64748b;text-align:center">
              E‚ÇÄ = tanh( R(TM,BM) + I(TM) + I_intel + I_LLM ‚àí D + Œª_faith + Œª_sys + Œª_trc )
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== Modals (minimal versions, same structure as 4.9) ====== -->

  <!-- Voice -->
  <div class="modalOverlay" id="modalVoice">
    <div class="modal">
      <div class="modalHeader">
        <div>üéôÔ∏è Voice<br><small>Read Aura‚Äôs replies using browser speech synthesis.</small></div>
        <button class="closeX" data-close="modalVoice">√ó</button>
      </div>
      <div class="modalBody">
        <p style="margin-bottom:8px">
          When <span class="badge"><span style="width:6px;height:6px;border-radius:999px;background:#22c55e"></span> on</span>,
          AURA-X Œ© will speak answers aloud. This uses your device TTS; nothing is sent to a server.
        </p>
        <button class="btn btnBlue" id="toggleVoiceBtn">Toggle voice (now: <span id="voiceStatusLabel">off</span>)</button>
      </div>
    </div>
  </div>

  <!-- Learning -->
  <div class="modalOverlay" id="modalLearn">
    <div class="modal">
      <div class="modalHeader">
        <div>üìö Learning<br><small>Correct answers become new Intelligence.</small></div>
        <button class="closeX" data-close="modalLearn">√ó</button>
      </div>
      <div class="modalBody">
        <p>
          If an answer is wrong, type <code>*incorrect</code>. AURA-X Œ© will ask for the correct
          answer and store it as a new Q ‚Üí A pair for future continuity.
        </p>
        <p style="margin-top:8px;font-size:12px;opacity:.8">
          You can disable this self-learning if you want a ‚Äúread-only‚Äù emotional continuity engine.
        </p>
        <button class="btn btnBlue" id="toggleLearnBtn">Toggle learning (now: <span id="learnStatusLabel">on</span>)</button>
      </div>
    </div>
  </div>

  <!-- Intelligence -->
  <div class="modalOverlay" id="modalIntel">
    <div class="modal">
      <div class="modalHeader">
        <div>üß† Intelligence<br><small>Stored Q ‚Üí A pairs.</small></div>
        <button class="closeX" data-close="modalIntel">√ó</button>
      </div>
      <div class="modalBody">
        <input id="intelSearch"
          style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.4);padding:8px 10px;font-size:13px;outline:none"
          placeholder="Search intelligence..." />
        <div id="intelList" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <!-- Seed / Logic -->
  <div class="modalOverlay" id="modalSeed">
    <div class="modal">
      <div class="modalHeader">
        <div>üå± Feed the seed<br><small>Add LaTeX Q ‚Üí A blocks and optional logic metadata.</small></div>
        <button class="closeX" data-close="modalSeed">√ó</button>
      </div>
      <div class="modalBody">
        <div style="opacity:.75;font-size:13px;line-height:1.35;margin-bottom:10px">
          Paste a LaTeX block with <code>\item</code> questions and <code>\textbf{A:}</code> answers.
          Optionally prefix answers with <code>[polarity=positive; code=E031; intensity=0.8]</code>.
        </div>
        <textarea id="seedBox"
          style="width:100%;min-height:150px;resize:vertical;border-radius:14px;border:2px solid rgba(59,130,246,.25);padding:10px;font-size:13px;outline:none;background:#020617;color:#e5e7eb"
          placeholder="Paste LaTeX conversation / logic block here..."></textarea>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-top:10px">
          <div style="font-size:12px;opacity:.7" id="seedHint">Waiting for block‚Ä¶</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn btnBlue" id="btnParseSeed">Parse block</button>
            <button class="btn btnBlue" id="btnSaveSeed">Save to seed</button>
            <button class="btn btnRed" id="btnDiscardSeed">Discard</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Faith (simplified ‚Äì lens only, article box like 4.9) -->
  <div class="modalOverlay" id="modalFaith">
    <div class="modal">
      <div class="modalHeader">
        <div>üïäÔ∏è Faith lens<br><small>Select lens + language; ethic text stays universal.</small></div>
        <button class="closeX" data-close="modalFaith">√ó</button>
      </div>
      <div class="modalBody">
        <div style="margin-bottom:8px;font-size:13px;opacity:.9">
          Choose a faith lens. Engine stays respectful and will not attack other paths.
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px" id="faithChips"></div>
        <textarea id="faithArticleBox"
          style="width:100%;min-height:120px;border-radius:14px;border:1px solid rgba(15,23,42,.55);padding:10px;font-size:13px;line-height:1.4;background:#020617;color:#e5e7eb;"></textarea>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn btnBlue" id="btnCopyFaithArticle">Copy</button>
          <button class="btn btnRed" id="btnSkipFaithBM">Skip</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Identity -->
  <div class="modalOverlay" id="modalId">
    <div class="modal">
      <div class="modalHeader">
        <div>ü™™ Identity<br><small>Deep profiling for continuity (local only).</small></div>
        <button class="closeX" data-close="modalId">√ó</button>
      </div>
      <div class="modalBody">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
          <input id="idName" placeholder="Name" style="padding:8px 10px;border-radius:12px;border:1px solid rgba(15,23,42,.5);background:#020617;color:#e5e7eb;">
          <input id="idRole" placeholder="Primary role (e.g. AI researcher)"
                 style="padding:8px 10px;border-radius:12px;border:1px solid rgba(15,23,42,.5);background:#020617;color:#e5e7eb;">
          <input id="idPlace" placeholder="Base city / context"
                 style="grid-column:1/3;padding:8px 10px;border-radius:12px;border:1px solid rgba(15,23,42,.5);background:#020617;color:#e5e7eb;">
        </div>
        <textarea id="idStory"
          style="width:100%;min-height:120px;border-radius:14px;border:1px solid rgba(15,23,42,.5);padding:10px;font-size:13px;background:#020617;color:#e5e7eb;"
          placeholder="Short emotional biography ‚Äì what matters to you, long-term projects, fears, hopes‚Ä¶"></textarea>
        <div style="margin-top:10px;display:flex;justify-content:flex-end;gap:8px">
          <button class="btn btnBlue" id="btnSaveId">Save identity</button>
          <button class="btn btnGhost" id="btnClearId">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- LLM config -->
  <div class="modalOverlay" id="modalLLM">
    <div class="modal">
      <div class="modalHeader">
        <div>ü§ñ Online LLM<br><small>Optional HTTP endpoint for TM ‚Üí answer.</small></div>
        <button class="closeX" data-close="modalLLM">√ó</button>
      </div>
      <div class="modalBody">
        <input id="apiEndpoint" placeholder="Endpoint URL"
               style="width:100%;margin-bottom:6px;padding:8px 10px;border-radius:12px;border:1px solid rgba(15,23,42,.5);background:#020617;color:#e5e7eb;">
        <input id="apiModel" placeholder="Model ID (optional)"
               style="width:100%;margin-bottom:6px;padding:8px 10px;border-radius:12px;border:1px solid rgba(15,23,42,.5);background:#020617;color:#e5e7eb;">
        <input id="apiKey" placeholder="API key (stored locally)"
               style="width:100%;margin-bottom:8px;padding:8px 10px;border-radius:12px;border:1px solid rgba(15,23,42,.5);background:#020617;color:#e5e7eb;">
        <button class="btn btnBlue" id="btnSaveAPI">Save settings</button>
      </div>
    </div>
  </div>

  <!-- BM recall -->
  <div class="modalOverlay" id="modalBM">
    <div class="modal">
      <div class="modalHeader">
        <div>üìò Bold Memory (BM)<br><small>Emotionally important prompts.</small></div>
        <button class="closeX" data-close="modalBM">√ó</button>
      </div>
      <div class="modalBody">
        <div id="bmList" style="font-size:13px;"></div>
      </div>
    </div>
  </div>

  <!-- History -->
  <div class="modalOverlay" id="modalHist">
    <div class="modal">
      <div class="modalHeader">
        <div>üìú Conversation history<br><small>Episodes with emotional tags.</small></div>
        <button class="closeX" data-close="modalHist">√ó</button>
      </div>
      <div class="modalBody">
        <div id="histList" style="font-size:13px;"></div>
      </div>
    </div>
  </div>

  <!-- NEW: Sense (Camera + Mic) -->
  <div class="modalOverlay" id="modalSense">
    <div class="modal">
      <div class="modalHeader">
        <div>üëÅÔ∏è + üéôÔ∏è Sense<br><small>Capture a scene and create a BM prompt stub.</small></div>
        <button class="closeX" data-close="modalSense">√ó</button>
      </div>
      <div class="modalBody">
        <p style="margin-bottom:8px">
          This panel can use <b>camera</b> and <b>microphone</b> (with your permission) to observe a
          short moment. The code prepares a descriptive BM prompt stub ‚Äì you can later connect
          a vision / speech API to analyse the actual content.
        </p>

        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px">
          <button class="btn btnBlue" id="btnSenseCamera">Capture camera snapshot</button>
          <button class="btn btnBlue" id="btnSenseMic">Record 10s audio</button>
        </div>

        <video id="senseVideo" autoplay playsinline muted
               style="width:100%;max-height:180px;border-radius:16px;border:1px solid rgba(30,64,175,.7);display:none;margin-bottom:8px"></video>

        <canvas id="senseCanvas" style="display:none"></canvas>

        <div id="senseStatus" style="font-size:12px;opacity:.85;margin-bottom:8px"></div>

        <textarea id="senseBMBox"
          style="width:100%;min-height:120px;border-radius:14px;border:1px solid rgba(15,23,42,.55);padding:10px;font-size:13px;background:#020617;color:#e5e7eb;"
          placeholder="Scene ‚Üí BM prompt stub will appear here‚Ä¶ You can edit before saving."></textarea>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
          <button class="btn btnBlue" id="btnSaveSenseBM">Save stub to BM</button>
        </div>

        <p style="margin-top:10px;font-size:11px;opacity:.7">
          ‚ö† Always respect privacy and local law. Do not record people without consent. Nothing in this demo
          is sent to any server unless you connect your own API in the LLM settings.
        </p>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    const els = {
      console: document.getElementById("console"),
      mainInput: document.getElementById("mainInput"),
      btnSend: document.getElementById("btnSend"),
      mE0: document.getElementById("mE0"),
      mTM: document.getElementById("mTM"),
      mBM: document.getElementById("mBM"),
      mC: document.getElementById("mC"),
      dreamBubble: document.getElementById("dreamBubble"),
      dreamMeta: document.getElementById("dreamMeta"),
      imagePreviewArea: document.getElementById("imagePreviewArea"),
      imgPrev: document.getElementById("imgPrev"),
      toast: document.getElementById("toast"),
      optionsMenu: document.getElementById("optionsMenu"),
      faithChips: document.getElementById("faithChips"),
      faithArticleBox: document.getElementById("faithArticleBox"),
      pillFaith: document.getElementById("pillFaith"),
      pillVoice: document.getElementById("pillVoice"),
      pillLearn: document.getElementById("pillLearn"),
      voiceStatusLabel: document.getElementById("voiceStatusLabel"),
      learnStatusLabel: document.getElementById("learnStatusLabel"),
      intelList: document.getElementById("intelList"),
      intelSearch: document.getElementById("intelSearch"),
      bmList: document.getElementById("bmList"),
      histList: document.getElementById("histList"),
      idName: document.getElementById("idName"),
      idRole: document.getElementById("idRole"),
      idPlace: document.getElementById("idPlace"),
      idStory: document.getElementById("idStory"),
      apiEndpoint: document.getElementById("apiEndpoint"),
      apiModel: document.getElementById("apiModel"),
      apiKey: document.getElementById("apiKey"),
      seedBox: document.getElementById("seedBox"),
      seedHint: document.getElementById("seedHint"),
      senseVideo: document.getElementById("senseVideo"),
      senseCanvas: document.getElementById("senseCanvas"),
      senseStatus: document.getElementById("senseStatus"),
      senseBMBox: document.getElementById("senseBMBox"),
      senseDot: document.getElementById("senseDot")
    };

    const defaultDeviceLang = (navigator.language || "").toLowerCase().startsWith("ur") ? "urdu" : "english";

    let state = {
      voiceOn: false,
      learningOn: true,
      faithSelection: [],
      intelligence: [],
      seedPairs: [],
      bmPrompts: [],
      history: [],
      userIdentity: null,
      apiConfig: { endpoint: "", model: "", key: "" },
      lastAnswerSource: null,
      lastUserQ: null,
      lastAuraA: null,
      correcting: false,
      metrics: { TM:0, BM:0, C:0.85, E0:0 },
      parsedSeed: [],
      editingIntelId: null,
      lastActivityTs: Date.now(),
      ethic: { topic:"general", lens:"none", lastUpdate:0, messageCount:0 },
      sense: { stream: null, mediaRecorder:null, chunks:[], hasCamera:false, hasAudio:false }
    };

    function safeLoadJSON(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      }catch{
        return fallback;
      }
    }

    function safeSaveJSON(key,value){
      try{ localStorage.setItem(key,JSON.stringify(value)); }catch{}
    }

    function initFromStorage(){
      state.intelligence = safeLoadJSON("ax_intel",[]);
      state.bmPrompts = safeLoadJSON("ax_bm",[]);
      state.history = safeLoadJSON("ax_hist",[]);
      state.userIdentity = safeLoadJSON("ax_id",null);
      state.apiConfig = safeLoadJSON("ax_api",{endpoint:"",model:"",key:""});
      if(state.userIdentity){
        els.idName.value = state.userIdentity.name || "";
        els.idRole.value = state.userIdentity.role || "";
        els.idPlace.value = state.userIdentity.place || "";
        els.idStory.value = state.userIdentity.story || "";
      }
      els.apiEndpoint.value = state.apiConfig.endpoint;
      els.apiModel.value = state.apiConfig.model;
      els.apiKey.value = state.apiConfig.key;
      recomputeBMMetric();
      refreshBMList();
      refreshIntelList();
      refreshHistoryView();
    }

    function logLine(roleOrText,maybeText){
      let role = "";
      let text;
      if(typeof maybeText === "undefined"){ text = roleOrText; }
      else { role = roleOrText || ""; text = maybeText; }
      const div = document.createElement("div");
      div.className = "line" + (role ? " " + role : "");
      div.textContent = text;
      els.console.appendChild(div);
      els.console.scrollTop = els.console.scrollHeight;
      if(role === "user" || role === "aura"){
        addHistory(role,text);
      }
    }

    function scoreTM(t){
      const len = Math.min((t||"").length,600);
      return Number(Math.tanh(len/200).toFixed(2));
    }

    function recomputeBMMetric(){
      const count = state.bmPrompts.length || 0;
      state.metrics.BM = Number(Math.tanh(count/10).toFixed(2));
      els.mBM.textContent = state.metrics.BM.toFixed(2);
    }

    function updateMetrics(tmIncrement){
      if(typeof tmIncrement === "number"){
        state.metrics.TM = Math.max(0,Math.min(1, tmIncrement));
      }
      const E0 = Math.tanh(state.metrics.TM + state.metrics.BM + state.metrics.C - 0.2);
      state.metrics.E0 = Number(E0.toFixed(3));
      els.mTM.textContent = state.metrics.TM.toFixed(2);
      els.mE0.textContent = state.metrics.E0.toFixed(3);
      els.mC.textContent = state.metrics.C.toFixed(3);
    }

    function showToast(msg){
      els.toast.textContent = msg;
      els.toast.style.display = "block";
      clearTimeout(state.toastTimer);
      state.toastTimer = setTimeout(()=>{ els.toast.style.display="none"; },2600);
    }

    function addHistory(role,text){
      const now = new Date();
      const ep = {
        ts: now.toISOString(),
        role,
        text
      };
      state.history.push(ep);
      if(state.history.length>400) state.history.shift();
      safeSaveJSON("ax_hist",state.history);
    }

    function refreshHistoryView(){
      const box = els.histList;
      box.innerHTML = "";
      if(!state.history.length){
        box.textContent = "No episodes yet.";
        return;
      }
      let lastDate = "";
      state.history.forEach(ep=>{
        const d = ep.ts.slice(0,10);
        if(d!==lastDate){
          const h = document.createElement("div");
          h.style.marginTop = "6px";
          h.style.fontSize = "11px";
          h.style.color = "#9ca3af";
          h.textContent = d;
          box.appendChild(h);
          lastDate = d;
        }
        const row = document.createElement("div");
        row.style.fontSize = "12px";
        row.style.marginLeft = "6px";
        row.textContent = (ep.role==="user"?"You: ":"Aura: ")+ep.text;
        box.appendChild(row);
      });
    }

    function refreshBMList(){
      const box = els.bmList;
      box.innerHTML = "";
      if(!state.bmPrompts.length){
        box.textContent = "No BM prompts yet.";
        return;
      }
      state.bmPrompts.forEach((bm,idx)=>{
        const wrap = document.createElement("div");
        wrap.style.borderBottom = "1px dashed rgba(148,163,184,.3)";
        wrap.style.padding = "6px 0";
        const t = document.createElement("div");
        t.style.fontSize = "12px";
        t.textContent = bm.text;
        const meta = document.createElement("div");
        meta.style.fontSize = "11px";
        meta.style.opacity = ".7";
        meta.textContent = "Saved: "+(bm.ts || "");
        const rowBtns = document.createElement("div");
        rowBtns.style.display="flex";
        rowBtns.style.gap="6px";
        rowBtns.style.marginTop="4px";
        const bCopy = document.createElement("button");
        bCopy.textContent="Copy";
        bCopy.className="btn btnBlue";
        bCopy.onclick=()=>{ navigator.clipboard?.writeText(bm.text); showToast("BM prompt copied.");};
        const bDel = document.createElement("button");
        bDel.textContent="Delete";
        bDel.className="btn btnRed";
        bDel.onclick=()=>{
          if(confirm("Delete this BM prompt?")){
            state.bmPrompts.splice(idx,1);
            safeSaveJSON("ax_bm",state.bmPrompts);
            recomputeBMMetric();
            refreshBMList();
          }
        };
        rowBtns.appendChild(bCopy);
        rowBtns.appendChild(bDel);
        wrap.appendChild(t);
        wrap.appendChild(meta);
        wrap.appendChild(rowBtns);
        box.appendChild(wrap);
      });
    }

    function refreshIntelList(){
      const box = els.intelList;
      box.innerHTML = "";
      const q = (els.intelSearch.value||"").toLowerCase();
      const data = state.intelligence.filter(it=>{
        if(!q) return true;
        return (it.q||"").toLowerCase().includes(q) || (it.a||"").toLowerCase().includes(q);
      });
      if(!data.length){
        box.textContent = "No intelligence entries yet.";
        return;
      }
      data.forEach((it,idx)=>{
        const wrap = document.createElement("div");
        wrap.style.borderBottom = "1px dashed rgba(148,163,184,.3)";
        wrap.style.padding = "6px 0";
        wrap.style.fontSize = "12px";
        const qDiv = document.createElement("div");
        qDiv.textContent = "Q: "+it.q;
        const aDiv = document.createElement("div");
        aDiv.textContent = "A: "+it.a;
        aDiv.style.color="#bfdbfe";
        const rowBtns = document.createElement("div");
        rowBtns.style.display="flex";
        rowBtns.style.gap="6px";
        rowBtns.style.marginTop="4px";
        const bUse = document.createElement("button");
        bUse.className="btn btnBlue";
        bUse.textContent="Use";
        bUse.onclick=()=>{ els.mainInput.value = it.q; els.mainInput.focus(); };
        const bDel = document.createElement("button");
        bDel.className="btn btnRed";
        bDel.textContent="Delete";
        bDel.onclick=()=>{
          if(confirm("Delete this intelligence item?")){
            const realIndex = state.intelligence.indexOf(it);
            if(realIndex>=0){
              state.intelligence.splice(realIndex,1);
              safeSaveJSON("ax_intel",state.intelligence);
              refreshIntelList();
            }
          }
        };
        rowBtns.appendChild(bUse);
        rowBtns.appendChild(bDel);
        wrap.appendChild(qDiv);
        wrap.appendChild(aDiv);
        wrap.appendChild(rowBtns);
        box.appendChild(wrap);
      });
    }

    function addIntelPair(q,a){
      if(!q || !a) return;
      state.intelligence.push({q,a,ts:new Date().toISOString()});
      if(state.intelligence.length>600) state.intelligence.shift();
      safeSaveJSON("ax_intel",state.intelligence);
      refreshIntelList();
    }

    // ==== core answer routing (very simplified compared to your big 4.9 logic) ====

    async function handleUserInput(){
      const text = (els.mainInput.value||"").trim();
      if(!text) return;
      els.mainInput.value = "";
      logLine("user","You: "+text);
      state.lastActivityTs = Date.now();
      state.metrics.TM = scoreTM(text);
      updateMetrics(state.metrics.TM);
      if(state.learningOn && text==="*incorrect"){
        if(!state.lastUserQ || !state.lastAuraA){
          logLine("system","No last Q ‚Üí A to correct.");
          return;
        }
        state.correcting = true;
        logLine("system","Please type the correct answer; it will be learned.");
        return;
      }
      if(state.correcting){
        addIntelPair(state.lastUserQ,text);
        state.correcting = false;
        logLine("system","Correct answer stored in Intelligence.");
        return;
      }

      state.lastUserQ = text;

      // 1) Check Intelligence
      const intelHit = state.intelligence.find(it => it.q.toLowerCase()===text.toLowerCase());
      if(intelHit){
        state.lastAnswerSource = "intel";
        answerFrom("intel",intelHit.a);
        return;
      }

      // 2) simple seed / BM echo
      const bmHit = state.bmPrompts[0];
      let baseReply = "I am listening and keeping continuity with your feelings. Tell me a bit more.";
      if(bmHit){
        baseReply = "I am holding your important BM context: \""+bmHit.text.slice(0,120)+"‚Ä¶\". "
                    +"How does your current thought connect to this?";
      }

      state.lastAnswerSource = "heuristic";

      // 3) if online API set, you can call it (placeholder)
      if(state.apiConfig.endpoint){
        try{
          const apiReply = await callOnlineLLM(text);
          if(apiReply){
            answerFrom("LLM",apiReply);
            return;
          }
        }catch(e){
          console.warn(e);
          showToast("Online API call failed; falling back to heuristic reply.");
        }
      }

      answerFrom("heuristic",baseReply);
    }

    function answerFrom(source, text){
      state.lastAuraA = text;
      logLine("aura","Aura: "+text);
      if(state.voiceOn){
        speak(text);
      }
      // simple continuity update
      state.metrics.C = Math.min(1, state.metrics.C + 0.01);
      updateMetrics(state.metrics.TM);
    }

    async function callOnlineLLM(userText){
      if(!state.apiConfig.endpoint) return null;
      const payload = {
        model: state.apiConfig.model || undefined,
        messages: [
          {role:"system",content:"You are Aura X Omega, an emotional continuity assistant. Keep answers short."},
          {role:"user",content:userText}
        ]
      };
      const res = await fetch(state.apiConfig.endpoint,{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization": state.apiConfig.key ? ("Bearer "+state.apiConfig.key) : undefined
        },
        body:JSON.stringify(payload)
      });
      if(!res.ok) throw new Error("API error "+res.status);
      const data = await res.json();
      const txt = data.choices?.[0]?.message?.content || "";
      return txt;
    }

    // ==== Voice (TTS) ====

    function speak(text){
      if(!("speechSynthesis" in window)) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = defaultDeviceLang==="urdu" ? "ur-PK" : "en-US";
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    // ==== Faith chips (very small stub, you can expand with full 4.9 logic later) ====

    const faithPresets = [
      {id:"none",label:"None"},
      {id:"islam",label:"Islam"},
      {id:"christianity",label:"Christianity"},
      {id:"judaism",label:"Judaism"},
      {id:"hinduism",label:"Hinduism"},
      {id:"buddhism",label:"Buddhism"},
      {id:"sikhism",label:"Sikhism"},
      {id:"bahai",label:"Bah√° º√≠"},
      {id:"secular",label:"Secular humanism"},
      {id:"other",label:"Other / custom"}
    ];

    function buildFaithChips(){
      els.faithChips.innerHTML = "";
      faithPresets.forEach(p=>{
        const b = document.createElement("button");
        b.className="btn btnGhost";
        b.textContent=p.label;
        b.onclick=()=>{
          state.faithSelection = [p.id];
          els.pillFaith.textContent = p.id==="none"?"none":p.label;
          showToast("Faith lens set to: "+p.label);
        };
        els.faithChips.appendChild(b);
      });
    }

    // ==== Identity save ====

    document.getElementById("btnSaveId").onclick = ()=>{
      state.userIdentity = {
        name: els.idName.value.trim(),
        role: els.idRole.value.trim(),
        place: els.idPlace.value.trim(),
        story: els.idStory.value.trim()
      };
      safeSaveJSON("ax_id",state.userIdentity);
      showToast("Identity saved locally.");
    };

    document.getElementById("btnClearId").onclick = ()=>{
      if(!confirm("Clear saved identity?")) return;
      state.userIdentity = null;
      safeSaveJSON("ax_id",null);
      els.idName.value = "";
      els.idRole.value = "";
      els.idPlace.value = "";
      els.idStory.value = "";
    };

    // ==== API save ====

    document.getElementById("btnSaveAPI").onclick = ()=>{
      state.apiConfig = {
        endpoint: els.apiEndpoint.value.trim(),
        model: els.apiModel.value.trim(),
        key: els.apiKey.value.trim()
      };
      safeSaveJSON("ax_api",state.apiConfig);
      showToast("API settings saved locally.");
    };

    // ==== Seed parsing (very simplified) ====

    function parseSeedText(text){
      const items = [];
      const parts = text.split("\\item").map(s=>s.trim()).filter(Boolean);
      parts.forEach(part=>{
        const idx = part.indexOf("\\textbf{A:");
        if(idx>0){
          const q = part.slice(0,idx).replace(/^[\-\*]/,"").trim();
          const rest = part.slice(idx+10);
          const end = rest.indexOf("}");
          const aRaw = end>=0 ? rest.slice(end+1) : rest;
          const a = aRaw.replace(/^[:\-]/,"").trim();
          if(q && a) items.push({q,a});
        }
      });
      return items;
    }

    document.getElementById("btnParseSeed").onclick = ()=>{
      const raw = els.seedBox.value;
      const parsed = parseSeedText(raw);
      if(!parsed.length){
        els.seedHint.textContent = "No Q ‚Üí A pairs detected.";
        return;
      }
      state.parsedSeed = parsed;
      els.seedHint.textContent = "Detected "+parsed.length+" pairs. Click Save to add to Intelligence.";
    };

    document.getElementById("btnSaveSeed").onclick = ()=>{
      if(!state.parsedSeed.length){
        showToast("Nothing parsed yet.");
        return;
      }
      state.parsedSeed.forEach(p=>addIntelPair(p.q,p.a));
      state.parsedSeed = [];
      els.seedBox.value = "";
      els.seedHint.textContent = "Saved to Intelligence.";
    };

    document.getElementById("btnDiscardSeed").onclick = ()=>{
      state.parsedSeed = [];
      els.seedBox.value = "";
      els.seedHint.textContent = "Waiting for block‚Ä¶";
    };

    // ==== Options / modals open-close ====

    document.getElementById("btnOptions").onclick = ()=>{
      // in 4.9 this was static; we just keep a small visual pulse
      els.optionsMenu.style.transform = "scale(1.01)";
      setTimeout(()=>{ els.optionsMenu.style.transform="scale(1)"; },120);
    };

    document.querySelectorAll(".menuItem[data-open]").forEach(mi=>{
      mi.addEventListener("click",()=>{
        const id = mi.getAttribute("data-open");
        const m = document.getElementById(id);
        if(m){ m.style.display="flex"; }
      });
    });

    document.querySelectorAll(".closeX").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const target = btn.getAttribute("data-close");
        if(target){
          const m = document.getElementById(target);
          if(m) m.style.display="none";
        }else{
          btn.closest(".modalOverlay").style.display="none";
        }
      });
    });

    window.addEventListener("click",e=>{
      if(e.target.classList.contains("modalOverlay")){
        e.target.style.display="none";
      }
    });

    // ==== Voice + Learning toggles ====

    document.getElementById("toggleVoiceBtn").onclick = ()=>{
      state.voiceOn = !state.voiceOn;
      els.pillVoice.textContent = state.voiceOn?"on":"off";
      els.pillVoice.className = state.voiceOn?"pillOn":"pillOff";
      els.voiceStatusLabel.textContent = state.voiceOn?"on":"off";
    };

    document.getElementById("toggleLearnBtn").onclick = ()=>{
      state.learningOn = !state.learningOn;
      els.pillLearn.textContent = state.learningOn?"on":"off";
      els.pillLearn.className = state.learningOn?"pillOn":"pillOff";
      els.learnStatusLabel.textContent = state.learningOn?"on":"off";
    };

    // ==== Faith ====
    buildFaithChips();

    // ====== Sense: Camera + Mic logic (NEW) ======

    async function startCameraCapture(){
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        showToast("Camera not available in this browser.");
        return;
      }
      try{
        const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
        if(state.sense.stream){
          state.sense.stream.getTracks().forEach(t=>t.stop());
        }
        state.sense.stream = stream;
        els.senseVideo.srcObject = stream;
        els.senseVideo.style.display = "block";
        els.senseStatus.textContent = "Camera on. Capturing snapshot in 2 seconds‚Ä¶";
        els.senseDot.style.background = "#22c55e";
        setTimeout(captureSnapshotFromVideo,2000);
      }catch(err){
        console.warn(err);
        showToast("Camera permission denied or error.");
      }
    }

    function captureSnapshotFromVideo(){
      if(!state.sense.stream) return;
      const video = els.senseVideo;
      const canvas = els.senseCanvas;
      const w = video.videoWidth || 320;
      const h = video.videoHeight || 240;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video,0,0,w,h);
      const dataUrl = canvas.toDataURL("image/jpeg",0.7);
      // stop stream to save battery
      state.sense.stream.getTracks().forEach(t=>t.stop());
      state.sense.stream = null;
      els.senseVideo.style.display = "none";
      els.senseDot.style.background = "#22c55e";
      els.senseStatus.textContent = "Snapshot captured locally (dataURL length "+dataUrl.length+"). Plug your vision API where indicated in code.";

      // Here we synthesize a BM stub ‚Äì YOU can replace with real CV/LLM analysis
      const stub = "Scene snapshot BM stub:\n"
        + "- Time: "+new Date().toLocaleString()+"\n"
        + "- Source: camera snapshot\n"
        + "- Developer TODO: send image dataURL to vision API and summarise people / objects / mood.\n"
        + "- Emotional guess: calm / neutral until analysed.\n";
      els.senseBMBox.value = stub;
    }

    async function startMicCapture(){
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        showToast("Microphone not available.");
        return;
      }
      try{
        const stream = await navigator.mediaDevices.getUserMedia({audio:true,video:false});
        state.sense.chunks = [];
        const rec = new MediaRecorder(stream);
        state.sense.mediaRecorder = rec;
        els.senseStatus.textContent = "Recording 10 seconds of audio‚Ä¶";
        els.senseDot.style.background = "#f97373";
        rec.ondataavailable = e => state.sense.chunks.push(e.data);
        rec.onstop = ()=>{
          stream.getTracks().forEach(t=>t.stop());
          els.senseDot.style.background = "#22c55e";
          const blob = new Blob(state.sense.chunks,{type:"audio/webm"});
          els.senseStatus.textContent = "Audio sample captured (~"+Math.round(blob.size/1024)+" KB). Plug your speech-to-text + emotion API here.";
          const stub = (els.senseBMBox.value||"")+"\n"
            +"Audio BM stub:\n"
            +"- Time: "+new Date().toLocaleString()+"\n"
            +"- Source: 10s microphone sample\n"
            +"- Developer TODO: send audio blob to ASR/emotion API (pitch, intensity, speaker count).\n";
          els.senseBMBox.value = stub.trim()+"\n";
        };
        rec.start();
        setTimeout(()=>{ if(rec.state==="recording") rec.stop(); },10000);
      }catch(err){
        console.warn(err);
        showToast("Mic permission denied or error.");
      }
    }

    document.getElementById("btnSenseCamera").onclick = startCameraCapture;
    document.getElementById("btnSenseMic").onclick = startMicCapture;

    document.getElementById("btnSaveSenseBM").onclick = ()=>{
      const text = els.senseBMBox.value.trim();
      if(!text){ showToast("Nothing to save."); return; }
      state.bmPrompts.push({text,ts:new Date().toISOString(),source:"sense"});
      safeSaveJSON("ax_bm",state.bmPrompts);
      recomputeBMMetric();
      refreshBMList();
      showToast("Scene BM stub saved.");
      els.senseBMBox.value = "";
    };

    // ==== Events ====

    els.btnSend.addEventListener("click",handleUserInput);
    els.mainInput.addEventListener("keydown",e=>{
      if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        handleUserInput();
      }
    });

    document.getElementById("reactionBar").addEventListener("click",e=>{
      const el = e.target;
      if(!el.dataset.r) return;
      const tag = el.dataset.r;
      logLine("system","Reaction logged: "+tag);
      // simple continuity tweak
      if(tag==="pos" || tag==="calm") state.metrics.C = Math.min(1,state.metrics.C+0.02);
      if(tag==="sad" || tag==="angry") state.metrics.C = Math.max(0,state.metrics.C-0.02);
      updateMetrics(state.metrics.TM);
    });

    els.intelSearch.addEventListener("input",refreshIntelList);

    document.getElementById("btnSaveId"); // already wired above

    // ==== Init ====

    initFromStorage();
    logLine("system","AURA-X Œ© 4.9 + Sense ready. TM = your inputs; internal layers keep emotional continuity.");

  </script>
</body>
</html>