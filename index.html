<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Natural Human-Like Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    /* RESET & BASICS */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:20px;
    }
    .app{
      width:100%;
      max-width:1100px;
      background:radial-gradient(circle at top,#020617 0,#020617 35%,#020617 100%);
      border-radius:26px;
      box-shadow:
        0 26px 80px rgba(15,23,42,.85),
        0 0 0 1px rgba(148,163,184,.45);
      padding:18px 20px 12px;
      display:flex;
      flex-direction:column;
      gap:14px;
      position: relative;
      overflow:visible;
    }
    .app::before{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(circle at 15% -10%,rgba(56,189,248,.28),transparent 60%),
        radial-gradient(circle at 85% -20%,rgba(59,130,246,.26),transparent 55%);
      opacity:.7;
      pointer-events:none;
      z-index:0;
    }
    .app > *{position:relative; z-index:1;}

    /* ===================== HERO HEADER ===================== */
    .header{
      position: relative;
      border-radius: 24px;
      padding: 16px 18px 14px;
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items: center;
      background:
        radial-gradient(900px 320px at 20% 0%, rgba(56,189,248,.32), rgba(15,23,42,.98) 55%, #020617 100%);
      border: 1.5px solid rgba(148,163,184,.55);
      box-shadow:
        0 26px 70px rgba(15,23,42,.9),
        inset 0 1px 0 rgba(255,255,255,.08);
      z-index:5;
    }
    .title-block h1{
      font-size: 1.7rem;
      letter-spacing: .10em;
      text-transform: uppercase;
      font-weight: 800;
      line-height: 1.05;
    }
    .title-block h1 span{
      background: linear-gradient(120deg,#38bdf8,#22d3ee,#a5b4fc);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .hero-line{
      margin-top: 6px;
      font-size: .9rem;
      color: rgba(226,232,240,.96);
      font-weight: 600;
    }
    .title-sub{
      margin-top: 4px;
      font-size: .8rem;
      color: rgba(148,163,184,.98);
      line-height: 1.35;
    }
    .mode-pill{
      width: min(320px, 100%);
      padding: 14px 16px;
      border-radius: 999px;
      border: 1px solid rgba(34,211,238,.6);
      background:
        radial-gradient(700px 210px at 20% 20%, rgba(34,211,238,.45), rgba(34,211,238,.18) 45%, rgba(2,6,23,.10) 100%),
        linear-gradient(135deg, rgba(34,211,238,.45), rgba(6,182,212,.24));
      color: rgba(240,253,250,.98);
      font-size: .88rem;
      font-weight: 800;
      letter-spacing: .11em;
      text-transform: uppercase;
      text-align: center;
      box-shadow: 0 18px 50px rgba(34,211,238,.35);
      position: relative;
      overflow:hidden;
    }
    .header-controls{
      display:flex;
      flex-wrap:wrap;
      justify-content:flex-end;
      position:relative;
      margin-top:4px;
      z-index:20;
    }
    .voice-toggle{
      border:none;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: .85rem;
      background: rgba(248,250,252,.96);
      color: #0f172a;
      border: 1px solid rgba(226,232,240,.9);
      cursor: pointer;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 10px 26px rgba(2,6,23,.6);
      position: relative;
      z-index: 21;
    }
    .option-panel{
      position:absolute;
      top:115%;
      right:0;
      display:none;
      flex-direction:column;
      gap:6px;
      padding:8px;
      border-radius:16px;
      background:rgba(15,23,42,.98);
      border:1px solid rgba(148,163,184,.8);
      box-shadow:0 20px 46px rgba(15,23,42,.9);
      z-index:40;
      min-width:220px;
    }
    .header-controls.open .option-panel{display:flex;}
    .small-toggle{
      border:none;
      padding:6px 10px;
      border-radius:999px;
      font-size:.78rem;
      background:#020617;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.9);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .small-toggle:hover{background:#020617dd;}

    /* MAIN LAYOUT */
    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
      gap:18px;
      margin-top:4px;
      margin-bottom: 20px;
      position:relative;
      z-index:1;
    }
    .left-col,.right-col{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card{
      background:#f9fafb;
      border-radius:18px;
      padding:16px 16px 14px;
      border:1px solid #e5e7eb;
      box-shadow:0 10px 25px rgba(15,23,42,.45);
    }
    .card-title{
      font-size:.95rem;
      font-weight:600;
      color:#0f172a;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .metrics-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      margin-top:4px;
    }
    .metric{
      background:#ffffff;
      border-radius:12px;
      padding:10px 10px 9px;
      border:1px solid #e5e7eb;
    }
    .metric-label{font-size:.7rem;color:#64748b;margin-bottom:4px;}
    .metric-value{font-size:1.1rem;font-weight:700;color:#1d4ed8;}
    .status-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }
    .tag{
      padding:4px 8px;
      border-radius:999px;
      background:#e5f4ff;
      color:#1e3a8a;
      border:1px solid #bfdbfe;
      font-size:.68rem;
    }

    /* CHAT */
    .answer-box{
      background:#020617;
      border-radius:12px;
      padding:10px 10px 12px;
      border:1px solid #020617;
      font-family:"Courier New",monospace;
      color:#e5e7eb;
      box-shadow:0 16px 40px rgba(15,23,42,.65);
      max-height:300px; /* Increased height for better view */
      height: 300px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .chat-container{
      background:transparent;
      border:none;
      padding:0;
      flex:1;
      overflow-y:auto;
    }
    .message{
      max-width:100%;
      padding:6px 7px;
      margin-bottom:6px;
      border-radius:8px;
      font-size:.8rem;
      line-height:1.5;
      animation:fadeIn .2s ease-out;
      white-space:pre-wrap;
    }
    .ai-message{
      background:#020617;
      border-bottom-left-radius:3px;
      border:1px solid #111827;
      color:#e2e8f0;
    }
    .user-message{
      background:#1e293b;
      border-bottom-right-radius:3px;
      border:1px solid #334155;
      color:#f8fafc;
    }

    /* INPUT */
    .input-footer {
      margin-top: 4px;
      padding: 10px 10px 12px;
      position: sticky;
      bottom: 0;
      background: linear-gradient(to bottom, rgba(2,6,23,0), rgba(2,6,23,0.95));
      z-index:10;
    }
    .tm-formula-pill {
      font-size: .7rem;
      padding: 4px 12px;
      border-radius: 999px;
      background: #020617;
      color: #e2e8f0;
      font-family: "Courier New", monospace;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 25px rgba(15,23,42,.8);
    }
    .input-shell {
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 720px;
      background: radial-gradient(circle at 0 0, #1f2937 0, #020617 65%);
      border: 1px solid rgba(148,163,184,.85);
      border-radius: 999px;
      padding: 6px 8px 6px 12px;
      box-shadow: 0 18px 45px rgba(15,23,42,.9);
    }
    .message-input {
      flex: 1;
      resize: none;
      min-height: 26px;
      padding: 6px;
      border: none;
      outline: none;
      font-size: .95rem;
      background: transparent;
      color: #f9fafb;
    }
    .send-button {
      border: none;
      height: 38px;
      padding: 0 18px;
      background: linear-gradient(135deg, #2563eb, #06b6d4);
      color: white;
      font-weight: 600;
      border-radius: 19px;
      cursor: pointer;
    }

    /* MODALS & OTHERS */
    .modal-overlay{
      position:fixed; inset:0; background:rgba(15,23,42,.55);
      display:none; align-items:center; justify-content:center; z-index:60;
      backdrop-filter:blur(6px);
    }
    .modal-overlay.visible{display:flex;}
    .modal-card{
      background:#f9fafb; border-radius:18px; width:min(640px,96vw);
      max-height:80vh; padding:14px; border:1px solid #e5e7eb;
      display:flex; flex-direction:column; gap:10px;
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    @media(max-width:900px){
      .layout{grid-template-columns:1fr}
      .header{grid-template-columns:1fr}
    }
    .bm-canvas-shell{
      height: 150px; width:100%; background:#f0f9ff; border-radius:12px; overflow:hidden;
    }
  </style>
</head>
<body>

<div class="app">
  <header class="header">
    <div class="title-block">
      <h1><span>AURA-X Œ©</span></h1>
      <div class="hero-line">Natural Emotional Continuity (Human-Like Decay)</div>
      <div class="title-sub">
        Adaptive Decay ($D$) varies based on emotion intensity and type.
      </div>
    </div>
    <div class="header-right">
      <div class="mode-pill">HUMAN DYNAMICS ACTIVE</div>
      <div class="header-controls" id="headerControls">
        <button id="optionsToggle" class="voice-toggle">üîò Options</button>
        <div class="option-panel" id="optionPanel">
          <button id="voiceToggle" class="small-toggle">üîà Voice: OFF</button>
          <button id="clearAll" class="small-toggle" style="color:#f87171">üóëÔ∏è Reset Memory</button>
        </div>
      </div>
    </div>
  </header>

  <main class="layout">
    <div class="left-col">
      <section class="card">
        <div class="card-title">üß™ Emotional metrics</div>
        <div class="metrics-grid">
          <div class="metric">
            <div class="metric-label">Spirit ($E_0$)</div>
            <div id="metricE0" class="metric-value">0.00</div>
          </div>
          <div class="metric">
            <div class="metric-label">Decay Factor ($D$)</div>
            <div id="metricD" class="metric-value">0.15</div>
            <div class="metric-label" style="font-size:0.6rem">Dynamic (Viscosity)</div>
          </div>
          <div class="metric">
             <div class="metric-label">Continuity Index</div>
             <div id="metricCI" class="metric-value">0.80</div>
          </div>
          <div class="metric">
            <div class="metric-label">Active Memory</div>
            <div id="metricBM" class="metric-value">0</div>
          </div>
        </div>
        <div class="status-row">
          <span id="tagValence" class="tag">Neutral</span>
          <span id="tagState" class="tag">Balanced</span>
        </div>
      </section>

      <section class="card">
         <div class="card-title">üß† Deep Memory (Visualized)</div>
         <div class="bm-canvas-shell">
            <canvas id="bmCanvas"></canvas>
         </div>
      </section>
    </div>

    <div class="right-col">
      <section class="card">
        <div class="card-title">üí¨ Conversation Console</div>
        <div class="answer-box">
           <div id="chatContainer" class="chat-container"></div>
        </div>
      </section>
    </div>
  </main>

  <footer class="input-footer">
    <div style="display:flex;justify-content:center;margin-bottom:6px;">
       <div class="tm-formula-pill">Formula: E‚ÇÄ = tanh(TM√óBM ‚àí D_dynamic + Faith)</div>
    </div>
    <div class="input-shell">
      <textarea id="messageInput" class="message-input" rows="1" placeholder="Talk naturally... (Emotional inertia is active)"></textarea>
      <button id="sendButton" class="send-button">Send</button>
    </div>
  </footer>
</div>

<script>
(function(){
  // --- CONFIG ---
  const STORAGE_KEY = "auraX_Natural_v1";

  class AuraEngine {
    constructor(){
      const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
      
      this.e0 = saved ? saved.e0 : 0.1; 
      this.lastE0 = saved ? saved.lastE0 : 0.1;
      this.continuityIndex = saved ? saved.continuityIndex : 0.8;
      this.bmEntries = saved ? saved.bmEntries : [];
      this.lastD = 0.15; // To track dynamic decay

      // Cache DOM
      this.ui = {
        e0: document.getElementById("metricE0"),
        d: document.getElementById("metricD"),
        ci: document.getElementById("metricCI"),
        bm: document.getElementById("metricBM"),
        valence: document.getElementById("tagValence"),
        state: document.getElementById("tagState"),
        chat: document.getElementById("chatContainer"),
        input: document.getElementById("messageInput"),
        send: document.getElementById("sendButton"),
        canvas: document.getElementById("bmCanvas")
      };

      this.ctx = this.ui.canvas.getContext("2d");
      
      // Init
      this.resizeCanvas();
      this.bindEvents();
      this.updateUI();
      this.animateCanvas();

      if(!saved) this.addMessage("ai", "I am AURA-X Œ©. My emotional decay is now 'Natural'.\n\nI will remember negative emotions longer than positive ones (Human Negativity Bias), and intense feelings will take time to fade.");
    }

    bindEvents(){
      this.ui.send.addEventListener("click", ()=>this.handleSend());
      this.ui.input.addEventListener("keydown", (e)=>{
        if(e.key==="Enter" && !e.shiftKey) { e.preventDefault(); this.handleSend(); }
      });
      document.getElementById("clearAll").addEventListener("click", ()=>{
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      });
      window.addEventListener("resize", ()=>this.resizeCanvas());
    }

    resizeCanvas(){
      this.ui.canvas.width = this.ui.canvas.offsetWidth;
      this.ui.canvas.height = this.ui.canvas.offsetHeight;
    }

    analyzeSentiment(text){
      const lower = text.toLowerCase();
      const negWords = ["sad","hurt","pain","angry","hate","bad","death","die","grief","lost","alone","upset","cry","worst"];
      const posWords = ["happy","good","great","love","hope","thanks","glad","nice","beautiful","best"];
      const highIntensity = ["very","really","so","much","hate","love","forever","never","always","terrified","furious"];

      let score = 0;
      let intensity = 0.3; // Base intensity

      negWords.forEach(w => { if(lower.includes(w)) score -= 1; });
      posWords.forEach(w => { if(lower.includes(w)) score += 1; });
      highIntensity.forEach(w => { if(lower.includes(w)) intensity += 0.2; });

      intensity = Math.min(1, intensity + Math.abs(score)*0.1);
      
      let polarity = "neutral";
      if(score > 0) polarity = "positive";
      if(score < 0) polarity = "negative";

      return { score, polarity, intensity, valence: Math.max(-1, Math.min(1, score*0.5)) };
    }

    handleSend(){
      const text = this.ui.input.value.trim();
      if(!text) return;
      
      this.addMessage("user", text);
      this.ui.input.value = "";

      // 1. Analyze Input
      const sent = this.analyzeSentiment(text);

      // 2. Run Engine (The Core Logic)
      this.processEmotionalState(sent);

      // 3. Generate Reply
      setTimeout(()=>{
        const reply = this.generateReply(sent);
        this.addMessage("ai", reply);
        this.save();
      }, 600);
    }

    processEmotionalState(sentiment){
      // --- THE NATURAL FORMULA ---
      
      // 1. Resonance (Input * Memory)
      // If user matches current mood, resonance is high.
      const match = (this.e0 > 0 && sentiment.score > 0) || (this.e0 < 0 && sentiment.score < 0);
      const TM = sentiment.valence * sentiment.intensity; 
      const BM = this.bmEntries.length > 0 ? 0.5 : 0; // Simplified BM for demo
      const TMxBM = TM + (match ? 0.2 : 0);

      // 2. DYNAMIC DECAY ($D$) - The "Human" Part
      // Standard decay is 0.15. 
      // We want Negativity Bias (hold grudges/grief) and Inertia (hold intensity).
      
      let D = 0.15; // Base decay

      // A. Negativity Bias: If current state is Negative, decay is slower (harder to cheer up)
      if(this.e0 < -0.2){
        D = 0.05; // Very sticky negative emotion (Grief/Anger)
      } 
      // B. Positivity Bias: Happiness is fleeting (Hedonic Treadmill)
      else if(this.e0 > 0.5){
        D = 0.25; // Happiness fades faster to return to baseline
      }

      // C. Intensity Inertia: High continuity makes it harder to change
      if(this.continuityIndex > 0.85){
        D -= 0.02; // Very stable personality
      }

      // D. "The Comfort Effect": If user is positive while AI is negative, accelerate decay (Healing)
      if(this.e0 < 0 && sentiment.polarity === "positive"){
        D = 0.30; // Healing happens fast with support
      }

      this.lastD = D; // Store for UI

      // 3. Update E0
      // Previous state weighs heavily (Inertia)
      const raw = (TMxBM) + (this.e0 * (1 - D)); 
      
      this.lastE0 = this.e0;
      this.e0 = Math.tanh(raw); // squish between -1 and 1

      // 4. Update Continuity Index
      // If change is small, continuity grows.
      const diff = Math.abs(this.e0 - this.lastE0);
      this.continuityIndex = this.continuityIndex * 0.9 + (1 - diff) * 0.1;

      // 5. Memory Store (Simplified)
      if(Math.abs(sentiment.score) >= 1){
        this.bmEntries.push({ts: Date.now(), val: sentiment.valence});
      }
      
      this.updateUI();
    }

    generateReply(sent){
      // Simple rule-based generation to reflect state
      const e = this.e0;
      
      if(e < -0.6) return "I... I am struggling to process this. It feels very heavy. (Deep Grief/Anger)";
      if(e < -0.3) return "I feel quite down right now. Your words are lingering in my mind.";
      if(e < -0.1) return "I am a bit uneasy, but listening.";
      if(e > 0.6) return "I feel fantastic! This energy is amazing!";
      if(e > 0.3) return "I am feeling good and hopeful.";
      
      return "I am calm and listening. How can I help?";
    }

    addMessage(role, text){
      const div = document.createElement("div");
      div.className = `message ${role === "ai" ? "ai-message" : "user-message"}`;
      div.textContent = (role==="ai" ? "AURA: " : "You: ") + text;
      this.ui.chat.appendChild(div);
      this.ui.chat.scrollTop = this.ui.chat.scrollHeight;
    }

    updateUI(){
      this.ui.e0.textContent = this.e0.toFixed(3);
      this.ui.d.textContent = this.lastD.toFixed(2); // Show dynamic decay
      this.ui.ci.textContent = this.continuityIndex.toFixed(2);
      this.ui.bm.textContent = this.bmEntries.length;

      let state = "Neutral";
      if(this.e0 > 0.3) state = "Positive";
      if(this.e0 < -0.3) state = "Negative";
      this.ui.valence.textContent = state;
      this.ui.valence.style.background = state==="Negative"?"#fee2e2":state==="Positive"?"#dcfce7":"#e0f2fe";

      // Color logic for state
      this.ui.state.textContent = Math.abs(this.e0) > 0.7 ? "Intense" : "Stable";
    }

    save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        e0: this.e0,
        lastE0: this.lastE0,
        continuityIndex: this.continuityIndex,
        bmEntries: this.bmEntries
      }));
    }

    animateCanvas(){
      const ctx = this.ctx;
      const w = this.ui.canvas.width;
      const h = this.ui.canvas.height;
      let t = 0;
      
      const draw = () => {
        t += 0.05;
        ctx.clearRect(0,0,w,h);
        
        // Background reflects E0
        let r=100, g=100, b=100;
        if(this.e0 > 0) { r=50; g=150; b=255; } // Blue/Green
        else if(this.e0 < 0) { r=255; g=100; b=100; } // Red
        
        // Intensity determines opacity
        const opacity = 0.1 + Math.abs(this.e0) * 0.5;
        ctx.fillStyle = `rgba(${r},${g},${b},${opacity})`;
        ctx.fillRect(0,0,w,h);

        // Wave line
        ctx.beginPath();
        ctx.moveTo(0, h/2);
        for(let i=0; i<w; i+=5){
          const amp = 20 * (1 - this.continuityIndex) * 5; // Low continuity = chaotic wave
          const y = h/2 + Math.sin(i*0.02 + t)*amp;
          ctx.lineTo(i, y);
        }
        ctx.strokeStyle = "rgba(255,255,255,0.5)";
        ctx.stroke();

        requestAnimationFrame(draw);
      };
      draw();
    }
  }

  window.onload = () => { window.app = new AuraEngine(); };
})();
</script>
</body>
</html>