<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline BM Pack (Media + Export/Import + Dream)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root { --accent:#0ea5e9; --bg:#020617; --panel:rgba(2,6,23,.55); --stroke:rgba(148,163,184,.18); }
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px 10px;
    }
    .app{
      width:min(980px,98vw);
      background:rgba(2,6,23,.45);
      border:1px solid rgba(148,163,184,.18);
      border-radius:22px;
      overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
    }
    .top{
      padding:18px 16px 12px;
      border-bottom:1px solid rgba(148,163,184,.14);
      text-align:center;
      position:relative;
    }
    .brand{
      font-weight:900;
      letter-spacing:.6px;
      font-size:26px;
      color:#7dd3fc;
      text-shadow:0 0 22px rgba(14,165,233,.28);
    }
    .sub{opacity:.8;margin-top:4px;font-size:13px;line-height:1.35}
    .pill{
      margin:12px auto 0;
      max-width:760px;
      background:linear-gradient(90deg, rgba(14,165,233,.65), rgba(34,211,238,.45));
      border:1px solid rgba(125,211,252,.30);
      color:#0b1220;
      font-weight:900;
      letter-spacing:.6px;
      border-radius:999px;
      padding:12px 16px;
      text-transform:uppercase;
      box-shadow:0 12px 40px rgba(14,165,233,.22);
    }

    .main{ padding:16px 16px 18px }
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:stretch}
    .leftCol{ flex:1 1 340px; min-width:300px }
    .rightCol{ flex:1 1 360px; min-width:320px }

    .card{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      backdrop-filter:blur(10px);
    }

    .optionsBtn{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;padding:10px 14px;border-radius:999px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(15,23,42,.55);
      color:#e5e7eb;cursor:pointer;user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .optionsBtn:active{transform:scale(.99)}
    .btnRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .btn{
      border:none;border-radius:999px;
      padding:10px 14px;font-weight:900;cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      background:rgba(15,23,42,.6);color:#e5e7eb;
      border:1px solid rgba(148,163,184,.22);
    }
    .btn:active{transform:scale(.99)}
    .btnPrimary{
      background:linear-gradient(90deg, var(--accent), rgba(34,211,238,.55));
      color:#0b1220;border:0;
      box-shadow:0 12px 30px rgba(14,165,233,.18);
    }
    .btnDanger{ background:rgba(239,68,68,.14); border-color:rgba(239,68,68,.25); color:#fecaca; }
    .btnOk{ background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.25); color:#bbf7d0; }

    .console{
      margin-top:12px;height:220px;border-radius:16px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(0,0,0,.25);
      padding:12px;overflow:auto;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:13px;line-height:1.55;white-space:pre-wrap;
      box-shadow:inset 0 0 0 1px rgba(125,211,252,.06);
    }
    .line{display:block;margin:2px 0}
    .line.user{color:#a5b4fc}
    .line.aura{color:#bbf7d0}
    .line.sys{color:#fbbf24;font-size:12px}

    .chatWrap{
      padding:12px;border-radius:18px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.45);
    }
    .capsule{
      margin:6px 0 10px;
      width:100%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      padding:8px 12px;
      display:flex;gap:10px;flex-wrap:wrap;
      align-items:center;justify-content:center;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:12px;color:#dbeafe;
      box-shadow:inset 0 0 0 1px rgba(125,211,252,.06);
    }
    .capsule b{ color:#7dd3fc; font-weight:900 }

    .inputRow{display:flex;gap:10px;align-items:flex-end}
    .input{
      flex:1;border-radius:999px;border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);color:#e5e7eb;
      padding:12px 14px;outline:none;font-size:14px;
    }
    .send{
      border:none;border-radius:999px;
      background:linear-gradient(90deg, var(--accent), rgba(34,211,238,.55));
      color:#0b1220;font-weight:900;
      padding:12px 18px;cursor:pointer;min-width:88px;
      box-shadow:0 12px 30px rgba(14,165,233,.18);
      -webkit-tap-highlight-color:transparent;
    }
    .send:active{transform:scale(.99)}

    /* Preview panel */
    .previewPanel{
      margin-top:10px;border:1px solid rgba(148,163,184,.18);
      border-radius:16px;background:rgba(15,23,42,.45);
      padding:10px;display:none;
    }
    .previewMedia{
      width:100%;max-height:190px;border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      background:#000;object-fit:contain;
    }
    .note{
      width:100%;margin-top:8px;border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);color:#e5e7eb;
      padding:10px;font-size:13px;min-height:90px;outline:none;
      font-family:ui-monospace,Menlo,Consolas,monospace;
    }
    .small{font-size:11px;opacity:.75;margin-top:6px;text-align:center}

    /* Modal */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:flex-end;justify-content:center;
      padding:18px 12px;z-index:9999;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(860px,96vw);
      border-radius:18px;overflow:hidden;
      background:rgba(250,250,250,.93);color:#0b1220;
      border:1px solid rgba(15,23,42,.18);
      box-shadow:0 30px 80px rgba(0,0,0,.35);
      backdrop-filter:blur(12px);
    }
    .mHeader{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 14px;background:rgba(255,255,255,.75);
      border-bottom:1px solid rgba(15,23,42,.10);font-weight:900;
    }
    .closeX{
      border:none;background:transparent;font-size:22px;
      cursor:pointer;line-height:1;padding:0 4px;opacity:.75;
    }
    .mBody{padding:14px;max-height:72vh;overflow:auto}
    .bmItem{
      background:#fff;border:1px solid rgba(15,23,42,.12);
      border-radius:14px;padding:10px 10px;margin-bottom:10px;
      cursor:pointer;
    }
    .bmItem b{display:block}
    .bmMeta{font-size:12px;opacity:.7;margin-top:2px}
    .bmDetail{
      margin-top:10px;border:1px solid rgba(15,23,42,.12);
      background:#fff;border-radius:14px;padding:10px;
    }
    .bmDetail pre{
      white-space:pre-wrap;word-break:break-word;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:12.5px;line-height:1.45;
      background:rgba(2,6,23,.03);
      border:1px solid rgba(15,23,42,.06);
      border-radius:12px;padding:10px;
    }
    .bmActions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
    .mFooter{
      padding:12px 14px;border-top:1px solid rgba(15,23,42,.10);
      background:rgba(255,255,255,.72);
      display:flex;gap:8px;flex-wrap:wrap;justify-content:space-between;align-items:center;
    }

    /* Toast */
    .toast{
      position:fixed;bottom:18px;left:50%;
      transform:translate(-50%,10px);
      padding:6px 14px;border-radius:999px;
      background:rgba(15,23,42,.95);color:#e5e7eb;font-size:12px;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:0 12px 30px rgba(0,0,0,.5);
      opacity:0;pointer-events:none;z-index:10000;
      transition:opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1;transform:translate(-50%,0)}

    /* Dream overlay */
    #dreamOverlay{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      z-index:9500;backdrop-filter:blur(16px);background:rgba(0,0,0,.22);
    }
    #dreamCanvas{position:absolute;inset:0;width:100%;height:100%}
    #dreamIntro{
      position:relative;z-index:2;text-align:center;padding:18px 16px;max-width:620px;
      background:rgba(15,23,42,.35);border:1px solid rgba(148,163,184,.18);
      border-radius:18px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="brand">AURA-X Œ©</div>
      <div class="sub">
        Offline BM Pack Prototype (Media Vault + Export/Import + Recall + Dream)<br>
        Everything stays on device unless you connect your own API.
      </div>
      <div class="pill">EMOTIONAL CONTINUITY ENGINE ‚Äî ACTIVE</div>
    </div>

    <div class="main">
      <div class="row">
        <!-- LEFT -->
        <div class="leftCol">
          <div class="card">
            <div class="optionsBtn" id="btnOptions">
              <span style="font-weight:900">Options</span>
              <span style="opacity:.85;font-size:12px">BM + Pack + Dream</span>
            </div>

            <div class="btnRow">
              <button class="btn btnPrimary" id="btnBMRecall">üìò BM Recall</button>
              <button class="btn" id="btnDreamToggle">üåô Dream: On</button>
              <button class="btn" id="btnTestDream">Test Dream</button>
            </div>

            <div class="console" id="console"></div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="rightCol">
          <div class="chatWrap">
            <div class="capsule">
              <span><b>E0</b>: <span id="cE0">0.000</span></span><span>¬∑</span>
              <span><b>TM</b>: <span id="cTM">0.00</span></span><span>¬∑</span>
              <span><b>BM</b>: <span id="cBM">0.00</span></span><span>¬∑</span>
              <span><b>C</b>: <span id="cC">0.850</span></span>
            </div>

            <div class="inputRow">
              <label class="btn" style="padding:10px 12px;cursor:pointer;">
                üì∑/üé¨/üéôÔ∏è
                <input id="mediaInput" type="file" accept="image/*,video/*,audio/*" style="display:none" />
              </label>
              <input class="input" id="userInput" placeholder="Talk to AURA-X Œ©‚Ä¶ (TM = your inputs)" />
              <button class="send" id="sendBtn">Send</button>
            </div>

            <div class="previewPanel" id="previewPanel">
              <div id="previewSlot"></div>
              <textarea class="note" id="mediaNote" placeholder="Optional note / PROMPT (this is what 'Copy prompt' will copy)‚Ä¶"></textarea>
              <div class="btnRow" style="justify-content:flex-end">
                <button class="btn btnOk" id="btnSaveToBM">Save to BM</button>
                <button class="btn btnDanger" id="btnCancelMedia">Cancel</button>
              </div>
              <div class="small">Tip: ÿß⁄Øÿ± ÿ¢Ÿæ ⁄Üÿß€Åÿ™€í €Å€å⁄∫ generator ŸÖ€å⁄∫ ‚Äú99% same‚Äù ÿ¢ÿ¶€í ÿ™Ÿà prompt ⁄©€í ÿ≥ÿßÿ™⁄æ reference image ÿ®⁄æ€å ÿßÿ≥ÿ™ÿπŸÖÿßŸÑ ⁄©ÿ±€å⁄∫ (img2img/ref).</div>
            </div>

            <div class="small" style="margin-top:10px">
              BM Pack Export/Import ‚Üí ÿß€å⁄© ŸÅÿßÿ¶ŸÑ ŸÖ€å⁄∫ Text + Image + Video + Audio ÿ≥ÿ®
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BM Recall Modal -->
  <div class="overlay" id="bmOverlay">
    <div class="modal">
      <div class="mHeader">
        <div>üìò Recall from BM <small style="font-weight:700;opacity:.7"> (text + media-ready)</small></div>
        <button class="closeX" id="bmClose">√ó</button>
      </div>

      <div class="mBody">
        <input id="bmSearch" placeholder="Search BM by text‚Ä¶" style="width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(15,23,42,.12);outline:none;margin-bottom:10px;">
        <div id="bmList"></div>

        <div class="bmDetail" id="bmDetail" style="display:none">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
            <div>
              <b id="bmTitle">BM</b>
              <div class="bmMeta" id="bmMeta"></div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" id="btnUnlock">Unlock</button>
              <button class="btn" id="btnLock">Lock</button>
            </div>
          </div>

          <pre id="bmText"></pre>

          <div class="bmActions">
            <button class="btn" id="btnCopyPrompt">Copy prompt</button>
            <button class="btn" id="btnExtractMedia">Extract media</button>
            <button class="btn btnDanger" id="btnDeleteBM">Delete</button>
          </div>
        </div>
      </div>

      <div class="mFooter">
        <div style="font-size:12px;opacity:.8">
          Pack: Export/Import BM + All Media
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn" id="btnExportPack">Export BM Pack</button>
          <label class="btn" style="cursor:pointer">
            Import BM Pack
            <input id="importPackInput" type="file" accept=".json,application/json" style="display:none">
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Dream -->
  <div id="dreamOverlay">
    <canvas id="dreamCanvas"></canvas>
    <div id="dreamIntro">
      <div style="font-weight:900;font-size:18px;color:#e0f2fe;">AURA-X Œ© ¬∑ Dreaming‚Ä¶</div>
      <div style="margin-top:6px;font-size:13px;color:#bae6fd;opacity:.95;">
        BM images drifting softly. Tap anywhere to wake.
      </div>
      <div id="dreamMeta" style="margin-top:6px;font-size:11px;color:#93c5fd;opacity:.9;"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ==========================
   AURA-X Œ© BM PACK (Single HTML)
   - Media Vault: IndexedDB blobs
   - BM: localStorage array with mediaIds
   - Export Pack: JSON+Base64 (single file)
   - Import Pack: restore BM + media
   - Copy prompt: clipboard + fallback
   - Dream: uses stored images
   ========================== */

const KEY_BM = "aurax_bm_v2_pack";
const KEY_CFG = "aurax_cfg_v2_pack";

const state = {
  metrics: { TM:0, BM:0, C:0.85, E0:0 },
  bm: [],
  dreamEnabled: true,
  dreamDelayMs: 10 * 60 * 1000,
  lastActivity: Date.now(),
  dreamTimer: null,

  pendingMedia: null, // {id, kind, name, mime, blob, previewUrl}
  selectedBMId: null,
  dream: { running:false, imgs:[], idx:0, t0:0 }
};

const els = {
  console: document.getElementById("console"),
  userInput: document.getElementById("userInput"),
  sendBtn: document.getElementById("sendBtn"),

  cE0: document.getElementById("cE0"),
  cTM: document.getElementById("cTM"),
  cBM: document.getElementById("cBM"),
  cC: document.getElementById("cC"),

  mediaInput: document.getElementById("mediaInput"),
  previewPanel: document.getElementById("previewPanel"),
  previewSlot: document.getElementById("previewSlot"),
  mediaNote: document.getElementById("mediaNote"),
  btnSaveToBM: document.getElementById("btnSaveToBM"),
  btnCancelMedia: document.getElementById("btnCancelMedia"),

  btnBMRecall: document.getElementById("btnBMRecall"),
  bmOverlay: document.getElementById("bmOverlay"),
  bmClose: document.getElementById("bmClose"),
  bmSearch: document.getElementById("bmSearch"),
  bmList: document.getElementById("bmList"),
  bmDetail: document.getElementById("bmDetail"),
  bmTitle: document.getElementById("bmTitle"),
  bmMeta: document.getElementById("bmMeta"),
  bmText: document.getElementById("bmText"),
  btnCopyPrompt: document.getElementById("btnCopyPrompt"),
  btnExtractMedia: document.getElementById("btnExtractMedia"),
  btnDeleteBM: document.getElementById("btnDeleteBM"),
  btnUnlock: document.getElementById("btnUnlock"),
  btnLock: document.getElementById("btnLock"),

  btnExportPack: document.getElementById("btnExportPack"),
  importPackInput: document.getElementById("importPackInput"),

  btnDreamToggle: document.getElementById("btnDreamToggle"),
  btnTestDream: document.getElementById("btnTestDream"),
  dreamOverlay: document.getElementById("dreamOverlay"),
  dreamCanvas: document.getElementById("dreamCanvas"),
  dreamMeta: document.getElementById("dreamMeta"),

  toast: document.getElementById("toast")
};

function nowTs(){ return Date.now(); }
function fmt(ts){
  try{
    const d = new Date(ts);
    return d.toLocaleString();
  }catch(e){ return String(ts); }
}

function showToast(msg){
  els.toast.textContent = msg;
  els.toast.classList.add("show");
  setTimeout(()=>els.toast.classList.remove("show"), 2200);
}

function logLine(role, text){
  const span = document.createElement("span");
  span.className = "line " + role;
  span.textContent = "["+role.toUpperCase()+"] " + text;
  els.console.appendChild(span);
  els.console.appendChild(document.createElement("br"));
  els.console.scrollTop = els.console.scrollHeight;
}

/* ===================== IndexedDB Media Vault ===================== */
const DB_NAME = "aurax_media_vault_v1";
const DB_STORE = "media";

function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = (e)=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(DB_STORE)){
        const st = db.createObjectStore(DB_STORE, { keyPath:"id" });
        st.createIndex("kind","kind",{unique:false});
        st.createIndex("ts","ts",{unique:false});
      }
    };
    req.onsuccess = ()=>resolve(req.result);
    req.onerror = ()=>reject(req.error);
  });
}

async function putMedia(rec){
  const db = await openDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(DB_STORE,"readwrite");
    tx.objectStore(DB_STORE).put(rec);
    tx.oncomplete=()=>{ db.close(); resolve(true); };
    tx.onerror=()=>{ const err = tx.error; db.close(); reject(err); };
  });
}

async function getMedia(id){
  const db = await openDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(DB_STORE,"readonly");
    const req = tx.objectStore(DB_STORE).get(id);
    req.onsuccess=()=>{ const v=req.result; db.close(); resolve(v||null); };
    req.onerror=()=>{ const err=req.error; db.close(); reject(err); };
  });
}

async function getAllMedia(){
  const db = await openDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(DB_STORE,"readonly");
    const req = tx.objectStore(DB_STORE).getAll();
    req.onsuccess=()=>{ const v=req.result||[]; db.close(); resolve(v); };
    req.onerror=()=>{ const err=req.error; db.close(); reject(err); };
  });
}

async function deleteMedia(id){
  const db = await openDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(DB_STORE,"readwrite");
    tx.objectStore(DB_STORE).delete(id);
    tx.oncomplete=()=>{ db.close(); resolve(true); };
    tx.onerror=()=>{ const err=tx.error; db.close(); reject(err); };
  });
}

/* ===================== BM Storage ===================== */
function loadCfg(){
  try{
    const cfg = JSON.parse(localStorage.getItem(KEY_CFG)||"{}");
    if(typeof cfg.dreamEnabled === "boolean") state.dreamEnabled = cfg.dreamEnabled;
  }catch(e){}
}
function saveCfg(){
  localStorage.setItem(KEY_CFG, JSON.stringify({ dreamEnabled: state.dreamEnabled }));
}

function loadBM(){
  try{
    const raw = localStorage.getItem(KEY_BM);
    state.bm = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(state.bm)) state.bm = [];
  }catch(e){
    state.bm = [];
  }
  recomputeBMMetric();
}

function saveBM(){
  localStorage.setItem(KEY_BM, JSON.stringify(state.bm));
  recomputeBMMetric();
}

function recomputeTMMetric(){
  const t = (els.userInput.value||"").trim().length;
  state.metrics.TM = Math.min(t/300, 1.5);
}

function recomputeBMMetric(){
  const locked = state.bm.filter(x=>x.locked).length;
  state.metrics.BM = Math.min(locked/12, 1.6);
  recomputeE0();
}

function recomputeE0(){
  const m = state.metrics;
  const R = m.TM*0.9 + m.BM*1.1;
  const I_TM = m.TM*0.5;
  const D = 0;
  const raw = R + I_TM - D + 0.1 + 0.15;
  m.E0 = Math.tanh(raw);
  updateCapsule();
}

function updateCapsule(){
  els.cTM.textContent = state.metrics.TM.toFixed(2);
  els.cBM.textContent = state.metrics.BM.toFixed(2);
  els.cC.textContent  = state.metrics.C.toFixed(3);
  els.cE0.textContent = state.metrics.E0.toFixed(3);
}

/* ===================== Clipboard copy (robust) ===================== */
async function robustCopyText(text){
  // 1) Clipboard API
  try{
    if(navigator.clipboard && window.isSecureContext){
      await navigator.clipboard.writeText(text);
      return true;
    }
  }catch(e){}
  // 2) execCommand fallback
  try{
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    ta.style.top = "0";
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    const ok = document.execCommand("copy");
    document.body.removeChild(ta);
    if(ok) return true;
  }catch(e){}
  // 3) last resort: put into input and select (manual copy)
  els.userInput.value = text;
  els.userInput.focus();
  els.userInput.setSelectionRange(0, els.userInput.value.length);
  return false;
}

/* ===================== Media pick + preview ===================== */
function kindFromMime(mime){
  if(!mime) return "file";
  if(mime.startsWith("image/")) return "image";
  if(mime.startsWith("video/")) return "video";
  if(mime.startsWith("audio/")) return "audio";
  return "file";
}

function clearPendingMedia(){
  if(state.pendingMedia?.previewUrl){
    try{ URL.revokeObjectURL(state.pendingMedia.previewUrl); }catch(e){}
  }
  state.pendingMedia = null;
  els.previewPanel.style.display = "none";
  els.previewSlot.innerHTML = "";
  els.mediaNote.value = "";
}

function renderPreview(p){
  els.previewSlot.innerHTML = "";
  if(!p) return;

  if(p.kind==="image"){
    const img = document.createElement("img");
    img.src = p.previewUrl;
    img.className = "previewMedia";
    img.alt = "image";
    els.previewSlot.appendChild(img);
  }else if(p.kind==="video"){
    const v = document.createElement("video");
    v.src = p.previewUrl;
    v.className = "previewMedia";
    v.controls = true;
    v.playsInline = true;
    els.previewSlot.appendChild(v);
  }else if(p.kind==="audio"){
    const a = document.createElement("audio");
    a.src = p.previewUrl;
    a.controls = true;
    a.style.width = "100%";
    els.previewSlot.appendChild(a);
  }else{
    const d = document.createElement("div");
    d.textContent = "File attached: " + p.name;
    d.style.padding="10px";
    d.style.border="1px solid rgba(148,163,184,.18)";
    d.style.borderRadius="14px";
    els.previewSlot.appendChild(d);
  }

  els.previewPanel.style.display = "block";
}

els.mediaInput.addEventListener("change", (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;

  const id = "m_" + nowTs() + "_" + Math.random().toString(16).slice(2);
  const kind = kindFromMime(f.type);
  const previewUrl = URL.createObjectURL(f);

  state.pendingMedia = { id, kind, name:f.name||(`${kind}_${id}`), mime:f.type||"", blob:f, ts: nowTs(), previewUrl };
  renderPreview(state.pendingMedia);
  showToast("Media attached ‚Ä¢ add prompt note then Save to BM");
  e.target.value = "";
});

/* ===================== Save to BM ===================== */
async function savePendingToBM(){
  const p = state.pendingMedia;
  if(!p){ showToast("No media attached"); return; }

  // Save media blob to vault
  await putMedia({ id:p.id, kind:p.kind, name:p.name, mime:p.mime, ts:p.ts, blob:p.blob });

  const note = (els.mediaNote.value||"").trim();
  const title = (p.kind==="image" ? "Sense image" : (p.kind==="video" ? "Sense capture" : (p.kind==="audio" ? "Sense voice" : "Sense file")));

  const bmId = "bm_" + nowTs() + "_" + Math.random().toString(16).slice(2);
  const bmText = [
    note ? note : "(no text prompt saved)",
    "",
    `[BM_MEDIA: ${p.id} kind=${p.kind} name=${p.name}]`
  ].join("\n");

  state.bm.unshift({
    id: bmId,
    title,
    text: bmText,
    ts: nowTs(),
    locked: true,
    mediaIds: [p.id]
  });

  saveBM();
  clearPendingMedia();
  showToast("Saved to BM ‚úÖ");
  scheduleDream();
  logLine("sys", `Saved BM: ${title} (${bmId}) with media ${p.id}`);
}

els.btnSaveToBM.addEventListener("click", ()=>savePendingToBM().catch(err=>{
  console.warn(err);
  showToast("Save failed (storage/permission)");
}));
els.btnCancelMedia.addEventListener("click", clearPendingMedia);

/* ===================== Simple chat ===================== */
function generateAuraReply(prompt){
  const mood = state.metrics.E0 > 0.4 ? "positive" : (state.metrics.E0 < -0.2 ? "heavy" : "neutral");
  return `I hear you. Current E‚ÇÄ ‚âà ${state.metrics.E0.toFixed(3)} (${mood}). You said: ‚Äú${prompt}‚Äù.`;
}
function handleSend(){
  const text = (els.userInput.value||"").trim();
  if(!text) return;
  els.userInput.value="";
  state.metrics.TM = Math.min(text.length/400, 1.5);
  recomputeE0();
  registerActivity();

  logLine("user", text);
  const reply = generateAuraReply(text);
  logLine("aura", reply);
}

/* ===================== BM Recall UI ===================== */
function openBM(){
  refreshBMList();
  els.bmOverlay.classList.add("show");
}
function closeBM(){
  els.bmOverlay.classList.remove("show");
  state.selectedBMId = null;
  els.bmDetail.style.display="none";
}

function refreshBMList(){
  const q = (els.bmSearch.value||"").trim().toLowerCase();
  const items = state.bm.filter(b=>{
    if(!q) return true;
    const t = (b.title||"") + " " + (b.text||"");
    return t.toLowerCase().includes(q);
  });

  els.bmList.innerHTML = "";
  if(!items.length){
    const empty = document.createElement("div");
    empty.style.opacity=".75";
    empty.textContent = "No BM entries yet.";
    els.bmList.appendChild(empty);
    return;
  }

  items.forEach(b=>{
    const div = document.createElement("div");
    div.className = "bmItem";
    div.innerHTML = `
      <b>${escapeHtml(b.title||"BM")}</b>
      <div class="bmMeta">${fmt(b.ts)} ‚Ä¢ ${b.locked ? "üîí locked" : "üîì unlocked"} ‚Ä¢ media: ${(b.mediaIds||[]).length}</div>
    `;
    div.addEventListener("click", ()=>selectBM(b.id));
    els.bmList.appendChild(div);
  });
}

function selectBM(id){
  const b = state.bm.find(x=>x.id===id);
  if(!b) return;
  state.selectedBMId = id;

  els.bmTitle.textContent = b.title || "BM";
  els.bmMeta.textContent = `${fmt(b.ts)} ‚Ä¢ ${b.locked ? "locked" : "unlocked"} ‚Ä¢ media: ${(b.mediaIds||[]).length}`;
  els.bmText.textContent = b.text || "";

  els.bmDetail.style.display="block";
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, ch=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[ch]));
}

function cleanPromptFromBMText(text){
  // remove BM_MEDIA tags and trim
  return (text||"")
    .replace(/\[BM_MEDIA:[^\]]+\]/g, "")
    .replace(/\s+\n/g, "\n")
    .trim();
}

els.btnCopyPrompt.addEventListener("click", async ()=>{
  const id = state.selectedBMId;
  const b = state.bm.find(x=>x.id===id);
  if(!b){ showToast("Select BM first"); return; }

  const prompt = cleanPromptFromBMText(b.text);
  if(!prompt){
    showToast("No text prompt saved");
    return;
  }

  const ok = await robustCopyText(prompt);
  showToast(ok ? "Prompt copied ‚úÖ" : "Prompt placed in input (manual copy)");
});

els.btnExtractMedia.addEventListener("click", async ()=>{
  const id = state.selectedBMId;
  const b = state.bm.find(x=>x.id===id);
  if(!b){ showToast("Select BM first"); return; }
  const ids = b.mediaIds || [];
  if(!ids.length){ showToast("No media in this BM"); return; }

  for(const mid of ids){
    const rec = await getMedia(mid);
    if(!rec || !rec.blob){
      showToast("Media missing: " + mid);
      continue;
    }
    downloadBlob(rec.blob, rec.name || (mid + ".bin"));
  }
  showToast("Media extracted");
});

els.btnDeleteBM.addEventListener("click", async ()=>{
  const id = state.selectedBMId;
  const idx = state.bm.findIndex(x=>x.id===id);
  if(idx<0){ showToast("Select BM first"); return; }

  // delete BM entry (media kept; you can delete media too if you want)
  const removed = state.bm.splice(idx,1)[0];
  saveBM();
  state.selectedBMId=null;
  els.bmDetail.style.display="none";
  refreshBMList();
  showToast("BM deleted");

  logLine("sys", `Deleted BM ${removed?.id||""}`);
});

els.btnUnlock.addEventListener("click", ()=>{
  const b = state.bm.find(x=>x.id===state.selectedBMId);
  if(!b) return;
  b.locked = false;
  saveBM();
  selectBM(b.id);
  refreshBMList();
  showToast("Unlocked");
});

els.btnLock.addEventListener("click", ()=>{
  const b = state.bm.find(x=>x.id===state.selectedBMId);
  if(!b) return;
  b.locked = true;
  saveBM();
  selectBM(b.id);
  refreshBMList();
  showToast("Locked");
});

els.bmSearch.addEventListener("input", refreshBMList);

/* ===================== Pack Export/Import ===================== */
function blobToDataUrl(blob){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>resolve(fr.result);
    fr.onerror = ()=>reject(fr.error);
    fr.readAsDataURL(blob);
  });
}
function dataUrlToBlob(dataUrl){
  const parts = dataUrl.split(",");
  const meta = parts[0] || "";
  const b64 = parts[1] || "";
  const mime = (meta.match(/data:(.*?);base64/)||[])[1] || "application/octet-stream";
  const bin = atob(b64);
  const len = bin.length;
  const u8 = new Uint8Array(len);
  for(let i=0;i<len;i++) u8[i] = bin.charCodeAt(i);
  return new Blob([u8], { type:mime });
}

function downloadText(text, filename){
  const blob = new Blob([text], {type:"application/json;charset=utf-8"});
  downloadBlob(blob, filename);
}
function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
}

els.btnExportPack.addEventListener("click", async ()=>{
  try{
    showToast("Exporting‚Ä¶ (big media may take time)");
    const media = await getAllMedia();

    const mediaPacked = [];
    for(const m of media){
      if(!m?.blob) continue;
      const dataUrl = await blobToDataUrl(m.blob);
      mediaPacked.push({
        id: m.id, kind: m.kind, name: m.name, mime: m.mime, ts: m.ts,
        dataUrl
      });
    }

    const pack = {
      pack_version: "1.0",
      created_at: nowTs(),
      bm: state.bm,
      media: mediaPacked
    };

    downloadText(JSON.stringify(pack), `AURA_BM_PACK_${nowTs()}.auraxpack.json`);
    showToast("Pack exported ‚úÖ");
    logLine("sys", `Exported pack (bm=${state.bm.length}, media=${mediaPacked.length})`);
  }catch(e){
    console.warn(e);
    showToast("Export failed");
  }
});

els.importPackInput.addEventListener("change", async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  e.target.value = "";

  try{
    showToast("Importing pack‚Ä¶");
    const text = await f.text();
    const pack = JSON.parse(text);

    const packBM = Array.isArray(pack.bm) ? pack.bm : [];
    const packMedia = Array.isArray(pack.media) ? pack.media : [];

    // Merge BM by id (overwrite existing)
    const map = new Map(state.bm.map(x=>[x.id,x]));
    for(const b of packBM){
      if(b && b.id) map.set(b.id, b);
    }
    state.bm = Array.from(map.values()).sort((a,b)=> (b.ts||0)-(a.ts||0));
    saveBM();

    // Restore media to vault
    for(const m of packMedia){
      if(!m?.id || !m.dataUrl) continue;
      const blob = dataUrlToBlob(m.dataUrl);
      await putMedia({
        id:m.id, kind:m.kind||kindFromMime(m.mime), name:m.name||m.id,
        mime:m.mime||blob.type, ts:m.ts||nowTs(), blob
      });
    }

    refreshBMList();
    showToast("Pack imported ‚úÖ");
    logLine("sys", `Imported pack (bm=${packBM.length}, media=${packMedia.length})`);
    scheduleDream();
  }catch(err){
    console.warn(err);
    showToast("Import failed (file invalid?)");
  }
});

/* ===================== Dream Mode (uses BM images) ===================== */
function registerActivity(){
  state.lastActivity = nowTs();
  scheduleDream();
}
function scheduleDream(){
  if(state.dreamTimer){ clearTimeout(state.dreamTimer); state.dreamTimer = null; }
  if(!state.dreamEnabled) return;
  state.dreamTimer = setTimeout(()=>startDream(), state.dreamDelayMs);
}
function stopDream(){
  state.dream.running = false;
  els.dreamOverlay.style.display = "none";
  scheduleDream();
}
function initDreamCanvasSize(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const w = Math.floor(window.innerWidth * dpr);
  const h = Math.floor(window.innerHeight * dpr);
  els.dreamCanvas.width = w;
  els.dreamCanvas.height = h;
}
function rnd(a,b){ return a + Math.random()*(b-a); }

async function buildDreamImageCache(){
  // use images from vault
  const all = await getAllMedia();
  const images = all.filter(m=>m.kind==="image" && m.blob);
  const list = [];
  for(const m of images){
    const url = URL.createObjectURL(m.blob);
    const img = new Image();
    await new Promise(res=>{
      img.onload=()=>res(true);
      img.onerror=()=>res(true);
      img.src = url;
    });
    list.push({ id:m.id, name:m.name, url, img });
  }
  // cleanup old urls
  if(state.dream.imgs?.length){
    for(const it of state.dream.imgs){
      try{ URL.revokeObjectURL(it.url); }catch(e){}
    }
  }
  state.dream.imgs = list;
  state.dream.idx = 0;
}

function drawDreamFrame(ts){
  if(!state.dream.running) return;
  const c = els.dreamCanvas;
  const ctx = c.getContext("2d");
  const w = c.width, h = c.height;

  // bg
  const g = ctx.createLinearGradient(0,0,w,h);
  g.addColorStop(0,"rgba(2,6,23,1)");
  g.addColorStop(0.45,"rgba(2,24,60,1)");
  g.addColorStop(1,"rgba(2,6,23,1)");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,w,h);

  // image drift
  const imgs = state.dream.imgs || [];
  if(imgs.length){
    const it = imgs[state.dream.idx % imgs.length];
    const img = it.img;

    const t = (ts - state.dream.t0) * 0.001;
    const scale = 1.05 + 0.04*Math.sin(t*0.35);
    const ox = (Math.sin(t*0.18) * 0.06) * w;
    const oy = (Math.cos(t*0.14) * 0.06) * h;

    const iw = img.width || 1;
    const ih = img.height || 1;
    const ar = iw/ih;

    // cover fit
    let dw = w, dh = w/ar;
    if(dh < h){ dh = h; dw = h*ar; }
    dw *= scale; dh *= scale;

    const x = (w - dw)/2 + ox;
    const y = (h - dh)/2 + oy;

    ctx.globalAlpha = 0.28;
    ctx.drawImage(img, x, y, dw, dh);
    ctx.globalAlpha = 1;

    // gentle caption
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    ctx.font = `${Math.round(14*(window.devicePixelRatio||1))}px ui-sans-serif, system-ui`;
    ctx.textAlign = "center";
    ctx.fillText(it.name || "BM image", w/2, h*0.86);
  }else{
    ctx.fillStyle = "rgba(255,255,255,0.8)";
    ctx.font = `${Math.round(16*(window.devicePixelRatio||1))}px ui-sans-serif, system-ui`;
    ctx.textAlign = "center";
    ctx.fillText("No BM images yet ‚Äî add images to BM for Dream visuals.", w/2, h/2);
  }

  // sparkles
  const n = 110;
  for(let i=0;i<n;i++){
    const x = (i*97 + (ts*0.02)) % w;
    const y = (i*53 + (ts*0.015)) % h;
    const r = 0.5 + (i%3);
    ctx.fillStyle = `rgba(125,211,252,${0.08 + (i%5)*0.01})`;
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  }

  requestAnimationFrame(drawDreamFrame);
}

async function startDream(){
  if(state.dream.running) return;
  state.dream.running = true;
  state.dream.t0 = performance.now();
  initDreamCanvasSize();

  await buildDreamImageCache();
  els.dreamOverlay.style.display = "flex";

  els.dreamMeta.textContent = state.dream.imgs.length
    ? `Dreaming with ${state.dream.imgs.length} BM image(s)‚Ä¶`
    : `Add images to BM to enrich dreams.`;

  // cycle image every 12s
  setInterval(()=>{
    if(!state.dream.running) return;
    if(state.dream.imgs.length) state.dream.idx = (state.dream.idx + 1) % state.dream.imgs.length;
  }, 12000);

  requestAnimationFrame(drawDreamFrame);
}

els.dreamOverlay.addEventListener("pointerdown", (e)=>{ e.preventDefault(); stopDream(); }, {passive:false});
els.dreamOverlay.addEventListener("touchstart", (e)=>{ e.preventDefault(); stopDream(); }, {passive:false});
window.addEventListener("resize", ()=>{
  if(state.dream.running) initDreamCanvasSize();
});

/* ===================== Buttons ===================== */
els.sendBtn.addEventListener("click", handleSend);
els.userInput.addEventListener("keydown", (e)=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    handleSend();
  }
});
document.addEventListener("click", ()=>registerActivity(), {capture:true});
document.addEventListener("keydown", ()=>registerActivity(), {capture:true});
document.addEventListener("touchstart", ()=>registerActivity(), {capture:true});

els.btnBMRecall.addEventListener("click", openBM);
els.bmClose.addEventListener("click", closeBM);

els.btnDreamToggle.addEventListener("click", ()=>{
  state.dreamEnabled = !state.dreamEnabled;
  els.btnDreamToggle.textContent = state.dreamEnabled ? "üåô Dream: On" : "üåô Dream: Off";
  saveCfg();
  showToast("Dream " + (state.dreamEnabled ? "enabled" : "disabled"));
  scheduleDream();
});

els.btnTestDream.addEventListener("click", ()=>{
  startDream().catch(()=>showToast("Dream failed"));
});

function init(){
  loadCfg();
  els.btnDreamToggle.textContent = state.dreamEnabled ? "üåô Dream: On" : "üåô Dream: Off";
  loadBM();
  recomputeTMMetric();
  recomputeE0();
  scheduleDream();
  logLine("sys","AURA-X Œ© ready. BM Pack enabled (Export/Import).");
}

init();
</script>
</body>
</html>