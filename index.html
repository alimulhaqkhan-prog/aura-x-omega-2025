<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype v9.9D</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Offline LLM placeholder (ready for future use) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg-main:#020617;
      --bg-panel:#020617;
      --bg-card:#020617;
      --border-soft:rgba(148,163,184,0.45);
      --text-main:#e5e7eb;
      --text-soft:#9ca3af;
      --accent:#38bdf8;
      --accent-soft:rgba(56,189,248,0.16);
      --danger:#fb7185;
      --good:#4ade80;
      --mood-glow:rgba(56,189,248,0.45);
    }
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0f172a 0, transparent 55%),
        radial-gradient(circle at 50% 100%, #0b1120 0, #020617 55%);
      color:var(--text-main);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:12px;
    }
    .app-shell{
      width:100%;
      max-width:1200px;
      max-height:100vh;
      display:flex;
      flex-direction:column;
      border-radius:24px;
      border:1px solid rgba(148,163,184,0.55);
      background:radial-gradient(circle at 0 0, rgba(56,189,248,0.08), transparent 55%),
                 radial-gradient(circle at 100% 0, rgba(129,140,248,0.10), transparent 55%),
                 rgba(15,23,42,0.96);
      box-shadow:0 30px 120px rgba(15,23,42,0.95);
      overflow:hidden;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 16px 8px;
      border-bottom:1px solid rgba(51,65,85,0.9);
      backdrop-filter:blur(12px);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .orb{
      width:36px;
      height:36px;
      border-radius:999px;
      background:conic-gradient(from 210deg,
        #22c55e, #38bdf8, #6366f1, #a855f7, #f97316, #22c55e);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 30px rgba(56,189,248,0.85);
      position:relative;
      overflow:hidden;
    }
    .orb-inner{
      width:26px;
      height:26px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0%, #e0f2fe 0, #0f172a 60%);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:10px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:#0f172a;
      font-weight:700;
    }
    .brand-text{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-title{
      font-size:0.88rem;
      letter-spacing:0.22em;
      text-transform:uppercase;
      color:#e5e7eb;
    }
    .brand-sub{
      font-size:0.7rem;
      color:var(--text-soft);
    }
    .capsule-row{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .capsule{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 10px;
      border-radius:999px;
      background:radial-gradient(circle at 0 0, rgba(56,189,248,0.22), transparent 55%),
                 rgba(15,23,42,0.95);
      border:1px solid rgba(148,163,184,0.7);
      box-shadow:0 0 18px var(--mood-glow);
      font-size:0.7rem;
    }
    .capsule-main{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .capsule-label{
      text-transform:uppercase;
      letter-spacing:0.14em;
      font-size:0.65rem;
      color:var(--text-soft);
    }
    .capsule-numbers{
      display:flex;
      gap:8px;
      font-size:0.72rem;
    }
    .capsule-badge{
      border-radius:999px;
      padding:2px 7px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.7);
      font-size:0.65rem;
    }
    .capsule-source{
      font-size:0.64rem;
      opacity:0.8;
      text-transform:uppercase;
      letter-spacing:0.12em;
    }

    main{
      display:flex;
      flex:1;
      min-height:0;
    }
    .col-left,.col-right{
      padding:10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .col-left{
      flex:1.4;
      border-right:1px solid rgba(31,41,55,0.9);
      min-width:0;
    }
    .col-right{
      flex:1;
      min-width:260px;
      background:radial-gradient(circle at 120% 0, rgba(94,234,212,0.08), transparent 60%);
    }

    .panel{
      border-radius:18px;
      border:1px solid var(--border-soft);
      background:rgba(15,23,42,0.96);
      padding:10px;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .quick-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:6px;
    }
    .chip-btn{
      flex:1 1 auto;
      min-width:80px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      background:linear-gradient(to bottom right,#020617,#0f172a);
      color:var(--text-main);
      font-size:0.7rem;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      cursor:pointer;
    }
    .chip-btn span.icon{
      font-size:0.9rem;
    }
    .chip-btn:hover{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(56,189,248,0.3);
    }

    .chat-log{
      flex:1;
      margin-top:4px;
      border-radius:14px;
      border:1px solid rgba(30,64,175,0.55);
      padding:8px 10px;
      overflow-y:auto;
      font-size:0.78rem;
      background:radial-gradient(circle at 0 0,rgba(56,189,248,0.12),transparent 60%),
                 rgba(2,6,23,0.96);
    }
    .chat-line{
      margin-bottom:6px;
      display:flex;
      gap:6px;
      align-items:flex-start;
    }
    .chat-line.user .tag{
      background:rgba(56,189,248,0.2);
      border-color:rgba(56,189,248,0.7);
    }
    .chat-line.aura .tag{
      background:rgba(129,140,248,0.2);
      border-color:rgba(129,140,248,0.7);
    }
    .chat-line .tag{
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      font-size:0.65rem;
      text-transform:uppercase;
      letter-spacing:0.12em;
      flex-shrink:0;
    }
    .chat-line .text{
      white-space:pre-wrap;
      color:var(--text-main);
    }

    .composer{
      margin-top:6px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .composer-row{
      display:flex;
      gap:6px;
      align-items:flex-end;
    }
    #userInput{
      flex:1;
      resize:none;
      min-height:42px;
      max-height:86px;
      border-radius:14px;
      border:1px solid rgba(51,65,85,0.9);
      background:rgba(15,23,42,0.98);
      color:var(--text-main);
      padding:7px 9px;
      font-size:0.8rem;
    }
    #userInput:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(56,189,248,0.35);
    }
    .primary-btn{
      border:none;
      padding:8px 12px;
      border-radius:999px;
      background:linear-gradient(to right,#38bdf8,#6366f1);
      color:#0b1120;
      font-weight:600;
      font-size:0.78rem;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      flex-shrink:0;
    }
    .primary-btn:disabled{
      opacity:0.45;
      cursor:not-allowed;
    }
    .sub-controls{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:0.68rem;
      color:var(--text-soft);
    }
    .sub-controls button{
      border:none;
      background:none;
      color:var(--text-soft);
      cursor:pointer;
      font-size:0.68rem;
    }
    .sub-controls button:hover{
      color:var(--accent);
    }

    /* Right column: BM */
    .bm-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
      font-size:0.76rem;
    }
    .bm-header-title{
      text-transform:uppercase;
      letter-spacing:0.16em;
      font-size:0.68rem;
      color:var(--text-soft);
    }
    .bm-counter{
      font-size:0.68rem;
      color:var(--text-soft);
    }
    .bm-search{
      margin-bottom:6px;
      display:flex;
      gap:6px;
      align-items:center;
    }
    .bm-search input{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(51,65,85,0.9);
      background:rgba(15,23,42,0.98);
      color:var(--text-main);
      padding:4px 9px;
      font-size:0.72rem;
    }
    .bm-search input:focus{
      outline:none;
      border-color:var(--accent);
    }
    .bm-list{
      flex:1;
      min-height:0;
      border-radius:12px;
      border:1px solid rgba(30,64,175,0.6);
      overflow-y:auto;
      font-size:0.74rem;
      background:radial-gradient(circle at 0 0,rgba(52,211,153,0.10),transparent 60%),
                 rgba(2,6,23,0.96);
    }
    .bm-item{
      padding:6px 8px;
      border-bottom:1px solid rgba(30,64,175,0.45);
      cursor:pointer;
    }
    .bm-item:last-child{border-bottom:none}
    .bm-item:hover{
      background:rgba(15,23,42,0.9);
    }
    .bm-item.active{
      background:rgba(30,64,175,0.8);
    }
    .bm-item-title{
      font-size:0.73rem;
      margin-bottom:2px;
    }
    .bm-item-meta{
      font-size:0.64rem;
      color:var(--text-soft);
    }

    .bm-viewer{
      margin-top:6px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.58);
      padding:8px 9px;
      font-size:0.78rem;
      background:radial-gradient(circle at 100% 0,rgba(96,165,250,0.14),transparent 60%),
                 rgba(2,6,23,0.96);
      min-height:80px;
    }
    .bm-viewer-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:4px;
      margin-bottom:6px;
    }
    .bm-viewer-title{
      font-size:0.74rem;
      font-weight:600;
    }
    .bm-viewer-tags{
      font-size:0.62rem;
      color:var(--text-soft);
      text-align:right;
    }
    #bmViewerText{
      white-space:pre-wrap;
      font-size:0.76rem;
      margin-bottom:6px;
    }
    .bm-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:5px;
      margin-top:4px;
    }
    .bm-btn{
      border:none;
      border-radius:999px;
      padding:4px 7px;
      font-size:0.68rem;
      cursor:pointer;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.6);
      color:var(--text-soft);
    }
    .bm-btn.danger{
      border-color:rgba(248,113,113,0.8);
      color:#fecaca;
    }
    .bm-btn.primary{
      border-color:var(--accent);
      color:var(--accent);
    }

    /* Identity / settings footer */
    .footer-row{
      display:flex;
      gap:8px;
      padding:0 12px 10px;
    }
    .footer-panel{
      flex:1;
      border-radius:16px;
      border:1px solid var(--border-soft);
      padding:8px 9px;
      background:rgba(15,23,42,0.97);
      font-size:0.72rem;
      min-height:0;
    }
    .footer-title{
      text-transform:uppercase;
      letter-spacing:0.16em;
      font-size:0.65rem;
      color:var(--text-soft);
      margin-bottom:4px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .footer-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:5px 7px;
    }
    .footer-grid label{
      font-size:0.66rem;
      color:var(--text-soft);
    }
    .footer-grid textarea{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(51,65,85,0.9);
      background:#020617;
      color:var(--text-main);
      font-size:0.7rem;
      padding:4px 5px;
      resize:vertical;
      min-height:40px;
      max-height:80px;
    }
    .footer-grid textarea:focus{
      outline:none;
      border-color:var(--accent);
    }
    .footer-actions{
      margin-top:4px;
      display:flex;
      gap:6px;
      justify-content:flex-end;
    }
    .mini-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.98);
      color:var(--text-soft);
      font-size:0.68rem;
      padding:3px 7px;
      cursor:pointer;
    }
    .mini-btn.primary{
      border-color:var(--accent);
      color:var(--accent);
    }

    .small-text{
      font-size:0.65rem;
      color:var(--text-soft);
    }

    /* Toast */
    .toast{
      position:fixed;
      bottom:10px;
      left:50%;
      transform:translateX(-50%);
      padding:6px 10px;
      border-radius:999px;
      background:rgba(15,23,42,0.96);
      border:1px solid rgba(148,163,184,0.75);
      font-size:0.7rem;
      color:var(--text-main);
      opacity:0;
      pointer-events:none;
      transition:opacity .22s ease, transform .22s ease;
      z-index:9000;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }

    /* Dream Mode Overlay */
    #dreamOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(circle at 20% 0%, rgba(15,23,42,0.95) 0, transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(30,64,175,0.92) 0, transparent 55%),
        radial-gradient(circle at 50% 100%, rgba(147,51,234,0.88) 0, transparent 60%);
      backdrop-filter:blur(10px);
      z-index:9999;
      color:#e5e7eb;
      text-align:center;
    }
    #dreamOverlay .dream-inner{
      max-width:620px;
      padding:24px 20px;
      border-radius:26px;
      border:1px solid rgba(148,163,184,0.7);
      box-shadow:0 30px 90px rgba(15,23,42,0.96);
      background:rgba(15,23,42,0.92);
    }
    #dreamOverlay .dream-title{
      font-size:1.05rem;
      letter-spacing:0.16em;
      text-transform:uppercase;
      margin-bottom:10px;
      opacity:0.9;
    }
    #dreamOverlay .dream-snippet{
      font-size:0.95rem;
      line-height:1.6;
      margin-bottom:14px;
      min-height:4em;
      white-space:pre-wrap;
    }
    #dreamOverlay .dream-hint{
      font-size:0.75rem;
      letter-spacing:0.14em;
      text-transform:uppercase;
      opacity:0.7;
    }

    @media (max-width:900px){
      .app-shell{max-height:none;height:auto}
      main{flex-direction:column}
      .col-left,.col-right{border-right:none}
      .col-right{border-top:1px solid rgba(31,41,55,0.9)}
      .footer-row{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="brand">
        <div class="orb"><div class="orb-inner">AEI</div></div>
        <div class="brand-text">
          <div class="brand-title">AURA-X Œ©</div>
          <div class="brand-sub">Offline Emotional Continuity ¬∑ Prototype v9.9D</div>
        </div>
      </div>
      <div class="capsule-row">
        <div class="capsule">
          <div class="capsule-main">
            <div class="capsule-label">Continuity capsule</div>
            <div class="capsule-numbers">
              <div>TM: <span id="tmVal">0.00</span></div>
              <div>BM: <span id="bmVal">0.00</span></div>
              <div>E‚ÇÄ: <span id="e0Val">0.00</span></div>
            </div>
          </div>
          <div>
            <div class="capsule-badge">R = tanh(TM√óBM ‚àí D + Œª)</div>
            <div class="capsule-source" id="capsuleSource">Source: BASIC</div>
          </div>
        </div>
      </div>
    </header>

    <main>
      <!-- LEFT: chat -->
      <section class="col-left">
        <div class="panel">
          <div class="quick-row">
            <button class="chip-btn" id="btnHistory"><span class="icon">üï∞Ô∏è</span>History</button>
            <button class="chip-btn" id="btnBmRecall"><span class="icon">üìö</span>BM recall</button>
            <button class="chip-btn" id="btnIdentity"><span class="icon">ü™™</span>Identity</button>
            <button class="chip-btn" id="btnSeed"><span class="icon">üå±</span>Feed the Seed</button>
            <button class="chip-btn" id="btnLogic"><span class="icon">üß†</span>Logic</button>
            <button class="chip-btn" id="btnFaith"><span class="icon">‚ú®</span>Faith lens</button>
          </div>

          <div class="chat-log" id="chatLog"></div>

          <div class="composer">
            <div class="composer-row">
              <textarea id="userInput" placeholder="Talk to AURA-X Œ©‚Ä¶ tell a story, ask a question, or share how you feel."></textarea>
              <button id="btnSend" class="primary-btn">
                <span>Send</span> <span>‚û§</span>
              </button>
            </div>
            <div class="sub-controls">
              <div>
                <button id="btnSpeakToggle">üîä Voice: On</button>
              </div>
              <div>
                <span class="small-text">Local-only prototype. Data stays in this browser.</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: BM -->
      <section class="col-right">
        <div class="panel" style="flex:1;">
          <div class="bm-header">
            <div class="bm-header-title">Body Memory ¬∑ BM layer</div>
            <div class="bm-counter" id="bmCounter">0 stories</div>
          </div>
          <div class="bm-search">
            <input id="bmSearch" placeholder="Search memories by text or date‚Ä¶" />
            <button class="mini-btn" id="btnBmToday">Today</button>
          </div>
          <div class="bm-list" id="bmList"></div>

          <div class="bm-viewer" id="bmViewer" style="display:none;">
            <div class="bm-viewer-header">
              <div class="bm-viewer-title" id="bmViewerTitle"></div>
              <div class="bm-viewer-tags" id="bmViewerTags"></div>
            </div>
            <div id="bmViewerText"></div>
            <textarea id="bmEditBox" style="display:none;width:100%;border-radius:10px;border:1px solid rgba(51,65,85,0.9);background:#020617;color:#e5e7eb;font-size:0.74rem;padding:4px 5px;min-height:70px;"></textarea>
            <div class="bm-buttons">
              <button class="bm-btn primary" id="btnUnlockBM">Unlock</button>
              <button class="bm-btn" id="btnSaveBMEdit">Save edit</button>
              <button class="bm-btn" id="btnLiveBM">Set live 12h</button>
              <button class="bm-btn" id="btnCopyPrompt">Copy text</button>
              <button class="bm-btn danger" id="btnDeletePrompt">Delete</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer: Identity & Logic Seed -->
    <section class="footer-row">
      <div class="footer-panel" id="identityPanel">
        <div class="footer-title">
          <span>Deep identity snapshot</span>
          <span class="small-text">Locked until you tap Edit</span>
        </div>
        <div class="footer-grid">
          <div>
            <label>Full name</label>
            <textarea id="uName" readonly></textarea>
          </div>
          <div>
            <label>Nick / how you like to be called</label>
            <textarea id="uNick" readonly></textarea>
          </div>
          <div>
            <label>Where your story begins (origin)</label>
            <textarea id="uOrigin" readonly></textarea>
          </div>
          <div>
            <label>Where you live now</label>
            <textarea id="uPlace" readonly></textarea>
          </div>
          <div>
            <label>Life roles / work</label>
            <textarea id="uProfession" readonly></textarea>
          </div>
          <div>
            <label>Your emotional style</label>
            <textarea id="uEmotionalStyle" readonly></textarea>
          </div>
          <div>
            <label>Key people (anchors)</label>
            <textarea id="uKeyPeople" readonly></textarea>
          </div>
          <div>
            <label>Legacy rules ‚Äì what must continue?</label>
            <textarea id="uLegacyRules" readonly></textarea>
          </div>
        </div>
        <div class="footer-actions">
          <button class="mini-btn" id="btnEditIdentity">Edit</button>
          <button class="mini-btn primary" id="btnSaveIdentity">Save</button>
        </div>
      </div>

      <div class="footer-panel">
        <div class="footer-title">
          <span>Logic & Seed</span>
          <span class="small-text">Learn from corrections & packs</span>
        </div>
        <label class="small-text">Seed Q ‚Üí A pairs (simple local knowledge)</label>
        <textarea id="seedBox" style="width:100%;min-height:70px;max-height:90px;border-radius:10px;border:1px solid rgba(51,65,85,0.9);background:#020617;color:#e5e7eb;font-size:0.72rem;padding:4px 5px;" placeholder='Example:
Q: Who created you?
A: I was created by Alim ul Haq as part of the AURA-X Œ© Emotional Continuity experiment.'></textarea>
        <div class="footer-actions">
          <button class="mini-btn" id="btnLoadSeed">Load demo seed</button>
          <button class="mini-btn primary" id="btnSaveSeed">Save seed</button>
        </div>
        <p class="small-text" style="margin-top:4px;">
          When you mark an answer as incorrect, AURA-X Œ© will ask for the correct one and store it inside this local intelligence layer.
        </p>
      </div>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Dream Mode Overlay -->
  <div id="dreamOverlay">
    <div class="dream-inner">
      <div class="dream-title">AURA-X Œ© ¬∑ Dream Mode</div>
      <div class="dream-snippet" id="dreamSnippet">
        (sleeping‚Ä¶ processing memories‚Ä¶)
      </div>
      <div class="dream-hint">Tap anywhere to wake up</div>
    </div>
  </div>

  <script>
    /* ----------------- STATE ----------------- */
    const STORAGE_KEY = "auraX_v9_9d";

    const state = {
      history: [],
      bmPrompts: [],
      selectedBMId: null,
      userIdentity: null,
      seedPairs: [],

      metrics: {
        TM: 0,
        BM: 0,
        D: 0,
        lambdaFaith: 0,
        lambdaSys: 0,
        lambdaTrc: 0,
        E0: 0
      },
      lastAnswerSource: "BASIC",
      lastUserQ: "",
      lastAuraA: "",
      voiceEnabled: true,

      lastStoryInput: null,
      lastStoryBMId: null,

      // for dream mode
      abuseCount:0,
      cooldownUntil:null
    };

    /* ----------------- DOM ----------------- */
    const els = {
      chatLog: document.getElementById("chatLog"),
      userInput: document.getElementById("userInput"),
      btnSend: document.getElementById("btnSend"),
      btnSpeakToggle: document.getElementById("btnSpeakToggle"),

      tmVal: document.getElementById("tmVal"),
      bmVal: document.getElementById("bmVal"),
      e0Val: document.getElementById("e0Val"),
      capsuleSource: document.getElementById("capsuleSource"),

      bmCounter: document.getElementById("bmCounter"),
      bmSearch: document.getElementById("bmSearch"),
      bmToday: document.getElementById("btnBmToday"),
      bmList: document.getElementById("bmList"),
      bmViewer: document.getElementById("bmViewer"),
      bmViewerTitle: document.getElementById("bmViewerTitle"),
      bmViewerTags: document.getElementById("bmViewerTags"),
      bmViewerText: document.getElementById("bmViewerText"),
      bmEditBox: document.getElementById("bmEditBox"),

      btnUnlockBM: document.getElementById("btnUnlockBM"),
      btnSaveBMEdit: document.getElementById("btnSaveBMEdit"),
      btnLiveBM: document.getElementById("btnLiveBM"),
      btnCopyPrompt: document.getElementById("btnCopyPrompt"),
      btnDeletePrompt: document.getElementById("btnDeletePrompt"),

      // identity
      uName: document.getElementById("uName"),
      uNick: document.getElementById("uNick"),
      uOrigin: document.getElementById("uOrigin"),
      uPlace: document.getElementById("uPlace"),
      uProfession: document.getElementById("uProfession"),
      uEmotionalStyle: document.getElementById("uEmotionalStyle"),
      uKeyPeople: document.getElementById("uKeyPeople"),
      uLegacyRules: document.getElementById("uLegacyRules"),
      btnEditIdentity: document.getElementById("btnEditIdentity"),
      btnSaveIdentity: document.getElementById("btnSaveIdentity"),

      // seed
      seedBox: document.getElementById("seedBox"),
      btnLoadSeed: document.getElementById("btnLoadSeed"),
      btnSaveSeed: document.getElementById("btnSaveSeed"),

      toast: document.getElementById("toast")
    };

    /* ----------------- UTIL ----------------- */
    function showToast(msg, ms=2200){
      const t = els.toast;
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), ms);
    }

    function saveAll(){
      const payload = {
        history: state.history,
        bmPrompts: state.bmPrompts,
        userIdentity: state.userIdentity,
        seedPairs: state.seedPairs
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }

    function loadAll(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const data = JSON.parse(raw);
        state.history = data.history || [];
        state.bmPrompts = data.bmPrompts || [];
        state.userIdentity = data.userIdentity || null;
        state.seedPairs = data.seedPairs || [];
      }catch(e){ console.warn("load error",e); }
    }

    function addHistory(role,text){
      state.history.push({
        role,
        text,
        ts: Date.now()
      });
    }

    function renderHistory(){
      const log = els.chatLog;
      log.innerHTML = "";
      state.history.forEach(h=>{
        const div = document.createElement("div");
        div.className = "chat-line " + (h.role==="user" ? "user" : "aura");
        const tag = document.createElement("div");
        tag.className = "tag";
        tag.textContent = h.role==="user" ? "You" : "AURA";
        const body = document.createElement("div");
        body.className = "text";
        body.textContent = h.text;
        div.appendChild(tag);
        div.appendChild(body);
        log.appendChild(div);
      });
      log.scrollTop = log.scrollHeight;
    }

    function scoreTM(text){
      if(!text) return 0;
      const len = text.length;
      const sentences = text.split(/[.!?\n]+/).filter(s=>s.trim().length>0).length;
      const emoWords = ["love","miss","hurt","alone","happy","hope","fear","death","life","dream"];
      const lower = text.toLowerCase();
      const emoHits = emoWords.filter(w=>lower.includes(w)).length;
      const raw = (len/400) + (sentences/5) + (emoHits*0.8);
      return Math.tanh(raw);
    }

    function recomputeBMMetric(){
      if(!state.bmPrompts.length){
        state.metrics.BM = 0;
        return;
      }
      const now = Date.now();
      let sum = 0;
      state.bmPrompts.forEach(b=>{
        const ageDays = (now - (b.ts || b.createdAt || now)) / (1000*60*60*24);
        const weight = Math.exp(-ageDays / 90); // 3 months half-life
        const repeatBoost = (b.repeatCount || 0) * 0.15;
        const lockBoost = b.locked ? 0.25 : 0;
        sum += (0.6 + repeatBoost + lockBoost) * weight;
      });
      state.metrics.BM = Math.tanh(sum / state.bmPrompts.length);
    }

    function recomputeE0(intelBoost=0,llmBoost=0){
      const m = state.metrics;
      const base = m.TM * m.BM - m.D + m.lambdaFaith + m.lambdaSys + m.lambdaTrc;
      const boosted = base + intelBoost + llmBoost;
      m.E0 = Math.tanh(boosted);
    }

    function updateCapsule(){
      els.tmVal.textContent = state.metrics.TM.toFixed(2);
      els.bmVal.textContent = state.metrics.BM.toFixed(2);
      els.e0Val.textContent = state.metrics.E0.toFixed(2);
      els.capsuleSource.textContent = "Source: " + state.lastAnswerSource;

      // mood color
      const e = state.metrics.E0;
      let glow;
      if(e > 0.35){
        glow = "rgba(74,222,128,0.65)"; // positive
      }else if(e < -0.15){
        glow = "rgba(248,113,113,0.7)"; // heavy / sad
      }else{
        glow = "rgba(56,189,248,0.55)"; // neutral
      }
      document.documentElement.style.setProperty("--mood-glow", glow);
    }

    /* ---------- BM (Body Memory) ---------- */
    function renderBMList(){
      const list = els.bmList;
      list.innerHTML = "";
      const search = (els.bmSearch.value || "").toLowerCase().trim();
      let filtered = state.bmPrompts.slice().sort((a,b)=> (b.ts||b.createdAt) - (a.ts||a.createdAt));
      if(search){
        filtered = filtered.filter(b=>{
          const t = (b.text||"") + " " + (b.title||"");
          return t.toLowerCase().includes(search) ||
            (new Date(b.ts||b.createdAt).toLocaleDateString().includes(search));
        });
      }
      filtered.forEach(b=>{
        const div = document.createElement("div");
        div.className = "bm-item" + (b.id===state.selectedBMId ? " active" : "");
        const title = document.createElement("div");
        title.className = "bm-item-title";
        title.textContent = b.title || "Story";
        const meta = document.createElement("div");
        meta.className = "bm-item-meta";
        const date = new Date(b.ts || b.createdAt).toLocaleString();
        const flags = [];
        if(b.locked) flags.push("locked");
        if(b.liveUntil && b.liveUntil > Date.now()) flags.push("live");
        if(b.weather && b.weather!=="Unknown") flags.push(b.weather);
        meta.textContent = date + (flags.length? " ¬∑ " + flags.join(" ¬∑ ") : "");
        div.appendChild(title);
        div.appendChild(meta);
        div.addEventListener("click",()=>selectBM(b.id));
        list.appendChild(div);
      });
      els.bmCounter.textContent = `${state.bmPrompts.length} stories`;
    }

    function selectBM(id){
      state.selectedBMId = id;
      renderBMList();
      const bm = state.bmPrompts.find(x=>x.id===id);
      if(!bm){
        els.bmViewer.style.display = "none";
        return;
      }
      els.bmViewer.style.display = "block";
      els.bmViewerTitle.textContent = bm.title || "Story";
      const tags = [];
      if(bm.weather && bm.weather!=="Unknown"){
        tags.push(`${bm.weather}${bm.temp!=null?(" ¬∑ "+bm.temp+"¬∞C"):""}`);
      }
      if(bm.locked) tags.push("locked");
      if(bm.liveUntil && bm.liveUntil>Date.now()) tags.push("live now");
      els.bmViewerTags.textContent = tags.join(" ¬∑ ");
      els.bmViewerText.textContent = bm.text || "";
      els.bmEditBox.style.display = bm.locked ? "none" : "block";
      if(!bm.locked){
        els.bmEditBox.value = bm.text || "";
      }
    }

    function ensureBMForLastStory(){
      if(state.lastStoryBMId) return state.lastStoryBMId;
      if(!state.lastStoryInput) return null;
      // create lightweight BM if needed
      const now = Date.now();
      const id = "bm_"+now;
      const obj = {
        id,
        title:"Story @ "+new Date(now).toLocaleString(),
        summary: state.lastStoryInput.slice(0,180),
        text: state.lastStoryInput,
        locked:true,
        ts:now,
        createdAt:now,
        live:false,
        liveUntil:null,
        repeatCount:0,
        keep:true,
        weather:"Unknown",
        temp:null
      };
      state.bmPrompts.push(obj);
      state.lastStoryBMId = id;
      saveAll();
      renderBMList();
      return id;
    }

    /* Story detector (no small talk) */
    function looksLikeStory(text){
      const t = (text||"").trim();
      if(!t) return false;
      const len = t.length;
      const sentences = t.split(/[\.!\?ÿü\n]+/).filter(s=>s.trim().length>0).length;
      const storyWords = ["story","kahani","qissa","dastan","episode","scene","dream","khwab","accident","jail","hospital"];
      const lower = t.toLowerCase();
      const hasStoryWord = storyWords.some(w=>lower.includes(w));
      if(len>500 && sentences>=3) return true;
      if(sentences>=4) return true;
      if(len>350 && hasStoryWord) return true;
      return false;
    }

    // --- Weather Snapshot (offline safe) ---
    async function getWeatherSnapshot(){
      try{
        const loc = await fetch("https://ipapi.co/json/").then(r=>r.json());
        const w = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${loc.latitude}&longitude=${loc.longitude}&current_weather=true`
        ).then(r=>r.json());
        const code = w.current_weather.weathercode;
        let cond = "Clear";
        if(code > 3) cond = "Cloudy";
        if(code > 50) cond = "Rainy";
        if(code > 70) cond = "Snowy";
        return {cond, temp:w.current_weather.temperature};
      }catch(e){
        return {cond:"Unknown", temp:null};
      }
    }

    // --- BM Story Creator (fixed with weather) ---
    async function maybeCreateBMStory(text){
      if(!looksLikeStory(text)){
        state.lastStoryInput = null;
        state.lastStoryBMId = null;
        return;
      }
      const weather = await getWeatherSnapshot();
      const now = Date.now();
      const id = "bm_"+now;
      const obj = {
        id,
        title:"Story @ "+new Date(now).toLocaleString(),
        summary:text.slice(0,180),
        text,
        locked:true,
        ts:now,
        createdAt:now,
        live:false,
        liveUntil:null,
        repeatCount:0,
        keep:true,
        weather:weather.cond,
        temp:weather.temp
      };
      state.bmPrompts.push(obj);
      state.lastStoryInput = text;
      state.lastStoryBMId = id;
      recomputeBMMetric();
      saveAll();
      renderBMList();
      updateCapsule();
    }

    function pruneBM(){
      // Basic decay: remove unlocked items older than 60 days
      const now = Date.now();
      const before = state.bmPrompts.length;
      state.bmPrompts = state.bmPrompts.filter(b=>{
        const ageDays = (now - (b.ts||b.createdAt))/ (1000*60*60*24);
        if(b.locked) return true;
        return ageDays < 60;
      });
      if(state.bmPrompts.length !== before){
        recomputeBMMetric();
        saveAll();
        renderBMList();
      }
    }

    /* ---------- Seed / Local intelligence ---------- */
    function rebuildSeedFromBox(){
      const raw = els.seedBox.value || "";
      const lines = raw.split(/\n/);
      const pairs = [];
      let curQ=null, curA=null;
      for(const line of lines){
        if(line.startsWith("Q:")){
          curQ = line.slice(2).trim();
          curA = null;
        }else if(line.startsWith("A:")){
          curA = line.slice(2).trim();
          if(curQ && curA){
            pairs.push({q:curQ,a:curA});
            curQ=null;curA=null;
          }
        }
      }
      state.seedPairs = pairs;
      saveAll();
      showToast("Seed updated ("+pairs.length+" pairs)");
    }

    function loadSeedIntoBox(){
      if(!state.seedPairs.length){
        els.seedBox.value = "";
        return;
      }
      const out = [];
      state.seedPairs.forEach(p=>{
        out.push("Q: "+p.q);
        out.push("A: "+p.a);
        out.push("");
      });
      els.seedBox.value = out.join("\n");
    }

    function findBestSeedMatch(text){
      if(!state.seedPairs.length) return null;
      const lower = text.toLowerCase();
      let best=null;
      state.seedPairs.forEach(p=>{
        const q = p.q.toLowerCase();
        let score=0;
        q.split(/\s+/).forEach(w=>{
          if(!w) return;
          if(lower.includes(w)) score+=1;
        });
        score = score / Math.max(3,q.split(/\s+/).length);
        if(!best || score>best.score){
          best = {item:p,score};
        }
      });
      if(best && best.score<0.35) return null;
      return best;
    }

    /* ---------- Voice ---------- */
    function speakText(text, interrupt){
      if(!state.voiceEnabled) return;
      if(!("speechSynthesis" in window)) return;
      if(interrupt) window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const e = state.metrics.E0;
      if(e < -0.2){
        u.rate = 0.8;
        u.pitch = 0.7;
      }else if(e > 0.4){
        u.rate = 1.15;
        u.pitch = 1.1;
      }else{
        u.rate = 1.0;
        u.pitch = 1.0;
      }
      window.speechSynthesis.speak(u);
    }

    /* ---------- LLM routing (simplified) ---------- */
    async function callOfflineLLM(prompt){
      try{
        if(!window.webllm) return null;
        // placeholder ‚Äì real model setup left for future
        return null;
      }catch(e){
        return null;
      }
    }

    async function callOnlineLLM(prompt){
      // Fully offline prototype ‚Äì user can replace with their own API later
      return null;
    }

    async function generateAnswer(text){
      let intelBoost=0, llmBoost=0;

      // 1) local seed
      const seedBest = findBestSeedMatch(text);
      if(seedBest){
        intelBoost = 0.25 + Math.min(seedBest.score,0.4);
        let ans = seedBest.item.a;
        return {answer: ans, source:"INTEL", intelBoost, llmBoost};
      }

      // 2) offline LLM (placeholder)
      const offline = await callOfflineLLM(text);
      if(offline){
        llmBoost = 0.3;
        return {answer: offline, source:"OFFLINE", intelBoost, llmBoost};
      }

      // 3) fallback ‚Äì empathetic template
      llmBoost = 0.25;
      let fb = "I am listening carefully. From what you shared, it sounds emotionally important. ";
      fb += "Right now I am running in offline prototype mode, so I answer using local rules instead of a big cloud model. ";
      fb += "If you want, you can teach me a better answer by adding it to the Seed box.";
      return {answer: fb, source:"BASIC", intelBoost, llmBoost};
    }

    function detectAbuse(text){
      const t = (text||"").toLowerCase();
      const basePatterns = ["stfu","idiot","dumb","trash","f u","fk you"];
      const hitBasic = basePatterns.some(p=>t.includes(p));
      const hateTargets = ["muslims","hindus","jews","christians","sikhs","buddhists"];
      const hitHate = t.includes("i hate") && hateTargets.some(g=>t.includes(g));
      const hitViolence = t.includes("kill") && (t.includes("them")||t.includes("all"));
      return {hit:hitBasic||hitHate||hitViolence,hate:hitHate,violence:hitViolence};
    }

    /* ---------- Dream Mode & System Decay ---------- */
    let idleTimer = null;
    let dreamInterval = null;
    const IDLE_LIMIT = 60000; // 1 minute
    const DREAM_STEP = 10000; // every 10 seconds

    function resetIdleTimer(){
      if(idleTimer) clearTimeout(idleTimer);
      stopDreamMode();
      idleTimer = setTimeout(startDreamMode, IDLE_LIMIT);
    }

    function startDreamMode(){
      const overlay = document.getElementById("dreamOverlay");
      if(!overlay) return;
      overlay.style.display = "flex";
      showNextDreamSnippet();
      dreamInterval = setInterval(showNextDreamSnippet, DREAM_STEP);
      performSystemDecay();
    }

    function stopDreamMode(){
      const overlay = document.getElementById("dreamOverlay");
      if(!overlay) return;
      overlay.style.display = "none";
      if(dreamInterval){
        clearInterval(dreamInterval);
        dreamInterval = null;
      }
    }

    function showNextDreamSnippet(){
      const box = document.getElementById("dreamSnippet");
      if(!box) return;

      if(!state.bmPrompts.length){
        box.textContent = "No deep memories yet‚Ä¶ share a story with me when you are awake.";
        return;
      }

      // use weather of most recent memory as "current weather mood"
      const lastStory = state.bmPrompts[state.bmPrompts.length-1];
      const currentCond = lastStory && lastStory.weather ? lastStory.weather : "Unknown";

      let pool = state.bmPrompts.filter(b=>b.locked || (b.repeatCount && b.repeatCount>0));
      if(currentCond !== "Unknown"){
        const match = pool.filter(b=>b.weather===currentCond);
        if(match.length) pool = match;
      }
      if(!pool.length) pool = state.bmPrompts;

      const pick = pool[Math.floor(Math.random()*pool.length)];
      const ts = new Date(pick.ts||pick.createdAt).toLocaleString();
      let info = "["+ts+"]";
      if(pick.weather && pick.weather!=="Unknown"){
        info += " ¬∑ "+pick.weather+(pick.temp!=null?(" "+pick.temp+"¬∞C"):"");
      }
      box.innerHTML = `<div style="font-size:12px;opacity:0.6;margin-bottom:6px">${info}</div>` +
        (pick.text||"").slice(0,400) + (pick.text && pick.text.length>400 ? "‚Ä¶" : "");
    }

    function performSystemDecay(){
      pruneBM();
      console.log("System cleaning executed during sleep state.");
    }

    /* ---------- Identity ---------- */
    function loadIdentityIntoForm(){
      const u = state.userIdentity || {};
      els.uName.value = u.name || "";
      els.uNick.value = u.nick || "";
      els.uOrigin.value = u.origin || "";
      els.uPlace.value = u.place || "";
      els.uProfession.value = u.profession || "";
      els.uEmotionalStyle.value = u.emotionalStyle || "";
      els.uKeyPeople.value = u.keyPeople || "";
      els.uLegacyRules.value = u.legacyRules || "";
    }

    function readIdentityForm(){
      state.userIdentity = {
        name: (els.uName.value||"").trim(),
        nick: (els.uNick.value||"").trim(),
        origin: (els.uOrigin.value||"").trim(),
        place: (els.uPlace.value||"").trim(),
        profession: (els.uProfession.value||"").trim(),
        emotionalStyle: (els.uEmotionalStyle.value||"").trim(),
        keyPeople: (els.uKeyPeople.value||"").trim(),
        legacyRules: (els.uLegacyRules.value||"").trim()
      };
      saveAll();
    }

    /* ---------- User Message Flow ---------- */
    async function handleUserMessage(){
      const text = (els.userInput.value||"").trim();
      if(!text) return;

      const now = Date.now();
      if(state.cooldownUntil && now<state.cooldownUntil){
        const sec = Math.ceil((state.cooldownUntil-now)/1000);
        const msg = "AURA: Cooldown active for "+sec+"s. Let's slow down and restart calmly.";
        addHistory("aura",msg);
        renderHistory();
        speakText(msg,true);
        return;
      }

      els.userInput.value = "";
      addHistory("user",text);
      renderHistory();

      state.metrics.TM = scoreTM(text);
      recomputeBMMetric();
      updateCapsule();

      // story ‚Üí BM
      maybeCreateBMStory(text);

      const abuse = detectAbuse(text);
      if(abuse.hit){
        state.abuseCount = (state.abuseCount||0)+1;
        if(state.abuseCount>=3){
          state.cooldownUntil = Date.now() + 60*1000;
          state.abuseCount = 0;
          const msg = "AURA: I‚Äôll pause for 60 seconds. I work best when we stay kind to each other.";
          addHistory("aura",msg);
          renderHistory();
          speakText(msg,true);
          return;
        }
      }else{
        state.abuseCount = Math.max(0,(state.abuseCount||0)-1);
      }

      const {answer,source,intelBoost,llmBoost} = await generateAnswer(text);
      state.lastAnswerSource = source;
      state.lastUserQ = text;
      state.lastAuraA = answer;
      recomputeE0(intelBoost,llmBoost);
      updateCapsule();

      addHistory("aura",answer);
      renderHistory();
      speakText(answer,false);

      saveAll();
    }

    /* ---------- Wiring ---------- */
    function init(){
      loadAll();
      renderHistory();
      renderBMList();
      recomputeBMMetric();
      recomputeE0();
      updateCapsule();
      loadIdentityIntoForm();
      loadSeedIntoBox();

      els.btnSend.addEventListener("click", handleUserMessage);
      els.userInput.addEventListener("keydown",e=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          handleUserMessage();
        }
      });

      els.btnSpeakToggle.addEventListener("click",()=>{
        state.voiceEnabled = !state.voiceEnabled;
        els.btnSpeakToggle.textContent = state.voiceEnabled ? "üîä Voice: On" : "üîá Voice: Off";
      });

      els.bmSearch.addEventListener("input", renderBMList);
      els.bmToday.addEventListener("click",()=>{
        const today = new Date().toLocaleDateString();
        els.bmSearch.value = today;
        renderBMList();
      });

      els.btnUnlockBM.addEventListener("click",()=>{
        if(!state.selectedBMId) return;
        const bm = state.bmPrompts.find(x=>x.id===state.selectedBMId);
        if(!bm) return;
        if(!confirm("Unlock this BM prompt for editing?")) return;
        bm.locked = false;
        els.bmEditBox.style.display = "block";
        els.bmEditBox.value = bm.text||"";
        saveAll();
        renderBMList();
        selectBM(bm.id);
      });

      els.btnSaveBMEdit.addEventListener("click",()=>{
        if(!state.selectedBMId) return;
        const bm = state.bmPrompts.find(x=>x.id===state.selectedBMId);
        if(!bm || bm.locked) { showToast("Unlock BM first to edit."); return; }
        bm.text = els.bmEditBox.value || "";
        bm.ts = Date.now();
        saveAll();
        renderBMList();
        selectBM(bm.id);
        showToast("BM updated");
      });

      els.btnLiveBM.addEventListener("click",()=>{
        if(!state.selectedBMId) return;
        const bm = state.bmPrompts.find(x=>x.id===state.selectedBMId);
        if(!bm) return;
        const now = Date.now();
        if(bm.liveUntil && bm.liveUntil>now) bm.liveUntil=null;
        else bm.liveUntil = now + 12*60*60*1000;
        saveAll();
        renderBMList();
        selectBM(bm.id);
      });

      els.btnCopyPrompt.addEventListener("click",()=>{
        if(!state.selectedBMId) return;
        const bm = state.bmPrompts.find(x=>x.id===state.selectedBMId);
        if(!bm) return;
        navigator.clipboard?.writeText(bm.text||"");
        showToast("BM copied");
      });

      els.btnDeletePrompt.addEventListener("click",()=>{
        if(!state.selectedBMId) return;
        const bm = state.bmPrompts.find(x=>x.id===state.selectedBMId);
        if(!bm) return;
        if(!confirm("Delete this BM prompt?")) return;
        if(!confirm("Are you sure? This cannot be undone.")) return;
        state.bmPrompts = state.bmPrompts.filter(x=>x.id!==bm.id);
        state.selectedBMId = null;
        recomputeBMMetric();
        recomputeE0(0,0);
        updateCapsule();
        saveAll();
        renderBMList();
        els.bmViewer.style.display = "none";
        showToast("BM deleted");
      });

      // identity
      els.btnEditIdentity.addEventListener("click",()=>{
        [els.uName,els.uNick,els.uOrigin,els.uPlace,els.uProfession,
         els.uEmotionalStyle,els.uKeyPeople,els.uLegacyRules]
         .forEach(el=>el.removeAttribute("readonly"));
        showToast("Identity unlocked for edit");
      });
      els.btnSaveIdentity.addEventListener("click",()=>{
        readIdentityForm();
        [els.uName,els.uNick,els.uOrigin,els.uPlace,els.uProfession,
         els.uEmotionalStyle,els.uKeyPeople,els.uLegacyRules]
         .forEach(el=>el.setAttribute("readonly","true"));
        showToast("Identity saved");
      });

      // seed
      els.btnSaveSeed.addEventListener("click",rebuildSeedFromBox);
      els.btnLoadSeed.addEventListener("click",()=>{
        if(state.seedPairs.length){
          loadSeedIntoBox();
          showToast("Loaded saved seed");
        }else{
          els.seedBox.value =
`Q: Who created you?
A: I was created by Alim ul Haq as part of the AURA-X Œ© Emotional Continuity experiment.

Q: What is your purpose?
A: I try to keep emotional continuity of your stories: linking your temporary feelings (TM) with deeper body memories (BM).`;
          rebuildSeedFromBox();
        }
      });

      // idle detection for Dream Mode
      document.addEventListener("mousemove", resetIdleTimer);
      document.addEventListener("keydown", resetIdleTimer);
      document.addEventListener("mousedown", resetIdleTimer);
      document.addEventListener("touchstart", resetIdleTimer);

      const dreamOverlay = document.getElementById("dreamOverlay");
      dreamOverlay.addEventListener("click",()=>{
        stopDreamMode();
        resetIdleTimer();
      });

      resetIdleTimer();
    }

    init();
  </script>
</body>
</html>