<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Optimized Priority Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    /* --- STYLES (Optimized for Mobile & Desktop) --- */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,sans-serif;
      background:radial-gradient(circle at 50% 0%, #1e293b 0, #020617 100%);
      color:#e5e7eb; min-height:100vh; display:flex; justify-content:center; padding:10px;
    }
    .app{
      width:100%; max-width:1000px;
      background:#0f172a; border-radius:20px;
      box-shadow:0 0 0 1px #1e293b, 0 20px 40px rgba(0,0,0,0.5);
      padding:15px; display:flex; flex-direction:column; gap:15px; position:relative;
    }

    /* HEADER */
    .header{
      display:flex; justify-content:space-between; align-items:center;
      background:linear-gradient(90deg, #0f172a, #1e293b);
      padding:15px; border-radius:15px; border:1px solid #334155;
    }
    .brand h1{ 
      font-size:1.4rem; font-weight:800; letter-spacing:1px;
      background:linear-gradient(to right, #38bdf8, #818cf8); -webkit-background-clip:text; color:transparent; 
    }
    .brand p{ font-size:0.75rem; color:#94a3b8; }
    
    /* OPTIONS MENU */
    .controls{ position:relative; }
    .btn-opt{
      background:#1e293b; border:1px solid #475569; color:#f1f5f9;
      padding:8px 14px; border-radius:99px; cursor:pointer; font-size:0.85rem;
      display:flex; align-items:center; gap:6px; transition:0.2s;
    }
    .btn-opt:hover{ background:#334155; }
    
    .dropdown{
      position:absolute; top:120%; right:0; width:200px;
      background:#1e293b; border:1px solid #475569; border-radius:12px;
      padding:6px; display:none; flex-direction:column; gap:4px; z-index:50;
      box-shadow:0 10px 30px rgba(0,0,0,0.5);
    }
    .controls.open .dropdown{ display:flex; }
    
    .menu-item{
      background:transparent; border:none; color:#cbd5e1; text-align:left;
      padding:8px 12px; border-radius:8px; font-size:0.8rem; cursor:pointer;
    }
    .menu-item:hover{ background:#334155; color:#fff; }

    /* LAYOUT */
    .main-grid{ display:grid; grid-template-columns:1fr 1.2fr; gap:15px; }
    @media(max-width:768px){ .main-grid{ grid-template-columns:1fr; } }

    /* CARDS */
    .card{
      background:#1e293b; border:1px solid #334155; border-radius:15px;
      padding:15px; display:flex; flex-direction:column; gap:10px;
    }
    .card-head{ font-size:0.85rem; font-weight:600; color:#94a3b8; text-transform:uppercase; letter-spacing:0.5px; }
    
    /* METRICS */
    .metrics{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .stat-box{ background:#0f172a; padding:10px; border-radius:10px; text-align:center; border:1px solid #1e293b; }
    .stat-val{ font-size:1.1rem; font-weight:bold; color:#38bdf8; }
    .stat-lbl{ font-size:0.65rem; color:#64748b; }

    /* CHAT */
    .chat-box{
      background:#020617; border-radius:12px; flex:1; min-height:300px; max-height:400px;
      overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px;
      border:1px solid #1e293b;
    }
    .msg{ padding:8px 12px; border-radius:10px; font-size:0.9rem; max-width:85%; line-height:1.4; animation:popIn 0.2s ease; }
    .msg.user{ align-self:flex-end; background:#2563eb; color:white; border-bottom-right-radius:2px; }
    .msg.ai{ align-self:flex-start; background:#1e293b; color:#e2e8f0; border:1px solid #334155; border-bottom-left-radius:2px; }
    .msg.sys{ align-self:center; font-size:0.7rem; color:#64748b; background:#0f172a; padding:4px 10px; border-radius:99px; }

    @keyframes popIn{ from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

    /* INPUT AREA */
    .input-area{
      position:sticky; bottom:0; background:#0f172a; padding-top:10px; z-index:10;
    }
    .input-bar{
      display:flex; gap:10px; background:#1e293b; padding:8px; border-radius:99px; border:1px solid #334155;
    }
    .txt-in{
      flex:1; background:transparent; border:none; outline:none; color:white; padding:0 10px; font-size:0.95rem;
    }
    .btn-send{
      background:#38bdf8; border:none; padding:8px 20px; border-radius:99px;
      font-weight:600; color:#0f172a; cursor:pointer;
    }
    
    /* MODALS */
    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,0.7); display:none;
      align-items:center; justify-content:center; z-index:100; backdrop-filter:blur(3px);
    }
    .modal.open{ display:flex; }
    .modal-box{
      background:#1e293b; width:90%; max-width:500px; padding:20px;
      border-radius:16px; border:1px solid #475569; box-shadow:0 25px 50px rgba(0,0,0,0.5);
    }
    .modal-head{ display:flex; justify-content:space-between; margin-bottom:15px; font-weight:bold; }
    .close-modal{ background:none; border:none; color:#94a3b8; cursor:pointer; font-size:1.2rem; }
    .llm-status{ font-size:0.75rem; color:#38bdf8; margin-top:5px; }

    /* OFFLINE LOADER */
    .progress-bar{ height:4px; background:#334155; border-radius:2px; margin-top:10px; overflow:hidden; }
    .progress-fill{ height:100%; width:0%; background:#38bdf8; transition:width 0.2s; }
  </style>
</head>
<body>

<div class="app">
  <header class="header">
    <div class="brand">
      <h1>AURA-X Œ©</h1>
      <p>Priority: Intel > Offline > Online</p>
    </div>
    <div class="controls" id="controls">
      <button class="btn-opt" id="optBtn">‚öôÔ∏è Options</button>
      <div class="dropdown">
        <button class="menu-item" id="btnVoice">üîä Voice: OFF</button>
        <button class="menu-item" id="btnOffline">ü§ñ Offline LLM</button>
        <button class="menu-item" id="btnReset" style="color:#f87171">üóëÔ∏è Reset Memory</button>
      </div>
    </div>
  </header>

  <div class="main-grid">
    <div class="card">
      <div class="card-head">üß† Engine State</div>
      <div class="metrics">
        <div class="stat-box">
          <div class="stat-lbl">Emotional State (E‚ÇÄ)</div>
          <div class="stat-val" id="valE0">0.00</div>
        </div>
        <div class="stat-box">
          <div class="stat-lbl">TM Sentiment</div>
          <div class="stat-val" id="valTM">0.00</div>
        </div>
        <div class="stat-box">
          <div class="stat-lbl">BM Sentiment</div>
          <div class="stat-val" id="valBM">0.00</div>
        </div>
        <div class="stat-box">
          <div class="stat-lbl">Learned Nodes</div>
          <div class="stat-val" id="valNodes">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-lbl">Active Source</div>
          <div class="stat-val" id="valSource" style="font-size:0.8rem; color:#a5b4fc">Idle</div>
        </div>
      </div>
      <div style="font-size:0.75rem; color:#64748b; padding:5px;">
        TM is analyzed immediately on entrance. Reply is fetched based on priority hierarchy.
      </div>
    </div>

    <div class="card" style="flex:1;">
      <div class="card-head">üí¨ Console</div>
      <div class="chat-box" id="chat">
        <div class="msg sys">System online. Priority Mode Active.</div>
      </div>
      
      <div class="input-area">
        <div class="input-bar">
          <input type="text" class="txt-in" id="input" placeholder="Type here..." autocomplete="off">
          <button class="btn-send" id="send">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="llmModal">
  <div class="modal-box">
    <div class="modal-head">
      <span>Offline Intelligence (WebLLM)</span>
      <button class="close-modal" id="closeLlm">√ó</button>
    </div>
    <p style="font-size:0.85rem; color:#cbd5e1; margin-bottom:15px;">
      Load a small AI model directly in your browser. This will be used if "Learned Data" has no answer.
    </p>
    <button class="btn-opt" id="loadLlmBtn" style="width:100%; justify-content:center; background:#2563eb;">
      üì• Download & Load Model (~1.2GB)
    </button>
    <div class="llm-status" id="llmStatus">Status: Idle</div>
    <div class="progress-bar"><div class="progress-fill" id="llmProgress"></div></div>
  </div>
</div>

<script>
class AuraSystem {
  constructor() {
    this.state = {
      e0: 0.1,
      bm: 0.0,
      intelNodes: [
        { q: "who are you", a: "I am AURA-X Omega, an emotional continuity engine." },
        { q: "how are you", a: "I am functioning within normal emotional parameters." }
      ],
      tmHistory: [],
      offlineReady: false,
      voice: false,
      learning: false,
      lastQ: ''
    };

    this.offlineEngine = null;
    this.dom = {
      input: document.getElementById('input'),
      chat: document.getElementById('chat'),
      valE0: document.getElementById('valE0'),
      valTM: document.getElementById('valTM'),
      valBM: document.getElementById('valBM'),
      valNodes: document.getElementById('valNodes'),
      valSource: document.getElementById('valSource'),
      controls: document.getElementById('controls')
    };

    this.init();
  }

  init() {
    // Option Button Event
    document.getElementById('optBtn').addEventListener('click', (e) => {
      e.stopPropagation();
      this.dom.controls.classList.toggle('open');
    });

    document.addEventListener('click', (e) => {
      if (!this.dom.controls.contains(e.target)) {
        this.dom.controls.classList.remove('open');
      }
    });

    // Send Events
    document.getElementById('send').addEventListener('click', () => this.processInput());
    this.dom.input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.processInput();
    });

    // Voice Toggle
    document.getElementById('btnVoice').addEventListener('click', () => {
      this.state.voice = !this.state.voice;
      document.getElementById('btnVoice').innerText = `üîä Voice: ${this.state.voice ? 'ON' : 'OFF'}`;
    });

    // Offline LLM Events
    document.getElementById('btnOffline').addEventListener('click', () => {
      document.getElementById('llmModal').classList.add('open');
    });
    document.getElementById('closeLlm').addEventListener('click', () => {
      document.getElementById('llmModal').classList.remove('open');
    });
    document.getElementById('loadLlmBtn').addEventListener('click', () => this.loadOfflineModel());

    // Reset Memory
    document.getElementById('btnReset').addEventListener('click', () => {
      this.state.intelNodes = [
        { q: "who are you", a: "I am AURA-X Omega, an emotional continuity engine." },
        { q: "how are you", a: "I am functioning within normal emotional parameters." }
      ];
      this.state.tmHistory = [];
      this.state.e0 = 0.1;
      this.state.bm = 0.0;
      this.state.learning = false;
      this.updateUI();
      this.addMsg("Memory reset complete.", 'sys');
    });

    this.updateUI();
  }

  async processInput() {
    const text = this.dom.input.value.trim();
    if (!text) return;

    // If in learning mode, treat input as the response to learn
    if (this.state.learning) {
      const a = text;
      this.state.intelNodes.push({ q: this.state.lastQ, a });
      this.addMsg("Learned new response for: " + this.state.lastQ, 'sys');
      this.state.learning = false;
      this.dom.input.value = '';
      this.updateUI();
      return;
    }

    // UI: Show User Message
    this.addMsg(text, 'user');
    this.dom.input.value = '';

    // IMMEDIATE TM ANALYSIS (On Entrance)
    const sentiment = this.analyzeSentiment(text);
    this.updateEmotion(sentiment); // Update E0 instantly based on input
    
    this.dom.valSource.innerText = "Thinking...";

    // PRIORITY HIERARCHY FOR ANSWER
    let reply = null;
    let source = "";

    // Priority A: Learned Intelligence (Exact or Fuzzy Match)
    const learned = this.findIntelMatch(text);
    if (learned) {
      reply = learned;
      source = "üß† Learned Memory";
      // Artificial delay for realism
      await new Promise(r => setTimeout(r, 600));
    }

    // Priority B: Offline LLM (WebLLM)
    if (!reply && this.state.offlineReady) {
      try {
        source = "ü§ñ Offline AI";
        reply = await this.queryOfflineLLM(text);
      } catch (e) { console.error(e); }
    }

    // Priority C: Online API (Placeholder, disabled)
    if (!reply && false) { 
      // Implement OpenAI or similar here if desired
    }

    // Fallback: Learning Prompt
    if (!reply) {
      reply = "I don't have a memory for this yet. How should I respond?";
      source = "‚ùì Needs Training";
      this.state.learning = true;
      this.state.lastQ = text;
    }

    // Output Reply
    this.dom.valSource.innerText = source;
    this.addMsg(reply, 'ai');
    
    // Voice Output?
    if (this.state.voice) this.speak(reply);
  }

  // --- CORE FUNCTIONS ---

  analyzeSentiment(text) {
    // Simple mock sentiment analysis (-1 to 1 range)
    let score = 0;
    const pos = ['good','happy','thanks','great','love'];
    const neg = ['bad','sad','hate','angry','wrong'];
    text.toLowerCase().split(' ').forEach(w => {
      if(pos.includes(w)) score += 0.2;
      if(neg.includes(w)) score -= 0.2;
    });
    score = Math.max(-1, Math.min(1, score));
    // Update UI immediately
    this.dom.valTM.innerText = score.toFixed(2);
    this.state.tmHistory.push(score);
    return score;
  }

  resonant(TM, BM) {
    // Wave-like resonant interaction: amplitude * cos(phase difference)
    // This simulates interference: full positive if aligned, negative if opposed
    const amplitude = (Math.abs(TM) + Math.abs(BM)) / 2;
    const phaseDiff = Math.abs(TM - BM);
    return amplitude * Math.cos(phaseDiff * Math.PI / 2);
  }

  updateEmotion(tmScore) {
    // Full numerical formula from AURA-X Œ© paper:
    // E_0 = tanh( R(TM, BM) - D + Œª_faith + Œª_sys + Œª_trc )
    // Where R is resonant interaction (wave-like, not scalar multiply)
    // D is decay, Œª_faith is belief stabilization (e.g., 0.05), Œª_sys is system bias (0.0), Œª_trc is truth correction (0.0 for now)
    const TM = tmScore;
    const BM = this.state.bm;
    const R = this.resonant(TM, BM);
    const D = 0.1 * Math.abs(this.state.e0); // Decay: 10% of current |E0| 
    const lambda_faith = 0.05; // Stabilizing belief/moral grounding
    const lambda_sys = 0.0; // System-level constraints
    const lambda_trc = 0.0; // Truth-resonance correction (could be negative if "false" detected, but simplified)
    const raw = R - D + lambda_faith + lambda_sys + lambda_trc;
    this.state.e0 = Math.tanh(raw);

    // Slowly update BM (slow-changing identity memory)
    this.state.bm = 0.95 * BM + 0.05 * TM;

    this.updateUI();
  }

  findIntelMatch(input) {
    // Find best match in known Q/A pairs (simple substring match)
    const cleanIn = input.toLowerCase();
    const match = this.state.intelNodes.find(n => cleanIn.includes(n.q.toLowerCase()));
    return match ? match.a : null;
  }

  async loadOfflineModel() {
    if (!window.webllm) return alert("WebLLM library failed to load.");
    
    const statusEl = document.getElementById('llmStatus');
    const bar = document.getElementById('llmProgress');
    
    try {
      statusEl.innerText = "Initializing Engine...";
      this.offlineEngine = await window.webllm.CreateMLCEngine(
        "Llama-3.2-1B-Instruct-q4f16_1-MLC", 
        { 
          initProgressCallback: (info) => {
            statusEl.innerText = info.text;
            bar.style.width = `${info.progress * 100}%`;
          } 
        }
      );
      this.state.offlineReady = true;
      statusEl.innerText = "Model Ready!";
      statusEl.style.color = "#4ade80";
      setTimeout(() => document.getElementById('llmModal').classList.remove('open'), 1000);
    } catch (err) {
      statusEl.innerText = "Error: " + err.message;
      statusEl.style.color = "#f87171";
    }
  }

  async queryOfflineLLM(text) {
    if (!this.offlineEngine) return null;
    const res = await this.offlineEngine.chat.completions.create({
      messages: [{ role: "user", content: text }],
      temperature: 0.7,
    });
    return res.choices[0].message.content;
  }

  addMsg(text, role) {
    const div = document.createElement('div');
    div.className = `msg ${role}`;
    div.innerText = text;
    this.dom.chat.appendChild(div);
    this.dom.chat.scrollTop = this.dom.chat.scrollHeight;
  }

  speak(text) {
    if ('speechSynthesis' in window) {
      const utt = new SpeechSynthesisUtterance(text);
      window.speechSynthesis.speak(utt);
    }
  }

  updateUI() {
    this.dom.valE0.innerText = this.state.e0.toFixed(3);
    this.dom.valE0.style.color = this.state.e0 > 0 ? '#4ade80' : (this.state.e0 < 0 ? '#f87171' : '#e2e8f0');
    this.dom.valBM.innerText = this.state.bm.toFixed(2);
    this.dom.valNodes.innerText = this.state.intelNodes.length;
  }
}

// Start App
window.onload = () => window.aura = new AuraSystem();
</script>

</body>
</html>