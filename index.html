<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AURA-X Œ© ‚Äî Code 9 UI (Final All-in-One)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* =========================
   CODE 9 UI (LOCKED)
========================= */
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:
    radial-gradient(circle at 20% 0%, rgba(30,41,59,.85) 0, transparent 45%),
    radial-gradient(circle at 80% 0%, rgba(15,118,110,.45) 0, transparent 45%),
    radial-gradient(circle at 50% 100%, rgba(30,64,175,.35) 0, transparent 50%),
    #050b16;
  color:#e5e7eb;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;
}
.card{
  width:min(520px,100%);
  border-radius:28px;
  background:linear-gradient(180deg, rgba(2,6,23,.55), rgba(2,6,23,.35));
  border:1px solid rgba(148,163,184,.16);
  box-shadow:0 20px 70px rgba(0,0,0,.45);
  padding:18px;
}
.hdr{text-align:center;padding:8px 6px 10px}
.hdr h1{font-weight:800;letter-spacing:.5px;font-size:34px;color:#8dd6ff;text-shadow:0 0 20px rgba(56,189,248,.15)}
.hdr .sub{margin-top:6px;font-size:13px;line-height:1.45;opacity:.85}
.ethic{
  margin:14px 0;padding:12px 14px;border-radius:18px;
  border:1px solid rgba(234,179,8,.22);
  background:rgba(2,6,23,.35);color:#facc15;font-size:13.5px;line-height:1.5;text-align:center;
}
.pill{
  margin:14px 0 16px;text-align:center;padding:14px 16px;border-radius:999px;
  background:linear-gradient(90deg, rgba(56,189,248,.35), rgba(20,184,166,.25));
  border:1px solid rgba(148,163,184,.18);font-weight:800;letter-spacing:.7px;color:#cfefff;
}
.panel{border-radius:22px;border:1px solid rgba(148,163,184,.14);background:rgba(2,6,23,.35);padding:16px}
.topRow{display:flex;gap:12px;align-items:center;margin-bottom:12px}
.btn{
  border:1px solid rgba(148,163,184,.18);background:rgba(15,23,42,.65);
  color:#e5e7eb;padding:11px 14px;border-radius:18px;cursor:pointer;transition:.15s ease;user-select:none
}
.btn:hover{transform:translateY(-1px);border-color:rgba(56,189,248,.35)}
.btn:active{transform:translateY(0);opacity:.95}
.btnSmall{padding:8px 12px;border-radius:14px;font-size:12px}
.danger{border-color:rgba(239,68,68,.35)}
.danger:hover{border-color:rgba(239,68,68,.55)}
#btnOptions{display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:999px;min-width:140px}
#optionsMenu{display:none;margin-top:10px;padding:14px;border-radius:20px;border:1px solid rgba(148,163,184,.14);background:rgba(2,6,23,.25)}
.menuGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.menuItem{
  border-radius:16px;border:1px solid rgba(148,163,184,.14);
  background:rgba(15,23,42,.55);padding:12px 10px;text-align:center;cursor:pointer;
  transition:.15s ease;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;min-height:70px
}
.menuItem:hover{transform:translateY(-1px);border-color:rgba(56,189,248,.35)}
.miTop{display:flex;gap:10px;align-items:center;font-weight:700}
.miPill{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.14)}
.pillOn{background:rgba(34,197,94,.14);border-color:rgba(34,197,94,.25)}
.pillOff{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.20)}
.pillOpen{background:rgba(14,165,233,.12);border-color:rgba(14,165,233,.25)}
.pillNone{background:rgba(244,63,94,.10);border-color:rgba(244,63,94,.22)}
.console{
  margin-top:14px;border-radius:18px;border:1px solid rgba(148,163,184,.14);
  background:rgba(2,6,23,.35);padding:12px;min-height:230px;max-height:330px;overflow:auto;
  font-family:ui-monospace, Menlo, Consolas, monospace;font-size:13px;line-height:1.55;color:#dbeafe
}
.line{white-space:pre-wrap}
.you{color:#f1f5f9}
.aura{color:#a7f3d0}
.ts{opacity:.7}
.stats{
  margin-top:14px;border-radius:999px;border:1px solid rgba(148,163,184,.14);
  background:rgba(2,6,23,.35);padding:12px 14px;display:flex;justify-content:space-between;gap:10px;
  font-family:ui-monospace, Menlo, Consolas, monospace;font-size:13px;opacity:.95
}
.inputRow{margin-top:12px;display:flex;gap:10px;align-items:center}
#userInput{
  flex:1;border:1px solid rgba(148,163,184,.14);background:rgba(15,23,42,.55);
  color:#e5e7eb;padding:12px 14px;border-radius:999px;outline:none
}
#btnSend{
  padding:12px 18px;border-radius:999px;
  background:linear-gradient(90deg, rgba(56,189,248,.55), rgba(20,184,166,.35));
  border:1px solid rgba(56,189,248,.28);font-weight:800;color:#e6fbff
}
.formula{margin-top:10px;text-align:center;font-family:ui-monospace, Menlo, Consolas, monospace;font-size:13px;opacity:.85}

/* ===== Modals ===== */
.modalOverlay{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.45);padding:16px;z-index:999}
.modal{
  width:min(560px,100%);border-radius:22px;border:1px solid rgba(148,163,184,.18);
  background:rgba(2,6,23,.92);box-shadow:0 30px 90px rgba(0,0,0,.65);overflow:hidden
}
.modalHead{padding:14px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(148,163,184,.12)}
.modalTitle{font-weight:900;font-size:16px}
.modalSub{font-size:12.5px;opacity:.78;margin-top:2px}
.closeX{cursor:pointer;font-size:18px;opacity:.9}
.modalBody{padding:14px}
textarea, input[type="text"], input[type="date"]{
  width:100%;border:1px solid rgba(148,163,184,.14);background:rgba(15,23,42,.65);
  color:#e5e7eb;padding:12px;border-radius:16px;outline:none;min-height:110px;resize:vertical
}
input[type="date"]{min-height:auto}
.hint{opacity:.75;font-size:12px;margin-top:8px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
hr{border:none;border-top:1px solid rgba(148,163,184,.12);margin:12px 0}

/* BM modal */
.bmWrap{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:520px){.bmWrap{grid-template-columns:1fr}}
.bmLeft,.bmRight{border:1px solid rgba(148,163,184,.12);background:rgba(15,23,42,.35);border-radius:18px;padding:12px}
.bmList{display:flex;flex-direction:column;gap:10px;margin-top:10px;max-height:260px;overflow:auto}
.bmItem{padding:10px;border-radius:14px;border:1px solid rgba(148,163,184,.12);background:rgba(2,6,23,.35);cursor:pointer}
.bmItem:hover{border-color:rgba(56,189,248,.30)}
.bmTitle{font-weight:800;font-size:13px}
.bmMeta{font-size:12px;opacity:.75;margin-top:2px}
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(148,163,184,.18);border-radius:999px;padding:2px 8px;font-size:11px;opacity:.9}
.badge.lock{background:rgba(14,165,233,.10)}
.badge.file{background:rgba(34,197,94,.10)}
.bmAttachBar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
.bmFiles{display:flex;flex-direction:column;gap:10px;margin-top:10px;max-height:190px;overflow:auto}
.fileRow{border:1px solid rgba(148,163,184,.14);background:rgba(2,6,23,.45);border-radius:14px;padding:10px}
.fileName{font-size:13px}
.fileType{opacity:.7;font-size:12px}
.fileActions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.filePreview{margin-top:10px}
.smallNote{font-size:12px;opacity:.8}
</style>
</head>

<body>
<div class="card">
  <div class="hdr">
    <h1>AURA-X Œ©</h1>
    <div class="sub">
      Offline emotional continuity engine (prototype)<br/>
      TM = your inputs ¬∑ Local memory layers keep continuity.
    </div>
  </div>

  <div class="ethic">
    <b>Universal ethic:</b> avoid actions that grow negative emotions in you or others.
  </div>

  <div class="pill">EMOTIONAL CONTINUITY ENGINE ‚Äî ACTIVE</div>

  <div class="panel">
    <div class="topRow">
      <button class="btn" id="btnOptions">‚öô Options</button>
    </div>

    <div id="optionsMenu">
      <div class="menuGrid">
        <div class="menuItem" id="miVoice">
          <div class="miTop">üéôÔ∏è Voice</div>
          <div class="miPill pillOn" id="pillVoice">on</div>
        </div>
        <div class="menuItem" id="miIntel">
          <div class="miTop">üß† Intelligence</div>
          <div class="miPill pillOpen">open</div>
        </div>
        <div class="menuItem" id="miLearning">
          <div class="miTop">üìö Learning</div>
          <div class="miPill pillOn" id="pillLearning">on</div>
        </div>

        <div class="menuItem" id="miFeed">
          <div class="miTop">üå± Feed</div>
          <div class="miPill pillOpen">open</div>
        </div>
        <div class="menuItem" id="miFaith">
          <div class="miTop">üïäÔ∏è Faith</div>
          <div class="miPill pillNone" id="pillFaith">none</div>
        </div>
        <div class="menuItem" id="miIdentity">
          <div class="miTop">ü™™ Identity</div>
          <div class="miPill pillOpen">open</div>
        </div>

        <div class="menuItem" id="miLLM">
          <div class="miTop">ü§ñ LLM</div>
          <div class="miPill pillOpen">open</div>
        </div>
        <div class="menuItem" id="miBM">
          <div class="miTop">üìò BM Recall</div>
          <div class="miPill pillOpen">open</div>
        </div>
        <div class="menuItem" id="miHistory">
          <div class="miTop">üìú History</div>
          <div class="miPill pillOpen">open</div>
        </div>
      </div>
    </div>

    <!-- IMPORTANT: NO startup message shown here -->
    <div class="console" id="console"></div>

    <div class="stats">
      <span id="statE0">E0: 0.000</span>
      <span id="statTM">TM: 0.00</span>
      <span id="statBM">BM: 0.00</span>
      <span id="statC">C: 0.850</span>
    </div>

    <div class="inputRow">
      <input id="userInput" placeholder="Talk to AURA-X Œ©‚Ä¶" autocomplete="off" />
      <button id="btnSend">Send</button>
    </div>

    <div class="formula">
      E‚ÇÄ = tanh( R(TM,BM) + I(TM) + I<sub>intel</sub> + I<sub>LLM</sub> ‚àí D + Œª<sub>faith</sub> + Œª<sub>sys</sub> + Œª<sub>trc</sub> )
    </div>
  </div>
</div>

<!-- =========================
   MODALS
========================= -->

<!-- Intelligence -->
<div class="modalOverlay" id="modalIntel">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="modalTitle">Intelligence (local)</div>
        <div class="modalSub">Learned Q‚ÜíA stored on your device. Edit carefully.</div>
      </div>
      <div class="closeX" data-close="modalIntel">‚úï</div>
    </div>
    <div class="modalBody">
      <div class="row">
        <button class="btn btnSmall" id="btnIntelSave">Save</button>
        <button class="btn btnSmall" id="btnIntelExport">Export JSON</button>
        <button class="btn btnSmall danger" id="btnIntelClear">Clear (double confirm)</button>
      </div>
      <div class="hint" id="intelHint"></div>
      <textarea id="intelArea" spellcheck="false"></textarea>
      <div class="hint smallNote">
        Tip: Keep it as a JSON array of objects: { "q": "...", "a": "...", "locked": true/false, "approvedAt": number }.
      </div>
    </div>
  </div>
</div>

<!-- Feed (blank input, no placeholder text) -->
<div class="modalOverlay" id="modalSeed">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="modalTitle">Feed the seed (protected)</div>
        <div class="modalSub">Paste a block or simple Q/A. Saved items become locked by default.</div>
      </div>
      <div class="closeX" data-close="modalSeed">‚úï</div>
    </div>
    <div class="modalBody">
      <textarea id="seedArea" spellcheck="false"></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn btnSmall" id="btnSeedParse">Parse</button>
        <button class="btn btnSmall" id="btnSeedSave">Save</button>
        <button class="btn btnSmall danger" id="btnSeedDiscard">Discard</button>
      </div>
      <div class="hint" id="seedHint"></div>
    </div>
  </div>
</div>

<!-- Faith -->
<div class="modalOverlay" id="modalFaith">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="modalTitle">Faith lens</div>
        <div class="modalSub">Optional encouragement layer (local only).</div>
      </div>
      <div class="closeX" data-close="modalFaith">‚úï</div>
    </div>
    <div class="modalBody">
      <div class="row" id="faithButtons"></div>
      <div class="hint">Universal ethic remains active. This only adds gentle tone hints.</div>
    </div>
  </div>
</div>

<!-- Identity -->
<div class="modalOverlay" id="modalIdentity">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="modalTitle">Identity (local)</div>
        <div class="modalSub">Your profile stays on this device.</div>
      </div>
      <div class="closeX" data-close="modalIdentity">‚úï</div>
    </div>
    <div class="modalBody">
      <textarea id="identityArea" spellcheck="false"></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn btnSmall" id="btnIdSave">Save</button>
        <button class="btn btnSmall danger" id="btnIdClear">Clear (double confirm)</button>
      </div>
    </div>
  </div>
</div>

<!-- LLM -->
<div class="modalOverlay" id="modalLLM">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="modalTitle">LLM</div>
        <div class="modalSub">Pipeline: Seed/Intelligence ‚Üí BM recall ‚Üí (future offline LLM/API)</div>
      </div>
      <div class="closeX" data-close="modalLLM">‚úï</div>
    </div>
    <div class="modalBody">
      <div class="hint">
        This build stays local by default. You can later connect a real offline model (WebGPU) or an API endpoint.
      </div>
    </div>
  </div>
</div>

<!-- BM Recall (by date + evidence files) -->
<div class="modalOverlay" id="modalBM">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="modalTitle">BM Recall</div>
        <div class="modalSub">Filter by date. Open prompts. Attach evidence files (photo/video/audio).</div>
      </div>
      <div class="closeX" data-close="modalBM">‚úï</div>
    </div>
    <div class="modalBody">
      <div class="bmWrap">
        <div class="bmLeft">
          <div class="row">
            <button class="btn btnSmall" id="btnBMExport">Export</button>
            <button class="btn btnSmall danger" id="btnBMClear">Clear all (double confirm)</button>
          </div>
          <hr/>
          <div class="row">
            <input type="date" id="bmDateFilter" />
            <button class="btn btnSmall" id="btnBMFilter">Filter</button>
            <button class="btn btnSmall" id="btnBMShowAll">Show all</button>
          </div>
          <div class="bmList" id="bmList"></div>
        </div>

        <div class="bmRight" id="bmViewer" style="display:none">
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="modalTitle" id="bmTitle">BM Prompt</div>
              <div class="modalSub" id="bmMeta"></div>
            </div>
            <div id="bmLockIcon" style="font-size:18px">üîí</div>
          </div>

          <div class="bmAttachBar">
            <input type="file" id="bmFileInput" accept="image/*,video/*,audio/*" />
            <button class="btn btnSmall" id="btnBMAddFile">Add evidence</button>
          </div>

          <div class="bmFiles" id="bmFiles"></div>

          <textarea id="bmTextArea" spellcheck="false"></textarea>

          <div class="row" style="margin-top:10px">
            <button class="btn btnSmall" id="btnBMCopy">Copy</button>
            <button class="btn btnSmall" id="btnBMSendToInput">Send to input</button>
            <button class="btn btnSmall" id="btnBMUnlock">Unlock</button>
            <button class="btn btnSmall danger" id="btnBMDelete">Delete</button>
          </div>
          <div class="hint">Locked BM cannot be edited until unlocked (double confirm).</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- History (TM) -->
<div class="modalOverlay" id="modalHistory">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div class="modalTitle">Conversation History (TM)</div>
        <div class="modalSub">Auto-decays after 48h. Export or delete manually.</div>
      </div>
      <div class="closeX" data-close="modalHistory">‚úï</div>
    </div>
    <div class="modalBody">
      <div class="row">
        <button class="btn btnSmall" id="btnHistExport">Export</button>
        <button class="btn btnSmall danger" id="btnHistClear">Delete all (double confirm)</button>
      </div>
      <div class="hint" id="histHint"></div>
      <textarea id="histArea" spellcheck="false"></textarea>
    </div>
  </div>
</div>

<script>
/* =========================
   FINAL LOGIC (ALL-IN-ONE)
========================= */
const el = (id)=>document.getElementById(id);
const escapeHTML = (s)=>String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
const norm = (s)=>String(s||"").toLowerCase().replace(/[^\p{L}\p{N}\s]+/gu," ").replace(/\s+/g," ").trim();
const nowTS = ()=>new Date().toLocaleTimeString([], {hour12:false});
const ymd = ()=>new Date().toISOString().slice(0,10);
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

/* Storage keys */
const KEY_CFG="aurax_cfg_v9_final";
const KEY_INT="aurax_intelligence_v9_final";
const KEY_BM ="aurax_bm_v9_final";
const KEY_HIST="aurax_hist_v9_final";
const KEY_ID ="aurax_id_v9_final";
const KEY_FAITH="aurax_faith_v9_final";

/* Config */
let cfg = Object.assign({
  voiceOn:true,
  learningOn:true,
  decayHours:48,
  bmMinChars:18,
  bmAutoLockDays:30   // items in Intelligence become "locked" by default; after approval they remain locked
}, safeLoad(KEY_CFG, {}));

/* Local data */
let intelligence = safeLoad(KEY_INT, []);
let bm = safeLoad(KEY_BM, []);
let hist = safeLoad(KEY_HIST, []);
let identity = safeLoad(KEY_ID, "");
let faith = safeLoad(KEY_FAITH, "None");

/* Minimal built-in seed */
const SEED_QA = [
  {q:"hello", a:"Hello! I am AURA-X Œ©. How can I help today?"},
  {q:"hi", a:"Hi! I am AURA-X Œ©. What would you like to talk about?"},
  {q:"how are you", a:"I am running well. How are you feeling right now?"},
  {q:"who created you", a:"I am AURA-X Œ©, created as a prototype by Alim ul Haq."},
  {q:"what is aura x omega", a:"AURA-X Œ© is an offline emotional continuity prototype using local memory + continuity math."}
];

/* UI refs */
const consoleBox = el("console");
const statE0 = el("statE0");
const statTM = el("statTM");
const statBM = el("statBM");
const statC  = el("statC");
const userInput = el("userInput");

/* ===== IndexedDB for BM files ===== */
const DB_NAME="aurax_db_final";
const DB_VER=1;

function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = ()=>{
      const db=req.result;
      if(!db.objectStoreNames.contains("bm_files")){
        db.createObjectStore("bm_files",{keyPath:"id"});
      }
    };
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}
async function dbPut(obj){
  const db=await openDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction("bm_files","readwrite");
    tx.objectStore("bm_files").put(obj);
    tx.oncomplete=()=>resolve(true);
    tx.onerror=()=>reject(tx.error);
  });
}
async function dbGet(id){
  const db=await openDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction("bm_files","readonly");
    const rq=tx.objectStore("bm_files").get(id);
    rq.onsuccess=()=>resolve(rq.result||null);
    rq.onerror=()=>reject(rq.error);
  });
}
async function dbDel(id){
  const db=await openDB();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction("bm_files","readwrite");
    tx.objectStore("bm_files").delete(id);
    tx.oncomplete=()=>resolve(true);
    tx.onerror=()=>reject(tx.error);
  });
}
function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>resolve(String(r.result||""));
    r.onerror=()=>reject(r.error);
    r.readAsDataURL(file);
  });
}

/* ===== Safe localStorage ===== */
function safeLoad(key, fallback){
  try{
    const v=localStorage.getItem(key);
    if(!v) return fallback;
    return JSON.parse(v);
  }catch(e){ return fallback; }
}
function safeSave(key, val){
  localStorage.setItem(key, JSON.stringify(val));
}

/* ===== Options Toggle ===== */
el("btnOptions").onclick=()=>{
  el("optionsMenu").style.display = el("optionsMenu").style.display==="block" ? "none" : "block";
};

/* ===== Modals open/close ===== */
document.querySelectorAll("[data-close]").forEach(x=>{
  x.addEventListener("click", ()=> el(x.getAttribute("data-close")).style.display="none");
});
document.querySelectorAll(".modalOverlay").forEach(ov=>{
  ov.addEventListener("click",(e)=>{ if(e.target===ov) ov.style.display="none"; });
});

function openModal(id){ el(id).style.display="flex"; }

/* ===== Pills ===== */
function refreshPills(){
  el("pillVoice").className="miPill " + (cfg.voiceOn?"pillOn":"pillOff");
  el("pillVoice").textContent = cfg.voiceOn ? "on":"off";

  el("pillLearning").className="miPill " + (cfg.learningOn?"pillOn":"pillOff");
  el("pillLearning").textContent = cfg.learningOn ? "on":"off";

  el("pillFaith").className="miPill " + (faith==="None" ? "pillNone":"pillOpen");
  el("pillFaith").textContent = (faith||"none").toLowerCase();
}
refreshPills();

/* ===== Menu actions ===== */
el("miVoice").onclick=()=>{ cfg.voiceOn=!cfg.voiceOn; safeSave(KEY_CFG,cfg); refreshPills(); };
el("miLearning").onclick=()=>{ cfg.learningOn=!cfg.learningOn; safeSave(KEY_CFG,cfg); refreshPills(); };

el("miIntel").onclick=()=>{ renderIntel(); openModal("modalIntel"); };
el("miFeed").onclick=()=>{ el("seedHint").textContent=""; openModal("modalSeed"); };
el("miFaith").onclick=()=>{ renderFaithButtons(); openModal("modalFaith"); };
el("miIdentity").onclick=()=>{ el("identityArea").value = identity || ""; openModal("modalIdentity"); };
el("miLLM").onclick=()=>{ openModal("modalLLM"); };
el("miBM").onclick=()=>{ renderBMList(); el("bmViewer").style.display="none"; openModal("modalBM"); };
el("miHistory").onclick=()=>{ renderHistory(); openModal("modalHistory"); };

/* ===== Conversation log ===== */
function logLine(role, text){
  const div=document.createElement("div");
  div.className="line "+(role==="YOU"?"you":"aura");
  div.innerHTML=`<span class="ts">[${nowTS()}]</span> <b>${role}:</b> ${escapeHTML(text)}`;
  consoleBox.appendChild(div);
  consoleBox.scrollTop = consoleBox.scrollHeight;
}

/* ===== Voice ===== */
function speak(text){
  try{
    if(!cfg.voiceOn) return;
    if(!("speechSynthesis" in window)) return;
    window.speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(String(text||""));
    u.rate=1; u.pitch=1; u.volume=1;
    // prefer English voice if available
    const voices = window.speechSynthesis.getVoices?.() || [];
    const v = voices.find(x=>/en/i.test(x.lang)) || voices[0];
    if(v) u.voice = v;
    window.speechSynthesis.speak(u);
  }catch(e){}
}
try{ window.speechSynthesis.getVoices?.(); }catch(e){}

/* ===== TM history decay ===== */
function pruneHistory(){
  const now=Date.now();
  const maxAge = cfg.decayHours*3600*1000;
  hist = hist.filter(x => (now - x.t) <= maxAge);
  safeSave(KEY_HIST, hist);
}
function addHist(role,text){
  pruneHistory();
  hist.push({role,text,t:Date.now()});
  safeSave(KEY_HIST, hist);
}

/* ===== Continuity numbers ===== */
let TM=0.00, BMv=0.00, C=0.85, E0=0.0;
function compute(){
  // simple stable continuity core
  const R = (TM*0.45) + (BMv*0.55);
  const I_TM = TM*0.25;
  const I_intel = Math.min(0.35, intelligence.length*0.002);
  const I_llm = 0.00; // placeholder
  const D = 0.06;
  const lam_faith = (faith && faith!=="None") ? 0.06 : 0.0;
  const lam_sys = 0.04;
  const lam_trc = 0.04;
  const x = R + I_TM + I_intel + I_llm - D + lam_faith + lam_sys + lam_trc;
  E0 = Math.tanh(x);
  statE0.textContent = "E0: " + E0.toFixed(3);
  statTM.textContent = "TM: " + TM.toFixed(2);
  statBM.textContent = "BM: " + BMv.toFixed(2);
  statC.textContent  = "C: " + C.toFixed(3);
}

/* ===== Intelligence matching ===== */
function findIntel(q){
  const nq=norm(q);
  if(!nq) return null;

  // exact/contains + overlap score
  let best=null, bestScore=0;
  for(const it of intelligence){
    const iq=norm(it.q);
    if(!iq) continue;
    let s=0;
    if(nq===iq) s=12;
    else{
      if(nq.includes(iq) || iq.includes(nq)) s=7;
      const a=new Set(nq.split(" "));
      const b=new Set(iq.split(" "));
      let inter=0;
      for(const w of a){ if(b.has(w)) inter++; }
      s+=inter;
    }
    if(s>bestScore){ bestScore=s; best=it; }
  }
  return bestScore>=3 ? best : null;
}

/* ===== Learning correction flow ===== */
let correction = null; // {q, awaitingCorrect, awaitingConfirm, correct}
function correctionStep(userText){
  if(!correction) return null;
  const t=norm(userText);

  if(t==="incorrect" && !correction.awaitingCorrect && !correction.awaitingConfirm){
    correction.awaitingCorrect=true;
    return "Okay. Please type the correct answer for that question.";
  }
  if(correction.awaitingCorrect && !correction.awaitingConfirm){
    const correct=userText.trim();
    if(!correct) return "Please type the correct answer.";
    correction.correct=correct;
    correction.awaitingCorrect=false;
    correction.awaitingConfirm=true;
    return "Save this learned answer? Reply: yes / no";
  }
  if(correction.awaitingConfirm){
    if(t==="yes" || t==="y"){
      intelligence.unshift({
        q: correction.q,
        a: correction.correct,
        locked: true,
        approvedAt: Date.now()
      });
      safeSave(KEY_INT, intelligence);
      correction=null;
      return "Saved locally. ‚úÖ";
    }
    if(t==="no" || t==="n"){
      correction=null;
      return "Not saved.";
    }
    return "Please reply yes or no.";
  }
  return null;
}

/* ===== Seed parsing & saving ===== */
let parsedSeed=[];
function parseSeed(txt){
  // Supports:
  // 1) LaTeX style: \item Q ... \textbf{A:} Answer
  // 2) Simple lines: Q: ... \n A: ...
  parsedSeed=[];
  const lines=String(txt||"").split("\n");
  let curQ=null, curA=null;

  for(const raw of lines){
    const l=raw.trim();
    if(l.startsWith("\\item")){
      if(curQ && curA) parsedSeed.push({q:curQ,a:curA});
      curQ = l.replace(/^\\item\s*/,"").trim();
      curA = null;
    }else if(l.includes("\\textbf{A:}")){
      curA = l.split("\\textbf{A:}")[1].trim();
    }else if(/^q\s*:/i.test(l)){
      if(curQ && curA) parsedSeed.push({q:curQ,a:curA});
      curQ = l.replace(/^q\s*:/i,"").trim();
      curA = null;
    }else if(/^a\s*:/i.test(l)){
      curA = l.replace(/^a\s*:/i,"").trim();
    }else{
      // multiline answer continuation
      if(curA!==null && l) curA += " " + l;
    }
  }
  if(curQ && curA) parsedSeed.push({q:curQ,a:curA});
  return parsedSeed;
}
el("btnSeedParse").onclick=()=>{
  const out=parseSeed(el("seedArea").value||"");
  el("seedHint").textContent = out.length ? `Parsed ${out.length} Q/A items.` : "No valid items found.";
};
el("btnSeedSave").onclick=()=>{
  const txt=el("seedArea").value||"";
  const out = parsedSeed.length ? parsedSeed : parseSeed(txt);
  if(!out.length){
    el("seedHint").textContent="Parse first (or paste valid Q/A).";
    return;
  }
  for(const it of out){
    intelligence.unshift({
      q: it.q,
      a: it.a,
      locked: true,
      approvedAt: Date.now()
    });
  }
  safeSave(KEY_INT, intelligence);
  el("seedArea").value="";
  parsedSeed=[];
  el("seedHint").textContent="Saved to Intelligence (locked). ‚úÖ";
};
el("btnSeedDiscard").onclick=()=>{
  el("seedArea").value="";
  parsedSeed=[];
  el("seedHint").textContent="Discarded.";
};

/* ===== Faith lens ===== */
const FAITHS=["None","Islam","Christianity","Humanism","Other / Mixed"];
function renderFaithButtons(){
  const box=el("faithButtons");
  box.innerHTML="";
  FAITHS.forEach(name=>{
    const b=document.createElement("button");
    b.className="btn btnSmall";
    b.textContent=name;
    if(faith===name) b.style.borderColor="rgba(56,189,248,.55)";
    b.onclick=()=>{
      faith=name;
      safeSave(KEY_FAITH, faith);
      refreshPills();
      el("modalFaith").style.display="none";
    };
    box.appendChild(b);
  });
}
function faithLine(){
  if(!faith || faith==="None") return "";
  return ` (encouragement ¬∑ ${faith} lens)`;
}

/* ===== Identity ===== */
el("btnIdSave").onclick=()=>{
  identity=el("identityArea").value||"";
  safeSave(KEY_ID, identity);
  el("modalIdentity").style.display="none";
};
el("btnIdClear").onclick=()=>{
  if(!confirm("Clear identity?")) return;
  if(!confirm("Final confirmation: clear now?")) return;
  identity="";
  safeSave(KEY_ID, identity);
  el("identityArea").value="";
};

/* ===== Intelligence modal (edit/export/clear) ===== */
function renderIntel(){
  el("intelHint").textContent = `Items: ${intelligence.length}`;
  el("intelArea").value = JSON.stringify(intelligence,null,2);
}
el("btnIntelSave").onclick=()=>{
  try{
    const arr=JSON.parse(el("intelArea").value||"[]");
    if(!Array.isArray(arr)) throw new Error("Not array");
    intelligence=arr;
    safeSave(KEY_INT, intelligence);
    el("intelHint").textContent="Saved.";
  }catch(e){
    el("intelHint").textContent="Invalid JSON. Not saved.";
  }
};
el("btnIntelExport").onclick=()=>{
  const blob=new Blob([JSON.stringify(intelligence,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="AURA_Intelligence.json";
  a.click();
  URL.revokeObjectURL(a.href);
};
el("btnIntelClear").onclick=()=>{
  if(!confirm("Clear learned intelligence?")) return;
  if(!confirm("Final confirmation: clear now?")) return;
  intelligence=[];
  safeSave(KEY_INT, intelligence);
  renderIntel();
};

/* ===== BM rules ===== */
function maybeSaveBMFromUser(text){
  if(!cfg.learningOn) return;
  const t=String(text||"").trim();
  if(t.length < cfg.bmMinChars) return;

  // Save prompt into BM as locked by default
  bm.unshift({
    id: "bm_"+Date.now()+"_"+Math.random().toString(16).slice(2),
    date: ymd(),
    title: (t.length>44 ? (t.slice(0,44)+"‚Ä¶") : t),
    text: t,
    locked: true,
    files: []
  });
  safeSave(KEY_BM,bm);
}

/* ===== BM Modal: list + filter + viewer + files ===== */
let bmFilterDate="";
let activeBMIndex=-1;

function renderBMList(){
  const list=el("bmList");
  list.innerHTML="";
  const items = bmFilterDate ? bm.filter(x=>x.date===bmFilterDate) : bm;

  if(!items.length){
    list.innerHTML = `<div class="hint">No BM items for this date.</div>`;
    return;
  }
  items.forEach(item=>{
    const realIndex = bm.findIndex(x=>x.id===item.id);
    const hasFiles = item.files && item.files.length;

    const div=document.createElement("div");
    div.className="bmItem";
    div.innerHTML = `
      <div class="bmTitle">${escapeHTML(item.title||"BM")}</div>
      <div class="bmMeta">${escapeHTML(item.date||"")} ¬∑
        ${item.locked?'<span class="badge lock">locked</span>':''}
        ${hasFiles?`<span class="badge file">${item.files.length} file</span>`:''}
      </div>
    `;
    div.onclick=()=>openBMItem(realIndex);
    list.appendChild(div);
  });
}

el("btnBMFilter").onclick=()=>{
  bmFilterDate = el("bmDateFilter").value || "";
  renderBMList();
  el("bmViewer").style.display="none";
};
el("btnBMShowAll").onclick=()=>{
  bmFilterDate="";
  el("bmDateFilter").value="";
  renderBMList();
  el("bmViewer").style.display="none";
};
el("btnBMExport").onclick=()=>{
  const blob=new Blob([JSON.stringify(bm,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="AURA_BM.json";
  a.click();
  URL.revokeObjectURL(a.href);
};
el("btnBMClear").onclick=()=>{
  if(!confirm("Clear ALL BM items?")) return;
  if(!confirm("Final confirmation: clear now?")) return;
  bm=[];
  safeSave(KEY_BM,bm);
  renderBMList();
  el("bmViewer").style.display="none";
};

async function renderBMFiles(idx){
  const item=bm[idx];
  const box=el("bmFiles");
  box.innerHTML="";
  const files = (item && Array.isArray(item.files)) ? item.files : [];
  if(!files.length){
    box.innerHTML = `<div class="hint">No evidence files attached.</div>`;
    return;
  }
  for(const fid of files){
    const rec = await dbGet(fid);
    if(!rec) continue;

    const row=document.createElement("div");
    row.className="fileRow";
    const isImg=rec.type.startsWith("image/");
    const isVid=rec.type.startsWith("video/");
    const isAud=rec.type.startsWith("audio/");

    row.innerHTML = `
      <div class="fileName">${escapeHTML(rec.name)} <span class="fileType">(${escapeHTML(rec.type)})</span></div>
      <div class="fileActions">
        <button class="btn btnSmall" data-open>Open</button>
        <button class="btn btnSmall danger" data-del>Delete</button>
      </div>
      <div class="filePreview"></div>
    `;
    const preview=row.querySelector(".filePreview");
    row.querySelector("[data-open]").onclick=()=>{
      preview.innerHTML="";
      if(isImg){
        const img=document.createElement("img");
        img.src=rec.dataURL;
        img.style.maxWidth="100%";
        img.style.borderRadius="12px";
        preview.appendChild(img);
      }else if(isVid){
        const v=document.createElement("video");
        v.src=rec.dataURL; v.controls=true;
        v.style.maxWidth="100%"; v.style.borderRadius="12px";
        preview.appendChild(v);
      }else if(isAud){
        const a=document.createElement("audio");
        a.src=rec.dataURL; a.controls=true;
        a.style.width="100%";
        preview.appendChild(a);
      }else{
        const a=document.createElement("a");
        a.href=rec.dataURL; a.download=rec.name;
        a.textContent="Download file";
        preview.appendChild(a);
      }
    };
    row.querySelector("[data-del]").onclick=async()=>{
      if(!confirm("Delete this attached file?")) return;
      if(!confirm("Final confirmation: delete now?")) return;
      await dbDel(rec.id);
      item.files = (item.files||[]).filter(x=>x!==rec.id);
      safeSave(KEY_BM,bm);
      await renderBMFiles(idx);
      renderBMList();
    };

    box.appendChild(row);
  }
}

function openBMItem(idx){
  activeBMIndex=idx;
  const item=bm[idx];
  if(!item) return;

  el("bmViewer").style.display="block";
  el("bmTitle").textContent = item.title || "BM Prompt";
  el("bmMeta").textContent = `Date: ${item.date||""} ¬∑ ${item.locked?"Locked":"Unlocked"}`;
  el("bmLockIcon").textContent = item.locked ? "üîí" : "üîì";

  el("bmTextArea").value = item.text || "";
  el("bmTextArea").readOnly = true;

  // buttons
  el("btnBMUnlock").style.display = item.locked ? "inline-block" : "none";

  renderBMFiles(idx);
}

el("btnBMUnlock").onclick=()=>{
  const item=bm[activeBMIndex];
  if(!item) return;
  if(!confirm("Unlock this BM prompt?")) return;
  if(!confirm("Final confirmation: unlock now?")) return;
  item.locked=false;
  safeSave(KEY_BM,bm);
  openBMItem(activeBMIndex);
  renderBMList();
};

el("btnBMCopy").onclick=()=>{
  const item=bm[activeBMIndex];
  navigator.clipboard?.writeText(item?.text||"");
};

el("btnBMSendToInput").onclick=()=>{
  const item=bm[activeBMIndex];
  if(!item) return;
  userInput.value = item.text || "";
  el("modalBM").style.display="none";
  userInput.focus();
};

el("btnBMDelete").onclick=()=>{
  if(activeBMIndex<0) return;
  if(!confirm("Delete this BM prompt?")) return;
  if(!confirm("Final confirmation: delete now?")) return;
  bm.splice(activeBMIndex,1);
  safeSave(KEY_BM,bm);
  activeBMIndex=-1;
  renderBMList();
  el("bmViewer").style.display="none";
};

el("btnBMAddFile").onclick=async()=>{
  const item=bm[activeBMIndex];
  if(!item) return;
  const f = el("bmFileInput").files && el("bmFileInput").files[0];
  if(!f){ alert("Choose a file first."); return; }
  const id="f_"+Date.now()+"_"+Math.random().toString(16).slice(2);
  const dataURL = await fileToDataURL(f);

  await dbPut({
    id,
    name: f.name,
    type: f.type || "application/octet-stream",
    size: f.size || 0,
    createdAt: new Date().toISOString(),
    dataURL
  });

  item.files = item.files || [];
  item.files.unshift(id);
  safeSave(KEY_BM,bm);
  el("bmFileInput").value="";
  await renderBMFiles(activeBMIndex);
  renderBMList();
};

/* ===== History modal ===== */
function renderHistory(){
  pruneHistory();
  el("histHint").textContent = `TM auto-decay: ${cfg.decayHours} hours.`;
  el("histArea").value = JSON.stringify(hist,null,2);
}
el("btnHistExport").onclick=()=>{
  const blob=new Blob([JSON.stringify(hist,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="AURA_TM_History.json";
  a.click();
  URL.revokeObjectURL(a.href);
};
el("btnHistClear").onclick=()=>{
  if(!confirm("Delete ALL conversation history?")) return;
  if(!confirm("Final confirmation: delete now?")) return;
  hist=[];
  safeSave(KEY_HIST,hist);
  el("histArea").value="[]";
  consoleBox.innerHTML="";
};

/* ===== Reply pipeline (Seed ‚Üí Intelligence ‚Üí BM recall by date ‚Üí fallback + correction) ===== */
function tryBMRecallByDate(userText){
  // If user asks: "show me 2025-01-12 memories" or includes yyyy-mm-dd
  const m = String(userText||"").match(/\b(20\d{2}-\d{2}-\d{2})\b/);
  if(!m) return null;
  const date=m[1];
  const items=bm.filter(x=>x.date===date);
  if(!items.length) return `I found 0 BM items for ${date}.`;
  const lines = items.slice(0,40).map((x,i)=>`${i+1}) ${x.text}`);
  return `BM items for ${date} (${items.length}):\n` + lines.join("\n");
}

function reply(userText){
  // 0) if correction flow is active, handle it first
  const corr = correctionStep(userText);
  if(corr) return corr;

  const t=userText.trim();
  const nt=norm(t);

  // 1) BM recall by date
  const bmRecall = tryBMRecallByDate(t);
  if(bmRecall) return bmRecall;

  // 2) built-in seed
  for(const it of SEED_QA){
    if(nt.includes(it.q)) return it.a;
  }

  // 3) intelligence
  const intelHit = findIntel(t);
  if(intelHit) return intelHit.a;

  // 4) fallback (no real LLM in this offline build)
  let out = `Prototype reply (local only). I heard: "${t}". Right now I use Seed + Intelligence + BM recall + continuity math.`;
  out += faithLine();

  // start correction flow
  if(cfg.learningOn){
    out += `\n\nIf that answer is incorrect, reply: *incorrect*.\nThen I will ask for the correct answer and store it locally.`;
    correction = {q:t, awaitingCorrect:false, awaitingConfirm:false, correct:""};
  }
  return out;
}

/* ===== Send handler ===== */
el("btnSend").onclick=send;
userInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") send(); });

function send(){
  const t=userInput.value.trim();
  if(!t) return;

  // YOU
  logLine("YOU", t);
  addHist("YOU", t);

  // update TM
  TM = clamp(TM + 0.05, 0, 1);

  // BM auto-save
  maybeSaveBMFromUser(t);

  // AURA
  const out = reply(t);
  logLine("AURA", out);
  addHist("AURA", out);

  // update BM value
  BMv = clamp(bm.length * 0.01, 0, 1);

  // compute
  compute();

  // speak
  speak(out);

  userInput.value="";
}

/* ===== Initial state: NO startup message ===== */
(function init(){
  pruneHistory();
  // Do NOT render old history into chat to keep main screen clean (as requested).
  // If you want to show old history, uncomment:
  // hist.forEach(x=>logLine(x.role, x.text));

  compute();
  refreshPills();
  safeSave(KEY_CFG,cfg);
  safeSave(KEY_INT,intelligence);
  safeSave(KEY_BM,bm);
  safeSave(KEY_HIST,hist);
  safeSave(KEY_ID,identity);
  safeSave(KEY_FAITH,faith);
})();

/* ===== Open BM now from menu ===== */
function renderBMList(){
  const list=el("bmList");
  list.innerHTML="";
  const items = bmFilterDate ? bm.filter(x=>x.date===bmFilterDate) : bm;
  if(!items.length){
    list.innerHTML=`<div class="hint">No BM items for this date.</div>`;
    return;
  }
  items.forEach(item=>{
    const idx=bm.findIndex(x=>x.id===item.id);
    const hasFiles=item.files && item.files.length;
    const div=document.createElement("div");
    div.className="bmItem";
    div.innerHTML=`
      <div class="bmTitle">${escapeHTML(item.title||"BM")}</div>
      <div class="bmMeta">${escapeHTML(item.date||"")} ¬∑
        ${item.locked?'<span class="badge lock">locked</span>':''}
        ${hasFiles?`<span class="badge file">${item.files.length} file</span>`:''}
      </div>
    `;
    div.onclick=()=>openBMItem(idx);
    list.appendChild(div);
  });
}
</script>
</body>
</html>