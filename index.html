<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© v1 ‚Äì Emotional Continuity Prototype (Scientific UI)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ================= STYLES (From Part 1) ================= */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }
    .app {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Header */
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .title-block h1 {
      font-size: 1.4rem;
      letter-spacing: 0.08em;
    }
    .title-block p {
      font-size: 0.7rem;
      opacity: 0.8;
      line-height: 1.2;
    }
    .mode-pill {
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid #38bdf8;
      font-size: 0.63rem;
      text-align: right;
      background: #020617;
    }
    .mode-pill span { display: block; }
    .mode-pill .mode-label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.9;
    }
    .mode-pill .mode-sub {
      color: #22c55e;
      font-weight: 500;
    }
    .mode-pill .engine { opacity: 0.6; }

    /* Top buttons (one line) */
    .top-buttons {
      display: flex;
      flex-wrap: nowrap;
      gap: 6px;
      margin-top: 4px;
    }
    .pill-btn {
      flex: 1;
      border-radius: 999px;
      padding: 8px 6px;
      border: 1px solid #4b5563;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s, border-color 0.15s;
      min-width: 0;
      white-space: nowrap;
    }
    .pill-btn span.icon { font-size: 0.95rem; }
    .pill-btn.primary {
      border-color: #f59e0b;
      background: #111827;
    }
    .pill-btn:hover {
      transform: translateY(-1px);
      border-color: #facc15;
    }

    /* Cards */
    .card {
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px solid rgba(148,163,184,0.5);
      background: radial-gradient(circle at top left, #111827 0, #020617 55%, #020617 100%);
      font-size: 0.8rem;
      line-height: 1.4;
    }
    .card.golden {
      background: radial-gradient(circle at top left, #374151 0, #020617 55%, #020617 100%);
      border-color: #fbbf24;
      color: #fde68a;
      font-weight: 500;
    }
    .card.equation {
      border-style: dashed;
      background: radial-gradient(circle at top left, #020617 0, #020617 60%, #000 100%);
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.75rem;
    }
    .card.equation .label {
      opacity: 0.9;
      margin-bottom: 4px;
      font-weight: 600;
      letter-spacing: 0.06em;
    }
    .card.equation .formula-main {
      margin: 4px 0 6px;
      color: #e5e7eb;
    }
    .card.equation .formula-values { opacity: 0.85; }

    /* Chat area */
    .chat-area {
      flex: 1;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.5);
      background: #020617;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 140px;
    }

    /* Reaction banner with polarity % */
    .reaction-banner {
      display: none;
      border-radius: 12px;
      padding: 6px 8px;
      font-size: 0.75rem;
      line-height: 1.3;
      border: 1px solid rgba(148,163,184,0.7);
      background: #020617;
    }
    .reaction-banner strong {
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 0.7rem;
    }
    .reaction-positive {
      border-color: #22c55e;
      color: #bbf7d0;
    }
    .reaction-negative {
      border-color: #ef4444;
      color: #fecaca;
    }
    .reaction-neutral {
      border-color: #eab308;
      color: #fef9c3;
    }
    .polarity-line {
      font-size: 0.72rem;
      margin-top: 2px;
    }
    .polarity-pos {
      color: #22c55e;
      font-weight: 600;
    }
    .polarity-neg {
      color: #ef4444;
      font-weight: 600;
    }
    .polarity-mixed {
      color: #6b7280;
      font-weight: 500;
    }

    .chat-log {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 0.8rem;
      scroll-behavior: smooth;
    }
    .msg { margin-bottom: 8px; }
    .msg-user { text-align: right; color: #bfdbfe; }
    .msg-bot { text-align: left; color: #e5e7eb; }

    .status-line {
      font-size: 0.7rem;
      opacity: 0.7;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }
    .input-row textarea {
      flex: 1;
      resize: none;
      min-height: 40px;
      max-height: 80px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      padding: 8px 12px;
      font-size: 0.8rem;
    }
    .input-row textarea:focus {
      outline: none;
      border-color: #22c55e;
    }
    .send-btn {
      border-radius: 999px;
      padding: 10px 16px;
      border: none;
      background: #16a34a;
      color: white;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 0 0 1px rgba(22,163,74,0.6);
      transition: transform 0.1s, box-shadow 0.1s, background 0.1s;
    }
    .send-btn:active {
      transform: translateY(1px);
      box-shadow: 0 0 0 1px rgba(22,163,74,0.8);
      background: #15803d;
    }

    .footer-line {
      font-size: 0.7rem;
      opacity: 0.65;
      margin-top: 2px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* Voice toggle */
    .voice-toggle {
      border-radius: 999px;
      padding: 3px 10px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.7rem;
      cursor: pointer;
    }
    .voice-toggle.active {
      border-color: #22c55e;
      color: #bbf7d0;
    }

    /* Demo buttons bottom */
    .bottom-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    .demo-btn {
      flex: 1;
      border-radius: 999px;
      padding: 10px 14px;
      border: none;
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-weight: 500;
      color: #f9fafb;
    }
    .demo-btn.negative { background: #b91c1c; }
    .demo-btn.positive { background: #15803d; }
    .demo-btn span { font-size: 1rem; }

    /* Modals shared */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }
    .modal {
      width: 100%;
      max-width: 480px;
      max-height: 80vh;
      background: #020617;
      border-radius: 20px;
      border: 1px solid #4b5563;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .modal-title {
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .modal-close {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.75rem;
      cursor: pointer;
      background: #111827;
      color: #e5e7eb;
    }
    .modal-body {
      flex: 1;
      overflow-y: auto;
      font-size: 0.78rem;
    }

    /* BM Viewer styles */
    .bm-day {
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(55,65,81,0.7);
      padding-bottom: 6px;
    }
    .bm-day-title {
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 0.8rem;
      color: #e5e7eb;
    }
    .bm-node {
      margin-bottom: 8px;
      padding: 6px 8px;
      border-radius: 12px;
      background: #020617;
      border: 1px solid #374151;
    }
    .bm-node-title {
      font-weight: 500;
      margin-bottom: 2px;
    }
    .bm-node-meta {
      font-size: 0.7rem;
      opacity: 0.85;
      margin-bottom: 3px;
    }
    .bm-node-polarity {
      font-size: 0.7rem;
      margin-bottom: 4px;
    }
    .layer-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 4px;
    }
    .layer-chip {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 0.65rem;
      color: #020617;
      font-weight: 600;
    }
    .L1 { background: #60a5fa; }
    .L2 { background: #fb7185; }
    .L3 { background: #f97316; }
    .L4 { background: #a855f7; }
    .L5 { background: #22c55e; }
    .L6 { background: #eab308; }
    .L7 { background: #e5e7eb; }

    .delete-day-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.7rem;
      cursor: pointer;
      background: #7f1d1d;
      color: #fee2e2;
      margin-left: auto;
      display: block;
      margin-top: 4px;
    }

    /* Recall modal */
    .recall-search { margin-bottom: 6px; }
    .recall-search input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      padding: 6px 10px;
      font-size: 0.78rem;
    }
    .recall-node {
      border-radius: 12px;
      border: 1px solid #374151;
      padding: 6px 8px;
      margin-bottom: 6px;
      background: #020617;
    }
    .copy-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.7rem;
      cursor: pointer;
      background: #1d4ed8;
      color: #e5e7eb;
      margin-top: 4px;
    }

    /* Options modal */
    .option-section-title {
      font-weight: 600;
      font-size: 0.8rem;
      margin: 6px 0 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.9;
    }
    .faith-note {
      font-size: 0.74rem;
      opacity: 0.8;
      margin-bottom: 6px;
    }
    .faith-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }
    .faith-pill {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      padding: 5px 10px;
      font-size: 0.73rem;
      cursor: pointer;
      color: #e5e7eb;
    }
    .faith-pill.active {
      background: #0f172a;
      border-color: #22c55e;
      color: #bbf7d0;
      font-weight: 500;
    }

    .option-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .option-row span { font-size: 0.78rem; }

    .toggle {
      position: relative;
      width: 38px;
      height: 20px;
    }
    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #374151;
      transition: .2s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .2s;
      border-radius: 50%;
    }
    input:checked + .slider { background-color: #22c55e; }
    input:checked + .slider:before { transform: translateX(18px); }

    .llm-list {
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 12px;
      border: 1px solid #374151;
      background: #020617;
      font-size: 0.74rem;
    }
    .llm-list ul { padding-left: 18px; margin: 4px 0; }
    .llm-list li { margin-bottom: 2px; }

    .llm-select-row {
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.78rem;
    }
    #llmSelect {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      padding: 4px 10px;
      font-size: 0.78rem;
    }
    .options-footer-note {
      margin-top: 6px;
      font-size: 0.72rem;
      opacity: 0.75;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #020617; }
    ::-webkit-scrollbar-thumb { background: #374151; border-radius: 999px; }
    ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
  </style>
</head>
<body>
  <div class="app">
    <div class="header-top">
      <div class="title-block">
        <h1>AURA-X Œ©</h1>
        <p>EMOTIONAL CONTINUITY ¬∑ AEC ¬∑ CRM ¬∑ AECN ¬∑ RL¬≥ ¬∑ LR¬≥</p>
      </div>
      <div class="mode-pill" id="modePill">
        <span class="mode-label">MODE: OFFLINE PROTOTYPE</span>
        <span class="mode-sub">Universal Ethics ¬∑ Local BM</span>
        <span class="engine">Engine: Seed (local)</span>
      </div>
    </div>

    <div class="top-buttons">
      <button class="pill-btn" id="bmViewerBtn">
        <span class="icon">üß†</span><span>BM Viewer</span>
      </button>
      <button class="pill-btn primary" id="recallBtn">
        <span class="icon">üìÇ</span><span>Recall BM</span>
      </button>
      <button class="pill-btn" id="cleanupBtn">
        <span class="icon">‚ôªÔ∏è</span><span>Cleanup 24h</span>
      </button>
      <button class="pill-btn" id="optionsBtn">
        <span class="icon">üîò</span><span>Options</span>
      </button>
    </div>

    <div class="card golden" id="ethicsBanner">
      Avoid actions that generate negative emotions in yourself or others.
      Gently move toward choices that create calm, kindness, and positive feelings.
    </div>

    <div class="card equation" id="equationCard">
      <div class="label">EMOTIONAL CONTINUITY EQUATION</div>
      <div class="formula-main" id="eqMain">
        E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)
      </div>
      <div class="formula-values" id="eqValues">
        E‚ÇÄ = 0.00 ¬∑ TM = 0.35 ¬∑ BM = 0.55 ¬∑ D = 0.00 ¬∑ Œ£C‚Çú = 0.05 ¬∑ Œª_faith = 0.00 ¬∑ Œª_sys = 0.02
      </div>
    </div>

    <div class="chat-area">
      <div id="reactionBanner" class="reaction-banner"></div>

      <div class="chat-log" id="chatLog"></div>

      <div class="status-line" id="statusLine">
        E‚ÇÄ=0.00 ¬∑ TM=0.35 ¬∑ D=0.00 ¬∑ tag=neutral
      </div>

      <div class="input-row">
        <textarea id="userInput"
          placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."></textarea>
        <button class="send-btn" id="sendBtn">Send</button>
      </div>

      <div class="footer-line">
        <span>Prototype ¬∑ TM ‚Üí Emotional Engine ‚Üí BM ¬∑ Equation live.</span>
        <span>Engine: <span id="engineStatusFooter">Seed (local)</span></span>
        <button id="voiceToggle" class="voice-toggle active">üîä Voice: On</button>
      </div>
    </div>

    <div class="bottom-row">
      <button class="demo-btn negative" id="dogDemoBtn">
        <span>üêí</span> Dog Bite (Negative Demo)
      </button>
      <button class="demo-btn positive" id="childDemoBtn">
        <span>‚ù§Ô∏è</span> Lost Child (Positive Demo)
      </button>
    </div>
  </div>

  <div class="modal-backdrop" id="bmModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>üß†</span> Bold Memory (BM)</div>
        <button class="modal-close" data-close="bmModalBackdrop">Close</button>
      </div>
      <div class="modal-body" id="bmModalBody"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="recallModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>üìÇ</span> Recall from BM</div>
        <button class="modal-close" data-close="recallModalBackdrop">Close</button>
      </div>
      <div class="modal-body">
        <div class="recall-search">
          <input id="recallSearchInput"
            placeholder='Search all BM layers by keyword (e.g., "snow", "mother", "court", "hope").' />
        </div>
        <div id="recallList"></div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="optionsModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>üîò</span> AURA-X Œ© options</div>
        <button class="modal-close" data-close="optionsModalBackdrop">Close</button>
      </div>
      <div class="modal-body">
        <div class="option-section-title">FAITH LENS (OPTIONAL)</div>
        <div class="faith-note">
          Universal ethics are always active. You can optionally pick a faith lens to shape
          encouragement lines locally. Nothing is sent to any external server from this frontend.
        </div>
        <div class="faith-row" id="faithRow">
          <button class="faith-pill" data-faith="None">None</button>
          <button class="faith-pill" data-faith="Islam">Islam</button>
          <button class="faith-pill" data-faith="Christianity">Christianity</button>
          <button class="faith-pill" data-faith="Hinduism">Hinduism</button>
          <button class="faith-pill" data-faith="Buddhism">Buddhism</button>
          <button class="faith-pill" data-faith="Sikhism">Sikhism</button>
          <button class="faith-pill" data-faith="Judaism">Judaism</button>
          <button class="faith-pill" data-faith="Atheism / Humanism">Atheism / Humanism</button>
          <button class="faith-pill" data-faith="Other / Mixed">Other / Mixed</button>
        </div>

        <div class="option-section-title">Engine mode</div>
        <div class="faith-note">
          Seed-only (offline) or Live emotional reactor (via your backend).
        </div>
        <div class="option-row">
          <span>Current: <span id="engineModeLabel">Seed-only. Everything runs locally.</span></span>
          <label class="toggle">
            <input type="checkbox" id="engineModeToggle" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="llm-list">
          <div><strong>Example models your backend could use:</strong></div>
          <ul>
            <li>OpenAI ‚Äì GPT-4.1 / GPT-4o</li>
            <li>Anthropic ‚Äì Claude 3.5 Sonnet / Opus</li>
            <li>Google ‚Äì Gemini 1.5 Pro</li>
            <li>Mistral ‚Äì Mistral Large</li>
          </ul>
          <div class="llm-select-row">
            <span>Preferred LLM:</span>
            <select id="llmSelect">
              <option value="openai-gpt4o">OpenAI ¬∑ GPT-4o</option>
              <option value="google-gemini15pro">Google ¬∑ Gemini 1.5 Pro</option>
              <option value="anthropic-claude35s">Anthropic ¬∑ Claude 3.5 Sonnet</option>
            </select>
          </div>
        </div>

        <div class="option-section-title">Prototype controls</div>
        <div class="option-row">
          <span>Auto-summarize long conversations</span>
          <label class="toggle">
            <input type="checkbox" id="autoSummarizeToggle" checked />
            <span class="slider"></span>
          </label>
        </div>
        <div class="option-row">
          <span>Ignore tiny small-talk as BM</span>
          <label class="toggle">
            <input type="checkbox" id="ignoreSmallTalkToggle" checked />
            <span class="slider"></span>
          </label>
        </div>
        <div class="option-row">
          <span>Clear last 24h BM</span>
          <button class="pill-btn negative-btn" id="clear24hBtn" style="border-color:#ef4444; background:#450a0a;">‚ôªÔ∏è Clear 24h</button>
        </div>
        <div class="option-row">
          <span>Delete FULL Life (All BM)</span>
          <button class="pill-btn negative-btn" id="clearAllBtn" style="border-color:#ef4444; background:#450a0a;">Delete All</button>
        </div>

        <div class="options-footer-note">
          About AURA-X Œ©: Designed around the idea that emotions are continuity functions.
          This page is an offline scientific demo.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== LocalStorage keys & constants =====
    const lsKey      = "auraX_bm_v31";
    const faithKey   = "auraX_faithLens";
    const engineKey  = "auraX_engineMode";
    const llmKey     = "auraX_llmChoice";

    const smallTalkPatterns = [
      "hi","hello","hey","salam","assalamualaikum",
      "how are you","kia hal hai","kese ho","how r u"
    ];
    const abuseWords = [
      "fuck","fucking","fucked","lanat","laanat","haramzada",
      "bastard","bitch","bitches","bloody","kutte","kutta","kutiya",
      "chutiya","stupid","idiot","gadha","gandi zuban","shut up","chup",
      "bakwas","bakwass","zalil","zaleel","cursed"
    ];
    const duaWords = [
      "dua","prayer","pray for me","make dua","dua karo","dua karna",
      "istighfar","astaghfirullah"
    ];
    const shukrWords = [
      "shukr","shukar","thanks","thank you","alhamdulillah","grateful","gratitude"
    ];
    const tawakkulWords = [
      "tawakkul","tawakkal","trust in allah","allah par bharosa","allah pe bharosa"
    ];
    const loveSeedWords = [
      "i love you","love you","pyaar","pyar","mohabbat",
      "i care about you","miss you","hug","embrace"
    ];
    const empathyWords = [
      "feel sorry for you","sorry for you","may allah ease",
      "may allah make it easy","allah apko ajar de",
      "i am with you","i understand your pain","may god help you"
    ];

    function loadBM() {
      try {
        const raw = localStorage.getItem(lsKey);
        return raw ? JSON.parse(raw) : {};
      } catch { return {}; }
    }
    function saveBM(data) { localStorage.setItem(lsKey, JSON.stringify(data)); }
    function todayKey() { return new Date().toISOString().slice(0,10); }
    function tanh(x){ const e2x=Math.exp(2*x); return (e2x-1)/(e2x+1); }

    function isMostlySmallTalk(text){
      const clean=text.toLowerCase().trim();
      if (clean.length>80) return false;
      return smallTalkPatterns.some(p=>clean===p||clean.startsWith(p+" "));
    }
    function containsAny(lower, arr){ return arr.some(w => lower.includes(w)); }
    function countAny(lower, arr){ return arr.reduce((c,w)=> c + (lower.includes(w)?1:0), 0); }
    
    function analyseContent(text){
      const lower = text.toLowerCase();
      const abuseCount = countAny(lower, abuseWords);
      const posSeedCount =
        countAny(lower, loveSeedWords) +
        countAny(lower, shukrWords) +
        countAny(lower, tawakkulWords) +
        countAny(lower, empathyWords);
      const total = abuseCount + posSeedCount;
      const sentiment = total ? (posSeedCount - abuseCount) / total : 0;
      
      return {
        isAbuse: abuseCount > 0,
        hasDua: containsAny(lower, duaWords),
        hasShukr: containsAny(lower, shukrWords),
        hasLove: containsAny(lower, loveSeedWords),
        hasEmpathy: containsAny(lower, empathyWords),
        hasTawakkul: containsAny(lower, tawakkulWords),
        hasFaithSeed: containsAny(lower, duaWords) || containsAny(lower, tawakkulWords),
        positiveSeed: posSeedCount > 0,
        abuseCount,
        posSeedCount,
        sentiment
      };
    }

    // ===== State =====
    let TM=0.35, BMvalue=0.55, D=0.0, Csum=0.05;
    let lambdaFaith=0.0;
    const lambdaSys=0.02;
    let E0=0.0;

    let engineMode = localStorage.getItem(engineKey) || "seed";
    let llmChoice  = localStorage.getItem(llmKey) || "openai-gpt4o";
    let autoSummarize = true;
    let ignoreSmallTalkFlag = true;
    let autoVoice = true;

    // UI Elements
    const chatLogEl=document.getElementById("chatLog");
    const statusLineEl=document.getElementById("statusLine");
    const eqMainEl=document.getElementById("eqMain");
    const eqValuesEl=document.getElementById("eqValues");
    const userInputEl=document.getElementById("userInput");
    const modePill=document.getElementById("modePill");
    const reactionBannerEl=document.getElementById("reactionBanner");
    const voiceToggleEl=document.getElementById("voiceToggle");
    const engineStatusFooter=document.getElementById("engineStatusFooter");
    const engineModeToggle=document.getElementById("engineModeToggle");
    const engineModeLabel=document.getElementById("engineModeLabel");
    const llmSelect=document.getElementById("llmSelect");
    const autoSummarizeToggle=document.getElementById("autoSummarizeToggle");
    const ignoreSmallTalkToggle=document.getElementById("ignoreSmallTalkToggle");

    // Helpers
    function getPolarityInfoFromE0(value){
      const e = value;
      let polarity;
      if (e>0.1) polarity="Positive";
      else if (e<-0.1) polarity="Negative";
      else polarity="Neutral / Mixed";

      let posPct, negPct;
      if (polarity==="Positive"){
        posPct = 50 + Math.abs(e)*50;
        negPct = 100 - posPct;
      } else if (polarity==="Negative"){
        negPct = 50 + Math.abs(e)*50;
        posPct = 100 - negPct;
      } else {
        posPct = 50;
        negPct = 50;
      }
      return {polarity, posPct:Math.round(posPct), negPct:Math.round(negPct)};
    }

    function updateEquationDisplay(){
      eqMainEl.textContent="E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)";
      eqValuesEl.textContent=
        `E‚ÇÄ = ${E0.toFixed(2)} ¬∑ TM = ${TM.toFixed(2)} ¬∑ BM = ${BMvalue.toFixed(2)} ¬∑ ` +
        `D = ${D.toFixed(2)} ¬∑ Œ£C‚Çú = ${Csum.toFixed(2)} ¬∑ Œª_faith = ${lambdaFaith.toFixed(2)} ¬∑ Œª_sys = ${lambdaSys.toFixed(2)}`;
      const tag = E0>0.1?"positive":E0<-0.1?"negative":"neutral";
      statusLineEl.textContent=
        `E‚ÇÄ=${E0.toFixed(2)} ¬∑ TM=${TM.toFixed(2)} ¬∑ D=${D.toFixed(2)} ¬∑ tag=${tag}`;
    }

    function buildReactionTone(){
      const intensity=Math.abs(E0);
      let polarity = "Neutral / Mixed";
      let cls = "reaction-neutral";

      if (E0>0.1){ polarity="Positive"; cls="reaction-positive"; }
      else if (E0<-0.1){ polarity="Negative"; cls="reaction-negative"; }

      let tone="";
      if (polarity==="Positive"){
        if (intensity>0.7) tone="Warm, expansive, high-energy encouragement.";
        else if (intensity>0.35) tone="Soft, stabilizing, hopeful resonance.";
        else tone="Light, gentle, low-amplitude positive drift.";
      } else if (polarity==="Negative"){
        if (intensity>0.7) tone="Deep, heavy, thunder-style emotional load (fear/anger).";
        else if (intensity>0.35) tone="Firm, serious, caution-oriented resonance.";
        else tone="Mild negative charge, like a faint worry or discomfort.";
      } else {
        tone="Calm, observant, analytically neutral reading.";
      }

      const perc = getPolarityInfoFromE0(E0);
      return {polarity, cls, intensity, tone, perc};
    }

    function updateReactionBanner(sourceText){
      const text = (sourceText||"").trim();
      if (!text){
        reactionBannerEl.style.display="none";
        return;
      }
      const {polarity, cls, intensity, tone, perc} = buildReactionTone();
      reactionBannerEl.className = "reaction-banner " + cls;

      const posHtml = `<span class="polarity-pos">${perc.posPct}%</span>`;
      const negHtml = `<span class="polarity-neg">${perc.negPct}%</span>`;

      reactionBannerEl.innerHTML =
        `<strong>AURA-X Œ© REACTION</strong><br>` +
        `Polarity: ${polarity} ¬∑ Intensity: ${intensity.toFixed(2)}<br>` +
        `<span class="polarity-line">Polarity ratio: ${posHtml} : ${negHtml}</span><br>` +
        `Tone: ${tone}`;

      reactionBannerEl.style.display = "block";
    }

    function appendMessage(text, who){
      const div = document.createElement("div");
      div.className = "msg " + (who === "user" ? "msg-user" : "msg-bot");
      div.textContent = text;
      chatLogEl.appendChild(div);
      chatLogEl.scrollTop = chatLogEl.scrollHeight;
    }

    // Voice
    function pickVoiceForPolarity(polarity){
      const synth = window.speechSynthesis;
      if (!synth) return {voice:null, pitch:1.0, rate:1.0};
      const voices = synth.getVoices() || [];
      if (!voices.length) return {voice:null, pitch:1.0, rate:1.0};

      let v = voices[0];
      if (polarity === "Positive"){
        v = voices.find(x => /male|david|daniel/i.test(x.name)) || v;
        return {voice:v, pitch:0.95, rate:1.0};
      } else if (polarity === "Negative"){
        v = voices.find(x => /female|zira|samantha/i.test(x.name)) || v;
        return {voice:v, pitch:1.1, rate:1.0};
      } else {
        return {voice:v, pitch:1.0, rate:1.0};
      }
    }

    function speakReply(text){
      if (!autoVoice || !("speechSynthesis" in window)) return;
      const clean = (text || "").trim();
      if (!clean) return;
      const synth = window.speechSynthesis;
      const {polarity} = buildReactionTone();
      const {voice, pitch, rate} = pickVoiceForPolarity(polarity);
      const u = new SpeechSynthesisUtterance(clean);
      if (voice) u.voice = voice;
      u.pitch = pitch;
      u.rate = rate;
      synth.cancel();
      synth.speak(u);
    }

    // Emotion Math
    function computeEmotion(strength, analysis){
      const baseFromLength = Math.min(1, 0.2 + strength/400);
      const sentiment = analysis ? (analysis.sentiment || 0) : 0;
      TM = Math.min(1, Math.max(0, baseFromLength + sentiment*0.3));

      if (analysis && analysis.isAbuse){
        D = Math.min(1, D + 0.25);
        Csum = Math.max(0, Csum - 0.03);
      } else {
        D = Math.max(0, D - 0.02);
      }

      if (analysis && (analysis.positiveSeed || analysis.hasFaithSeed)){
        Csum = Math.min(1, Csum + 0.06);
      }

      lambdaFaith = analysis && analysis.hasFaithSeed ? 0.05 : 0.0;
      BMvalue = 0.7 * BMvalue + 0.3 * TM;
      const raw = TM*BMvalue - D + lambdaFaith + lambdaSys + Csum;
      E0 = tanh(raw);
      updateEquationDisplay();
    }

    function getFaithLensStored(){ return localStorage.getItem(faithKey) || "None"; }

    function buildSeedReply(userText, analysis){
      const clean = userText.trim();
      const lower = clean.toLowerCase();
      const faith = getFaithLensStored();
      analysis = analysis || analyseContent(userText);

      if (isMostlySmallTalk(clean)){
        if (lower.includes("how are")){
          return "I‚Äôm stable and calm ‚Äî my emotional core E‚ÇÄ is around " + E0.toFixed(2) + ". How is yours?";
        }
        return "Hello. I treat even small greetings as tiny TM events, but I usually only save deeper stories into Bold Memory (BM).";
      }

      let prefix = "";
      if (faith === "Islam") prefix = "From an Islamic encouragement lens: ";
      else if (faith === "Christianity") prefix = "From a Christian lens: ";
      else if (faith !== "None") prefix = "Through your faith lens: ";

      if (analysis.isAbuse){
        return "I feel anger and harsh words in this TM. AURA-X Œ© advises against this, as it increases D (damage). Try to express your pain without attacking.";
      }
      if (analysis.hasDua || analysis.hasTawakkul){
        return prefix + "Your words carry dua and tawakkul. This lowers D and increases Œ£C‚Çú, stabilizing your long-term emotional continuity.";
      }
      if (analysis.hasShukr){
        return prefix + "There is gratitude here. Noticing blessings pulls E‚ÇÄ to the positive side and creates strong BM nodes.";
      }
      if (analysis.hasLove){
        return prefix + "This memory is soaked in love. It behaves like a warm anchor for future storms.";
      }
      if (E0 > 0.15){
        return prefix + "I‚Äôve collided your TM with BM. E‚ÇÄ ‚âà " + E0.toFixed(2) + ". The context is generating a positive continuity trace.";
      } else if (E0 < -0.15){
        return prefix + "Your TM resonates with heavier patterns. E‚ÇÄ ‚âà " + E0.toFixed(2) + ". Consider re-framing or adding supportive memories.";
      } else {
        return prefix + "The signal is balanced. E‚ÇÄ ‚âà " + E0.toFixed(2) + ". You can tilt it by adding hopeful details.";
      }
    }

    // BM Storage
    function computeLayerIntensities(analysis){
      const mag = Math.round(Math.min(1, Math.abs(E0)) * 100);
      const emoNeg = analysis && analysis.sentiment < 0 ? Math.abs(analysis.sentiment) : 0;
      const emoPos = analysis && analysis.sentiment > 0 ? analysis.sentiment : 0;

      return {
        L1: Math.round(Math.min(100, 30 + mag * 0.4)),
        L2: Math.round(Math.min(100, 10 + emoNeg * 60 + D * 40)),
        L3: Math.round(Math.min(100, 10 + mag * 0.25)),
        L4: Math.round(Math.min(100, 20 + mag * 0.3)),
        L5: Math.round(Math.min(100, 20 + emoPos * 60 + Csum * 40)),
        L6: Math.round(Math.min(100, 15 + lambdaFaith * 900)),
        L7: Math.round(Math.min(100, 5 + (1 - Math.abs(E0)) * 40))
      };
    }

    function storeBMNode(userText, analysis){
      const data = loadBM();
      const day = todayKey();
      if (!data[day]) data[day] = [];
      const timeStr = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      const layers = computeLayerIntensities(analysis);
      const polInfo = getPolarityInfoFromE0(E0);

      data[day].push({
        time: timeStr, text: userText, E0, TM, D, Csum,
        polarity: polInfo.polarity, posPct: polInfo.posPct, negPct: polInfo.negPct, layers
      });
      saveBM(data);
    }

    // Rendering
    const bmModalBackdrop = document.getElementById("bmModalBackdrop");
    const bmModalBody = document.getElementById("bmModalBody");
    const recallModalBackdrop = document.getElementById("recallModalBackdrop");
    const recallListEl = document.getElementById("recallList");
    const recallSearchInput = document.getElementById("recallSearchInput");

    function renderBMViewer(){
      const data = loadBM();
      bmModalBody.innerHTML = "";
      const days = Object.keys(data).sort().reverse();
      if (!days.length){
        bmModalBody.innerHTML = "<p style='color:#94a3b8; text-align:center; margin-top:20px;'>No Bold Memory stored yet.</p>";
        return;
      }
      days.forEach(day => {
        const dayDiv = document.createElement("div");
        dayDiv.className = "bm-day";
        const title = document.createElement("div");
        title.className = "bm-day-title";
        title.textContent = `${day} (${data[day].length} nodes)`;
        dayDiv.appendChild(title);

        data[day].forEach(node => {
          const nDiv = document.createElement("div");
          nDiv.className = "bm-node";
          const short = node.text.length > 110 ? node.text.slice(0,107) + "‚Ä¶" : node.text;
          
          nDiv.innerHTML = `
            <div class="bm-node-title">${short}</div>
            <div class="bm-node-meta">E‚ÇÄ‚âà${node.E0.toFixed(2)} ¬∑ TM=${node.TM.toFixed(2)} ¬∑ ${node.time}</div>
            <div class="bm-node-polarity">Polarity: ${node.polarity} <span class="polarity-pos">${node.posPct}</span> : <span class="polarity-neg">${node.negPct}</span></div>
          `;
          
          const chips = document.createElement("div");
          chips.className = "layer-chips";
          Object.entries(node.layers || {}).forEach(([key, val]) => {
            chips.innerHTML += `<span class="layer-chip ${key}">${key}:${val}</span>`;
          });
          nDiv.appendChild(chips);
          dayDiv.appendChild(nDiv);
        });

        const delBtn = document.createElement("button");
        delBtn.className = "delete-day-btn";
        delBtn.textContent = "Delete Day";
        delBtn.onclick = () => {
          if(confirm("Delete all memories for "+day+"?")){
            delete data[day];
            saveBM(data);
            renderBMViewer();
          }
        };
        dayDiv.appendChild(delBtn);
        bmModalBody.appendChild(dayDiv);
      });
    }

    function renderRecallList(query){
      const data = loadBM();
      recallListEl.innerHTML = "";
      const q = (query || "").toLowerCase().trim();
      const allNodes = [];
      Object.entries(data).forEach(([day, nodes]) => {
        nodes.forEach(n => allNodes.push({day, node:n}));
      });
      
      const filtered = q ? allNodes.filter(x => x.node.text.toLowerCase().includes(q)) : allNodes;
      
      if (!filtered.length){
        recallListEl.innerHTML = "<p style='color:#94a3b8; margin-top:10px;'>No matching BM found.</p>";
        return;
      }
      
      filtered.sort((a,b) => (b.day + b.node.time).localeCompare(a.day + a.node.time));
      
      filtered.slice(0, 80).forEach(item => {
        const {day, node} = item;
        const wrap = document.createElement("div");
        wrap.className = "recall-node";
        
        const head = document.createElement("div");
        head.style.fontWeight = "600";
        head.style.marginBottom = "2px";
        head.textContent = `${day} ¬∑ ${node.time}`;
        wrap.appendChild(head);
        
        // PART 2 LOGIC MERGE HERE
        const body = document.createElement("div");
        body.style.fontSize = "0.75rem";
        body.style.opacity = "0.9";
        body.textContent = node.text;
        wrap.appendChild(body);

        const copyBtn = document.createElement("button");
        copyBtn.className = "copy-btn";
        copyBtn.textContent = "Copy Text";
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(node.text);
          copyBtn.textContent = "Copied!";
          setTimeout(()=>copyBtn.textContent="Copy Text", 1500);
        };
        wrap.appendChild(copyBtn);

        recallListEl.appendChild(wrap);
      });
    }

    // ===== Main Handlers =====
    function handleUserAction(overrideText){
      const text = overrideText || userInputEl.value;
      if (!text.trim()) return;
      
      appendMessage(text, "user");
      if (!overrideText) userInputEl.value = "";

      const analysis = analyseContent(text);
      computeEmotion(text.length, analysis);
      updateReactionBanner(text);

      setTimeout(() => {
        const reply = buildSeedReply(text, analysis);
        appendMessage(reply, "bot");
        speakReply(reply);

        const isSmall = isMostlySmallTalk(text);
        if (!isSmall || !ignoreSmallTalkFlag) {
           storeBMNode(text, analysis);
        }
      }, 600);
    }

    // ===== Event Listeners =====
    document.getElementById("sendBtn").addEventListener("click", () => handleUserAction());
    userInputEl.addEventListener("keydown", (e) => {
      if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); handleUserAction(); }
    });

    // Modals
    document.getElementById("bmViewerBtn").addEventListener("click", () => {
      renderBMViewer();
      bmModalBackdrop.style.display = "flex";
    });
    document.getElementById("recallBtn").addEventListener("click", () => {
      renderRecallList("");
      recallModalBackdrop.style.display = "flex";
    });
    document.getElementById("optionsBtn").addEventListener("click", () => {
      document.getElementById("optionsModalBackdrop").style.display = "flex";
    });
    
    document.querySelectorAll("[data-close]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        document.getElementById(e.target.dataset.close).style.display = "none";
      });
    });

    // Recall Search
    recallSearchInput.addEventListener("input", (e) => renderRecallList(e.target.value));

    // Demos
    document.getElementById("dogDemoBtn").addEventListener("click", () => {
      handleUserAction("A stray dog bit me in the snow. I felt sharp pain and fear.");
    });
    document.getElementById("childDemoBtn").addEventListener("click", () => {
      handleUserAction("I saw a lost child find his mother in the market. They hugged tightly, it was beautiful.");
    });

    // Options / cleanup
    document.getElementById("cleanupBtn").addEventListener("click", () => {
       // Visual feedback only for prototype
       alert("Running 24h cleanup simulation... Optimized.");
    });
    document.getElementById("clear24hBtn").addEventListener("click", () => {
      const data = loadBM();
      const day = todayKey();
      if(data[day]) { delete data[day]; saveBM(data); alert("Today's BM cleared."); }
    });
    document.getElementById("clearAllBtn").addEventListener("click", () => {
      if(confirm("Delete ALL Bold Memory? Cannot undo.")){
        localStorage.removeItem(lsKey);
        alert("System reset.");
      }
    });
    
    // Faith selection
    const faithPills = document.querySelectorAll(".faith-pill");
    const savedFaith = getFaithLensStored();
    faithPills.forEach(p => {
      if(p.dataset.faith === savedFaith) p.classList.add("active");
      p.addEventListener("click", () => {
        faithPills.forEach(x=>x.classList.remove("active"));
        p.classList.add("active");
        localStorage.setItem(faithKey, p.dataset.faith);
      });
    });

    // Voice toggle
    voiceToggleEl.addEventListener("click", () => {
      autoVoice = !autoVoice;
      voiceToggleEl.textContent = autoVoice ? "üîä Voice: On" : "üîá Voice: Off";
      voiceToggleEl.classList.toggle("active", autoVoice);
    });

    // Engine init
    updateEquationDisplay();
    appendMessage("System Online. AURA-X Œ© v1 is ready. Share a TM event.", "bot");

  </script>
</body>
</html>
