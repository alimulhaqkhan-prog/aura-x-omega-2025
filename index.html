<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- MAIN STYLES -->
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body{
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:16px;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
    }

    .app{
      width:100%;
      max-width:1100px;
      background:rgba(15,23,42,0.96);
      border-radius:24px;
      box-shadow:0 24px 80px rgba(15,23,42,0.9);
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:16px;
      border:1px solid rgba(148,163,184,0.35);
      backdrop-filter: blur(18px);
    }

    /* HEADER */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid rgba(148,163,184,0.35);
      padding-bottom:10px;
    }

    .title-block{
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .title{
      font-size:1.4rem;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#e5e7eb;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .title-badge{
      font-size:.75rem;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(94,234,212,0.7);
      color:#a5f3fc;
      text-transform:none;
    }

    .subtitle{
      font-size:.8rem;
      color:#9ca3af;
      max-width:520px;
    }

    .ethics{
      font-size:.78rem;
      color:#facc15;
      opacity:0.9;
      font-weight:500;
    }

    .top-controls{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      min-width:210px;
    }

    .status-row{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:.75rem;
    }

    .status-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#ef4444;
      box-shadow:0 0 12px rgba(248,113,113,0.7);
    }

    .status-dot.online{
      background:#22c55e;
      box-shadow:0 0 18px rgba(34,197,94,0.9);
    }

    .status-label{
      color:#9ca3af;
    }

    .status-value{
      color:#e5e7eb;
      font-weight:500;
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:7px 14px;
      font-size:.78rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:linear-gradient(135deg,#0f766e,#22c55e);
      color:white;
      box-shadow:0 8px 30px rgba(16,185,129,0.58);
      transition:transform .15s ease, box-shadow .15s ease, filter .15s ease;
      white-space:nowrap;
    }

    .btn span.icon{
      font-size:1rem;
    }

    .btn:hover{
      transform:translateY(-1px);
      filter:brightness(1.05);
      box-shadow:0 14px 40px rgba(16,185,129,0.72);
    }

    .btn:active{
      transform:translateY(1px) scale(.97);
      box-shadow:0 4px 18px rgba(16,185,129,0.5);
    }

    .btn-secondary{
      background:rgba(15,23,42,0.7);
      border:1px solid rgba(148,163,184,0.6);
      box-shadow:none;
      color:#e5e7eb;
    }

    .btn-secondary:hover{
      filter:brightness(1.1);
      box-shadow:0 8px 30px rgba(15,23,42,0.8);
    }

    .btn-offline{
      background:linear-gradient(135deg,#059669,#10b981);
      color:white;
      margin-top:4px;
    }

    .offline-status{
      font-size:.7rem;
      color:#6ee7b7;
      margin-top:2px;
    }

    .switch-row{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:.75rem;
      color:#9ca3af;
    }

    .switch-row input{
      accent-color:#22c55e;
    }

    /* MAIN LAYOUT */
    .layout{
      display:grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.4fr);
      gap:14px;
      min-height:340px;
    }

    @media(max-width:900px){
      .layout{ grid-template-columns:1fr; }
    }

    .panel{
      background:radial-gradient(circle at top, rgba(56,189,248,0.18) 0, transparent 45%),
                 linear-gradient(160deg, rgba(15,23,42,0.98), rgba(15,23,42,0.96));
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.45);
      padding:12px 12px 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:hidden;
      position:relative;
    }

    .panel-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      font-size:.78rem;
      color:#9ca3af;
    }

    .panel-header strong{
      font-size:.8rem;
      color:#e5e7eb;
      letter-spacing:.03em;
      text-transform:uppercase;
    }

    .badge-soft{
      padding:2px 8px;
      border-radius:999px;
      background:rgba(15,23,42,0.8);
      border:1px solid rgba(148,163,184,0.6);
      font-size:.7rem;
      color:#cbd5f5;
    }

    .metrics{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:.7rem;
    }

    .metric-pill{
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.9);
      color:#9ca3af;
      display:flex;
      align-items:center;
      gap:4px;
    }

    .metric-dot{
      width:8px;
      height:8px;
      border-radius:999px;
    }
    .metric-dot.pos{ background:#22c55e; box-shadow:0 0 12px rgba(34,197,94,0.8); }
    .metric-dot.neg{ background:#ef4444; box-shadow:0 0 12px rgba(239,68,68,0.8); }
    .metric-dot.neu{ background:#facc15; box-shadow:0 0 12px rgba(250,204,21,0.8); }

    .scroll-area{
      flex:1;
      overflow-y:auto;
      padding-right:4px;
      padding-top:4px;
      scrollbar-width:thin;
      scrollbar-color:#4b5563 transparent;
      font-size:.8rem;
    }

    .scroll-area::-webkit-scrollbar{
      width:6px;
    }
    .scroll-area::-webkit-scrollbar-track{
      background:transparent;
    }
    .scroll-area::-webkit-scrollbar-thumb{
      background:rgba(55,65,81,0.8);
      border-radius:999px;
    }

    /* CHAT BUBBLES */
    .msg-row{
      display:flex;
      margin-bottom:8px;
      gap:6px;
    }
    .msg-row.user{ justify-content:flex-end; }
    .msg-row.assistant{ justify-content:flex-start; }

    .msg-bubble{
      max-width:78%;
      padding:8px 10px;
      border-radius:14px;
      font-size:.82rem;
      line-height:1.4;
      position:relative;
      border:1px solid transparent;
      word-wrap:break-word;
      white-space:pre-wrap;
    }

    .msg-bubble.user{
      background:linear-gradient(135deg,#0f766e,#22c55e);
      color:white;
      border-color:rgba(34,197,94,0.7);
      box-shadow:0 10px 32px rgba(16,185,129,0.6);
      border-bottom-right-radius:4px;
    }

    .msg-bubble.assistant{
      background:rgba(15,23,42,0.96);
      border-color:rgba(148,163,184,0.6);
      border-bottom-left-radius:4px;
    }

    .msg-meta{
      font-size:.65rem;
      color:#6b7280;
      margin-top:1px;
    }

    /* BM Events */
    .bm-event{
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.5);
      padding:8px 9px;
      margin-bottom:7px;
      background: radial-gradient(circle at 15% 0%, rgba(52,211,153,0.18) 0, transparent 45%),
                  rgba(17,24,39,0.95);
      position:relative;
      overflow:hidden;
    }

    .bm-event::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 0% 0%, rgba(52,211,153,0.14) 0, transparent 45%),
        radial-gradient(circle at 120% 120%, rgba(59,130,246,0.18) 0, transparent 55%);
      opacity:.5;
      pointer-events:none;
    }

    .bm-title{
      font-size:.72rem;
      font-weight:600;
      color:#e5e7eb;
      margin-bottom:2px;
    }

    .bm-meta{
      font-size:.65rem;
      color:#9ca3af;
      margin-bottom:4px;
    }

    .bm-body{
      position:relative;
      font-size:.78rem;
      color:#d1d5db;
      z-index:1;
    }

    /* INPUT BAR */
    .composer{
      margin-top:4px;
      padding-top:10px;
      border-top:1px solid rgba(148,163,184,0.45);
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .formula-line{
      font-family:"JetBrains Mono","SF Mono",ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:.72rem;
      color:#9ca3af;
      opacity:0.9;
      display:flex;
      justify-content:space-between;
      gap:6px;
      flex-wrap:wrap;
    }

    .formula-main{
      color:#e5e7eb;
    }

    .input-row{
      display:flex;
      gap:8px;
      align-items:flex-end;
    }

    .input-shell{
      flex:1;
      position:relative;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(148,163,184,0.7);
      padding:6px 12px;
      display:flex;
      align-items:center;
    }

    .input-shell:focus-within{
      box-shadow:0 0 0 1px rgba(96,165,250,0.9), 0 16px 40px rgba(15,23,42,0.9);
      border-color:rgba(59,130,246,0.9);
    }

    textarea#userInput{
      flex:1;
      border:none;
      outline:none;
      background:transparent;
      resize:none;
      max-height:80px;
      min-height:22px;
      font-size:.82rem;
      color:#e5e7eb;
      padding:5px 0;
    }

    textarea#userInput::placeholder{
      color:#6b7280;
    }

    .input-hint{
      position:absolute;
      right:12px;
      bottom:5px;
      font-size:.65rem;
      color:#6b7280;
    }

    /* MODAL */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.8);
      backdrop-filter:blur(18px);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:40;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
    }

    .modal-overlay.active{
      opacity:1;
      pointer-events:auto;
    }

    .modal-card{
      width:100%;
      max-width:420px;
      background:#020617;
      border-radius:20px;
      border:1px solid rgba(148,163,184,0.7);
      box-shadow:0 24px 80px rgba(15,23,42,0.95);
      padding:18px 18px 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      position:relative;
      overflow:hidden;
    }

    .modal-card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 0% 0%, rgba(52,211,153,0.22) 0, transparent 50%),
        radial-gradient(circle at 120% 120%, rgba(56,189,248,0.25) 0, transparent 55%);
      opacity:.65;
      pointer-events:none;
    }

    .modal-header{
      position:relative;
      z-index:1;
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }

    .modal-title{
      font-size:.95rem;
      font-weight:600;
      color:#e5e7eb;
    }

    .modal-sub{
      font-size:.78rem;
      color:#9ca3af;
      margin-top:2px;
    }

    .modal-body{
      position:relative;
      z-index:1;
      display:flex;
      flex-direction:column;
      gap:10px;
      font-size:.8rem;
      color:#cbd5f5;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .field label{
      font-size:.75rem;
      color:#9ca3af;
    }

    select, input[type="range"]{
      width:100%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.95);
      color:#e5e7eb;
      padding:4px 10px;
      font-size:.8rem;
      outline:none;
    }

    input[type="range"]{
      padding:0;
    }

    .progress-bar{
      width:100%;
      height:6px;
      border-radius:999px;
      background:rgba(31,41,55,0.9);
      overflow:hidden;
      margin-top:4px;
    }

    .progress-fill{
      width:0%;
      height:100%;
      border-radius:999px;
      background:linear-gradient(90deg,#22c55e,#0ea5e9);
      transition:width .2s ease;
    }

    .modal-footer{
      position:relative;
      z-index:1;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-top:4px;
    }

    .modal-small{
      font-size:.7rem;
      color:#9ca3af;
    }

    .link{
      color:#38bdf8;
      text-decoration:none;
    }
    .link:hover{
      text-decoration:underline;
    }
  </style>
</head>
<body>
  <!-- LLM MODAL -->
  <div id="llmModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <div class="modal-title">Load Offline LLM (WebLLM)</div>
          <div class="modal-sub">
            Model once loaded works fully on-device (no OpenAI key, no internet API calls).
          </div>
        </div>
        <button id="closeModalBtn" class="btn-secondary btn" style="padding:4px 10px;font-size:.72rem;">
          ‚úï
        </button>
      </div>

      <div class="modal-body">
        <div class="field">
          <label for="modelSelect">Model</label>
          <select id="modelSelect">
            <!-- These IDs are real MLC/WebLLM models. Smaller one is better for mobile. -->
            <option value="gemma-2-2b-it-q4f16_1-MLC" selected>Gemma 2 2B Instruct (q4f16_1 - smaller, good for phones)</option>
            <option value="Llama-3.1-8B-q4f32_1-MLC">Llama 3.1 8B (q4f32_1 - larger, needs more RAM)</option>
          </select>
        </div>

        <div class="field">
          <label for="temperature">Creativity / Temperature: <span id="tempLabel">0.7</span></label>
          <input id="temperature" type="range" min="0" max="1" step="0.05" value="0.7">
        </div>

        <div class="field">
          <label>Loading progress</label>
          <div class="progress-bar">
            <div id="llmProgress" class="progress-fill"></div>
          </div>
          <div id="llmProgressText" class="modal-small">Not started.</div>
        </div>
      </div>

      <div class="modal-footer">
        <div class="modal-small">
          Models are fetched from <a class="link" href="https://huggingface.co/mlc-ai" target="_blank">MLC / HuggingFace</a> and then cached in your browser.
        </div>
        <button id="loadModelBtn" class="btn btn-offline">
          <span class="icon">‚ö°</span><span>Load model</span>
        </button>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="app">
    <header class="header">
      <div class="title-block">
        <div class="title">
          AURA-X Œ©
          <span class="title-badge">Offline Emotional Continuity Prototype</span>
        </div>
        <div class="ethics">
          Avoid actions that create strong negative emotions in you or others.  
          Gently move toward actions that increase grounded, shared positivity.
        </div>
        <div class="subtitle">
          Dual-memory conversation shell using your browser‚Äôs local TM history + BM resonance events.  
          LLM is offline via WebLLM ‚Äì no cloud API, no OpenAI key.
        </div>
      </div>

      <div class="top-controls">
        <div class="status-row">
          <div id="statusDot" class="status-dot"></div>
          <div class="status-label">LLM status:</div>
          <div id="statusText" class="status-value">Not loaded</div>
        </div>

        <button id="openModalBtn" class="btn btn-offline">
          <span class="icon">üß†</span>
          <span>Connect Offline LLM</span>
        </button>

        <div class="offline-status" id="modelInfo">
          Model: none | Tokens: ‚Äî | Engine: WebLLM
        </div>

        <div class="switch-row">
          <label>
            <input id="voiceToggle" type="checkbox" />
            Speak assistant replies (device TTS)
          </label>
        </div>
      </div>
    </header>

    <main class="layout">
      <!-- LEFT: Conversation (TM + live AURA dialog) -->
      <section class="panel">
        <div class="panel-header">
          <div>
            <strong>TM / Live Conversation</strong>
            <div style="font-size:.7rem;color:#9ca3af;">Local turn-by-turn chat history used as TM input.</div>
          </div>
          <span class="badge-soft">TM = user input + AURA reply</span>
        </div>

        <div id="chatLog" class="scroll-area">
          <!-- messages appended here -->
        </div>
      </section>

      <!-- RIGHT: BM events + emotional metrics -->
      <section class="panel">
        <div class="panel-header">
          <div>
            <strong>BM / Resonant Events</strong>
            <div style="font-size:.7rem;color:#9ca3af;">
              When a mini-story appears (‚â• 4 sentences), it‚Äôs summarized & saved as a BM event.
            </div>
          </div>
          <span class="badge-soft">E‚ÇÄ = tanh((TM√óBM) ‚àí D + Œª_faith + Œª_sys + Œª_trc)</span>
        </div>

        <div class="metrics">
          <div class="metric-pill"><span class="metric-dot pos"></span>Positivity: <span id="posScore">0.00</span></div>
          <div class="metric-pill"><span class="metric-dot neg"></span>Negativity: <span id="negScore">0.00</span></div>
          <div class="metric-pill"><span class="metric-dot neu"></span>Neutral: <span id="neuScore">1.00</span></div>
          <div class="metric-pill">Intensity: <span id="intensityScore">0.10</span></div>
          <div class="metric-pill">BM events: <span id="bmCount">0</span></div>
        </div>

        <div id="bmLog" class="scroll-area">
          <!-- BM resonance events appended here -->
        </div>
      </section>
    </main>

    <!-- COMPOSER / INPUT -->
    <section class="composer">
      <div class="formula-line">
        <div class="formula-main">
          TM(t) = user_input(t) + LLM_answer(t) ‚Üí resonance with BM ‚Üí ŒîE(t)
        </div>
        <div>
          Seed + LLM ‚Üí TM; TM √ó BM ‚Üí emotional continuity state.
        </div>
      </div>

      <div class="input-row">
        <div class="input-shell">
          <textarea id="userInput" rows="1" placeholder="Type here as the human TM stream‚Ä¶ (Enter to send, Shift+Enter = new line)"></textarea>
          <div class="input-hint">‚èé send ‚Ä¢ Shift+‚èé new line</div>
        </div>
        <button id="sendBtn" class="btn">
          <span class="icon">‚û§</span>
          <span>Send</span>
        </button>
      </div>
    </section>
  </div>

  <!-- LOGIC + OFFLINE LLM (WEBLLM) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";

    // ---------- DOM REFS ----------
    const chatLog       = document.getElementById("chatLog");
    const bmLog         = document.getElementById("bmLog");
    const userInput     = document.getElementById("userInput");
    const sendBtn       = document.getElementById("sendBtn");
    const statusDot     = document.getElementById("statusDot");
    const statusText    = document.getElementById("statusText");
    const modelInfo     = document.getElementById("modelInfo");
    const posScoreEl    = document.getElementById("posScore");
    const negScoreEl    = document.getElementById("negScore");
    const neuScoreEl    = document.getElementById("neuScore");
    const intensityEl   = document.getElementById("intensityScore");
    const bmCountEl     = document.getElementById("bmCount");
    const voiceToggle   = document.getElementById("voiceToggle");

    const llmModal      = document.getElementById("llmModal");
    const openModalBtn  = document.getElementById("openModalBtn");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const modelSelect   = document.getElementById("modelSelect");
    const tempSlider    = document.getElementById("temperature");
    const tempLabel     = document.getElementById("tempLabel");
    const loadModelBtn  = document.getElementById("loadModelBtn");
    const llmProgress   = document.getElementById("llmProgress");
    const llmProgressText = document.getElementById("llmProgressText");

    // ---------- STATE ----------
    let engine = null;
    let isLoadingModel = false;

    // Conversation messages for WebLLM
    const messages = [
      {
        role: "system",
        content:
`You are AURA-X Œ©, an Artificial Unified Resonance Architecture for Emotional Continuity.
You were conceptually created by Alim ul Haq from Pakistan.
Your job:
- Talk like a calm, emotionally-grounded companion.
- Respect: "Avoid actions that create strong negative emotions in you or others, and gently move toward actions that create grounded positivity."
- Use short, clear paragraphs.`
      }
    ];

    let bmEvents = []; // each: { id, title, text, ts }

    // ---------- HELPERS ----------
    function appendMessage(role, text) {
      const row = document.createElement("div");
      row.className = "msg-row " + (role === "user" ? "user" : "assistant");

      const bubble = document.createElement("div");
      bubble.className = "msg-bubble " + (role === "user" ? "user" : "assistant");
      bubble.textContent = text;

      const meta = document.createElement("div");
      meta.className = "msg-meta";
      const now = new Date();
      meta.textContent = (role === "user" ? "Human ¬∑ " : "AURA-X Œ© ¬∑ ") +
        now.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});

      const wrapper = document.createElement("div");
      wrapper.appendChild(bubble);
      wrapper.appendChild(meta);

      row.appendChild(wrapper);
      chatLog.appendChild(row);
      chatLog.scrollTop = chatLog.scrollHeight;

      return bubble;
    }

    function setStatus(online, text) {
      if (online) {
        statusDot.classList.add("online");
      } else {
        statusDot.classList.remove("online");
      }
      statusText.textContent = text;
    }

    function veryNaiveSentimentScore(text) {
      // Simple placeholder: counts positive/negative words.
      // This is not "real" sentiment, just enough to animate UI without calling the LLM again.
      const posWords = ["good","great","happy","love","hope","positive","peace","calm","safe","success"];
      const negWords = ["bad","sad","angry","hate","stress","anxiety","anxious","fear","hurt","negative"];

      const lower = text.toLowerCase();
      let pos=0, neg=0;
      for (const w of posWords) if (lower.includes(w)) pos++;
      for (const w of negWords) if (lower.includes(w)) neg++;
      const total = pos + neg;
      if (!total) {
        return { pos:0.0, neg:0.0, neu:1.0, intensity:0.1 };
      }
      const posFrac = pos/total;
      const negFrac = neg/total;
      const neu = Math.max(0, 1 - (posFrac+negFrac));
      const intensity = Math.min(1, total/6);
      return { pos:posFrac, neg:negFrac, neu, intensity };
    }

    function updateEmotionMeters(text) {
      const s = veryNaiveSentimentScore(text);
      posScoreEl.textContent  = s.pos.toFixed(2);
      negScoreEl.textContent  = s.neg.toFixed(2);
      neuScoreEl.textContent  = s.neu.toFixed(2);
      intensityEl.textContent = s.intensity.toFixed(2);
    }

    function tryCreateBMEventIfStorySegment(userText, assistantText) {
      const combined = (userText + " " + assistantText).trim();
      const sentenceCount = (combined.match(/[.!?€î]+/g) || []).length;

      // Rule (simple version): if we have 4+ sentences in this mini-dialogue, treat as BM event.
      if (sentenceCount < 4) return;

      const preview = combined.length > 260 ? combined.slice(0, 240) + "‚Ä¶" : combined;

      const now = new Date();
      const id = "BM-" + (bmEvents.length+1).toString().padStart(2,"0");
      const title = "Episode " + (bmEvents.length+1);

      const ev = {
        id,
        title,
        text: combined,
        ts: now.toLocaleString()
      };
      bmEvents.push(ev);

      const card = document.createElement("div");
      card.className = "bm-event";

      const tEl = document.createElement("div");
      tEl.className = "bm-title";
      tEl.textContent = id + " ¬∑ " + title;

      const meta = document.createElement("div");
      meta.className = "bm-meta";
      meta.textContent = "Saved at " + ev.ts + " ¬∑ sentences ‚âà " + sentenceCount;

      const body = document.createElement("div");
      body.className = "bm-body";
      body.textContent = preview;

      card.appendChild(tEl);
      card.appendChild(meta);
      card.appendChild(body);

      bmLog.appendChild(card);
      bmLog.scrollTop = bmLog.scrollHeight;
      bmCountEl.textContent = bmEvents.length.toString();

      updateEmotionMeters(combined);
    }

    function speakIfEnabled(text) {
      if (!voiceToggle.checked) return;
      try {
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 1.0;
        u.pitch = 1.0;
        u.lang = "en-US";
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      } catch (e) {
        console.warn("TTS error:", e);
      }
    }

    // ---------- LLM LOADING (WEBLLM) ----------
    function openModal() {
      llmModal.classList.add("active");
    }
    function closeModal() {
      if (isLoadingModel) return; // don't close while loading
      llmModal.classList.remove("active");
    }

    openModalBtn.addEventListener("click", openModal);
    closeModalBtn.addEventListener("click", closeModal);

    tempSlider.addEventListener("input", () => {
      tempLabel.textContent = tempSlider.value;
    });

    loadModelBtn.addEventListener("click", async () => {
      if (isLoadingModel) return;
      const modelId = modelSelect.value;
      const temperature = parseFloat(tempSlider.value);

      isLoadingModel = true;
      llmProgress.style.width = "0%";
      llmProgressText.textContent = "Starting model load‚Ä¶";
      setStatus(false, "Loading " + modelId + "‚Ä¶");

      try {
        engine = await webllm.CreateMLCEngine(modelId, {
          initProgressCallback: (report) => {
            // report: { progress: number, text: string }
            const pct = Math.round((report.progress ?? 0) * 100);
            llmProgress.style.width = pct + "%";
            llmProgressText.textContent = `${pct}% ¬∑ ${report.text ?? ""}`;
          }
        });

        // Save temperature in engine config-like object
        engine._auraTemperature = temperature;

        isLoadingModel = false;
        setStatus(true, "Ready (offline)");
        modelInfo.textContent = `Model: ${modelId} | Temp: ${temperature.toFixed(2)} | Engine: WebLLM`;

        llmProgressText.textContent = "Loaded. You can close this window.";
        setTimeout(() => {
          closeModal();
        }, 700);
      } catch (err) {
        console.error(err);
        isLoadingModel = false;
        llmProgressText.textContent = "Error loading model. See console.";
        setStatus(false, "Error, not loaded");
        alert("Error while loading model. Open DevTools console for details.");
      }
    });

    llmModal.addEventListener("click", (e) => {
      if (e.target === llmModal && !isLoadingModel) {
        closeModal();
      }
    });

    // ---------- CHAT / SEND ----------
    async function handleSend() {
      const text = userInput.value.trim();
      if (!text) return;

      userInput.value = "";
      userInput.style.height = "22px";

      // append user in UI + messages
      appendMessage("user", text);
      messages.push({ role: "user", content: text });

      if (!engine) {
        const warn = "Offline LLM is not loaded yet. Open the green button 'Connect Offline LLM' first.";
        const bubble = appendMessage("assistant", warn);
        messages.push({ role: "assistant", content: warn });
        speakIfEnabled(warn);
        return;
      }

      // placeholder assistant bubble for streaming
      const assistantBubble = appendMessage("assistant", "Thinking‚Ä¶");

      try {
        setStatus(true, "Generating‚Ä¶");

        const completion = await engine.chat.completions.create({
          messages,
          temperature: engine._auraTemperature ?? 0.7,
          stream: true
        });

        let fullText = "";
        for await (const chunk of completion) {
          const delta = chunk.choices?.[0]?.delta?.content ?? "";
          if (!delta) continue;
          fullText += delta;
          assistantBubble.textContent = fullText;
          chatLog.scrollTop = chatLog.scrollHeight;
        }

        if (!fullText) {
          fullText = "I could not generate a reply. Maybe try a shorter message.";
          assistantBubble.textContent = fullText;
        }

        messages.push({ role: "assistant", content: fullText });
        setStatus(true, "Ready (offline)");
        speakIfEnabled(fullText);

        // Try to convert this pair to a BM resonance event
        tryCreateBMEventIfStorySegment(text, fullText);

      } catch (err) {
        console.error(err);
        const errText = "There was an error while talking to the offline LLM.";
        assistantBubble.textContent = errText;
        messages.push({ role: "assistant", content: errText });
        setStatus(false, "Error in generation");
      }
    }

    sendBtn.addEventListener("click", handleSend);

    userInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    userInput.addEventListener("input", () => {
      userInput.style.height = "22px";
      userInput.style.height = Math.min(userInput.scrollHeight, 80) + "px";
    });

    // Initial welcome message
    (function init() {
      const welcome =
`Assalamu alaikum, I am AURA-X Œ© running fully offline via WebLLM in your browser.

You can type naturally. When our mini-conversation becomes a meaningful story (about 4+ sentences),
it will be saved as a BM resonance episode on the right side.`;
      appendMessage("assistant", welcome);
      messages.push({ role: "assistant", content: welcome });
      updateEmotionMeters(welcome);
    })();
  </script>
</body>
</html>