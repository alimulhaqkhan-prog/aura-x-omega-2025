<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Î© â€“ Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root {
      --accent-color: #0ea5e9;
    }
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px 10px;
    }
    .app{
      width:min(980px,98vw);
      background:rgba(2,6,23,.45);
      border:1px solid rgba(148,163,184,.18);
      border-radius:22px;
      overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
    }
    .top{
      padding:20px 18px 10px;
      border-bottom:1px solid rgba(148,163,184,.14);
      text-align:center;
    }
    .brand{
      font-weight:800;
      letter-spacing:.5px;
      font-size:26px;
      color:#7dd3fc;
      text-shadow:0 0 22px rgba(14,165,233,.28);
    }
    .sub{
      opacity:.8;
      margin-top:2px;
      font-size:13px;
    }
    .ethic{
      margin:14px auto 12px;
      max-width:720px;
      border:1px solid rgba(251,191,36,.35);
      border-radius:14px;
      padding:12px 14px;
      color:#fbbf24;
      background:rgba(2,6,23,.35);
      box-shadow:inset 0 0 0 1px rgba(251,191,36,.08);
      font-size:14px;
      line-height:1.45;
    }
    .pill{
      margin:10px auto 0;
      max-width:760px;
      background:linear-gradient(90deg, rgba(14,165,233,.65), rgba(34,211,238,.45));
      border:1px solid rgba(125,211,252,.30);
      color:#0b1220;
      font-weight:800;
      letter-spacing:.6px;
      border-radius:999px;
      padding:14px 16px;
      text-transform:uppercase;
      box-shadow:0 12px 40px rgba(14,165,233,.22);
    }
    .main{ padding:16px 16px 18px }
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:stretch}
    .leftCol{ flex:1 1 340px; min-width:300px }
    .rightCol{ flex:1 1 360px; min-width:320px }
    .card{
      background:rgba(2,6,23,.50);
      border:1px solid rgba(148,163,184,.16);
      border-radius:18px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      backdrop-filter:blur(10px);
    }
    .optionsBtn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(15,23,42,.55);
      color:#e5e7eb;
      cursor:pointer;
      user-select:none;
      margin:12px 0;
    }
    .optionsBtn:active{transform:scale(.99)}
    .gear{width:18px;height:18px;filter:drop-shadow(0 0 10px rgba(125,211,252,.25))}
    .console{
      margin-top:12px;
      height:230px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(0,0,0,.25);
      padding:14px;
      overflow:auto;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:14px;
      box-shadow:inset 0 0 0 1px rgba(125,211,252,.06);
      line-height:1.55;
      white-space:pre-wrap;
    }
    .line{display:block;margin:2px 0;position:relative;padding-right:50px}
    .feedbackBtns{
      position:absolute;
      right:0;
      top:50%;
      transform:translateY(-50%);
      display:flex;
      gap:6px;
      opacity:0;
      transition:opacity .2s;
    }
    .line:hover .feedbackBtns{opacity:1}
    .fbBtn{
      width:28px;height:28px;
      border-radius:50%;
      border:none;
      background:rgba(15,23,42,.6);
      color:#e5e7eb;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
    }
    .fbBtn:active{transform:scale(.9)}
    .fbBtn.like{background:rgba(34,197,94,.3);border:1px solid rgba(34,197,94,.4)}
    .fbBtn.dislike{background:rgba(239,68,68,.3);border:1px solid rgba(239,68,68,.4)}
    .optionsMenu{
      position:fixed;
      left:12px;right:12px;top:120px;margin:0 auto;
      max-width:940px;
      background:rgba(2,6,23,.92);
      border:1px solid rgba(148,163,184,.18);
      border-radius:16px;
      padding:8px;
      display:none;
      z-index:9999;
      box-shadow:0 18px 45px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
    }
    .optionsMenu.show{display:grid}
    .menuItem{
      padding:8px 6px;
      border-radius:13px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:6px;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.10);
      background:rgba(15,23,42,.55);
      user-select:none;
      min-height:58px;
    }
    .menuItem:active{transform:scale(.995)}
    .menuLeft{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-weight:800;
      font-size:12.5px;
    }
    .menuIcon{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;}
    .menuRight{display:inline-flex;align-items:center;justify-content:center;min-width:44px;}
    .pillOn,.pillOff,.pillMid{
      font-size:10px;padding:4px 7px;border-radius:999px;font-weight:900;text-transform:lowercase;border:1px solid transparent;
    }
    .pillOn{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.24);color:#bbf7d0;}
    .pillOff{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.22);color:#fecaca;}
    .pillMid{background:rgba(14,165,233,.14);border-color:rgba(14,165,233,.20);color:#bae6fd;opacity:.95;}
    .chatWrap{
      margin-top:0;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.45);
    }
    .liveCapsule{
      margin:4px 0 10px;
      width:100%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      padding:10px 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:12px;
      color:#dbeafe;
      box-shadow:inset 0 0 0 1px rgba(125,211,252,.06);
    }
    .liveCapsule b{ color:#7dd3fc; font-weight:900 }
    .faithBubble{
      margin:4px 0 10px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(251,191,36,.16);
      border:1px solid rgba(251,191,36,.4);
      display:none;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:#facc15;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      transition:opacity .25s ease, transform .25s ease;
    }
    .faithBubble.show{display:flex;opacity:1;transform:translateY(0);}
    .fbIcon{font-size:18px;}
    .fbText{flex:1;line-height:1.3;}
    .fbTitle{font-weight:800;}
    .fbMeta{opacity:.85;}
    .fbClose{border:none;background:transparent;color:#fed7aa;font-size:16px;cursor:pointer;padding:0 4px;line-height:1;}
    body.theme-golden .ethic{border-color: rgba(251,191,36,.7);background: rgba(251,191,36,.06);}
    .faithBubble.pulse{animation: faithPulse 1.4s infinite;}
    @keyframes faithPulse{
      0%   { box-shadow: 0 0 0 0 rgba(251,191,36,.55); }
      100% { box-shadow: 0 0 0 18px rgba(251,191,36,0); }
    }
    .inputRow{display:flex;gap:10px;align-items:flex-end}
    .input{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      padding:12px 14px;
      outline:none;
      font-size:14px;
    }
    .send{
      border:none;
      border-radius:999px;
      background:linear-gradient(90deg, var(--accent-color, #0ea5e9), rgba(34,211,238,.55));
      color:#0b1220;
      font-weight:900;
      padding:12px 18px;
      cursor:pointer;
      min-width:88px;
      box-shadow:0 12px 30px rgba(14,165,233,.18);
    }
    .send:active{transform:scale(.99)}
    .formula{
      margin-top:10px;
      opacity:.8;
      font-size:12px;
      text-align:center;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      color:#dbeafe;
    }
    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:18px 12px;
      z-index:9999;
    }
    .modalOverlay.show{display:flex}
    .modal{
      width:min(860px,96vw);
      border-radius:18px;
      overflow:hidden;
      background:rgba(250,250,250,.93);
      color:#0b1220;
      border:1px solid rgba(15,23,42,.18);
      box-shadow:0 30px 80px rgba(0,0,0,.35);
      backdrop-filter:blur(12px);
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      background:rgba(255,255,255,.75);
      border-bottom:1px solid rgba(15,23,42,.10);
      font-weight:800;
    }
    .modalHeader small{font-weight:600;opacity:.7}
    .closeX{
      border:none;
      background:transparent;
      font-size:22px;
      cursor:pointer;
      line-height:1;
      padding:0 4px;
      opacity:.75;
    }
    .modalBody{
      padding:14px;
      max-height:70vh;
      overflow:auto;
    }
    @media (max-width:760px){.console{height:240px}.optionsMenu{top:112px}}
    @media (max-width:420px){
      .brand{font-size:22px}.pill{font-size:14px}.ethic{font-size:13px}.console{height:260px}
      .optionsMenu{gap:6px;padding:7px;grid-template-columns:repeat(3,minmax(0,1fr));}
      .menuItem{min-height:52px;padding:6px 4px;}
      .menuLeft{font-size:11px}
      .pillOn,.pillOff,.pillMid{font-size:9.5px;padding:4px 6px;}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="brand">AURA-X Î©</div>
      <div class="sub">
        Offline emotional continuity engine (prototype)<br>
        TM = user inputs only Â· Internal layers keep continuity and emotional trajectory.
      </div>
      <div class="ethic">
        Universal ethic: avoid actions that grow negative emotions in you or others.
        Move gently toward choices that increase shared positive feeling for everyone.
      </div>
      <div class="pill">EMOTIONAL CONTINUITY ENGINE â€” ACTIVE</div>
    </div>
    <div class="main">
      <div class="row">
        <div class="leftCol">
          <div class="card">
            <div class="optionsBtn" id="btnOptions">
              <svg class="gear" viewBox="0 0 24 24" fill="none">
                <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="#7dd3fc" stroke-width="2"/>
                <path d="M19.4 15a8.2 8.2 0 0 0 .1-2l2-1.5-2-3.5-2.4 1a8.5 8.5 0 0 0-1.7-1l-.4-2.6h-4l-.4 2.6a8.5 8.5 0 0 0-1.7 1l-2.4-1-2 3.5 2 1.5a8.2 8.2 0 0 0 .1 2L2.7 16.5l2 3.5 2.4-1a8.5 8.5 0 0 0 1.7 1l.4 2.6h4l.4-2.6a8.5 8.5 0 0 0 1.7-1l2.4 1 2-3.5L19.4 15Z" stroke="#7dd3fc" stroke-width="1.6" opacity=".9"/>
              </svg>
              <span>Options</span>
            </div>
            <div class="optionsMenu" id="optionsMenu">
              <div class="menuItem" id="miVoice">
                <div class="menuLeft"><span class="menuIcon">ðŸŽ¤</span><span>Voice</span></div>
                <div class="menuRight"><span class="pillOff" id="voicePill">off</span></div>
              </div>
              <div class="menuItem" id="miIntel">
                <div class="menuLeft"><span class="menuIcon">ðŸ§ </span><span>Intelligence</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miLearn">
                <div class="menuLeft"><span class="menuIcon">ðŸ“š</span><span>Learning</span></div>
                <div class="menuRight"><span class="pillOn" id="learnPill">on</span></div>
              </div>
              <div class="menuItem" id="miSeed">
                <div class="menuLeft"><span class="menuIcon">ðŸŒ±</span><span>Feed</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miFaith">
                <div class="menuLeft"><span class="menuIcon">ðŸ•Š</span><span>Faith</span></div>
                <div class="menuRight"><span class="pillOff" id="faithLabel">none</span></div>
              </div>
              <div class="menuItem" id="miIdentity">
                <div class="menuLeft"><span class="menuIcon">ðŸªª</span><span>Identity</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miLLM">
                <div class="menuLeft"><span class="menuIcon">ðŸ¤–</span><span>LLM</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miBMRecall">
                <div class="menuLeft"><span class="menuIcon">ðŸ“˜</span><span>BM Recall</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miHistory">
                <div class="menuLeft"><span class="menuIcon">ðŸ“œ</span><span>History</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
            </div>
            <div class="console" id="console"></div>
          </div>
        </div>
        <div class="rightCol">
          <div class="chatWrap">
            <div class="liveCapsule">
              <span><b>E0</b>: <span id="cE0">0.000</span></span><span>Â·</span>
              <span><b>TM</b>: <span id="cTM">0.00</span></span><span>Â·</span>
              <span><b>BM</b>: <span id="cBM">0.00</span></span><span>Â·</span>
              <span><b>C</b>: <span id="cCont">0.850</span></span>
            </div>
            <div class="faithBubble" id="faithBubble">
              <div class="fbIcon">ðŸ’­</div>
              <div class="fbText">
                <div class="fbTitle" id="faithBubbleTitle">Faith reflection bubble</div>
                <div class="fbMeta" id="faithBubbleMeta">Tap to see a short suggestion.</div>
              </div>
              <button class="fbClose" id="faithBubbleClose">Ã—</button>
            </div>
            <div class="inputRow">
              <input class="input" id="userInput" placeholder="Talk to AURA-X Î©â€¦ (TM = your inputs)" />
              <button class="send" id="sendBtn">Send</button>
            </div>
            <div class="formula">
              Eâ‚€ = tanh( R(TM,BM) + I(TM) + I<sub>intel</sub> + I<sub>LLM</sub> âˆ’ D + Î»<sub>faith</sub> + Î»<sub>sys</sub> + Î»<sub>trc</sub> )
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- All modals remain exactly the same (omitted for brevity â€“ copy from previous version) -->
  <!-- ... (Faith, FaithArticle, Intel, Seed, LLM, BM, History, Identity modals unchanged) ... -->

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const KEY_CFG   = "aurax_cfg_v12";
      const KEY_INT   = "aurax_intel_v12"; // updated version
      const KEY_BM    = "aurax_bm_v11";
      const KEY_HIST  = "aurax_hist_v11";
      const KEY_USER  = "aurax_user_v11";
      const KEY_LOGIC = "aurax_logic_v12";
      const KEY_QTABLE = "aurax_qtable_v1";

      const OFFLINE_MODEL_ID = "Llama-3-8B-Instruct-q4f32_1-MLC";

      const els = {
        console: document.getElementById("console"),
        btnOptions: document.getElementById("btnOptions"),
        optionsMenu: document.getElementById("optionsMenu"),
        // ... all other elements same as before
        userInput: document.getElementById("userInput"),
        sendBtn: document.getElementById("sendBtn"),
        // ... rest unchanged
      };

      // ... FAITH_OPTIONS, FAITH_LIBRARY same

      class QLearning {
        // ... same as previous version
      }

      let state = {
        // ... same as before
        lastUserMessage: "",
        lastAuraMessage: "",
        lastAuraLineElement: null,
        qLearner: new QLearning(),
        prevState: null,
        prevAction: null,
        prevE0: 0
      };

      // ... all helper functions same (safeLoadJSON, logLine, scoreTM, recomputeBMMetric, recomputeE0, updateCapsule, save functions, etc.)

      function logLine(text, role = "aura") {
        const div = document.createElement("div");
        div.className = "line";
        div.textContent = (role === "user" ? "You: " : "AURA-X Î©: ") + text;

        if (role === "aura") {
          state.lastAuraLineElement = div;
          state.lastAuraMessage = text;

          const feedback = document.createElement("div");
          feedback.className = "feedbackBtns";

          const likeBtn = document.createElement("button");
          likeBtn.className = "fbBtn like";
          likeBtn.textContent = "ðŸ‘";
          likeBtn.title = "Save this answer to Intelligence";
          likeBtn.addEventListener("click", () => saveToIntelligence(true));

          const dislikeBtn = document.createElement("button");
          dislikeBtn.className = "fbBtn dislike";
          dislikeBtn.textContent = "ðŸ‘Ž";
          dislikeBtn.title = "Correct this answer";
          dislikeBtn.addEventListener("click", () => promptCorrection());

          feedback.appendChild(likeBtn);
          feedback.appendChild(dislikeBtn);
          div.appendChild(feedback);
        }

        els.console.appendChild(div);
        els.console.scrollTop = els.console.scrollHeight;
      }

      function saveToIntelligence(isGood) {
        if (!state.lastUserMessage || !state.lastAuraMessage) return;
        if (!state.learningOn) {
          logLine("[System] Learning is off â€“ cannot save.");
          return;
        }

        const q = state.lastUserMessage.trim();
        const a = state.lastAuraMessage.trim();

        // Avoid duplicates
        const exists = state.intelligence.some(item => item.q.toLowerCase() === q.toLowerCase());
        if (exists) {
          logLine("[System] Already saved this Q&A.");
          return;
        }

        state.intelligence.push({
          id: "fb_" + Date.now(),
          q,
          a,
          meta: "Saved via ðŸ‘ on " + new Date().toLocaleDateString()
        });
        saveIntelligence();
        logLine(isGood ? "[System] ðŸ‘ Answer saved to Intelligence!" : "[System] ðŸ‘Ž Answer noted for improvement.");
      }

      function promptCorrection() {
        const correction = prompt("Please provide the correct or better answer:", state.lastAuraMessage);
        if (correction && correction.trim() && correction.trim() !== state.lastAuraMessage) {
          const q = state.lastUserMessage.trim();
          const a = correction.trim();

          // Replace if exists, else add
          const idx = state.intelligence.findIndex(item => item.q.toLowerCase() === q.toLowerCase());
          if (idx >= 0) {
            state.intelligence[idx].a = a;
            state.intelligence[idx].meta = "Corrected via ðŸ‘Ž on " + new Date().toLocaleDateString();
          } else {
            state.intelligence.push({
              id: "corr_" + Date.now(),
              q,
              a,
              meta: "Corrected via ðŸ‘Ž on " + new Date().toLocaleDateString()
            });
          }
          saveIntelligence();
          logLine("[System] ðŸ‘Ž Correction saved to Intelligence.");
        }
      }

      async function handleUserMessage(){
        const text = (els.userInput.value||"").trim();
        if(!text) return;

        state.lastUserMessage = text;
        state.lastAuraMessage = "";
        state.lastAuraLineElement = null;

        // ... existing abuse check, metrics, etc.

        logLine(text, "user");
        addHistory("user",text);
        renderHistory();

        state.metrics.TM = scoreTM(text);
        recomputeBMMetric();
        updateCapsule();

        // ... abuse detection same

        const {answer,source,intelBoost,llmBoost}=await generateAnswer(text);
        state.lastAnswerSource=source;
        recomputeE0(intelBoost, llmBoost);
        updateCapsule();

        logLine(answer);  // This now adds ðŸ‘ðŸ‘Ž buttons
        addHistory("aura",answer);
        renderHistory();

        speakText(answer);
        maybeTriggerFaithBubble(text,answer);
        maybeUpdateLiveBM(text,answer);

        // Q-learning update (same as before)
        if (state.learningOn) {
          const newE0 = state.metrics.E0;
          const reward = newE0 - state.prevE0 + 0.1; // small bonus for completing interaction
          const newStateKey = Math.round(newE0 * 10) + (abuse.hit ? '_abuse' : '_normal');
          state.qLearner.update(state.prevState, state.prevAction, reward, newStateKey);
          state.qLearner.decay();
          state.qLearner.save();
        }
      }

      // ... rest of the code (generateAnswer with Q-learning, initFromStorage, events) remains exactly the same as previous advanced version

      els.sendBtn.addEventListener("click", handleUserMessage);
      els.userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          handleUserMessage();
        }
      });

      // ... all other event listeners same

      initFromStorage();
    });
  </script>
</body>
</html>
