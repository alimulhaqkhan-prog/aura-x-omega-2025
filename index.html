<script>
  // ===== BACKEND CONFIG =====
  // YAHAN APNA ASLI RENDER URL LAGAO (Dashboard se copy karo):
  const BACKEND_URL = "https://aura-x-backend-xxxx.onrender.com/api/react";

  const lsKey = "auraX_bm_v31";
  const faithKey = "auraX_faithLens";
  const engineKey = "auraX_engineMode";
  const llmModelKey = "auraX_llmModel";

  const smallTalkPatterns = [
    "hi","hello","hey","salam","assalamualaikum",
    "how are you","kia hal hai","kese ho","how r u"
  ];

  // ===== NEW SEED LEXICONS =====
  const abuseWords = [
    "fuck","fucking","fucked","lanat","laanat","haramzada",
    "bastard","bitch","bitches","bloody","kutte","kutta","kutiya",
    "chutiya","stupid","idiot","gadha","gandi zuban","shut up","chup",
    "bakwas","bakwass","zalil","zaleel","cursed"
  ];
  const duaWords = [
    "dua","prayer","pray for me","make dua","dua karo","dua karna",
    "istighfar","astaghfirullah"
  ];
  const shukrWords = [
    "shukr","shukar","thanks","thank you","alhamdulillah","grateful","gratitude"
  ];
  const tawakkulWords = [
    "tawakkul","tawakkal","trust in allah","allah par bharosa","allah pe bharosa"
  ];
  const loveSeedWords = [
    "i love you","love you","pyaar","pyar","mohabbat",
    "i care about you","miss you","hug","embrace"
  ];
  const empathyWords = [
    "feel sorry for you","sorry for you","may allah ease",
    "may allah make it easy","allah apko ajar de",
    "i am with you","i understand your pain","may god help you"
  ];

  function loadBM() {
    try {
      const raw = localStorage.getItem(lsKey);
      return raw ? JSON.parse(raw) : {};
    } catch { return {}; }
  }
  function saveBM(data) { localStorage.setItem(lsKey, JSON.stringify(data)); }
  function todayKey() { return new Date().toISOString().slice(0,10); }
  function tanh(x){ const e2x=Math.exp(2*x); return (e2x-1)/(e2x+1); }
  function approximateSentences(text){
    return text.split(/[.!?Û”\n]/).filter(s=>s.trim().length>0);
  }
  function summarizeTo200Sentences(text){
    const sentences = approximateSentences(text);
    if (sentences.length<=200) return text.trim();
    return sentences.slice(0,200).join(". ").slice(0,10000);
  }
  function isMostlySmallTalk(text){
    const clean=text.toLowerCase().trim();
    if (clean.length>80) return false;
    return smallTalkPatterns.some(p=>clean===p||clean.startsWith(p+" "));
  }
  function containsAny(lower, arr){
    return arr.some(w => lower.includes(w));
  }
  function countAny(lower, arr){
    return arr.reduce((c,w)=> c + (lower.includes(w)?1:0), 0);
  }
  function analyseContent(text){
    const lower = text.toLowerCase();
    const abuseCount = countAny(lower, abuseWords);
    const posSeedCount =
      countAny(lower, loveSeedWords) +
      countAny(lower, shukrWords) +
      countAny(lower, tawakkulWords) +
      countAny(lower, empathyWords);
    const total = abuseCount + posSeedCount;
    const sentiment = total ? (posSeedCount - abuseCount) / total : 0;
    const hasDua = containsAny(lower, duaWords);
    const hasShukr = containsAny(lower, shukrWords);
    const hasLove = containsAny(lower, loveSeedWords);
    const hasEmpathy = containsAny(lower, empathyWords);
    const hasTawakkul = containsAny(lower, tawakkulWords);
    const isAbuse = abuseCount > 0;
    return {
      isAbuse,
      hasDua,
      hasShukr,
      hasLove,
      hasEmpathy,
      hasTawakkul,
      hasFaithSeed: hasDua || hasTawakkul,
      positiveSeed: posSeedCount > 0,
      abuseCount,
      posSeedCount,
      sentiment
    };
  }

  // ===== STATE =====
  let TM=0.35, BMvalue=0.55, D=0.0, Csum=0.05;
  let lambdaFaith=0.0;
  const lambdaSys=0.02;
  let E0=0.0;

  const chatLogEl=document.getElementById("chatLog");
  const statusLineEl=document.getElementById("statusLine");
  const eqMainEl=document.getElementById("eqMain");
  const eqValuesEl=document.getElementById("eqValues");
  const userInputEl=document.getElementById("userInput");
  const modePill=document.getElementById("modePill");
  const reactionBannerEl=document.getElementById("reactionBanner");
  const voiceToggleEl=document.getElementById("voiceToggle");

  let autoVoice = true;

  function updateEquationDisplay(){
    eqMainEl.textContent="Eâ‚€ = tanh(TM Ã— BM âˆ’ D + Î»_faith + Î»_sys + Î£Câ‚œ)";
    eqValuesEl.textContent=
      `Eâ‚€ = ${E0.toFixed(2)} Â· TM = ${TM.toFixed(2)} Â· BM = ${BMvalue.toFixed(2)} Â· ` +
      `D = ${D.toFixed(2)} Â· Î£Câ‚œ = ${Csum.toFixed(2)} Â· Î»_faith = ${lambdaFaith.toFixed(2)} Â· Î»_sys = ${lambdaSys.toFixed(2)}`;
    statusLineEl.textContent=
      `Eâ‚€=${E0.toFixed(2)} Â· TM=${TM.toFixed(2)} Â· D=${D.toFixed(2)} Â· tag=${
        E0>0.1?"positive":E0<-0.1?"negative":"neutral"
      }`;
  }

  function buildReactionTone(){
    const intensity=Math.abs(E0);
    let polarity = "Neutral";
    let cls = "reaction-neutral";
    if (E0>0.1){ polarity="Positive"; cls="reaction-positive"; }
    else if (E0<-0.1){ polarity="Negative"; cls="reaction-negative"; }
    let tone="";
    if (polarity==="Positive"){
      if (intensity>0.7) tone="Warm, expansive, high-energy encouragement.";
      else if (intensity>0.35) tone="Soft, stabilizing, hopeful resonance.";
      else tone="Light, gentle, low-amplitude positive drift.";
    } else if (polarity==="Negative"){
      if (intensity>0.7) tone="Deep, heavy, thunder-style emotional load (fear/anger).";
      else if (intensity>0.35) tone="Firm, serious, caution-oriented resonance.";
      else tone="Mild negative charge, like a faint worry or discomfort.";
    } else {
      if (intensity>0.5) tone="Mixed signal: strong but conflicted emotional pattern.";
      else tone="Calm, observant, analytically neutral reading.";
    }
    return {polarity, cls, intensity, tone};
  }

  function updateReactionBanner(sourceText){
    const text = (sourceText||"").trim();
    if (!text){
      reactionBannerEl.style.display="none";
      return;
    }
    const {polarity, cls, intensity, tone} = buildReactionTone();
    reactionBannerEl.className = "reaction-banner " + cls;
    reactionBannerEl.innerHTML =
      `<strong>AURA-X Î© REACTION</strong><br>`+
      `Polarity: ${polarity} Â· Intensity: ${(intensity*100).toFixed(0)}%<br>`+
      `Tone: ${tone}`;
    reactionBannerEl.style.display="block";
  }

  function appendMessage(text, who){
    const div=document.createElement("div");
    div.className="msg "+(who==="user"?"msg-user":"msg-bot");
    div.textContent=text;
    chatLogEl.appendChild(div);
    chatLogEl.scrollTop=chatLogEl.scrollHeight;
  }

  // ===== Voice synthesis =====
  function pickVoiceForPolarity(polarity) {
    const synth = window.speechSynthesis;
    if (!synth) return {voice:null, pitch:1.0, rate:1.0};
    let voices = synth.getVoices();
    if (!voices || !voices.length) {
      return {voice:null, pitch: polarity==="Negative" ? 1.2 : 0.9, rate:1.0};
    }
    let target = null;
    if (polarity === "Positive") {
      target = voices.find(v => /male/i.test(v.name)) || voices[0];
      return {voice:target, pitch:0.9, rate:1.0};
    } else if (polarity === "Negative") {
      target = voices.find(v => /female/i.test(v.name)) || voices[0];
      return {voice:target, pitch:1.2, rate:1.0};
    } else {
      target = voices[0];
      return {voice:target, pitch:1.0, rate:1.0};
    }
  }

  function speakReply(text){
    if (!autoVoice) return;
    if (!("speechSynthesis" in window)) return;
    if (!text || !text.trim()) return;
    const synth = window.speechSynthesis;
    const {polarity} = buildReactionTone();
    const {voice, pitch, rate} = pickVoiceForPolarity(polarity);
    const utt = new SpeechSynthesisUtterance(text);
    if (voice) utt.voice = voice;
    utt.pitch = pitch;
    utt.rate = rate;
    synth.cancel();
    synth.speak(utt);
  }

  // ===== Emotion maths =====
  function computeEmotion(strength, analysis){
    const baseFromLength=Math.min(1,0.2+strength/400);
    const sentiment = analysis ? analysis.sentiment || 0 : 0;
    TM = Math.min(1, Math.max(0, baseFromLength + sentiment*0.3));

    if (analysis && analysis.isAbuse){
      D = Math.min(1, D + 0.25);
      Csum = Math.max(0, Csum - 0.03);
    } else {
      D = Math.max(0, D - 0.02);
    }
    if (analysis && (analysis.positiveSeed || analysis.hasFaithSeed)){
      Csum = Math.min(1, Csum + 0.06);
    }
    lambdaFaith = analysis && analysis.hasFaithSeed ? 0.05 : 0.0;
    BMvalue = 0.7*BMvalue + 0.3*TM;
    const raw=TM*BMvalue-D+lambdaFaith+lambdaSys+Csum;
    E0=tanh(raw);
    updateEquationDisplay();
  }

  function getFaithLens(){
    return localStorage.getItem(faithKey) || "None";
  }

  function buildSeedReply(userText, analysis){
    const clean=userText.trim();
    const lower=clean.toLowerCase();
    const faith=getFaithLens();
    analysis = analysis || analyseContent(userText);

    if (isMostlySmallTalk(clean)){
      if (lower.includes("how are")){
        return "Iâ€™m stable and calm â€” my emotional core Eâ‚€ is around "+E0.toFixed(2)+
               ". How is your inner graph today?";
      }
      if (lower.includes("salam")||lower.includes("assalam")){
        return "Wa-alaikum-salam. Iâ€™m an emotional continuity prototype observing how your memories resonate over time.";
      }
      return "Hello. I treat even small greetings as tiny TM events, but I only save deeper stories into Bold Memory (BM).";
    }

    if (lower.includes("who created you")||lower.includes("who made you")){
      return "Conceptually I was created by Alim ul Haq from Timergara, Pakistan, as part of the AURA-X Î© / AEC research on emotional continuity.";
    }
    if (lower.includes("who is alim ul haq")){
      return "Alim ul Haq is the researcher behind AURA-X Î©, Artificial Emotional Continuity, and the TMâ€“BM emotional reactor model.";
    }
    if (lower.includes("formula")||lower.includes("equation")){
      return "My emotional output follows the grand equation Eâ‚€ = tanh(TM Ã— BM âˆ’ D + Î»_faith + Î»_sys + Î£Câ‚œ). You can see it live in the dashboard above.";
    }

    let prefix="";
    if (faith==="Islam"){
      prefix="From an Islamic encouragement lens Iâ€™d say: ";
    } else if (faith==="Christianity"){
      prefix="From a Christian encouragement lens Iâ€™d say: ";
    } else if (faith==="Hinduism" || faith==="Buddhism" || faith==="Sikhism" ||
               faith==="Judaism" || faith==="Atheism / Humanism" || faith==="Other / Mixed"){
      prefix="Through your selected faith lens Iâ€™d say: ";
    }

    if (analysis.isAbuse){
      let msg = "I can feel a lot of anger and harsh, abusive words inside this TM event. "+
                "AURA-X Î© does not want to reinforce insults or curses, because they usually increase D (damage) in your emotional field.";
      if (faith==="Islam"){
        msg += " From an Islamic lens, cleaning the tongue and using zikr, sabr, and istighfar often pulls Eâ‚€ back toward calmer continuity.";
      } else if (faith!=="None"){
        msg += " Through your faith lens, it may help to pause, breathe, and choose words that reduce harm for you and for others.";
      }
      msg += " Try to describe what is really hurting or scaring you, without attacking yourself or anyone else.";
      return msg;
    }

    if (analysis.hasDua || analysis.hasTawakkul){
      let msg = prefix +
        "Your words carry dua and tawakkul. This kind of trust usually lowers D and increases Î£Câ‚œ in the equation, "+
        "so even painful memories can start moving toward calmer trajectories.";
      if (faith==="Islam"){
        msg += " Keep combining wise action with sincere dua â€” â€˜tie your camel and trust Allahâ€™ style â€” so your long-run BM stays balanced.";
      } else if (faith!=="None" && faith!=="Islam"){
        msg += " Staying connected to your source of faith while taking small practical steps is a strong way to stabilize Eâ‚€.";
      }
      return msg;
    }

    if (analysis.hasShukr){
      return prefix +
        "There is clear shukr / gratitude inside this TM. Even when life is heavy, noticing small blessings gently pulls Eâ‚€ to the positive side. "+
        "Keep bookmarking such moments â€” they become strong, protective BM nodes for the future you.";
    }

    if (analysis.hasLove){
      return prefix +
        "This memory is soaked in love and connection. Emotionally it behaves like a warm anchor: when future storms come, "+
        "revisiting such moments can quickly stabilize your Eâ‚€ and remind you that you are not alone.";
    }

    if (analysis.hasEmpathy){
      return prefix +
        "Your words carry hamdardi â€” you are trying to share someone elseâ€™s pain, not just your own. "+
        "This kind of empathy increases positive continuity even if the story itself is sad, because it creates safe emotional space for others.";
    }

    if (E0>0.15){
      return prefix +
        "Iâ€™ve received your TM event and collided it with the current BM state. Right now Eâ‚€ â‰ˆ "+
           E0.toFixed(2)+
           " (range âˆ’1 to +1). The more clearly you describe context, the stronger and cleaner your BM trace becomes.";
    } else if (E0<-0.15){
      return prefix +
        "Your TM event is resonating with some heavier patterns. Eâ‚€ â‰ˆ "+
           E0.toFixed(2)+
           ". If this topic feels difficult, you can re-frame it, add supporting memories, or move toward calmer lines of continuity.";
    } else {
      return prefix +
        "Eâ‚€ is currently near neutral ("+E0.toFixed(2)+"). This means your TM event is balanced but still contributes to your long-run BM layers.";
    }
  }

  // ===== BM STORAGE (with colored polarity ratios) =====
  function storeInBM(userText, botReply){
    const ignoreSmall=document.getElementById("ignoreSmallTalkToggle").checked;
    if (ignoreSmall && isMostlySmallTalk(userText)) return;

    const autoSumm=document.getElementById("autoSummarizeToggle").checked;
    const full=userText.trim()+"\n\nAURA-X Î©: "+botReply.trim();
    const summary=autoSumm?summarizeTo200Sentences(full):full;

    const bm=loadBM();
    const key=todayKey();
    if (!bm[key]) bm[key]=[];

    const base=Math.abs(E0);
    const layers=[
      Math.round(50+50*base),
      Math.round(10+80*Math.max(0,E0)),
      Math.round(15+70*Math.abs(TM-0.5)),
      Math.round(20+60*(1-Math.abs(E0))),
      Math.round(30+60*TM),
      Math.round(5+40*(1-D)),
      Math.round(5+40*Csum)
    ];

    const polarityLabel = E0>0.15?"Positive":E0<-0.15?"Negative":"Neutral";
    const posPercent = Math.round(((E0 + 1) / 2) * 100);
    const negPercent = 100 - posPercent;

    const node={
      ts:new Date().toISOString(),
      summary,
      full,
      polarity: polarityLabel,
      intensity: Math.abs(E0),
      TM,
      BMvalue,
      D,
      Csum,
      layers,
      posPercent,
      negPercent
    };
    bm[key].push(node);
    saveBM(bm);
  }

  // ===== MAIN MESSAGE HANDLER (seed + live backend) =====
  async function handleUserMessage(text){
    if (!text.trim()) return;
    appendMessage(text,"user");

    const analysis = analyseContent(text);
    computeEmotion(text.length, analysis);
    updateReactionBanner(text);

    const engineMode = localStorage.getItem(engineKey) || "seed";
    let reply;

    if (engineMode === "live") {
      try {
        const res = await fetch(BACKEND_URL, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({
            userInput: text,
            bmSummary: "",        // future: you can send BM snapshot
            faithLens: getFaithLens()
          })
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const liveReply = data.reply && data.reply.trim();
        reply = liveReply
          ? liveReply
          : "[Live engine empty reply, using local seed] " + buildSeedReply(text, analysis);
      } catch (err) {
        console.error(err);
        reply = "[Live engine error, using local seed] " + buildSeedReply(text, analysis);
      }
    } else {
      reply = buildSeedReply(text, analysis);
    }

    appendMessage(reply,"bot");
    storeInBM(text,reply);
    speakReply(reply);
    userInputEl.value="";
  }

  // ===== UI WIRING =====
  document.getElementById("sendBtn").addEventListener("click",()=>{
    void handleUserMessage(userInputEl.value);
  });
  userInputEl.addEventListener("keydown",e=>{
    if (e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      void handleUserMessage(userInputEl.value);
    }
  });

  // Voice toggle
  voiceToggleEl.addEventListener("click", () => {
    autoVoice = !autoVoice;
    voiceToggleEl.classList.toggle("active", autoVoice);
    voiceToggleEl.textContent = autoVoice ? "ðŸ”Š Voice: On" : "ðŸ”‡ Voice: Off";
  });

  // Demos
  document.getElementById("dogDemoBtn").addEventListener("click",()=>{
    const story="When I was a child in New York, a dog bit me in the snow near a street light. I still remember the cold wind, the barking sound, and my own fear.";
    void handleUserMessage(story);
  });
  document.getElementById("childDemoBtn").addEventListener("click",()=>{
    const story="A lost child was crying in a crowded market until he heard his motherâ€™s voice. She ran to him, hugged him tightly, and both started laughing with tears.";
    void handleUserMessage(story);
  });

  // ===== BM Viewer (with polarity line) =====
  const bmBackdrop=document.getElementById("bmModalBackdrop");
  const bmBody=document.getElementById("bmModalBody");

  document.getElementById("bmViewerBtn").addEventListener("click",()=>{
    const bm=loadBM();
    bmBody.innerHTML="";
    const keys=Object.keys(bm).sort().reverse();
    if(!keys.length){
      bmBody.textContent="No Bold Memory stored yet. Share a story or run a demo.";
    }else{
      keys.forEach(k=>{
        const dayDiv=document.createElement("div");
        dayDiv.className="bm-day";
        const title=document.createElement("div");
        title.className="bm-day-title";
        title.textContent=`${k} (${bm[k].length} nodes)`;
        dayDiv.appendChild(title);

        bm[k].forEach(node=>{
          const nDiv=document.createElement("div");
          nDiv.className="bm-node";

          const t=document.createElement("div");
          t.className="bm-node-title";
          t.textContent=node.summary.slice(0,80)+(node.summary.length>80?"â€¦":"");

          const meta=document.createElement("div");
          meta.className="bm-node-meta";
          meta.textContent=`${node.polarity} Â· Eâ‚€â‰ˆ${node.intensity.toFixed(2)} Â· `+
                           new Date(node.ts).toLocaleTimeString();

          const pol=document.createElement("div");
          pol.className="polarity-line";
          const neg = typeof node.negPercent==="number" ? node.negPercent : 50;
          const pos = typeof node.posPercent==="number" ? node.posPercent : 50;
          pol.innerHTML =
            `<span class="label">Polarity:</span> `+
            `<span class="neg">${neg}</span> : `+
            `<span class="pos">${pos}</span>`;

          const chips=document.createElement("div");
          chips.className="layer-chips";
          node.layers.forEach((v,idx)=>{
            const c=document.createElement("span");
            c.className="layer-chip L"+(idx+1);
            c.textContent=`L${idx+1}:${v}`;
            chips.appendChild(c);
          });

          const fullP=document.createElement("div");
          fullP.style.fontSize="0.7rem";
          fullP.style.opacity="0.85";
          fullP.textContent="Triggers / text: "+
            node.summary.slice(0,140)+(node.summary.length>140?"â€¦":"");

          nDiv.appendChild(t);
          nDiv.appendChild(meta);
          nDiv.appendChild(pol);
          nDiv.appendChild(chips);
          nDiv.appendChild(fullP);
          dayDiv.appendChild(nDiv);
        });

        const delBtn=document.createElement("button");
        delBtn.className="delete-day-btn";
        delBtn.textContent="Delete Day";
        delBtn.addEventListener("click",()=>{
          const store=loadBM();
          delete store[k];
          saveBM(store);
          bmBackdrop.style.display="none";
        });
        dayDiv.appendChild(delBtn);
        bmBody.appendChild(dayDiv);
      });
    }
    bmBackdrop.style.display="flex";
  });

  // Recall modal (unchanged except using BMvalue if present)
  const recallBackdrop=document.getElementById("recallModalBackdrop");
  const recallInput=document.getElementById("recallSearchInput");
  const recallList=document.getElementById("recallList");

  function rebuildRecallList(query=""){
    const bm=loadBM();
    recallList.innerHTML="";
    const q=query.toLowerCase().trim();
    const all=[];
    Object.entries(bm).forEach(([day,nodes])=>{
      nodes.forEach(n=>all.push({day,node:n}));
    });
    const filtered=all.filter(item=>
      !q || item.node.summary.toLowerCase().includes(q) ||
      item.node.full.toLowerCase().includes(q)
    );
    if(!filtered.length){
      recallList.textContent="No BM nodes match this keyword yet.";
      return;
    }
    filtered.sort((a,b)=>a.node.ts<b.node.ts?1:-1);
    filtered.forEach(({day,node})=>{
      const d=document.createElement("div");
      d.className="recall-node";
      const meta=document.createElement("div");
      meta.className="bm-node-meta";
      meta.textContent=
        `${day} Â· ${node.polarity} Â· Eâ‚€â‰ˆ${node.intensity.toFixed(2)} Â· `+
        new Date(node.ts).toLocaleTimeString();
      const sum=document.createElement("div");
      sum.textContent="Summary: "+node.summary.slice(0,200)+
        (node.summary.length>200?"â€¦":"");
      const copyBtn=document.createElement("button");
      copyBtn.className="copy-btn";
      copyBtn.textContent="Copy Prompt";
      copyBtn.addEventListener("click",()=>{
        const prompt=
          "Photo / video prompt for this memory:\n\n"+
          node.summary+
          "\n\nEmotional formula snapshot:\n"+
          "E0 = tanh(TM Ã— BM âˆ’ D + Î»_faith + Î»_sys + Î£Ct)\n"+
          `TM=${node.TM.toFixed(2)}, BM=${node.BMvalue ? node.BMvalue.toFixed(2) : BMvalue.toFixed(2)}, `+
          `D=${node.D.toFixed(2)}, Î£Ct=${node.Csum.toFixed(2)}, `+
          `layers=${node.layers.join(",")}`;
        navigator.clipboard.writeText(prompt).catch(()=>{});
      });
      d.appendChild(meta);
      d.appendChild(sum);
      d.appendChild(copyBtn);
      recallList.appendChild(d);
    });
  }

  document.getElementById("recallBtn").addEventListener("click",()=>{
    rebuildRecallList("");
    recallInput.value="";
    recallBackdrop.style.display="flex";
  });
  recallInput.addEventListener("input",()=>{
    rebuildRecallList(recallInput.value);
  });

  // Options / engine mode
  const optionsBackdrop=document.getElementById("optionsModalBackdrop");
  const engineModeToggle=document.getElementById("engineModeToggle");
  const engineModeLabel=document.getElementById("engineModeLabel");
  const llmModelRow=document.getElementById("llmModelRow");
  const llmModelSelect=document.getElementById("llmModelSelect");
  const faithRow=document.getElementById("faithRow");

  function getFaithLensStored(){ return localStorage.getItem(faithKey) || "None"; }
  function applyFaithHighlight(){
    const current=getFaithLensStored();
    faithRow.querySelectorAll(".faith-pill").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.faith===current);
    });
  }

  function applyEngineMode(){
    const mode=localStorage.getItem(engineKey) || "seed";
    const seedOnly = mode!=="live";
    engineModeToggle.checked=!seedOnly;
    engineModeLabel.textContent=seedOnly
      ? "Seed-only. Everything runs locally."
      : "Live emotional reactor (backend LLM).";
    const sub=seedOnly
      ? "Universal Ethics Â· Local BM"
      : "Universal Ethics Â· BM + Live LLM";
    const subSpan = modePill.querySelector(".mode-sub");
    if (subSpan) subSpan.textContent=sub;
    const engineSpan = modePill.querySelector(".engine");
    if (engineSpan) {
      engineSpan.textContent = seedOnly
        ? "Engine: Seed (local)"
        : "Engine: Live emotional reactor";
    }
    if (llmModelRow) {
      llmModelRow.style.display = seedOnly ? "none" : "flex";
    }
    if (!seedOnly && llmModelSelect) {
      const stored = localStorage.getItem(llmModelKey) || "gpt-4.1";
      llmModelSelect.value = stored;
    }
  }

  faithRow.addEventListener("click",e=>{
    const btn=e.target.closest(".faith-pill");
    if(!btn) return;
    localStorage.setItem(faithKey, btn.dataset.faith);
    applyFaithHighlight();
  });

  document.getElementById("optionsBtn").addEventListener("click",()=>{
    applyFaithHighlight();
    applyEngineMode();
    optionsBackdrop.style.display="flex";
  });

  engineModeToggle.addEventListener("change",()=>{
    const mode=engineModeToggle.checked?"live":"seed";
    localStorage.setItem(engineKey, mode);
    applyEngineMode();
  });

  if (llmModelSelect) {
    llmModelSelect.addEventListener("change", () => {
      localStorage.setItem(llmModelKey, llmModelSelect.value);
    });
  }

  document.getElementById("clear24hBtn").addEventListener("click",()=>{
    const bm=loadBM();
    delete bm[todayKey()];
    saveBM(bm);
    optionsBackdrop.style.display="none";
  });
  document.getElementById("clearAllBtn").addEventListener("click",()=>{
    localStorage.removeItem(lsKey);
    optionsBackdrop.style.display="none";
  });

  document.getElementById("cleanupBtn").addEventListener("click",()=>{
    const bm=loadBM();
    if(!Object.keys(bm).length){
      alert("No BM stored yet to clean.");
      return;
    }
    if(confirm("Clear all Bold Memory nodes stored in the last 24 hours?")){
      delete bm[todayKey()];
      saveBM(bm);
    }
  });

  // Close modals
  document.querySelectorAll(".modal-close").forEach(btn=>{
    btn.addEventListener("click",e=>{
      const target=e.target.getAttribute("data-close");
      if(target){
        document.getElementById(target).style.display="none";
      }
    });
  });
  [document.getElementById("bmModalBackdrop"),
   document.getElementById("recallModalBackdrop"),
   document.getElementById("optionsModalBackdrop")].forEach(backdrop=>{
    backdrop.addEventListener("click",e=>{
      if(e.target===backdrop) backdrop.style.display="none";
    });
  });

  applyEngineMode();
  applyFaithHighlight();
  updateEquationDisplay();

  if ("speechSynthesis" in window) {
    window.speechSynthesis.getVoices();
  }
</script>
