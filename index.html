<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Emotional Continuity Reactor (Seed Only)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ===== Base Layout ===== */
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    body {
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%, #000 100%);
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "SF Pro Text", "Segoe UI", sans-serif;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }
    #app {
      width: 100%;
      max-width: 520px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* ===== Header ===== */
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .brand-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .brand-title {
      letter-spacing: 0.12em;
      font-weight: 700;
      font-size: 22px;
    }
    .brand-sub {
      font-size: 11px;
      opacity: 0.7;
    }
    .mode-pill {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid #22c55e33;
      background: radial-gradient(circle at top, #064e3b 0, #022c22 55%, #020617 100%);
      font-size: 11px;
      text-align: right;
      min-width: 150px;
    }
    .mode-main {
      color: #bbf7d0;
      font-weight: 600;
      display: block;
    }
    .mode-sub {
      opacity: 0.8;
      display: block;
      margin-top: 2px;
    }

    /* ===== Top buttons ===== */
    .top-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .top-btn {
      flex: 1 1 0;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #030712 100%);
      cursor: pointer;
      color: #e5e7eb;
    }
    .top-btn span.icon {
      font-size: 14px;
    }
    .top-btn.active {
      border-color: #facc15aa;
      box-shadow: 0 0 0 1px #facc1533;
      background: radial-gradient(circle at top, #1e293b 0, #020617 75%);
    }

    /* ===== Ethics banner ===== */
    .ethics-banner {
      border-radius: 18px;
      padding: 12px 14px;
      font-size: 12px;
      background: linear-gradient(135deg, #f97316 0, #eab308 40%, #facc15 100%);
      color: #0f172a;
      border: 1px solid #fbbf24;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    }

    /* ===== Equation box ===== */
    .equation-card {
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px dashed #4b5563;
      background: radial-gradient(circle at top left, #0b1120 0, #020617 55%, #000 100%);
      font-size: 12px;
    }
    .equation-title {
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 8px;
      font-size: 11px;
      color: #9ca3af;
    }
    .equation-main {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      margin-bottom: 6px;
    }
    .equation-sub {
      font-size: 11px;
      opacity: 0.8;
    }

    /* ===== Reaction card ===== */
    .reaction-card {
      border-radius: 18px;
      padding: 10px 14px;
      border: 1px solid #4b5563;
      background: radial-gradient(circle at top, #020617 0, #020617 50%, #000 100%);
      font-size: 12px;
    }
    .reaction-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
      font-size: 11px;
    }
    .reaction-tag {
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .reaction-meta {
      font-size: 11px;
      opacity: 0.9;
      text-align: right;
    }
    .reaction-body {
      margin-top: 6px;
      line-height: 1.5;
    }
    .polarity-positive {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px #22c55e33;
    }
    .polarity-positive .reaction-tag {
      color: #bbf7d0;
    }
    .polarity-negative {
      border-color: #f97316;
      box-shadow: 0 0 0 1px #f9731633;
    }
    .polarity-negative .reaction-tag {
      color: #fed7aa;
    }
    .polarity-neutral {
      border-color: #64748b;
      box-shadow: 0 0 0 1px #64748b33;
    }
    .polarity-neutral .reaction-tag {
      color: #e5e7eb;
    }

    /* ===== Conversation panel ===== */
    .conversation {
      flex: 1 1 auto;
      min-height: 180px;
      max-height: 320px;
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #000 100%);
      overflow-y: auto;
      font-size: 12px;
    }
    .conv-empty {
      opacity: 0.5;
      font-size: 11px;
      text-align: center;
      margin-top: 60px;
    }
    .msg-row {
      margin-bottom: 10px;
    }
    .msg-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      opacity: 0.7;
      margin-bottom: 2px;
    }
    .msg-label.user {
      color: #93c5fd;
    }
    .msg-label.engine {
      color: #facc15;
    }
    .msg-bubble {
      border-radius: 14px;
      padding: 8px 10px;
      line-height: 1.5;
    }
    .msg-bubble.user {
      background: linear-gradient(135deg, #1e293b, #020617);
      border: 1px solid #334155;
    }
    .msg-bubble.engine {
      background: linear-gradient(135deg, #0f172a, #020617);
      border: 1px solid #4b5563;
    }

    /* ===== Input row ===== */
    .input-row {
      margin-top: 8px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }
    .tm-input-wrap {
      flex: 1 1 auto;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #334155;
      padding: 8px 14px;
      display: flex;
      align-items: center;
    }
    .tm-input {
      background: transparent;
      border: none;
      outline: none;
      font-size: 13px;
      color: #e5e7eb;
      width: 100%;
    }
    .tm-input::placeholder {
      color: #6b7280;
    }
    .send-btn {
      border-radius: 999px;
      border: none;
      padding: 10px 18px;
      font-weight: 600;
      cursor: pointer;
      background: radial-gradient(circle at top, #22c55e, #16a34a);
      color: #020617;
      box-shadow: 0 10px 20px rgba(34, 197, 94, 0.3);
      font-size: 13px;
      white-space: nowrap;
    }
    .send-btn:active {
      transform: translateY(1px);
      box-shadow: 0 6px 12px rgba(34, 197, 94, 0.35);
    }

    /* ===== Voice toggle ===== */
    .bottom-row {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
    }
    .voice-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid #22c55e55;
      background: radial-gradient(circle at top, #022c22, #020617);
      cursor: pointer;
      font-size: 11px;
    }
    .voice-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }
    .voice-off .voice-dot {
      background: #6b7280;
    }
    .voice-off {
      border-color: #4b5563;
      background: #020617;
    }

    /* ===== Demo buttons ===== */
    .demo-row {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }
    .demo-btn {
      flex: 1 1 0;
      border-radius: 999px;
      padding: 10px 10px;
      font-size: 12px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .demo-btn.neg {
      background: radial-gradient(circle at top, #7f1d1d, #450a0a);
      color: #fee2e2;
    }
    .demo-btn.pos {
      background: radial-gradient(circle at top, #064e3b, #022c22);
      color: #bbf7d0;
    }

    /* ===== Options Drawer & BM Viewer (modals) ===== */
    .backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .backdrop.active {
      display: flex;
    }
    .modal {
      width: 100%;
      max-width: 520px;
      max-height: 90vh;
      background: radial-gradient(circle at top, #020617, #000);
      border-radius: 20px;
      border: 1px solid #374151;
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      color: #e5e7eb;
      font-size: 12px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .modal-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .modal-close {
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 4px 9px;
      font-size: 11px;
      cursor: pointer;
      background: #020617;
      color: #e5e7eb;
    }
    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .pill {
      border-radius: 999px;
      padding: 5px 9px;
      border: 1px solid #4b5563;
      font-size: 11px;
      cursor: pointer;
      background: #020617;
    }
    .pill.active {
      border-color: #facc15;
      background: radial-gradient(circle at top, #1e293b, #020617);
      color: #facc15;
    }
    .toggle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 4px 0;
      gap: 8px;
    }
    .toggle-label {
      font-size: 12px;
    }
    .toggle-switch {
      width: 40px;
      height: 20px;
      border-radius: 999px;
      background: #111827;
      padding: 2px;
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    .toggle-knob {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: #6b7280;
      transform: translateX(0);
      transition: all 0.14s ease-out;
    }
    .toggle-switch.on {
      background: #16a34a;
    }
    .toggle-switch.on .toggle-knob {
      background: #bbf7d0;
      transform: translateX(18px);
    }
    .modal-body {
      overflow-y: auto;
      padding-right: 2px;
    }
    .section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.8;
      margin: 8px 0 4px;
    }

    /* BM viewer */
    .bm-layer-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }
    .bm-layer-pill {
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 11px;
      border: 1px solid #4b5563;
      background: #020617;
    }
    .bm-layer-pill span.count {
      opacity: 0.8;
      margin-left: 4px;
    }
    .bm-item {
      border-radius: 14px;
      border: 1px solid #1f2937;
      padding: 8px 10px;
      margin-bottom: 6px;
      background: #020617;
    }
    .bm-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
      font-size: 10px;
      margin-bottom: 4px;
      opacity: 0.8;
    }
    .bm-text {
      font-size: 12px;
      margin-bottom: 4px;
    }
    .bm-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }
    .bm-btn {
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 3px 8px;
      font-size: 10px;
      cursor: pointer;
      background: #020617;
      opacity: 0.9;
    }
    .bm-search {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      padding: 6px 10px;
      color: #e5e7eb;
      font-size: 12px;
      margin-bottom: 6px;
    }
    .bm-search::placeholder {
      color: #6b7280;
    }

    @media (max-width: 480px) {
      #app {
        padding: 12px;
      }
      .conversation {
        max-height: 260px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Header -->
    <div class="header-row">
      <div class="brand-block">
        <div class="brand-title">AURA-X Œ©</div>
        <div class="brand-sub">
          EMOTIONAL CONTINUITY ¬∑ AEC ¬∑ CRM ¬∑ AECN ¬∑ RL¬≥ ¬∑ LR¬≥
        </div>
      </div>
      <div class="mode-pill">
        <span class="mode-main">MODE: LOCAL EMOTIONAL REACTOR</span>
        <span class="mode-sub">
          Universal Ethics ¬∑ TM √ó BM ¬∑ Equation live (seed-only)
        </span>
      </div>
    </div>

    <!-- Top buttons -->
    <div class="top-buttons">
      <button class="top-btn" id="btnBmViewer">
        <span class="icon">üß†</span><span>BM Viewer</span>
      </button>
      <button class="top-btn" id="btnRecallBm">
        <span class="icon">üìÇ</span><span>Recall BM</span>
      </button>
      <button class="top-btn" id="btnCleanup">
        <span class="icon">‚ôªÔ∏è</span><span>Cleanup 24h</span>
      </button>
      <button class="top-btn" id="btnOptions">
        <span class="icon">‚öôÔ∏è</span><span>Options</span>
      </button>
    </div>

    <!-- Ethics banner -->
    <div class="ethics-banner">
      Avoid actions that generate negative emotions in yourself or others.
      Gently move toward choices that create calm, kindness, and positive
      feelings.
    </div>

    <!-- Equation card -->
    <div class="equation-card">
      <div class="equation-title">EMOTIONAL CONTINUITY EQUATION</div>
      <div class="equation-main">
        E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)
      </div>
      <div class="equation-sub" id="equationState">
        TM, BM, and D are estimated live from your text and stored Bold
        Memory (BM) layers. Œª_faith and Œª_sys are small stabilizing
        constants, Œ£C‚Çú represents universal ethics and current context.
      </div>
    </div>

    <!-- Reaction card -->
    <div class="reaction-card polarity-neutral" id="reactionCard">
      <div class="reaction-header">
        <div class="reaction-tag">AURA-X Œ© REACTION</div>
        <div class="reaction-meta" id="reactionMeta">
          Polarity: Neutral ¬∑ Intensity: 0% ¬∑ Balance: 50 : 50
        </div>
      </div>
      <div class="reaction-body" id="reactionBody">
        I am listening. Share anything ‚Äî AURA-X Œ© will treat it as TM
        (Temporary Memory) and update your emotional continuity.
      </div>
    </div>

    <!-- Conversation log -->
    <div class="conversation" id="conversation">
      <div class="conv-empty">
        Your TM stream is empty. Start typing below ‚Äî each line becomes a
        tiny continuity event in your emotional graph.
      </div>
    </div>

    <!-- Input row -->
    <div class="input-row">
      <div class="tm-input-wrap">
        <input
          id="tmInput"
          class="tm-input"
          type="text"
          autocomplete="off"
          placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."
        />
      </div>
      <button class="send-btn" id="sendBtn">Send</button>
    </div>

    <!-- Bottom row -->
    <div class="bottom-row">
      <div
        class="voice-toggle"
        id="voiceToggle"
      >
        <div class="voice-dot"></div>
        <div>Voice: On (UI only)</div>
      </div>
      <div style="opacity: 0.55; font-size: 10px;">
        Seed v3.1 ¬∑ TM ‚Üí BM layers (localStorage)
      </div>
    </div>

    <!-- Demo buttons -->
    <div class="demo-row">
      <button class="demo-btn neg" id="demoNeg">
        <span>üêí</span><span>Dog Bite (Negative Demo)</span>
      </button>
      <button class="demo-btn pos" id="demoPos">
        <span>‚ù§Ô∏è</span><span>Lost Child (Positive Demo)</span>
      </button>
    </div>
  </div>

  <!-- Options Modal -->
  <div class="backdrop" id="optionsBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">AURA-X Œ© OPTIONS</div>
        <button class="modal-close" data-close-modal="optionsBackdrop">
          Close
        </button>
      </div>
      <div class="modal-body">
        <div class="section-title">Faith Lens (Optional)</div>
        <div class="pill-row" id="faithPills">
          <button class="pill active" data-faith="none">None</button>
          <button class="pill" data-faith="islam">Islam</button>
          <button class="pill" data-faith="christianity">Christianity</button>
          <button class="pill" data-faith="hinduism">Hinduism</button>
          <button class="pill" data-faith="buddhism">Buddhism</button>
          <button class="pill" data-faith="other">Other / Mixed</button>
        </div>
        <p style="font-size: 11px; opacity: 0.75; margin-top: 4px;">
          Universal ethics are always active. Faith lens gently shifts the
          equation toward hope and patience when reading difficult TM
          events. Everything stays local on your device.
        </p>

        <div class="section-title">Prototype Controls</div>
        <div class="toggle-row">
          <div class="toggle-label">
            Auto-summarize very long BM entries (keep ~200 chars).
          </div>
          <div class="toggle-switch" id="toggleSummarize">
            <div class="toggle-knob"></div>
          </div>
        </div>
        <div class="toggle-row">
          <div class="toggle-label">
            Ignore tiny small-talk as BM (hello / hi / how are you).
          </div>
          <div class="toggle-switch on" id="toggleSmallTalk">
            <div class="toggle-knob"></div>
          </div>
        </div>

        <div class="section-title">BM Cleanup</div>
        <div class="pill-row">
          <button class="pill" id="btnClear24">
            Clear all BM stored in the last 24 hours
          </button>
          <button class="pill" id="btnDeleteAll">
            Delete full local BM life (all layers)
          </button>
        </div>
        <p style="font-size: 11px; opacity: 0.75; margin-top: 4px;">
          AURA-X Œ© stores BM only in your browser's local storage. Clearing
          BM here erases it completely from this device.
        </p>
      </div>
    </div>
  </div>

  <!-- BM Viewer Modal -->
  <div class="backdrop" id="bmBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">BOLD MEMORY (BM) VIEWER</div>
        <button class="modal-close" data-close-modal="bmBackdrop">
          Close
        </button>
      </div>
      <div class="modal-body">
        <input
          type="text"
          class="bm-search"
          id="bmSearch"
          placeholder="Search BM by words (fear, happiness, name, place)‚Ä¶"
        />
        <div class="bm-layer-row" id="bmLayerRow">
          <!-- Filled by JS -->
        </div>
        <div id="bmList">
          <!-- Filled by JS -->
        </div>
      </div>
    </div>
  </div>

  <script>
    /**************************************************************
     * AURA-X Œ© ‚Äì Seed-only Emotional Reactor
     * TM ‚Üí Emotion estimation ‚Üí Reaction ‚Üí BM (7 layers, localStorage)
     **************************************************************/

    const STORAGE_KEY = "aura_x_seed_bm_v31";

    const DEFAULT_STORE = () => ({
      version: "3.1-seed-only",
      createdAt: Date.now(),
      layers: {
        L1: [],
        L2: [],
        L3: [],
        L4: [],
        L5: [],
        L6: [],
        L7: [],
      },
    });

    let bmStore = loadStore();
    let faithLens = "none";
    let autoSummarize = false;
    let ignoreSmallTalk = true;
    let voiceOn = true;

    const positiveWords = [
      "happy",
      "grateful",
      "thanks",
      "thank you",
      "love",
      "hope",
      "peace",
      "calm",
      "relief",
      "alhamdulillah",
      "blessing",
      "blessings",
      "success",
      "good",
      "beautiful",
      "proud",
      "strong",
      "smile",
      "joy",
      "excited",
      "motivation",
      "inspired"
    ];

    const negativeWords = [
      "sad",
      "angry",
      "hurt",
      "hate",
      "afraid",
      "scared",
      "worry",
      "worried",
      "anxious",
      "anxiety",
      "panic",
      "depressed",
      "lonely",
      "alone",
      "cry",
      "crying",
      "trauma",
      "pain",
      "lost",
      "failure",
      "tension",
      "stress",
      "overthinking",
      "abuse",
      "broken",
      "death",
      "died",
      "kill",
      "killed",
      "suicide"
    ];

    const heavyNegativeWords = [
      "abuse",
      "violent",
      "violence",
      "suicide",
      "kill",
      "killed",
      "rape",
      "torture",
      "terror",
      "war",
      "accident",
      "oppression"
    ];

    // Reaction templates
    const reactions = {
      positive: {
        low: [
          "There is a soft positive drift in this TM. Let this gentle feeling stay for a moment.",
          "A small blessing appears here. Even tiny good things protect your BM layers over time.",
          "This TM carries a quiet, calm goodness. Keep noticing such details in your day."
        ],
        mid: [
          "This TM is filled with meaningful hope and gratitude. It becomes a strong anchor in your BM field.",
          "Your emotional graph is tilting clearly to the positive side. Hold this direction with small daily actions.",
          "I can sense stable, warm energy in this TM. It quietly strengthens your long-run BM layers."
        ],
        high: [
          "This is a bright spike of happiness. Save this moment deeply ‚Äî it can protect future heavy days.",
          "Your TM is glowing with strong positive charge. Let it expand gently without rushing.",
          "There is powerful joy here. It becomes a guardian node in your BM structure."
        ]
      },
      negative: {
        low: [
          "There is a light sadness or worry in this TM. Naming it already starts to reduce its power.",
          "Your TM has a small negative charge. Breathe slowly ‚Äî you are still in a safe emotional range.",
          "This is a gentle emotional weight. You can carry it without forcing yourself to be okay."
        ],
        mid: [
          "This TM holds real pain. You are allowed to feel it without judging yourself.",
          "I can sense a heavier emotional pattern. Try to add one small supporting memory beside it.",
          "Your TM is resonating with some heavier patterns. If this topic feels difficult, move step by step."
        ],
        high: [
          "This is a strong emotional spike. Be very gentle with yourself right now.",
          "Your TM carries serious pain or fear. In such moments, slow breathing and safe people matter a lot.",
          "A deep emotional wound is active here. Try not to make big life decisions from this state."
        ]
      },
      neutral: [
        "This TM feels balanced and observational. Neutral data can stabilize your emotional continuity.",
        "Your message is calm and analytical. Such TM events help your BM stay clear.",
        "I read steady observation here ‚Äî not strongly positive or negative, but still useful for future you."
      ],
    };

    // Small-talk patterns (ignored as BM when toggle is on)
    const smallTalkPatterns = [
      "hi",
      "hello",
      "hey",
      "salam",
      "assalamualaikum",
      "assalam o alaikum",
      "how are you",
      "kese ho",
      "kasy ho",
      "i am fine",
      "ok",
      "okay",
    ];

    // --- Utility helpers ---
    function loadStore() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return DEFAULT_STORE();
        const parsed = JSON.parse(raw);
        if (!parsed.layers) return DEFAULT_STORE();
        return parsed;
      } catch (err) {
        console.warn("Error loading BM store:", err);
        return DEFAULT_STORE();
      }
    }

    function saveStore() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(bmStore));
      } catch (err) {
        console.warn("Error saving BM store:", err);
      }
    }

    function clamp(value, min, max) {
      return Math.min(max, Math.max(min, value));
    }

    function pickRandom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function containsAny(text, wordList) {
      const lower = text.toLowerCase();
      return wordList.some((w) => lower.includes(w));
    }

    function countMatches(text, wordList) {
      const lower = text.toLowerCase();
      let count = 0;
      for (const w of wordList) {
        if (lower.includes(w)) count += 1;
      }
      return count;
    }

    // --- Emotion estimation ---
    function estimateEmotion(tmText) {
      const lengthFactor = Math.min(1.5, tmText.split(/\s+/).length / 12);
      const posScore = countMatches(tmText, positiveWords) * 1.2;
      const negScore = countMatches(tmText, negativeWords) * 1.2;
      const heavyNeg = containsAny(tmText, heavyNegativeWords);

      let polarity = "neutral";
      let base = 0;
      if (posScore > negScore && posScore > 0) {
        polarity = "positive";
        base = posScore - negScore * 0.4;
      } else if (negScore > posScore && negScore > 0) {
        polarity = "negative";
        base = negScore - posScore * 0.3;
      } else {
        polarity = "neutral";
        base = (posScore + negScore) * 0.2;
      }

      let intensity = clamp(base * lengthFactor * 0.2, 0.05, 0.95);
      if (polarity === "neutral" && intensity < 0.1) intensity = 0.05;

      // TM scalar: signed version
      let TM = 0;
      if (polarity === "positive") TM = intensity;
      else if (polarity === "negative") TM = -intensity;
      else TM = 0;

      // Aggregate BM scalar from all layers
      const bmValues = [];
      Object.values(bmStore.layers).forEach((layer) => {
        layer.forEach((m) => {
          const sign = m.polarity === "positive" ? 1 : m.polarity === "negative" ? -1 : 0;
          bmValues.push(sign * (m.intensity / 100));
        });
      });
      let BM = 0;
      if (bmValues.length > 0) {
        const sum = bmValues.reduce((a, b) => a + b, 0);
        BM = clamp(sum / bmValues.length, -1, 1);
      }

      // Damage term
      let D = 0;
      if (polarity === "negative") {
        D = intensity * (heavyNeg ? 0.9 : 0.4);
      }

      // Faith and system constants
      let lambdaFaith = 0;
      if (faithLens !== "none") {
        lambdaFaith = 0.03;
      }
      const lambdaSys = 0.02;
      const contextSum = 0.05; // universal ethics baseline

      const E0 = Math.tanh(TM * BM - D + lambdaFaith + lambdaSys + contextSum);

      // Derived polarity/intensity from E0
      let outPolarity = "neutral";
      if (E0 > 0.05) outPolarity = "positive";
      else if (E0 < -0.05) outPolarity = "negative";

      const outIntensity = clamp(Math.abs(E0), 0, 1);
      const percentIntensity = Math.round(outIntensity * 100);

      return {
        polarity: outPolarity,
        rawPolarity: polarity,
        intensityPercent: percentIntensity,
        E0,
        TM,
        BM,
        D,
      };
    }

    function getReactionText(emo, tmText) {
      const { polarity, intensityPercent, E0 } = emo;
      let band = "low";
      if (intensityPercent >= 70) band = "high";
      else if (intensityPercent >= 30) band = "mid";

      let text;
      if (polarity === "positive") {
        text = pickRandom(reactions.positive[band]);
      } else if (polarity === "negative") {
        text = pickRandom(reactions.negative[band]);
      } else {
        text = pickRandom(reactions.neutral);
      }

      // Add a short E0 hint line
      const eStr = `E‚ÇÄ ‚âà ${E0.toFixed(2)} (range ‚àí1 to +1).`;
      return `${text} ${eStr} `;
    }

    function updateReactionCard(emo) {
      const card = document.getElementById("reactionCard");
      card.classList.remove("polarity-positive", "polarity-negative", "polarity-neutral");

      const meta = document.getElementById("reactionMeta");
      const body = document.getElementById("reactionBody");

      const { polarity, intensityPercent, E0 } = emo;

      const posSide = Math.round(50 + E0 * 50);
      const posClamped = clamp(posSide, 0, 100);
      const negClamped = 100 - posClamped;

      meta.textContent = `Polarity: ${
        polarity.charAt(0).toUpperCase() + polarity.slice(1)
      } ¬∑ Intensity: ${intensityPercent}% ¬∑ Balance: ${posClamped} : ${negClamped}`;

      let tone;
      if (polarity === "positive") {
        if (intensityPercent < 30) tone = "Tone: Light, gentle positive drift.";
        else if (intensityPercent < 70) tone = "Tone: Warm, stable positive field.";
        else tone = "Tone: Strong, high-amplitude positive spike.";
        card.classList.add("polarity-positive");
      } else if (polarity === "negative") {
        if (intensityPercent < 30) tone = "Tone: Mild negative charge, like faint sadness or worry.";
        else if (intensityPercent < 70) tone = "Tone: Heavier emotional weight ‚Äî handle with care.";
        else tone = "Tone: Intense emotional spike ‚Äî be very gentle with yourself.";
        card.classList.add("polarity-negative");
      } else {
        tone = "Tone: Calm, observant, analytically neutral reading.";
        card.classList.add("polarity-neutral");
      }

      body.textContent = "";
      const p1 = document.createElement("div");
      p1.textContent = tone;
      body.appendChild(p1);
    }

    function appendConversation(tmText, reactionText) {
      const container = document.getElementById("conversation");
      const empty = container.querySelector(".conv-empty");
      if (empty) empty.remove();

      const userRow = document.createElement("div");
      userRow.className = "msg-row";
      userRow.innerHTML = `
        <div class="msg-label user">TM ¬∑ USER</div>
        <div class="msg-bubble user">${escapeHtml(tmText)}</div>
      `;

      const engineRow = document.createElement("div");
      engineRow.className = "msg-row";
      engineRow.innerHTML = `
        <div class="msg-label engine">AURA-X Œ© ¬∑ REACTOR</div>
        <div class="msg-bubble engine">${escapeHtml(reactionText)}</div>
      `;

      container.appendChild(userRow);
      container.appendChild(engineRow);
      container.scrollTop = container.scrollHeight;
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    // --- BM handling ---
    function pushToBmLayers(entry) {
      const layers = bmStore.layers;
      layers.L1.unshift(entry); // newest at front

      const maxPerLayer = 40;

      function cascade(fromKey, toKey) {
        const from = layers[fromKey];
        const to = layers[toKey];
        while (from.length > maxPerLayer) {
          const moved = from.pop(); // oldest
          moved.layer = toKey;
          to.unshift(moved);
        }
      }

      cascade("L1", "L2");
      cascade("L2", "L3");
      cascade("L3", "L4");
      cascade("L4", "L5");
      cascade("L5", "L6");
      cascade("L6", "L7");

      // Truncate L7 extra
      while (layers.L7.length > maxPerLayer) {
        layers.L7.pop();
      }

      saveStore();
    }

    function summariseIfNeeded(text) {
      if (!autoSummarize) return text;
      const limit = 220;
      if (text.length <= limit) return text;
      return text.slice(0, limit) + " ‚Ä¶";
    }

    function isSmallTalk(text) {
      const lower = text.trim().toLowerCase();
      return smallTalkPatterns.some((p) => lower === p || lower.startsWith(p + " "));
    }

    // --- Main TM submit ---
    function handleTmSubmit(tmText) {
      const trimmed = tmText.trim();
      if (!trimmed) return;

      const emotion = estimateEmotion(trimmed);
      const reaction = getReactionText(emotion, trimmed);

      updateReactionCard(emotion);

      // Build BM entry (unless pure small-talk and ignore enabled)
      if (!(ignoreSmallTalk && isSmallTalk(trimmed))) {
        const bmEntry = {
          id: Date.now() + "-" + Math.random().toString(36).slice(2, 7),
          text: summariseIfNeeded(trimmed),
          polarity: emotion.polarity,
          intensity: emotion.intensityPercent,
          E0: Number(emotion.E0.toFixed(2)),
          timestamp: Date.now(),
          layer: "L1",
        };
        pushToBmLayers(bmEntry);
      }

      appendConversation(trimmed, reaction);
    }

    // --- Options / BM Viewer UI ---
    function openModal(id) {
      document.getElementById(id).classList.add("active");
    }
    function closeModal(id) {
      document.getElementById(id).classList.remove("active");
    }

    function renderBmViewer(filterText = "") {
      const bmList = document.getElementById("bmList");
      const bmLayerRow = document.getElementById("bmLayerRow");
      bmList.innerHTML = "";
      bmLayerRow.innerHTML = "";

      const layers = bmStore.layers;
      const allEntries = [];
      for (const [layerKey, arr] of Object.entries(layers)) {
        const pill = document.createElement("div");
        const avgPol = getLayerAveragePolarity(arr);
        pill.className = "bm-layer-pill";
        pill.innerHTML = `<strong>${layerKey}</strong><span class="count">(${arr.length}) ¬∑ ${avgPol}</span>`;
        bmLayerRow.appendChild(pill);

        arr.forEach((e) => allEntries.push(e));
      }

      let filtered = allEntries;
      if (filterText && filterText.trim()) {
        const query = filterText.toLowerCase();
        filtered = allEntries.filter((e) => e.text.toLowerCase().includes(query));
      }

      if (filtered.length === 0) {
        const empty = document.createElement("div");
        empty.style.opacity = "0.6";
        empty.style.fontSize = "11px";
        empty.textContent = "No BM entries found for this search.";
        bmList.appendChild(empty);
        return;
      }

      filtered
        .sort((a, b) => b.timestamp - a.timestamp)
        .forEach((entry) => {
          const item = document.createElement("div");
          item.className = "bm-item";
          const date = new Date(entry.timestamp);
          const dateStr = date.toLocaleString();
          const polIcon =
            entry.polarity === "positive"
              ? "üü¢"
              : entry.polarity === "negative"
              ? "üü†"
              : "‚ö™";

          item.innerHTML = `
            <div class="bm-meta-row">
              <div>${polIcon} ${entry.polarity.toUpperCase()} ¬∑ ${entry.intensity}%</div>
              <div>${entry.layer} ¬∑ ${dateStr}</div>
            </div>
            <div class="bm-text">${escapeHtml(entry.text)}</div>
            <div class="bm-meta-row">
              <div style="opacity:0.7;">E‚ÇÄ snapshot: ${entry.E0}</div>
              <div class="bm-actions">
                <button class="bm-btn" data-copy="${encodeURIComponent(
                  entry.text
                )}">Copy Prompt</button>
              </div>
            </div>
          `;
          bmList.appendChild(item);
        });

      // Attach copy handlers
      bmList.querySelectorAll(".bm-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const text = decodeURIComponent(btn.getAttribute("data-copy") || "");
          if (navigator.clipboard && text) {
            navigator.clipboard.writeText(text).then(
              () => {
                btn.textContent = "Copied ‚úì";
                setTimeout(() => (btn.textContent = "Copy Prompt"), 1000);
              },
              () => {
                alert("Copy failed ‚Äî you can manually select the text instead.");
              }
            );
          } else {
            alert("Copy not available ‚Äî please select and copy manually.");
          }
        });
      });
    }

    function getLayerAveragePolarity(arr) {
      if (!arr || arr.length === 0) return "balanced";
      let total = 0;
      arr.forEach((e) => {
        const sign =
          e.polarity === "positive"
            ? 1
            : e.polarity === "negative"
            ? -1
            : 0;
        total += sign * (e.intensity / 100);
      });
      const avg = total / arr.length;
      if (avg > 0.15) return "tilted positive";
      if (avg < -0.15) return "tilted negative";
      return "balanced";
    }

    function clearLast24h() {
      const cutoff = Date.now() - 24 * 60 * 60 * 1000;
      for (const key of Object.keys(bmStore.layers)) {
        bmStore.layers[key] = bmStore.layers[key].filter(
          (e) => e.timestamp < cutoff
        );
      }
      saveStore();
    }

    function deleteAllBm() {
      bmStore = DEFAULT_STORE();
      saveStore();
    }

    // --- Event wiring ---
    document.getElementById("sendBtn").addEventListener("click", () => {
      const input = document.getElementById("tmInput");
      const text = input.value;
      input.value = "";
      handleTmSubmit(text);
      input.focus();
    });

    document
      .getElementById("tmInput")
      .addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          document.getElementById("sendBtn").click();
        }
      });

    // Demo buttons
    document.getElementById("demoNeg").addEventListener("click", () => {
      const demoText =
        "A street dog bit me yesterday and I am still scared and in pain.";
      handleTmSubmit(demoText);
    });

    document.getElementById("demoPos").addEventListener("click", () => {
      const demoText =
        "My lost child returned home safely today and my heart is full of relief and gratitude.";
      handleTmSubmit(demoText);
    });

    // Voice toggle (UI only)
    document.getElementById("voiceToggle").addEventListener("click", () => {
      voiceOn = !voiceOn;
      const vt = document.getElementById("voiceToggle");
      vt.classList.toggle("voice-off", !voiceOn);
      vt.querySelector("div:nth-child(2)").textContent = voiceOn
        ? "Voice: On (UI only)"
        : "Voice: Off (UI only)";
    });

    // Options
    document.getElementById("btnOptions").addEventListener("click", () => {
      openModal("optionsBackdrop");
    });

    document.getElementById("btnBmViewer").addEventListener("click", () => {
      renderBmViewer();
      openModal("bmBackdrop");
    });

    document.getElementById("btnRecallBm").addEventListener("click", () => {
      renderBmViewer();
      openModal("bmBackdrop");
    });

    document.getElementById("btnCleanup").addEventListener("click", () => {
      clearLast24h();
      alert("BM for the last 24 hours has been cleared from this device.");
    });

    // Close buttons
    document.querySelectorAll(".modal-close").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-close-modal");
        if (id) closeModal(id);
      });
    });

    // Faith lens pills
    document.querySelectorAll("#faithPills .pill").forEach((pill) => {
      pill.addEventListener("click", () => {
        document
          .querySelectorAll("#faithPills .pill")
          .forEach((p) => p.classList.remove("active"));
        pill.classList.add("active");
        faithLens = pill.getAttribute("data-faith") || "none";
      });
    });

    // Toggles
    function toggleSwitch(element, state) {
      element.classList.toggle("on", state);
    }

    const summarizeEl = document.getElementById("toggleSummarize");
    const smallTalkEl = document.getElementById("toggleSmallTalk");

    summarizeEl.addEventListener("click", () => {
      autoSummarize = !autoSummarize;
      toggleSwitch(summarizeEl, autoSummarize);
    });

    smallTalkEl.addEventListener("click", () => {
      ignoreSmallTalk = !ignoreSmallTalk;
      toggleSwitch(smallTalkEl, ignoreSmallTalk);
    });

    // BM cleanup buttons inside options
    document.getElementById("btnClear24").addEventListener("click", () => {
      clearLast24h();
      alert("BM for the last 24 hours has been cleared.");
    });

    document.getElementById("btnDeleteAll").addEventListener("click", () => {
      if (
        confirm(
          "This will delete all BM layers from this browser. Are you sure?"
        )
      ) {
        deleteAllBm();
        alert("All BM data deleted from this device.");
      }
    });

    // BM search
    document.getElementById("bmSearch").addEventListener("input", (e) => {
      renderBmViewer(e.target.value);
    });

    // Initial toggle visual
    toggleSwitch(summarizeEl, autoSummarize);
    toggleSwitch(smallTalkEl, ignoreSmallTalk);
  </script>
</body>
</html>
