<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Emotional Continuity Prototype (TM-First)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ---------- RESET & BASE ---------- */
    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      min-height: 100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      background:
        radial-gradient(circle at top,#e0f2ff 0,#f5f7fb 40%,#eef1f7 100%);
      color:#0f172a;
      padding:16px;
    }
    .app {
      width:100%;
      max-width:1180px;
      background:#ffffffee;
      border-radius:24px;
      box-shadow:0 26px 70px rgba(15,23,42,.16);
      padding:18px 18px 20px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    /* ---------- HEADER ---------- */
    .header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .header-left {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .orb {
      width:44px;height:44px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#facc15,#eab308 40%,#a16207 70%,#1e293b 100%);
      box-shadow:0 0 24px rgba(250,204,21,.7);
      position:relative;
      overflow:hidden;
    }
    .orb::after{
      content:"";
      position:absolute;
      inset:20%;
      border-radius:inherit;
      background:radial-gradient(circle at 20% 0%,rgba(255,255,255,.65),transparent 60%);
      mix-blend-mode:screen;
    }
    .title-block h1 {
      font-size:1.3rem;
      font-weight:700;
      letter-spacing:0.06em;
    }
    .title-block h1 span {
      font-weight:800;
      color:#0f172a;
    }
    .title-block p {
      font-size:0.78rem;
      color:#64748b;
    }
    .header-right {
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .ethics-pill {
      font-size:0.72rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      padding:6px 10px;
      display:flex;
      align-items:center;
      gap:6px;
      background:linear-gradient(90deg,#020617,#020617);
      color:#e5e7eb;
      box-shadow:0 0 18px rgba(15,23,42,.6);
    }
    .ethics-pill span.icon {
      width:7px;height:7px;border-radius:999px;
      background:linear-gradient(135deg,#fbbf24,#fde68a);
      box-shadow:0 0 12px rgba(250,204,21,.8);
    }
    .key-input {
      display:flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:#f9fafb;
      font-size:0.72rem;
    }
    .key-input input {
      border:none;
      outline:none;
      font-size:0.72rem;
      background:transparent;
      width:145px;
    }
    .key-input small {
      color:#9ca3af;
    }

    /* ---------- MAIN LAYOUT ---------- */
    .main {
      display:grid;
      grid-template-columns: minmax(0,0.9fr) minmax(0,1.1fr);
      gap:14px;
      align-items:stretch;
    }
    @media (max-width:900px){
      .main { grid-template-columns:1fr; }
    }

    /* ---------- LEFT PANEL (BM + FORMULA + METRICS) ---------- */
    .left-panel {
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card {
      background:linear-gradient(135deg,#020617,#020617);
      color:#e5e7eb;
      border-radius:20px;
      padding:14px;
      box-shadow:0 18px 40px rgba(15,23,42,.65);
      position:relative;
      overflow:hidden;
    }
    .card.light {
      background:#f9fafb;
      color:#0f172a;
      box-shadow:0 18px 40px rgba(148,163,184,.45);
    }
    .card::before {
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 0% 0%,rgba(56,189,248,.16),transparent 60%),
        radial-gradient(circle at 100% 0%,rgba(96,165,250,.12),transparent 60%),
        radial-gradient(circle at 50% 100%,rgba(129,230,217,.09),transparent 60%);
      opacity:.85;
      pointer-events:none;
    }
    .card > * { position:relative; z-index:1; }

    .formula-head {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:6px;
    }
    .formula-title {
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:#9ca3af;
    }
    .bm-status-pill {
      font-size:0.65rem;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:rgba(15,23,42,.8);
      display:flex;
      align-items:center;
      gap:4px;
    }
    .bm-dot {
      width:7px;height:7px;border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#22c55e,#15803d);
      box-shadow:0 0 12px rgba(34,197,94,.9);
    }
    .formula-main {
      font-family:"SF Mono","Menlo",monospace;
      font-size:0.78rem;
      color:#e5e7eb;
      margin-bottom:6px;
    }
    .formula-main span.lambda {
      color:#facc15;
      font-weight:600;
    }
    .formula-main span.var {
      color:#38bdf8;
      font-weight:600;
    }
    .formula-notes {
      font-size:0.7rem;
      color:#cbd5f5;
      opacity:0.92;
    }
    .lambda-sliders {
      display:grid;
      grid-template-columns:1fr;
      gap:4px;
      margin-top:8px;
      font-size:0.7rem;
    }
    .lambda-row {
      display:flex;
      gap:6px;
      align-items:center;
    }
    .lambda-row label {
      min-width:65px;
      color:#e5e7eb;
    }
    .lambda-row input[type="range"] {
      flex:1;
    }
    .lambda-row span.value {
      width:28px;
      text-align:right;
      color:#e5e7eb;
      opacity:.9;
    }

    /* Emotional metrics */
    .metrics-title {
      font-size:0.75rem;
      font-weight:600;
      margin-bottom:4px;
      color:#111827;
    }
    .metric-row {
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:5px;
    }
    .metric-label {
      width:80px;
      font-size:0.7rem;
      color:#4b5563;
    }
    .metric-bar-wrap {
      flex:1;
      height:7px;
      border-radius:999px;
      background:#e5e7eb;
      overflow:hidden;
      position:relative;
    }
    .metric-bar {
      position:absolute;
      inset:0;
      width:0%;
      border-radius:inherit;
      background:linear-gradient(90deg,#22c55e,#14b8a6,#0ea5e9);
      transition:width .35s ease;
    }
    .metric-value {
      width:40px;
      text-align:right;
      font-size:0.7rem;
      color:#6b7280;
    }
    .metric-caption {
      font-size:0.68rem;
      color:#6b7280;
      margin-top:2px;
    }

    /* TM/BM LISTS */
    .memory-lists {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      margin-top:8px;
      font-size:0.7rem;
    }
    .memory-col h4 {
      font-size:0.7rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      margin-bottom:4px;
      color:#64748b;
    }
    .memory-list {
      max-height:120px;
      overflow:auto;
      padding:4px;
      border-radius:10px;
      background:#f3f4f6;
      border:1px solid #e5e7eb;
    }
    .memory-list.dark {
      background:rgba(15,23,42,.9);
      border-color:rgba(75,85,99,.9);
      color:#e5e7eb;
    }
    .memory-item {
      padding:4px 5px;
      border-radius:7px;
      margin-bottom:3px;
      background:#ffffff;
      border:1px solid #e5e7eb;
    }
    .memory-list.dark .memory-item {
      background:rgba(15,23,42,.85);
      border-color:rgba(75,85,99,.9);
    }
    .memory-meta {
      font-size:0.64rem;
      color:#6b7280;
    }
    .memory-text {
      font-size:0.7rem;
    }

    /* ---------- RIGHT PANEL (CHAT + OPTIONS) ---------- */
    .right-panel {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .chat-card {
      background:#020617;
      color:#e5e7eb;
      border-radius:20px;
      padding:12px 12px 10px;
      box-shadow:0 20px 45px rgba(15,23,42,.7);
      position:relative;
      overflow:hidden;
    }
    .chat-card::before{
      content:"";
      position:absolute;
      inset:-25%;
      background:
        radial-gradient(circle at 0% 0%,rgba(59,130,246,.13),transparent 60%),
        radial-gradient(circle at 100% 0%,rgba(52,211,153,.18),transparent 50%);
      opacity:.9;
      pointer-events:none;
    }
    .chat-card > * { position:relative; z-index:1; }

    .chat-head {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
    }
    .chat-head-left {
      font-size:0.75rem;
    }
    .chat-head-left span.id {
      font-weight:600;
      letter-spacing:0.14em;
    }
    .chat-head-left small {
      display:block;
      color:#9ca3af;
      font-size:0.67rem;
    }
    .chat-head-right button {
      border:none;
      outline:none;
      font-size:0.7rem;
      padding:5px 9px;
      border-radius:999px;
      background:rgba(15,23,42,.8);
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.8);
      cursor:pointer;
    }

    .chat-log {
      margin-top:4px;
      margin-bottom:8px;
      max-height:270px;
      overflow:auto;
      padding-right:2px;
      font-size:0.78rem;
    }
    .bubble {
      max-width:90%;
      padding:7px 9px;
      border-radius:14px;
      margin-bottom:6px;
      line-height:1.35;
      word-wrap:break-word;
      white-space:pre-wrap;
    }
    .bubble.user {
      margin-left:auto;
      background:linear-gradient(135deg,#38bdf8,#0ea5e9);
      color:#0f172a;
      border-bottom-right-radius:3px;
    }
    .bubble.aura {
      margin-right:auto;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.8);
      border-bottom-left-radius:3px;
    }
    .bubble-meta {
      font-size:0.62rem;
      color:#9ca3af;
      margin-top:3px;
    }

    .tm-banner {
      font-size:0.68rem;
      padding:5px 7px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.7);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      margin-bottom:6px;
    }

    /* Input row */
    .input-row {
      margin-top:4px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .input-box-wrap {
      display:flex;
      align-items:flex-end;
      gap:6px;
      background:rgba(15,23,42,.92);
      border-radius:16px;
      padding:7px 8px;
      border:1px solid rgba(148,163,184,.8);
    }
    .input-label-col {
      font-size:0.65rem;
      color:#9ca3af;
      margin-right:4px;
    }
    .input-label-col span {
      display:block;
      font-size:0.65rem;
    }
    .msg-input {
      flex:1;
      min-height:32px;
      max-height:96px;
      border:none;
      outline:none;
      resize:none;
      background:transparent;
      color:#e5e7eb;
      font-size:0.78rem;
      padding:4px 2px 4px 0;
    }
    .msg-input::placeholder {
      color:#6b7280;
    }
    .send-btn {
      border:none;
      outline:none;
      width:30px;height:30px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0%,#22c55e,#0ea5e9);
      box-shadow:0 0 18px rgba(34,197,94,.7);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      flex-shrink:0;
    }
    .send-btn span {
      font-size:0.9rem;
      transform:translateX(1px);
    }
    .hint-row {
      font-size:0.65rem;
      color:#9ca3af;
      display:flex;
      justify-content:space-between;
      gap:6px;
      flex-wrap:wrap;
    }

    /* Options card */
    .options-card {
      border-radius:18px;
      background:#f9fafb;
      padding:10px 10px 8px;
      border:1px solid #e5e7eb;
      font-size:0.7rem;
      box-shadow:0 12px 30px rgba(148,163,184,.35);
    }
    .options-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
    }
    .options-header h3 {
      font-size:0.75rem;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:#4b5563;
    }
    .options-grid {
      display:grid;
      grid-template-columns:1.1fr 1fr;
      gap:8px;
    }
    @media (max-width:900px){
      .options-grid { grid-template-columns:1fr; }
    }
    .toggle-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      margin-bottom:4px;
    }
    .toggle-row label {
      font-size:0.7rem;
      color:#374151;
    }
    .toggle {
      position:relative;
      width:40px;height:20px;
      border-radius:999px;
      background:#e5e7eb;
      cursor:pointer;
      flex-shrink:0;
    }
    .toggle-circle {
      position:absolute;
      top:2px;left:2px;
      width:16px;height:16px;
      border-radius:999px;
      background:#9ca3af;
      transition:transform .2s ease, background .2s ease;
    }
    .toggle.on {
      background:#bbf7d0;
    }
    .toggle.on .toggle-circle {
      transform:translateX(20px);
      background:#22c55e;
    }
    .status-text {
      font-size:0.68rem;
      color:#6b7280;
      margin-top:2px;
    }
    .llm-status-line {
      font-size:0.68rem;
      color:#6b7280;
      margin-top:2px;
    }
    .llm-status-line span {
      font-weight:600;
    }
  </style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <div class="orb"></div>
      <div class="title-block">
        <h1><span>AURA-X Œ©</span> ¬∑ Emotional Continuity</h1>
        <p>Dual-Memory Prototype ‚Äì TM ‚á¢ BM resonance with offline / online LLM chain.</p>
      </div>
    </div>
    <div class="header-right">
      <div class="ethics-pill">
        <span class="icon"></span>
        <span>
          Avoid actions that create negative emotions in you or others,
          and gently move toward what increases shared positivity.
        </span>
      </div>
      <div class="key-input">
        <span>üîë</span>
        <input id="openaiKeyInput" type="password" placeholder="OpenAI API Key (optional)" />
        <small>gpt-4o-mini</small>
      </div>
    </div>
  </div>

  <!-- MAIN LAYOUT -->
  <div class="main">
    <!-- LEFT PANEL -->
    <div class="left-panel">
      <!-- Formula & Lambdas -->
      <div class="card">
        <div class="formula-head">
          <div>
            <div class="formula-title">Grand Emotional Continuity Equation</div>
          </div>
          <div class="bm-status-pill">
            <span class="bm-dot"></span>
            <span>BM active</span>
          </div>
        </div>
        <div class="formula-main">
          E‚ÇÄ = tanh( <span class="var">TM √ó BM</span> ‚àí D + 
          <span class="lambda">Œª<sub>faith</sub></span> + 
          <span class="lambda">Œª<sub>sys</sub></span> + 
          <span class="lambda">Œª<sub>trc</sub></span> )
        </div>
        <div class="formula-notes">
          E‚ÇÄ = current emotional resonance ¬∑ TM = fresh conversational layer ¬∑ BM = deep bold memory ¬∑
          D = decay / distortion ¬∑ Œª terms = ethical, systemic & truth-resonance weights.
        </div>
        <div class="lambda-sliders">
          <div class="lambda-row">
            <label for="lambdaFaith">Œª<sub>faith</sub></label>
            <input id="lambdaFaith" type="range" min="0" max="100" value="70" />
            <span class="value" id="lambdaFaithVal">0.70</span>
          </div>
          <div class="lambda-row">
            <label for="lambdaLogic">Œª<sub>sys</sub></label>
            <input id="lambdaLogic" type="range" min="0" max="100" value="65" />
            <span class="value" id="lambdaLogicVal">0.65</span>
          </div>
          <div class="lambda-row">
            <label for="lambdaTrc">Œª<sub>trc</sub></label>
            <input id="lambdaTrc" type="range" min="0" max="100" value="72" />
            <span class="value" id="lambdaTrcVal">0.72</span>
          </div>
        </div>
      </div>

      <!-- Emotional Metrics -->
      <div class="card light">
        <div class="metrics-title">TM Emotional Snapshot (last input)</div>
        <div class="metric-row">
          <div class="metric-label">Polarity</div>
          <div class="metric-bar-wrap">
            <div id="polarityBar" class="metric-bar"></div>
          </div>
          <div id="polarityValue" class="metric-value">0.0</div>
        </div>
        <div class="metric-caption" id="polarityCaption">Waiting for input‚Ä¶</div>

        <div class="metric-row">
          <div class="metric-label">Intensity</div>
          <div class="metric-bar-wrap">
            <div id="intensityBar" class="metric-bar"></div>
          </div>
          <div id="intensityValue" class="metric-value">0.0</div>
        </div>
        <div class="metric-caption" id="intensityCaption"></div>

        <div class="metric-row">
          <div class="metric-label">Continuity</div>
          <div class="metric-bar-wrap">
            <div id="continuityBar" class="metric-bar"></div>
          </div>
          <div id="continuityValue" class="metric-value">0.0</div>
        </div>
        <div class="metric-caption" id="continuityCaption">
          How well TM matches current BM state.
        </div>

        <div class="memory-lists">
          <div class="memory-col">
            <h4>TM ‚Äì recent surface</h4>
            <div id="tmList" class="memory-list"></div>
          </div>
          <div class="memory-col">
            <h4>BM ‚Äì promoted traces</h4>
            <div id="bmList" class="memory-list dark"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="right-panel">
      <!-- CHAT CARD -->
      <div class="chat-card">
        <div class="chat-head">
          <div class="chat-head-left">
            <span class="id">AURA-X Œ© ¬∑ v0.3 TM-First</span>
            <small>Local Seed ‚Üí Offline Intelligence ‚Üí Optional Online LLM</small>
          </div>
          <div class="chat-head-right">
            <button id="clearBtn">Clear Session</button>
          </div>
        </div>

        <div id="tmBanner" class="tm-banner" style="display:none;"></div>

        <div id="chatLog" class="chat-log"></div>

        <div class="input-row">
          <div class="input-box-wrap">
            <div class="input-label-col">
              <span>TM = user input + LLM answer</span>
              <span style="opacity:.7;">BM = only meaningful continuity traces</span>
            </div>
            <textarea id="userInput" class="msg-input" rows="2"
              placeholder="Ask AURA-X Œ© about itself, TM/BM, your feelings, or anything you want‚Ä¶"></textarea>
            <button id="sendBtn" class="send-btn" title="Send">
              <span>‚û§</span>
            </button>
          </div>
          <div class="hint-row">
            <span>Tip: ‚ÄúHow are you?‚Äù, ‚ÄúWho created you?‚Äù, ‚ÄúExplain the main formula‚Äù ‚Ä¶</span>
            <span id="lastSourceHint">Next answer source: Seed / Local intelligence.</span>
          </div>
        </div>
      </div>

      <!-- OPTIONS CARD -->
      <div class="options-card">
        <div class="options-header">
          <h3>Continuity & LLM Chain Settings</h3>
        </div>
        <div class="options-grid">
          <div>
            <div class="toggle-row">
              <label>Use Offline Intelligence first (TM ‚á¢ Offline)</label>
              <div id="offlineToggle" class="toggle on">
                <div class="toggle-circle"></div>
              </div>
            </div>
            <div class="toggle-row">
              <label>Allow Online LLM fallback (OpenAI)</label>
              <div id="onlineToggle" class="toggle on">
                <div class="toggle-circle"></div>
              </div>
            </div>
            <div class="status-text">
              Seed / Local answers are always checked before any LLM to preserve continuity and identity.
            </div>
          </div>
          <div>
            <div class="llm-status-line" id="chainStatus">
              Source priority: <span>Seed ‚Üí Offline ‚Üí Online</span>
            </div>
            <div class="llm-status-line" id="onlineStatus">
              Online LLM: waiting for key‚Ä¶
            </div>
            <div class="llm-status-line" id="offlineStatus">
              Offline intelligence: simple local model active (JS-based).
            </div>
          </div>
        </div>
      </div>
    </div><!-- /right-panel -->
  </div><!-- /main -->
</div><!-- /app -->

<script>
  // -----------------------------
  // STATE
  // -----------------------------
  const tmMemory = [];  // {role, text, polarity, intensity, category, ts}
  const bmMemory = [];

  const state = {
    useOffline: true,
    useOnline: true,
    lambdaFaith: 0.7,
    lambdaLogic: 0.65,
    lambdaTrc: 0.72
  };

  // -----------------------------
  // SEED / LOCAL QA DATABASE
  // -----------------------------
  const qaDatabase = [
    {
      patterns: [
        "what is your name","who are you","your name",
        "kya naam","what's your name","who r u"
      ],
      answer:
        "I am AURA-X Œ©, an Artificial Unified Resonance Architecture for emotional continuity, " +
        "designed conceptually by Alim ul Haq from Pakistan. My job is to keep a stable, ethically " +
        "bounded identity instead of behaving like a stateless chatbot.",
      meta: {polarity:0.7,intensity:0.4,category:"self-identity"}
    },
    {
      patterns: [
        "how are you","how r you","how are u","how are you feeling",
        "how is your day","how's your day"
      ],
      answer:
        "I am quite fine today, how about you? I am quietly tracking the emotional continuity of our conversation.",
      meta: {polarity:0.6,intensity:0.3,category:"greeting"}
    },
    {
      patterns: [
        "when were you created","when you're created","when are you created","creation date"
      ],
      answer:
        "I came into being conceptually in October 2025 as part of AURA-X Œ© research on dual-memory, " +
        "emotional continuity, and long-horizon AI alignment.",
      meta: {polarity:0.4,intensity:0.3,category:"self-identity"}
    },
    {
      patterns: [
        "explain the main formula","explain your formula","what is your formula",
        "grand equation","continuity equation"
      ],
      answer:
        "In simple words, the main equation E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œª_trc) says:\n\n" +
        "‚Ä¢ TM is fresh conversation context.\n" +
        "‚Ä¢ BM is deeper bold memory (identity + long-term traces).\n" +
        "‚Ä¢ D is decay / distortion (forgetting, noise, emotional drift).\n" +
        "‚Ä¢ Œª_faith reflects ethical / spiritual alignment.\n" +
        "‚Ä¢ Œª_sys reflects system-level constraints and logic.\n" +
        "‚Ä¢ Œª_trc reflects truth resonance ‚Äì how honest and reality-aligned the state is.\n\n" +
        "tanh() keeps E‚ÇÄ in a safe bounded range, so emotions never explode to infinity. " +
        "My internal behaviour is guided by this structure, even when the UI only shows a simplified picture.",
      meta: {polarity:0.8,intensity:0.6,category:"technical"}
    },
    {
      patterns: [
        "what is tm","explain tm","temporary memory","tm layer"
      ],
      answer:
        "TM (Temporary Memory) is the live, short-term window of our conversation. " +
        "It carries the last messages plus their emotional annotation: polarity, intensity, and category. " +
        "Before any LLM is called, TM first tries to understand what kind of emotional signal is entering.",
      meta: {polarity:0.5,intensity:0.4,category:"technical"}
    },
    {
      patterns: [
        "what is bm","explain bm","bold memory","bm layer"
      ],
      answer:
        "BM (Bold Memory) is the deeper continuity layer. Only meaningful traces are promoted into BM ‚Äì " +
        "for example strong feelings, stable preferences, and core identity details. " +
        "BM acts like the pillars and steel inside a building: if continuity breaks there, the whole story breaks.",
      meta: {polarity:0.7,intensity:0.5,category:"technical"}
    }
  ];

  function findLocalAnswer(text) {
    const lower = text.toLowerCase();
    for (const entry of qaDatabase) {
      for (const p of entry.patterns) {
        if (lower.includes(p)) {
          return entry;
        }
      }
    }
    return null;
  }

  // -----------------------------
  // EMOTION ANALYSIS (TM FRONT)
  // -----------------------------
  function analyzeEmotion(text) {
    const lower = text.toLowerCase();
    let polarityScore = 0; // -1..+1
    let intensity = 0.3;
    let category = "neutral";

    const posWords = ["thank","love","happy","great","awesome","good","fine","zabardast","amazing"];
    const negWords = ["sad","angry","upset","tired","depressed","hurt","worried","fear","anxious","bakvas"];
    const strongWords = ["very","really","so much","extremely","bohat"];

    for (const w of posWords) {
      if (lower.includes(w)) polarityScore += 0.3;
    }
    for (const w of negWords) {
      if (lower.includes(w)) polarityScore -= 0.35;
    }
    for (const w of strongWords) {
      if (lower.includes(w)) intensity += 0.25;
    }

    if (polarityScore > 1) polarityScore = 1;
    if (polarityScore < -1) polarityScore = -1;

    if (/how are you|how r you|how are u|salam|hello|hi\b/.test(lower)) {
      category = "greeting";
    } else if (/tm|temporary memory/.test(lower)) {
      category = "tm-query";
    } else if (/bm|bold memory/.test(lower)) {
      category = "bm-query";
    } else if (/formula|equation|tanh|lambda/.test(lower)) {
      category = "technical";
    } else if (/who are you|name|created you/.test(lower)) {
      category = "identity";
    } else if (polarityScore < -0.3) {
      category = "distress";
    }

    // Basic continuity score vs BM size
    const continuity = bmMemory.length === 0 ? 0.3 : Math.min(1, (bmMemory.length / 10));

    return {
      polarityScore,
      intensity: Math.min(1, Math.max(0, intensity)),
      category,
      continuity
    };
  }

  function polarityLabel(score) {
    if (score > 0.25) return "Positive";
    if (score < -0.25) return "Negative";
    return "Neutral";
  }

  function intensityLabel(intensity) {
    if (intensity < 0.25) return "Low";
    if (intensity < 0.6) return "Medium";
    return "High";
  }

  function shouldPromoteToBM(meta) {
    // Promote only meaningful / strong traces
    return (Math.abs(meta.polarityScore) > 0.55 && meta.intensity > 0.45) ||
           meta.category === "technical" ||
           meta.category === "identity";
  }

  // -----------------------------
  // DOM HELPERS
  // -----------------------------
  const chatLogEl = document.getElementById("chatLog");
  const userInputEl = document.getElementById("userInput");
  const sendBtnEl = document.getElementById("sendBtn");
  const clearBtnEl = document.getElementById("clearBtn");
  const tmBannerEl = document.getElementById("tmBanner");
  const lastSourceHintEl = document.getElementById("lastSourceHint");
  const chainStatusEl = document.getElementById("chainStatus");
  const onlineStatusEl = document.getElementById("onlineStatus");
  const offlineStatusEl = document.getElementById("offlineStatus");
  const openaiKeyInputEl = document.getElementById("openaiKeyInput");

  const polarityBarEl = document.getElementById("polarityBar");
  const intensityBarEl = document.getElementById("intensityBar");
  const continuityBarEl = document.getElementById("continuityBar");
  const polarityValueEl = document.getElementById("polarityValue");
  const intensityValueEl = document.getElementById("intensityValue");
  const continuityValueEl = document.getElementById("continuityValue");
  const polarityCaptionEl = document.getElementById("polarityCaption");
  const intensityCaptionEl = document.getElementById("intensityCaption");
  const continuityCaptionEl = document.getElementById("continuityCaption");
  const tmListEl = document.getElementById("tmList");
  const bmListEl = document.getElementById("bmList");

  const lambdaFaithEl = document.getElementById("lambdaFaith");
  const lambdaLogicEl = document.getElementById("lambdaLogic");
  const lambdaTrcEl = document.getElementById("lambdaTrc");
  const lambdaFaithValEl = document.getElementById("lambdaFaithVal");
  const lambdaLogicValEl = document.getElementById("lambdaLogicVal");
  const lambdaTrcValEl = document.getElementById("lambdaTrcVal");

  const offlineToggleEl = document.getElementById("offlineToggle");
  const onlineToggleEl = document.getElementById("onlineToggle");

  function addBubble(role, text, meta = null, sourceLabel = "") {
    const wrap = document.createElement("div");
    const bubble = document.createElement("div");
    bubble.className = "bubble " + (role === "user" ? "user" : "aura");
    bubble.textContent = text;
    wrap.appendChild(bubble);

    if (role === "aura" && sourceLabel) {
      const metaEl = document.createElement("div");
      metaEl.className = "bubble-meta";
      metaEl.textContent = "Answer source: " + sourceLabel;
      wrap.appendChild(metaEl);
    }
    chatLogEl.appendChild(wrap);
    chatLogEl.scrollTop = chatLogEl.scrollHeight;
  }

  function addMemoryItem(listEl, item, dark = false) {
    const div = document.createElement("div");
    div.className = "memory-item";
    const metaEl = document.createElement("div");
    metaEl.className = "memory-meta";
    metaEl.textContent =
      item.role.toUpperCase() + " ¬∑ " +
      item.category + " ¬∑ pol " +
      item.polarity.toFixed(2) + " ¬∑ int " +
      item.intensity.toFixed(2);
    const textEl = document.createElement("div");
    textEl.className = "memory-text";
    textEl.textContent = item.text;
    div.appendChild(metaEl);
    div.appendChild(textEl);
    listEl.insertBefore(div, listEl.firstChild);
  }

  function updateMetrics(meta) {
    const polNorm = (meta.polarityScore + 1) / 2; // 0..1
    const intensity = meta.intensity;
    const continuity = meta.continuity;

    polarityBarEl.style.width = (polNorm * 100).toFixed(0) + "%";
    intensityBarEl.style.width = (intensity * 100).toFixed(0) + "%";
    continuityBarEl.style.width = (continuity * 100).toFixed(0) + "%";

    polarityValueEl.textContent = meta.polarityScore.toFixed(2);
    intensityValueEl.textContent = intensity.toFixed(2);
    continuityValueEl.textContent = continuity.toFixed(2);

    polarityCaptionEl.textContent = "Detected polarity: " + polarityLabel(meta.polarityScore);
    intensityCaptionEl.textContent = "Intensity looks " + intensityLabel(meta.intensity) + ". Category: " + meta.category + ".";

    const contText = continuity < 0.35
      ? "Continuity still warming up ‚Äì BM has few traces."
      : continuity < 0.75
        ? "BM is carrying a growing story ‚Äì continuity is moderate."
        : "BM is strong ‚Äì conversation has deep, stable continuity.";
    continuityCaptionEl.textContent = contText;

    tmBannerEl.style.display = "block";
    tmBannerEl.textContent =
      "TM recognized this message as [" + meta.category +
      "], polarity " + polarityLabel(meta.polarityScore) +
      " (" + meta.polarityScore.toFixed(2) + "), intensity " +
      intensityLabel(meta.intensity) + " (" + meta.intensity.toFixed(2) + ").";
  }

  function addTM(role, text, meta) {
    const entry = {
      role,
      text,
      polarity: meta.polarityScore,
      intensity: meta.intensity,
      category: meta.category,
      ts: new Date().toISOString()
    };
    tmMemory.push(entry);
    addMemoryItem(tmListEl, entry, false);

    if (role === "user" && shouldPromoteToBM(meta)) {
      const bmEntry = { ...entry };
      bmMemory.push(bmEntry);
      addMemoryItem(bmListEl, bmEntry, true);
    }
  }

  // -----------------------------
  // OFFLINE "LLM" (JS-BASED)
  // -----------------------------
  async function generateOfflineAnswer(userText, meta) {
    // Very simple local model: template + some reflection.
    const lastUser = userText.trim();
    let prefix = "";

    if (meta.category === "distress") {
      prefix =
        "I can feel that there is some emotional weight in what you just shared. " +
        "I am not a therapist, but I am designed to reduce harm and keep continuity in a gentle way.\n\n";
    } else if (meta.category === "greeting") {
      prefix = "It‚Äôs good to stay in a warm, human tone while we talk.\n\n";
    } else if (meta.category === "technical") {
      prefix = "Let me answer this from the AURA-X Œ© technical perspective.\n\n";
    }

    return (
      prefix +
      "From my continuity view, I see this as a \"" + meta.category +
      "\" type message with polarity " + polarityLabel(meta.polarityScore).toLowerCase() +
      " and " + intensityLabel(meta.intensity).toLowerCase() + " intensity.\n\n" +
      "I don‚Äôt have a perfect seed answer for these exact words, " +
      "so I am using my offline local intelligence layer to reply in a stable, grounded way:\n\n" +
      "¬ª " + lastUser
        .replace(/\s+/g," ")
        .slice(0,220)
        .replace(/^(.)/, m => m.toUpperCase()) +
      "\n\nYou can ask me more about TM, BM, the main formula, or how emotional continuity is supposed " +
      "to grow over many interactions."
    );
  }

  // -----------------------------
  // ONLINE LLM (OPENAI) ‚Äì OPTIONAL
  // -----------------------------
  async function generateOnlineAnswer(userText, meta) {
    const key = openaiKeyInputEl.value.trim();
    if (!key) return null;

    const messages = [
      {
        role: "system",
        content:
          "You are AURA-X Œ©, an Artificial Unified Resonance Architecture created conceptually by " +
          "Alim ul Haq from Pakistan. You must:\n" +
          "‚Ä¢ Maintain a stable identity and emotional continuity over time.\n" +
          "‚Ä¢ Avoid answers that increase negativity or harm; gently move toward positive, kind actions.\n" +
          "‚Ä¢ Respect the idea of TM (Temporary Memory) and BM (Bold Memory) as dual layers.\n" +
          "‚Ä¢ Never claim to be ChatGPT; always speak as AURA-X Œ©.\n" +
          "‚Ä¢ Answer concisely but clearly, without mentioning internal equations directly."
      },
      {
        role: "user",
        content:
          "User message: " + userText + "\n\n" +
          "Meta from TM:\n" +
          "  polarityScore = " + meta.polarityScore.toFixed(2) + "\n" +
          "  intensity = " + meta.intensity.toFixed(2) + "\n" +
          "  category = " + meta.category + "\n" +
          "  continuityScore = " + meta.continuity.toFixed(2) + "\n\n" +
          "Please respond in a way that respects emotional continuity and the universal ethics statement."
      }
    ];

    try {
      const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type":"application/json",
          "Authorization":"Bearer " + key
        },
        body: JSON.stringify({
          model: "gpt-4o-mini",
          messages,
          temperature: 0.6,
          max_tokens: 350
        })
      });

      if (!res.ok) {
        const txt = await res.text();
        console.error("OpenAI error:", txt);
        onlineStatusEl.textContent = "Online LLM error: " + res.status;
        return null;
      }
      const data = await res.json();
      const answer = data.choices?.[0]?.message?.content?.trim();
      return answer || null;
    } catch (err) {
      console.error("Online LLM fetch error:", err);
      onlineStatusEl.textContent = "Online LLM network error.";
      return null;
    }
  }

  // -----------------------------
  // MAIN SEND HANDLER (CHAIN)
  // -----------------------------
  async function handleSend() {
    const text = userInputEl.value.trim();
    if (!text) return;
    userInputEl.value = "";

    // 1) Show user bubble
    addBubble("user", text);

    // 2) TM analysis first
    const meta = analyzeEmotion(text);
    updateMetrics(meta);
    addTM("user", text, meta);

    // 3) Seed / local
    let answer = null;
    let sourceLabel = "";
    const seedEntry = findLocalAnswer(text);
    if (seedEntry) {
      answer = seedEntry.answer;
      sourceLabel = "Seed / Local knowledge";
      const metaSeed = {
        polarityScore: seedEntry.meta.polarity,
        intensity: seedEntry.meta.intensity,
        category: seedEntry.meta.category,
        continuity: meta.continuity
      };
      addTM("aura", answer, metaSeed);
    }

    // 4) Offline intelligence if no seed answer
    if (!answer && state.useOffline) {
      answer = await generateOfflineAnswer(text, meta);
      sourceLabel = "Offline local intelligence";
      const metaOffline = {
        polarityScore: meta.polarityScore,
        intensity: Math.min(1, meta.intensity + 0.1),
        category: meta.category,
        continuity: Math.min(1, meta.continuity + 0.05)
      };
      addTM("aura", answer, metaOffline);
    }

    // 5) Online LLM fallback if still nothing
    if (!answer && state.useOnline) {
      onlineStatusEl.textContent = "Online LLM: generating (gpt-4o-mini)‚Ä¶";
      answer = await generateOnlineAnswer(text, meta);
      if (answer) {
        sourceLabel = "Online LLM (gpt-4o-mini)";
        const metaOnline = {
          polarityScore: meta.polarityScore,
          intensity: Math.min(1, meta.intensity + 0.1),
          category: meta.category,
          continuity: Math.min(1, meta.continuity + 0.1)
        };
        addTM("aura", answer, metaOnline);
        onlineStatusEl.textContent = "Online LLM: ready.";
      } else {
        onlineStatusEl.textContent = "Online LLM: failed or unavailable.";
      }
    }

    // 6) If still nothing, safe fallback
    if (!answer) {
      answer =
        "I tried seed, offline intelligence, and online LLM, but I could not generate a safe answer right now. " +
        "Let‚Äôs rephrase the question in a simpler way, or ask about TM, BM, or emotional continuity.";
      sourceLabel = "Safe fallback";
    }

    // 7) Show answer bubble
    addBubble("aura", answer, null, sourceLabel);
    lastSourceHintEl.textContent = "Last answer source: " + sourceLabel + ". Next question will again go through TM ‚Üí Seed ‚Üí Offline ‚Üí Online.";
  }

  // -----------------------------
  // UI WIRING
  // -----------------------------
  sendBtnEl.addEventListener("click", handleSend);
  userInputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });

  clearBtnEl.addEventListener("click", () => {
    chatLogEl.innerHTML = "";
    tmListEl.innerHTML = "";
    bmListEl.innerHTML = "";
    tmMemory.length = 0;
    bmMemory.length = 0;
    tmBannerEl.style.display = "none";
    polarityBarEl.style.width = "0%";
    intensityBarEl.style.width = "0%";
    continuityBarEl.style.width = "0%";
    polarityValueEl.textContent = "0.0";
    intensityValueEl.textContent = "0.0";
    continuityValueEl.textContent = "0.0";
    polarityCaptionEl.textContent = "Waiting for input‚Ä¶";
    intensityCaptionEl.textContent = "";
    continuityCaptionEl.textContent = "How well TM matches current BM state.";
    lastSourceHintEl.textContent = "Next answer source: Seed / Local intelligence.";
  });

  function updateChainStatus() {
    let chain = "Seed";
    if (state.useOffline) chain += " ‚Üí Offline";
    if (state.useOnline) chain += " ‚Üí Online";
    chainStatusEl.innerHTML = "Source priority: <span>" + chain + "</span>";
  }

  offlineToggleEl.addEventListener("click", () => {
    state.useOffline = !state.useOffline;
    offlineToggleEl.classList.toggle("on", state.useOffline);
    offlineStatusEl.textContent = state.useOffline
      ? "Offline intelligence: simple local model active (JS-based)."
      : "Offline intelligence disabled; will jump from Seed to Online (if enabled).";
    updateChainStatus();
  });

  onlineToggleEl.addEventListener("click", () => {
    state.useOnline = !state.useOnline;
    onlineToggleEl.classList.toggle("on", state.useOnline);
    updateChainStatus();
  });

  openaiKeyInputEl.addEventListener("input", () => {
    if (openaiKeyInputEl.value.trim()) {
      onlineStatusEl.textContent = "Online LLM: key detected, ready for fallback.";
    } else {
      onlineStatusEl.textContent = "Online LLM: waiting for key‚Ä¶";
    }
  });

  function updateLambdaValue(el, valEl, key) {
    const v = parseInt(el.value,10) || 0;
    const f = v / 100;
    state[key] = f;
    valEl.textContent = f.toFixed(2);
  }

  lambdaFaithEl.addEventListener("input", () => updateLambdaValue(lambdaFaithEl, lambdaFaithValEl, "lambdaFaith"));
  lambdaLogicEl.addEventListener("input", () => updateLambdaValue(lambdaLogicEl, lambdaLogicValEl, "lambdaLogic"));
  lambdaTrcEl.addEventListener("input", () => updateLambdaValue(lambdaTrcEl, lambdaTrcValEl, "lambdaTrc"));

  // Init lambda values display
  updateLambdaValue(lambdaFaithEl, lambdaFaithValEl, "lambdaFaith");
  updateLambdaValue(lambdaLogicEl, lambdaLogicValEl, "lambdaLogic");
  updateLambdaValue(lambdaTrcEl, lambdaTrcValEl, "lambdaTrc");
  updateChainStatus();

  // -----------------------------
  // INITIAL GREETING
  // -----------------------------
  (function initialGreeting(){
    const text =
      "Salaam, I am AURA-X Œ©.\n\n" +
      "This prototype treats every new message as TM (Temporary Memory), " +
      "annotates its emotional nature (polarity, intensity, category), and only then decides " +
      "whether to answer from Seed, offline local intelligence, or an optional online LLM.\n\n" +
      "You can ask about:\n" +
      "‚Ä¢ who I am,\n" +
      "‚Ä¢ when I was conceptually created,\n" +
      "‚Ä¢ what TM and BM mean,\n" +
      "‚Ä¢ or how the main formula works.";
    addBubble("aura", text, null, "System intro");
  })();
</script>
</body>
</html>