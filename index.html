<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Offline LLM package (WebLLM, for in-browser models ‚Äì future ready) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root { --accent-color:#0ea5e9; }
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px 10px;
    }
    .app{
      width:min(980px,98vw);
      background:rgba(2,6,23,.45);
      border:1px solid rgba(148,163,184,.18);
      border-radius:22px;
      overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
    }
    .top{
      padding:20px 18px 10px;
      border-bottom:1px solid rgba(148,163,184,.14);
      text-align:center;
      position:relative;
    }
    .brand{
      font-weight:800;
      letter-spacing:.5px;
      font-size:26px;
      color:#7dd3fc;
      text-shadow:0 0 22px rgba(14,165,233,.28);
    }
    .sub{
      opacity:.8;
      margin-top:2px;
      font-size:13px;
    }
    .ethic{
      margin:14px auto 12px;
      max-width:720px;
      border:1px solid rgba(251,191,36,.35);
      border-radius:14px;
      padding:10px 36px 9px 14px;
      color:#fbbf24;
      background:rgba(2,6,23,.35);
      box-shadow:inset 0 0 0 1px rgba(251,191,36,.08);
      font-size:14px;
      line-height:1.4;
      position:relative;
      overflow:hidden;
      transition:background .4s ease,border-color .4s ease,transform .4s ease,box-shadow .4s ease;
    }
    .ethicMain{font-weight:600;}
    .ethicMeta{
      font-size:11px;
      opacity:.8;
      margin-top:2px;
      display:none; /* default hidden */
    }
    .ethic.ethicPulse{
      animation:ethicPulse 1.1s ease;
    }
    @keyframes ethicPulse{
      0%{box-shadow:0 0 0 0 rgba(251,191,36,.55);transform:translateY(0);}
      45%{box-shadow:0 0 0 16px rgba(251,191,36,0);transform:translateY(-1px);}
      100%{box-shadow:0 0 0 0 rgba(251,191,36,0);transform:translateY(0);}
    }
    .faithCfgBtn{
      position:absolute;
      right:6px;
      top:4px;
      border:none;
      background:transparent;
      color:#fde68a;
      cursor:pointer;
      font-size:16px;
      line-height:1;
      display:none;
      -webkit-tap-highlight-color:transparent;
    }
    .faithCfgBtn.show{display:inline-flex;}
    .pill{
      margin:10px auto 0;
      max-width:760px;
      background:linear-gradient(90deg, rgba(14,165,233,.65), rgba(34,211,238,.45));
      border:1px solid rgba(125,211,252,.30);
      color:#0b1220;
      font-weight:800;
      letter-spacing:.6px;
      border-radius:999px;
      padding:14px 16px;
      text-transform:uppercase;
      box-shadow:0 12px 40px rgba(14,165,233,.22);
      position:relative;
    }
    .pill.faithGlow{
      border-color:rgba(251,191,36,.9);
      box-shadow:0 0 26px rgba(251,191,36,.75);
      background:linear-gradient(90deg, rgba(14,165,233,.6), rgba(251,191,36,.9));
    }
    .main{ padding:16px 16px 18px }
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:stretch}
    .leftCol{ flex:1 1 340px; min-width:300px }
    .rightCol{ flex:1 1 360px; min-width:320px }
    .card{
      background:rgba(2,6,23,.50);
      border:1px solid rgba(148,163,184,.16);
      border-radius:18px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      backdrop-filter:blur(10px);
    }
    .optionsBtn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(15,23,42,.55);
      color:#e5e7eb;
      cursor:pointer;
      user-select:none;
      margin:12px 0;
      -webkit-tap-highlight-color:transparent;
    }
    .optionsBtn:active{transform:scale(.99)}
    .gear{width:18px;height:18px;filter:drop-shadow(0 0 10px rgba(125,211,252,.25))}
    .console{
      margin-top:12px;
      height:230px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(0,0,0,.25);
      padding:14px;
      overflow:auto;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:14px;
      box-shadow:inset 0 0 0 1px rgba(125,211,252,.06);
      line-height:1.55;
      white-space:pre-wrap;
    }
    .line{display:block;margin:2px 0}
    .line.user{color:#a5b4fc;}
    .line.aura{color:#bbf7d0;}
    .line.sys{color:#fbbf24;font-size:12px;}
    .optionsMenu{
      position:fixed;
      left:12px;
      right:12px;
      top:120px;
      margin:0 auto;
      max-width:940px;
      background:rgba(2,6,23,.92);
      border:1px solid rgba(148,163,184,.18);
      border-radius:16px;
      padding:8px;
      display:none;
      z-index:9999;
      box-shadow:0 18px 45px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
      align-items:stretch;
    }
    .optionsMenu.show{display:grid}
    .menuItem{
      padding:8px 6px;
      border-radius:13px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:6px;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.10);
      background:rgba(15,23,42,.55);
      user-select:none;
      min-height:58px;
    }
    .menuItem:active{transform:scale(.995)}
    .menuLeft{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-weight:800;
      font-size:12.5px;
    }
    .menuIcon{
      width:18px;
      height:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .menuRight{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:44px;
    }
    .pillOn,.pillOff,.pillMid{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      font-weight:900;
      text-transform:lowercase;
      border:1px solid transparent;
    }
    .pillOn{
      background:rgba(34,197,94,.18);
      border-color:rgba(34,197,94,.24);
      color:#bbf7d0;
    }
    .pillOff{
      background:rgba(239,68,68,.12);
      border-color:rgba(239,68,68,.22);
      color:#fecaca;
    }
    .pillMid{
      background:rgba(14,165,233,.14);
      border-color:rgba(14,165,233,.20);
      color:#bae6fd;
      opacity:.95;
    }
    .chatWrap{
      margin-top:0;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.45);
    }
    .reactionBar{
      margin-top:0;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      font-size:18px;
      opacity:.9;
    }
    .reactBtn{
      border:none;
      background:transparent;
      cursor:pointer;
      padding:4px;
      line-height:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      -webkit-tap-highlight-color:transparent;
    }
    .reactBtn:active{transform:scale(.9)}
    .liveCapsule{
      margin:4px 0 10px;
      width:100%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      padding:8px 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:12px;
      color:#dbeafe;
      box-shadow:inset 0 0 0 1px rgba(125,211,252,.06);
    }
    .liveCapsule b{ color:#7dd3fc; font-weight:900 }
    .faithBubble{
      margin:4px 0 10px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(251,191,36,.16);
      border:1px solid rgba(251,191,36,.4);
      display:none;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:#facc15;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      transition:opacity .25s ease, transform .25s ease;
      width:100%;
    }
    .faithBubble.show{
      display:flex;
      opacity:1;
      transform:translateY(0);
    }
    .fbIcon{font-size:18px;}
    .fbText{flex:1;line-height:1.3;}
    .fbTitle{font-weight:800;}
    .fbMeta{opacity:.85;}
    .fbClose{
      border:none;
      background:transparent;
      color:#fed7aa;
      font-size:16px;
      cursor:pointer;
      padding:0 4px;
      line-height:1;
    }
    .faithBubble.pulse{
      animation: faithPulse 1.4s infinite;
    }
    .faithBubble.flying{
      animation: faithFlyUp 2.1s ease-in-out forwards, faithBlink 1s ease-in-out 0s 2;
    }
    @keyframes faithPulse{
      0%   { box-shadow: 0 0 0 0 rgba(251,191,36,.55); }
      100% { box-shadow: 0 0 0 18px rgba(251,191,36,0); }
    }
    @keyframes faithFlyUp{
      0%   { transform:translateY(0); opacity:1; }
      60%  { transform:translateY(-140px); opacity:1; }
      100% { transform:translateY(-180px); opacity:0; }
    }
    @keyframes faithBlink{
      0%{box-shadow:0 0 0 0 rgba(251,191,36,.4);}
      50%{box-shadow:0 0 18px 4px rgba(251,191,36,.95);}
      100%{box-shadow:0 0 0 0 rgba(251,191,36,0);}
    }
    .inputRow{display:flex;gap:10px;align-items:flex-end}
    .input{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      padding:12px 14px;
      outline:none;
      font-size:14px;
    }
    .send{
      border:none;
      border-radius:999px;
      background:linear-gradient(90deg, var(--accent-color, #0ea5e9), rgba(34,211,238,.55));
      color:#0b1220;
      font-weight:900;
      padding:12px 18px;
      cursor:pointer;
      min-width:88px;
      box-shadow:0 12px 30px rgba(14,165,233,.18);
      -webkit-tap-highlight-color:transparent;
    }
    .send:active{transform:scale(.99)}
    .formula{
      margin-top:10px;
      opacity:.8;
      font-size:12px;
      text-align:center;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      color:#dbeafe;
    }
    .toastBubble{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translate(-50%,10px);
      padding:6px 14px;
      border-radius:999px;
      background:rgba(15,23,42,.95);
      color:#e5e7eb;
      font-size:12px;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:0 12px 30px rgba(0,0,0,.5);
      opacity:0;
      pointer-events:none;
      z-index:10000;
      transition:opacity .18s ease, transform .18s ease;
    }
    .toastBubble.show{
      opacity:1;
      transform:translate(-50%,0);
    }
    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:18px 12px;
      z-index:9999;
    }
    .modalOverlay.show{display:flex}
    .modal{
      width:min(860px,96vw);
      border-radius:18px;
      overflow:hidden;
      background:rgba(250,250,250,.93);
      color:#0b1220;
      border:1px solid rgba(15,23,42,.18);
      box-shadow:0 30px 80px rgba(0,0,0,.35);
      backdrop-filter:blur(12px);
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      background:rgba(255,255,255,.75);
      border-bottom:1px solid rgba(15,23,42,.10);
      font-weight:800;
    }
    .modalHeader small{font-weight:600;opacity:.7}
    .closeX{
      border:none;
      background:transparent;
      font-size:22px;
      cursor:pointer;
      line-height:1;
      padding:0 4px;
      opacity:.75;
    }
    .modalBody{
      padding:14px;
      max-height:70vh;
      overflow:auto;
    }
    .chipsWrap{margin-top:10px;display:flex;flex-wrap:wrap;gap:10px}
    .chip{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.16);
      background:rgba(255,255,255,.9);
      font-weight:800;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }
    .chip.active{
      background:#0f172a;
      color:#fff;
      border-color:rgba(15,23,42,.2);
      box-shadow:0 12px 30px rgba(2,6,23,.12);
    }
    .btn{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:12px;
      font-weight:900;
      -webkit-tap-highlight-color:transparent;
      font-size:12px;
    }
    .btnBlue{background:rgba(59,130,246,.16);border:1px solid rgba(59,130,246,.22)}
    .btnDark{background:rgba(2,6,23,.92);color:#fff}
    .btnRed{background:rgba(239,68,68,.14);border:1px solid rgba(239,68,68,.22);color:#7f1d1d}
    .btnGreen{background:rgba(34,197,94,.18);border:1px solid rgba(34,197,94,.25);color:#064e2a}
    .bmCard{
      border-radius:16px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.85);
      padding:12px;
      margin-top:12px;
    }
    .bmTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .bmTop .title{
      font-weight:900;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .bmSub{font-size:12px;opacity:.7;margin-top:2px}
    .bmText{
      width:100%;
      min-height:240px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.18);
      padding:12px;
      outline:none;
      resize:vertical;
      background:#fff;
      font-size:14px;
      line-height:1.45;
    }
    .bmActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      justify-content:flex-start;
    }
    .intelEditInput, .intelEditArea{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.18);
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .intelEditArea{
      min-height:90px;
      resize:vertical;
      line-height:1.4;
      margin-top:6px;
    }
    .intelCard{
      border-radius:12px;
      border:1px solid rgba(15,23,42,.12);
      background:#f9fafb;
      padding:10px;
      margin-top:8px;
      font-size:13px;
    }
    .intelTop{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-bottom:4px;
    }
    .intelQ{font-weight:700;}
    .intelA{margin-top:2px;white-space:pre-wrap;}
    .intelMeta{font-size:11px;opacity:.65;margin-top:2px;}
    .intelButtons{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;margin-top:6px;}
    .intelEditBlock{
      margin-top:8px;
      border-radius:10px;
      border:1px dashed rgba(15,23,42,.18);
      padding:8px;
      background:#fff;
    }
    #modalHistory .modalBody{background:#f8fafc;}
    #historyBox{
      margin-top:4px;
      border-radius:14px;
      padding:4px 0;
      max-height:60vh;
      overflow:auto;
    }
    .historyLine{
      padding:8px 10px;
      font-size:12px;
      margin-bottom:6px;
      border-radius:12px;
      background:#f9fafb;
      border:1px solid rgba(148,163,184,.45);
      color:#0b1120;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:6px;
    }
    .historyText{flex:1;white-space:pre-wrap;}
    .historyLock{
      border:none;
      background:transparent;
      cursor:pointer;
      font-size:15px;
      line-height:1;
      padding:0 2px;
    }
    .bmItem{
      margin-top:6px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.5);
      background:#f9fafb;
      cursor:pointer;
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:6px;
    }
    .bmItemTitle{font-weight:700;}
    .bmItemMeta{opacity:.65;font-size:11px;}

    /* --- DREAM OVERLAY (advanced) --- */
    #dreamOverlay{
      position:fixed;
      inset:0;
      background:
        radial-gradient(circle at 10% 0%, #020617 0, transparent 45%),
        radial-gradient(circle at 90% 0, #0ea5e9 0, transparent 45%),
        rgba(2,6,23,.96);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9500;
      backdrop-filter:blur(16px);
    }
    #dreamOverlay.show{display:flex;}

    .dreamInner{
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:16px;
      text-align:center;
      padding:20px 18px;
      max-width:620px;
      width:100%;
    }

    /* dreamy sky behind everything */
    .dreamSky{
      position:absolute;
      inset:-40px;
      pointer-events:none;
      overflow:hidden;
      opacity:0.9;
    }
    .dreamSky .cloud{
      position:absolute;
      border-radius:999px;
      filter:blur(6px);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 70% 60%, rgba(226,232,240,0.9), rgba(15,23,42,0) 60%);
      opacity:0.55;
      animation:dreamCloudDrift 48s linear infinite;
    }
    .dreamSky .cloud.cloud-a{
      top:8%;
      left:-32%;
      width:165%;
      height:42%;
      animation-duration:52s;
    }
    .dreamSky .cloud.cloud-b{
      bottom:-14%;
      left:-18%;
      width:160%;
      height:46%;
      animation-duration:64s;
      animation-direction:reverse;
    }
    .dreamSky .cloud.cloud-c{
      top:36%;
      left:-40%;
      width:180%;
      height:50%;
      animation-duration:56s;
    }
    @keyframes dreamCloudDrift{
      0%   { transform:translateX(0); }
      100% { transform:translateX(35%); }
    }

    /* BM dream window ‚Äì merged into clouds */
    .dreamBMWindow{
      position:absolute;
      inset:18% 8%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px 20px;
      border-radius:32px;
      background:
        radial-gradient(circle at 20% 0%, rgba(248,250,252,0.95), rgba(15,23,42,0.05) 55%);
      box-shadow:
        0 0 0 1px rgba(148,163,184,0.16),
        0 22px 45px rgba(15,23,42,0.65);
      backdrop-filter:blur(24px);
      opacity:0;
      transform:translateY(12px) scale(0.98);
      transition:opacity 600ms ease, transform 600ms ease;
    }
    #dreamOverlay.show .dreamBMWindow{
      opacity:1;
      transform:translateY(0) scale(1);
    }
    .dreamBMText{
      max-height:9.2rem;
      overflow:hidden;
      font-size:0.9rem;
      line-height:1.4;
      text-align:center;
      color:#020617;
      text-shadow:0 1px 2px rgba(255,255,255,0.9);
      opacity:0;
      transform:translateY(8px) scale(0.98);
      transition:opacity 550ms ease, transform 550ms ease;
    }
    .dreamBMText.show{
      opacity:1;
      transform:translateY(0) scale(1);
    }
    .dreamBMText[data-intensity]::after{
      content:"intensity: " attr(data-intensity);
      display:block;
      margin-top:6px;
      font-size:0.65rem;
      letter-spacing:0.08em;
      text-transform:uppercase;
      opacity:0.75;
    }

    .dreamOrb{
      width:120px;
      height:120px;
      border-radius:999px;
      background:
        radial-gradient(circle at 30% 20%, #ffffff, #7dd3fc 40%, transparent 70%);
      border:2px solid rgba(125,211,252,.9);
      box-shadow:0 0 40px rgba(56,189,248,.8);
      animation:dreamPulse 3.5s ease-in-out infinite;
      position:relative;
      z-index:2;
    }
    .dreamTitle{
      font-weight:800;
      font-size:18px;
      color:#e0f2fe;
      position:relative;
      z-index:2;
    }
    .dreamSub{
      max-width:420px;
      font-size:13px;
      color:#bae6fd;
      opacity:.9;
      position:relative;
      z-index:2;
    }
    .dreamMeta{
      margin-top:4px;
      font-size:11px;
      color:#93c5fd;
      opacity:.85;
      position:relative;
      z-index:2;
    }
    .dreamHint{
      margin-top:6px;
      font-size:11px;
      color:#bfdbfe;
      opacity:.9;
      position:relative;
      z-index:2;
    }
    @keyframes dreamPulse{
      0%{transform:translateY(0) scale(1);}
      50%{transform:translateY(-6px) scale(1.03);}
      100%{transform:translateY(0) scale(1);}
    }

    #imagePreviewArea{
      display:none;
      margin:6px 2px 2px;
      text-align:center;
      font-size:10px;
      opacity:.8;
    }
    #imgPrev{
      max-height:90px;
      border-radius:10px;
      border:2px solid var(--accent-color);
      margin-bottom:2px;
    }

    body.theme-golden .ethic{
      border-color: rgba(251,191,36,.7);
      background: rgba(251,191,36,.06);
    }

    .@media-fix{}
    @media (max-width:760px){
      .console{height:240px}
      .optionsMenu{top:112px}
    }
    @media (max-width:420px){
      .brand{font-size:22px}
      .pill{font-size:14px}
      .ethic{font-size:13px}
      .console{height:260px}
      .optionsMenu{
        gap:6px;
        padding:7px;
        grid-template-columns:repeat(3,minmax(0,1fr));
      }
      .menuItem{min-height:52px;padding:6px 4px;}
      .menuLeft{font-size:11px}
      .pillOn,.pillOff,.pillMid{font-size:9.5px;padding:4px 6px;}
      .reactionBar{font-size:16px;gap:8px;}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="brand">AURA-X Œ©</div>
      <div class="sub">
        Offline emotional continuity engine (prototype)<br>
        TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory.
      </div>
      <div class="ethic" id="ethicBox">
        <div class="ethicMain" id="ethicMain">
          Universal ethic: avoid actions that grow negative emotions in you or others.
          Move gently toward choices that increase shared positive feeling for everyone.
        </div>
        <div class="ethicMeta" id="ethicMeta"></div>
        <button id="faithCfgBtn" class="faithCfgBtn" title="Faith live bar settings">üîò</button>
      </div>
      <div class="pill">EMOTIONAL CONTINUITY ENGINE ‚Äî ACTIVE</div>
    </div>
    <div class="main">
      <div class="row">
        <!-- LEFT -->
        <div class="leftCol">
          <div class="card">
            <div class="optionsBtn" id="btnOptions">
              <svg class="gear" viewBox="0 0 24 24" fill="none">
                <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"
                      stroke="#7dd3fc" stroke-width="2"/>
                <path d="M19.4 15a8.2 8.2 0 0 0 .1-2l2-1.5-2-3.5-2.4 1a8.5 8.5 0 0 0-1.7-1l-.4-2.6h-4l-.4 2.6a8.5 8.5 0 0 0-1.7 1l-2.4-1-2 3.5 2 1.5a8.2 8.2 0 0 0 .1 2L2.7 16.5l2 3.5 2.4-1a8.5 8.5 0 0 0 1.7 1l.4 2.6h4l.4-2.6a8.5 8.5 0 0 0 1.7-1l2.4 1 2-3.5L19.4 15Z"
                      stroke="#7dd3fc" stroke-width="1.6" opacity=".9"/>
              </svg>
              <span>Options</span>
            </div>
            <div class="optionsMenu" id="optionsMenu">
              <div class="menuItem" id="miVoice">
                <div class="menuLeft"><span class="menuIcon">üé§</span><span>Voice</span></div>
                <div class="menuRight"><span class="pillOff" id="voicePill">off</span></div>
              </div>
              <div class="menuItem" id="miIntel">
                <div class="menuLeft"><span class="menuIcon">üß†</span><span>Intelligence</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miLearn">
                <div class="menuLeft"><span class="menuIcon">üìö</span><span>Learning</span></div>
                <div class="menuRight"><span class="pillOn" id="learnPill">on</span></div>
              </div>
              <div class="menuItem" id="miSeed">
                <div class="menuLeft"><span class="menuIcon">üå±</span><span>Feed</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miFaith">
                <div class="menuLeft"><span class="menuIcon">üïä</span><span>Faith</span></div>
                <div class="menuRight"><span class="pillOff" id="faithLabel">none</span></div>
              </div>
              <div class="menuItem" id="miIdentity">
                <div class="menuLeft"><span class="menuIcon">ü™™</span><span>Identity</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miLLM">
                <div class="menuLeft"><span class="menuIcon">ü§ñ</span><span>LLM</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miBMRecall">
                <div class="menuLeft"><span class="menuIcon">üìò</span><span>BM Recall</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miHistory">
                <div class="menuLeft"><span class="menuIcon">üìú</span><span>History</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miSense">
                <div class="menuLeft"><span class="menuIcon">üëÅÔ∏è</span><span>Sense</span></div>
                <div class="menuRight"><span class="pillMid" id="sensePill">idle</span></div>
              </div>
            </div>
            <div class="console" id="console"></div>
          </div>
        </div>
        <!-- RIGHT -->
        <div class="rightCol">
          <div class="chatWrap">
            <div class="reactionBar" id="reactionBar">
              <button class="reactBtn" id="btnLikeLast" title="Save to Intelligence (like)">üëç</button>
              <button class="reactBtn" id="btnDislikeLast" title="Mark incorrect & teach new answer">üëé</button>
              <button class="reactBtn" id="btnSpeakLast" title="Play voice for last answer">üîä</button>
              <button class="reactBtn" id="btnShareLast" title="Copy question + answer">üîó</button>
            </div>
            <div class="liveCapsule">
              <span><b>E0</b>: <span id="cE0">0.000</span></span><span>¬∑</span>
              <span><b>TM</b>: <span id="cTM">0.00</span></span><span>¬∑</span>
              <span><b>BM</b>: <span id="cBM">0.00</span></span><span>¬∑</span>
              <span><b>C</b>: <span id="cCont">0.850</span></span>
            </div>
            <div class="faithBubble" id="faithBubble">
              <div class="fbIcon">üí≠</div>
              <div class="fbText">
                <div class="fbTitle" id="faithBubbleTitle">Faith reflection bubble</div>
                <div class="fbMeta" id="faithBubbleMeta">Tap to see a short suggestion.</div>
              </div>
              <button class="fbClose" id="faithBubbleClose">√ó</button>
            </div>
            <div class="inputRow">
              <label class="reactBtn" style="cursor:pointer;margin-bottom:12px;">
                üì∑
                <input type="file" id="visionInput" accept="image/*" style="display:none">
              </label>
              <input class="input" id="userInput" placeholder="Talk to AURA-X Œ©‚Ä¶ (TM = your inputs)" />
              <button class="send" id="sendBtn">Send</button>
            </div>
            <div id="imagePreviewArea">
              <img id="imgPrev" alt="preview">
              <div>Image attached for analysis</div>
            </div>
            <div class="formula">
              E‚ÇÄ = tanh( R(TM,BM) + I(TM) + I<sub>intel</sub> + I<sub>LLM</sub> ‚àí D + Œª<sub>faith</sub> + Œª<sub>sys</sub> + Œª<sub>trc</sub> )
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dream overlay (advanced) -->
  <div id="dreamOverlay">
    <div class="dreamInner">
      <div class="dreamSky">
        <div class="cloud cloud-a"></div>
        <div class="cloud cloud-b"></div>
        <div class="cloud cloud-c"></div>

        <div class="dreamBMWindow">
          <div class="dreamBMText" id="dreamBMText"></div>
        </div>
      </div>

      <div class="dreamOrb"></div>
      <div class="dreamText">
        <div class="dreamTitle">AURA-X Œ© ¬∑ Dreaming</div>
        <div class="dreamSub">
          Screensaver is softly exploring your BM + TM resonance.
        </div>
        <div class="dreamMeta" id="dreamMetaText"></div>
        <div class="dreamHint">
          Tap anywhere to return ¬∑ nothing is sent online while dreaming.
        </div>
      </div>
    </div>
  </div>

  <!-- Toast bubble -->
  <div class="toastBubble" id="toastBubble"></div>

  <!-- Sense (Camera + Mic) -->
  <div class="modalOverlay" id="modalSense">
    <div class="modal">
      <div class="modalHeader">
        <div>üëÅÔ∏è Sense (Camera + Mic)<br><small>Capture a moment ‚Üí create a BM prompt stub (local only).</small></div>
        <button class="closeX" data-close="modalSense">√ó</button>
      </div>
      <div class="modalBody" style="background:#fefce8;">
        <div style="opacity:.85;font-size:13px;line-height:1.35;margin-bottom:10px">
          Uses your device camera/microphone only with permission. Nothing is uploaded in this prototype.
          A developer can later plug a Vision / Speech-to-text API to analyse the real content.
        </div>

        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px">
          <button class="btn btnBlue" id="btnSenseCamera">Camera snapshot</button>
          <button class="btn btnBlue" id="btnSenseMic">Record 10s audio</button>
          <span style="font-size:12px;opacity:.75;align-self:center" id="senseStatus">Idle.</span>
        </div>

        <video id="senseVideo" autoplay playsinline muted
               style="width:100%;max-height:190px;border-radius:14px;border:1px solid rgba(15,23,42,.18);display:none;margin-bottom:8px;background:#000"></video>
        <canvas id="senseCanvas" style="display:none"></canvas>

        <textarea id="senseBMBox"
          style="width:100%;min-height:160px;border-radius:14px;border:1px solid rgba(15,23,42,.18);padding:10px;font-size:13px;line-height:1.4;background:#fff;"
          placeholder="Sense ‚Üí BM prompt stub will appear here‚Ä¶ You can edit before saving."></textarea>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn btnGreen" id="btnSaveSenseBM">Save as BM snapshot</button>
        </div>
      </div>
    </div>
  </div>

  <!-- LLM settings -->
  <div class="modalOverlay" id="modalLLM">
    <div class="modal">
      <div class="modalHeader">
        <div>ü§ñ LLM Settings<br><small>Configure offline/online model (prototype only).</small></div>
        <button class="closeX" data-close="modalLLM">√ó</button>
      </div>
      <div class="modalBody">
        <div style="font-size:13px;opacity:.8;margin-bottom:10px">
          In this prototype, replies are local scripted logic + your Intelligence/BM. A developer can later plug an actual API / WebLLM model here.
        </div>
        <label style="font-size:12px;font-weight:600">Endpoint (optional)</label>
        <input id="apiEndpoint" class="intelEditInput" placeholder="https://api.openai.com/v1/chat/completions (for example)">
        <label style="font-size:12px;font-weight:600;margin-top:8px;display:block">Model</label>
        <input id="apiModel" class="intelEditInput" placeholder="gpt-4.1-mini (for example)">
        <label style="font-size:12px;font-weight:600;margin-top:8px;display:block">API Key (stored locally only)</label>
        <input id="apiKey" class="intelEditInput" placeholder="sk-..." type="password">
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn btnDark" id="btnSaveLLM">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- BM Recall -->
  <div class="modalOverlay" id="modalBM">
    <div class="modal">
      <div class="modalHeader">
        <div>üìò Bold Memory (BM) Recall<br><small>Review & edit locked prompts.</small></div>
        <button class="closeX" data-close="modalBM">√ó</button>
      </div>
      <div class="modalBody">
        <div style="font-size:13px;opacity:.75;margin-bottom:8px">
          These are strongly ‚Äúlocked‚Äù BM snapshots that shape continuity and dreaming.
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <input id="bmSearch" class="intelEditInput" placeholder="Search in BM text‚Ä¶">
          <input id="bmDate" class="intelEditInput" type="date" style="max-width:160px">
        </div>
        <div id="bmSelectList"></div>

        <div id="bmViewer" class="bmCard" style="display:none;">
          <div class="bmTop">
            <div class="title">
              <span id="bmLockIcon">üîí</span>
              <span id="bmTitle">Selected BM</span>
            </div>
            <div class="bmMeta" id="bmMeta">meta</div>
          </div>
          <textarea id="bmTextArea" class="bmText"></textarea>
          <div class="bmActions">
            <button class="btn btnGreen" id="btnLiveBM">Use live</button>
            <button class="btn btnBlue" id="btnCopyPrompt">Copy</button>
            <button class="btn btnBlue" id="btnAutoGen">Auto title</button>
            <button class="btn btnRed" id="btnUnlockBM">Unlock</button>
            <button class="btn btnRed" id="btnDeletePrompt">Delete</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- History -->
  <div class="modalOverlay" id="modalHistory">
    <div class="modal">
      <div class="modalHeader">
        <div>üìú Conversation History<br><small>Last sessions & emotional trail.</small></div>
        <button class="closeX" data-close="modalHistory">√ó</button>
      </div>
      <div class="modalBody">
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <button class="btn btnRed" id="btnDeleteAllHist">Delete all</button>
          <button class="btn btnBlue" id="btnDeleteRecent">Delete last 10</button>
          <button class="btn btnBlue" id="btnCopyHistory">Copy</button>
        </div>
        <div id="historyBox"></div>
      </div>
    </div>
  </div>

  <!-- Intelligence -->
  <div class="modalOverlay" id="modalIntel">
    <div class="modal">
      <div class="modalHeader">
        <div>üß† Intelligence (Local Q&A)<br><small>Teach AURA-X Œ© your stable truths.</small></div>
        <button class="closeX" data-close="modalIntel">√ó</button>
      </div>
      <div class="modalBody">
        <input id="intelQ" class="intelEditInput" placeholder="Question / trigger text">
        <textarea id="intelA" class="intelEditArea" placeholder="Your answer / explanation (plain text)"></textarea>
        <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn btnGreen" id="btnSaveIntel">Save / update</button>
        </div>
        <div id="intelList"></div>
      </div>
    </div>
  </div>

  <!-- Identity -->
  <div class="modalOverlay" id="modalIdentity">
    <div class="modal">
      <div class="modalHeader">
        <div>ü™™ Identity (You)<br><small>Used only for emotional continuity, local only.</small></div>
        <button class="closeX" data-close="modalIdentity">√ó</button>
      </div>
      <div class="modalBody">
        <div style="font-size:12px;opacity:.78;margin-bottom:6px">
          This is a local ‚Äúprofile‚Äù so that AURA-X Œ© can remember who you are across sessions (BM-style).
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
          <input id="uName" class="intelEditInput" placeholder="Full name" readonly>
          <input id="uNick" class="intelEditInput" placeholder="Nickname / alias" readonly>
          <input id="uOrigin" class="intelEditInput" placeholder="Origin / roots" readonly>
          <input id="uPlace" class="intelEditInput" placeholder="Current city" readonly>
          <input id="uProfession" class="intelEditInput" placeholder="Profession / main role" readonly>
          <input id="uEmotionalStyle" class="intelEditInput" placeholder="Emotional style (e.g. ‚Äòcalm / intense / playful‚Äô)" readonly>
        </div>
        <textarea id="uKeyPeople" class="intelEditArea" placeholder="Key people in your life (names / relation)" readonly></textarea>
        <textarea id="uLegacyRules" class="intelEditArea" placeholder="Legacy rules ‚Äî what should never be violated for you?" readonly></textarea>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn btnBlue" id="btnEditIdentity">Unlock for edit</button>
          <button class="btn btnGreen" id="btnSaveUserIdentity">Save</button>
          <button class="btn btnRed" id="btnDeleteUserIdentity">Delete identity</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Faith modal (simple version) -->
  <div class="modalOverlay" id="modalFaith">
    <div class="modal">
      <div class="modalHeader">
        <div>üïä Faith Window<br><small>Gentle reflection texts (manual, local).</small></div>
        <button class="closeX" data-close="modalFaith">√ó</button>
      </div>
      <div class="modalBody">
        <div style="font-size:13px;opacity:.8;margin-bottom:8px">
          This is a small manual ‚Äúfaith window‚Äù text block. You can replace it with your own curated content.
        </div>
        <textarea id="faithText" class="intelEditArea" style="min-height:200px;">
In every decision, try to avoid actions that produce durable harm or remorse.
Move gently toward choices that increase shared positive feeling for you and the people around you.
        </textarea>
        <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn btnGreen" id="btnSaveFaith">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Seed (TM/BM feed) -->
  <div class="modalOverlay" id="modalSeed">
    <div class="modal">
      <div class="modalHeader">
        <div>üå± Feed TM/BM<br><small>Paste longer context so AURA-X Œ© sees your world.</small></div>
        <button class="closeX" data-close="modalSeed">√ó</button>
      </div>
      <div class="modalBody">
        <textarea id="seedInput" class="intelEditArea" placeholder="Paste texts / notes that should temporarily colour TM‚Ä¶"></textarea>
        <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn btnGreen" id="btnParseSeed">Parse into TM</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dream / screensaver controls modal -->
  <div class="modalOverlay" id="modalDreamCfg">
    <div class="modal">
      <div class="modalHeader">
        <div>üí§ Dream Screensaver<br><small>BM-integrated dreaming clouds.</small></div>
        <button class="closeX" data-close="modalDreamCfg">√ó</button>
      </div>
      <div class="modalBody">
        <div style="font-size:13px;opacity:.8;margin-bottom:10px">
          When idle, AURA-X Œ© enters a ‚Äúdream‚Äù mode where clouds drift and stronger BM snapshots appear softly like scenes.
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <span style="font-size:13px;opacity:.8">Delay:</span>
          <select id="dreamDelaySelect" class="intelEditInput" style="max-width:200px">
            <option value="60000">1 minute</option>
            <option value="180000">3 minutes</option>
            <option value="300000">5 minutes</option>
            <option value="900000">15 minutes</option>
          </select>
        </div>
        <div id="dreamStatusText" style="font-size:12px;opacity:.8;margin-bottom:10px;"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn btnBlue" id="btnTestDream">Test dream now</button>
          <button class="btn btnGreen" id="btnToggleDream">Enable</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Simple helpers =====
    const KEY_INT = "aurax_intelligence_v1";
    const KEY_BM = "aurax_bm_v1";
    const KEY_CFG = "aurax_cfg_v14";
    const KEY_HISTORY = "aurax_history_v1";
    const KEY_SEED = "aurax_seed_v1";
    const KEY_IDENTITY = "aurax_identity_v1";
    const KEY_FAITH = "aurax_faith_text_v1";
    const KEY_INTUITION = "aurax_intuition_v1";

    const INTUITION_INTERVAL_MS = 7*24*60*60*1000; // €ÅŸÅÿ™€Å

    function safeLoadJSON(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        return JSON.parse(raw);
      }catch(e){
        console.warn("JSON load failed", key, e);
        return fallback;
      }
    }

    function showToast(msg){
      const el = document.getElementById("toastBubble");
      if(!el) return;
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(()=>el.classList.remove("show"), 2200);
    }

    function logLine(role, text){
      const consoleEl = document.getElementById("console");
      if(!consoleEl) return;
      const span = document.createElement("span");
      span.className = "line " + role;
      span.textContent = "["+role.toUpperCase()+"] " + text;
      consoleEl.appendChild(span);
      consoleEl.appendChild(document.createElement("br"));
      consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    function nowTs(){
      return Date.now();
    }

    // ===== Global state =====
    const state = {
      metrics: { TM:0, BM:0, C:0.85, E0:0 },
      intelligence: [],
      bmPrompts: [],
      history: [],
      parsedSeed: [],
      editingIntelId: null,
      lastStoryInput: null,
      lastStoryBMId: null,
      faithSelection: "none",
      faithLiveOptions: {},
      abuseCount: 0,
      cooldownUntil: 0,
      mode: "adult",
      learningOn: true,
      voiceOn: false,
      apiConfig: { endpoint:"", model:"", key:"" },
      offlineReady: false,
      userIdentity: null,
      lastAnswerText: "",
      toastTimer: null,
      dreamEnabled: false,
      dreamDelayMs: 300000,
      dreamTimerId: null,
      lastActivityTs: nowTs(),
      currentFaith: "none",
      faithFlightPending: false,
      faithFlightDone: false,
      currentFaithForCfg: null,
      sense: { stream:null, mediaRecorder:null, chunks:[], busy:false },
      intuition: { lastRun: 0, samples: [] },
      dreamSeq: [],
      dreamSeqIndex: 0,
      dreamCloudTimerId: null
    };

    const els = {
      console: document.getElementById("console"),
      userInput: document.getElementById("userInput"),
      sendBtn: document.getElementById("sendBtn"),
      toastBubble: document.getElementById("toastBubble"),
      cE0: document.getElementById("cE0"),
      cTM: document.getElementById("cTM"),
      cBM: document.getElementById("cBM"),
      cCont: document.getElementById("cCont"),
      btnOptions: document.getElementById("btnOptions"),
      optionsMenu: document.getElementById("optionsMenu"),
      miVoice: document.getElementById("miVoice"),
      miIntel: document.getElementById("miIntel"),
      miLearn: document.getElementById("miLearn"),
      miSeed: document.getElementById("miSeed"),
      miFaith: document.getElementById("miFaith"),
      miIdentity: document.getElementById("miIdentity"),
      miLLM: document.getElementById("miLLM"),
      miBMRecall: document.getElementById("miBMRecall"),
      miHistory: document.getElementById("miHistory"),
      miSense: document.getElementById("miSense"),
      voicePill: document.getElementById("voicePill"),
      learnPill: document.getElementById("learnPill"),
      faithLabel: document.getElementById("faithLabel"),
      faithCfgBtn: document.getElementById("faithCfgBtn"),
      ethicBox: document.getElementById("ethicBox"),
      ethicMeta: document.getElementById("ethicMeta"),
      faithBubble: document.getElementById("faithBubble"),
      faithBubbleTitle: document.getElementById("faithBubbleTitle"),
      faithBubbleMeta: document.getElementById("faithBubbleMeta"),
      faithBubbleClose: document.getElementById("faithBubbleClose"),
      visionInput: document.getElementById("visionInput"),
      imagePreviewArea: document.getElementById("imagePreviewArea"),
      imgPrev: document.getElementById("imgPrev"),
      btnLikeLast: document.getElementById("btnLikeLast"),
      btnDislikeLast: document.getElementById("btnDislikeLast"),
      btnSpeakLast: document.getElementById("btnSpeakLast"),
      btnShareLast: document.getElementById("btnShareLast"),
      modalSense: document.getElementById("modalSense"),
      btnSenseCamera: document.getElementById("btnSenseCamera"),
      btnSenseMic: document.getElementById("btnSenseMic"),
      senseVideo: document.getElementById("senseVideo"),
      senseCanvas: document.getElementById("senseCanvas"),
      senseStatus: document.getElementById("senseStatus"),
      senseBMBox: document.getElementById("senseBMBox"),
      btnSaveSenseBM: document.getElementById("btnSaveSenseBM"),
      modalLLM: document.getElementById("modalLLM"),
      apiEndpoint: document.getElementById("apiEndpoint"),
      apiModel: document.getElementById("apiModel"),
      apiKey: document.getElementById("apiKey"),
      btnSaveLLM: document.getElementById("btnSaveLLM"),
      modalBM: document.getElementById("modalBM"),
      bmSearch: document.getElementById("bmSearch"),
      bmDate: document.getElementById("bmDate"),
      bmSelectList: document.getElementById("bmSelectList"),
      bmViewer: document.getElementById("bmViewer"),
      bmLockIcon: document.getElementById("bmLockIcon"),
      bmTitle: document.getElementById("bmTitle"),
      bmMeta: document.getElementById("bmMeta"),
      bmTextArea: document.getElementById("bmTextArea"),
      btnLiveBM: document.getElementById("btnLiveBM"),
      btnUnlockBM: document.getElementById("btnUnlockBM"),
      btnCopyPrompt: document.getElementById("btnCopyPrompt"),
      btnAutoGen: document.getElementById("btnAutoGen"),
      btnDeletePrompt: document.getElementById("btnDeletePrompt"),
      modalHistory: document.getElementById("modalHistory"),
      historyBox: document.getElementById("historyBox"),
      btnDeleteAllHist: document.getElementById("btnDeleteAllHist"),
      btnDeleteRecent: document.getElementById("btnDeleteRecent"),
      btnCopyHistory: document.getElementById("btnCopyHistory"),
      modalIntel: document.getElementById("modalIntel"),
      intelQ: document.getElementById("intelQ"),
      intelA: document.getElementById("intelA"),
      btnSaveIntel: document.getElementById("btnSaveIntel"),
      intelList: document.getElementById("intelList"),
      modalIdentity: document.getElementById("modalIdentity"),
      btnEditIdentity: document.getElementById("btnEditIdentity"),
      btnSaveUserIdentity: document.getElementById("btnSaveUserIdentity"),
      btnDeleteUserIdentity: document.getElementById("btnDeleteUserIdentity"),
      uName: document.getElementById("uName"),
      uNick: document.getElementById("uNick"),
      uOrigin: document.getElementById("uOrigin"),
      uPlace: document.getElementById("uPlace"),
      uProfession: document.getElementById("uProfession"),
      uEmotionalStyle: document.getElementById("uEmotionalStyle"),
      uKeyPeople: document.getElementById("uKeyPeople"),
      uLegacyRules: document.getElementById("uLegacyRules"),
      modalFaith: document.getElementById("modalFaith"),
      faithText: document.getElementById("faithText"),
      btnSaveFaith: document.getElementById("btnSaveFaith"),
      modalSeed: document.getElementById("modalSeed"),
      seedInput: document.getElementById("seedInput"),
      btnParseSeed: document.getElementById("btnParseSeed"),
      modalDreamCfg: document.getElementById("modalDreamCfg"),
      dreamDelaySelect: document.getElementById("dreamDelaySelect"),
      dreamStatusText: document.getElementById("dreamStatusText"),
      btnTestDream: document.getElementById("btnTestDream"),
      btnToggleDream: document.getElementById("btnToggleDream"),
      dreamOverlay: document.getElementById("dreamOverlay"),
      dreamMetaText: document.getElementById("dreamMetaText"),
      dreamBMText: document.getElementById("dreamBMText")
    };

    // ===== Metrics and E0 =====
    function recomputeTMMetric(){
      const h = state.history;
      if(!h.length){ state.metrics.TM = 0; return; }
      const last = h[h.length-1];
      const len = (last.text || "").length;
      state.metrics.TM = Math.min(len / 400, 1.5);
    }

    function recomputeBMMetric(){
      const locked = state.bmPrompts.filter(b=>b.locked);
      state.metrics.BM = Math.min(locked.length / 12, 1.6);
    }

    function recomputeE0(extraLLM = 0, extraIntel = 0){
      const m = state.metrics;
      const R = m.TM * 0.9 + m.BM * 1.1;
      const I_TM = m.TM * 0.5;
      const I_intel = extraIntel;
      const I_llm = extraLLM;
      const D = state.history.length > 40 ? 0.5 : 0.0;
      const lambda_faith = state.currentFaith === "none" ? 0 : 0.2;
      const lambda_sys = 0.1;
      const lambda_trc = 0.15;
      const raw = R + I_TM + I_intel + I_llm - D + lambda_faith + lambda_sys + lambda_trc;
      const E0 = Math.tanh(raw);
      state.metrics.E0 = E0;
      updateCapsule();
    }

    function updateCapsule(){
      if(els.cTM) els.cTM.textContent = state.metrics.TM.toFixed(2);
      if(els.cBM) els.cBM.textContent = state.metrics.BM.toFixed(2);
      if(els.cCont) els.cCont.textContent = state.metrics.C.toFixed(3);
      if(els.cE0) els.cE0.textContent = state.metrics.E0.toFixed(3);
    }

    // ===== Intelligence (Q&A) =====
    function loadIntelligence(){
      const data = safeLoadJSON(KEY_INT, []);
      if(Array.isArray(data)) state.intelligence = data;
      renderIntelList();
    }

    function saveIntelligence(){
      localStorage.setItem(KEY_INT, JSON.stringify(state.intelligence));
    }

    function renderIntelList(){
      if(!els.intelList) return;
      els.intelList.innerHTML = "";
      state.intelligence.forEach(item=>{
        const card = document.createElement("div");
        card.className = "intelCard";
        const top = document.createElement("div");
        top.className = "intelTop";
        const qEl = document.createElement("div");
        qEl.className = "intelQ";
        qEl.textContent = item.q;
        const meta = document.createElement("div");
        meta.className = "intelMeta";
        meta.textContent = "ID " + item.id + " ¬∑ " + new Date(item.ts).toLocaleString();
        top.appendChild(qEl);
        top.appendChild(meta);

        const aEl = document.createElement("div");
        aEl.className = "intelA";
        aEl.textContent = item.a;

        const btns = document.createElement("div");
        btns.className = "intelButtons";
        const bEdit = document.createElement("button");
        bEdit.className = "btn btnBlue";
        bEdit.textContent = "Edit";
        bEdit.onclick = ()=>{
          state.editingIntelId = item.id;
          els.intelQ.value = item.q;
          els.intelA.value = item.a;
        };
        const bDel = document.createElement("button");
        bDel.className = "btn btnRed";
        bDel.textContent = "Delete";
        bDel.onclick = ()=>{
          if(!confirm("Delete this Q&A?")) return;
          state.intelligence = state.intelligence.filter(x=>x.id!==item.id);
          saveIntelligence();
          renderIntelList();
          showToast("Intelligence item deleted");
        };
        btns.appendChild(bEdit);
        btns.appendChild(bDel);

        card.appendChild(top);
        card.appendChild(aEl);
        card.appendChild(btns);
        els.intelList.appendChild(card);
      });
    }

    function handleSaveIntel(){
      const q = els.intelQ.value.trim();
      const a = els.intelA.value.trim();
      if(!q || !a){ showToast("Both question and answer required"); return; }
      if(state.editingIntelId){
        const item = state.intelligence.find(x=>x.id===state.editingIntelId);
        if(item){
          item.q = q;
          item.a = a;
          item.ts = nowTs();
        }
        state.editingIntelId = null;
      }else{
        state.intelligence.push({
          id: "intel_"+nowTs(),
          q, a,
          ts: nowTs()
        });
      }
      els.intelQ.value = "";
      els.intelA.value = "";
      saveIntelligence();
      renderIntelList();
      showToast("Intelligence saved");
    }

    function findIntelAnswer(prompt){
      const lower = prompt.toLowerCase();
      let best = null;
      state.intelligence.forEach(item=>{
        if(lower.includes(item.q.toLowerCase())){
          best = item;
        }
      });
      if(best) return best.a;
      return null;
    }

    // ===== BM =====
    function loadBM(){
      const data = safeLoadJSON(KEY_BM, []);
      if(Array.isArray(data)) state.bmPrompts = data;
      recomputeBMMetric();
      renderBMList();
    }

    function saveBM(){
      localStorage.setItem(KEY_BM, JSON.stringify(state.bmPrompts));
      recomputeBMMetric();
      recomputeE0(0,0);
    }

    function renderBMList(){
      if(!els.bmSelectList) return;
      els.bmSelectList.innerHTML = "";
      state.bmPrompts.forEach(b=>{
        const div = document.createElement("div");
        div.className = "bmItem";
        div.onclick = ()=>openBMViewer(b.id);
        const left = document.createElement("div");
        const title = document.createElement("div");
        title.className = "bmItemTitle";
        title.textContent = (b.title || "BM snapshot");
        const meta = document.createElement("div");
        meta.className = "bmItemMeta";
        meta.textContent = (b.locked?"üîí":"üîì")+" ¬∑ "+new Date(b.ts).toLocaleString();
        left.appendChild(title);
        left.appendChild(meta);
        const right = document.createElement("div");
        right.className="bmItemMeta";
        const t = (b.text || "").slice(0,60).replace(/\s+\S*$/,"");
        right.textContent = t + (b.text && b.text.length>60 ? "‚Ä¶" : "");
        div.appendChild(left);
        div.appendChild(right);
        els.bmSelectList.appendChild(div);
      });
    }

    function openBMViewer(id){
      const b = state.bmPrompts.find(x=>x.id===id);
      if(!b) return;
      state.selectedBMId = id;
      els.bmViewer.style.display = "block";
      els.bmTitle.textContent = b.title || "BM snapshot";
      els.bmLockIcon.textContent = b.locked ? "üîí" : "üîì";
      els.bmMeta.textContent = new Date(b.ts).toLocaleString();
      els.bmTextArea.value = b.text || "";
    }

    function saveCurrentBMText(){
      if(!state.selectedBMId) return;
      const b = state.bmPrompts.find(x=>x.id===state.selectedBMId);
      if(!b) return;
      b.text = els.bmTextArea.value;
      b.ts = nowTs();
      saveBM();
      renderBMList();
      showToast("BM updated");
    }

    // ===== History =====
    function loadHistory(){
      const data = safeLoadJSON(KEY_HISTORY, []);
      if(Array.isArray(data)) state.history = data;
      renderHistory();
    }

    function saveHistory(){
      localStorage.setItem(KEY_HISTORY, JSON.stringify(state.history));
    }

    function addHistory(role, text){
      state.history.push({ role, text, ts: nowTs() });
      if(state.history.length > 200) state.history.shift();
      saveHistory();
      renderHistory();
      recomputeTMMetric();
      recomputeE0(0,0);
    }

    function renderHistory(){
      if(!els.historyBox) return;
      els.historyBox.innerHTML = "";
      state.history.slice().reverse().forEach(h=>{
        const div = document.createElement("div");
        div.className = "historyLine";
        const t = document.createElement("div");
        t.className = "historyText";
        t.textContent = "["+h.role+"] "+h.text;
        const b = document.createElement("button");
        b.className = "historyLock";
        b.textContent = "‚≠ê";
        b.title = "Save as BM snapshot";
        b.onclick = ()=>{
          state.bmPrompts.push({
            id: "bm_"+nowTs(),
            title: "From history",
            text: h.text,
            ts: nowTs(),
            locked: true
          });
          saveBM();
          renderBMList();
          showToast("Saved to BM");
        };
        div.appendChild(t);
        div.appendChild(b);
        els.historyBox.appendChild(div);
      });
    }

    // ===== Identity =====
    function loadIdentity(){
      const data = safeLoadJSON(KEY_IDENTITY, null);
      if(data) state.userIdentity = data;
      loadIdentityIntoForm();
    }

    function loadIdentityIntoForm(){
      const u = state.userIdentity || {};
      els.uName.value = u.name || "";
      els.uNick.value = u.nick || "";
      els.uOrigin.value = u.origin || "";
      els.uPlace.value = u.place || "";
      els.uProfession.value = u.profession || "";
      els.uEmotionalStyle.value = u.emotionalStyle || "";
      els.uKeyPeople.value = u.keyPeople || "";
      els.uLegacyRules.value = u.legacyRules || "";
    }

    function saveIdentity(){
      state.userIdentity = {
        name: els.uName.value.trim(),
        nick: els.uNick.value.trim(),
        origin: els.uOrigin.value.trim(),
        place: els.uPlace.value.trim(),
        profession: els.uProfession.value.trim(),
        emotionalStyle: els.uEmotionalStyle.value.trim(),
        keyPeople: els.uKeyPeople.value.trim(),
        legacyRules: els.uLegacyRules.value.trim(),
        ts: nowTs()
      };
      localStorage.setItem(KEY_IDENTITY, JSON.stringify(state.userIdentity));
      showToast("Identity saved");
    }

    // ===== Faith text =====
    function loadFaith(){
      const txt = localStorage.getItem(KEY_FAITH);
      if(txt && els.faithText){
        els.faithText.value = txt;
      }
    }

    function saveFaithText(){
      const txt = els.faithText.value;
      localStorage.setItem(KEY_FAITH, txt);
      showToast("Faith text saved");
    }

    // ===== Seed =====
    function loadSeed(){
      const txt = localStorage.getItem(KEY_SEED);
      if(txt && els.seedInput) els.seedInput.value = txt;
    }

    function saveSeed(){
      localStorage.setItem(KEY_SEED, els.seedInput.value);
    }

    function parseSeed(){
      const txt = els.seedInput.value.trim();
      saveSeed();
      if(!txt){ showToast("Nothing to parse"); return; }
      const lines = txt.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      state.parsedSeed = lines;
      showToast("Seed parsed into "+lines.length+" TM lines");
    }

    // ===== Config (dream, voice, learning, LLM) =====
    function loadCfg(){
      const cfg = safeLoadJSON(KEY_CFG, null);
      if(!cfg) return;
      state.voiceOn = !!cfg.voiceOn;
      state.learningOn = !!cfg.learningOn;
      state.faithSelection = cfg.faithSelection || "none";
      state.faithLiveOptions = cfg.faithLiveOptions || {};
      state.apiConfig = cfg.apiConfig || state.apiConfig;
      state.offlineReady = !!cfg.offlineReady;
      if(cfg.dream){
        state.dreamEnabled = !!cfg.dream.enabled;
        state.dreamDelayMs = cfg.dream.delayMs || state.dreamDelayMs;
      }
      updateCfgUI();
    }

    function saveCfg(){
      const cfg = {
        voiceOn: state.voiceOn,
        learningOn: state.learningOn,
        faithSelection: state.faithSelection,
        faithLiveOptions: state.faithLiveOptions,
        apiConfig: state.apiConfig,
        offlineReady: state.offlineReady,
        dream: { enabled: state.dreamEnabled, delayMs: state.dreamDelayMs }
      };
      localStorage.setItem(KEY_CFG, JSON.stringify(cfg));
    }

    function updateCfgUI(){
      els.voicePill.textContent = state.voiceOn ? "on" : "off";
      els.voicePill.className = state.voiceOn ? "pillOn" : "pillOff";
      els.learnPill.textContent = state.learningOn ? "on" : "off";
      els.learnPill.className = state.learningOn ? "pillOn" : "pillOff";
      els.faithLabel.textContent = state.faithSelection || "none";
      updateDreamUI();
    }

    // ===== Dream mode 2.0 (BM scenes in clouds) =====
    function buildDreamSequence(){
      const seq = (state.bmPrompts || [])
        .map(b=>{
          const text = (b.text || "").trim();
          if(!text) return null;
          const base = Math.min(text.length/240, 1.2);
          const lockedBoost = b.locked ? 0.4 : 0;
          const score = Math.min(base + lockedBoost, 1.6);
          return {
            id: b.id,
            text,
            intensity: Number(Math.min(score, 1.6).toFixed(2))
          };
        })
        .filter(Boolean)
        .filter(d=>d.intensity >= 0.6);

      if(!seq.length){
        const hist = (state.history || []).filter(h=>h.role==="user").slice(-6);
        hist.forEach((h,idx)=>{
          const text = (h.text || "").trim();
          if(!text) return;
          const base = Math.min(text.length/260, 1);
          seq.push({
            id: "hist_"+idx,
            text,
            intensity: Number(Math.max(0.5, base).toFixed(2))
          });
        });
      }

      state.dreamSeq = seq;
      state.dreamSeqIndex = 0;
    }

    function showNextDreamFrame(){
      if(!els.dreamBMText) return;
      if(!state.dreamSeq || !state.dreamSeq.length){
        els.dreamBMText.textContent =
          "Soft idle dreaming‚Ä¶ (no strong BM snapshots yet).";
        els.dreamBMText.dataset.intensity = "";
        els.dreamBMText.classList.add("show");
        return;
      }
      const item = state.dreamSeq[state.dreamSeqIndex % state.dreamSeq.length];
      state.dreamSeqIndex++;

      let t = item.text;
      if(t.length > 260){
        t = t.slice(0,240).replace(/\s+\S*$/,"") + "‚Ä¶";
      }

      els.dreamBMText.classList.remove("show");
      void els.dreamBMText.offsetWidth;
      els.dreamBMText.textContent = t;
      els.dreamBMText.dataset.intensity = item.intensity.toFixed(2);
      els.dreamBMText.classList.add("show");
    }

    function startDreamCloudLoop(){
      if(state.dreamCloudTimerId){
        clearInterval(state.dreamCloudTimerId);
        state.dreamCloudTimerId = null;
      }
      showNextDreamFrame();
      state.dreamCloudTimerId = setInterval(showNextDreamFrame, 9000);
    }

    function stopDreamCloudLoop(){
      if(state.dreamCloudTimerId){
        clearInterval(state.dreamCloudTimerId);
        state.dreamCloudTimerId = null;
      }
    }

    function updateDreamUI(){
      if(!els.dreamDelaySelect || !els.btnToggleDream || !els.dreamStatusText) return;
      if(state.dreamEnabled){
        els.btnToggleDream.textContent = "Disable";
        els.btnToggleDream.className = "btn btnRed";
      }else{
        els.btnToggleDream.textContent = "Enable";
        els.btnToggleDream.className = "btn btnGreen";
      }
      const current = state.dreamDelayMs;
      let bestVal = els.dreamDelaySelect.options.length ? els.dreamDelaySelect.options[0].value : String(current);
      let bestDiff = Infinity;
      Array.from(els.dreamDelaySelect.options).forEach(opt=>{
        const v = parseInt(opt.value,10);
        const diff = Math.abs(v-current);
        if(diff<bestDiff){bestDiff=diff;bestVal=opt.value;}
      });
      els.dreamDelaySelect.value = bestVal;
      const ms = state.dreamDelayMs;
      let label;
      if(ms < 60000){
        label = Math.round(ms/1000) + " seconds";
      }else{
        const mins = ms/60000;
        if(mins >= 60){
          const hrs = mins/60;
          label = hrs.toFixed(1).replace(/\.0$/,"") + " hours";
        }else{
          label = mins + " minutes";
        }
      }
      els.dreamStatusText.textContent = state.dreamEnabled
        ? "Screensaver is ON ¬∑ starts after " + label + " of no activity."
        : "Screensaver is OFF.";
    }

    function showDreamOverlay(){
      if(!els.dreamOverlay) return;

      buildDreamSequence();
      startDreamCloudLoop();

      const bmCount = state.bmPrompts.length || 0;
      if(els.dreamMetaText){
        els.dreamMetaText.textContent = bmCount
          ? "Dreaming across " + bmCount + " BM snapshot" + (bmCount>1?"s":"") + "‚Ä¶"
          : "Dreaming gently with recent TM feelings (no BM snapshots stored yet).";
      }
      els.dreamOverlay.classList.add("show");
    }

    function hideDreamOverlay(){
      if(!els.dreamOverlay) return;
      els.dreamOverlay.classList.remove("show");
      stopDreamCloudLoop();
      scheduleDreamTimer();
    }

    function scheduleDreamTimer(){
      state.lastActivityTs = nowTs();
      if(state.dreamTimerId){ clearTimeout(state.dreamTimerId); state.dreamTimerId = null; }
      if(!state.dreamEnabled) return;
      const delay = Math.min(Math.max(state.dreamDelayMs,30000), 28800000);
      state.dreamDelayMs = delay;
      state.dreamTimerId = setTimeout(()=>{ showDreamOverlay(); }, delay);

      // Weekly intuition check €Åÿ± ÿ®ÿßÿ± ÿ¨ÿ® €ÅŸÖ ÿÆŸàÿßÿ® plan ⁄©ÿ±ÿ™€í €Å€å⁄∫
      maybeRunWeeklyIntuition();
    }

    function registerActivity(){
      if(els.dreamOverlay && els.dreamOverlay.classList.contains("show")) return;
      scheduleDreamTimer();
    }

    // ===== Intuition (weekly soft suggestions) =====
    function loadIntuition(){
      const data = safeLoadJSON(KEY_INTUITION, null);
      if(data && typeof data === "object"){
        state.intuition.lastRun = data.lastRun || 0;
        state.intuition.samples = Array.isArray(data.samples) ? data.samples : [];
      }
    }

    function saveIntuition(){
      const payload = {
        lastRun: state.intuition.lastRun || 0,
        samples: (state.intuition.samples || []).slice(-12)
      };
      localStorage.setItem(KEY_INTUITION, JSON.stringify(payload));
    }

    function buildIntuitionSummary(hist, lockedBM){
      const total = hist.length;
      const userMsgs = hist.filter(h=>h.role==="user").length;
      const auraMsgs = hist.filter(h=>h.role==="aura").length;
      const locked = lockedBM.length;
      const latestLocked = lockedBM[locked-1];
      const latestHint = latestLocked && (latestLocked.text || "")
        .replace(/\s+/g," ")
        .slice(0,120);

      let summary = `Ÿæ⁄Ü⁄æŸÑ€í €ÅŸÅÿ™€í ÿ™ŸÖ ŸÜ€í ${total} ÿß€ÅŸÖ ÿ®ÿßÿ™€å⁄∫ ⁄©€å⁄∫ (You:${userMsgs}, AURA:${auraMsgs}). `;
      if(locked && latestHint){
        summary += `ÿ™ŸÖ ŸÜ€í ${locked} BM snapshots ⁄©Ÿà lock ⁄©€åÿß ‚Äì ÿ¢ÿÆÿ±€å focus: ‚Äú${latestHint}‚Ä¶‚Äù. `;
      }
      summary += "ŸÖ€åÿ±€å intuition €å€Å ⁄©€Åÿ™€å €Å€í ⁄©€Å ÿß⁄ØŸÑ€í €ÅŸÅÿ™€í ÿßŸÜ€Å€å themes ŸÖ€å⁄∫ ÿ≥€í 1‚Äì2 ⁄Ü⁄æŸàŸπ€í practical ŸÅ€åÿµŸÑ€í ŸæŸÑÿßŸÜ ⁄©ÿ±Ÿàÿå ÿ®⁄ë€í dramatic jumps ⁄©€í ÿ®ÿ¨ÿßÿ¶€í€î";
      return summary;
    }

    function maybeRunWeeklyIntuition(){
      const now = nowTs();
      const last = state.intuition.lastRun || 0;
      if(now - last < INTUITION_INTERVAL_MS) return;

      const recentHist = (state.history || []).filter(h=> now - h.ts <= INTUITION_INTERVAL_MS);
      const lockedBM  = (state.bmPrompts || []).filter(b=>b.locked);

      if(!recentHist.length && !lockedBM.length) return;

      const summary = buildIntuitionSummary(recentHist, lockedBM);
      const sample = {
        ts: now,
        summary,
        historyCount: recentHist.length,
        lockedBMCount: lockedBM.length
      };

      state.intuition.lastRun = now;
      state.intuition.samples.push(sample);
      saveIntuition();

      logLine("aura", "[Intuition] " + summary);
    }

    // ===== Simple reply engine (local only) =====
    function generateAuraReply(prompt){
      const intel = findIntelAnswer(prompt);
      if(intel){
        return intel;
      }
      // fallback simple echo + E0 context
      const mood = state.metrics.E0 > 0.4 ? "positive" : (state.metrics.E0 < -0.2 ? "heavy" : "neutral");
      return `ŸÖ€å⁄∫ ÿ™ŸÖ€Åÿßÿ±€å ÿ®ÿßÿ™ ÿ≥ŸÜ ÿ±€Åÿß €ÅŸà⁄∫€î ÿßÿ®⁄æ€å E‚ÇÄ ‚âà ${state.metrics.E0.toFixed(3)} (${mood}). ÿ™ŸÖ ŸÜ€í ⁄©€Åÿß: ‚Äú${prompt}‚Äù ‚Äî ⁄Üÿß€ÅŸà ÿ™Ÿà ÿßÿ≥€í BM ŸÖ€å⁄∫ lock ÿ®⁄æ€å ⁄©ÿ± ÿ≥⁄©ÿ™€í €ÅŸà€î`;
    }

    function handleSend(){
      const text = els.userInput.value.trim();
      if(!text) return;
      els.userInput.value = "";
      registerActivity();

      logLine("user", text);
      addHistory("user", text);

      const reply = generateAuraReply(text);
      state.lastAnswerText = reply;
      logLine("aura", reply);
      addHistory("aura", reply);
    }

    // ===== Sense (camera + mic) stub =====
    async function startSenseCamera(){
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        showToast("Camera not available");
        return;
      }
      try{
        state.sense.stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
        els.senseVideo.srcObject = state.sense.stream;
        els.senseVideo.style.display = "block";
        els.senseStatus.textContent = "Camera active ‚Äì tap snapshot via BM button below (prototype).";
        showToast("Camera on (local only)");
      }catch(e){
        console.warn(e);
        showToast("Camera permission denied");
      }
    }

    function stopSenseCamera(){
      if(state.sense.stream){
        state.sense.stream.getTracks().forEach(t=>t.stop());
        state.sense.stream = null;
      }
      els.senseVideo.style.display = "none";
      els.senseStatus.textContent = "Idle.";
    }

    function saveSenseAsBM(){
      const txt = els.senseBMBox.value.trim();
      if(!txt){ showToast("No sense text to save"); return; }
      state.bmPrompts.push({
        id: "bm_sense_"+nowTs(),
        title: "Sense snapshot",
        text: txt,
        ts: nowTs(),
        locked: true
      });
      els.senseBMBox.value = "";
      saveBM();
      renderBMList();
      showToast("Sense ‚Üí BM saved");
    }

    // ===== Modals helpers =====
    function openModal(id){
      const el = document.getElementById(id);
      if(el) el.classList.add("show");
    }
    function closeModal(id){
      const el = document.getElementById(id);
      if(el) el.classList.remove("show");
      if(id==="modalSense") stopSenseCamera();
    }

    // ===== Wiring =====
    function wireEvents(){
      els.sendBtn.addEventListener("click", handleSend);
      els.userInput.addEventListener("keydown", e=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          handleSend();
        }
      });

      document.addEventListener("click", ()=>registerActivity(), {capture:true});
      document.addEventListener("keydown", ()=>registerActivity(), {capture:true});
      document.addEventListener("mousemove", ()=>registerActivity());
      document.addEventListener("touchstart", ()=>registerActivity());

      els.btnOptions.addEventListener("click", ()=>{
        els.optionsMenu.classList.toggle("show");
      });

      els.miVoice.addEventListener("click", ()=>{
        state.voiceOn = !state.voiceOn;
        updateCfgUI();
        saveCfg();
      });
      els.miLearn.addEventListener("click", ()=>{
        state.learningOn = !state.learningOn;
        updateCfgUI();
        saveCfg();
      });
      els.miLLM.addEventListener("click", ()=>openModal("modalLLM"));
      els.miIntel.addEventListener("click", ()=>openModal("modalIntel"));
      els.miBMRecall.addEventListener("click", ()=>openModal("modalBM"));
      els.miHistory.addEventListener("click", ()=>openModal("modalHistory"));
      els.miIdentity.addEventListener("click", ()=>openModal("modalIdentity"));
      els.miFaith.addEventListener("click", ()=>openModal("modalFaith"));
      els.miSeed.addEventListener("click", ()=>openModal("modalSeed"));

      // Dream config ‚Äì open via holding Options (long-press logic simplified: double click)
      els.btnOptions.addEventListener("dblclick", ()=>openModal("modalDreamCfg"));

      // Generic close buttons
      document.querySelectorAll(".closeX").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-close");
          if(id) closeModal(id);
        });
      });

      // LLM save
      els.btnSaveLLM.addEventListener("click", ()=>{
        state.apiConfig.endpoint = els.apiEndpoint.value.trim();
        state.apiConfig.model = els.apiModel.value.trim();
        state.apiConfig.key = els.apiKey.value.trim();
        saveCfg();
        showToast("LLM config saved (local only)");
      });

      // Intel save
      els.btnSaveIntel.addEventListener("click", handleSaveIntel);

      // History actions
      els.btnDeleteAllHist.addEventListener("click", ()=>{
        if(!confirm("Delete ALL history?")) return;
        state.history = [];
        saveHistory();
        renderHistory();
        recomputeTMMetric();
        recomputeE0(0,0);
        showToast("History cleared");
      });
      els.btnDeleteRecent.addEventListener("click", ()=>{
        state.history.splice(-10,10);
        saveHistory();
        renderHistory();
        recomputeTMMetric();
        recomputeE0(0,0);
        showToast("Last 10 history items removed");
      });
      els.btnCopyHistory.addEventListener("click", ()=>{
        const txt = state.history.map(h=>"[ "+h.role+" ] "+h.text).join("\n");
        navigator.clipboard.writeText(txt).then(()=>showToast("History copied"));
      });

      // BM viewer buttons
      els.bmTextArea.addEventListener("blur", saveCurrentBMText);
      els.btnUnlockBM.addEventListener("click", ()=>{
        if(!state.selectedBMId) return;
        const b = state.bmPrompts.find(x=>x.id===state.selectedBMId);
        if(!b) return;
        b.locked = !b.locked;
        els.bmLockIcon.textContent = b.locked ? "üîí" : "üîì";
        saveBM();
        renderBMList();
        showToast(b.locked?"Locked":"Unlocked");
      });
      els.btnLiveBM.addEventListener("click", ()=>{
        if(!state.selectedBMId) return;
        const b = state.bmPrompts.find(x=>x.id===state.selectedBMId);
        if(!b) return;
        els.userInput.value = b.text || "";
        closeModal("modalBM");
      });
      els.btnCopyPrompt.addEventListener("click", ()=>{
        if(!state.selectedBMId) return;
        const b = state.bmPrompts.find(x=>x.id===state.selectedBMId);
        if(!b) return;
        navigator.clipboard.writeText(b.text || "").then(()=>showToast("BM copied"));
      });
      els.btnAutoGen.addEventListener("click", ()=>{
        if(!state.selectedBMId) return;
        const b = state.bmPrompts.find(x=>x.id===state.selectedBMId);
        if(!b) return;
        const t = (b.text || "").split(/[.\n]/)[0].slice(0,60);
        b.title = t || "BM snapshot";
        els.bmTitle.textContent = b.title;
        saveBM();
        renderBMList();
        showToast("Title auto-generated");
      });
      els.btnDeletePrompt.addEventListener("click",()=>{
        if(!state.selectedBMId) return;
        const bm = state.bmPrompts.find(x=>x.id===state.selectedBMId);
        if(!bm) return;
        if(!confirm("Delete this BM prompt?")) return;
        if(!confirm("Are you sure? This cannot be undone.")) return;
        state.bmPrompts = state.bmPrompts.filter(x=>x.id!==bm.id);
        state.selectedBMId = null;
        saveBM();
        renderBMList();
        els.bmViewer.style.display = "none";
        showToast("BM prompt deleted");
      });

      // Identity buttons
      els.btnEditIdentity.addEventListener("click",()=>{
        [els.uName,els.uNick,els.uOrigin,els.uPlace,els.uProfession,
         els.uEmotionalStyle,els.uKeyPeople,els.uLegacyRules].forEach(el=>el.removeAttribute("readonly"));
        showToast("Identity fields unlocked for edit");
      });
      els.btnSaveUserIdentity.addEventListener("click",saveIdentity);
      els.btnDeleteUserIdentity.addEventListener("click",()=>{
        if(!confirm("Delete identity?")) return;
        state.userIdentity = null;
        localStorage.removeItem(KEY_IDENTITY);
        loadIdentityIntoForm();
        showToast("Identity deleted");
      });

      // Faith
      els.btnSaveFaith.addEventListener("click", saveFaithText);

      // Seed
      els.btnParseSeed.addEventListener("click", parseSeed);

      // Dream config
      if(els.btnToggleDream){
        els.btnToggleDream.addEventListener("click",()=>{
          state.dreamEnabled = !state.dreamEnabled;
          if(!state.dreamEnabled){
            if(state.dreamTimerId){ clearTimeout(state.dreamTimerId); state.dreamTimerId = null; }
            if(els.dreamOverlay) els.dreamOverlay.classList.remove("show");
          }
          updateDreamUI();
          saveCfg();
          scheduleDreamTimer();
        });
      }
      if(els.dreamDelaySelect){
        els.dreamDelaySelect.addEventListener("change",()=>{
          const v = parseInt(els.dreamDelaySelect.value,10);
          if(!isNaN(v)){
            state.dreamDelayMs = v;
            updateDreamUI();
            saveCfg();
            scheduleDreamTimer();
          }
        });
      }
      if(els.btnTestDream && els.dreamOverlay){
        els.btnTestDream.addEventListener("click",()=>{ showDreamOverlay(); });
      }
      if(els.dreamOverlay){
        els.dreamOverlay.addEventListener("click",()=>{ hideDreamOverlay(); });
      }

      // Sense
      els.btnSenseCamera.addEventListener("click", startSenseCamera);
      els.btnSenseMic.addEventListener("click", ()=>{
        showToast("Mic recording stub ‚Äî real STT to be wired by developer.");
      });
      els.btnSaveSenseBM.addEventListener("click", saveSenseAsBM);

      // Vision input preview
      els.visionInput.addEventListener("change", (e)=>{
        const file = e.target.files && e.target.files[0];
        if(!file){ els.imagePreviewArea.style.display="none"; return; }
        const reader = new FileReader();
        reader.onload = ev=>{
          els.imgPrev.src = ev.target.result;
          els.imagePreviewArea.style.display = "block";
        };
        reader.readAsDataURL(file);
      });

      // Reaction bar
      els.btnLikeLast.addEventListener("click", ()=>{
        if(!state.lastAnswerText){ showToast("No last answer"); return; }
        state.intelligence.push({
          id: "intel_from_like_"+nowTs(),
          q: state.lastStoryInput || "recent",
          a: state.lastAnswerText,
          ts: nowTs()
        });
        saveIntelligence();
        renderIntelList();
        showToast("Saved to Intelligence");
      });
      els.btnDislikeLast.addEventListener("click", ()=>{
        showToast("Teach better answer via Intelligence panel.");
      });
      els.btnShareLast.addEventListener("click", ()=>{
        if(!state.lastAnswerText){ showToast("No last answer"); return; }
        navigator.clipboard.writeText(state.lastAnswerText).then(()=>showToast("Answer copied"));
      });
      els.btnSpeakLast.addEventListener("click", ()=>{
        if(!("speechSynthesis" in window)){ showToast("No TTS in this browser"); return; }
        if(!state.lastAnswerText){ showToast("No last answer"); return; }
        const utter = new SpeechSynthesisUtterance(state.lastAnswerText);
        speechSynthesis.speak(utter);
      });

      // Faith bubble close
      els.faithBubbleClose.addEventListener("click",(e)=>{
        e.stopPropagation();
        els.faithBubble.classList.remove("show","pulse","flying");
      });
      els.faithBubble.addEventListener("click",()=>{
        openModal("modalFaith");
      });
    }

    function init(){
      loadIntelligence();
      loadBM();
      loadHistory();
      loadIdentity();
      loadFaith();
      loadSeed();
      loadCfg();
      loadIntuition();
      updateCapsule();
      wireEvents();
      scheduleDreamTimer();
      logLine("sys","AURA-X Œ© ready. This is the 4.9 baseline with advanced Dream & weekly Intuition layer.");
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>