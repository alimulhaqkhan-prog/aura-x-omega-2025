<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #fdf4e3; /* book-page background */
      color: #111827;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Header */
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .title-main {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .title-sub {
      font-size: 11px;
      color: #6b7280;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
      white-space: nowrap;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #ef4444;
    }
    .status-pill[data-status="calling"] {
      background: #fef9c3;
      color: #854d0e;
      border-color: #fef3c7;
    }
    .status-pill[data-status="calling"] .status-dot {
      background: #eab308;
    }
    .status-pill[data-status="online"] {
      background: #dcfce7;
      color: #166534;
      border-color: #bbf7d0;
    }
    .status-pill[data-status="online"] .status-dot {
      background: #22c55e;
    }
    .status-pill[data-status="error"] {
      background: #fee2e2;
      color: #991b1b;
      border-color: #fecaca;
    }
    .status-pill span {
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Top buttons */
    .top-buttons {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
    }
    .chip-button {
      flex: 0 0 auto;
      min-width: 96px;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      background: #fef3c7;
      color: #92400e;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 1px 0 rgba(0,0,0,0.04);
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
    }
    .chip-button:hover {
      background: #fde68a;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .chip-emoji {
      font-size: 16px;
    }

    /* Ethics banner */
    .ethics-banner {
      border-radius: 16px;
      background: #fef3c7;
      padding: 12px 14px;
      font-size: 13px;
      line-height: 1.4;
      color: #92400e;
      border: 1px solid rgba(251, 191, 36, 0.4);
    }

    /* Equation card */
    .card {
      border-radius: 18px;
      background: #faf5ff;
      padding: 12px 14px;
      border: 1px solid rgba(129, 140, 248, 0.3);
    }
    .card-title {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #4b5563;
      margin-bottom: 6px;
    }
    .equation {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      margin-bottom: 6px;
      color: #111827;
    }
    .card-body {
      font-size: 11.5px;
      color: #4b5563;
      line-height: 1.4;
    }

    /* Reaction card */
    .reaction-card {
      border-radius: 18px;
      background: #dcfce7;
      padding: 12px 14px;
      border: 1px solid #bbf7d0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 80px;
    }
    .reaction-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      font-size: 11px;
      color: #166534;
      margin-bottom: 2px;
    }
    .reaction-title {
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .reaction-tags {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      font-size: 11px;
    }
    .reaction-tag {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(22, 163, 74, 0.1);
      color: #166534;
    }
    .reaction-metrics {
      font-size: 11px;
      color: #166534;
    }
    .reaction-text {
      font-size: 13px;
      color: #064e3b;
      margin-top: 4px;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .reaction-error {
      font-size: 11px;
      color: #991b1b;
      margin-top: 2px;
    }

    /* Message log area */
    .log-card {
      border-radius: 18px;
      background: #fefce8;
      padding: 10px 12px;
      border: 1px solid #fef3c7;
      flex: 1;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow-y: auto;
    }
    .log-label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 2px;
    }
    .log-bubble {
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 13px;
      line-height: 1.35;
      background: #ecfeff;
      color: #0f172a;
      border: 1px solid #bae6fd;
      white-space: pre-wrap;
    }
    .log-bubble.user {
      background: #dbeafe;
      border-color: #bfdbfe;
    }
    .log-meta {
      font-size: 10px;
      color: #9ca3af;
      text-align: right;
      margin-top: 2px;
    }

    /* Input area */
    .input-section {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .tm-caption {
      font-size: 11px;
      color: #6b7280;
    }
    .input-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    .tm-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 10px 14px;
      font-size: 13px;
      outline: none;
      background: #fefdf7;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6);
      transition: border-color 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }
    .tm-input:focus {
      border-color: #22c55e;
      box-shadow:
        0 0 0 1px rgba(34, 197, 94, 0.3),
        0 4px 12px rgba(34, 197, 94, 0.25);
      background: #ffffff;
    }
    .send-button {
      border-radius: 999px;
      border: none;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      color: white;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      box-shadow: 0 6px 16px rgba(22, 163, 74, 0.45);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      min-width: 82px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.08s ease;
    }
    .send-button:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 8px 18px rgba(22, 163, 74, 0.55);
    }
    .send-button:active {
      transform: translateY(0);
      box-shadow: 0 3px 8px rgba(22, 163, 74, 0.4);
    }
    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* Voice toggle bar */
    .voice-bar {
      margin-top: 4px;
      border-radius: 999px;
      padding: 6px 10px;
      background: #ecfdf5;
      border: 1px solid #bbf7d0;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      color: #166534;
    }
    .voice-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .voice-indicator {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      background: linear-gradient(135deg, #22c55e, #4ade80);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
      position: relative;
      overflow: hidden;
    }
    .voice-indicator::after {
      content: "";
      position: absolute;
      inset: 3px;
      border-radius: 3px;
      border: 1px solid rgba(240, 253, 250, 0.9);
    }
    .voice-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      font-size: 11px;
      color: #166534;
    }

    /* BM Viewer modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }
    .modal-backdrop.show {
      display: flex;
    }
    .modal {
      width: 100%;
      max-width: 480px;
      max-height: 80vh;
      background: #fefce8;
      border-radius: 18px;
      padding: 14px 14px 12px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
      display: flex;
      flex-direction: column;
      gap: 8px;
      border: 1px solid #facc15;
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .modal-title {
      font-size: 14px;
      font-weight: 700;
      color: #78350f;
    }
    .modal-close {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 12px;
      background: #fef3c7;
      color: #92400e;
      cursor: pointer;
    }
    .modal-search {
      border-radius: 999px;
      border: 1px solid #facc15;
      padding: 6px 10px;
      font-size: 12px;
      background: #fffbeb;
      outline: none;
    }
    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding-right: 2px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .bm-layer {
      border-radius: 12px;
      padding: 6px 8px;
      background: rgba(248, 250, 252, 0.8);
      border: 1px solid #e5e7eb;
    }
    .bm-layer-header {
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 3px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }
    .bm-item {
      border-radius: 10px;
      padding: 6px 8px;
      background: #fef9c3;
      font-size: 12px;
      line-height: 1.35;
      margin-top: 4px;
    }
    .bm-meta {
      font-size: 10px;
      color: #6b7280;
      margin-top: 2px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }
    .bm-copy-btn {
      border-radius: 999px;
      border: none;
      padding: 2px 8px;
      font-size: 10px;
      background: #22c55e;
      color: white;
      cursor: pointer;
    }

    .footer-trace {
      margin-top: 3px;
      font-size: 10px;
      text-align: center;
      color: #9ca3af;
    }

    @media (max-width: 480px) {
      .app { padding: 10px 8px 10px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header-top">
      <div class="title-block">
        <div class="title-main">AURA-X Œ© ‚Äì Emotional Continuity</div>
        <div class="title-sub">TM ¬∑ BM ¬∑ AEC ¬∑ CRM ¬∑ AECN ¬∑ RL¬≥ ¬∑ LR¬≥</div>
      </div>
      <div class="status-pill" id="llmStatus" data-status="idle">
        <div class="status-dot"></div>
        <span id="llmStatusText">LLM: Waiting for first call</span>
      </div>
    </header>

    <!-- Top controls -->
    <div class="top-buttons">
      <button class="chip-button" id="btnBmViewer">
        <span class="chip-emoji">üß†</span>
        <span>BM Viewer</span>
      </button>
      <button class="chip-button" id="btnRecallBm">
        <span class="chip-emoji">üìú</span>
        <span>Recall BM</span>
      </button>
      <button class="chip-button" id="btnRecycle">
        <span class="chip-emoji">‚ôªÔ∏è</span>
        <span>Recycle 48h</span>
      </button>
      <button class="chip-button" id="btnOptions">
        <span class="chip-emoji">‚öôÔ∏è</span>
        <span>Options</span>
      </button>
    </div>

    <!-- Ethics banner -->
    <div class="ethics-banner" id="ethicsBanner">
      Avoid actions that generate negative emotions in yourself or others.
      Gently move toward choices that create calm, kindness, and positive feelings.
    </div>

    <!-- Equation card -->
    <section class="card">
      <div class="card-title">EMOTIONAL CONTINUITY EQUATION</div>
      <div class="equation">
        E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)
      </div>
      <div class="card-body">
        All parameters are updated internally after every message to keep emotional continuity live.
      </div>
    </section>

    <!-- Reaction card -->
    <section class="reaction-card" id="reactionCard">
      <div class="reaction-header">
        <div>
          <div class="reaction-title">AURA-X Œ© REACTION</div>
        </div>
        <div class="reaction-tags">
          <span class="reaction-tag" id="polarityTag">Polarity: Mixed</span>
          <span class="reaction-tag" id="toneTag">Tone: Neutral</span>
        </div>
      </div>
      <div class="reaction-metrics" id="intensityLine">
        Intensity: Low ‚Ä¢ Polarity: 50 : 50
      </div>
      <div class="reaction-text" id="reactionText">
        Backend error aya, lekin TM/BM local side par phir bhi save ho sakte hain.
        Thori dair baad dobara try karein.
      </div>
      <div class="reaction-error" id="reactionError"></div>
    </section>

    <!-- Log (last TM / BM pair) -->
    <section class="log-card" id="logCard">
      <div>
        <div class="log-label">TM input (last message)</div>
        <div class="log-bubble user" id="tmLogBubble">
          Write anything‚Ä¶ it will be treated as TM (Temporary Memory).
        </div>
        <div class="log-meta" id="tmMetaText"></div>
      </div>
      <div>
        <div class="log-label">AURA-X Œ© (last reaction)</div>
        <div class="log-bubble" id="bmLogBubble">
          When stories get deeper, they are promoted from TM to BM (Bold Memory).
        </div>
        <div class="log-meta" id="bmMetaText"></div>
      </div>
    </section>

    <!-- Input section -->
    <section class="input-section">
      <div class="tm-caption">
        TM = Œ£(User Inputs) + (Seed + LLM)
      </div>
      <div class="input-row">
        <input
          id="tmInput"
          class="tm-input"
          placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."
        />
        <button id="sendButton" class="send-button">
          <span>Send</span>
          <span>‚û§</span>
        </button>
      </div>
      <div class="voice-bar">
        <div class="voice-left">
          <div class="voice-indicator" id="voiceIndicator"></div>
          <span>Prototype: TM ‚Üí Analysis ‚Üí Equation ‚Üí BM save ‚Üí Reaction.</span>
        </div>
        <button class="voice-toggle" id="voiceToggle" type="button">
          <span id="voiceToggleCheck">‚úÖ</span>
          <span>Voice: On (UI only)</span>
        </button>
      </div>
    </section>

    <div class="footer-trace">
      AURA-X Œ© ¬∑ Local Emotional Continuity Prototype (Frontend only ‚Äì book-page theme)
    </div>
  </div>

  <!-- BM Viewer Modal -->
  <div class="modal-backdrop" id="bmModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Bold Memory (BM) ‚Äì 7 Layer Viewer</div>
        <button class="modal-close" id="bmModalClose">Close</button>
      </div>
      <input
        id="bmSearch"
        class="modal-search"
        placeholder="Search BM by text, category, or layer‚Ä¶"
      />
      <div class="modal-body" id="bmModalBody">
        <!-- BM layers rendered here -->
      </div>
    </div>
  </div>

  <script>
    // =============================
    //  CONFIG
    // =============================
    const BACKEND_URL = "https://aura-x-omega-backend.onrender.com/api/ask";
    const STORAGE_TM_KEY = "aura_tm_log_v1";
    const STORAGE_BM_KEY = "aura_bm_layers_v1";

    // =============================
    //  STATE
    // =============================
    let tmLog = [];
    let bmLayers = [];
    let voiceEnabled = true;

    function initState() {
      try {
        const storedTm = localStorage.getItem(STORAGE_TM_KEY);
        const storedBm = localStorage.getItem(STORAGE_BM_KEY);
        tmLog = storedTm ? JSON.parse(storedTm) : [];
        bmLayers = storedBm ? JSON.parse(storedBm) : createEmptyBMLayers();
      } catch (e) {
        console.error("Failed to parse stored state", e);
        tmLog = [];
        bmLayers = createEmptyBMLayers();
      }
      renderLastLog();
    }

    function createEmptyBMLayers() {
      const names = [
        "L1 ‚Äì Fresh Daily",
        "L2 ‚Äì Recent Drift",
        "L3 ‚Äì Weekly Echo",
        "L4 ‚Äì Monthly Pattern",
        "L5 ‚Äì Yearly Story",
        "L6 ‚Äì Life Themes",
        "L7 ‚Äì Core Narrative"
      ];
      return names.map((name, idx) => ({
        id: "L" + (idx + 1),
        name,
        memories: []
      }));
    }

    function saveState() {
      localStorage.setItem(STORAGE_TM_KEY, JSON.stringify(tmLog));
      localStorage.setItem(STORAGE_BM_KEY, JSON.stringify(bmLayers));
    }

    // =============================
    //  LLM STATUS
    // =============================
    const llmStatusEl = document.getElementById("llmStatus");
    const llmStatusTextEl = document.getElementById("llmStatusText");

    function setStatusIdle() {
      llmStatusEl.dataset.status = "idle";
      llmStatusTextEl.textContent = "LLM: Waiting for first call";
    }

    function setStatusCalling() {
      llmStatusEl.dataset.status = "calling";
      llmStatusTextEl.textContent = "LLM: Contacting backend‚Ä¶";
    }

    function setStatusOnline() {
      llmStatusEl.dataset.status = "online";
      llmStatusTextEl.textContent = "LLM: Online";
    }

    function setStatusError(msg) {
      llmStatusEl.dataset.status = "error";
      llmStatusTextEl.textContent = "LLM: Error ‚Äì " + msg;
    }

    // =============================
    //  EMOTION METRICS (SIMPLE)
    // =============================
    function computeEmotionMetrics(text) {
      const lengthScore = Math.min(text.length / 280, 1);
      const exclamations = (text.match(/!/g) || []).length;
      const questions = (text.match(/\?/g) || []).length;
      const lower = text.toLowerCase();

      let positiveHint = 0;
      let negativeHint = 0;

      const posWords = ["thank", "shukriya", "love", "great", "zabardast", "happy", "alhamdulillah"];
      const negWords = ["sad", "afraid", "scared", "alone", "angry", "hurt", "problem", "issue", "depressed"];

      posWords.forEach(w => { if (lower.includes(w)) positiveHint += 0.08; });
      negWords.forEach(w => { if (lower.includes(w)) negativeHint += 0.08; });

      let polarityRaw = 0.5 + positiveHint - negativeHint + (exclamations * 0.01) - (questions * 0.01);
      polarityRaw = Math.max(0.05, Math.min(0.95, polarityRaw));

      const posPercent = Math.round(polarityRaw * 100);
      const negPercent = 100 - posPercent;

      let polarityLabel = "Mixed";
      if (posPercent > 60) polarityLabel = "Positive";
      if (negPercent > 60) polarityLabel = "Negative";

      let tone = "Neutral";
      if (posPercent > 65 && lengthScore < 0.4) tone = "Light, gentle positive drift.";
      else if (posPercent > 65) tone = "Warm, hopeful positive drift.";
      else if (negPercent > 65 && lengthScore > 0.5) tone = "Heavy, low-energy concern.";
      else if (negPercent > 65) tone = "Soft fallback, mild worry.";

      let intensityLabel = "Low";
      if (lengthScore > 0.7 || exclamations + questions >= 3) intensityLabel = "High";
      else if (lengthScore > 0.4) intensityLabel = "Medium";

      return {
        polarityLabel,
        tone,
        intensityLabel,
        posPercent,
        negPercent
      };
    }

    // =============================
    //  BACKEND CALL
    // =============================
    async function callBackend(message) {
      setStatusCalling();
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 25000);

      try {
        const res = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message }),
          signal: controller.signal
        });

        clearTimeout(timeout);

        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        const data = await res.json();
        setStatusOnline();

        let reply =
          data.reply ||
          data.response ||
          data.message ||
          "[Backend replied but no text field was found]";

        return { reply, error: null };
      } catch (err) {
        clearTimeout(timeout);
        console.error("Backend error", err);
        setStatusError(err.name === "AbortError" ? "Timeout" : err.message);
        return { reply: null, error: err.message || "Unknown error" };
      }
    }

    // =============================
    //  LOG + BM SAVE
    // =============================
    function addTMEntry(userText, auraText, metrics, backendError) {
      const entry = {
        id: Date.now().toString(),
        userText,
        auraText,
        metrics,
        backendError: backendError || null,
        timestamp: new Date().toISOString()
      };
      tmLog.push(entry);
      if (tmLog.length > 120) tmLog.shift();
      promoteToBM(entry);
      saveState();
      renderLastLog();
    }

    function promoteToBM(entry) {
      const { userText, metrics } = entry;
      const lengthScore = userText.length;

      // simple rule: only deeper / longer messages become BM
      if (lengthScore < 140) return;

      // choose layer by length and intensity
      let layerIndex = 0; // L1
      if (lengthScore > 200) layerIndex = 1;
      if (lengthScore > 280) layerIndex = 2;
      if (metrics.intensityLabel === "High") layerIndex = 3;
      if (metrics.polarityLabel === "Negative" && metrics.intensityLabel === "High") layerIndex = 4;
      if (lengthScore > 400) layerIndex = 5;
      if (lengthScore > 600) layerIndex = 6;

      const layer = bmLayers[layerIndex];
      layer.memories.push({
        id: entry.id,
        text: userText,
        polarity: metrics.polarityLabel,
        intensity: metrics.intensityLabel,
        createdAt: entry.timestamp,
        layerId: layer.id
      });

      // limit each layer
      if (layer.memories.length > 40) layer.memories.shift();
    }

    function renderLastLog() {
      const tmBubble = document.getElementById("tmLogBubble");
      const bmBubble = document.getElementById("bmLogBubble");
      const tmMetaText = document.getElementById("tmMetaText");
      const bmMetaText = document.getElementById("bmMetaText");

      if (tmLog.length === 0) {
        tmBubble.textContent = "Write anything‚Ä¶ it will be treated as TM (Temporary Memory).";
        bmBubble.textContent = "When stories get deeper, they are promoted from TM to BM (Bold Memory).";
        tmMetaText.textContent = "";
        bmMetaText.textContent = "";
        return;
      }

      const last = tmLog[tmLog.length - 1];
      tmBubble.textContent = last.userText;
      bmBubble.textContent = last.auraText;

      const time = new Date(last.timestamp).toLocaleString();
      tmMetaText.textContent =
        "Saved as TM at " + time + " ¬∑ Polarity " +
        last.metrics.posPercent + ":" + last.metrics.negPercent +
        " ¬∑ Intensity " + last.metrics.intensityLabel;

      bmMetaText.textContent = last.backendError
        ? "LLM backend error: " + last.backendError
        : "LLM backend OK ‚Äì stored as emotional continuity trace.";
    }

    // =============================
    //  REACTION CARD RENDER
    // =============================
    function renderReaction(metrics, auraText, backendError) {
      const polarityTag = document.getElementById("polarityTag");
      const toneTag = document.getElementById("toneTag");
      const intensityLine = document.getElementById("intensityLine");
      const reactionTextEl = document.getElementById("reactionText");
      const errorEl = document.getElementById("reactionError");

      polarityTag.textContent = "Polarity: " + metrics.polarityLabel;
      toneTag.textContent = "Tone: " + metrics.tone;
      intensityLine.textContent =
        "Intensity: " + metrics.intensityLabel +
        " ‚Ä¢ Polarity: " + metrics.posPercent + " : " + metrics.negPercent;

      reactionTextEl.textContent = auraText;
      errorEl.textContent = backendError
        ? "[LLM backend error: " + backendError + "]"
        : "";
    }

    // =============================
    //  INPUT HANDLING
    // =============================
    const tmInputEl = document.getElementById("tmInput");
    const sendButtonEl = document.getElementById("sendButton");

    async function handleSend() {
      const text = tmInputEl.value.trim();
      if (!text) return;

      tmInputEl.value = "";
      sendButtonEl.disabled = true;

      const metrics = computeEmotionMetrics(text);

      // optimistic placeholder
      let auraText =
        "Processing your TM‚Ä¶ even if backend fails, this story will still be saved as BM trace.";

      let backendError = null;

      const backendResult = await callBackend(text);
      if (backendResult.reply) {
        auraText = backendResult.reply;
      } else if (backendResult.error) {
        backendError = backendResult.error;
      }

      renderReaction(metrics, auraText, backendError);
      addTMEntry(text, auraText, metrics, backendError);

      sendButtonEl.disabled = false;
      tmInputEl.focus();
    }

    sendButtonEl.addEventListener("click", handleSend);
    tmInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // =============================
    //  VOICE TOGGLE (UI ONLY)
    // =============================
    const voiceToggleEl = document.getElementById("voiceToggle");
    const voiceToggleCheckEl = document.getElementById("voiceToggleCheck");

    voiceToggleEl.addEventListener("click", () => {
      voiceEnabled = !voiceEnabled;
      voiceToggleCheckEl.textContent = voiceEnabled ? "‚úÖ" : "‚¨ú";
    });

    // =============================
    //  BM VIEWER MODAL
    // =============================
    const bmModalBackdrop = document.getElementById("bmModalBackdrop");
    const bmModalBody = document.getElementById("bmModalBody");
    const bmModalClose = document.getElementById("bmModalClose");
    const bmSearch = document.getElementById("bmSearch");

    function openBmModal() {
      renderBmModal();
      bmModalBackdrop.classList.add("show");
      bmSearch.value = "";
    }

    function closeBmModal() {
      bmModalBackdrop.classList.remove("show");
    }

    function renderBmModal() {
      const query = bmSearch.value.trim().toLowerCase();
      bmModalBody.innerHTML = "";

      bmLayers.forEach(layer => {
        const filtered = query
          ? layer.memories.filter(m =>
              m.text.toLowerCase().includes(query) ||
              (m.polarity || "").toLowerCase().includes(query) ||
              (layer.name || "").toLowerCase().includes(query)
            )
          : layer.memories;

        if (filtered.length === 0) return;

        const layerDiv = document.createElement("div");
        layerDiv.className = "bm-layer";

        const header = document.createElement("div");
        header.className = "bm-layer-header";
        header.innerHTML = `<span>${layer.name}</span><span>${filtered.length} memories</span>`;
        layerDiv.appendChild(header);

        filtered
          .slice()
          .reverse()
          .forEach(mem => {
            const item = document.createElement("div");
            item.className = "bm-item";
            item.textContent = mem.text;

            const meta = document.createElement("div");
            meta.className = "bm-meta";
            const time = new Date(mem.createdAt).toLocaleString();
            meta.innerHTML =
              `<span>${mem.polarity || "Unknown"} ¬∑ ${mem.intensity || "n/a"}</span>` +
              `<button class="bm-copy-btn" data-text="${encodeURIComponent(mem.text)}">Copy</button>` +
              `<span>${time}</span>`;

            item.appendChild(meta);
            layerDiv.appendChild(item);
          });

        bmModalBody.appendChild(layerDiv);
      });

      if (!bmModalBody.childElementCount) {
        const empty = document.createElement("div");
        empty.textContent = "No BM saved yet. Longer / deeper messages will automatically appear here.";
        empty.style.fontSize = "12px";
        empty.style.color = "#6b7280";
        bmModalBody.appendChild(empty);
      }

      // Attach copy handlers
      bmModalBody.querySelectorAll(".bm-copy-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const txt = decodeURIComponent(e.target.dataset.text || "");
          navigator.clipboard.writeText(txt).catch(console.error);
          e.target.textContent = "Copied!";
          setTimeout(() => (e.target.textContent = "Copy"), 1000);
        });
      });
    }

    bmModalClose.addEventListener("click", closeBmModal);
    bmModalBackdrop.addEventListener("click", (e) => {
      if (e.target === bmModalBackdrop) closeBmModal();
    });
    bmSearch.addEventListener("input", renderBmModal);

    // =============================
    //  TOP BUTTON ACTIONS
    // =============================
    document.getElementById("btnBmViewer").addEventListener("click", openBmModal);

    document.getElementById("btnRecallBm").addEventListener("click", () => {
      // take latest BM memory (any layer) and load into input
      let latest = null;
      bmLayers.forEach(layer => {
        layer.memories.forEach(mem => {
          if (!latest || mem.createdAt > latest.createdAt) latest = mem;
        });
      });

      if (!latest) {
        alert("No BM saved yet. Send a slightly longer / deeper message first.");
        return;
      }

      tmInputEl.value = latest.text;
      tmInputEl.focus();
    });

    document.getElementById("btnRecycle").addEventListener("click", () => {
      if (!tmLog.length) {
        alert("No TM history yet to recycle.");
        return;
      }
      const cutoff = Date.now() - 48 * 60 * 60 * 1000;
      const recent = tmLog.filter(e => new Date(e.timestamp).getTime() >= cutoff);
      const selected = recent.length ? recent : tmLog.slice(-6);

      const prompt = selected
        .map(e => `User: ${e.userText}\nAURA-X Œ©: ${e.auraText}`)
        .join("\n\n---\n\n");

      navigator.clipboard.writeText(prompt).catch(console.error);
      alert("Last 48h emotional continuity copied to clipboard as a prompt.");
    });

    document.getElementById("btnOptions").addEventListener("click", () => {
      alert("Future options: export JSON, clear TM/BM, change faith lens, etc. (UI placeholder).");
    });

    // =============================
    //  INIT
    // =============================
    initState();
    setStatusIdle();
  </script>
</body>
</html>
