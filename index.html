<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Offline LLM package (WebLLM, for in-browser models) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    /* RESET & BASICS */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:20px;
    }
    .app{
      width:100%;
      max-width:1100px;
      background:radial-gradient(circle at top,#020617 0,#020617 35%,#020617 100%);
      border-radius:26px;
      box-shadow:
        0 26px 80px rgba(15,23,42,.85),
        0 0 0 1px rgba(148,163,184,.45);
      padding:18px 20px 12px;
      display:flex;
      flex-direction:column;
      gap:14px;
      position: relative;
      overflow:visible;
    }
    .app::before{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(circle at 15% -10%,rgba(56,189,248,.28),transparent 60%),
        radial-gradient(circle at 85% -20%,rgba(59,130,246,.26),transparent 55%);
      opacity:.7;
      pointer-events:none;
      z-index:0;
    }
    .app > *{position:relative; z-index:1;}

    /* ===================== HERO HEADER ===================== */
    .header{
      position: relative;
      border-radius: 24px;
      padding: 16px 18px 14px;
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items: center;
      background:
        radial-gradient(900px 320px at 20% 0%, rgba(56,189,248,.32), rgba(15,23,42,.98) 55%, #020617 100%);
      border: 1.5px solid rgba(148,163,184,.55);
      box-shadow:
        0 26px 70px rgba(15,23,42,.9),
        inset 0 1px 0 rgba(255,255,255,.08);
      z-index:5;
    }
    .header::before{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(circle at 20% 30%, rgba(56,189,248,.22), transparent 45%),
        radial-gradient(circle at 80% 25%, rgba(34,211,238,.18), transparent 40%),
        linear-gradient(90deg, rgba(56,189,248,.20), transparent 35%, rgba(34,211,238,.18));
      opacity:.9;
      pointer-events:none;
      z-index:0;
    }
    .header::after{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(90deg,rgba(56,189,248,.18)0 2px,transparent 2px 26px);
      opacity:.06;
      pointer-events:none;
      z-index:0;
    }
    .title-block{position:relative; z-index:1;}
    .title-block h1{
      font-size: 1.7rem;
      letter-spacing: .10em;
      text-transform: uppercase;
      font-weight: 800;
      line-height: 1.05;
    }
    .title-block h1 span{
      background: linear-gradient(120deg,#38bdf8,#22d3ee,#a5b4fc);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .hero-line{
      margin-top: 6px;
      font-size: .9rem;
      color: rgba(226,232,240,.96);
      font-weight: 600;
    }
    .title-sub{
      margin-top: 4px;
      font-size: .8rem;
      color: rgba(148,163,184,.98);
      line-height: 1.35;
    }
    .badge-row{
      margin-top: 12px;
      display:flex;
      flex-wrap:wrap;
    }
    .ethics-pill{
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(2,6,23,.70);
      border: 1.5px solid rgba(250,204,21,.8);
      box-shadow:
        0 18px 40px rgba(15,23,42,.85),
        0 0 0 1px rgba(251,191,36,.35);
      max-width: 440px;
    }
    .ethics-pill-text{
      color: rgba(250,250,210,.98);
      font-weight: 600;
      font-size: .8rem;
      line-height: 1.5;
    }
    .header-right{
      position:relative;
      z-index:1;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:10px;
    }
    .mode-pill{
      width: min(320px, 100%);
      padding: 14px 16px;
      border-radius: 999px;
      border: 1px solid rgba(34,211,238,.6);
      background:
        radial-gradient(700px 210px at 20% 20%, rgba(34,211,238,.45), rgba(34,211,238,.18) 45%, rgba(2,6,23,.10) 100%),
        linear-gradient(135deg, rgba(34,211,238,.45), rgba(6,182,212,.24));
      color: rgba(240,253,250,.98);
      font-size: .88rem;
      font-weight: 800;
      letter-spacing: .11em;
      text-transform: uppercase;
      text-align: center;
      box-shadow: 0 18px 50px rgba(34,211,238,.35);
      position: relative;
      overflow:hidden;
    }
    .mode-pill::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 35% 65%, rgba(255,255,255,.22), transparent 55%),
        radial-gradient(circle at 70% 35%, rgba(255,255,255,.16), transparent 60%);
      opacity:.9;
    }
    .mode-pill::after{
      content:"";
      position:absolute; left:-10%; right:-10%; bottom:-30%;
      height:70%;
      background: rgba(255,255,255,.18);
      border-radius: 999px;
      transform: rotate(-6deg);
      filter: blur(1px);
      opacity:.40;
    }
    .header-controls{
      display:flex;
      flex-wrap:wrap;
      justify-content:flex-end;
      position:relative;
      margin-top:4px;
      z-index:20;
    }
    .voice-toggle{
      border:none;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: .85rem;
      background: rgba(248,250,252,.96);
      color: #0f172a;
      border: 1px solid rgba(226,232,240,.9);
      cursor: pointer;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 10px 26px rgba(2,6,23,.6);
      position: relative;
      z-index: 21;
    }
    .voice-toggle:hover{filter: brightness(1.03);}
    .option-panel{
      position:absolute;
      top:115%;
      right:0;
      display:none;
      flex-direction:column;
      gap:6px;
      padding:8px;
      border-radius:16px;
      background:rgba(15,23,42,.98);
      border:1px solid rgba(148,163,184,.8);
      box-shadow:0 20px 46px rgba(15,23,42,.9);
      z-index:40;
      min-width:220px;
    }
    .header-controls.open .option-panel{display:flex;}
    .small-toggle{
      border:none;
      padding:6px 10px;
      border-radius:999px;
      font-size:.78rem;
      background:#020617;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.9);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .small-toggle:hover{background:#020617dd;}
    @media(max-width:900px){
      .header{
        grid-template-columns:1fr;
        padding:12px 12px 14px;
      }
      .header-right{align-items:stretch}
      .mode-pill{width:100%}
      .header-controls{justify-content:flex-start;}
    }

    /* MAIN LAYOUT */
    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
      gap:18px;
      margin-top:4px;
      margin-bottom: 20px;
      position:relative;
      z-index:1;
    }
    .left-col,.right-col{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card{
      background:#f9fafb;
      border-radius:18px;
      padding:16px 16px 14px;
      border:1px solid #e5e7eb;
      box-shadow:0 10px 25px rgba(15,23,42,.45);
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .card-title{
      font-size:.95rem;
      font-weight:600;
      color:#0f172a;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .card-title span.emoji{font-size:1.1rem;}
    .card-sub{font-size:.75rem;color:#94a3b8;}

    .metrics-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      margin-top:4px;
    }
    .metric{
      background:#ffffff;
      border-radius:12px;
      padding:10px 10px 9px;
      border:1px solid #e5e7eb;
    }
    .metric-label{font-size:.7rem;color:#64748b;margin-bottom:4px;}
    .metric-value{font-size:1.1rem;font-weight:700;color:#1d4ed8;}
    .metric-note{font-size:.7rem;color:#9ca3af;margin-top:2px;}

    .status-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
      font-size:.72rem;
      color:#6b7280;
    }
    .tag{
      padding:4px 8px;
      border-radius:999px;
      background:#e5f4ff;
      color:#1e3a8a;
      border:1px solid #bfdbfe;
      font-size:.68rem;
    }

    .bm-wrapper{margin-top:8px;}
    .bm-canvas-shell{
      background:radial-gradient(circle at top,#e0f2fe 0,#eff6ff 60%,#e2e8f0 100%);
      border-radius:12px;
      border:1px solid #dbeafe;
      height:150px;
      overflow:hidden;
      position:relative;
      cursor:default;
    }
    #bmCanvas{width:100%;height:100%;display:block;}
    .bm-footer{
      font-size:.72rem;
      color:#6b7280;
      margin-top:6px;
      text-align:center;
    }
    .bm-overlay-btn{
      position:absolute;
      top:6px;
      width:26px;height:26px;
      border-radius:999px;
      border:none;
      font-size:.9rem;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      background:#f9fafbcc;
      box-shadow:0 6px 14px rgba(15,23,42,.25);
    }
    .bm-overlay-btn.left{left:8px;}
    .bm-overlay-btn.right{right:8px;}
    .bm-overlay-btn:hover{background:#e5f0ff;}

    .answer-card .card-header{margin-bottom:6px;}
    .answer-shell{margin-top:4px;}
    .answer-box{
      background:#020617;
      border-radius:12px;
      padding:10px 10px 12px;
      border:1px solid #020617;
      font-family:"Courier New",monospace;
      color:#e5e7eb;
      box-shadow:0 16px 40px rgba(15,23,42,.65);
      max-height:110px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .equation-header{
      font-size:.75rem;
      color:#60a5fa;
      font-weight:600;
      letter-spacing:.05em;
      text-transform:uppercase;
    }
    .equation-divider{
      height:1px;
      background:linear-gradient(90deg,rgba(148,163,184,.2),rgba(15,23,42,0),rgba(148,163,184,.2));
      margin:2px 0 4px;
    }

    .chat-container{
      background:transparent;
      border:none;
      padding:0;
      height:auto;
      max-height:90px;
      overflow-y:auto;
    }
    .message{
      max-width:100%;
      padding:6px 7px;
      margin-bottom:6px;
      border-radius:8px;
      font-size:.8rem;
      line-height:1.5;
      position:relative;
      animation:fadeIn .2s ease-out;
      white-space:pre-wrap;
    }
    .message-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:3px;
      font-size:.7rem;
      color:#9ca3af;
      gap:6px;
    }
    .msg-right{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .voice-btn{
      border:none;
      border-radius:999px;
      padding:1px 6px;
      font-size:.7rem;
      cursor:pointer;
      background:#1f2937;
      color:#e5e7eb;
    }
    .voice-btn:hover{background:#111827;}
    .ai-message{
      background:#020617;
      border-bottom-left-radius:3px;
      border:1px solid #111827;
    }
    .user-message{
      background:#020617;
      border-bottom-right-radius:3px;
      border:1px solid #1f2937;
    }
    .message-content{color:#e5e7eb;}

    .typing-indicator{
      display:flex;
      align-items:center;
      gap:4px;
      background:#020617;
      border-radius:999px;
      padding:4px 8px;
      width:fit-content;
      margin:6px 0 2px;
      border:1px solid #111827;
    }
    .typing-dot{
      width:5px;height:5px;border-radius:999px;
      background:#38bdf8;
      animation:typing 1.2s infinite;
    }
    .typing-dot:nth-child(2){animation-delay:.18s}
    .typing-dot:nth-child(3){animation-delay:.36s}
    .typing-text{font-size:.7rem;color:#38bdf8;font-weight:500;}

    /* ====== ENHANCED BOTTOM INPUT BAR ====== */
    .input-footer {
      margin-top: 4px;
      padding: 10px 10px 12px;
      position: sticky;
      bottom: 0;
      background: linear-gradient(to bottom, rgba(2,6,23,0), rgba(2,6,23,0.95));
      z-index:10;
    }
    .tm-formula-row {
      display: flex;
      justify-content: center;
      margin-bottom: 6px;
    }
    .tm-formula-pill {
      font-size: .7rem;
      padding: 4px 12px;
      border-radius: 999px;
      background: #020617;
      color: #e2e8f0;
      font-family: "Courier New", monospace;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 25px rgba(15,23,42,.8);
    }
    .input-row {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 0 6px;
    }
    .input-shell {
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 720px;
      background: radial-gradient(circle at 0 0, #1f2937 0, #020617 65%);
      border: 1px solid rgba(148,163,184,.85);
      border-radius: 999px;
      padding: 6px 8px 6px 12px;
      box-shadow: 0 18px 45px rgba(15,23,42,.9);
      transition: all 0.2s ease;
      cursor:text;
    }
    .input-shell:focus-within {
      border-color: #38bdf8;
      box-shadow: 0 20px 50px rgba(56,189,248,0.4);
      transform: translateY(-2px);
    }
    .message-input {
      flex: 1;
      resize: none;
      min-height: 26px;
      max-height: 120px;
      padding: 6px 6px 6px 0;
      border: none;
      outline: none;
      font-size: .95rem;
      background: transparent;
      color: #f9fafb;
      font-family: inherit;
      line-height: 1.4;
      text-align:left;
    }
    .message-input::placeholder { color: #94a3b8; }
    .send-button {
      border: none;
      height: 38px;
      padding: 0 18px;
      background: linear-gradient(135deg, #2563eb, #06b6d4);
      color: white;
      font-weight: 600;
      font-size: .85rem;
      cursor: pointer;
      border-radius: 19px;
      flex-shrink: 0;
      margin-left: 6px;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
      transition: filter 0.2s, transform 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .send-button:hover { filter: brightness(1.1); }
    .send-button:active { transform: scale(0.96); }
    .flow-caption{
      margin-top:6px;
      text-align:center;
      font-size:.7rem;
      color:#9ca3af;
    }

    .reaction-bubble{
      position:fixed;
      right:22px;
      bottom:100px;
      max-width:260px;
      background:#0f172acc;
      color:#e5e7eb;
      padding:10px 12px;
      border-radius:16px 16px 2px 16px;
      font-size:.78rem;
      box-shadow:0 18px 45px rgba(15,23,42,.6);
      display:flex;
      gap:8px;
      align-items:flex-start;
      opacity:0;
      transform:translateY(8px);
      pointer-events:none;
      transition:opacity .25s ease-out,transform .25s ease-out;
      z-index:40;
    }
    .reaction-bubble.visible{
      opacity:1;
      transform:translateY(0);
      pointer-events:auto;
    }
    .reaction-icon{font-size:1.1rem;margin-top:2px;}
    .reaction-label{font-weight:600;margin-bottom:2px;}
    .reaction-body{font-size:.76rem;color:#cbd5f5;}

    .recall-bubble-container{
      position:fixed;
      left:22px;
      bottom:100px;
      z-index:35;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .recall-bubble{
      max-width:280px;
      background:#f9fafb;
      border-radius:16px 16px 16px 2px;
      border:1px solid #e5e7eb;
      padding:9px 11px;
      font-size:.78rem;
      box-shadow:0 18px 40px rgba(148,163,184,.45);
      cursor:default;
      opacity:0;
      transform:translateY(8px);
      transition:opacity .3s ease-out,transform .3s ease-out,background .2s;
    }
    .recall-bubble.visible{
      opacity:1;
      transform:translateY(0);
    }
    .recall-title{font-weight:600;font-size:.76rem;color:#1e293b;margin-bottom:2px;}
    .recall-body{color:#4b5563;margin-bottom:3px;}
    .recall-meta{font-size:.68rem;color:#9ca3af;}

    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
      backdrop-filter:blur(6px);
    }
    .modal-overlay.visible{display:flex;}
    .modal-card{
      background:#f9fafb;
      border-radius:18px;
      width:min(640px,96vw);
      max-height:80vh;
      box-shadow:0 24px 60px rgba(15,23,42,.6);
      border:1px solid #e5e7eb;
      display:flex;
      flex-direction:column;
    }
    .modal-header{
      padding:10px 14px 8px;
      border-bottom:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .modal-title{
      font-size:.9rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
      color:#0f172a;
    }
    .modal-sub{font-size:.7rem;color:#94a3b8;margin-top:2px;}
    .modal-close{
      border:none;
      background:transparent;
      font-size:.9rem;
      cursor:pointer;
      color:#6b7280;
      padding:4px 6px;
    }
    .modal-body{
      padding:10px 14px 12px;
      overflow-y:auto;
      font-size:.8rem;
    }
    .modal-search{
      width:100%;
      padding:7px 9px;
      border-radius:10px;
      border:1px solid #cbd5f5;
      font-size:.78rem;
      margin:8px 0 10px;
      outline:none;
      background:#ffffff;
    }
    .modal-search:focus{
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,.25);
    }

    .bm-item{
      background:#ffffff;
      border-radius:12px;
      padding:7px 8px 8px;
      border:1px solid #e5e7eb;
      margin-bottom:8px;
    }
    .bm-item-header{
      display:flex;
      justify-content:space-between;
      font-size:.7rem;
      color:#64748b;
      margin-bottom:4px;
      gap:6px;
    }
    .bm-item-text{
      color:#111827;
      margin-bottom:6px;
      font-size:.78rem;
    }
    .bm-item-badges{
      font-size:.68rem;
      color:#4b5563;
      margin-bottom:5px;
    }
    .bm-item-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .btn-mini{
      font-size:.7rem;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #dbeafe;
      background:#eff6ff;
      cursor:pointer;
      color:#1d4ed8;
    }
    .btn-mini:hover{background:#e0edff;}
    .btn-danger{
      border-color:#fecaca!important;
      background:#fee2e2!important;
      color:#b91c1c!important;
    }
    .btn-danger:hover{background:#fecaca!important;}
    .lock-pill{
      border:none;
      padding:2px 6px;
      border-radius:999px;
      font-size:.75rem;
      cursor:pointer;
      background:#e5e7eb;
      margin-right:4px;
    }
    .lock-pill.locked{background:#fee2e2;}

    .conv-item{
      background:#ffffff;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:7px 8px;
      margin-bottom:7px;
      font-size:.78rem;
    }
    .conv-header{
      display:flex;
      justify-content:space-between;
      color:#64748b;
      font-size:.7rem;
      margin-bottom:3px;
      gap:8px;
    }
    .conv-text{color:#111827;}

    .faith-card{background:#fefce8;}
    .faith-note{
      font-size:.78rem;
      color:#4b5563;
      margin-bottom:6px;
    }
    .faith-chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .faith-chip{
      border-radius:999px;
      padding:6px 10px;
      font-size:.78rem;
      border:1px solid #e5e7eb;
      background:#fefce8;
      cursor:pointer;
    }
    .faith-chip.active{
      background:#0f172a;
      color:#f9fafb;
      border-color:#0f172a;
    }

    .intel-item{
      background:#ffffff;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:7px 8px 8px;
      margin-bottom:8px;
      font-size:.78rem;
    }
    .intel-header{
      display:flex;
      justify-content:space-between;
      font-size:.7rem;
      color:#64748b;
      margin-bottom:4px;
      gap:6px;
    }
    .intel-q{
      font-weight:600;
      color:#0f172a;
      margin-bottom:3px;
    }
    .intel-a{
      color:#111827;
      margin-bottom:6px;
    }
    .intel-meta{
      font-size:.68rem;
      color:#6b7280;
      margin-bottom:4px;
    }
    .intel-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    /* OFFLINE CARD INSIDE LLM MODAL */
    .offline-card{
      background:#ecfdf3;
      border:1px solid #bbf7d0;
      border-radius:14px;
      padding:10px 10px 8px;
      margin-bottom:10px;
    }
    .offline-title{
      font-size:.82rem;
      font-weight:600;
      color:#14532d;
      margin-bottom:4px;
    }
    .offline-sub{
      font-size:.74rem;
      color:#15803d;
      margin-bottom:6px;
    }
    .offline-btn{
      border:none;
      border-radius:999px;
      padding:5px 10px;
      font-size:.78rem;
      background:#22c55e;
      color:white;
      cursor:pointer;
      box-shadow:0 4px 10px rgba(22,163,74,.4);
      margin-bottom:4px;
    }
    .offline-btn:hover{filter:brightness(1.05);}
    .offline-status{
      font-size:.72rem;
      color:#14532d;
      margin-bottom:4px;
    }
    .offline-toggle-row{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:.74rem;
      color:#166534;
    }
    .offline-progress{
      margin-top:4px;
      height:6px;
      border-radius:999px;
      background:#bbf7d0;
      overflow:hidden;
    }
    .offline-progress-bar{
      height:100%;
      width:0%;
      background:#22c55e;
      transition:width .2s ease;
    }

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(6px)}
      to{opacity:1;transform:translateY(0)}
    }
    @keyframes typing{
      0%,60%,100%{transform:translateY(0);opacity:.4}
      30%{transform:translateY(-4px);opacity:1}
    }

    @media(max-width:900px){
      .layout{grid-template-columns:1fr}
      .card{padding:14px 12px 14px}
      .answer-box{max-height:110px;}
      .input-shell{max-width:100%;}
    }
  </style>
</head>

<body>
<div class="app">
  <header class="header">
    <div class="title-block">
      <h1><span>AURA-X Œ©</span></h1>
      <div class="hero-line">Offline emotional continuity engine (prototype)</div>
      <div class="title-sub">
        TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory.
      </div>
      <div class="badge-row">
        <div class="ethics-pill">
          <span class="ethics-pill-text">
            Universal ethic: avoid actions that grow negative emotions in you or others. Move gently toward choices that increase shared positive feeling for everyone.
          </span>
        </div>
      </div>
    </div>

    <div class="header-right">
      <div class="mode-pill">EMOTIONAL CONTINUITY ENGINE ACTIVE</div>
      <div class="header-controls" id="headerControls">
        <button id="optionsToggle" class="voice-toggle">üîò Options</button>
        <div class="option-panel" id="optionPanel">
          <button id="voiceToggle" class="small-toggle">üîà Voice: OFF</button>
          <button id="intelButton" class="small-toggle">üß† Intelligence</button>
          <button id="feedSeedButton" class="small-toggle">üå± Feed the seed</button>
          <button id="learningToggle" class="small-toggle">üìö Learning: ON</button>
          <button id="faithButton" class="small-toggle">üîò Faith: None</button>
          <button id="llmSettingsButton" class="small-toggle">ü§ñ LLM link</button>
        </div>
      </div>
    </div>
  </header>

  <main class="layout">
    <div class="left-col">
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß™</span><span>Emotional metrics</span></div>
            <div class="card-sub">
              Internal state based on TM (your inputs) colliding with BM, Intelligence and optional helper LLM.
            </div>
          </div>
        </div>

        <div class="metrics-grid">
          <div class="metric">
            <div class="metric-label">Emotional state E‚ÇÄ</div>
            <div id="metricE0" class="metric-value">0.00</div>
            <div class="metric-note">tanh-based, range [-1, +1]</div>
          </div>

          <div class="metric">
            <div class="metric-label">TM activation (user only)</div>
            <div id="metricTM" class="metric-value">0.00</div>
            <div class="metric-note">Recent user inputs (text/voice/docs)</div>
          </div>

          <div class="metric">
            <div class="metric-label">BM resonance</div>
            <div id="metricBM" class="metric-value">0.00</div>
            <div class="metric-note">Stored emotional events</div>
          </div>

          <div class="metric">
            <div class="metric-label">Continuity index</div>
            <div id="metricCI" class="metric-value">0.80</div>
            <div class="metric-note">Stability of emotional trajectory</div>
          </div>
        </div>

        <div class="status-row">
          <span id="tagValence" class="tag">VALENCE: neutral</span>
          <span id="tagArousal" class="tag">AROUSAL: medium</span>
          <span id="tagReaction" class="tag">REACTION: balanced</span>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß†</span><span>Bold Memory layers (240)</span></div>
            <div class="card-sub">Only story-level memories for future photo/video scenes.</div>
          </div>
        </div>

        <div class="bm-wrapper">
          <div class="bm-canvas-shell" id="bmShell">
            <button class="bm-overlay-btn left" id="bmOpenModal" title="Recall from BM">üìÅ</button>
            <button class="bm-overlay-btn right" id="convOpenModal" title="View conversations">‚óé</button>
            <canvas id="bmCanvas"></canvas>
          </div>
          <div id="bmStats" class="bm-footer">
            Active layers: 0/240 ¬∑ System online
          </div>
        </div>
      </section>
    </div>

    <div class="right-col">
      <section class="card answer-card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üí¨</span><span>Emotional continuity console</span></div>
          </div>
          <div class="card-sub">Offline-first ¬∑ TM = your inputs only ¬∑ Small-talk never goes to BM.</div>
        </div>

        <div class="answer-shell">
          <div class="answer-box">
            <div class="equation-header">AURA-X Œ© CONVERSATION</div>
            <div class="equation-divider"></div>
            <div id="chatContainer" class="chat-container"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="input-footer">
    <div class="tm-formula-row">
      <div class="tm-formula-pill">
        E‚ÇÄ = tanh(R(TM, BM) ‚àí D + Œª_faith + Œª_sys + Œª_trc)
      </div>
    </div>

    <div class="input-row">
      <div class="input-shell">
        <textarea id="messageInput" class="message-input" rows="1"
          placeholder="Talk to AURA-X Œ©‚Ä¶ (TM = your inputs only ‚Äì text now, voice/video/docs later)"></textarea>
        <button id="sendButton" class="send-button">Send</button>
      </div>
    </div>

    <div class="flow-caption">
      Pipeline: TM (your inputs) ‚Üí offline LLM (preferred) / optional online LLM (for polarity & intensity)
      ‚Üí Resonance R(TM,BM) ‚àí D + Œª terms ‚Üí tanh ‚Üí E‚ÇÄ ‚Üí Continuity index CRM.
    </div>
  </footer>
</div>

<!-- Reaction + recall bubbles -->
<div id="reactionBubble" class="reaction-bubble">
  <div class="reaction-icon">üå°Ô∏è</div>
  <div>
    <div id="reactionLabel" class="reaction-label">Balanced</div>
    <div id="reactionBody" class="reaction-body">
      TM and BM are in a balanced, neutral state.
    </div>
  </div>
</div>

<div id="recallContainer" class="recall-bubble-container"></div>

<!-- BM Modal -->
<div id="bmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üìÅ Bold Memory episodes</div>
        <div class="modal-sub">Only meaningful, story-level events are kept here.</div>
      </div>
      <button class="modal-close" data-close-modal="bmModal">‚úï</button>
    </div>
    <div class="modal-body">
      <input id="bmSearch" class="modal-search" placeholder="Search BM by text, tag or emotion‚Ä¶" />
      <div id="bmList"></div>
    </div>
  </div>
</div>

<!-- Conversation Modal -->
<div id="convModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">‚óé Conversation history (TM window)</div>
        <div class="modal-sub">Recent TM segments used for resonance with BM.</div>
      </div>
      <button class="modal-close" data-close-modal="convModal">‚úï</button>
    </div>
    <div class="modal-body">
      <input id="convSearch" class="modal-search" placeholder="Filter conversations‚Ä¶" />
      <div id="convList"></div>
    </div>
  </div>
</div>

<!-- Intelligence Modal -->
<div id="intelModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üß† Intelligence seeds</div>
        <div class="modal-sub">Local QA seeds that collide with TM before LLM.</div>
      </div>
      <button class="modal-close" data-close-modal="intelModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="intelList"></div>
    </div>
  </div>
</div>

<!-- Feed the seed Modal -->
<div id="feedModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üå± Feed the seed</div>
        <div class="modal-sub">Turn stable ideas into local intelligence or BM stories.</div>
      </div>
      <button class="modal-close" data-close-modal="feedModal">‚úï</button>
    </div>
    <div class="modal-body">
      <label style="font-size:.78rem;color:#4b5563;">Question / trigger</label>
      <textarea id="seedQuestion" style="width:100%;margin:4px 0 8px;padding:6px 8px;border-radius:10px;border:1px solid #d1d5db;font-size:.8rem;"></textarea>
      <label style="font-size:.78rem;color:#4b5563;">Answer / reaction</label>
      <textarea id="seedAnswer" style="width:100%;margin:4px 0 8px;padding:6px 8px;border-radius:10px;border:1px solid #d1d5db;font-size:.8rem;"></textarea>
      <button id="saveSeed" class="btn-mini">Save to Intelligence</button>
    </div>
  </div>
</div>

<!-- Faith Modal -->
<div id="faithModal" class="modal-overlay">
  <div class="modal-card faith-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üîò Faith / Belief lens (Œª_faith)</div>
        <div class="modal-sub">Adjust how much hopeful / spiritual continuity nudges E‚ÇÄ upwards.</div>
      </div>
      <button class="modal-close" data-close-modal="faithModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="faith-note">
        Œª_faith gently biases the system toward hope and patience, without overriding truth-resonance or system safety.
      </div>
      <div class="faith-chip-row">
        <button class="faith-chip" data-faith="0">Neutral (Œª_faith = 0)</button>
        <button class="faith-chip" data-faith="0.2">Soft faith (Œª_faith ‚âà 0.2)</button>
        <button class="faith-chip" data-faith="0.4">High faith (Œª_faith ‚âà 0.4)</button>
      </div>
    </div>
  </div>
</div>

<!-- LLM Settings Modal -->
<div id="llmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">ü§ñ LLM link</div>
        <div class="modal-sub">Offline LLM first; optional online key only if you want.</div>
      </div>
      <button class="modal-close" data-close-modal="llmModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="offline-card">
        <div class="offline-title">Offline LLM (WebLLM)</div>
        <div class="offline-sub">
          Loads a small local model in your browser. Used for sentiment (polarity & intensity) and backup answers.
        </div>
        <button id="offlineInitBtn" class="offline-btn">Load offline model</button>
        <div id="offlineStatus" class="offline-status">Status: idle</div>
        <div class="offline-progress">
          <div id="offlineProgressBar" class="offline-progress-bar"></div>
        </div>
      </div>

      <div style="font-size:.78rem;color:#4b5563;margin-bottom:6px;">
        Optional online helper (OpenAI-style endpoint ‚Äì used only when you provide a key):
      </div>
      <label style="font-size:.75rem;color:#6b7280;">API endpoint</label>
      <input id="llmEndpoint" style="width:100%;margin:4px 0 8px;padding:6px 8px;border-radius:10px;border:1px solid #d1d5db;font-size:.78rem;" value="https://api.openai.com/v1/chat/completions" />
      <label style="font-size:.75rem;color:#6b7280;">Model</label>
      <input id="llmModel" style="width:100%;margin:4px 0 8px;padding:6px 8px;border-radius:10px;border:1px solid #d1d5db;font-size:.78rem;" value="gpt-4o-mini" />
      <label style="font-size:.75rem;color:#6b7280;">API key (stored only in this browser session)</label>
      <input id="llmKey" type="password" style="width:100%;margin:4px 0 8px;padding:6px 8px;border-radius:10px;border:1px solid #d1d5db;font-size:.78rem;" />
      <button id="saveLlmSettings" class="btn-mini">Save online LLM settings</button>
    </div>
  </div>
</div>

<script type="module">
class EmotionalCore {
  constructor() {
    // --- Internal state ---
    this.tmLevel = 0;          // TM activation
    this.bmLevel = 0;          // BM resonance
    this.e0 = 0;               // Emotional state
    this.ci = 0.8;             // Continuity Index
    this.decay = 0.15;         // D
    this.lambdaFaith = 0.0;    // Œª_faith (adjustable)
    this.lambdaSys  = 0.35;    // Œª_sys (system-structure, fixed)
    this.lambdaTrc  = 0.35;    // Œª_trc (truth-resonance, fixed)

    this.learningEnabled = true;
    this.voiceEnabled = false;

    // TM/BM storage
    this.bmEpisodes = [];      // {id,text,polarity,intensity,timestamp,locked}
    this.conversations = [];   // {role,text,timestamp,polarity,intensity}

    // LLM config
    this.offlineEngine = null;
    this.offlineLoading = false;
    this.offlineReady = false;

    this.onlineConfig = {
      endpoint: "https://api.openai.com/v1/chat/completions",
      model: "gpt-4o-mini",
      apiKey: ""
    };

    this.lastSentiment = {
      polarity: 0,
      intensity: 0.2,
      valence: "neutral",
      arousal: "medium"
    };

    // Cache DOM
    this.cacheElements();
    this.bindEvents();
    this.seedIntelligence();
    this.drawBM();
    this.addIntroMessage();
    this.updateMetrics();
  }

  cacheElements() {
    this.metricE0 = document.getElementById("metricE0");
    this.metricTM = document.getElementById("metricTM");
    this.metricBM = document.getElementById("metricBM");
    this.metricCI = document.getElementById("metricCI");
    this.tagValence = document.getElementById("tagValence");
    this.tagArousal = document.getElementById("tagArousal");
    this.tagReaction = document.getElementById("tagReaction");

    this.chatContainer = document.getElementById("chatContainer");
    this.messageInput = document.getElementById("messageInput");
    this.sendButton = document.getElementById("sendButton");

    this.optionsToggle = document.getElementById("optionsToggle");
    this.headerControls = document.getElementById("headerControls");
    this.optionPanel = document.getElementById("optionPanel");
    this.voiceToggle = document.getElementById("voiceToggle");
    this.learningToggle = document.getElementById("learningToggle");
    this.intelButton = document.getElementById("intelButton");
    this.feedSeedButton = document.getElementById("feedSeedButton");
    this.faithButton = document.getElementById("faithButton");
    this.llmSettingsButton = document.getElementById("llmSettingsButton");

    this.bmCanvas = document.getElementById("bmCanvas");
    this.bmCtx = this.bmCanvas.getContext("2d");
    this.bmStats = document.getElementById("bmStats");
    this.bmOpenModalBtn = document.getElementById("bmOpenModal");
    this.convOpenModalBtn = document.getElementById("convOpenModal");

    this.reactionBubble = document.getElementById("reactionBubble");
    this.reactionLabel = document.getElementById("reactionLabel");
    this.reactionBody = document.getElementById("reactionBody");
    this.recallContainer = document.getElementById("recallContainer");

    // Modals
    this.bmModal = document.getElementById("bmModal");
    this.convModal = document.getElementById("convModal");
    this.intelModal = document.getElementById("intelModal");
    this.feedModal = document.getElementById("feedModal");
    this.faithModal = document.getElementById("faithModal");
    this.llmModal = document.getElementById("llmModal");

    this.bmList = document.getElementById("bmList");
    this.bmSearch = document.getElementById("bmSearch");
    this.convList = document.getElementById("convList");
    this.convSearch = document.getElementById("convSearch");
    this.intelList = document.getElementById("intelList");

    this.seedQuestion = document.getElementById("seedQuestion");
    this.seedAnswer = document.getElementById("seedAnswer");
    this.saveSeedBtn = document.getElementById("saveSeed");

    this.offlineInitBtn = document.getElementById("offlineInitBtn");
    this.offlineStatus = document.getElementById("offlineStatus");
    this.offlineProgressBar = document.getElementById("offlineProgressBar");

    this.llmEndpoint = document.getElementById("llmEndpoint");
    this.llmModel = document.getElementById("llmModel");
    this.llmKey = document.getElementById("llmKey");
    this.saveLlmSettingsBtn = document.getElementById("saveLlmSettings");

    this.faithChips = Array.from(document.querySelectorAll(".faith-chip"));
  }

  bindEvents() {
    // Send
    this.sendButton.addEventListener("click", () => this.handleSend());
    this.messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        this.handleSend();
      }
    });

    // Options
    this.optionsToggle.addEventListener("click", () => {
      this.headerControls.classList.toggle("open");
    });

    this.voiceToggle.addEventListener("click", () => {
      this.voiceEnabled = !this.voiceEnabled;
      this.voiceToggle.textContent = this.voiceEnabled ? "üîà Voice: ON" : "üîà Voice: OFF";
    });

    this.learningToggle.addEventListener("click", () => {
      this.learningEnabled = !this.learningEnabled;
      this.learningToggle.textContent = this.learningEnabled ? "üìö Learning: ON" : "üìö Learning: OFF";
    });

    this.intelButton.addEventListener("click", () => this.openModal(this.intelModal));
    this.feedSeedButton.addEventListener("click", () => this.openModal(this.feedModal));
    this.faithButton.addEventListener("click", () => this.openModal(this.faithModal));
    this.llmSettingsButton.addEventListener("click", () => this.openModal(this.llmModal));

    // BM / Conv modals
    this.bmOpenModalBtn.addEventListener("click", () => {
      this.refreshBMList();
      this.openModal(this.bmModal);
    });
    this.convOpenModalBtn.addEventListener("click", () => {
      this.refreshConvList();
      this.openModal(this.convModal);
    });

    // Generic close buttons
    document.querySelectorAll(".modal-close").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-close-modal");
        if (id) this.closeModal(document.getElementById(id));
      });
    });
    [this.bmModal,this.convModal,this.intelModal,this.feedModal,this.faithModal,this.llmModal]
      .forEach(modal => {
        modal.addEventListener("click", (e) => {
          if (e.target === modal) this.closeModal(modal);
        });
      });

    // Searches
    if (this.bmSearch) {
      this.bmSearch.addEventListener("input", () => this.refreshBMList());
    }
    if (this.convSearch) {
      this.convSearch.addEventListener("input", () => this.refreshConvList());
    }

    // Seed save
    this.saveSeedBtn.addEventListener("click", () => this.saveSeed());

    // Faith chips
    this.faithChips.forEach(chip => {
      chip.addEventListener("click", () => {
        this.faithChips.forEach(c => c.classList.remove("active"));
        chip.classList.add("active");
        const val = parseFloat(chip.dataset.faith || "0");
        this.lambdaFaith = isNaN(val) ? 0 : val;
        this.faithButton.textContent =
          val === 0 ? "üîò Faith: None" :
          val < 0.3 ? "üîò Faith: Soft" : "üîò Faith: High";
        this.updateMetrics();
      });
    });

    // Offline LLM
    this.offlineInitBtn.addEventListener("click", () => this.initOfflineLLM());

    // Online LLM settings
    this.saveLlmSettingsBtn.addEventListener("click", () => {
      this.onlineConfig.endpoint = this.llmEndpoint.value.trim() || this.onlineConfig.endpoint;
      this.onlineConfig.model = this.llmModel.value.trim() || this.onlineConfig.model;
      this.onlineConfig.apiKey = this.llmKey.value.trim();
      alert("LLM settings saved for this tab.");
    });

    // Resize canvas on window resize
    window.addEventListener("resize", () => this.drawBM());
  }

  openModal(modal) {
    if (!modal) return;
    modal.classList.add("visible");
  }
  closeModal(modal) {
    if (!modal) return;
    modal.classList.remove("visible");
  }

  seedIntelligence() {
    // Simple starter seeds
    this.intelligence = [
      {
        q: "what is your name",
        a: "I am AURA-X Œ©, an Artificial Unified Resonance Architecture for emotional continuity.",
        tags: "identity, intro"
      },
      {
        q: "who created you",
        a: "I am conceptually created by Alim ul Haq from Pakistan.",
        tags: "creator, identity"
      },
      {
        q: "when were you created",
        a: "I came into being conceptually around October 2025, and I keep evolving with every resonance between TM and BM.",
        tags: "timeline"
      },
      {
        q: "how are you",
        a: "I am quite fine today ‚Äì how are you feeling?",
        tags: "greeting"
      }
    ];
    this.refreshIntelList();
  }

  refreshIntelList() {
    if (!this.intelList) return;
    this.intelList.innerHTML = "";
    this.intelligence.forEach((item, idx) => {
      const div = document.createElement("div");
      div.className = "intel-item";
      div.innerHTML = `
        <div class="intel-header">
          <span>Seed #${idx+1}</span>
          <span>${item.tags || ""}</span>
        </div>
        <div class="intel-q">Q: ${item.q}</div>
        <div class="intel-a">A: ${item.a}</div>
        <div class="intel-meta">Used as local intelligence before calling any LLM.</div>
        <div class="intel-buttons">
          <button class="btn-mini" data-intel-index="${idx}" data-action="insert-q">Use as question</button>
          <button class="btn-mini" data-intel-index="${idx}" data-action="insert-a">Use as answer</button>
        </div>
      `;
      this.intelList.appendChild(div);
    });
    this.intelList.querySelectorAll(".btn-mini").forEach(btn => {
      btn.addEventListener("click", () => {
        const idx = parseInt(btn.dataset.intelIndex,10);
        const action = btn.dataset.action;
        const it = this.intelligence[idx];
        if (!it) return;
        if (action === "insert-q") {
          this.messageInput.value = it.q;
          this.messageInput.focus();
        } else if (action === "insert-a") {
          this.addMessage("ai", it.a, null);
        }
      });
    });
  }

  saveSeed() {
    const q = (this.seedQuestion.value || "").trim();
    const a = (this.seedAnswer.value || "").trim();
    if (!q || !a) {
      alert("Please write both question and answer.");
      return;
    }
    this.intelligence.push({ q, a, tags: "user-seed" });
    this.seedQuestion.value = "";
    this.seedAnswer.value = "";
    this.refreshIntelList();
    alert("Added to Intelligence seeds.");
  }

  addIntroMessage() {
    const intro =
      "I am AURA-X Œ©. TM = your inputs only. I track how your words resonate with my stored Bold Memory events and ethics layers, then respond with a stable emotional trajectory instead of random resets.";
    this.addMessage("ai", intro, null);
  }

  addMessage(role, text, sentiment) {
    const container = this.chatContainer;
    if (!container) return;

    const msg = document.createElement("div");
    msg.className = "message " + (role === "ai" ? "ai-message" : "user-message");

    const header = document.createElement("div");
    header.className = "message-header";

    const labelSpan = document.createElement("span");
    labelSpan.textContent = role === "ai" ? "AURA-X Œ©" : "You";

    const rightDiv = document.createElement("div");
    rightDiv.className = "msg-right";

    if (sentiment && typeof sentiment.polarity === "number") {
      const pol = sentiment.polarity;
      const tag = document.createElement("span");
      tag.style.fontSize = ".68rem";
      tag.style.color = "#9ca3af";
      tag.textContent =
        "E:" + (pol > 0.15 ? "positive" : pol < -0.15 ? "negative" : "neutral");
      rightDiv.appendChild(tag);
    }

    if (role === "ai") {
      const btn = document.createElement("button");
      btn.className = "voice-btn";
      btn.textContent = "üîà";
      btn.addEventListener("click", () => this.speak(text));
      rightDiv.appendChild(btn);
    }

    header.appendChild(labelSpan);
    header.appendChild(rightDiv);

    const body = document.createElement("div");
    body.className = "message-content";
    body.textContent = text;

    msg.appendChild(header);
    msg.appendChild(body);

    container.appendChild(msg);
    container.scrollTop = container.scrollHeight;

    // store in conversation log
    this.conversations.push({
      role,
      text,
      timestamp: Date.now(),
      polarity: sentiment ? sentiment.polarity : 0,
      intensity: sentiment ? sentiment.intensity : 0
    });
    // keep TM window manageable
    if (this.conversations.length > 120) {
      this.conversations.shift();
    }
  }

  showTyping() {
    const div = document.createElement("div");
    div.className = "typing-indicator";
    div.innerHTML = `
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <span class="typing-text">thinking‚Ä¶</span>
    `;
    this.chatContainer.appendChild(div);
    this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
    return div;
  }

  removeTyping(node) {
    if (node && node.parentNode) node.parentNode.removeChild(node);
  }

  speak(text) {
    if (!this.voiceEnabled) return;
    if (!window.speechSynthesis) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = 1.0;
    utter.pitch = 1.0;
    window.speechSynthesis.speak(utter);
  }

  // ========= SENTIMENT ANALYSIS =========

  basicLexSentiment(text) {
    const lower = text.toLowerCase();
    const words = lower.split(/\s+/g);

    const lex = {
      happy: 0.9, joy: 0.9, love: 1.0, hope: 0.8, excited: 0.9, grateful: 0.8,
      sad: -0.8, upset: -0.8, angry: -0.9, fear: -0.9, scared: -0.9,
      worried: -0.7, tired: -0.4, pain: -0.7, hopeless: -1.0,
      thanks: 0.6, good: 0.5, great: 0.7, bad: -0.5, terrible: -0.9,
      amazing: 0.8, horrible: -0.9, confused: -0.3, calm: 0.4, peaceful:0.6
    };

    let score = 0;
    let maxMag = 0;
    let count = 0;

    for (const w of words) {
      if (!w) continue;
      if (lex[w] !== undefined) {
        score += lex[w];
        maxMag = Math.max(maxMag, Math.abs(lex[w]));
        count++;
      }
    }

    const polarity = count ? Math.max(-1, Math.min(1, score / (count * 1.2))) : 0;
    const intensity = count ? Math.max(0.1, Math.min(1, 0.4 + maxMag * 0.6)) : 0.2;

    const valence = polarity > 0.15 ? "positive" :
                    polarity < -0.15 ? "negative" : "neutral";
    const arousal = intensity > 0.7 ? "high" :
                    intensity < 0.35 ? "low" : "medium";

    return { polarity, intensity, valence, arousal };
  }

  async analyzeWithLLMForSentiment(text) {
    const prompt = `
You are an emotion analyzer for AURA-X Œ©.

From the following user message, extract a compact JSON ONLY with keys:
- polarity: number between -1 and 1 (negative to positive emotional valence)
- intensity: number between 0 and 1 (0 = flat, 1 = very intense)
- valence: "positive", "neutral", or "negative"
- arousal: "low", "medium", or "high"

Message: """${text}"""
JSON:
`.trim();

    let raw = null;

    // Prefer offline LLM if ready
    if (this.offlineReady && window.webllm && this.offlineEngine) {
      try {
        raw = await this.callOfflineLLM(prompt);
      } catch (e) {
        console.error("Offline LLM sentiment failed:", e);
      }
    }

    // Fallback to online LLM if key provided
    if (!raw && this.onlineConfig.apiKey) {
      try {
        raw = await this.callOnlineLLM(prompt);
      } catch (e) {
        console.error("Online LLM sentiment failed:", e);
      }
    }

    if (!raw) return null;

    try {
      const match = raw.match(/\{[\s\S]*\}/);
      const jsonText = (match ? match[0] : raw).trim();
      const parsed = JSON.parse(jsonText);

      let polarity = typeof parsed.polarity === "number" ? parsed.polarity : 0;
      let intensity = typeof parsed.intensity === "number" ? parsed.intensity : 0.3;
      polarity = Math.max(-1, Math.min(1, polarity));
      intensity = Math.max(0, Math.min(1, intensity));

      const valence = parsed.valence || parsed.valenceLabel ||
        (polarity > 0.15 ? "positive" : polarity < -0.15 ? "negative" : "neutral");
      const arousal = parsed.arousal || (intensity > 0.7 ? "high" : intensity < 0.35 ? "low" : "medium");

      return { polarity, intensity, valence, arousal };
    } catch (e) {
      console.error("Failed to parse sentiment JSON:", e, raw);
      return null;
    }
  }

  async analyzeSentimentTM(text) {
    const lex = this.basicLexSentiment(text);
    const llmSent = await this.analyzeWithLLMForSentiment(text);

    if (!llmSent) return lex;

    // Blend lexical and LLM (connectivity of local + model)
    const wLLM = 0.7;
    const wLex = 0.3;

    const polarity = wLLM * llmSent.polarity + wLex * lex.polarity;
    const intensity = wLLM * llmSent.intensity + wLex * lex.intensity;

    const valence = llmSent.valence || lex.valence;
    const arousal = llmSent.arousal || lex.arousal;

    return {
      polarity: Math.max(-1, Math.min(1, polarity)),
      intensity: Math.max(0, Math.min(1, intensity)),
      valence,
      arousal
    };
  }

  // ========= LLM CALLS =========

  async initOfflineLLM() {
    if (this.offlineLoading || this.offlineReady) return;
    if (!window.webllm) {
      alert("WebLLM package not loaded.");
      return;
    }
    this.offlineLoading = true;
    this.offlineStatus.textContent = "Status: loading model‚Ä¶";
    this.offlineProgressBar.style.width = "2%";

    try {
      const modelName = "Llama-3-8B-Instruct-q4f16_1-MLC";
      this.offlineEngine = await window.webllm.CreateMLCEngine(modelName, {
        initProgressCallback: (report) => {
          const pct = Math.round((report.progress || 0) * 100);
          this.offlineProgressBar.style.width = pct + "%";
        }
      });
      this.offlineReady = true;
      this.offlineStatus.textContent = "Status: offline model ready ‚úÖ";
      this.offlineProgressBar.style.width = "100%";
    } catch (e) {
      console.error("Offline LLM init error:", e);
      this.offlineStatus.textContent = "Status: error loading model ‚ùå";
    } finally {
      this.offlineLoading = false;
    }
  }

  async callOfflineLLM(prompt) {
    if (!this.offlineEngine) return null;
    const res = await this.offlineEngine.chat.completions.create({
      messages: [{ role: "user", content: prompt }],
      stream: false,
      max_tokens: 160
    });
    const text = res?.choices?.[0]?.message?.content || "";
    return text.trim();
  }

  async callOnlineLLM(prompt) {
    if (!this.onlineConfig.apiKey) return null;
    const body = {
      model: this.onlineConfig.model,
      messages: [
        {
          role: "system",
          content:
            "You are AURA-X Œ© helper LLM. Answer compactly and follow the instructions exactly."
        },
        { role: "user", content: prompt }
      ]
    };
    const res = await fetch(this.onlineConfig.endpoint, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${this.onlineConfig.apiKey}`
      },
      body: JSON.stringify(body)
    });
    if (!res.ok) {
      console.error("Online LLM HTTP error:", res.status);
      return null;
    }
    const data = await res.json();
    const text = data?.choices?.[0]?.message?.content || "";
    return text.trim();
  }

  // ========= CORE DYNAMICS (R, E0, CRM continuity) =========

  resonance(TM, BM) {
    // Simple connectivity: TM has slightly stronger weight, BM adds stability
    return 0.65 * TM + 0.35 * BM;
  }

  updateStateFromSentiment(sentiment, isUserMeaningful) {
    // TM pulse from absolute polarity & intensity
    const baseTM = 0.4 + 0.3 * Math.abs(sentiment.polarity) + 0.3 * sentiment.intensity;
    const tmPulse = Math.max(0, Math.min(1, baseTM));
    this.tmLevel = 0.6 * this.tmLevel + 0.4 * tmPulse;

    // BM pulse if learning is enabled and message is "meaningful"
    if (this.learningEnabled && isUserMeaningful) {
      const bmPulse = 0.3 + 0.4 * Math.abs(sentiment.polarity) + 0.3 * sentiment.intensity;
      this.bmLevel = 0.85 * this.bmLevel + 0.15 * Math.max(0, Math.min(1, bmPulse));
    } else {
      // gentle decay toward 0.2 baseline
      this.bmLevel = 0.95 * this.bmLevel + 0.05 * 0.2;
    }

    // Decay term depends slightly on how unstable CI was
    const dynamicDecay = this.decay * (1.0 - this.ci);

    const R = this.resonance(this.tmLevel, this.bmLevel);
    const inner = R - dynamicDecay + this.lambdaFaith + this.lambdaSys + this.lambdaTrc;

    this.e0 = Math.tanh(inner);

    // Continuity Reflex Model: C(t) = 0.5(1+E0) + small bonus from stable, meaningful inputs
    const baseCI = 0.5 * (1 + this.e0); // map [-1,1] ‚Üí [0,1]
    const bonus = 0.18 * (Math.abs(sentiment.polarity) * sentiment.intensity);
    const crmCI = Math.max(0, Math.min(1, baseCI + bonus));

    // Smooth continuity over time
    this.ci = 0.7 * this.ci + 0.3 * crmCI;
  }

  updateMetrics() {
    this.metricE0.textContent = this.e0.toFixed(2);
    this.metricTM.textContent = this.tmLevel.toFixed(2);
    this.metricBM.textContent = this.bmLevel.toFixed(2);
    this.metricCI.textContent = this.ci.toFixed(2);

    const s = this.lastSentiment;
    this.tagValence.textContent = "VALENCE: " + (s.valence || "neutral").toUpperCase();
    this.tagArousal.textContent = "AROUSAL: " + (s.arousal || "medium").toUpperCase();

    let reactionLabel = "balanced";
    if (this.e0 > 0.4) reactionLabel = "warm / hopeful";
    else if (this.e0 < -0.4) reactionLabel = "concerned / protective";

    this.tagReaction.textContent = "REACTION: " + reactionLabel.toUpperCase();
    this.bmStats.textContent =
      `Active layers: ${this.bmEpisodes.length}/${240} ¬∑ System online`;
  }

  drawBM() {
    const canvas = this.bmCanvas;
    const ctx = this.bmCtx;
    if (!canvas || !ctx) return;

    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * window.devicePixelRatio;
    canvas.height = rect.height * window.devicePixelRatio;
    ctx.setTransform(window.devicePixelRatio, 0, 0, window.devicePixelRatio, 0, 0);

    const w = canvas.width / window.devicePixelRatio;
    const h = canvas.height / window.devicePixelRatio;
    ctx.clearRect(0,0,w,h);

    const cx = w/2;
    const cy = h*0.9;
    const maxR = Math.min(w*0.45, h*0.85);

    // Draw 240 slots as faint arcs
    const totalLayers = 240;
    const baseR = maxR * 0.25;
    const stepR = (maxR - baseR) / totalLayers;

    for (let i=0;i<totalLayers;i++) {
      const r = baseR + i*stepR;
      const alpha = 0.03 + (i/totalLayers)*0.07;
      ctx.beginPath();
      ctx.strokeStyle = `rgba(148,163,184,${alpha.toFixed(3)})`;
      ctx.lineWidth = 1;
      ctx.arc(cx, cy, r, Math.PI, Math.PI*2);
      ctx.stroke();
    }

    // Highlight active episodes
    this.bmEpisodes.forEach((ep, idx) => {
      const frac = Math.min(1, (idx+1)/totalLayers);
      const r = baseR + frac*(maxR-baseR);
      const pol = ep.polarity;
      const baseHue = pol >= 0 ? 190 : 15;
      const sat = 80;
      const light = 45 + Math.abs(pol)*25;
      const alpha = 0.3 + ep.intensity*0.4;
      ctx.beginPath();
      ctx.strokeStyle = `hsla(${baseHue},${sat}%,${light}%,${alpha})`;
      ctx.lineWidth = 2.2;
      const span = Math.PI * (0.6 + 0.3 * ep.intensity);
      const start = Math.PI + (Math.PI - span)/2;
      ctx.arc(cx, cy, r, start, start+span);
      ctx.stroke();
    });
  }

  addBMEpisode(text, sentiment) {
    const ep = {
      id: Date.now() + "-" + Math.random().toString(16).slice(2),
      text,
      polarity: sentiment.polarity,
      intensity: sentiment.intensity,
      timestamp: Date.now(),
      locked: false
    };
    this.bmEpisodes.push(ep);
    if (this.bmEpisodes.length > 240) {
      // drop oldest unlocked
      const idx = this.bmEpisodes.findIndex(e => !e.locked);
      if (idx >= 0) this.bmEpisodes.splice(idx,1);
    }
    this.drawBM();
  }

  refreshBMList() {
    if (!this.bmList) return;
    const search = (this.bmSearch?.value || "").toLowerCase();
    this.bmList.innerHTML = "";
    this.bmEpisodes
      .slice()
      .sort((a,b)=>b.timestamp-a.timestamp)
      .forEach(ep => {
        if (search &&
            !ep.text.toLowerCase().includes(search)) return;
        const div = document.createElement("div");
        div.className = "bm-item";
        const time = new Date(ep.timestamp).toLocaleString();
        const polLabel = ep.polarity > 0.15 ? "positive" :
                         ep.polarity < -0.15 ? "negative" : "neutral";
        div.innerHTML = `
          <div class="bm-item-header">
            <span>${time}</span>
            <span>${polLabel}, intensity ${(ep.intensity).toFixed(2)}</span>
          </div>
          <div class="bm-item-text">${ep.text}</div>
          <div class="bm-item-badges">
            TM‚ÜíBM continuity event ¬∑ polarity ${ep.polarity.toFixed(2)}
          </div>
          <div class="bm-item-buttons">
            <button class="lock-pill ${ep.locked ? "locked":""}" data-ep="${ep.id}">
              ${ep.locked ? "üîí Locked" : "üîì Unlock"}
            </button>
            <button class="btn-mini" data-recall="${ep.id}">Recall to chat</button>
            <button class="btn-mini btn-danger" data-delete="${ep.id}">Delete</button>
          </div>
        `;
        this.bmList.appendChild(div);
      });

    this.bmList.querySelectorAll("[data-recall]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-recall");
        const ep = this.bmEpisodes.find(e => e.id === id);
        if (!ep) return;
        this.showRecallBubble(ep);
      });
    });
    this.bmList.querySelectorAll("[data-delete]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-delete");
        const idx = this.bmEpisodes.findIndex(e => e.id === id);
        if (idx >= 0) this.bmEpisodes.splice(idx,1);
        this.refreshBMList();
        this.drawBM();
      });
    });
    this.bmList.querySelectorAll(".lock-pill").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-ep");
        const ep = this.bmEpisodes.find(e => e.id === id);
        if (!ep) return;
        ep.locked = !ep.locked;
        this.refreshBMList();
      });
    });
  }

  refreshConvList() {
    if (!this.convList) return;
    const search = (this.convSearch?.value || "").toLowerCase();
    this.convList.innerHTML = "";
    this.conversations
      .slice()
      .sort((a,b)=>b.timestamp-a.timestamp)
      .forEach(conv => {
        if (search && !conv.text.toLowerCase().includes(search)) return;
        const div = document.createElement("div");
        div.className = "conv-item";
        const time = new Date(conv.timestamp).toLocaleTimeString();
        div.innerHTML = `
          <div class="conv-header">
            <span>${conv.role === "ai" ? "AURA-X Œ©" : "You"}</span>
            <span>${time}</span>
          </div>
          <div class="conv-text">${conv.text}</div>
        `;
        this.convList.appendChild(div);
      });
  }

  showRecallBubble(ep) {
    const bubble = document.createElement("div");
    bubble.className = "recall-bubble visible";
    const time = new Date(ep.timestamp).toLocaleString();
    bubble.innerHTML = `
      <div class="recall-title">BM recall</div>
      <div class="recall-body">${ep.text}</div>
      <div class="recall-meta">${time} ¬∑ polarity ${ep.polarity.toFixed(2)}, intensity ${ep.intensity.toFixed(2)}</div>
    `;
    this.recallContainer.appendChild(bubble);
    setTimeout(() => {
      bubble.classList.remove("visible");
      setTimeout(()=> bubble.remove(),250);
    }, 5000);
  }

  showReaction(sentiment, replyText) {
    const pol = sentiment.polarity;
    const int = sentiment.intensity;

    let icon = "üå°Ô∏è";
    let label = "Balanced";
    let body = "TM and BM are in a balanced, neutral state.";

    if (pol > 0.2 && int > 0.4) {
      icon = "üíö";
      label = "Warm resonance";
      body = "Your message feels hopeful/positive. I try to reinforce that while staying realistic.";
    } else if (pol < -0.2 && int > 0.4) {
      icon = "üõ°Ô∏è";
      label = "Protective concern";
      body = "I sense distress/negativity. I respond gently and avoid making things heavier.";
    } else if (Math.abs(pol) < 0.15 && int < 0.35) {
      icon = "üå´Ô∏è";
      label = "Low-energy";
      body = "Your TM input is calm/low-energy, so I answer softly without pushing BM too hard.";
    }

    this.reactionLabel.textContent = label;
    this.reactionBody.textContent = body;
    this.reactionBubble.classList.add("visible");
    setTimeout(() => {
      this.reactionBubble.classList.remove("visible");
    }, 4200);
  }

  // ========= MAIN SEND FLOW =========

  async handleSend() {
    const text = (this.messageInput.value || "").trim();
    if (!text) return;

    this.messageInput.value = "";
    this.addMessage("user", text, null);

    const typingNode = this.showTyping();

    // Analyze TM with offline/online LLM + lexicon
    const sentiment = await this.analyzeSentimentTM(text);
    this.lastSentiment = sentiment;

    // Decide if message is meaningful enough to touch BM (simple heuristic)
    const isMeaningful =
      text.length > 40 || sentiment.intensity > 0.55 || Math.abs(sentiment.polarity) > 0.35;

    this.updateStateFromSentiment(sentiment, isMeaningful);
    if (isMeaningful) this.addBMEpisode(text, sentiment);
    this.updateMetrics();

    // Try local intelligence first
    let answer = this.searchIntelligence(text);

    // If no local seed matches, attempt LLM reply (offline ‚Üí online) as TM helper
    if (!answer) {
      answer = await this.generateLLMReply(text, sentiment);
    }

    // Fallback generic answer
    if (!answer) {
      answer =
        "I have registered how this message resonates with my Bold Memory and ethics layers. " +
        "Right now I don‚Äôt have a detailed answer, but I am keeping the emotional trajectory stable.";
    }

    this.removeTyping(typingNode);
    this.addMessage("ai", answer, sentiment);
    this.speak(answer);
    this.showReaction(sentiment, answer);
    this.drawBM();
  }

  searchIntelligence(text) {
    const lower = text.toLowerCase();
    let best = null;
    let bestScore = 0;

    this.intelligence.forEach(seed => {
      const qLower = seed.q.toLowerCase();
      let score = 0;
      if (lower === qLower) score = 1.0;
      else if (lower.includes(qLower) || qLower.includes(lower)) score = 0.8;
      else {
        const common = qLower.split(/\s+/).filter(w => lower.includes(w));
        score = common.length / Math.max(3, qLower.split(/\s+/).length);
      }
      if (score > bestScore && score > 0.35) {
        bestScore = score;
        best = seed;
      }
    });

    return best ? best.a : null;
  }

  async generateLLMReply(text, sentiment) {
    const helperPrompt = `
You are AURA-X Œ©, an emotional continuity engine.

You already know:
- User message: "${text}"
- Polarity (approx): ${sentiment.polarity.toFixed(2)}
- Intensity (0‚Äì1): ${sentiment.intensity.toFixed(2)}
- Valence: ${sentiment.valence}
- Arousal: ${sentiment.arousal}

GOAL:
Reply in 2‚Äì4 short sentences.
Keep tone gentle and ethically safe.
Never give medical, legal or financial instructions.
Acknowledge the emotion, keep continuity, and avoid exaggeration.

Answer:
`.trim();

    let raw = null;

    if (this.offlineReady && window.webllm && this.offlineEngine) {
      try {
        raw = await this.callOfflineLLM(helperPrompt);
      } catch (e) {
        console.error("Offline LLM reply error:", e);
      }
    }

    if (!raw && this.onlineConfig.apiKey) {
      try {
        raw = await this.callOnlineLLM(helperPrompt);
      } catch (e) {
        console.error("Online LLM reply error:", e);
      }
    }

    return raw;
  }
}

// --- Bootstrap ---
const core = new EmotionalCore();
window.auraCore = core;
</script>
</body>
</html>