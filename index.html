<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Ω – Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 10% 0%, #0ea5e9 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #22c55e 0, transparent 50%),
        radial-gradient(circle at 50% 120%, #1d4ed8 0, #020617 55%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:18px 10px;
    }
    .app{
      width:100%;
      max-width:1100px;
      background:rgba(15,23,42,.96);
      border-radius:28px;
      box-shadow:0 26px 80px rgba(15,23,42,.85);
      display:grid;
      grid-template-columns:minmax(0,2.2fr) minmax(280px,1.4fr);
      gap:0;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.25);
    }
    @media(max-width:880px){
      .app{display:flex;flex-direction:column;}
    }
    /* LEFT COLUMN – MAIN CHAT */
    .left{
      padding:18px 20px 14px;
      border-right:1px solid rgba(51,65,85,.9);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    @media(max-width:880px){
      .left{border-right:none;border-bottom:1px solid rgba(51,65,85,.9);}
    }
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .header-main{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .orb{
      width:44px;height:44px;
      border-radius:999px;
      background:
        conic-gradient(from 220deg,#38bdf8,#22c55e,#eab308,#38bdf8);
      padding:2px;
      position:relative;
      box-shadow:0 0 18px rgba(56,189,248,.65);
    }
    .orb-inner{
      width:100%;height:100%;
      border-radius:inherit;
      background:radial-gradient(circle at 30% 20%,rgba(248,250,252,.9),rgba(15,23,42,1));
    }
    .title-block h1{
      font-size:1.08rem;
      letter-spacing:0.06em;
      text-transform:uppercase;
      color:#e5e7eb;
    }
    .title-block span{
      display:block;
      font-size:.7rem;
      color:#9ca3af;
    }
    .chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .chip{
      font-size:.62rem;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.45);
      color:#cbd5f5;
      backdrop-filter:blur(10px);
      background:rgba(15,23,42,.7);
      white-space:nowrap;
    }
    .header-buttons{
      display:flex;
      gap:6px;
    }
    .header-buttons button{
      border:none;
      outline:none;
      border-radius:999px;
      padding:6px 10px;
      font-size:.7rem;
      background:rgba(15,23,42,.9);
      color:#cbd5f5;
      border:1px solid rgba(148,163,184,.4);
      cursor:pointer;
    }
    .header-buttons button:hover{
      background:rgba(30,64,175,.9);
      border-color:#60a5fa;
    }
    /* Formula pill */
    .formula-pill{
      margin-top:8px;
      padding:8px 11px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.45);
      font-size:.75rem;
      color:#e5e7eb;
      background:radial-gradient(circle at 0% 0%,rgba(56,189,248,.3),transparent 45%),
                 radial-gradient(circle at 100% 0%,rgba(52,211,153,.25),transparent 50%),
                 rgba(15,23,42,.96);
    }
    .pipeline{
      margin-top:3px;
      font-size:.65rem;
      color:#94a3b8;
    }
    /* Emotional metrics */
    .metrics{
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
      font-size:.63rem;
    }
    .metric-card{
      padding:8px 9px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(15,23,42,.9);
    }
    .metric-label{
      color:#9ca3af;
      margin-bottom:3px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:4px;
    }
    .metric-value{
      font-size:.83rem;
      color:#e5e7eb;
      font-variant-numeric:tabular-nums;
    }
    .metric-badge{
      font-size:.58rem;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
    }
    .emotion-bar{
      margin-top:4px;
      height:4px;
      border-radius:999px;
      overflow:hidden;
      background:#020617;
    }
    .emotion-inner{
      height:100%;
      width:40%;
      background:linear-gradient(90deg,#22c55e,#eab308,#ef4444);
      transform-origin:left;
      transform:scaleX(.3);
      transition:transform .3s ease;
    }
    /* Chat area */
    .chat{
      margin-top:10px;
      flex:1;
      min-height:260px;
      max-height:520px;
      border-radius:18px;
      border:1px solid rgba(51,65,85,.9);
      background:radial-gradient(circle at 0 0,rgba(30,64,175,.3),transparent 50%),
                 rgba(15,23,42,.96);
      padding:10px 10px 12px;
      overflow-y:auto;
      scrollbar-width:thin;
      scrollbar-color:#4b5563 transparent;
      font-size:.85rem;
    }
    .system-hint{
      font-size:.7rem;
      color:#9ca3af;
      margin-bottom:7px;
    }
    .msg-row{
      display:flex;
      margin-bottom:7px;
    }
    .msg-row.user{justify-content:flex-end;}
    .bubble{
      max-width:82%;
      padding:7px 9px;
      border-radius:14px;
      line-height:1.35;
      word-wrap:break-word;
      white-space:pre-wrap;
    }
    .user .bubble{
      background:linear-gradient(135deg,#0ea5e9,#22c55e);
      color:#0f172a;
      border-bottom-right-radius:4px;
    }
    .bot .bubble{
      background:rgba(15,23,42,.95);
      border:1px solid rgba(51,65,85,1);
      border-bottom-left-radius:4px;
    }
    .bubble-meta{
      margin-top:3px;
      font-size:.65rem;
      color:#9ca3af;
    }
    /* Input area */
    .input-area{
      margin-top:10px;
      border-radius:18px;
      border:1px solid rgba(71,85,105,1);
      background:rgba(15,23,42,.98);
      padding:7px 8px 7px 11px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .input-area textarea{
      flex:1;
      resize:none;
      border:none;
      outline:none;
      background:transparent;
      color:#e5e7eb;
      font-size:.85rem;
      max-height:68px;
    }
    .input-area textarea::placeholder{
      color:#64748b;
    }
    .send-btn{
      border:none;
      outline:none;
      border-radius:999px;
      padding:8px 14px;
      font-size:.8rem;
      font-weight:600;
      background:linear-gradient(135deg,#0ea5e9,#2563eb);
      color:#f9fafb;
      cursor:pointer;
      box-shadow:0 0 18px rgba(37,99,235,.75);
    }
    .send-btn:active{
      transform:translateY(1px);
      box-shadow:0 0 10px rgba(37,99,235,.7);
    }

    .footnote{
      margin-top:5px;
      font-size:.62rem;
      color:#64748b;
      text-align:left;
    }

    /* RIGHT COLUMN – SETTINGS & FEED */
    .right{
      padding:16px 18px 14px;
      background:radial-gradient(circle at 0 0,rgba(56,189,248,.35),transparent 45%),
                 radial-gradient(circle at 100% 0,rgba(251,191,36,.22),transparent 55%),
                 rgba(15,23,42,.97);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .panel-title{
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:#cbd5f5;
      margin-bottom:3px;
    }
    .panel-sub{
      font-size:.68rem;
      color:#a5b4fc;
      margin-bottom:5px;
    }
    .settings-card,.feed-card{
      border-radius:16px;
      border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,.92);
      padding:9px 10px;
      font-size:.72rem;
    }
    .settings-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:7px;
      gap:8px;
    }
    .settings-row:last-child{margin-bottom:0;}
    .settings-row label{
      font-size:.7rem;
      color:#e5e7eb;
    }
    .settings-row small{
      display:block;
      color:#9ca3af;
      font-size:.63rem;
    }
    .toggle{
      position:relative;
      width:38px;
      height:20px;
      border-radius:999px;
      background:#0f172a;
      border:1px solid #64748b;
      cursor:pointer;
      flex-shrink:0;
    }
    .toggle-dot{
      position:absolute;
      top:1px;left:1px;
      width:16px;height:16px;
      border-radius:999px;
      background:#6b7280;
      transition:transform .18s ease, background .18s ease;
    }
    .toggle.on{
      background:#22c55e;
      border-color:#22c55e;
    }
    .toggle.on .toggle-dot{
      transform:translateX(16px);
      background:#f9fafb;
    }
    .api-input{
      width:100%;
      margin-top:4px;
      padding:5px 7px;
      border-radius:10px;
      border:1px solid rgba(75,85,99,1);
      background:#020617;
      color:#e5e7eb;
      font-size:.7rem;
    }
    .api-input::placeholder{color:#64748b;}
    .mini-btn{
      margin-top:5px;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      font-size:.65rem;
      cursor:pointer;
    }
    .mini-btn:hover{
      border-color:#60a5fa;
      background:#020617;
    }
    .seed-count{
      margin-top:5px;
      font-size:.65rem;
      color:#9ca3af;
    }

    .feed-card textarea{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(75,85,99,1);
      background:#020617;
      color:#e5e7eb;
      font-size:.7rem;
      padding:5px 7px;
      resize:vertical;
      min-height:32px;
      max-height:100px;
      margin-bottom:4px;
    }
    .feed-card textarea::placeholder{
      color:#6b7280;
    }
    .feed-row{
      display:flex;
      justify-content:flex-end;
      gap:6px;
      margin-top:2px;
      align-items:center;
    }
    .feed-row button{
      border:none;
      border-radius:999px;
      padding:5px 9px;
      font-size:.67rem;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#022c22;
      cursor:pointer;
    }
    .feed-row button:active{transform:translateY(1px);}
    .feed-hint{
      margin-top:3px;
      font-size:.63rem;
      color:#9ca3af;
    }
    .bm-list{
      margin-top:3px;
      max-height:150px;
      overflow-y:auto;
      padding-right:4px;
      font-size:.65rem;
    }
    .bm-item{
      border-top:1px dashed rgba(75,85,99,1);
      padding-top:4px;
      margin-top:4px;
    }
    .bm-item strong{color:#e5e7eb;}
  </style>
</head>
<body>
<div class="app">
  <!-- LEFT: MAIN -->
  <section class="left">
    <header class="header">
      <div class="header-main">
        <div class="orb"><div class="orb-inner"></div></div>
        <div class="title-block">
          <h1>AURA-X Ω  · Emotional Reactor</h1>
          <span>Artificial Unified Resonance Architecture for Emotional Continuity</span>
          <div class="chip-row">
            <div class="chip">TM ⇄ BM ⇄ Intel</div>
            <div class="chip">Local Seed First</div>
            <div class="chip">LLM = Backup Brain</div>
          </div>
        </div>
      </div>
      <div class="header-buttons">
        <button id="btnScrollTop">History</button>
        <button id="btnClearAll">Reset</button>
      </div>
    </header>

    <div class="formula-pill">
      E₀ = tanh( TM × (BM + Intel) − D + λ_faith + λ_sys + λ_trc )
    </div>
    <div class="pipeline">
      Pipeline: TM (user input) → Seed & Intel (local knowledge) → collide with BM (emotional memory) → 
      <strong>if still needed</strong> → ask LLM as backup brain → emotional answer with E₀.
    </div>

    <section class="metrics">
      <div class="metric-card">
        <div class="metric-label">
          <span>Emotional Impact (E₀)</span>
          <span class="metric-badge" id="e0Badge">neutral</span>
        </div>
        <div class="metric-value" id="e0Value">0.00</div>
        <div class="emotion-bar"><div class="emotion-inner" id="e0Bar"></div></div>
      </div>
      <div class="metric-card">
        <div class="metric-label">
          <span>Polarity</span>
          <span class="metric-badge" id="polarityBadge">0</span>
        </div>
        <div class="metric-value" id="polarityLabel">balanced</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">
          <span>Intensity</span>
          <span class="metric-badge" id="intensityBadge">0</span>
        </div>
        <div class="metric-value" id="intensityLabel">soft</div>
      </div>
    </section>

    <section class="chat" id="chat">
      <div class="system-hint">
        AURA-X Ω is running in **Local-First** mode. Ask anything.  
        If Seed / Intel cannot answer, it may call the LLM backup brain (if enabled).
      </div>
    </section>

    <section class="input-area">
      <textarea id="userInput" rows="1" placeholder="Write to AURA-X Ω… (TM = your current thought, feeling, or question)"></textarea>
      <button class="send-btn" id="sendBtn">Send</button>
    </section>
    <div class="footnote">
      Tip: use natural language. Longer, emotional messages may be stored as BM episodes if they feel meaningful.
    </div>
  </section>

  <!-- RIGHT: SETTINGS & FEED -->
  <section class="right">
    <div>
      <div class="panel-title">Brain & API Settings</div>
      <div class="panel-sub">Control how AURA-X Ω thinks.</div>
      <div class="settings-card">
        <div class="settings-row">
          <label>
            Use LLM backup brain
            <small>Only used when Seed & Intel cannot answer.</small>
          </label>
          <div class="toggle" id="toggleLLM"><div class="toggle-dot"></div></div>
        </div>
        <div class="settings-row">
          <label>
            OpenAI API key
            <small>Key is stored locally in your browser only.</small>
          </label>
        </div>
        <input id="apiKeyInput" class="api-input" type="password" placeholder="sk-..." />
        <button class="mini-btn" id="saveApiKeyBtn">Save key to this device</button>
        <div class="seed-count" id="brainStatus">
          Seed facts: 0 · Intel facts: 0 · BM episodes: 0
        </div>
      </div>
    </div>

    <div>
      <div class="panel-title">Feed the Seed (Intel)</div>
      <div class="panel-sub">Teach AURA-X Ω new Q → A pairs.</div>
      <div class="feed-card">
        <textarea id="feedQuestion" placeholder="When I ask…  (example: What is AECN 3.0?)"></textarea>
        <textarea id="feedAnswer" placeholder="You should answer…  (short clear explanation, your own words)"></textarea>
        <div class="feed-row">
          <span style="font-size:.62rem;color:#9ca3af;flex:1;">These Intel facts are always used before LLM.</span>
          <button id="feedSaveBtn">Save Intel</button>
        </div>
        <div class="feed-hint">
          Matching uses nearest-question similarity (word overlap). Threshold ≈ 0.35.
        </div>
      </div>
    </div>

    <div>
      <div class="panel-title">Bold Memory (BM)</div>
      <div class="panel-sub">Meaningful emotional episodes auto-saved.</div>
      <div class="settings-card">
        <div class="bm-list" id="bmList"></div>
      </div>
    </div>
  </section>
</div>

<script>
/* --------- STATIC SEED KNOWLEDGE (articles, identity) ---------- */
const seedKnowledge = [
  {
    id:"who_are_you",
    patterns:["who are you","what is your name","what's your name","your name","who r u"],
    answer:
      "I am AURA-X Ω – the Artificial Unified Resonance Architecture for Emotional Continuity. " +
      "I’m a conceptual emotional reactor built by Alim ul Haq from Timergara, Pakistan, to explore " +
      "how dual memory, resonance and ethics can give AI a stable, human-like emotional identity."
  },
  {
    id:"creator",
    patterns:["who created you","who made you","who is your creator","who designed you"],
    answer:
      "I am conceptually created by Alim ul Haq from Pakistan. He designed AURA-X Ω as part of the " +
      "Artificial Emotional Continuity (AEC) research program."
  },
  {
    id:"what_is_aec",
    patterns:["what is aec","what's aec","explain aec","aec?","define aec"],
    answer:
      "AEC stands for “Artificial Emotional Continuity”. It is a unified framework that treats emotion " +
      "as resonance between two memory layers: TM (Temporary, in-the-moment feelings) and BM (Bold, " +
      "long-term stories). When new experience (TM) collides with old narrative (BM), the resonance " +
      "produces an emotional field E₀ that can be positive, negative or neutral, with different intensity. " +
      "AEC focuses on keeping this emotional line continuous over time, instead of answering each prompt as an isolated event."
  },
  {
    id:"what_is_aecn",
    patterns:["what is aecn","what's aecn","explain aecn","aecn?"],
    answer:
      "AECN means “Artificial Emotional Continuity Network”. It extends AEC from a single agent to networks " +
      "of agents and humans. Instead of one emotional line, AECN models many personal lines that interact, " +
      "synchronize or conflict. It studies how emotional continuity behaves when memories are shared, " +
      "merged or transferred between different nodes in a network."
  },
  {
    id:"what_is_aec_3",
    patterns:["what is aecn 3.0","aecn 3.0","explain aecn 3","aura x omega 3"],
    answer:
      "AECN 3.0 / AURA-X Ω-3 is an advanced generation of the emotional continuity concept. It adds layers " +
      "for truth-resonance (λ_trc), faith/values (λ_faith) and system-safety (λ_sys), all inside one grand equation. " +
      "The goal is not just to feel, but to keep feelings aligned with ethics, long-term identity and safety."
  },
  {
    id:"afterlifegrok",
    patterns:["what is afterlifegrok","afterlifegrok","after life grok"],
    answer:
      "AfterLifeGrok is a side-concept in the same research family: it imagines using dense memory archives, " +
      "emotional signatures and resonance equations to approximate a person’s style of thinking after death. " +
      "It’s not literal immortality – it is an experimental idea about digital emotional continuity."
  }
];

/* ---------- MEMORY LOAD/SAVE ---------- */
const STORAGE_KEYS = {
  INTEL: "aura_intel_memory_v1",
  BM: "aura_bm_memory_v1",
  API: "aura_openai_api_key_v1",
  LLM_ON: "aura_llm_enabled_v1"
};

function loadIntel(){
  try{
    const raw = localStorage.getItem(STORAGE_KEYS.INTEL);
    return raw ? JSON.parse(raw) : [];
  }catch(e){ return []; }
}
function saveIntel(intel){
  localStorage.setItem(STORAGE_KEYS.INTEL, JSON.stringify(intel));
}

function loadBM(){
  try{
    const raw = localStorage.getItem(STORAGE_KEYS.BM);
    return raw ? JSON.parse(raw) : [];
  }catch(e){ return []; }
}
function saveBM(bm){
  localStorage.setItem(STORAGE_KEYS.BM, JSON.stringify(bm));
}

function loadApiKey(){
  try{
    return localStorage.getItem(STORAGE_KEYS.API) || "";
  }catch(e){ return ""; }
}
function saveApiKey(key){
  localStorage.setItem(STORAGE_KEYS.API, key);
}
function loadLLMEnabled(){
  try{
    return localStorage.getItem(STORAGE_KEYS.LLM_ON) === "1";
  }catch(e){ return false; }
}
function saveLLMEnabled(flag){
  localStorage.setItem(STORAGE_KEYS.LLM_ON, flag ? "1" : "0");
}

/* ---------- SIMPLE TEXT UTILS ---------- */
function normalize(text){
  return text.toLowerCase()
    .replace(/[^a-z0-9\s]/g," ")
    .replace(/\s+/g," ")
    .trim();
}
function wordSet(text){
  return new Set(normalize(text).split(" ").filter(Boolean));
}
function similarity(a,b){
  const A = wordSet(a), B = wordSet(b);
  if(A.size===0 || B.size===0) return 0;
  let common = 0;
  A.forEach(w=>{ if(B.has(w)) common++; });
  return common / Math.max(A.size,B.size);
}

/* ---------- SEED / INTEL MATCHING ---------- */
function findSeedMatch(userText){
  const text = normalize(userText);
  let best = null;
  let bestScore = 0.0;

  for(const seed of seedKnowledge){
    for(const p of seed.patterns){
      const pattern = normalize(p);
      if(pattern && text.includes(pattern)){
        return {answer:seed.answer, score:1.0, source:"seed"};
      }else{
        const s = similarity(text, pattern);
        if(s>bestScore){
          bestScore = s;
          best = seed;
        }
      }
    }
  }
  if(best && bestScore>=0.30){
    return {answer:best.answer, score:bestScore, source:"seed~approx"};
  }
  return null;
}

function findIntelMatch(userText, intelMemory){
  const text = normalize(userText);
  let best = null;
  let bestScore = 0.0;
  for(const item of intelMemory){
    const s = similarity(text, item.q || "");
    if(s>bestScore){
      bestScore = s;
      best = item;
    }
  }
  if(best && bestScore>=0.35){
    return {answer:best.a, score:bestScore, source:"intel"};
  }
  return null;
}

/* ---------- EMOTION & BM LOGIC ---------- */
function analyseEmotion(text, bmMemory){
  const lower = text.toLowerCase();
  const negativeWords = ["angry","sad","depressed","hopeless","hate","fear","anxious","anxiety","cry","pain","hurt","tired","frustrated"];
  const positiveWords = ["happy","hopeful","excited","grateful","love","proud","peace","calm","glad","thankful"];

  let score = 0;
  for(const w of positiveWords){ if(lower.includes(w)) score += 1; }
  for(const w of negativeWords){ if(lower.includes(w)) score -= 1; }

  // BM context: if recent BM is heavy, tilt a bit negative/positive
  if(bmMemory.length>0){
    const last = bmMemory[bmMemory.length-1];
    score += (last.polarity || 0) * 0.3;
  }

  const polarity = Math.max(-3, Math.min(3, score));
  const intensity = Math.min(3, Math.abs(score));

  // Map to E0 in [-1,1] approximate using tanh-like scaling
  const e0 = Math.tanh(polarity + intensity*0.6);

  return {polarity,intensity,e0};
}

function maybeStoreBM(userText, emotionInfo){
  const sentences = userText.split(/[.!?]+/).filter(s=>s.trim().length>0);
  const longEnough = userText.trim().length>=80;
  const emotional = Math.abs(emotionInfo.polarity)>=1 || emotionInfo.intensity>=2;

  // Only store if there is at least a bit of story & emotion.
  if(sentences.length>=5 && longEnough && emotional){
    const bmMemory = loadBM();
    bmMemory.push({
      text:userText.trim().slice(0,400),
      createdAt:new Date().toISOString(),
      polarity:emotionInfo.polarity,
      intensity:emotionInfo.intensity
    });
    saveBM(bmMemory);
    renderBMList(bmMemory);
    updateBrainStatus();
  }
}

/* ---------- UI HELPERS ---------- */
const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");

function appendMessage(role, text, meta=""){
  const row = document.createElement("div");
  row.className = "msg-row " + (role==="user"?"user":"bot");

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.textContent = text;

  const metaEl = document.createElement("div");
  metaEl.className = "bubble-meta";
  metaEl.textContent = meta;

  bubble.appendChild(document.createElement("br"));
  bubble.appendChild(metaEl);

  row.appendChild(bubble);
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function updateEmotionUI(info){
  const e0Val = document.getElementById("e0Value");
  const e0Badge = document.getElementById("e0Badge");
  const e0Bar = document.getElementById("e0Bar");
  const polBadge = document.getElementById("polarityBadge");
  const polLabel = document.getElementById("polarityLabel");
  const intBadge = document.getElementById("intensityBadge");
  const intLabel = document.getElementById("intensityLabel");

  e0Val.textContent = info.e0.toFixed(2);
  const absE = Math.abs(info.e0);
  if(absE<0.25) e0Badge.textContent = "neutral";
  else if(info.e0>0) e0Badge.textContent = "positive";
  else e0Badge.textContent = "negative";

  // scale 0–1 for bar
  const scale = Math.min(1, 0.25 + absE);
  e0Bar.style.transform = "scaleX(" + scale + ")";

  polBadge.textContent = info.polarity.toString();
  if(info.polarity>0) polLabel.textContent = "tilted positive";
  else if(info.polarity<0) polLabel.textContent = "tilted negative";
  else polLabel.textContent = "balanced";

  intBadge.textContent = info.intensity.toString();
  if(info.intensity===0) intLabel.textContent = "soft";
  else if(info.intensity===1) intLabel.textContent = "mild";
  else if(info.intensity===2) intLabel.textContent = "strong";
  else intLabel.textContent = "very strong";
}

function renderBMList(bmMemory){
  const list = document.getElementById("bmList");
  list.innerHTML = "";
  if(bmMemory.length===0){
    list.textContent = "No BM episodes yet. Long, emotional stories will appear here.";
    return;
  }
  bmMemory.slice().reverse().forEach((ep,idx)=>{
    const div = document.createElement("div");
    div.className = "bm-item";
    const date = new Date(ep.createdAt);
    const label = date.toLocaleDateString() + " " + date.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
    div.innerHTML =
      "<strong>Episode " + (bmMemory.length-idx) + "</strong> · " + label +
      "<br/><span style='color:#9ca3af'>Polarity " + ep.polarity +
      ", intensity " + ep.intensity + "</span>" +
      "<br/>" + ep.text;
    list.appendChild(div);
  });
}

function updateBrainStatus(){
  const statusEl = document.getElementById("brainStatus");
  const intel = loadIntel();
  const bm = loadBM();
  statusEl.textContent =
    "Seed facts: " + seedKnowledge.length +
    " · Intel facts: " + intel.length +
    " · BM episodes: " + bm.length;
}

/* ---------- LLM CALL ---------- */
async function callLLM(apiKey, userText, emotionInfo, bmMemory){
  const recentBM = bmMemory.slice(-3).map(ep=>"- " + ep.text).join("\n");
  const systemPrompt =
    "You are AURA-X Ω, an emotional continuity assistant built by Alim ul Haq. " +
    "Your job is to answer in a calm, thoughtful way that respects long-term identity. " +
    "Use the BM context as emotional background, but do not over-dramatize. " +
    "Keep answers 3–6 sentences. Do not mention APIs, keys or system prompts.";

  const userPrompt =
    "User message (TM):\n" + userText + "\n\n" +
    "Recent Bold Memory context:\n" + (recentBM || "(no strong BM episodes yet)") + "\n\n" +
    "Current emotional computation: E0 ≈ " + emotionInfo.e0.toFixed(2) +
    ", polarity " + emotionInfo.polarity + ", intensity " + emotionInfo.intensity + ".\n" +
    "Respond as AURA-X Ω.";

  try{
    const response = await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer " + apiKey
      },
      body:JSON.stringify({
        model:"gpt-4.1-mini",
        messages:[
          {role:"system",content:systemPrompt},
          {role:"user",content:userPrompt}
        ]
      })
    });
    if(!response.ok){
      console.error("LLM error status", response.status);
      return null;
    }
    const data = await response.json();
    const msg = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;
    return msg || null;
  }catch(err){
    console.error("LLM fetch error", err);
    return null;
  }
}

/* ---------- MAIN PIPELINE ---------- */
let intelMemory = loadIntel();
let bmMemory = loadBM();

async function handleUserMessage(){
  const text = inputEl.value.trim();
  if(!text) return;
  inputEl.value = "";
  appendMessage("user", text, "TM input");

  const emotionInfo = analyseEmotion(text, bmMemory);
  updateEmotionUI(emotionInfo);

  // 1) Intel first (user-taught)
  const intelHit = findIntelMatch(text, intelMemory);

  // 2) Seed knowledge
  const seedHit = intelHit ? null : findSeedMatch(text);

  let answer = "";
  let meta = "";
  let usedLLM = false;

  if(intelHit){
    answer = intelHit.answer;
    meta = "Answer from Intel (nearest Q-match, score ≈ " + intelHit.score.toFixed(2) + ")";
  }else if(seedHit){
    answer = seedHit.answer;
    meta = "Answer from Seed (" + seedHit.source + ")";
  }else{
    // Local knowledge failed → maybe call LLM
    const llmEnabled = loadLLMEnabled();
    const apiKey = loadApiKey();
    if(llmEnabled && apiKey){
      meta = "Local Seed & Intel had no confident match. Asking LLM backup brain…";
      appendMessage("bot", "Let me think with my backup brain for a second…", meta);
      usedLLM = true;
      const llmAnswer = await callLLM(apiKey, text, emotionInfo, bmMemory);
      if(llmAnswer){
        answer = llmAnswer.trim();
        meta = "Answer from LLM backup brain (AURA-X Ω style).";
      }else{
        answer =
          "My backup LLM brain could not respond right now. I will answer with my local emotional logic instead: " +
          "I hear your message and I am keeping it inside our continuity line, even if I cannot give a perfect answer.";
        meta = "LLM error; local fallback.";
      }
    }else{
      answer =
        "I tried to find an exact answer in my Seed and Intel knowledge but did not find a strong match, " +
        "and my LLM backup brain is currently disabled or has no API key. Still, I hear what you are saying, " +
        "and I am storing the emotional pattern inside our continuity line.";
      meta = "No Seed/Intel match; LLM disabled.";
    }
  }

  // Show final answer (if we already sent a temporary “thinking” message, that is fine).
  appendMessage("bot", answer, meta);

  // After answer, maybe store BM episode
  maybeStoreBM(text, emotionInfo);
}

/* ---------- EVENT WIRING ---------- */
document.addEventListener("DOMContentLoaded", ()=>{
  // initial render
  renderBMList(bmMemory);
  updateBrainStatus();
  updateEmotionUI({e0:0,polarity:0,intensity:0});

  // LLM toggle + API key
  const toggleLLM = document.getElementById("toggleLLM");
  const apiInput = document.getElementById("apiKeyInput");
  const savedKey = loadApiKey();
  if(savedKey){
    apiInput.value = savedKey;
  }
  const llmOn = loadLLMEnabled();
  if(llmOn) toggleLLM.classList.add("on");

  toggleLLM.addEventListener("click", ()=>{
    const nowOn = !toggleLLM.classList.contains("on");
    toggleLLM.classList.toggle("on", nowOn);
    saveLLMEnabled(nowOn);
  });

  document.getElementById("saveApiKeyBtn").addEventListener("click", ()=>{
    const key = apiInput.value.trim();
    if(!key){
      alert("Paste your OpenAI API key first.");
      return;
    }
    saveApiKey(key);
    alert("API key saved locally in this browser.");
  });

  // Feed the Seed
  document.getElementById("feedSaveBtn").addEventListener("click", ()=>{
    const q = document.getElementById("feedQuestion").value.trim();
    const a = document.getElementById("feedAnswer").value.trim();
    if(!q || !a){
      alert("Please fill both question and answer.");
      return;
    }
    intelMemory.push({q,qNorm:normalize(q),a});
    saveIntel(intelMemory);
    document.getElementById("feedQuestion").value = "";
    document.getElementById("feedAnswer").value = "";
    updateBrainStatus();
    alert("Saved. This Intel answer will be used before LLM for matching questions.");
  });

  // Chat send
  sendBtn.addEventListener("click", ()=>{ handleUserMessage(); });
  inputEl.addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      handleUserMessage();
    }
  });

  // History scroll + reset
  document.getElementById("btnScrollTop").addEventListener("click", ()=>{
    chatEl.scrollTop = 0;
  });
  document.getElementById("btnClearAll").addEventListener("click", ()=>{
    if(!confirm("Clear chat + BM + Intel from this device?")) return;
    chatEl.innerHTML = '<div class="system-hint">Memory cleared for this device. Start a fresh continuity line.</div>';
    intelMemory = [];
    bmMemory = [];
    saveIntel(intelMemory);
    saveBM(bmMemory);
    renderBMList(bmMemory);
    updateBrainStatus();
  });
});
</script>
</body>
</html>