<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Ω – Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* ============ RESET ============ */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 10% 0%, #020617 0, transparent 50%),
        radial-gradient(circle at 90% 0%, #0ea5e9 0, transparent 40%),
        radial-gradient(circle at 30% 120%, #22c55e 0, transparent 55%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:16px;
    }

    .app{
      width:100%;
      max-width:1100px;
      background:rgba(15,23,42,0.92);
      border-radius:24px;
      box-shadow:0 24px 80px rgba(15,23,42,0.95);
      padding:20px 20px 16px;
      display:flex;
      flex-direction:column;
      gap:16px;
      backdrop-filter:blur(18px);
    }

    /* ============ HEADER ============ */
    .header-top{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .title-block h1{
      font-size:1.4rem;
      letter-spacing:0.06em;
      text-transform:uppercase;
      color:#f9fafb;
    }
    .title-block h1 span{
      background:linear-gradient(120deg,#38bdf8,#a855f7,#22c55e);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .title-block p{
      margin-top:4px;
      font-size:0.8rem;
      color:#9ca3af;
      max-width:430px;
    }

    .ethics-pill{
      align-self:flex-start;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(250,204,21,0.4);
      background:linear-gradient(135deg,rgba(24,24,27,0.8),rgba(30,64,175,0.3));
      font-size:0.72rem;
      color:#facc15;
      display:flex;
      gap:6px;
      align-items:center;
      text-align:left;
      max-width:280px;
    }
    .ethics-pill span.icon{
      font-size:0.8rem;
    }

    .top-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }
    .btn-chip{
      font-size:0.75rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:radial-gradient(circle at 0 0,rgba(148,163,184,0.25),rgba(15,23,42,0.9));
      padding:5px 10px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      color:#e5e7eb;
    }
    .btn-chip span.dot{
      width:7px;
      height:7px;
      border-radius:50%;
      background:#22c55e;
      box-shadow:0 0 12px rgba(34,197,94,0.9);
    }
    .btn-chip.llm-off span.dot{background:#ef4444;box-shadow:0 0 12px rgba(248,113,113,0.9);}
    .btn-chip.llm-on span.dot{background:#22c55e;box-shadow:0 0 16px rgba(22,163,74,1);}

    /* ============ MAIN LAYOUT ============ */
    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1.4fr) minmax(0,0.9fr);
      gap:14px;
    }
    @media(max-width:980px){
      .layout{
        grid-template-columns:1fr;
      }
    }

    .panel{
      border-radius:18px;
      background:radial-gradient(circle at 0 0,rgba(148,163,184,0.14),rgba(15,23,42,0.96));
      border:1px solid rgba(148,163,184,0.28);
      padding:12px 12px 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .panel h2{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:#9ca3af;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .panel h2 span.sub{
      font-size:0.7rem;
      text-transform:none;
      letter-spacing:0;
      color:#6b7280;
    }

    /* Reactor / Orb */
    .orb-shell{
      margin-top:6px;
      background:radial-gradient(circle at 50% 0%,rgba(56,189,248,0.3),transparent 60%);
      border-radius:20px;
      padding:14px 10px 12px;
      position:relative;
      overflow:hidden;
    }
    .orb{
      width:130px;
      height:130px;
      border-radius:50%;
      margin:0 auto;
      background:
        radial-gradient(circle at 20% 20%,rgba(248,250,252,0.9),rgba(148,163,184,0.1)),
        radial-gradient(circle at 80% 80%,rgba(34,197,94,0.3),rgba(56,189,248,0.06));
      box-shadow:
        0 0 35px rgba(56,189,248,0.55),
        inset 0 0 55px rgba(15,23,42,0.95);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .orb-core{
      width:54px;
      height:54px;
      border-radius:50%;
      background:radial-gradient(circle,#22c55e,#0ea5e9);
      box-shadow:
        0 0 18px rgba(56,189,248,0.9),
        0 0 38px rgba(34,197,94,0.8);
      position:relative;
      animation:pulseCore 4s ease-in-out infinite;
    }
    .orb-ring{
      position:absolute;
      width:90%;
      height:90%;
      border-radius:50%;
      border:1px dashed rgba(148,163,184,0.45);
      box-shadow:0 0 20px rgba(56,189,248,0.2);
      animation:spinRing 18s linear infinite;
    }
    .orb-trace{
      position:absolute;
      width:2px;
      height:46%;
      background:linear-gradient(to top,rgba(56,189,248,0.1),rgba(56,189,248,0.8));
      transform-origin:50% 100%;
      border-radius:999px;
      opacity:0.85;
      animation:orbitTrace 7s ease-in-out infinite;
    }
    .orb-label{
      margin-top:8px;
      font-size:0.75rem;
      text-align:center;
      color:#cbd5f5;
    }

    .metric-row{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:0.75rem;
    }
    .metric-row span.label{
      color:#9ca3af;
      margin-bottom:2px;
    }
    .meter{
      width:100%;
      height:7px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      overflow:hidden;
      position:relative;
    }
    .meter-fill{
      height:100%;
      width:40%;
      background:linear-gradient(90deg,#dc2626,#eab308,#22c55e);
      box-shadow:0 0 14px rgba(34,197,94,0.8);
      transition:width .5s ease;
    }
    .meter-overlay{
      position:absolute;
      inset:0;
      background:linear-gradient(120deg,transparent,rgba(148,163,184,0.16),transparent);
      pointer-events:none;
    }

    .banner{
      margin-top:8px;
      font-size:0.72rem;
      padding:6px 8px;
      border-radius:10px;
      background:linear-gradient(135deg,rgba(24,24,27,0.9),rgba(30,64,175,0.7));
      display:flex;
      align-items:center;
      gap:6px;
    }
    .banner.bad{
      background:linear-gradient(135deg,rgba(24,24,27,0.9),rgba(185,28,28,0.8));
    }
    .banner.neutral{
      background:linear-gradient(135deg,rgba(24,24,27,0.9),rgba(180,83,9,0.8));
    }

    /* Conversation panel */
    .conversation-log{
      margin-top:6px;
      border-radius:14px;
      background:rgba(15,23,42,0.92);
      border:1px solid rgba(55,65,81,0.9);
      padding:10px;
      height:210px;
      overflow-y:auto;
      font-size:0.8rem;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .msg{
      display:flex;
      gap:6px;
      align-items:flex-start;
    }
    .msg-user .bubble{
      background:linear-gradient(135deg,#0ea5e9,#22c55e);
      color:#0f172a;
      margin-left:auto;
    }
    .msg-aura .bubble{
      background:linear-gradient(135deg,#020617,#111827);
      border:1px solid rgba(148,163,184,0.6);
    }
    .msg .avatar{
      width:20px;
      height:20px;
      border-radius:999px;
      background:#1e293b;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.7rem;
      flex-shrink:0;
    }
    .bubble{
      border-radius:14px;
      padding:7px 9px;
      max-width:88%;
      line-height:1.35;
    }
    .bubble small{
      display:block;
      font-size:0.65rem;
      opacity:0.6;
      margin-top:2px;
    }

    .answer-box{
      margin-top:8px;
      border-radius:16px;
      padding:9px 10px;
      background:radial-gradient(circle at 0 0,rgba(148,163,184,0.25),rgba(15,23,42,0.95));
      border:1px solid rgba(148,163,184,0.7);
      min-height:80px;
      font-size:0.8rem;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .answer-box-header{
      font-size:0.72rem;
      color:#9ca3af;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .answer-box-header span.badge{
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      font-size:0.65rem;
      color:#e5e7eb;
    }
    .answer-text{margin-top:4px;}

    /* BM panel */
    .bm-list{
      margin-top:6px;
      border-radius:12px;
      background:rgba(15,23,42,0.96);
      border:1px solid rgba(55,65,81,0.9);
      padding:8px;
      height:260px;
      overflow-y:auto;
      font-size:0.78rem;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .episode{
      padding:6px 7px;
      border-radius:10px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(55,65,81,0.9);
    }
    .episode-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:0.7rem;
      color:#9ca3af;
      margin-bottom:2px;
    }
    .episode-title{
      font-size:0.78rem;
      color:#e5e7eb;
    }
    .episode-meta{
      margin-top:3px;
      display:flex;
      gap:6px;
      font-size:0.65rem;
      color:#9ca3af;
    }

    /* Input area */
    .input-block{
      margin-top:4px;
      border-radius:18px;
      padding:8px 9px 6px;
      background:radial-gradient(circle at 100% 0%,rgba(14,165,233,0.25),rgba(15,23,42,0.95));
      border:1px solid rgba(148,163,184,0.65);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .formula-hint{
      font-size:0.68rem;
      color:#9ca3af;
      margin-left:4px;
      margin-bottom:2px;
    }
    .input-row{
      display:flex;
      gap:8px;
      align-items:flex-end;
    }
    .input-row textarea{
      flex:1;
      background:rgba(15,23,42,0.95);
      border-radius:12px;
      border:1px solid rgba(55,65,81,0.9);
      padding:8px 9px;
      font-size:0.8rem;
      color:#e5e7eb;
      resize:none;
      min-height:40px;
      max-height:90px;
      outline:none;
    }
    .input-row textarea::placeholder{
      color:#6b7280;
    }
    .btn-send{
      border:none;
      border-radius:999px;
      padding:8px 16px;
      font-size:0.8rem;
      background:linear-gradient(135deg,#22c55e,#0ea5e9);
      color:#020617;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      box-shadow:0 12px 30px rgba(34,197,94,0.45);
      flex-shrink:0;
    }

    /* LLM status under modal */
    .offline-status{
      font-size:0.7rem;
      color:#22c55e;
      margin-top:4px;
    }

    /* ============ MODAL ============ */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.7);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .hidden{display:none;}
    .modal-card{
      width:100%;
      max-width:420px;
      background:#020617;
      border-radius:20px;
      border:1px solid rgba(148,163,184,0.6);
      box-shadow:0 24px 60px rgba(15,23,42,0.98);
      padding:14px 16px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .modal-header h3{
      font-size:0.9rem;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:#e5e7eb;
    }
    .modal-header p{
      font-size:0.7rem;
      color:#9ca3af;
      margin-top:3px;
    }
    .modal-close{
      border-radius:999px;
      border:1px solid rgba(75,85,99,0.9);
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
      font-size:0.8rem;
      padding:4px 8px;
      cursor:pointer;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:6px;
      font-size:0.75rem;
    }
    .field label{color:#9ca3af;}
    .field input, .field select{
      background:#020617;
      border-radius:10px;
      border:1px solid rgba(55,65,81,0.9);
      padding:6px 8px;
      font-size:0.78rem;
      color:#e5e7eb;
      outline:none;
    }
    .field small{
      font-size:0.65rem;
      color:#6b7280;
    }
    .modal-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:6px;
      gap:8px;
      font-size:0.7rem;
    }
    .btn-primary-mini{
      border:none;
      border-radius:999px;
      padding:6px 10px;
      font-size:0.75rem;
      background:linear-gradient(135deg,#0ea5e9,#22c55e);
      color:#020617;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(14,165,233,0.65);
    }

    @keyframes pulseCore{
      0%,100%{transform:scale(1);box-shadow:0 0 18px rgba(56,189,248,0.9),0 0 36px rgba(34,197,94,0.9);}
      50%{transform:scale(1.08);box-shadow:0 0 28px rgba(56,189,248,1),0 0 48px rgba(34,197,94,1);}
    }
    @keyframes spinRing{
      0%{transform:rotate(0deg);}
      100%{transform:rotate(360deg);}
    }
    @keyframes orbitTrace{
      0%,100%{transform:rotate(-25deg);}
      50%{transform:rotate(35deg);}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header-top">
      <div class="title-block">
        <h1><span>AURA-X Ω</span> · Emotional Continuity Reactor</h1>
        <p>
          Dual-memory prototype: TM (conversation window) + BM (meaningful episodes) with offline + online LLM support.
        </p>
        <div class="top-buttons">
          <button class="btn-chip" id="btnFaithLens">
            <span class="dot"></span>Faith Lens
          </button>
          <button class="btn-chip" id="btnHistory">
            <span class="dot"></span>Conversation DNA
          </button>
          <button class="btn-chip" id="btnBMSnapshot">
            <span class="dot"></span>BM Snapshot
          </button>
          <button class="btn-chip llm-off" id="btnToggleLLM">
            <span class="dot"></span>LLM: OFF
          </button>
          <button class="btn-chip" id="btnLLMSettings">
            ⚙️ LLM Settings
          </button>
        </div>
      </div>
      <div class="ethics-pill">
        <span class="icon">⚖️</span>
        <div>
          Avoid actions that create strong negative emotions in you or others.
          Gently move toward states that increase shared calm, clarity and hope.
        </div>
      </div>
    </div>

    <div class="layout">
      <!-- Reactor / metrics -->
      <section class="panel">
        <h2>BM / TM REACTOR <span class="sub" id="reactorStateLabel">IDLE · NEUTRAL</span></h2>
        <div class="orb-shell">
          <div class="orb" id="reactorOrb">
            <div class="orb-ring"></div>
            <div class="orb-core"></div>
            <div class="orb-trace"></div>
          </div>
          <div class="orb-label" id="orbLabel">
            Waiting for conversation resonance…
          </div>
        </div>

        <div class="metric-row">
          <span class="label">Emotional Polarity (TM → BM)</span>
          <div class="meter">
            <div class="meter-fill" id="polarityFill"></div>
            <div class="meter-overlay"></div>
          </div>
        </div>

        <div class="metric-row">
          <span class="label">Continuity / Meaningfulness</span>
          <div class="meter">
            <div class="meter-fill" id="continuityFill" style="width:30%"></div>
            <div class="meter-overlay"></div>
          </div>
        </div>

        <div class="banner neutral" id="reactorBanner">
          <span>⊙</span>
          <span id="reactorBannerText">
            Talk naturally. If a clear idea, decision, or emotional shift appears, the reactor will suggest saving it into BM.
          </span>
        </div>
      </section>

      <!-- Conversation + answer -->
      <section class="panel">
        <h2>CONVERSATION & ANSWER <span class="sub">TM window + Aura-X Ω reply</span></h2>
        <div class="conversation-log" id="conversationLog"></div>

        <div class="answer-box" id="answerBox">
          <div class="answer-box-header">
            <span>Current Answer · AURA-X Ω</span>
            <span class="badge" id="answerBadge">Rules-only</span>
          </div>
          <div class="answer-text" id="answerText">
            Ask anything you like. First answers are rule-based. If LLM is enabled and safe, it will add extra reasoning.
          </div>
        </div>
      </section>

      <!-- BM episodes -->
      <aside class="panel">
        <h2>BM EPISODES <span class="sub">Saved continuity anchors</span></h2>
        <div class="bm-list" id="bmList">
          <!-- Episodes rendered here -->
        </div>
      </aside>
    </div>

    <!-- Input / TM box -->
    <div class="input-block">
      <div class="formula-hint">
        TM = last few turns of (user input + Aura-X Ω reply). Only meaningful clusters promote into BM episodes.
      </div>
      <div class="input-row">
        <textarea id="userInput" placeholder="Type your message…"></textarea>
        <button class="btn-send" id="sendBtn">
          <span>Send</span> ➤
        </button>
      </div>
    </div>
  </div>

  <!-- LLM SETTINGS MODAL -->
  <div id="llmModal" class="modal-overlay hidden">
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <h3>LLM SETTINGS</h3>
          <p>
            Optional helper LLM. Aura-X Ω first follows its own rules. If LLM is enabled, it adds extra suggestions.
          </p>
        </div>
        <button class="modal-close" id="closeLlmModal">✕</button>
      </div>

      <div class="field">
        <label for="providerSelect">Provider preset</label>
        <select id="providerSelect">
          <option value="openai">OpenAI compatible (e.g. api.openai.com)</option>
          <option value="deepseek">DeepSeek</option>
          <option value="custom">Custom base URL</option>
        </select>
        <small>Pick a preset to auto-fill base URL and model. You can still edit manually.</small>
      </div>

      <div class="field">
        <label for="baseUrlInput">Base URL (chat completions endpoint)</label>
        <input id="baseUrlInput" placeholder="https://api.openai.com/v1/chat/completions" />
      </div>

      <div class="field">
        <label for="modelInput">Model name</label>
        <input id="modelInput" placeholder="gpt-4.1-mini / deepseek-chat / etc." />
      </div>

      <div class="field">
        <label for="apiKeyInput">API key</label>
        <input id="apiKeyInput" placeholder="sk-..." />
        <small>Key is stored only in this page (browser memory). No server or database.</small>
      </div>

      <div class="field">
        <label>Offline model status (WebLLM)</label>
        <small id="offlineStatusText" class="offline-status">
          Preparing…
        </small>
      </div>

      <div class="modal-footer">
        <div id="llmStatusText">
          LLM is currently <strong>disabled</strong>. Use the “LLM: OFF/ON” chip in the header to toggle.
        </div>
        <button class="btn-primary-mini" id="saveLlmConfig">Save</button>
      </div>
    </div>
  </div>

  <script>
    // ========= STATE =========
    const state = {
      messages: [],        // {role:'user'|'aura', text, ts}
      bmEpisodes: [],      // {id,title,summary,polarity,intensity,createdAt}
      nextEpisodeId: 1,
      useLLM: false,
      lastAnswerWasLLM: false,
    };

    const llmConfig = {
      provider: "openai",
      baseUrl: "https://api.openai.com/v1/chat/completions",
      model: "gpt-4.1-mini",
      apiKey: ""
    };

    // ========= DOM =========
    const conversationLogEl = document.getElementById("conversationLog");
    const bmListEl          = document.getElementById("bmList");
    const reactorStateLabel = document.getElementById("reactorStateLabel");
    const orbLabel          = document.getElementById("orbLabel");
    const polarityFill      = document.getElementById("polarityFill");
    const continuityFill    = document.getElementById("continuityFill");
    const reactorBanner     = document.getElementById("reactorBanner");
    const reactorBannerText = document.getElementById("reactorBannerText");
    const btnToggleLLM      = document.getElementById("btnToggleLLM");
    const answerTextEl      = document.getElementById("answerText");
    const answerBadgeEl     = document.getElementById("answerBadge");
    const userInputEl       = document.getElementById("userInput");
    const sendBtn           = document.getElementById("sendBtn");
    const btnLLMSettings    = document.getElementById("btnLLMSettings");
    const llmModal          = document.getElementById("llmModal");
    const closeLlmModal     = document.getElementById("closeLlmModal");
    const providerSelect    = document.getElementById("providerSelect");
    const baseUrlInput      = document.getElementById("baseUrlInput");
    const modelInput        = document.getElementById("modelInput");
    const apiKeyInput       = document.getElementById("apiKeyInput");
    const llmStatusText     = document.getElementById("llmStatusText");
    const offlineStatusText = document.getElementById("offlineStatusText");

    // ========= UTIL =========
    function ts(){
      return new Date().toISOString();
    }

    function addMessage(role,text){
      state.messages.push({role,text,ts:ts()});
      // keep TM window at ~10 messages
      if(state.messages.length>20){
        state.messages.splice(0,state.messages.length-20);
      }
      renderConversation();
      updateReactor();
    }

    function renderConversation(){
      conversationLogEl.innerHTML = "";
      state.messages.forEach(msg=>{
        const row = document.createElement("div");
        row.className = "msg msg-" + (msg.role==="user"?"user":"aura");

        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = msg.role==="user" ? "U" : "Ω";

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.innerHTML = `
          <div>${escapeHtml(msg.text)}</div>
          <small>${new Date(msg.ts).toLocaleTimeString()}</small>
        `;

        if(msg.role==="user"){
          row.appendChild(bubble);
          row.appendChild(avatar);
        }else{
          row.appendChild(avatar);
          row.appendChild(bubble);
        }
        conversationLogEl.appendChild(row);
      });
      conversationLogEl.scrollTop = conversationLogEl.scrollHeight;
    }

    function escapeHtml(str){
      return str.replace(/[&<>]/g,ch=>({ "&":"&amp;","<":"&lt;",">":"&gt;" }[ch]));
    }

    // Simple sentiment-ish estimation
    const positiveWords = ["thank","thanks","grateful","hope","happy","excited","good","great","love","positive","clear","calm"];
    const negativeWords = ["sad","angry","upset","tired","hate","bad","worried","afraid","anxious","confused","stress","stressed"];

    function estimatePolarity(text){
      const lower = text.toLowerCase();
      let pos = 0, neg = 0;
      positiveWords.forEach(w=>{ if(lower.includes(w)) pos++; });
      negativeWords.forEach(w=>{ if(lower.includes(w)) neg++; });
      if(pos===0 && neg===0) return 0;
      return (pos-neg) / (pos+neg);
    }

    function updateReactor(){
      const recent = state.messages.slice(-6);
      const joined = recent.map(m=>m.text).join(" ");
      const polarity = estimatePolarity(joined);
      const continuity = Math.min(1, joined.length/400); // crude

      const polarityPercent = 50 + polarity * 50; // 0..100
      polarityFill.style.width = Math.max(5, Math.min(95, polarityPercent)) + "%";

      const continuityPercent = 20 + continuity*70;
      continuityFill.style.width = Math.max(10, Math.min(95, continuityPercent)) + "%";

      let bannerMode = "neutral";
      let bannerText = "Steady. If a clear idea or decision appears, I'll propose a BM episode.";
      let stateLabel = "IDLE · NEUTRAL";

      if(polarity>0.2){
        bannerMode = "good";
        bannerText = "Positive drift detected. We can crystallize this into a BM anchor if it feels important.";
        stateLabel = "ASCENDING · POSITIVE";
      }else if(polarity<-0.2){
        bannerMode = "bad";
        bannerText = "Some negative load detected. Let's slow down, normalize feelings, and gently move toward safer options.";
        stateLabel = "ALERT · NEGATIVE DRIFT";
      }

      reactorBanner.classList.remove("good","bad","neutral");
      reactorBanner.classList.add(bannerMode);
      reactorBannerText.textContent = bannerText;
      reactorStateLabel.textContent = stateLabel;

      if(recent.length===0){
        orbLabel.textContent = "Waiting for conversation resonance…";
      }else{
        orbLabel.textContent = "TM window active · "+recent.length+" turns in play.";
      }
    }

    function maybeCreateEpisode(userText, auraText){
      const tmSnippet = state.messages.slice(-6);
      const combined = tmSnippet.map(m=>m.text).join(" ");
      const sentenceCount = combined.split(/[.!?،؟]+/).filter(s=>s.trim().length>0).length;

      if(sentenceCount < 4) return; // too short / small talk

      // crude "meaningful" trigger: contains decision / plan / feeling words
      const triggerWords = ["plan","decision","decide","strategy","future","goal","idea","project","fear","worry","hope","dream"];
      const lower = combined.toLowerCase();
      const triggered = triggerWords.some(w=>lower.includes(w));
      if(!triggered) return;

      const polarity = estimatePolarity(combined);
      const intensity = Math.min(1, Math.max(0, combined.length/600));
      const title =
        polarity>0.2 ? "Positive step / hopeful insight" :
        polarity<-0.2 ? "Tension / concern surfaced" :
        "Neutral but important reflection";

      const summary = combined.length>260 ? combined.slice(0,240)+"…" : combined;

      const episode = {
        id: state.nextEpisodeId++,
        title,
        summary,
        polarity,
        intensity,
        createdAt: ts()
      };
      state.bmEpisodes.unshift(episode);
      if(state.bmEpisodes.length>12) state.bmEpisodes.pop();
      renderEpisodes();
    }

    function renderEpisodes(){
      bmListEl.innerHTML = "";
      if(state.bmEpisodes.length===0){
        bmListEl.innerHTML = `<div style="font-size:0.75rem;color:#6b7280;">
          No BM episodes yet. When a conversation cluster becomes meaningful,
          Aura-X Ω will propose an episode here.
        </div>`;
        return;
      }
      state.bmEpisodes.forEach(ep=>{
        const box = document.createElement("div");
        box.className = "episode";
        const polarityLabel =
          ep.polarity>0.2 ? "Positive" :
          ep.polarity<-0.2 ? "Negative" : "Mixed";
        const intensityPercent = Math.round(ep.intensity*100);

        box.innerHTML = `
          <div class="episode-header">
            <span>#${ep.id}</span>
            <span>${new Date(ep.createdAt).toLocaleTimeString()}</span>
          </div>
          <div class="episode-title">${escapeHtml(ep.title)}</div>
          <div style="margin-top:4px;">${escapeHtml(ep.summary)}</div>
          <div class="episode-meta">
            <span>Polarity: ${polarityLabel}</span>
            <span>Intensity: ${intensityPercent}%</span>
          </div>
        `;
        bmListEl.appendChild(box);
      });
    }

    // ========= RULE-BASED ANSWER =========
    function ruleBasedAnswer(userText){
      const lower = userText.toLowerCase();
      let base = "";

      if(lower.includes("who are you") || lower.includes("what are you")){
        base = "I am AURA-X Ω, an experimental dual-memory prototype created conceptually by Alim ul Haq from Pakistan. "+
               "My job is to keep emotional continuity over time by balancing TM (conversation window) and BM (long-term anchors).";
      }else if(lower.includes("bm") || lower.includes("bold memory")){
        base = "BM (Bold Memory) is where we save meaningful episodes: decisions, turning points, or strong emotional shifts. "+
               "Short or random talk stays in TM only. When something feels important and stable, we convert it into a BM episode.";
      }else if(lower.includes("tm")){
        base = "TM (Temporary Memory) is the live conversation window — the last few turns between you and me. "+
               "I analyse TM for polarity, intensity, and structure, and only promote useful patterns into BM.";
      }else if(lower.includes("sad") || lower.includes("depress") || lower.includes("anxious") || lower.includes("worry")){
        base = "I can feel from your words that there is some emotional weight here. "+
               "First, let's slow down and name what is bothering you in simple language. "+
               "Then we can look for one small, safe action that slightly reduces the pressure instead of trying to fix everything at once.";
      }else{
        base = "Let me respond using the continuity rules of AURA-X Ω. "+
               "I will try to keep your long-term emotional trajectory stable while still giving you a practical reply.";
      }

      const lastEpisode = state.bmEpisodes[0];
      if(lastEpisode){
        base += " Right now your latest BM episode is: \""+ lastEpisode.title +
                "\". If this new message connects with that theme, we can strengthen it instead of starting from zero.";
      }

      return base;
    }

    // ========= LLM CALL (offline first, online fallback) =========
    async function callLLM(promptText){
      const statusEl = llmStatusText;
      // 1) Try offline engine if available
      if(window.offlineLlmEngine){
        try{
          if(statusEl) statusEl.innerHTML = "Using <strong>offline WebLLM</strong>…";
          if(offlineStatusText) offlineStatusText.textContent = "Offline model is loaded. Answering locally in your browser.";
          const messages = [
            {
              role:"system",
              content:"You are Aura-X Ω's offline co-thinker (WebLLM). "+
                      "Follow Aura-X Ω ethics: avoid harmful instructions, respect emotional fragility, and keep replies grounded."
            },
            { role:"user", content: promptText }
          ];
          const result = await window.offlineLlmEngine.chat.completions.create({
            messages,
            temperature:0.7,
            max_tokens:450
          });
          const answer = result && result.choices && result.choices[0] &&
                         result.choices[0].message && result.choices[0].message.content;
          if(statusEl) statusEl.innerHTML = "Offline LLM answer ready.";
          if(answer) return answer.trim();
        }catch(err){
          console.error("Offline LLM error", err);
          if(offlineStatusText){
            offlineStatusText.textContent = "Offline model error; falling back to online / rules-only mode.";
          }
        }
      }

      // 2) If offline not available, use HTTP LLM if configured
      if(!llmConfig.apiKey || !llmConfig.baseUrl){
        if(statusEl) statusEl.innerHTML = "No API key / base URL. Staying in rules-only mode.";
        return null;
      }

      if(statusEl) statusEl.innerHTML = "Calling online LLM…";

      const payload = {
        model: llmConfig.model || "gpt-4.1-mini",
        messages: [
          {
            role:"system",
            content:"You are a helper LLM plugged inside AURA-X Ω. "+
                    "Respect its emotional-continuity rules. Give short, clear paragraphs. "+
                    "Avoid emojis unless the user uses them."
          },
          { role:"user", content: promptText }
        ],
        temperature:0.7,
        max_tokens:450
      };

      const url = llmConfig.baseUrl.endsWith("/v1/chat/completions")
        ? llmConfig.baseUrl
        : llmConfig.baseUrl.replace(/\/$/,"") + "/v1/chat/completions";

      const res = await fetch(url,{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":"Bearer "+llmConfig.apiKey
        },
        body:JSON.stringify(payload)
      });

      if(!res.ok){
        console.error("LLM HTTP error", res.status, await res.text());
        if(statusEl) statusEl.innerHTML = "LLM error "+res.status+". Staying with rules-only reply.";
        return null;
      }

      const data = await res.json();
      const answer = data.choices && data.choices[0] &&
                     data.choices[0].message && data.choices[0].message.content;
      if(statusEl) statusEl.innerHTML = "Online LLM answer ready.";
      return answer ? answer.trim() : null;
    }

    // ========= SEND HANDLER =========
    async function handleSend(){
      const text = userInputEl.value.trim();
      if(!text) return;
      userInputEl.value = "";
      addMessage("user",text);

      const rulesAnswer = ruleBasedAnswer(text);
      let finalAnswer = rulesAnswer;
      state.lastAnswerWasLLM = false;

      if(state.useLLM){
        const prompt = "User message: "+text+"\n\n"+
          "Recent TM messages:\n"+
          state.messages.map(m=>m.role.toUpperCase()+": "+m.text).join("\n")+
          "\n\nBM episodes:\n"+
          (state.bmEpisodes.map(ep=>"- "+ep.title+": "+ep.summary).join("\n") || "none yet")+
          "\n\nUsing these, extend the rule-based answer in a grounded and emotionally safe way.";

        try{
          const llmAnswer = await callLLM(prompt);
          if(llmAnswer){
            finalAnswer = rulesAnswer + "\n\n[LLM insight]\n" + llmAnswer;
            state.lastAnswerWasLLM = true;
          }
        }catch(e){
          console.error("LLM failure",e);
        }
      }

      addMessage("aura",finalAnswer);
      answerTextEl.textContent = finalAnswer;
      answerBadgeEl.textContent = state.useLLM && state.lastAnswerWasLLM ? "Rules + LLM" : "Rules-only";

      maybeCreateEpisode(text, finalAnswer);
    }

    // ========= LLM SETTINGS UI =========
    function refreshLlmChip(){
      if(state.useLLM){
        btnToggleLLM.classList.remove("llm-off");
        btnToggleLLM.classList.add("llm-on");
        btnToggleLLM.innerHTML = '<span class="dot"></span>LLM: ON';
      }else{
        btnToggleLLM.classList.remove("llm-on");
        btnToggleLLM.classList.add("llm-off");
        btnToggleLLM.innerHTML = '<span class="dot"></span>LLM: OFF';
      }
    }

    btnToggleLLM.addEventListener("click",()=>{
      state.useLLM = !state.useLLM;
      refreshLlmChip();
      llmStatusText.innerHTML = state.useLLM
        ? "LLM is <strong>enabled</strong>. If offline model is ready, it will be used first."
        : "LLM is <strong>disabled</strong>. Only rules-based reasoning will be used.";
    });

    btnLLMSettings.addEventListener("click",()=>{
      baseUrlInput.value = llmConfig.baseUrl;
      modelInput.value   = llmConfig.model;
      apiKeyInput.value  = llmConfig.apiKey;
      providerSelect.value = llmConfig.provider;
      llmModal.classList.remove("hidden");
    });
    closeLlmModal.addEventListener("click",()=>llmModal.classList.add("hidden"));
    llmModal.addEventListener("click",e=>{
      if(e.target===llmModal) llmModal.classList.add("hidden");
    });

    providerSelect.addEventListener("change",()=>{
      const v = providerSelect.value;
      llmConfig.provider = v;
      if(v==="openai"){
        baseUrlInput.value = "https://api.openai.com/v1/chat/completions";
        modelInput.value   = "gpt-4.1-mini";
      }else if(v==="deepseek"){
        baseUrlInput.value = "https://api.deepseek.com/v1/chat/completions";
        modelInput.value   = "deepseek-chat";
      }
    });

    document.getElementById("saveLlmConfig").addEventListener("click",()=>{
      llmConfig.baseUrl = baseUrlInput.value.trim() || llmConfig.baseUrl;
      llmConfig.model   = modelInput.value.trim()   || llmConfig.model;
      llmConfig.apiKey  = apiKeyInput.value.trim();
      llmModal.classList.add("hidden");
      llmStatusText.innerHTML = llmConfig.apiKey
        ? "API key saved. Toggle LLM ON when you want extra reasoning."
        : "API key not set. LLM will stay in rules-only mode.";
    });

    // ========= OTHER BUTTONS (light behaviour for now) =========
    document.getElementById("btnFaithLens").addEventListener("click",()=>{
      addMessage("aura",
        "Faith Lens: imagine every decision as a rope between present you and future you. "+
        "We only pull on the rope in directions that increase honesty, responsibility, and quiet courage."
      );
    });
    document.getElementById("btnHistory").addEventListener("click",()=>{
      addMessage("aura",
        "Conversation DNA: I don't just see single messages, I see repeating patterns — recurring fears, hopes, and projects. "+
        "Over time those patterns form your personal Conversation DNA code."
      );
    });
    document.getElementById("btnBMSnapshot").addEventListener("click",()=>{
      if(state.bmEpisodes.length===0){
        addMessage("aura","No BM episodes yet. After a few deeper turns, I'll propose your first BM snapshot.");
      }else{
        const titles = state.bmEpisodes.map(ep=>"#"+ep.id+" "+ep.title).join(" · ");
        addMessage("aura","Current BM snapshot: "+titles);
      }
    });

    // ========= INPUT EVENTS =========
    sendBtn.addEventListener("click",handleSend);
    userInputEl.addEventListener("keydown",e=>{
      if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        handleSend();
      }
    });

    // ========= INIT =========
    refreshLlmChip();
    renderEpisodes();
    updateReactor();
  </script>

  <!-- ========= OFFLINE WEBLLM MODULE (NO ALERT, JUST STATUS TEXT) ========= -->
  <script type="module">
    import { CreateMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

    const offlineStatus = document.getElementById("offlineStatusText");
    if (offlineStatus) {
      offlineStatus.textContent = "Loading WebLLM runtime…";
    }

    async function initOffline(){
      try{
        const modelId = "Llama-3.1-8B-Instruct-q4f32_1-MLC"; 
        const engine = await CreateMLCEngine(modelId,{
          initProgressCallback(progress){
            console.log("Offline LLM loading:", progress);
            if(!offlineStatus) return;
            if(progress.text){
              offlineStatus.textContent = progress.text;
            }else if(typeof progress.progress === "number"){
              offlineStatus.textContent =
                "Downloading offline model: "+Math.round(progress.progress*100)+"%";
            }
          }
        });
        window.offlineLlmEngine = engine;
        if(offlineStatus){
          offlineStatus.textContent =
            "Offline model ready ✅. Aura-X Ω will prefer WebLLM when LLM is ON.";
        }
      }catch(err){
        console.error("Error while loading offline model",err);
        if(offlineStatus){
          offlineStatus.textContent =
            "Error while loading offline model. Aura-X Ω will fall back to online / rules-only mode.";
        }
      }
    }

    if (document.readyState === "complete" || document.readyState === "interactive") {
      initOffline();
    } else {
      window.addEventListener("DOMContentLoaded", initOffline);
    }
  </script>
</body>
</html>