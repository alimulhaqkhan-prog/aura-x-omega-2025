<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Artificial Emotional Continuity (AEC v3.1)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      height: 100%;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }
    #app {
      width: 100%;
      max-width: 540px;
      height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo-orb {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #facc15, #e11d48 40%, #4f46e5 80%);
      box-shadow: 0 0 20px rgba(248, 250, 252, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 20px;
    }
    .header-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .header-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.04em;
    }
    .header-sub {
      font-size: 11px;
      color: #9ca3af;
    }

    /* Equation bar */
    .equation-card {
      border-radius: 14px;
      padding: 10px 12px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.6));
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.8);
      font-size: 11px;
    }
    .eq-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: #e5e7eb;
    }
    .eq-body {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono",
        "Courier New", monospace;
      font-size: 11px;
      color: #cbd5f5;
    }
    .eq-row {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      gap: 8px;
    }
    .eq-chip {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    .eq-value {
      font-size: 11px;
      font-weight: 600;
      color: #fbbf24;
    }

    /* Reaction card */
    .reaction-card {
      border-radius: 14px;
      padding: 10px 12px;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(15, 23, 42, 0.8));
      border: 1px solid rgba(52, 211, 153, 0.6);
      box-shadow: 0 10px 25px rgba(16, 185, 129, 0.35);
      font-size: 12px;
    }
    .reaction-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: #bbf7d0;
    }
    .reaction-meta {
      font-size: 11px;
      color: #a7f3d0;
      margin-bottom: 6px;
    }
    .reaction-text {
      font-size: 12px;
      line-height: 1.4;
      color: #e5e7eb;
      margin-bottom: 6px;
    }
    .reaction-foot {
      font-size: 10px;
      color: #9ca3af;
    }

    /* TM input */
    .input-card {
      border-radius: 14px;
      padding: 10px 12px 12px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.8);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .input-label {
      font-size: 11px;
      color: #9ca3af;
    }
    .input-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    .tm-input {
      flex: 1;
      min-height: 64px;
      max-height: 120px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #4b5563;
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 12px;
      resize: vertical;
    }
    .tm-input::placeholder {
      color: #6b7280;
      font-size: 11px;
    }
    .send-btn {
      padding: 10px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(34, 197, 94, 0.45);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Footer info */
    .footer-line {
      font-size: 10px;
      color: #6b7280;
      text-align: left;
    }
    .footer-line strong {
      color: #e5e7eb;
    }

    /* Top buttons */
    .top-buttons {
      display: flex;
      gap: 6px;
    }
    .top-btn {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
      font-size: 11px;
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    .top-btn span {
      font-size: 9px;
      color: #9ca3af;
    }

    /* Demo buttons bottom */
    .demo-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    .demo-btn {
      flex: 1;
      border-radius: 999px;
      padding: 10px 8px;
      border: none;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    .demo-btn.negative {
      background: radial-gradient(circle at 0 0, #f97316, #b91c1c);
      color: #fee2e2;
    }
    .demo-btn.positive {
      background: radial-gradient(circle at 0 0, #22c55e, #15803d);
      color: #dcfce7;
    }

    /* BM modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }
    .modal-backdrop.show {
      display: flex;
    }
    .modal {
      width: 100%;
      max-width: 520px;
      max-height: 90vh;
      background: #020617;
      border-radius: 18px;
      padding: 12px;
      border: 1px solid #1f2937;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      font-weight: 600;
    }
    .modal-close {
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 3px 8px;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
    }
    .modal-body {
      margin-top: 4px;
      overflow-y: auto;
      max-height: 70vh;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 11px;
    }
    .bm-item {
      border-radius: 12px;
      padding: 8px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(31, 41, 55, 0.9);
    }
    .bm-text {
      font-size: 11px;
      margin-bottom: 4px;
    }
    .bm-meta {
      font-size: 10px;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 4px;
    }
    .bm-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .bm-tag {
      font-size: 9px;
      border-radius: 999px;
      padding: 1px 5px;
      color: #020617;
    }
    .bm-tag.l1 { background: #bfdbfe; }
    .bm-tag.l2 { background: #fecaca; }
    .bm-tag.l3 { background: #fef08a; }
    .bm-tag.l4 { background: #ddd6fe; }
    .bm-tag.l5 { background: #bbf7d0; }
    .bm-tag.l6 { background: #fed7aa; }
    .bm-tag.l7 { background: #e5e7eb; }

    /* Options row (voice toggle etc.) */
    .options-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 10px;
      color: #9ca3af;
      margin-top: 4px;
      gap: 8px;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 38px;
      height: 20px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background-color: #4b5563;
      transition: 0.2s;
      border-radius: 999px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.2s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #22c55e;
    }
    input:checked + .slider:before {
      transform: translateX(16px);
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Header -->
    <div class="header">
      <div class="logo-orb">Œ©</div>
      <div class="header-text">
        <div class="header-title">AURA-X Œ© ¬∑ AEC v3.1</div>
        <div class="header-sub">
          TM‚ÄìBM Collision Reactor ¬∑ 7-Layer Bold Memory ¬∑ Live Emotional Continuity.
        </div>
      </div>
    </div>

    <!-- Top buttons -->
    <div class="top-buttons">
      <button class="top-btn" id="bmViewerBtn">
        üß† BM Viewer
        <span>L1‚ÄìL7 daily capsules</span>
      </button>
      <button class="top-btn" id="recallBtn">
        üîç Recall BM
        <span>Highest |E‚ÇÄ| trace</span>
      </button>
      <button class="top-btn" id="cleanupBtn">
        üßπ Cleanup 24h
        <span>Auto decay (1 day)</span>
      </button>
    </div>

    <!-- Equation card -->
    <div class="equation-card" id="equationCard">
      <div class="eq-title">EMOTIONAL CONTINUITY EQUATION</div>
      <div class="eq-body">
        E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)
      </div>
      <div class="eq-row">
        <div class="eq-chip">TM (Temporary Memory)</div>
        <div class="eq-chip">BM (Bold Memory ‚Äì 7 layers)</div>
      </div>
      <div class="eq-row">
        <div class="eq-chip">D (Distortion / Damage)</div>
        <div class="eq-chip">Œª_faith ¬∑ Œª_sys ¬∑ Œ£C‚Çú (Context)</div>
      </div>
      <div class="eq-row" style="margin-top:6px;">
        <div class="eq-chip">Live E‚ÇÄ</div>
        <div class="eq-value" id="eqE0Value">E‚ÇÄ ‚âà 0.00</div>
      </div>
    </div>

    <!-- Reaction card -->
    <div class="reaction-card" id="reactionCard">
      <div class="reaction-title">AURA-X Œ© REACTION</div>
      <div class="reaction-meta" id="reactionMeta">
        Polarity: Neutral ¬∑ Intensity: 0.00 ¬∑ Tone: Idle resonance.
      </div>
      <div class="reaction-text" id="reactionText">
        Describe any memory, story, or event. AURA-X Œ© will treat it as TM, collide
        it with your current BM state, and respond with a guided emotional continuity reaction.
      </div>
      <div class="reaction-foot" id="reactionFoot">
        Engine: TM ‚Üí BM ¬∑ Self-learning browser prototype ¬∑ Voice reaction enabled.
      </div>
      <div class="options-row">
        <span>üéß Voice reaction</span>
        <label class="switch">
          <input type="checkbox" id="voiceToggle" checked />
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <!-- TM input -->
    <div class="input-card">
      <div class="input-label">
        Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory).
      </div>
      <div class="input-row">
        <textarea
          id="tmInput"
          class="tm-input"
          placeholder="Example: When I was a child in New York, a dog bit me in the snow near a street light..."
        ></textarea>
        <button class="send-btn" id="sendBtn">
          <span>Send</span> <span>ü°¢</span>
        </button>
      </div>
      <div class="footer-line" id="statusLine">
        Prototype ¬∑ TM ‚Üí LLM(seed) ‚Üí BM (7-layer) ‚Üí E‚ÇÄ live. All memory stays in
        your browser <strong>localStorage</strong>.
      </div>
      <div class="demo-row">
        <button class="demo-btn negative" id="dogDemoBtn">
          üêí Dog Bite (Negative Demo)
        </button>
        <button class="demo-btn positive" id="lostChildDemoBtn">
          ‚ù§Ô∏è Lost Child (Positive Demo)
        </button>
      </div>
    </div>
  </div>

  <!-- BM Viewer modal -->
  <div class="modal-backdrop" id="bmModal">
    <div class="modal">
      <div class="modal-header">
        <span>üß† Bold Memory (BM Viewer)</span>
        <button class="modal-close" id="bmCloseBtn">Close</button>
      </div>
      <div class="modal-body" id="bmList"></div>
    </div>
  </div>

  <script>
    // =============================
    //  AURA-X Œ© STATE & SETTINGS
    // =============================

    const auraSettings = {
      voiceEnabled: true,
      voiceVolume: 1.0,
    };

    const STORAGE_KEY = "AURAX_BM_2025_V31";

    // Simple seed polarity engine (word-based)
    const positiveWords = [
      "love","loved","loving","safe","hug","hugged","warm","hope","hopeful","kind",
      "kindness","calm","peace","happy","happiness","smile","laugh","laughed","laughing",
      "beautiful","support","help","helped","forgive","forgiven","forgiveness"
    ];
    const negativeWords = [
      "hurt","hurting","bit","bite","bitten","afraid","fear","fearful","alone","cry",
      "crying","cried","angry","anger","shout","shouting","scream","screaming","sad",
      "sadness","pain","broken","dark","hate","hated","anxiety","panic","loss","lost"
    ];

    function loadBM() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch {
        return [];
      }
    }

    function saveBM(list) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      } catch (e) {
        console.error("BM save error", e);
      }
    }

    function nowIso() {
      return new Date().toISOString();
    }

    // =============================
    //  SIMPLE POLARITY ENGINE
    // =============================

    function classifyPolarity(text) {
      const lower = (text || "").toLowerCase();
      let posCount = 0;
      let negCount = 0;
      for (const w of positiveWords) {
        if (lower.includes(w)) posCount++;
      }
      for (const w of negativeWords) {
        if (lower.includes(w)) negCount++;
      }
      if (posCount === 0 && negCount === 0) {
        return { polarity: "neutral", ratioPos: 50, ratioNeg: 50 };
      }
      const total = posCount + negCount;
      const ratioPos = Math.round((posCount / total) * 100);
      const ratioNeg = 100 - ratioPos;
      const polarity = ratioPos > ratioNeg ? "positive" : ratioNeg > ratioPos ? "negative" : "mixed";
      return { polarity, ratioPos, ratioNeg };
    }

    // =============================
    //  AEC EQUATION
    // =============================

    function computeBMScore(node) {
      // 7-layer simple average; each L1‚ÄìL7 ‚àà [0,1]
      const layers = node.layers || {};
      const values = [
        layers.L1 || 0,
        layers.L2 || 0,
        layers.L3 || 0,
        layers.L4 || 0,
        layers.L5 || 0,
        layers.L6 || 0,
        layers.L7 || 0,
      ];
      const sum = values.reduce((a, b) => a + b, 0);
      return sum / values.length;
    }

    function computeTMScore(text) {
      if (!text) return 0;
      const len = text.trim().split(/\s+/).length;
      // 0‚Äì40 words ‚Üí 0‚Äì1
      return Math.max(0, Math.min(1, len / 40));
    }

    function computeDamage(polarity, ratioNeg) {
      if (polarity !== "negative") return 0;
      // More negative ‚Üí larger D in [0,0.8]
      return (ratioNeg / 100) * 0.8;
    }

    function computeFaithLens() {
      // Placeholder: neutral faith ‚Üí 0
      return 0;
    }

    function computeSysLens() {
      // Placeholder: mild stabilizing system lens
      return 0.02;
    }

    function computeContextTension(node) {
      // Very simple: recent memories slightly increase |Œ£C‚Çú|
      if (!node) return 0;
      const ageMs = Date.now() - new Date(node.timestamp).getTime();
      const dayMs = 24 * 60 * 60 * 1000;
      const ageDays = ageMs / dayMs;
      if (ageDays <= 0) return 0.05;
      if (ageDays > 7) return 0.01;
      return 0.05 - (ageDays / 7) * 0.04;
    }

    function computeE0(tmScore, bmScore, D, lambdaFaith, lambdaSys, contextT) {
      const x = tmScore * bmScore - D + lambdaFaith + lambdaSys + contextT;
      // tanh
      const e0 = Math.tanh(x);
      return e0;
    }

    // =============================
    //  BUILD BM NODE
    // =============================

    function buildLayersFromPolarity(polarity, intensity) {
      // intensity in [0,1] from |E0|
      const base = intensity || 0.3;
      if (polarity === "positive") {
        return {
          L1: 0.3 + base * 0.5, // sensory
          L2: 0.15,
          L3: 0.2,
          L4: 0.4 + base * 0.3,
          L5: 0.5 + base * 0.4,
          L6: 0.25,
          L7: 0.1 + base * 0.2,
        };
      } else if (polarity === "negative") {
        return {
          L1: 0.3 + base * 0.4,
          L2: 0.5 + base * 0.4,
          L3: 0.4 + base * 0.3,
          L4: 0.25,
          L5: 0.15,
          L6: 0.2 + base * 0.3,
          L7: 0.1,
        };
      } else {
        // neutral / mixed
        return {
          L1: 0.25,
          L2: 0.25,
          L3: 0.25,
          L4: 0.25,
          L5: 0.25,
          L6: 0.25,
          L7: 0.25,
        };
      }
    }

    function createBMNodeFromTM(text) {
      const { polarity, ratioPos, ratioNeg } = classifyPolarity(text);
      const tmScore = computeTMScore(text);

      const tempNode = {
        timestamp: nowIso(),
        tmText: text,
        polarity,
        ratioPos,
        ratioNeg,
        layers: buildLayersFromPolarity(polarity, 0.3),
      };

      const bmScore = computeBMScore(tempNode);
      const D = computeDamage(polarity, ratioNeg);
      const lambdaFaith = computeFaithLens();
      const lambdaSys = computeSysLens();
      const contextT = computeContextTension(tempNode);
      const E0 = computeE0(tmScore, bmScore, D, lambdaFaith, lambdaSys, contextT);

      const layersFinal = buildLayersFromPolarity(polarity, Math.abs(E0));

      return {
        timestamp: tempNode.timestamp,
        tmText: text,
        polarity,
        ratioPos,
        ratioNeg,
        tmScore,
        bmScore,
        D,
        lambdaFaith,
        lambdaSys,
        contextT,
        E0,
        layers: layersFinal,
      };
    }

    // =============================
    //  REACTION TEXT + VOICE
    // =============================

    function describeTone(polarity, E0) {
      const intensity = Math.abs(E0 || 0);
      if (polarity === "positive") {
        if (intensity < 0.2) return "Soft, stabilizing, hopeful resonance.";
        if (intensity < 0.6) return "Warm, supportive, growth-oriented resonance.";
        return "Bright, uplifting, high-continuity resonance.";
      } else if (polarity === "negative") {
        if (intensity < 0.2) return "Gentle caution with low negative charge.";
        if (intensity < 0.6) return "Firm warning against repeating this pattern.";
        return "Strong red-alert resonance. This path is emotionally damaging.";
      } else {
        if (intensity < 0.2) return "Neutral, observational resonance.";
        if (intensity < 0.6) return "Mixed, open-to-rewrite resonance.";
        return "Polarized but balanced resonance. Choose your next step carefully.";
      }
    }

    function buildReactionParagraph(node) {
      const { polarity, E0, tmText } = node;
      const tone = describeTone(polarity, E0);
      const polLabel =
        polarity === "positive"
          ? "positive"
          : polarity === "negative"
          ? "negative"
          : "mixed / neutral";

      const rounded = E0.toFixed(2);

      if (polarity === "positive") {
        return {
          tone,
          text:
            tmText +
            "\n\nI‚Äôve received your TM event and collided it with your current BM state. " +
            `Right now E‚ÇÄ ‚âà ${rounded} (range ‚àí1 to +1). This trace supports healing, gratitude, and emotional continuity. ` +
            "The more clearly you describe context, the stronger and cleaner your BM trace becomes.",
        };
      } else if (polarity === "negative") {
        return {
          tone,
          text:
            tmText +
            "\n\nThis TM event carries a negative resonance in the current BM field. " +
            `E‚ÇÄ ‚âà ${rounded}. AURA-X Œ© is asking you to gently step away from choices that reinforce this pattern. ` +
            "If you rewrite this memory with safer or kinder actions, future E‚ÇÄ will slowly move back toward stability.",
        };
      } else {
        return {
          tone,
          text:
            tmText +
            "\n\nThis TM event lands in a balanced or mixed range. " +
            `E‚ÇÄ ‚âà ${rounded}. With a few clearer details about intentions, support, or outcomes, ` +
            "AURA-X Œ© can help push this continuity toward calmer and more meaningful states.",
        };
      }
    }

    // ----- Voice mapping -----

    function buildVoiceConfigFromEmotion(e0, polarity) {
      const intensity = Math.abs(e0 || 0);
      let rate = 1.0;
      let pitch = 1.0;
      let volume = auraSettings.voiceVolume;

      if (polarity === "positive") {
        if (intensity < 0.2) {
          rate = 0.95;
          pitch = 1.05;
        } else if (intensity < 0.6) {
          rate = 1.02;
          pitch = 1.1;
        } else {
          rate = 1.12;
          pitch = 1.2;
        }
      } else if (polarity === "negative") {
        if (intensity < 0.2) {
          rate = 0.98;
          pitch = 0.95;
        } else if (intensity < 0.6) {
          rate = 0.9;
          pitch = 0.9;
        } else {
          rate = 0.82;   // thunder-warning style
          pitch = 0.8;
        }
      } else {
        rate = 1.0;
        pitch = 1.0;
      }

      return { rate, pitch, volume };
    }

    function buildSpokenReactionText(e0, polarity, toneDescription) {
      const rounded = e0.toFixed(2);
      if (polarity === "positive") {
        return `Emotional continuity is positive. Intensity ${rounded}. ${toneDescription} This memory supports calm, growth and hope.`;
      } else if (polarity === "negative") {
        return `Warning. Emotional continuity is negative. Intensity ${rounded}. ${toneDescription} Move away from actions that increase this feeling.`;
      } else {
        return `Emotional continuity is balanced around zero. ${toneDescription}`;
      }
    }

    function speakReaction(e0, polarity, toneDescription) {
      try {
        if (!auraSettings.voiceEnabled) return;
        if (!("speechSynthesis" in window)) return;

        const config = buildVoiceConfigFromEmotion(e0, polarity);
        const text = buildSpokenReactionText(e0, polarity, toneDescription || "");

        window.speechSynthesis.cancel();

        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = config.rate;
        utter.pitch = config.pitch;
        utter.volume = config.volume;

        const voices = window.speechSynthesis.getVoices();
        if (voices && voices.length > 0) {
          const preferred = voices.find((v) =>
            /male|urdu|en-gb|en-us/i.test(v.name + " " + v.lang)
          );
          if (preferred) utter.voice = preferred;
        }

        window.speechSynthesis.speak(utter);
      } catch (err) {
        console.error("AURA-X voice error:", err);
      }
    }

    // =============================
    //  RENDER FUNCTIONS
    // =============================

    const eqE0ValueEl = document.getElementById("eqE0Value");
    const reactionMetaEl = document.getElementById("reactionMeta");
    const reactionTextEl = document.getElementById("reactionText");
    const reactionFootEl = document.getElementById("reactionFoot");
    const statusLineEl = document.getElementById("statusLine");

    function renderAfterTM(node) {
      const polPretty =
        node.polarity === "positive"
          ? "Positive"
          : node.polarity === "negative"
          ? "Negative"
          : "Mixed / Neutral";

      const intensity = Math.abs(node.E0 || 0);
      const tone = describeTone(node.polarity, node.E0);
      const reaction = buildReactionParagraph(node);

      eqE0ValueEl.textContent = `E‚ÇÄ ‚âà ${node.E0.toFixed(2)}`;
      reactionMetaEl.textContent = `Polarity: ${polPretty} ¬∑ Intensity: ${intensity
        .toFixed(2)
        .toString()} ¬∑ Tone: ${tone}`;
      reactionTextEl.textContent = reaction.text;
      reactionFootEl.textContent = `E‚ÇÄ=${node.E0.toFixed(
        2
      )} ¬∑ TM=${node.tmScore.toFixed(2)} ¬∑ BM=${node.bmScore.toFixed(
        2
      )} ¬∑ D=${node.D.toFixed(2)} ¬∑ tag=${node.polarity}`;

      // Trigger voice
      speakReaction(node.E0, node.polarity, tone);
    }

    // =============================
    //  BM VIEWER
    // =============================

    const bmModalEl = document.getElementById("bmModal");
    const bmListEl = document.getElementById("bmList");
    const bmCloseBtn = document.getElementById("bmCloseBtn");

    function openBMViewer() {
      const list = loadBM().slice().sort((a, b) => (a.timestamp < b.timestamp ? 1 : -1));
      bmListEl.innerHTML = "";
      if (!list.length) {
        const empty = document.createElement("div");
        empty.textContent = "No BM traces stored yet. Send a TM event to start.";
        empty.style.fontSize = "11px";
        empty.style.color = "#9ca3af";
        bmListEl.appendChild(empty);
      } else {
        list.forEach((node) => {
          const item = document.createElement("div");
          item.className = "bm-item";

          const textDiv = document.createElement("div");
          textDiv.className = "bm-text";
          textDiv.textContent = node.tmText;
          item.appendChild(textDiv);

          const metaDiv = document.createElement("div");
          metaDiv.className = "bm-meta";
          const dateStr = new Date(node.timestamp).toLocaleString();
          metaDiv.innerHTML = `
            <span>${dateStr}</span>
            <span>E‚ÇÄ=${(node.E0 || 0).toFixed(2)} ¬∑ TM=${(node.tmScore || 0).toFixed(
            2
          )} ¬∑ BM=${(node.bmScore || 0).toFixed(2)}</span>
            <span>Polarity: ${node.polarity} (${node.ratioPos || 0} : ${
            node.ratioNeg || 0
          })</span>
          `;
          item.appendChild(metaDiv);

          const tagsDiv = document.createElement("div");
          tagsDiv.className = "bm-tags";
          const L = node.layers || {};
          for (let i = 1; i <= 7; i++) {
            const tag = document.createElement("span");
            tag.className = "bm-tag l" + i;
            tag.textContent = `L${i}:${Math.round((L["L" + i] || 0) * 100)}`;
            tagsDiv.appendChild(tag);
          }
          item.appendChild(tagsDiv);

          bmListEl.appendChild(item);
        });
      }
      bmModalEl.classList.add("show");
    }

    function closeBMViewer() {
      bmModalEl.classList.remove("show");
    }

    function recallTopBM() {
      const list = loadBM();
      if (!list.length) {
        statusLineEl.textContent =
          "No BM traces yet. Send a TM event first, then Recall can highlight the strongest continuity.";
        return;
      }
      let best = list[0];
      let bestScore = Math.abs(list[0].E0 || 0);
      for (const n of list) {
        const score = Math.abs(n.E0 || 0);
        if (score > bestScore) {
          best = n;
          bestScore = score;
        }
      }
      renderAfterTM(best);
      statusLineEl.textContent =
        "Recall BM: showing the stored memory with the strongest |E‚ÇÄ| resonance.";
    }

    function cleanup24h() {
      const list = loadBM();
      const cutoff = Date.now() - 24 * 60 * 60 * 1000;
      const filtered = list.filter(
        (n) => new Date(n.timestamp).getTime() >= cutoff
      );
      saveBM(filtered);
      statusLineEl.textContent =
        "Cleanup 24h: older traces have decayed. Recent BM is preserved to keep continuity fresh.";
    }

    // =============================
    //  TM HANDLING
    // =============================

    const tmInputEl = document.getElementById("tmInput");
    const sendBtnEl = document.getElementById("sendBtn");
    const dogDemoBtn = document.getElementById("dogDemoBtn");
    const lostChildDemoBtn = document.getElementById("lostChildDemoBtn");

    function handleTM(text) {
      if (!text || !text.trim()) return;
      const node = createBMNodeFromTM(text.trim());

      const list = loadBM();
      list.push(node);
      saveBM(list);

      renderAfterTM(node);
      tmInputEl.value = "";
      statusLineEl.textContent =
        "TM captured ‚Üí BM updated ‚Üí E‚ÇÄ recomputed. All continuity stays in your device.";
    }

    function handleDogDemo() {
      const text =
        "When I was a child in New York, a dog bit me in the snow near a street light. I still remember the cold wind, the barking sound, and my own fear.";
      handleTM(text);
    }

    function handleLostChildDemo() {
      const text =
        "A lost child was crying in a crowded market until he heard his mother‚Äôs voice. She ran to him, hugged him tightly, and both started laughing with tears of relief.";
      handleTM(text);
    }

    // =============================
    //  EVENTS & INIT
    // =============================

    document.getElementById("bmViewerBtn").addEventListener("click", openBMViewer);
    bmCloseBtn.addEventListener("click", closeBMViewer);
    document.getElementById("recallBtn").addEventListener("click", recallTopBM);
    document.getElementById("cleanupBtn").addEventListener("click", cleanup24h);

    sendBtnEl.addEventListener("click", () => {
      handleTM(tmInputEl.value);
    });

    tmInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        handleTM(tmInputEl.value);
      }
    });

    dogDemoBtn.addEventListener("click", handleDogDemo);
    lostChildDemoBtn.addEventListener("click", handleLostChildDemo);

    const voiceToggleEl = document.getElementById("voiceToggle");
    voiceToggleEl.checked = auraSettings.voiceEnabled;
    voiceToggleEl.addEventListener("change", () => {
      auraSettings.voiceEnabled = voiceToggleEl.checked;
      reactionFootEl.textContent = `E‚ÇÄ live ¬∑ Voice reaction ${
        auraSettings.voiceEnabled ? "ON" : "OFF"
      } ¬∑ All data stays in your browser.`;
      if (!auraSettings.voiceEnabled && window.speechSynthesis) {
        window.speechSynthesis.cancel();
      }
    });

    // Initial state
    statusLineEl.textContent =
      "Ready. Try one of the demo memories below, or write your own story in any language.";
  </script>
</body>
</html>
