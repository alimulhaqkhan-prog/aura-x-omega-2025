<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Offline LLM package (WebLLM, for in-browser models ‚Äì ready for future use) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    /* RESET & BASICS */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #020617 0, transparent 55%),
        linear-gradient(180deg,#000814,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:16px;
    }
    #app{
      width:min(980px,100%);
      background:linear-gradient(145deg,rgba(15,23,42,.98),rgba(15,23,42,.96));
      border-radius:24px;
      box-shadow:0 24px 80px rgba(0,0,0,.75);
      border:1px solid rgba(148,163,184,.35);
      overflow:hidden;
    }
    .shell{
      padding:18px 18px 16px;
    }
    h1{
      font-size:26px;
      letter-spacing:.14em;
      text-align:center;
      color:#bfdbfe;
      text-transform:uppercase;
      margin-bottom:4px;
    }
    .subtitle{
      text-align:center;
      font-size:13px;
      opacity:.8;
      margin-bottom:16px;
    }
    .pillBar{
      display:flex;
      justify-content:center;
      margin-bottom:14px;
    }
    .pillPrimary{
      padding:10px 18px;
      border-radius:999px;
      background:linear-gradient(90deg,#38bdf8,#22c55e);
      color:#022c22;
      font-weight:600;
      font-size:13px;
      box-shadow:0 0 0 1px rgba(15,23,42,.6),0 14px 30px rgba(15,118,110,.55);
    }

    .layout{
      display:grid;
      grid-template-columns:3fr 2fr;
      gap:14px;
    }
    @media(max-width:840px){
      .layout{
        grid-template-columns:1fr;
      }
    }

    .panel{
      background:radial-gradient(circle at top left,rgba(56,189,248,.16),transparent 55%),
                 radial-gradient(circle at bottom right,rgba(52,211,153,.12),transparent 55%),
                 rgba(15,23,42,.96);
      border-radius:18px;
      padding:12px 12px 10px;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:0 16px 35px rgba(15,23,42,.9);
      position:relative;
      overflow:hidden;
    }
    .panelHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .panelTitle{
      font-size:13px;
      font-weight:600;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:#93c5fd;
    }
    .badge{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .badge span.dot{
      width:8px;height:8px;border-radius:999px;
      background:radial-gradient(circle,#22c55e,#15803d);
      box-shadow:0 0 0 2px rgba(34,197,94,.4);
    }

    .ethicBox{
      margin-bottom:10px;
      border-radius:16px;
      padding:10px 12px;
      background:linear-gradient(90deg,rgba(234,179,8,.1),rgba(249,115,22,.16));
      border:1px solid rgba(250,204,21,.55);
      color:#fef3c7;
      font-size:13px;
      line-height:1.4;
    }

    .console{
      height:270px;
      background:radial-gradient(circle at top,rgba(30,64,175,.6),rgba(15,23,42,.96));
      border-radius:16px;
      border:1px solid rgba(30,64,175,.8);
      padding:10px 12px;
      overflow-y:auto;
      font-family:"JetBrains Mono","SF Mono",ui-monospace,monospace;
      font-size:12px;
      line-height:1.45;
      box-shadow:inset 0 0 0 1px rgba(15,23,42,.9);
      scrollbar-width:thin;
    }
    .console::-webkit-scrollbar{width:6px}
    .console::-webkit-scrollbar-thumb{
      background:rgba(148,163,184,.6);
      border-radius:999px;
    }
    .console .line{
      margin-bottom:4px;
      white-space:pre-wrap;
      word-wrap:break-word;
    }

    .consoleToolbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:8px;
      gap:6px;
      font-size:11px;
    }
    .eqCapsule{
      flex:1;
      border-radius:999px;
      padding:6px 10px;
      background:radial-gradient(circle at 0% 0%,rgba(56,189,248,.45),transparent 50%),
                 radial-gradient(circle at 100% 0%,rgba(34,197,94,.4),transparent 55%),
                 rgba(15,23,42,.96);
      border:1px solid rgba(56,189,248,.75);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      box-shadow:0 0 0 1px rgba(15,23,42,1),0 10px 20px rgba(15,23,42,.9);
    }
    .eqCapsule span.label{
      font-size:11px;
      opacity:.85;
    }
    .eqCapsule span.val{
      font-variant-numeric:tabular-nums;
      font-size:11px;
      padding:3px 7px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.7);
    }

    .optionsBtn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:rgba(15,23,42,.9);
      padding:6px 10px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }
    .optionsBtn span.icon{
      width:16px;height:16px;border-radius:999px;
      background:radial-gradient(circle,#38bdf8,#1d4ed8);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      color:#0b1120;
    }

    .inputRow{
      margin-top:10px;
      display:flex;
      align-items:flex-end;
      gap:8px;
    }
    textarea#userInput{
      flex:1;
      min-height:42px;
      max-height:120px;
      resize:vertical;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.8);
      padding:8px 10px;
      font-size:13px;
      background:rgba(15,23,42,.96);
      color:#e5e7eb;
      outline:none;
      box-shadow:0 0 0 1px rgba(15,23,42,1);
    }
    textarea#userInput::placeholder{color:rgba(148,163,184,.8)}
    button.sendBtn{
      border:none;
      border-radius:999px;
      padding:10px 18px;
      background:radial-gradient(circle at 0 0,#38bdf8,#0ea5e9);
      color:#0b1120;
      font-weight:600;
      font-size:13px;
      cursor:pointer;
      box-shadow:0 16px 35px rgba(8,47,73,.9);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .optionsMenu{
      position:absolute;
      top:42px;left:10px;
      background:rgba(15,23,42,.98);
      border-radius:14px;
      border:1px solid rgba(148,163,184,.9);
      box-shadow:0 18px 40px rgba(0,0,0,.8);
      padding:8px;
      font-size:12px;
      min-width:210px;
      z-index:30;
      display:none;
    }
    .optionsMenu.show{display:block}
    .menuItem{
      padding:7px 9px;
      border-radius:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
    }
    .menuItem:hover{
      background:rgba(30,64,175,.65);
    }
    .pill{
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      font-size:11px;
    }
    .pillOn{
      background:rgba(34,197,94,.15);
      border-color:rgba(34,197,94,.7);
      color:#bbf7d0;
    }
    .pillOff{
      background:rgba(30,64,175,.25);
      border-color:rgba(59,130,246,.7);
      color:#bfdbfe;
    }

    .secondaryPanelHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
    }
    .tabs{
      display:flex;
      gap:6px;
      font-size:11px;
    }
    .tabBtn{
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:rgba(15,23,42,.9);
      cursor:pointer;
      opacity:.75;
    }
    .tabBtn.active{
      background:radial-gradient(circle at 0 0,#38bdf8,#22c55e);
      color:#0b1120;
      opacity:1;
    }

    .sideBody{
      font-size:12px;
    }
    .sideBodySection{
      display:none;
    }
    .sideBodySection.active{display:block}

    .sectionLabel{
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      opacity:.7;
      margin-bottom:4px;
    }
    .intelList{
      max-height:150px;
      overflow-y:auto;
      background:rgba(15,23,42,.9);
      border-radius:10px;
      border:1px solid rgba(30,64,175,.7);
      padding:6px;
      margin-bottom:6px;
      scrollbar-width:thin;
    }
    .intelItem{
      padding:5px 6px;
      border-radius:8px;
      margin-bottom:4px;
      cursor:pointer;
    }
    .intelItem:hover{
      background:rgba(30,64,175,.7);
    }

    .bmSelectList{
      max-height:150px;
      overflow-y:auto;
      background:rgba(15,23,42,.96);
      border-radius:10px;
      border:1px solid rgba(30,64,175,.6);
      padding:6px;
      margin-bottom:6px;
      scrollbar-width:thin;
    }
    .bmCard{
      padding:6px;
      border-radius:8px;
      background:rgba(15,23,42,.95);
      border:1px solid rgba(55,65,81,.9);
      margin-bottom:4px;
    }

    .bmViewer{
      border-radius:10px;
      border:1px solid rgba(55,65,81,.9);
      padding:6px;
      background:rgba(15,23,42,.98);
      font-size:12px;
    }
    .bmViewer textarea,
    .bmViewer input{
      width:100%;
      border-radius:8px;
      border:1px solid rgba(71,85,105,.9);
      padding:5px 7px;
      background:rgba(15,23,42,1);
      color:#e5e7eb;
      font-size:12px;
      margin-bottom:5px;
    }

    .historyBox{
      max-height:190px;
      overflow-y:auto;
      background:rgba(15,23,42,.95);
      border-radius:10px;
      border:1px solid rgba(31,41,55,.9);
      padding:6px;
      font-size:11px;
      scrollbar-width:thin;
    }
    .historyRow{
      padding:4px 5px;
      border-bottom:1px dashed rgba(55,65,81,.7);
    }
    .historyRow:last-child{border-bottom:none}

    .equationLine{
      font-family:"JetBrains Mono","SF Mono",ui-monospace,monospace;
      font-size:11px;
      opacity:.8;
      text-align:center;
      margin-top:6px;
    }

    .modalBackdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.7);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:50;
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width:min(520px,100%);
      background:rgba(15,23,42,.98);
      border-radius:18px;
      border:1px solid rgba(148,163,184,.7);
      box-shadow:0 22px 60px rgba(0,0,0,.9);
      max-height:90vh;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalHeader{
      padding:10px 14px;
      border-bottom:1px solid rgba(31,41,55,.9);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .modalTitle{
      font-size:13px;
      font-weight:600;
    }
    .modalBody{
      padding:10px 14px 12px;
      overflow-y:auto;
      font-size:12px;
    }
    .closeX{
      border:none;
      background:none;
      color:#9ca3af;
      font-size:18px;
      cursor:pointer;
    }

    .faithChipRow{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
      margin-bottom:6px;
    }
    .faithChip{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:rgba(15,23,42,.98);
      font-size:11px;
      cursor:pointer;
    }
    .faithChip.active{
      background:radial-gradient(circle at 0 0,#facc15,#fb923c);
      color:#0b1120;
      border-color:rgba(245,158,11,.9);
    }

    .faithBubble{
      position:fixed;
      right:18px;
      bottom:18px;
      background:radial-gradient(circle at 0 0,#fbbf24,#f97316);
      padding:9px 12px;
      border-radius:999px;
      font-size:11px;
      color:#0b1120;
      display:none;
      align-items:center;
      gap:6px;
      box-shadow:0 18px 40px rgba(0,0,0,.9);
      cursor:pointer;
      z-index:40;
    }
    .faithBubble.show{display:flex}

    .kpiRow{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
      font-size:11px;
      opacity:.85;
    }
    .kpiRow span{
      padding:3px 6px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.9);
    }

  </style>
</head>
<body>
  <div id="app">
    <div class="shell">
      <h1>AURA-X Œ©</h1>
      <div class="subtitle">
        Offline emotional continuity engine (prototype)<br />
        TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory.
      </div>

      <div class="pillBar">
        <div class="pillPrimary">EMOTIONAL CONTINUITY ENGINE ‚Äî ACTIVE</div>
      </div>

      <div class="layout">
        <!-- LEFT: CONSOLE & INPUT -->
        <div class="panel">
          <div class="panelHeader">
            <div class="panelTitle">Conversation</div>
            <div class="badge">
              <span class="dot"></span>
              <span>AURA-X Œ© Prototype</span>
            </div>
          </div>

          <div class="ethicBox">
            Universal ethic: avoid actions that grow negative emotions in you or others.
            Move gently toward choices that increase shared positive feeling for everyone.
          </div>

          <div id="console" class="console">
            <!-- Empty at start; conversation will appear here -->
          </div>

          <div class="consoleToolbar">
            <div class="eqCapsule">
              <span class="label">E‚ÇÄ ¬∑ TM ¬∑ BM ¬∑ C</span>
              <span class="val" id="capsuleE0">E0: 0.000</span>
              <span class="val" id="capsuleTM">TM: 0.00</span>
              <span class="val" id="capsuleBM">BM: 0.00</span>
              <span class="val" id="capsuleC">C: 0.000</span>
            </div>
            <button id="btnOptions" class="optionsBtn">
              <span class="icon">‚öô</span>
              <span>Options</span>
            </button>
            <div id="optionsMenu" class="optionsMenu">
              <div class="menuItem" id="miVoice">
                <span>Voice</span>
                <span class="pill pillOn" id="voicePill">on</span>
              </div>
              <div class="menuItem" id="miLearn">
                <span>Self-learning</span>
                <span class="pill pillOn" id="learnPill">on</span>
              </div>
              <div class="menuItem" id="miIntel">
                <span>Intelligence</span>
                <span>‚ö°</span>
              </div>
              <div class="menuItem" id="miBM">
                <span>BM (bold memory)</span>
                <span>üß†</span>
              </div>
              <div class="menuItem" id="miHistory">
                <span>Conversation history</span>
                <span>üìú</span>
              </div>
              <div class="menuItem" id="miIdentity">
                <span>Identity</span>
                <span>ü™™</span>
              </div>
              <div class="menuItem" id="miFaith">
                <span>Faith / encouragement lens</span>
                <span>‚ú®</span>
              </div>
              <div class="menuItem" id="miLLM">
                <span>Online helper LLM</span>
                <span>üåê</span>
              </div>
              <div class="menuItem" id="miSeed">
                <span>Feed the seed (LaTeX)</span>
                <span>üå±</span>
              </div>
            </div>
          </div>

          <div class="inputRow">
            <textarea id="userInput" placeholder="Talk to AURA-X Œ©‚Ä¶ (TM = your inputs only)"></textarea>
            <button id="sendBtn" class="sendBtn">
              <span>Send</span> <span>‚ûú</span>
            </button>
          </div>

          <div class="equationLine">
            E‚ÇÄ = tanh( R(TM,BM) + I(TM) + I_intel + I_LLM ‚àí D + Œª_faith + Œª_sys + Œª_trc )
          </div>
        </div>

        <!-- RIGHT: SIDE PANELS -->
        <div class="panel">
          <div class="secondaryPanelHeader">
            <div class="panelTitle">Inner layers</div>
            <div class="tabs">
              <button class="tabBtn active" data-tab="intelTab">Intelligence</button>
              <button class="tabBtn" data-tab="bmTab">BM</button>
              <button class="tabBtn" data-tab="historyTab">History</button>
              <button class="tabBtn" data-tab="identityTab">Identity</button>
            </div>
          </div>

          <div class="sideBody">
            <!-- Intelligence -->
            <div id="intelTab" class="sideBodySection active">
              <div class="sectionLabel">Saved intelligence (Q‚ÜíA)</div>
              <input id="intelSearch" type="text" placeholder="Search questions‚Ä¶" style="margin-bottom:6px;padding:6px 8px;border-radius:10px;border:1px solid rgba(71,85,105,.9);background:rgba(15,23,42,1);color:#e5e7eb;font-size:12px;width:100%;" />
              <div id="intelList" class="intelList"></div>
              <div class="bmViewer" style="margin-top:4px;">
                <div style="font-weight:600;margin-bottom:4px;">Edit selected Q‚ÜíA</div>
                <textarea id="intelEditQ" placeholder="Question‚Ä¶"></textarea>
                <textarea id="intelEditA" placeholder="Answer‚Ä¶"></textarea>
                <input id="intelEditMeta" placeholder="Meta / tags (optional)" />
                <div style="display:flex;justify-content:flex-end;gap:6px;margin-top:4px;">
                  <button id="btnIntelDelete" style="font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(248,113,113,.8);background:rgba(127,29,29,.9);color:#fee2e2;cursor:pointer;">Delete</button>
                  <button id="btnIntelSave" style="font-size:11px;padding:4px 10px;border-radius:999px;border:1px solid rgba(56,189,248,.8);background:rgba(15,23,42,1);color:#e0f2fe;cursor:pointer;">Save</button>
                </div>
              </div>
            </div>

            <!-- BM -->
            <div id="bmTab" class="sideBodySection">
              <div class="sectionLabel">Bold memory (BM) stories</div>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                <button id="btnNewBM" style="font-size:11px;padding:4px 9px;border-radius:999px;border:1px solid rgba(56,189,248,.8);background:rgba(15,23,42,1);color:#e0f2fe;cursor:pointer;">+ New BM</button>
                <input id="bmDateFilter" type="date" style="font-size:11px;padding:3px 6px;border-radius:999px;border:1px solid rgba(71,85,105,.9);background:rgba(15,23,42,1);color:#e5e7eb;" />
              </div>
              <div id="bmSelectList" class="bmSelectList"></div>
              <div id="bmViewer" class="bmViewer" style="display:none;margin-top:4px;">
                <div style="font-weight:600;margin-bottom:4px;">BM details</div>
                <input id="bmTitle" placeholder="Title‚Ä¶" />
                <textarea id="bmText" placeholder="Story / memory text‚Ä¶"></textarea>
                <textarea id="bmEvidence" placeholder="Evidence / proof note (optional)‚Ä¶"></textarea>
                <div style="display:flex;flex-wrap:wrap;gap:6px;margin:4px 0;">
                  <label style="font-size:11px;display:flex;align-items:center;gap:4px;">
                    <input type="checkbox" id="bmLocked" /> locked
                  </label>
                  <label style="font-size:11px;display:flex;align-items:center;gap:4px;">
                    <input type="checkbox" id="bmLive" /> live for next 12h
                  </label>
                </div>
                <div style="display:flex;justify-content:flex-end;gap:6px;margin-top:4px;">
                  <button id="btnBMDelete" style="font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(248,113,113,.8);background:rgba(127,29,29,.9);color:#fee2e2;cursor:pointer;">Delete</button>
                  <button id="btnBMSave" style="font-size:11px;padding:4px 10px;border-radius:999px;border:1px solid rgba(56,189,248,.8);background:rgba(15,23,42,1);color:#e0f2fe;cursor:pointer;">Save</button>
                </div>
              </div>
            </div>

            <!-- History -->
            <div id="historyTab" class="sideBodySection">
              <div class="sectionLabel">Conversation history</div>
              <div class="historyBox" id="historyBox"></div>
              <div style="display:flex;justify-content:space-between;gap:6px;margin-top:6px;">
                <button id="btnClear48h" style="font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(251,191,36,.8);background:rgba(120,53,15,.95);color:#fffbeb;cursor:pointer;">Delete last 48h</button>
                <button id="btnClearAllHist" style="font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(248,113,113,.8);background:rgba(127,29,29,.95);color:#fee2e2;cursor:pointer;">Delete all</button>
              </div>
            </div>

            <!-- Identity -->
            <div id="identityTab" class="sideBodySection">
              <div class="sectionLabel">User identity (deep profiling)</div>
              <div class="bmViewer">
                <div style="font-weight:600;margin-bottom:4px;">Core identity</div>
                <input id="idName" placeholder="Your name (optional)" />
                <textarea id="idStory" placeholder="Short life story / background‚Ä¶"></textarea>
                <textarea id="idValues" placeholder="Core values, hopes, fears‚Ä¶"></textarea>
                <textarea id="idLegacy" placeholder="If one day this system speaks for you, what should it remember most?"></textarea>
                <div style="display:flex;justify-content:flex-end;gap:6px;margin-top:4px;">
                  <button id="btnIdReset" style="font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.8);background:rgba(15,23,42,1);color:#e5e7eb;cursor:pointer;">Reset</button>
                  <button id="btnIdSave" style="font-size:11px;padding:4px 10px;border-radius:999px;border:1px solid rgba(56,189,248,.8);background:rgba(15,23,42,1);color:#e0f2fe;cursor:pointer;">Save</button>
                </div>
              </div>
              <div class="kpiRow" id="identityKpiRow"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="equationLine" style="margin-top:10px;">
        Offline LLM (future) ¬∑ Local-only memory ¬∑ Faith lens optional ¬∑ No server logging.
      </div>
    </div>
  </div>

  <!-- Faith bubble -->
  <div id="faithBubble" class="faithBubble">
    <span>‚ú® Faith reflection available ‚Äì tap to open.</span>
  </div>

  <!-- Modals: Seed, Faith, LLM, etc. -->

  <div id="modalSeed" class="modalBackdrop">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle">üå± Feed the seed (protected)<br><small>Add LaTeX Q ‚Üí A blocks directly into intelligence memory.</small></div>
        <button class="closeX" data-close="modalSeed">√ó</button>
      </div>
      <div class="modalBody">
        <div style="opacity:.75;font-size:13px;line-height:1.35;margin-bottom:10px">
          Paste a LaTeX block with \item questions and \textbf{A:} answers. You can optionally start each answer with
          <span style="font-family:ui-monospace">[polarity=positive; code=E031; intensity=0.8]</span>.
        </div>
        <textarea id="seedBox"
          style="width:100%;min-height:150px;resize:vertical;border-radius:12px;border:1px solid rgba(55,65,81,.9);padding:12px;font-size:14px;outline:none;background:#fff"
          placeholder="Paste LaTeX conversation / logic block here..."></textarea>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
          <div id="seedHint" style="font-size:11px;opacity:.75;">Waiting for block‚Ä¶</div>
          <div style="display:flex;gap:6px;">
            <button id="btnParseSeed" style="font-size:11px;padding:4px 9px;border-radius:999px;border:1px solid rgba(59,130,246,.8);background:#0f172a;color:#dbeafe;cursor:pointer;">Parse block</button>
            <button id="btnSaveSeed" style="font-size:11px;padding:4px 9px;border-radius:999px;border:1px solid rgba(34,197,94,.8);background:#022c22;color:#bbf7d0;cursor:pointer;">Save to seed</button>
            <button id="btnDiscardSeed" style="font-size:11px;padding:4px 9px;border-radius:999px;border:1px solid rgba(248,113,113,.8);background:#7f1d1d;color:#fee2e2;cursor:pointer;">Discard</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Faith lens modal -->
  <div id="modalFaith" class="modalBackdrop">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle">‚ú® AURA-X Œ© options<br><small>Optional faith lens for encouragement lines.</small></div>
        <button class="closeX" data-close="modalFaith">√ó</button>
      </div>
      <div class="modalBody">
        <div style="font-size:13px;line-height:1.4;margin-bottom:6px;">
          Universal ethics are always active. You can optionally pick one or more faith lenses. Nothing is sent to any server.
        </div>
        <div class="faithChipRow" id="faithChipRow"></div>
        <div style="font-size:11px;opacity:.8;margin-top:6px;">
          These settings only affect short encouragement lines, not the factual core answer.
        </div>
      </div>
    </div>
  </div>

  <!-- LLM modal -->
  <div id="modalLLM" class="modalBackdrop">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle">üåê Online helper LLM<br><small>Optional API for deeper answers (not required).</small></div>
        <button class="closeX" data-close="modalLLM">√ó</button>
      </div>
      <div class="modalBody">
        <div style="font-size:12px;line-height:1.4;margin-bottom:8px;">
          If you want, you can connect an external LLM API (like a standard chat completion endpoint).
          Your emotional continuity layers (TM, BM, faith lens) will still stay local in this browser.
        </div>
        <input id="llmEndpoint" placeholder="Endpoint URL (https://‚Ä¶)" />
        <input id="llmModel" placeholder="Model name (e.g., gpt-4.1-mini)" />
        <input id="llmKey" placeholder="API key (stored only in this session)" />
        <div style="display:flex;justify-content:flex-end;gap:6px;margin-top:8px;">
          <button id="btnLLMReset" style="font-size:11px;padding:4px 9px;border-radius:999px;border:1px solid rgba(148,163,184,.8);background:#0f172a;color:#e5e7eb;cursor:pointer;">Reset</button>
          <button id="btnLLMSave" style="font-size:11px;padding:4px 10px;border-radius:999px;border:1px solid rgba(56,189,248,.8);background:#0f172a;color:#dbeafe;cursor:pointer;">Save</button>
        </div>
        <div style="font-size:11px;opacity:.8;margin-top:10px;">
          Status:
          <span id="llmStatus">offline only</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Faith article modal -->
  <div id="modalFaithArticle" class="modalBackdrop">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle">‚ú® Faith reflection</div>
        <button class="closeX" data-close="modalFaithArticle">√ó</button>
      </div>
      <div class="modalBody">
        <div id="faithArticleTitle" style="font-weight:600;margin-bottom:4px;"></div>
        <div id="faithArticleText" style="font-size:12px;line-height:1.5;"></div>
        <div style="display:flex;justify-content:flex-end;gap:6px;margin-top:10px;">
          <button id="btnAddFaithToBM" style="font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(56,189,248,.8);background:#0f172a;color:#dbeafe;cursor:pointer;">Attach to BM</button>
          <button id="btnSkipFaithBM" style="font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.8);background:#0f172a;color:#e5e7eb;cursor:pointer;">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const KEY_CFG   = "aurax_cfg_v11";
      const KEY_INT   = "aurax_intel_v11";
      const KEY_BM    = "aurax_bm_v11";
      const KEY_HIST  = "aurax_hist_v11";
      const KEY_USER  = "aurax_user_v11";
      const OFFLINE_MODEL_ID = "Llama-3-8B-Instruct-q4f32_1-MLC";

      const els = {
        console: document.getElementById("console"),
        btnOptions: document.getElementById("btnOptions"),
        optionsMenu: document.getElementById("optionsMenu"),
        miVoice: document.getElementById("miVoice"),
        miIntel: document.getElementById("miIntel"),
        miLearn: document.getElementById("miLearn"),
        miBM: document.getElementById("miBM"),
        miHistory: document.getElementById("miHistory"),
        miIdentity: document.getElementById("miIdentity"),
        miFaith: document.getElementById("miFaith"),
        miLLM: document.getElementById("miLLM"),
        miSeed: document.getElementById("miSeed"),
        voicePill: document.getElementById("voicePill"),
        learnPill: document.getElementById("learnPill"),
        userInput: document.getElementById("userInput"),
        sendBtn: document.getElementById("sendBtn"),
        capsuleE0: document.getElementById("capsuleE0"),
        capsuleTM: document.getElementById("capsuleTM"),
        capsuleBM: document.getElementById("capsuleBM"),
        capsuleC: document.getElementById("capsuleC"),
        intelTab: document.getElementById("intelTab"),
        bmTab: document.getElementById("bmTab"),
        historyTab: document.getElementById("historyTab"),
        identityTab: document.getElementById("identityTab"),
        historyBox: document.getElementById("historyBox"),
        modalSeed: document.getElementById("modalSeed"),
        seedBox: document.getElementById("seedBox"),
        seedHint: document.getElementById("seedHint"),
        btnParseSeed: document.getElementById("btnParseSeed"),
        btnSaveSeed: document.getElementById("btnSaveSeed"),
        btnDiscardSeed: document.getElementById("btnDiscardSeed"),
        faithChipRow: document.getElementById("faithChipRow"),
        modalFaith: document.getElementById("modalFaith"),
        modalLLM: document.getElementById("modalLLM"),
        llmEndpoint: document.getElementById("llmEndpoint"),
        llmModel: document.getElementById("llmModel"),
        llmKey: document.getElementById("llmKey"),
        btnLLMReset: document.getElementById("btnLLMReset"),
        btnLLMSave: document.getElementById("btnLLMSave"),
        llmStatus: document.getElementById("llmStatus"),
        intelList: document.getElementById("intelList"),
        intelSearch: document.getElementById("intelSearch"),
        intelEditQ: document.getElementById("intelEditQ"),
        intelEditA: document.getElementById("intelEditA"),
        intelEditMeta: document.getElementById("intelEditMeta"),
        btnIntelSave: document.getElementById("btnIntelSave"),
        btnIntelDelete: document.getElementById("btnIntelDelete"),
        bmSelectList: document.getElementById("bmSelectList"),
        bmViewer: document.getElementById("bmViewer"),
        bmTitle: document.getElementById("bmTitle"),
        bmText: document.getElementById("bmText"),
        bmEvidence: document.getElementById("bmEvidence"),
        bmLocked: document.getElementById("bmLocked"),
        bmLive: document.getElementById("bmLive"),
        btnBMSave: document.getElementById("btnBMSave"),
        btnBMDelete: document.getElementById("btnBMDelete"),
        bmDateFilter: document.getElementById("bmDateFilter"),
        btnNewBM: document.getElementById("btnNewBM"),
        btnClear48h: document.getElementById("btnClear48h"),
        btnClearAllHist: document.getElementById("btnClearAllHist"),
        idName: document.getElementById("idName"),
        idStory: document.getElementById("idStory"),
        idValues: document.getElementById("idValues"),
        idLegacy: document.getElementById("idLegacy"),
        btnIdSave: document.getElementById("btnIdSave"),
        btnIdReset: document.getElementById("btnIdReset"),
        identityKpiRow: document.getElementById("identityKpiRow"),
        faithBubble: document.getElementById("faithBubble"),
        modalFaithArticle: document.getElementById("modalFaithArticle"),
        faithArticleTitle: document.getElementById("faithArticleTitle"),
        faithArticleText: document.getElementById("faithArticleText"),
        btnAddFaithToBM: document.getElementById("btnAddFaithToBM"),
        btnSkipFaithBM: document.getElementById("btnSkipFaithBM")
      };

      const faithOptions = {
        none: [],
        islam: [{
          id: "islam_generic",
          title: "Sabr, tawakkul, and intention",
          short: "Holding pain with patience and trust.",
          content:
            "In many Islamic reflections, hardship is held together with sabr (patience) and tawakkul (trust). " +
            "You might ask: what intention keeps my heart clean here, and what response brings me closer to justice and mercy?"
        }],
        christianity: [{
          id: "christian_generic",
          title: "Hope, grace, and carrying one another",
          short: "Seeing pain through the lens of hope and shared burden.",
          content:
            "Many Christian reflections emphasise that no one carries their cross alone. " +
            "Moments of weakness and grief are also places where grace, support from others, and inner renewal can appear. " +
            "You may ask: where is love inviting me to be honest, forgiven, and more gentle with myself and others?"
        }]
      };

      let state = {
        voiceOn: true,
        learningOn: true,
        faithSelection: [],
        intelligence: [],
        bmPrompts: [],
        history: [],
        userIdentity: null,
        apiConfig: { endpoint: "", model: "", key: "" },
        offlineEngine: null,
        offlineLoading: false,
        offlineReady: false,
        lastAnswerSource: null,
        metrics: { TM: 0, BM: 0, C: 0, E0: 0 },
        parsedSeed: [],
        editingIntelId: null,
        editingBMId: null,
        lastStoryInput: "",
        lastStoryBMId: null,
        faithBubbleTimer: null
      };

      let cachedVoices = [];
      if ("speechSynthesis" in window) {
        cachedVoices = window.speechSynthesis.getVoices() || [];
        window.speechSynthesis.onvoiceschanged = () => {
          cachedVoices = window.speechSynthesis.getVoices() || [];
        };
      }

      function safeLoadJSON(key, fallback) {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : fallback;
        } catch {
          return fallback;
        }
      }

      function saveCfg() {
        const cfg = {
          voiceOn: state.voiceOn,
          learningOn: state.learningOn,
          faithSelection: state.faithSelection,
          apiConfig: state.apiConfig,
          offlineReady: state.offlineReady
        };
        localStorage.setItem(KEY_CFG, JSON.stringify(cfg));
      }
      function saveIntelligence() {
        localStorage.setItem(KEY_INT, JSON.stringify(state.intelligence));
      }
      function saveBM() {
        localStorage.setItem(KEY_BM, JSON.stringify(state.bmPrompts));
      }
      function saveHistory() {
        localStorage.setItem(KEY_HIST, JSON.stringify(state.history));
      }
      function saveUserIdentity() {
        localStorage.setItem(KEY_USER, JSON.stringify(state.userIdentity));
      }

      function logLine(text) {
        const div = document.createElement("div");
        div.className = "line";
        div.textContent = text;
        els.console.appendChild(div);
        els.console.scrollTop = els.console.scrollHeight;
      }

      function scoreTM(text) {
        if (!text) return 0;
        const len = text.length;
        return Math.min(1, Math.log10(1 + len) / 3);
      }
      function recomputeTMMetric() {
        const last = state.history.length ? state.history[state.history.length - 1] : null;
        const t = last ? last.text || "" : "";
        state.metrics.TM = Number(scoreTM(t).toFixed(2));
      }
      function recomputeBMMetric() {
        const count = state.bmPrompts.length || 0;
        state.metrics.BM = Number(Math.tanh(count / 10).toFixed(2));
      }
      function recomputeContinuityMetric() {
        const n = state.history.length || 0;
        const days = n ? Math.log10(1 + n) : 0;
        state.metrics.C = Number((1 / (1 + Math.exp(-days/2))).toFixed(3));
      }
      function recomputeE0(intelBoost, llmBoost) {
        const TM = state.metrics.TM;
        const BM = state.metrics.BM;
        const R = TM * BM;
        const I_tm = 0.3 * TM;
        const D = 0.1;
        const lambdaFaith = state.faithSelection.length ? 0.15 : 0;
        const lambdaSys = 0.12;
        const lambdaTrc = 0.18;
        const I_intel = intelBoost || 0;
        const I_llm = llmBoost || 0;
        const raw = R + I_tm + I_intel + I_llm - D + lambdaFaith + lambdaSys + lambdaTrc;
        state.metrics.E0 = Number(Math.tanh(raw).toFixed(3));
      }

      function updateCapsule(intelBoost=0, llmBoost=0) {
        recomputeTMMetric();
        recomputeBMMetric();
        recomputeContinuityMetric();
        recomputeE0(intelBoost, llmBoost);
        els.capsuleE0.textContent = "E0: " + state.metrics.E0.toFixed(3);
        els.capsuleTM.textContent = "TM: " + state.metrics.TM.toFixed(2);
        els.capsuleBM.textContent = "BM: " + state.metrics.BM.toFixed(2);
        els.capsuleC.textContent = "C: " + state.metrics.C.toFixed(3);
      }

      function renderHistoryBox() {
        els.historyBox.innerHTML = "";
        state.history.slice().forEach(h => {
          const row = document.createElement("div");
          row.className = "historyRow";
          const dt = new Date(h.ts || Date.now());
          const label = h.role === "user" ? "YOU" : h.role === "aura" ? "AURA" : "SYS";
          row.textContent = "[" + dt.toLocaleString() + "] " + label + ": " + h.text;
          els.historyBox.appendChild(row);
        });
      }

      function renderIntelList() {
        const filter = (els.intelSearch.value || "").toLowerCase();
        els.intelList.innerHTML = "";
        const list = state.intelligence.slice().sort((a,b) =>
          (a.createdAt||"") < (b.createdAt||"") ? -1 : 1
        );
        list.forEach(item => {
          const q = item.q || "";
          const a = item.a || "";
          if (filter && !q.toLowerCase().includes(filter) && !a.toLowerCase().includes(filter)) return;
          const div = document.createElement("div");
          div.className = "intelItem";
          div.textContent = q;
          div.addEventListener("click", () => {
            state.editingIntelId = item._id || q;
            els.intelEditQ.value = q;
            els.intelEditA.value = a;
            els.intelEditMeta.value = item.meta || "";
          });
          els.intelList.appendChild(div);
        });
      }

      function renderBMList() {
        els.bmSelectList.innerHTML = "";
        if (!state.bmPrompts.length) {
          els.bmSelectList.innerHTML =
            '<div style="margin-top:8px;font-size:12px;opacity:.6;">No BM prompts yet.</div>';
          els.bmViewer.style.display = "none";
          return;
        }
        const now = Date.now();
        const dateFilter = els.bmDateFilter.value || "";
        state.bmPrompts
          .slice()
          .filter(bm => {
            if (!dateFilter) return true;
            const d = new Date(bm.ts);
            const iso = d.toISOString().slice(0,10);
            return iso === dateFilter;
          })
          .sort((a, b) => b.ts - a.ts)
          .forEach(bm => {
            const card = document.createElement("div");
            card.className = "bmCard";
            card.style.cursor = "pointer";
            const title = document.createElement("div");
            title.style.fontWeight = "800";
            title.textContent = bm.title || "(untitled story)";
            const meta = document.createElement("div");
            meta.style.fontSize = "11px";
            meta.style.opacity = ".7";
            meta.style.marginTop = "2px";
            let metaText = new Date(bm.ts).toLocaleString() +
              (bm.locked ? " ¬∑ locked" : " ¬∑ editable");
            if (bm.live && bm.liveUntil && bm.liveUntil > now) {
              metaText += " ¬∑ live";
            }
            meta.textContent = metaText;
            card.appendChild(title);
            card.appendChild(meta);
            card.addEventListener("click", () => openBM(bm.id));
            els.bmSelectList.appendChild(card);
          });
      }

      function openBM(id) {
        const bm = state.bmPrompts.find(b => b.id === id);
        if (!bm) return;
        state.editingBMId = id;
        els.bmViewer.style.display = "block";
        els.bmTitle.value = bm.title || "";
        els.bmText.value = bm.text || "";
        els.bmEvidence.value = bm.evidence || "";
        els.bmLocked.checked = !!bm.locked;
        els.bmLive.checked = !!bm.live;
      }

      function closeBMViewer() {
        state.editingBMId = null;
        els.bmViewer.style.display = "none";
      }

      function speakText(text) {
        if (!state.voiceOn) return;
        if (!("speechSynthesis" in window)) return;
        if (!text) return;
        try {
          window.speechSynthesis.cancel();
          const u = new SpeechSynthesisUtterance(text);
          u.rate = 0.95;
          u.pitch = 0.7;
          let voices = cachedVoices;
          if (!voices || !voices.length) {
            voices = window.speechSynthesis.getVoices() || [];
          }
          const pick = voices.find(v =>
            /male|old|grand|baritone/i.test((v.name||"") + " " + (v.voiceURI||""))
          ) || voices[0];
          if (pick) u.voice = pick;
          window.speechSynthesis.speak(u);
        } catch(e) {
          console.warn("Voice error", e);
        }
      }

      function parseSeedBlock() {
        const text = els.seedBox.value || "";
        state.parsedSeed = [];
        if (!text.trim()) {
          els.seedHint.textContent = "No text to parse.";
          return;
        }
        const regex = /\\item\s*(.*?)\s*\\textbf\{A:\}\s*([\s\S]*?)(?=\\item|$)/g;
        let m;
        while ((m = regex.exec(text)) !== null) {
          const q = m[1].replace(/\s+/g, " ").trim();
          const aRaw = m[2].trim();
          const metaMatch = aRaw.match(/^\[(.*?)\]\s*(.*)$/s);
          let meta = "";
          let a = aRaw;
          if (metaMatch) {
            meta = metaMatch[1].trim();
            a = metaMatch[2].trim();
          }
          if (!q || !a) continue;
          state.parsedSeed.push({
            q,
            a,
            meta,
            createdAt: new Date().toISOString()
          });
        }
        if (!state.parsedSeed.length) {
          els.seedHint.textContent = "No LaTeX-style items detected.";
        } else {
          els.seedHint.textContent =
            "Parsed " + state.parsedSeed.length + " Q‚ÜíA pairs. Click 'Save to seed' to store.";
        }
      }

      function saveParsedSeed() {
        if (!state.parsedSeed.length) {
          els.seedHint.textContent = "Nothing parsed yet.";
          return;
        }
        state.intelligence = state.intelligence.concat(state.parsedSeed);
        saveIntelligence();
        renderIntelList();
        els.seedHint.textContent = "Saved " + state.parsedSeed.length + " pairs into intelligence.";
        state.parsedSeed = [];
        els.seedBox.value = "";
      }

      function discardSeed() {
        state.parsedSeed = [];
        els.seedBox.value = "";
        els.seedHint.textContent = "Waiting for block‚Ä¶";
      }

      function findBestIntelMatch(text) {
        const t = text.toLowerCase();
        let best = null;
        state.intelligence.forEach(item => {
          const q = (item.q || "").toLowerCase();
          let score = 0;
          if (t === q) score = 1;
          else if (t.includes(q) || q.includes(t)) score = 0.8;
          else {
            const words = t.split(/\s+/);
            let hits = 0;
            words.forEach(w => {
              if (w.length < 3) return;
              if (q.includes(w)) hits++;
            });
            if (hits) score = hits / words.length;
          }
          if (!best || score > best.score) {
            best = { item, score };
          }
        });
        if (!best || best.score < 0.25) return null;
        return best;
      }

      function addHistory(role, text) {
        const entry = { role, text, ts: Date.now() };
        state.history.push(entry);
        if (state.history.length > 500) {
          state.history.shift();
        }
        saveHistory();
        renderHistoryBox();
      }

      function maybeTriggerFaithBubble(text, answer) {
        if (!state.faithSelection.length) return;
        const combined = (text + " " + answer).toLowerCase();
        if (!/pain|fear|sad|anxious|hope|death|grief|alone|ibuprofen|cancer|suicide/.test(combined)) return;
        els.faithBubble.classList.add("show");
        if (state.faithBubbleTimer) clearTimeout(state.faithBubbleTimer);
        state.lastStoryInput = text || answer || "";
        state.lastStoryBMId = null;
        speakText("Faith suggestion available. Tap the golden bubble if you want a short reflection.");
        state.faithBubbleTimer = setTimeout(() => {
          els.faithBubble.classList.remove("show");
        }, 5000);
      }

      function openFaithArticleFromBubble() {
        const primary = state.faithSelection[0] || "none";
        const opt = faithOptions[primary] && faithOptions[primary][0];
        if (!opt) return;
        els.faithArticleTitle.textContent = opt.title;
        els.faithArticleText.textContent = opt.content;
        document.getElementById("modalFaithArticle").classList.add("show");
      }

      function getBaseIntel() {
        const nowIso = new Date().toISOString();
        return [
          {
            q: "hello",
            a: "Hello! I am AURA-X Œ©, an offline emotional continuity prototype created by Alim ul Haq. I live entirely on this device and try to keep your feelings and memories connected over time.",
            meta: "[core=greeting;polarity=positive;code=HELLO;intensity=0.3]",
            createdAt: nowIso
          },
          {
            q: "who are you",
            a: "I am AURA-X Œ©, an experimental emotional continuity engine. I do not replace a full LLM. I use your saved intelligence, memories, and a simple continuity equation E‚ÇÄ to keep track of your emotional trajectory.",
            meta: "[core=identity;polarity=neutral;code=WHO_AM_I;intensity=0.4]",
            createdAt: nowIso
          },
          {
            q: "who created you",
            a: "I was created by Alim ul Haq from Timergara, Pakistan, as part of the AURA-X Œ© Emotional Continuity research project.",
            meta: "[core=creator;polarity=positive;code=CREATOR;intensity=0.5]",
            createdAt: nowIso
          },
          {
            q: "what is aura x omega",
            a: "AURA-X Œ© is a unified resonance architecture for emotional continuity. It combines temporary memory (TM), bold memory (BM), truth resonance, faith, and system structure into one equation to estimate your emotional output E‚ÇÄ over time.",
            meta: "[core=definition;polarity=neutral;code=WHAT_IS;intensity=0.5]",
            createdAt: nowIso
          },
          {
            q: "hi",
            a: "Hi! I am here as your emotional continuity prototype. You can talk in any language; I will keep the memory on this device only.",
            meta: "[core=greeting;polarity=positive;code=HI;intensity=0.3]",
            createdAt: nowIso
          }
        ];
      }

      function ensureBaseIntel() {
        const base = getBaseIntel();
        if (!Array.isArray(state.intelligence)) {
          state.intelligence = [];
        }
        const existingQs = new Set(
          state.intelligence.map(item => (item.q || "").toLowerCase())
        );
        base.forEach(item => {
          const key = item.q.toLowerCase();
          if (!existingQs.has(key)) {
            state.intelligence.push(item);
          }
        });
      }

      function handleUserMessage() {
        const text = (els.userInput.value || "").trim();
        if (!text) return;
        els.userInput.value = "";
        logLine("YOU: " + text);
        addHistory("user", text);
        let intelBoost = 0;
        let llmBoost = 0;
        const intelMatch = findBestIntelMatch(text);
        if (intelMatch) {
          const { item, score } = intelMatch;
          const answer = item.a || "";
          intelBoost = Math.min(0.3 + score * 0.4, 0.7);
          state.lastAnswerSource = "intel";
          addHistory("aura", answer);
          logLine("AURA-X Œ© (intel): " + answer);
          speakText(answer);
          maybeTriggerFaithBubble(text, answer);
          updateCapsule(intelBoost, llmBoost);
          return;
        }
        const answer = "Prototype reply (local only). I heard: \"" + text + "\". Right now I am using saved intelligence + simple continuity math, not a full LLM.";
        state.lastAnswerSource = "proto";
        addHistory("aura", answer);
        logLine("AURA-X Œ© (proto): " + answer);
        speakText(answer);
        maybeTriggerFaithBubble(text, answer);
        updateCapsule(intelBoost, llmBoost);
      }

      function renderFaithChips() {
        const lenses = [
          "None","Islam","Christianity","Hinduism","Buddhism",
          "Sikhism","Judaism","Atheism / Humanism","Other / Mixed",
          "Indigenous / Traditional","Eastern / Chinese"
        ];
        const keys = [
          "none","islam","christianity","hinduism","buddhism",
          "sikhism","judaism","atheism","other","indigenous","eastern"
        ];
        els.faithChipRow.innerHTML = "";
        lenses.forEach((label,idx) => {
          const key = keys[idx];
          const chip = document.createElement("button");
          chip.type = "button";
          chip.className = "faithChip" + (state.faithSelection.includes(key) ? " active" : "");
          chip.textContent = label;
          chip.addEventListener("click", () => {
            if (key === "none") {
              state.faithSelection = [];
            } else {
              const i = state.faithSelection.indexOf(key);
              if (i >= 0) state.faithSelection.splice(i,1);
              else state.faithSelection.push(key);
              state.faithSelection = state.faithSelection.filter(k => k!=="none");
            }
            saveCfg();
            renderFaithChips();
          });
          els.faithChipRow.appendChild(chip);
        });
      }

      function loadIdentityIntoForm() {
        const u = state.userIdentity || {};
        els.idName.value = u.name || "";
        els.idStory.value = u.story || "";
        els.idValues.value = u.values || "";
        els.idLegacy.value = u.legacy || "";
        renderIdentityKpi();
      }

      function renderIdentityKpi() {
        const u = state.userIdentity || {};
        const filled = ["name","story","values","legacy"].filter(k => (u[k]||"").trim().length>0).length;
        const score = Math.round((filled/4)*100);
        els.identityKpiRow.innerHTML = "";
        const tag = document.createElement("span");
        tag.textContent = "Profile completeness: " + score + "%";
        els.identityKpiRow.appendChild(tag);
      }

      function openModal(id) {
        document.getElementById(id).classList.add("show");
      }
      function closeModal(id) {
        document.getElementById(id).classList.remove("show");
      }

      function initFromStorage() {
        const cfg = safeLoadJSON(KEY_CFG, null);
        const intel = safeLoadJSON(KEY_INT, []);
        const bm = safeLoadJSON(KEY_BM, []);
        const hist = safeLoadJSON(KEY_HIST, []);
        const user = safeLoadJSON(KEY_USER, null);
        if (cfg) applyConfigToUI(cfg);
        state.intelligence = Array.isArray(intel) ? intel : [];
        ensureBaseIntel();
        saveIntelligence();
        state.bmPrompts = Array.isArray(bm) ? bm : [];
        state.history = Array.isArray(hist) ? hist : [];
        state.userIdentity = user;
        renderFaithChips();
        renderIntelList();
        renderBMList();
        renderHistoryBox();
        loadIdentityIntoForm();
        updateCapsule();
      }

      function applyConfigToUI(cfg) {
        if (!cfg) return;
        state.voiceOn = !!cfg.voiceOn;
        state.learningOn = cfg.learningOn !== false;
        state.faithSelection = Array.isArray(cfg.faithSelection) ? cfg.faithSelection : [];
        state.apiConfig = cfg.apiConfig || { endpoint:"", model:"", key:"" };
        state.offlineReady = !!cfg.offlineReady;
        els.voicePill.textContent = state.voiceOn ? "on" : "off";
        els.voicePill.className = state.voiceOn ? "pill pillOn" : "pill pillOff";
        els.learnPill.textContent = state.learningOn ? "on" : "off";
        els.learnPill.className = state.learningOn ? "pill pillOn" : "pill pillOff";
        if (state.apiConfig.endpoint) els.llmEndpoint.value = state.apiConfig.endpoint;
        if (state.apiConfig.model) els.llmModel.value = state.apiConfig.model;
        els.llmStatus.textContent = state.apiConfig.endpoint ? "online helper configured" : "offline only";
      }

      function switchTab(tabId) {
        ["intelTab","bmTab","historyTab","identityTab"].forEach(id => {
          document.getElementById(id).classList.remove("active");
        });
        document.getElementById(tabId).classList.add("active");
        document.querySelectorAll(".tabBtn").forEach(btn => {
          if (btn.dataset.tab === tabId) btn.classList.add("active");
          else btn.classList.remove("active");
        });
      }

      els.sendBtn.addEventListener("click", handleUserMessage);
      els.userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          handleUserMessage();
        }
      });

      els.btnOptions.addEventListener("click", () => {
        els.optionsMenu.classList.toggle("show");
      });
      document.addEventListener("click", (e) => {
        if (!els.optionsMenu.contains(e.target) && e.target !== els.btnOptions) {
          els.optionsMenu.classList.remove("show");
        }
      });

      els.miVoice.addEventListener("click", () => {
        state.voiceOn = !state.voiceOn;
        els.voicePill.textContent = state.voiceOn ? "on" : "off";
        els.voicePill.className = state.voiceOn ? "pill pillOn" : "pill pillOff";
        saveCfg();
      });
      els.miLearn.addEventListener("click", () => {
        state.learningOn = !state.learningOn;
        els.learnPill.textContent = state.learningOn ? "on" : "off";
        els.learnPill.className = state.learningOn ? "pill pillOn" : "pill pillOff";
        saveCfg();
      });

      els.miIntel.addEventListener("click", () => {
        switchTab("intelTab");
      });
      els.miBM.addEventListener("click", () => {
        switchTab("bmTab");
      });
      els.miHistory.addEventListener("click", () => {
        switchTab("historyTab");
      });
      els.miIdentity.addEventListener("click", () => {
        switchTab("identityTab");
      });
      els.miFaith.addEventListener("click", () => {
        openModal("modalFaith");
      });
      els.miLLM.addEventListener("click", () => {
        openModal("modalLLM");
      });
      els.miSeed.addEventListener("click", () => {
        openModal("modalSeed");
      });

      document.querySelectorAll(".closeX").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-close");
          if (id) closeModal(id);
        });
      });

      els.btnParseSeed.addEventListener("click", parseSeedBlock);
      els.btnSaveSeed.addEventListener("click", saveParsedSeed);
      els.btnDiscardSeed.addEventListener("click", discardSeed);

      els.intelSearch.addEventListener("input", renderIntelList);
      els.btnIntelSave.addEventListener("click", () => {
        if (!state.editingIntelId) return;
        const q = (els.intelEditQ.value || "").trim();
        const a = (els.intelEditA.value || "").trim();
        if (!q || !a) {
          alert("Question and answer required.");
          return;
        }
        const meta = (els.intelEditMeta.value || "").trim();
        const idx = state.intelligence.findIndex(it => (it._id || it.q) === state.editingIntelId);
        if (idx >= 0) {
          state.intelligence[idx].q = q;
          state.intelligence[idx].a = a;
          state.intelligence[idx].meta = meta;
        }
        saveIntelligence();
        renderIntelList();
      });
      els.btnIntelDelete.addEventListener("click", () => {
        if (!state.editingIntelId) return;
        if (!confirm("Delete this Q‚ÜíA pair?")) return;
        state.intelligence = state.intelligence.filter(it => (it._id || it.q) !== state.editingIntelId);
        state.editingIntelId = null;
        els.intelEditQ.value = "";
        els.intelEditA.value = "";
        els.intelEditMeta.value = "";
        saveIntelligence();
        renderIntelList();
      });

      els.btnNewBM.addEventListener("click", () => {
        const id = "bm_" + Date.now();
        const bm = {
          id,
          title: "",
          text: "",
          evidence: "",
          locked: false,
          live: false,
          ts: Date.now(),
          liveUntil: null
        };
        state.bmPrompts.push(bm);
        saveBM();
        renderBMList();
        openBM(id);
      });
      els.bmDateFilter.addEventListener("change", renderBMList);
      els.btnBMSave.addEventListener("click", () => {
        if (!state.editingBMId) return;
        const idx = state.bmPrompts.findIndex(b => b.id === state.editingBMId);
        if (idx < 0) return;
        const bm = state.bmPrompts[idx];
        bm.title = els.bmTitle.value || "";
        bm.text = els.bmText.value || "";
        bm.evidence = els.bmEvidence.value || "";
        bm.locked = els.bmLocked.checked;
        bm.live = els.bmLive.checked;
        if (bm.live) {
          const now = Date.now();
          bm.liveUntil = now + 12*60*60*1000;
        } else {
          bm.liveUntil = null;
        }
        saveBM();
        renderBMList();
      });
      els.btnBMDelete.addEventListener("click", () => {
        if (!state.editingBMId) return;
        if (!confirm("Delete this BM story? This cannot be undone.")) return;
        state.bmPrompts = state.bmPrompts.filter(b => b.id !== state.editingBMId);
        saveBM();
        closeBMViewer();
        renderBMList();
      });

      els.btnClear48h.addEventListener("click", () => {
        if (!confirm("Delete history from last 48 hours?")) return;
        const cutoff = Date.now() - 48*60*60*1000;
        state.history = state.history.filter(h => (h.ts || 0) < cutoff);
        saveHistory();
        renderHistoryBox();
      });
      els.btnClearAllHist.addEventListener("click", () => {
        if (!confirm("Delete ALL history entries? This cannot be undone.")) return;
        state.history = [];
        saveHistory();
        renderHistoryBox();
      });

      els.btnIdSave.addEventListener("click", () => {
        state.userIdentity = {
          name: (els.idName.value || "").trim(),
          story: (els.idStory.value || "").trim(),
          values: (els.idValues.value || "").trim(),
          legacy: (els.idLegacy.value || "").trim()
        };
        saveUserIdentity();
        renderIdentityKpi();
      });
      els.btnIdReset.addEventListener("click", () => {
        if (!confirm("Clear identity form?")) return;
        state.userIdentity = null;
        els.idName.value = "";
        els.idStory.value = "";
        els.idValues.value = "";
        els.idLegacy.value = "";
        saveUserIdentity();
        renderIdentityKpi();
      });

      els.faithBubble.addEventListener("click", openFaithArticleFromBubble);
      els.btnAddFaithToBM.addEventListener("click", () => {
        closeModal("modalFaithArticle");
      });
      els.btnSkipFaithBM.addEventListener("click", () => {
        closeModal("modalFaithArticle");
        els.faithBubble.classList.remove("show");
      });

      els.btnLLMReset.addEventListener("click", () => {
        state.apiConfig = { endpoint:"", model:"", key:"" };
        els.llmEndpoint.value = "";
        els.llmModel.value = "";
        els.llmKey.value = "";
        saveCfg();
        els.llmStatus.textContent = "offline only";
      });
      els.btnLLMSave.addEventListener("click", () => {
        state.apiConfig.endpoint = (els.llmEndpoint.value || "").trim();
        state.apiConfig.model = (els.llmModel.value || "").trim();
        state.apiConfig.key = (els.llmKey.value || "").trim();
        saveCfg();
        els.llmStatus.textContent =
          state.apiConfig.endpoint ? "online helper configured" : "offline only";
      });

      document.querySelectorAll(".tabBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const tabId = btn.getAttribute("data-tab");
          switchTab(tabId);
        });
      });

      initFromStorage();
      // ⁄©Ÿàÿ¶€å auto-message ŸÜ€Å€å⁄∫ÿå screen clean ÿ±€Å€í ⁄Ø€å ‚Äî console ÿÆÿßŸÑ€å ÿ¥ÿ±Ÿàÿπ €ÅŸà⁄Øÿß
    });
  </script>
</body>
</html>