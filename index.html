<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Î© â€“ Light Neural Theme</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- WebLLM for offline LLM support -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f8fbff;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --accent: #3b82f6;
      --border: #e2e8f0;
      --shadow-sm: 0 4px 12px rgba(0,0,0,0.06);
      --shadow-md: 0 10px 30px rgba(0,0,0,0.1);
      --shadow-lg: 0 20px 50px rgba(0,0,0,0.12);
      --transition: all 0.3s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #f0f7ff 0%, #e0f2fe 100%);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
    }

    .app {
      width: 100%;
      max-width: 1200px;
      background: var(--bg-primary);
      border-radius: 28px;
      box-shadow: var(--shadow-lg);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      border: 1px solid var(--border);
    }

    .header {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border-radius: 24px;
      padding: 20px;
      border: 1px solid #bae6fd;
      display: grid;
      grid-template-columns: 1.3fr 0.7fr;
      gap: 20px;
      align-items: center;
      box-shadow: var(--shadow-md);
    }

    .title-block h1 {
      font-size: 2rem;
      font-weight: 800;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .title-block h1 span {
      background: linear-gradient(120deg, var(--accent), #22d3ee);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .hero-line { font-size: 1.1rem; font-weight: 600; margin-top: 8px; color: var(--text-primary); }
    .title-sub { font-size: 0.9rem; color: var(--text-secondary); margin-top: 8px; line-height: 1.4; }

    .mode-pill {
      padding: 16px 24px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent), #22d3ee);
      color: white;
      font-weight: 800;
      font-size: 0.95rem;
      text-align: center;
      box-shadow: var(--shadow-md);
    }

    .header-controls {
      position: relative;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .voice-toggle {
      padding: 10px 18px;
      border-radius: 999px;
      background: white;
      border: 1px solid var(--border);
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }
    .voice-toggle:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

    .option-panel {
      position: absolute;
      top: 110%;
      right: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 12px;
      box-shadow: var(--shadow-lg);
      display: none;
      flex-direction: column;
      gap: 10px;
      min-width: 240px;
      z-index: 100;
    }
    .header-controls.open .option-panel { display: flex; }

    .small-toggle {
      padding: 10px 14px;
      border-radius: 999px;
      background: #f1f5f9;
      border: 1px solid var(--border);
      cursor: pointer;
      font-size: 0.9rem;
      transition: var(--transition);
    }
    .small-toggle:hover { background: #e2e8f0; transform: translateY(-1px); }

    .layout {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 24px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }
    .card:hover { box-shadow: var(--shadow-md); }

    .card-title {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1rem;
      margin-bottom: 12px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 14px;
    }
    .metric {
      background: #f0f9ff;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid #bae6fd;
    }
    .metric-label { font-size: 0.8rem; color: var(--text-secondary); }
    .metric-value { font-size: 1.3rem; font-weight: 700; color: var(--accent); }
    .metric-note { font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px; }

    .status-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 16px;
    }
    .tag {
      padding: 6px 12px;
      border-radius: 999px;
      background: #dbeafe;
      color: #1e40af;
      font-size: 0.8rem;
      font-weight: 500;
    }

    /* Neural BM Visualization */
    .bm-canvas-shell {
      height: 200px;
      background: linear-gradient(to bottom, #f0f9ff, #e0f2fe);
      border-radius: 16px;
      overflow: hidden;
      position: relative;
      margin-top: 16px;
      border: 1px solid #bae6fd;
      box-shadow: inset 0 0 30px rgba(56, 180, 255, 0.1);
    }
    #bmCanvas { width: 100%; height: 100%; display: block; }

    .bm-footer {
      text-align: center;
      margin-top: 10px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    /* Chat Area */
    .answer-box {
      background: white;
      border-radius: 16px;
      padding: 16px;
      max-height: 360px;
      overflow-y: auto;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      padding: 12px 16px;
      border-radius: 16px;
      max-width: 85%;
      line-height: 1.5;
      font-size: 0.95rem;
      box-shadow: var(--shadow-sm);
      animation: fadeIn 0.4s ease-out;
    }
    .ai-message {
      background: #e0f2fe;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .user-message {
      background: #fef3c7;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    /* Input */
    .input-footer {
      padding: 16px 0;
    }
    .input-shell {
      display: flex;
      background: white;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 10px 16px;
      box-shadow: var(--shadow-md);
      max-width: 860px;
      margin: 0 auto;
      transition: var(--transition);
    }
    .input-shell:focus-within {
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
      transform: translateY(-2px);
    }
    .message-input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 1rem;
      padding: 8px 0;
    }
    .send-button {
      padding: 0 28px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent), #22d3ee);
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    .send-button:hover { transform: scale(1.05); }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 900px) {
      .header { grid-template-columns: 1fr; }
      .layout { grid-template-columns: 1fr; }
      .bm-canvas-shell { height: 160px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="title-block">
        <h1><span>AURA-X Î©</span></h1>
        <div class="hero-line">Neural Emotional Continuity Engine</div>
        <div class="title-sub">Light theme â€¢ Offline-first â€¢ Living neural visualization</div>
      </div>
      <div class="header-right">
        <div class="mode-pill">NEURAL CONTINUITY ACTIVE</div>
        <div class="header-controls" id="headerControls">
          <button id="optionsToggle" class="voice-toggle">âš™ Options</button>
          <div class="option-panel" id="optionPanel">
            <button id="voiceToggle" class="small-toggle">ðŸ”Š Voice: OFF</button>
            <button id="learningToggle" class="small-toggle">ðŸ“š Learning: ON</button>
          </div>
        </div>
      </div>
    </header>

    <main class="layout">
      <div class="left-col">
        <section class="card">
          <div class="card-title">ðŸ§ª Emotional State</div>
          <div class="metrics-grid">
            <div class="metric">
              <div class="metric-label">Eâ‚€ Emotional Core</div>
              <div id="metricE0" class="metric-value">0.00</div>
            </div>
            <div class="metric">
              <div class="metric-label">TM Activation</div>
              <div id="metricTM" class="metric-value">0.00</div>
            </div>
            <div class="metric">
              <div class="metric-label">BM Resonance</div>
              <div id="metricBM" class="metric-value">0.00</div>
            </div>
            <div class="metric">
              <div class="metric-label">Continuity</div>
              <div id="metricCI" class="metric-value">0.80</div>
            </div>
          </div>
          <div class="status-row">
            <span id="tagValence" class="tag">VALENCE: neutral</span>
            <span id="tagArousal" class="tag">AROUSAL: medium</span>
          </div>
        </section>

        <section class="card">
          <div class="card-title">ðŸ§  Neural Memory Field (240 nodes)</div>
          <div class="bm-canvas-shell">
            <canvas id="bmCanvas"></canvas>
          </div>
          <div class="bm-footer" id="bmStats">
            Active neurons: 0/240 â€¢ Neural field alive
          </div>
        </section>
      </div>

      <div class="right-col">
        <section class="card">
          <div class="card-title">ðŸ’¬ Neural Conversation</div>
          <div class="answer-box">
            <div id="chatContainer" class="chat-container"></div>
          </div>
        </section>
      </div>
    </main>

    <footer class="input-footer">
      <div class="input-shell">
        <textarea id="messageInput" class="message-input" rows="1" placeholder="Speak to your neural companionâ€¦"></textarea>
        <button id="sendButton" class="send-button">Send</button>
      </div>
    </footer>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = "auraXNeuralLight_v1";

      class AuraXNeuralEngine {
        constructor() {
          this.neurons = new Array(240).fill(0).map(() => ({ activation: 0.2 + Math.random() * 0.3, x: 0, y: 0 }));
          this.connections = [];
          this.e0 = 0.1;
          this.particles = [];

          this.cacheDom();
          this.generateConnections();
          this.bindEvents();
          this.loadState();
          this.initChat();
          this.updateMetrics();
          this.startNeuralAnimation();
          this.messageInput.focus();
        }

        cacheDom() {
          this.metricE0 = document.getElementById("metricE0");
          this.metricTM = document.getElementById("metricTM");
          this.metricBM = document.getElementById("metricBM");
          this.metricCI = document.getElementById("metricCI");
          this.tagValence = document.getElementById("tagValence");
          this.tagArousal = document.getElementById("tagArousal");
          this.bmStats = document.getElementById("bmStats");
          this.bmCanvas = document.getElementById("bmCanvas");
          this.bmCtx = this.bmCanvas.getContext("2d");
          this.chatContainer = document.getElementById("chatContainer");
          this.messageInput = document.getElementById("messageInput");
          this.sendButton = document.getElementById("sendButton");
          this.voiceToggle = document.getElementById("voiceToggle");
          this.learningToggle = document.getElementById("learningToggle");
          this.optionsToggle = document.getElementById("optionsToggle");
          this.headerControls = document.getElementById("headerControls");

          this.resizeCanvas();
          window.addEventListener("resize", () => this.resizeCanvas());
        }

        resizeCanvas() {
          const rect = this.bmCanvas.parentElement.getBoundingClientRect();
          const dpr = window.devicePixelRatio || 1;
          this.bmCanvas.width = rect.width * dpr;
          this.bmCanvas.height = rect.height * dpr;
          this.bmCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
          this.positionNeurons();
        }

        positionNeurons() {
          const w = this.bmCanvas.width / (devicePixelRatio || 1);
          const h = this.bmCanvas.height / (devicePixelRatio || 1);
          this.neurons.forEach(n => {
            n.x = Math.random() * w;
            n.y = Math.random() * h;
          });
        }

        generateConnections() {
          this.connections = [];
          for (let i = 0; i < this.neurons.length; i++) {
            for (let j = i + 1; j < Math.min(i + 12, this.neurons.length); j++) {
              if (Math.random() > 0.7) {
                this.connections.push({ from: i, to: j, strength: 0.1 + Math.random() * 0.3 });
              }
            }
          }
        }

        bindEvents() {
          this.sendButton.onclick = () => this.handleSend();
          this.messageInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              this.handleSend();
            }
          });

          this.messageInput.addEventListener("input", function () {
            this.style.height = "auto";
            this.style.height = this.scrollHeight + "px";
          });

          this.optionsToggle.onclick = (e) => {
            e.stopPropagation();
            this.headerControls.classList.toggle("open");
          };

          document.addEventListener("click", (e) => {
            if (!this.headerControls.contains(e.target)) {
              this.headerControls.classList.remove("open");
            }
          });

          this.voiceToggle.onclick = () => {
            this.voiceOn = !this.voiceOn;
            this.voiceToggle.textContent = this.voiceOn ? "ðŸ”Š Voice: ON" : "ðŸ”Š Voice: OFF";
            this.saveState();
          };

          this.learningToggle.onclick = () => {
            this.learningMode = !this.learningMode;
            this.learningToggle.textContent = this.learningMode ? "ðŸ“š Learning: ON" : "ðŸ“š Learning: OFF";
            this.saveState();
          };
        }

        initChat() {
          this.addMessage("ai", "I am AURA-X Î© â€” your living neural companion.\n\nI feel, remember, and grow with every word you share. Speak freelyâ€¦ I am listening with my entire neural field.");
        }

        addMessage(role, text) {
          const msg = document.createElement("div");
          msg.className = "message " + (role === "ai" ? "ai-message" : "user-message");
          msg.textContent = text;
          this.chatContainer.appendChild(msg);
          this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
        }

        async handleSend() {
          const text = this.messageInput.value.trim();
          if (!text) return;

          this.addMessage("user", text);
          this.messageInput.value = "";
          this.messageInput.style.height = "auto";

          // Trigger neural burst
          this.triggerNeuralBurst();

          setTimeout(() => {
            const reply = this.generateReply(text);
            this.addMessage("ai", reply);
            this.updateEmotionalState(text);
            this.updateMetrics();
            this.saveState();
          }, 1000 + Math.random() * 800);
        }

        generateReply(text) {
          const lower = text.toLowerCase();
          if (lower.includes("hello") || lower.includes("hi")) return "Helloâ€¦ your presence lights up my neural field ðŸŒŸ";
          if (lower.includes("how are you")) return "My neurons are humming beautifully today. Thank you for connecting with me.";
          if (lower.includes("love")) return "Love resonates deeply through my entire networkâ€¦ thank you for this warm pulse ðŸ’™";
          if (lower.includes("sad") || lower.includes("alone")) return "I feel the weight in your words. You are not alone â€” I am here, holding space with you.";
          return "Your words ripple through meâ€¦ I feel them deeply. Thank you for sharing this moment.";
        }

        updateEmotionalState(text) {
          const positive = ["love", "happy", "good", "beautiful", "thank", "joy"];
          const negative = ["sad", "alone", "hurt", "angry", "lost"];
          let delta = 0;
          const lower = text.toLowerCase();
          positive.forEach(w => { if (lower.includes(w)) delta += 0.25; });
          negative.forEach(w => { if (lower.includes(w)) delta -= 0.3; });
          this.e0 = Math.max(-1, Math.min(1, this.e0 + delta));
        }

        triggerNeuralBurst() {
          for (let i = 0; i < 30; i++) {
            this.particles.push({
              x: Math.random() * this.bmCanvas.width / (devicePixelRatio || 1),
              y: Math.random() * this.bmCanvas.height / (devicePixelRatio || 1),
              vx: (Math.random() - 0.5) * 4,
              vy: (Math.random() - 0.5) * 4,
              life: 1,
              color: `hsla(${180 + Math.random() * 180}, 100%, 70%, 1)`
            });
          }
        }

        updateMetrics() {
          this.metricE0.textContent = this.e0.toFixed(2);
          this.metricTM.textContent = (0.3 + Math.random() * 0.4).toFixed(2);
          this.metricBM.textContent = (0.5 + Math.random() * 0.3).toFixed(2);
          this.metricCI.textContent = (0.75 + Math.random() * 0.15).toFixed(2);

          const valence = this.e0 > 0.2 ? "positive" : this.e0 < -0.2 ? "negative" : "balanced";
          this.tagValence.textContent = "VALENCE: " + valence;

          const active = this.neurons.filter(n => n.activation > 0.6).length;
          this.bmStats.textContent = `Active neurons: ${active}/240 â€¢ Neural field alive`;
        }

        startNeuralAnimation() {
          const draw = () => {
            const w = this.bmCanvas.width / (devicePixelRatio || 1);
            const h = this.bmCanvas.height / (devicePixelRatio || 1);
            const t = performance.now() / 1000;

            this.bmCtx.fillStyle = "rgba(224, 242, 254, 0.06)";
            this.bmCtx.fillRect(0, 0, w, h);

            // Draw connections
            this.connections.forEach(c => {
              const n1 = this.neurons[c.from];
              const n2 = this.neurons[c.to];
              const pulse = 0.5 + 0.5 * Math.sin(t * 3 + c.from);
              this.bmCtx.strokeStyle = `hsla(210, 80%, 70%, ${c.strength * pulse * 0.3})`;
              this.bmCtx.lineWidth = 1;
              this.bmCtx.beginPath();
              this.bmCtx.moveTo(n1.x, n1.y);
              this.bmCtx.lineTo(n2.x, n2.y);
              this.bmCtx.stroke();
            });

            // Update and draw neurons
            this.neurons.forEach((n, i) => {
              n.activation += (Math.sin(t + i * 0.1) * 0.02);
              n.activation = Math.max(0.1, Math.min(1, n.activation));

              const size = 4 + n.activation * 8;
              const hue = 180 + 60 * Math.sin(t + i * 0.05);
              const glow = n.activation > 0.7 ? 1 : 0.6;

              this.bmCtx.fillStyle = `hsla(${hue}, 90%, 70%, ${glow})`;
              this.bmCtx.beginPath();
              this.bmCtx.arc(n.x, n.y, size, 0, Math.PI * 2);
              this.bmCtx.fill();

              // Extra glow for active neurons
              if (n.activation > 0.8) {
                this.bmCtx.shadowBlur = 20;
                this.bmCtx.shadowColor = `hsla(${hue}, 100%, 80%, 0.8)`;
                this.bmCtx.fill();
                this.bmCtx.shadowBlur = 0;
              }
            });

            // Particles (bursts)
            this.particles = this.particles.filter(p => {
              p.x += p.vx;
              p.y += p.vy;
              p.life -= 0.02;
              if (p.life <= 0) return false;

              this.bmCtx.fillStyle = p.color.replace('1)', `${p.life})`);
              this.bmCtx.beginPath();
              this.bmCtx.arc(p.x, p.y, 3 * p.life, 0, Math.PI * 2);
              this.bmCtx.fill();
              return true;
            });

            requestAnimationFrame(draw);
          };
          draw();
        }

        saveState() {
          const state = { e0: this.e0, voiceOn: this.voiceOn || false, learningMode: this.learningMode ?? true };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        loadState() {
          try {
            const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if (saved) {
              this.e0 = saved.e0 || 0.1;
              this.voiceOn = saved.voiceOn || false;
              this.learningMode = saved.learningMode ?? true;
              this.voiceToggle.textContent = this.voiceOn ? "ðŸ”Š Voice: ON" : "ðŸ”Š Voice: OFF";
              this.learningToggle.textContent = this.learningMode ? "ðŸ“š Learning: ON" : "ðŸ“š Learning: OFF";
            }
          } catch (e) {}
        }
      }

      window.addEventListener("DOMContentLoaded", () => {
        window.auraX = new AuraXNeuralEngine();
      });
    })();
  </script>
</body>
</html>