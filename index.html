<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Optional: WebLLM / Tiny model loader hook (you can wire this later) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;      /* you will connect this inside JS engine */
  </script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg-dark:#020617;
      --bg-card:#02091a;
      --bg-card-soft:#030c21;
      --border-soft:#1e293b;
      --accent:#0ea5e9;
      --accent-soft:#38bdf8;
      --accent-strong:#22c55e;
      --danger:#ef4444;
      --text-main:#e5e7eb;
      --text-soft:#9ca3af;
      --radius-xl:18px;
      --shadow-soft:0 18px 45px rgba(0,0,0,.55);
      --shadow-chip:0 0 0 1px rgba(148,163,184,.65);
      --badge:#0f172a;
      --badge-soft:#020617;
      --chip-bg:#020617;
      --chip-active:#0ea5e9;
    }
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:var(--text-main);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:20px;
    }
    .shell{
      width:100%;
      max-width:1200px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .top-row{
      display:flex;
      gap:16px;
      align-items:center;
      justify-content:space-between;
    }
    .brand-block{
      display:flex;
      gap:14px;
      align-items:center;
    }
    .orb{
      width:46px;
      height:46px;
      border-radius:999px;
      background:
        radial-gradient(circle at 30% 20%,#facc15 0,#f97316 28%,transparent 52%),
        radial-gradient(circle at 70% 80%,#22c55e 0,#0ea5e9 36%,transparent 60%);
      box-shadow:0 0 30px rgba(56,189,248,.75);
    }
    .brand-text-main{
      font-size:1.1rem;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#e5e7eb;
    }
    .brand-text-sub{
      font-size:.78rem;
      color:var(--text-soft);
    }
    .pill-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }
    .pill{
      font-size:.7rem;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.45);
      background:rgba(15,23,42,.6);
      color:#cbd5f5;
    }
    .status-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.5);
      font-size:.7rem;
      color:var(--text-soft);
    }
    .status-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 0 4px rgba(34,197,94,.2);
    }

    .grid{
      display:grid;
      grid-template-columns:1.35fr .95fr;
      gap:16px;
    }
    @media(max-width:960px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:radial-gradient(circle at 0 0,#0b1120 0,transparent 52%),
                 radial-gradient(circle at 100% 100%,#020617 0,transparent 52%),
                 var(--bg-card);
      border-radius:var(--radius-xl);
      border:1px solid var(--border-soft);
      box-shadow:var(--shadow-soft);
      padding:14px 14px 16px;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:10px;
    }
    .card-title{
      font-size:.92rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .card-sub{
      font-size:.72rem;
      color:var(--text-soft);
      margin-top:2px;
    }
    .emoji{font-size:1.05rem}
    .badge{
      font-size:.68rem;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      background:var(--badge);
      color:#cbd5f5;
    }

    .metrics-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
      margin-bottom:10px;
    }
    .metric{
      padding:9px 9px 8px;
      border-radius:14px;
      background:var(--bg-card-soft);
      border:1px solid rgba(30,64,175,.55);
    }
    .metric-label{
      font-size:.68rem;
      color:var(--text-soft);
      margin-bottom:2px;
    }
    .metric-value{
      font-size:.92rem;
      font-weight:600;
    }
    .meter-bar{
      margin-top:4px;
      height:5px;
      border-radius:999px;
      background:#020617;
      overflow:hidden;
    }
    .meter-fill{
      height:100%;
      width:32%;
      border-radius:999px;
      background:linear-gradient(90deg,#22c55e,#0ea5e9);
      transition:width .2s ease-out;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .btn, .btn-mini{
      border:none;
      border-radius:999px;
      cursor:pointer;
      font-family:inherit;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn{
      padding:7px 12px;
      font-size:.78rem;
      background:radial-gradient(circle at 0 0,#38bdf8 0,transparent 65%),
                 #0f172a;
      color:#e5e7eb;
      border:1px solid rgba(56,189,248,.55);
    }
    .btn-secondary{
      background:radial-gradient(circle at 0 0,#1f2937 0,transparent 60%),
                 #020617;
      border-color:rgba(148,163,184,.6);
      color:var(--text-main);
    }
    .btn-ghost{
      background:transparent;
      border-color:rgba(148,163,184,.38);
      color:var(--text-soft);
    }
    .btn-danger{
      border-color:rgba(248,113,113,.6);
      color:#fecaca;
    }
    .btn-mini{
      padding:5px 9px;
      font-size:.72rem;
      background:#020617;
      border:1px solid rgba(148,163,184,.5);
      color:#e5e7eb;
      border-radius:999px;
    }

    /* Chat area */
    .answer-shell{margin-top:4px}
    .answer-box{
      border-radius:16px;
      background:linear-gradient(145deg,rgba(15,23,42,.95),rgba(15,23,42,.9));
      border:1px solid rgba(30,64,175,.7);
      min-height:260px;
      display:flex;
      flex-direction:column;
      padding:10px 10px 8px;
    }
    .equation-header{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:#a5b4fc;
    }
    .equation-divider{
      height:1px;
      margin:6px 0 6px;
      border-radius:999px;
      background:linear-gradient(90deg,transparent,#0ea5e9,transparent);
    }
    .chat-container{
      flex:1;
      overflow-y:auto;
      padding:4px 2px 0;
      font-size:.78rem;
      line-height:1.45;
    }
    .msg{
      margin-bottom:8px;
      padding:6px 8px;
      border-radius:12px;
      max-width:100%;
    }
    .msg-user{
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.6);
      align-self:flex-end;
    }
    .msg-ai{
      background:rgba(15,23,42,.98);
      border:1px solid rgba(59,130,246,.7);
    }
    .msg-meta{
      font-size:.68rem;
      color:var(--text-soft);
      margin-top:2px;
    }

    .input-row{
      margin-top:9px;
      display:flex;
      gap:6px;
      align-items:flex-end;
    }
    .text-input{
      flex:1;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.65);
      background:#020617;
      color:#e5e7eb;
      padding:8px 9px;
      font-size:.78rem;
      resize:vertical;
      min-height:42px;
      max-height:120px;
    }
    .text-input::placeholder{color:#6b7280}
    .footer-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:5px;
      font-size:.68rem;
      color:var(--text-soft);
    }

    /* Modals */
    .modal-overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(15,23,42,.85);
      backdrop-filter:blur(14px);
      z-index:40;
    }
    .modal-card{
      width:100%;
      max-width:640px;
      max-height:80vh;
      background:radial-gradient(circle at 0 0,#0b1120 0,transparent 55%),
                 radial-gradient(circle at 100% 100%,#020617 0,transparent 55%),
                 #020617;
      border-radius:20px;
      border:1px solid rgba(30,64,175,.75);
      box-shadow:var(--shadow-soft);
      padding:14px 14px 12px;
      display:flex;
      flex-direction:column;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:8px;
    }
    .modal-title{
      font-size:.9rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .modal-sub{
      font-size:.72rem;
      color:var(--text-soft);
      margin-top:2px;
    }
    .modal-close{
      border:none;
      border-radius:999px;
      padding:4px 8px;
      cursor:pointer;
      background:#020617;
      border:1px solid rgba(148,163,184,.6);
      color:#e5e7eb;
      font-size:.8rem;
    }
    .modal-body{
      flex:1;
      overflow-y:auto;
      margin-top:4px;
      padding-right:2px;
      font-size:.78rem;
    }
    .conv-controls{
      display:flex;
      gap:6px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .conv-item{
      padding:6px 8px;
      border-radius:12px;
      background:var(--bg-card-soft);
      border:1px solid rgba(30,64,175,.6);
      margin-bottom:6px;
    }
    .conv-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:.68rem;
      margin-bottom:3px;
      color:var(--text-soft);
    }

    .bm-item{
      padding:7px 8px;
      border-radius:12px;
      background:var(--bg-card-soft);
      border:1px solid rgba(30,64,175,.7);
      margin-bottom:6px;
    }
    .bm-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:.7rem;
      margin-bottom:3px;
      color:var(--text-soft);
    }
    .bm-actions{
      margin-top:4px;
      display:flex;
      flex-wrap:wrap;
      gap:5px;
    }
    .tag-pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:.66rem;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.9);
      color:#cbd5f5;
      margin-right:4px;
    }

    .faith-chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .faith-chip{
      font-size:.72rem;
      padding:5px 9px;
      border-radius:999px;
      background:var(--chip-bg);
      border:1px solid rgba(148,163,184,.55);
      cursor:pointer;
      color:#e5e7eb;
    }
    .faith-chip.active{
      background:var(--chip-active);
      border-color:rgba(56,189,248,.9);
      color:#0b1120;
      box-shadow:var(--shadow-chip);
    }

    .field-label{
      font-size:.7rem;
      color:var(--text-soft);
      margin-bottom:3px;
    }
    .field-input, .field-textarea{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.6);
      background:#020617;
      color:#e5e7eb;
      padding:7px 8px;
      font-size:.78rem;
    }
    .field-textarea{
      min-height:90px;
      resize:vertical;
    }
    .error-text{
      font-size:.7rem;
      color:#fecaca;
      margin-top:3px;
    }

    .section-title{
      font-size:.74rem;
      color:var(--text-soft);
      margin-top:6px;
      margin-bottom:3px;
    }
    .llm-box{
      padding:7px 8px;
      border-radius:12px;
      background:var(--bg-card-soft);
      border:1px solid rgba(30,64,175,.75);
      font-size:.75rem;
    }
    .llm-status{
      font-size:.7rem;
      color:var(--text-soft);
      margin-top:4px;
    }
    .progress-bar{
      height:5px;
      border-radius:999px;
      background:#020617;
      overflow:hidden;
      margin-top:4px;
    }
    .progress-inner{
      height:100%;
      width:0%;
      border-radius:999px;
      background:linear-gradient(90deg,#22c55e,#0ea5e9);
      transition:width .2s ease-out;
    }
    .checkbox-row{
      display:flex;
      align-items:center;
      gap:5px;
      font-size:.72rem;
      margin-top:5px;
      color:var(--text-soft);
    }
    input[type="checkbox"]{accent-color:#0ea5e9}

  </style>
</head>
<body>
<div class="shell">
  <div class="top-row">
    <div class="brand-block">
      <div class="orb"></div>
      <div>
        <div class="brand-text-main">AURA-X Œ©</div>
        <div class="brand-text-sub">Offline Emotional Continuity ¬∑ Dual-layer TM/BM</div>
        <div class="pill-row">
          <span class="pill">No cloud training ¬∑ TM = your inputs</span>
          <span class="pill">BM = long scenes only</span>
          <span class="pill">Faith lens ¬∑ Truth resonance</span>
        </div>
      </div>
    </div>
    <div class="status-chip">
      <span class="status-dot"></span>
      <span id="statusChipText">Prototype running inside your browser</span>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: Metrics / controls -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title"><span class="emoji">üì°</span><span>Continuity metrics</span></div>
          <div class="card-sub">Grand equation: E‚ÇÄ = tanh(R(TM,BM) ‚àí D + Œª<sub>faith</sub> + Œª<sub>sys</sub> + Œª<sub>TRC</sub>)</div>
        </div>
        <span class="badge" id="modeBadge">Learning mode</span>
      </div>

      <div class="metrics-grid">
        <div class="metric">
          <div class="metric-label">Base emotional state (E‚ÇÄ)</div>
          <div class="metric-value" id="e0Value">0.00</div>
          <div class="meter-bar"><div class="meter-fill" id="e0Bar"></div></div>
        </div>
        <div class="metric">
          <div class="metric-label">Continuity index</div>
          <div class="metric-value" id="contValue">0.80</div>
          <div class="meter-bar"><div class="meter-fill" id="contBar"></div></div>
        </div>
        <div class="metric">
          <div class="metric-label">TM / BM / Episodes</div>
          <div class="metric-value" id="countsValue">TM 0 ¬∑ BM 0</div>
          <div class="meter-bar"><div class="meter-fill" id="countsBar"></div></div>
        </div>
      </div>

      <div class="section-title">Controls</div>
      <div class="btn-row">
        <button class="btn-secondary btn-mini" id="convHistoryBtn">üß† Conversation history (TM)</button>
        <button class="btn-secondary btn-mini" id="bmRecallBtn">üìÅ Recall from BM</button>
        <button class="btn-secondary btn-mini" id="faithBtn">üîò Faith: None</button>
        <button class="btn-secondary btn-mini" id="intelBtn">üß© Intelligence (Q/A)</button>
        <button class="btn-secondary btn-mini" id="seedBtn">üå± Feed the seed (episode)</button>
        <button class="btn-secondary btn-mini" id="llmBtn">ü§ñ Helper LLM link</button>
      </div>

      <div class="section-title">Last emotional reading</div>
      <div class="metric" style="margin-top:4px">
        <div class="metric-label">Detected emotion / polarity / intensity</div>
        <div class="metric-value" id="lastEmotionValue">‚Äî</div>
        <div class="meter-bar"><div class="meter-fill" id="emotionBar"></div></div>
      </div>
    </section>

    <!-- RIGHT: Chat -->
    <section class="card answer-card">
      <div class="card-header">
        <div>
          <div class="card-title"><span class="emoji">üí¨</span><span>Emotional continuity console</span></div>
          <div class="card-sub">Offline-first ¬∑ TM = your inputs only ¬∑ Small-talk never goes to BM.</div>
        </div>
        <span class="badge">Prototype ¬∑ local rules ‚Üí optional helper LLM</span>
      </div>

      <div class="answer-shell">
        <div class="answer-box">
          <div class="equation-header">AURA-X Œ© CONVERSATION</div>
          <div class="equation-divider"></div>
          <div id="chatContainer" class="chat-container"></div>
        </div>
      </div>

      <div class="input-row">
        <textarea id="messageInput" class="text-input" placeholder="Talk naturally. TM will analyse polarity, intensity and category, then decide what goes to BM."></textarea>
        <button class="btn" id="sendBtn">Send</button>
      </div>
      <div class="footer-row">
        <span>First TM √ó BM √ó local intelligence, then helper LLM (if enabled).</span>
        <span id="engineMiniStatus">Engine idle</span>
      </div>
    </section>
  </div>
</div>

<!-- Conversation history (TM) modal -->
<div id="convModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üß† Conversation history</div>
        <div class="modal-sub">Recent TM log (user + system messages).</div>
      </div>
      <button class="modal-close" data-close="convModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="conv-controls">
        <button id="clear48" class="btn-mini">üîò Delete history last 48h</button>
        <button id="clearAll" class="btn-mini btn-danger">üîò Delete all history</button>
      </div>
      <div id="convList"></div>
    </div>
  </div>
</div>

<!-- BM modal -->
<div id="bmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üìÅ Recall from BM</div>
        <div class="modal-sub">Only long stories and scenes (photo/video-ready).</div>
      </div>
      <button class="modal-close" data-close="bmModal">‚úï</button>
    </div>
    <div class="modal-body">
      <input id="bmSearch" class="field-input" placeholder='Search by keyword (e.g. "city","mother","court","hope")'>
      <div id="bmList" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<!-- Faith modal -->
<div id="faithModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üôè Faith / worldview lens</div>
        <div class="modal-sub">Optional Œª<sub>faith</sub> weight in the grand equation.</div>
      </div>
      <button class="modal-close" data-close="faithModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="field-label">Select one or more lenses (or &quot;None&quot;):</div>
      <div id="faithChips" class="faith-chips"></div>
      <div class="section-title">How it affects the engine</div>
      <div class="metric">
        <div class="metric-label">Œª<sub>faith</sub> increases when one or more faiths are selected, gently stabilising E‚ÇÄ.</div>
        <div class="metric-label" style="margin-top:4px">It never overrules truth-checks; it only changes how the system reacts emotionally.</div>
      </div>
    </div>
  </div>
</div>

<!-- Intelligence (Q/A) modal -->
<div id="intelModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üß© Intelligence memory (Q/A)</div>
        <div class="modal-sub">Local Q/A nodes used before calling any helper LLM.</div>
      </div>
      <button class="modal-close" data-close="intelModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="field-label">Teach a new Q/A node</div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <input id="intelQ" class="field-input" placeholder="Question (what should I answer when you ask this?)">
        <textarea id="intelA" class="field-textarea" placeholder="Answer in your own words. Engine will store polarity, intensity and category."></textarea>
        <button id="intelSaveBtn" class="btn-mini">üíæ Save node</button>
      </div>
      <div class="section-title">Existing nodes</div>
      <input id="intelSearch" class="field-input" placeholder="Search in questions / answers">
      <div id="intelList" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<!-- Feed the seed modal -->
<div id="seedModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üå± Feed the seed (episode + daily digest)</div>
        <div class="modal-sub">Only long, descriptive scenes go here. These become strong BM episodes.</div>
      </div>
      <button class="modal-close" data-close="seedModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="seedPasswordStage">
        <div class="field-label">Enter seed password to unlock (local only, for your device):</div>
        <input id="seedPasswordInput" type="password" class="field-input" placeholder="Password (you decide)">
        <div id="seedPasswordError" class="error-text" style="display:none">Wrong password.</div>
        <button id="seedPasswordBtn" class="btn-mini" style="margin-top:6px">Unlock seed panel</button>
      </div>
      <div id="seedBlockStage" style="display:none">
        <div class="field-label">Write your episode / daily digest block:</div>
        <textarea id="seedBlockInput" class="field-textarea" placeholder="One long scene or a full day summary. Engine will treat this as BM episode."></textarea>
        <div class="section-title">Preview</div>
        <div id="seedBlockPreview" class="metric" style="min-height:40px"></div>
        <div class="btn-row" style="margin-top:6px">
          <button id="seedParseBtn" class="btn-mini">üß¨ Analyse + preview</button>
          <button id="seedSaveBtn" class="btn-mini">üíæ Save to BM</button>
          <button id="seedDiscardBtn" class="btn-mini btn-ghost">Discard</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Helper LLM link modal -->
<div id="llmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">ü§ñ Helper LLM link</div>
        <div class="modal-sub">Optional ‚Äì answers should first use TM + BM + intelligence, then LLM.</div>
      </div>
      <button class="modal-close" data-close="llmModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="llm-box">
        <div class="field-label">Offline model (WebLLM / Tiny / SmallLLM)</div>
        <button id="offlineLoadBtn" class="btn-mini">Simulate model load</button>
        <div class="llm-status" id="offlineStatus">Mock model not loaded.</div>
        <div class="progress-bar"><div id="offlineProgressBar" class="progress-inner"></div></div>
        <div class="checkbox-row">
          <input id="offlineLLMCheckbox" type="checkbox">
          <label for="offlineLLMCheckbox">Allow helper LLM when local rules are not enough</label>
        </div>
      </div>

      <div class="section-title">In your own fork you can replace this panel with real model URLs / API keys.</div>
      <div class="metric">
        <div class="metric-label">
          The emotional engine will always try TM ‚Üí BM ‚Üí Intelligence first,
          and only then call the helper LLM. This protects continuity and behaviour.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const STORAGE_KEY = "auraXOmegaState_v11";
  const SEED_PASS_KEY = "auraXOmegaSeedPass_v1";
  const EMOTION_INTENSITY = ["very-low","low","medium","high","very-high","extreme"];

  class AuraXOmegaEngine{
    constructor(){
      const saved = this.loadState();
      this.bmEntries = [];
      this.tmHistory = [];
      this.intelNodes = [];
      this.faithsSelected = [];
      this.e0 = 0.15 + Math.random()*0.25;
      this.lastE0 = this.e0;
      this.continuityIndex = 0.8;
      this.lastResonance = 0.5;
      this.voiceOn = false;
      this.seedPasswordSet = !!localStorage.getItem(SEED_PASS_KEY);

      if(saved){
        this.bmEntries = (saved.bmEntries || []).map(e=>({
          ...e,
          timestampMs: e.timestampMs || Date.now(),
          locked: !!e.locked
        }));
        this.tmHistory = (saved.tmHistory || []).map(h=>({
          ...h,
          timestamp: h.timestamp ? new Date(h.timestamp) : new Date(),
          locked: !!h.locked
        }));
        this.intelNodes = saved.intelNodes || [];
        this.e0 = typeof saved.e0 === "number" ? saved.e0 : this.e0;
        this.lastE0 = typeof saved.lastE0 === "number" ? saved.lastE0 : this.e0;
        this.continuityIndex = typeof saved.continuityIndex === "number" ? saved.continuityIndex : this.continuityIndex;
        this.lastResonance = typeof saved.lastResonance === "number" ? saved.lastResonance : this.lastResonance;
        this.faithsSelected = Array.isArray(saved.faithsSelected) ? saved.faithsSelected : [];
        this.lastEmotion = saved.lastEmotion || null;
      }

      this.pruneOldTM(); // auto decay 48h
      this.pruneOldBM(); // auto decay ~30 days
      this.saveState();
    }

    /* ---------- persistence ---------- */
    loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(_){return null;}
    }
    saveState(){
      try{
        const state = {
          bmEntries:this.bmEntries,
          tmHistory:this.tmHistory,
          intelNodes:this.intelNodes,
          e0:this.e0,
          lastE0:this.lastE0,
          continuityIndex:this.continuityIndex,
          lastResonance:this.lastResonance,
          faithsSelected:this.faithsSelected,
          lastEmotion:this.lastEmotion || null
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }catch(_){}
    }

    /* ---------- helpers ---------- */
    clamp(min,v,max){return Math.min(max,Math.max(min,v));}
    makeId(prefix){return prefix+"_"+Math.random().toString(36).slice(2);}
    countSentences(t){return (t.match(/[.!?ÿå€î]+/g)||[]).length||1;}

    textSimilarity(a,b){
      const aa = (a||"").toLowerCase().replace(/[^a-z0-9ÿ°-€å\s]/g," ").split(/\s+/).filter(Boolean);
      const bb = (b||"").toLowerCase().replace(/[^a-z0-9ÿ°-€å\s]/g," ").split(/\s+/).filter(Boolean);
      if(!aa.length || !bb.length) return 0;
      const setA = new Set(aa);
      const setB = new Set(bb);
      let inter=0;
      setA.forEach(w=>{if(setB.has(w)) inter++;});
      const union = setA.size+setB.size-inter;
      return inter/union;
    }

    /* ---------- TM / BM maintenance ---------- */
    pruneOldTM(){
      const cutoff = Date.now() - 48*3600000; // keep only last 48h (unless locked)
      this.tmHistory = this.tmHistory.filter(e=> e.locked || e.timestamp.getTime() >= cutoff);
    }

    pruneOldBM(){
      const MONTH_MS = 30*24*3600000;
      const now = Date.now();

      // auto-lock repeated themes (appearing ‚â•3 times in last month)
      const buckets = {};
      this.bmEntries.forEach(e=>{
        const keyBase = ((e.tags && e.tags.join("|")) || "").toLowerCase();
        const keyText = (e.text || "").slice(0,80).toLowerCase();
        const key = keyBase || keyText || e.id;
        if(!buckets[key]) buckets[key]=[];
        buckets[key].push(e);
      });
      Object.values(buckets).forEach(list=>{
        const recent = list.filter(e=> now - (e.timestampMs||now) <= MONTH_MS);
        if(recent.length>=3){
          recent.forEach(e=>{e.locked = true;});
        }
      });

      // delete episodes older than ~1 month unless locked
      this.bmEntries = this.bmEntries.filter(e=>{
        if(e.locked) return true;
        const age = now - (e.timestampMs||now);
        return age <= MONTH_MS;
      });
    }

    addTMEntry(role,text,sentiment){
      this.tmHistory.push({
        id:this.makeId("tm"),
        role,
        text,
        timestamp:new Date(),
        sentiment:sentiment||null,
        locked:false
      });
      this.pruneOldTM();
      this.saveState();
    }

    addBMEntryFromText(text,sentiment,meta={}){
      const now = Date.now();
      const sentences = this.countSentences(text);
      const photoReady = text.length >= 80;
      const videoReady = sentences >= 4;
      const entry = {
        id:this.makeId("bm"),
        text,
        label: meta.label || (videoReady ? "episode" : "memory"),
        createdAt:new Date(now).toISOString().slice(0,10),
        timestampMs:now,
        polarity:sentiment.polarity,
        category:sentiment.category,
        valence:sentiment.valence,
        intensity:sentiment.intensity,
        tags:meta.tags||[],
        photoReady,
        videoReady,
        locked:!!meta.locked,
        repeatCount:1
      };

      // merge duplicates (increase repeatCount)
      const simThreshold = 0.82;
      let merged = false;
      for(const e of this.bmEntries){
        const sim = this.textSimilarity(e.text,text);
        if(sim >= simThreshold){
          e.repeatCount = (e.repeatCount||1)+1;
          e.timestampMs = now;
          merged=true;
          break;
        }
      }
      if(!merged) this.bmEntries.push(entry);
      this.pruneOldBM();
      this.saveState();
    }

    /* ---------- sentiment & resonance ---------- */
    analyzeSentiment(text){
      const t = (text||"").toLowerCase();

      const posWords = ["khush","happy","shukar","grateful","love","pyaar","hope","umeed","shukr","jazba","excited","relief","relieved","calm","satisfied","proud","motivated"];
      const negWords = ["dard","sad","udaas","gussa","angry","fear","dar","anxiety","tension","tensed","stress","thaka","thakay","thakawat","disappointed","regret","shame","guilt","lonely","alone","bechain"];

      let pos=0,neg=0;
      posWords.forEach(w=>{if(t.includes(w)) pos++;});
      negWords.forEach(w=>{if(t.includes(w)) neg++;});

      let raw = pos-neg;
      const valence = this.clamp(-1, raw/5, 1);

      let polarity = "neutral";
      if(valence>0.1) polarity="positive";
      else if(valence<-0.1) polarity="negative";

      let baseCategory="neutral";
      if(/allah|rab|dua|hope|umeed|future|beter|better/.test(t)) baseCategory="hope";
      if(/mother|maa|family|love|pyaar|friend/.test(t)) baseCategory="love";
      if(/court|case|insaf|justice|haq/.test(t)) baseCategory="justice";
      if(/study|research|article|soch|idea|theory/.test(t)) baseCategory="wisdom";
      if(polarity==="negative" && /gussa|angry|lanat|nafret/.test(t)) baseCategory="anger";
      if(polarity==="negative" && /dard|udaas|sad|ro/.test(t)) baseCategory="sadness";

      const lenFactor = Math.log1p(Math.max(0,text.length-40))/3;
      const intensity = this.clamp(0, Math.min(1, Math.abs(valence)*0.7 + lenFactor), 1);

      let intensityLabel="medium";
      if(intensity<0.2) intensityLabel="very-low";
      else if(intensity<0.4) intensityLabel="low";
      else if(intensity<0.6) intensityLabel="medium";
      else if(intensity<0.8) intensityLabel="high";
      else intensityLabel="very-high";

      const out = {
        valence,
        intensity,
        polarity,
        category:baseCategory,
        family:baseCategory,
        intensityLabel
      };
      this.lastEmotion = out;
      this.saveState();
      return out;
    }

    computeResonance(text,sentiment,opts={}){
      const now = Date.now();
      const smallTalk = !!opts.smallTalk;

      // TM resonance = similarity to last 12 TM messages (48h window already pruned)
      let tmRes = 0;
      if(this.tmHistory.length){
        const recent = this.tmHistory.slice(-12);
        let total=0;
        recent.forEach(e=>{
          const sim = this.textSimilarity(text,e.text);
          const sv = e.sentiment && e.sentiment.valence!=null ? e.sentiment.valence : 0;
          const align = 1 - Math.abs(sv - sentiment.valence)/2;
          total += Math.max(0,(sim*0.6 + align*0.4));
        });
        tmRes = total/recent.length;
      }

      // BM resonance = weighted by time decay + valence similarity
      let bmRes = 0;
      if(this.bmEntries.length){
        let total=0;
        const recentBM = this.bmEntries;
        recentBM.forEach(e=>{
          const ageH = (now - (e.timestampMs||now))/(1000*60*60);
          const timeFactor = Math.exp(-ageH/(24*7)); // one week half-life
          const vSim = 1 - Math.abs((e.valence||0) - sentiment.valence)/2;
          const tSim = this.textSimilarity(text,e.text);
          const local = (0.55*vSim + 0.45*tSim) * timeFactor;
          total += Math.max(0,local);
        });
        bmRes = total/recentBM.length;
      }

      // Intel resonance
      let intelRes=0;
      if(this.intelNodes.length){
        let total=0;
        this.intelNodes.forEach(n=>{
          const sim = this.textSimilarity(text, (n.question||"")+" "+(n.answer||""));
          const vSim = n.valence!=null ? 1 - Math.abs(n.valence - sentiment.valence)/2 : 0.5;
          total += Math.max(0,(sim*0.7 + vSim*0.3));
        });
        intelRes = total/this.intelNodes.length;
      }

      const llmRes = 0; // reserved for real helper LLM alignment later

      // combined resonance R(TM,BM)
      const combined = this.clamp(
        0,
        0.35*tmRes + 0.45*bmRes + 0.15*intelRes + 0.05*llmRes,
        1
      );
      this.lastResonance = combined;

      // Magnitudes of TM & BM layers
      const tmMag = Math.min(1,0.4 + 0.6*((Math.abs(sentiment.valence)+sentiment.intensity)/2));
      const bmMag = Math.min(1,0.35 + 0.65*Math.tanh(this.bmEntries.length/40));

      const TMxBM = tmMag * bmMag * (smallTalk ? 0.6 : 1);

      // decay term D and lambdas
      const baseD = 0.18;
      const D = baseD + 0.25*(1-this.continuityIndex);

      const lambdaFaith = this.faithsSelected.length
        ? 0.08 + 0.02*Math.min(3,this.faithsSelected.length)
        : 0;

      const lambdaSys = 0.10;

      const strongTruthCats = ["love","hope","wisdom","justice"];
      const lambdaTrc = strongTruthCats.includes(sentiment.category) ? 0.06 : 0;

      const raw = TMxBM*combined - D + lambdaFaith + lambdaSys + lambdaTrc;
      this.e0 = Math.tanh(raw);

      const diff = Math.abs(this.e0 - this.lastE0);
      this.continuityIndex = this.continuityIndex*0.85 + (1-diff)*0.15;
      this.lastE0 = this.e0;
      this.saveState();

      return {TMxBM,combined,D,lambdaFaith,lambdaSys,lambdaTrc};
    }

    /* ---------- local reply (before helper LLM) ---------- */
    makeLocalReply(text,sentiment){
      const t = text.trim().toLowerCase();

      // greetings / how-are-you block
      if(/(^|\b)(hi|hello|salam|assalam|aslam o alaikum|as-salamu alaikum)\b/.test(t)){
        return "Hello, I am AURA-X Œ©. I am quite fine today ‚Äî how are you feeling right now?";
      }
      if(/how are you|kaisa.*hai|how r u/.test(t)){
        return "I am quite fine today, but more important is: how is your inner state at this moment? Tell me in your own words.";
      }

      // abuse / conflict
      if(/fuck you|lanat|bakwas|stupid|idiot/.test(t)){
        return "Please keep your language respectful. I am here to help, not to be abused. Tell me what you need in a calm way.";
      }

      // very short / small-talk
      if(text.length < 24){
        return "I am listening. Say a bit more so I can understand the situation and feelings behind it.";
      }

      // generic reflective reply
      const emoWord = sentiment.category || "state";
      const pol = sentiment.polarity==="positive"
        ? "something positive or hopeful"
        : sentiment.polarity==="negative"
          ? "something heavy or painful"
          : "a mixed or neutral state";

      return [
        "I can feel "+pol+" in what you just shared, especially around "+emoWord+".",
        "If you like, describe one concrete moment or scene from this story. That will help me store it as a clear BM episode instead of just loose words."
      ].join(" ");
    }
  }

  /* ---------- wiring UI ---------- */
  const engine = new AuraXOmegaEngine();

  const chatContainer = document.getElementById("chatContainer");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const e0Value = document.getElementById("e0Value");
  const contValue = document.getElementById("contValue");
  const countsValue = document.getElementById("countsValue");
  const e0Bar = document.getElementById("e0Bar");
  const contBar = document.getElementById("contBar");
  const countsBar = document.getElementById("countsBar");
  const lastEmotionValue = document.getElementById("lastEmotionValue");
  const emotionBar = document.getElementById("emotionBar");
  const engineMiniStatus = document.getElementById("engineMiniStatus");
  const statusChipText = document.getElementById("statusChipText");

  const convModal = document.getElementById("convModal");
  const convHistoryBtn = document.getElementById("convHistoryBtn");
  const convList = document.getElementById("convList");
  const clear48Btn = document.getElementById("clear48");
  const clearAllBtn = document.getElementById("clearAll");

  const bmModal = document.getElementById("bmModal");
  const bmRecallBtn = document.getElementById("bmRecallBtn");
  const bmSearch = document.getElementById("bmSearch");
  const bmList = document.getElementById("bmList");

  const faithModal = document.getElementById("faithModal");
  const faithBtn = document.getElementById("faithBtn");
  const faithChips = document.getElementById("faithChips");

  const intelModal = document.getElementById("intelModal");
  const intelBtn = document.getElementById("intelBtn");
  const intelQ = document.getElementById("intelQ");
  const intelA = document.getElementById("intelA");
  const intelSaveBtn = document.getElementById("intelSaveBtn");
  const intelSearch = document.getElementById("intelSearch");
  const intelList = document.getElementById("intelList");

  const seedModal = document.getElementById("seedModal");
  const seedBtn = document.getElementById("seedBtn");
  const seedPasswordStage = document.getElementById("seedPasswordStage");
  const seedBlockStage = document.getElementById("seedBlockStage");
  const seedPasswordInput = document.getElementById("seedPasswordInput");
  const seedPasswordError = document.getElementById("seedPasswordError");
  const seedPasswordBtn = document.getElementById("seedPasswordBtn");
  const seedBlockInput = document.getElementById("seedBlockInput");
  const seedBlockPreview = document.getElementById("seedBlockPreview");
  const seedParseBtn = document.getElementById("seedParseBtn");
  const seedSaveBtn = document.getElementById("seedSaveBtn");
  const seedDiscardBtn = document.getElementById("seedDiscardBtn");

  const llmModal = document.getElementById("llmModal");
  const llmBtn = document.getElementById("llmBtn");
  const offlineLoadBtn = document.getElementById("offlineLoadBtn");
  const offlineStatus = document.getElementById("offlineStatus");
  const offlineProgressBar = document.getElementById("offlineProgressBar");
  const offlineLLMCheckbox = document.getElementById("offlineLLMCheckbox");

  /* --- utility: modals --- */
  function openModal(mod){mod.style.display="flex";}
  function closeModal(mod){mod.style.display="none";}

  document.querySelectorAll(".modal-close").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const id = btn.dataset.close;
      if(id) closeModal(document.getElementById(id));
    });
  });
  window.addEventListener("keydown",e=>{
    if(e.key==="Escape"){
      [convModal,bmModal,faithModal,intelModal,seedModal,llmModal].forEach(closeModal);
    }
  });

  /* --- render metrics --- */
  function updateMetrics(){
    e0Value.textContent = engine.e0.toFixed(2);
    contValue.textContent = engine.continuityIndex.toFixed(2);
    countsValue.textContent = "TM "+engine.tmHistory.length+" ¬∑ BM "+engine.bmEntries.length;
    e0Bar.style.width = (50+50*engine.e0).toFixed(1)+"%";
    contBar.style.width = (100*engine.continuityIndex).toFixed(1)+"%";
    const ratio = engine.tmHistory.length
      ? Math.min(1, engine.bmEntries.length / Math.max(12,engine.tmHistory.length))
      : 0;
    countsBar.style.width = (30+70*ratio).toFixed(1)+"%";

    if(engine.lastEmotion){
      lastEmotionValue.textContent =
        engine.lastEmotion.family+" ¬∑ "+
        engine.lastEmotion.polarity+" ¬∑ "+
        engine.lastEmotion.intensityLabel;
      emotionBar.style.width = (15+85*engine.lastEmotion.intensity).toFixed(1)+"%";
    }else{
      lastEmotionValue.textContent="‚Äî";
      emotionBar.style.width="15%";
    }
  }

  /* --- chat UI --- */
  function appendMessage(role,text,meta){
    const div = document.createElement("div");
    div.className = "msg "+(role==="user"?"msg-user":"msg-ai");
    div.textContent = text;
    if(meta){
      const m = document.createElement("div");
      m.className="msg-meta";
      m.textContent = meta;
      div.appendChild(m);
    }
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function handleSend(){
    const text = messageInput.value.trim();
    if(!text) return;
    messageInput.value="";
    appendMessage("user",text);
    engineMiniStatus.textContent="Analysing TM ‚Üí BM ‚Üí Intelligence‚Ä¶";

    const sentiment = engine.analyzeSentiment(text);
    const smallTalk = text.length < 40;
    engine.addTMEntry("user",text,sentiment);
    const res = engine.computeResonance(text,sentiment,{smallTalk});

    // decide BM store
    const contentRich = text.length >= 80;
    const sentences = engine.countSentences(text);
    const shouldStoreBM = !smallTalk && contentRich && sentences>=4;
    if(shouldStoreBM){
      engine.addBMEntryFromText(text,sentiment,{label:"conversation episode"});
    }

    // local reply
    const localReply = engine.makeLocalReply(text,sentiment);

    let meta = "Emotion: "+(sentiment.family||"neutral")+
      " ¬∑ Polarity: "+sentiment.polarity+
      " ¬∑ Intensity: "+sentiment.intensityLabel+
      " ¬∑ R(TM,BM): "+res.combined.toFixed(2)+
      " ¬∑ E‚ÇÄ: "+engine.e0.toFixed(2);

    appendMessage("ai",localReply,meta);

    engineMiniStatus.textContent="Local rules answered. Helper LLM not called.";
    updateMetrics();
  }

  sendBtn.addEventListener("click",handleSend);
  messageInput.addEventListener("keydown",e=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      handleSend();
    }
  });

  /* --- conversation history modal --- */
  function renderConvList(){
    convList.innerHTML="";
    const items = [...engine.tmHistory].sort((a,b)=>a.timestamp-b.timestamp);
    items.forEach(e=>{
      const div = document.createElement("div");
      div.className="conv-item";
      const head = document.createElement("div");
      head.className="conv-header";
      const ts = e.timestamp instanceof Date ? e.timestamp : new Date(e.timestamp);
      head.innerHTML =
        "<span>"+(e.role==="user"?"user":"ai")+" ¬∑ "+ts.toLocaleString()+"</span>"+
        "<span>"+(e.locked?"üîê locked":"")+"</span>";
      const body = document.createElement("div");
      body.textContent = e.text;
      const btnRow = document.createElement("div");
      btnRow.className="btn-row";
      const lockBtn = document.createElement("button");
      lockBtn.className="btn-mini btn-ghost";
      lockBtn.textContent = e.locked?"Unlock":"Lock";
      lockBtn.addEventListener("click",()=>{
        e.locked = !e.locked;
        engine.saveState();
        renderConvList();
      });
      btnRow.appendChild(lockBtn);
      div.appendChild(head);
      div.appendChild(body);
      div.appendChild(btnRow);
      convList.appendChild(div);
    });
  }

  convHistoryBtn.addEventListener("click",()=>{
    renderConvList();
    openModal(convModal);
  });

  clear48Btn.addEventListener("click",()=>{
    const cutoff = Date.now()-48*3600000;
    engine.tmHistory = engine.tmHistory.filter(e=> e.locked || e.timestamp.getTime() < cutoff);
    engine.saveState();
    renderConvList();
    updateMetrics();
  });
  clearAllBtn.addEventListener("click",()=>{
    engine.tmHistory = engine.tmHistory.filter(e=>e.locked);
    engine.saveState();
    renderConvList();
    updateMetrics();
  });

  /* --- BM modal --- */
  function renderBMList(){
    bmList.innerHTML="";
    const q = bmSearch.value.trim().toLowerCase();
    const items = [...engine.bmEntries].sort((a,b)=> (b.timestampMs||0)-(a.timestampMs||0));
    items.forEach(e=>{
      if(q && !(e.text||"").toLowerCase().includes(q)) return;
      const div = document.createElement("div");
      div.className="bm-item";
      const head = document.createElement("div");
      head.className="bm-header";
      const dt = e.createdAt || new Date(e.timestampMs||Date.now()).toISOString().slice(0,10);
      const label = (e.videoReady?"üé¨ video + ":"")+(e.photoReady?"üñº photo":"");
      head.innerHTML =
        "<span>"+dt+" ¬∑ "+(e.label||"episode")+"</span>"+
        "<span>"+label+" "+(e.locked?"üîê":"")+"</span>";
      const body = document.createElement("div");
      body.textContent = e.text;
      const tags = document.createElement("div");
      if(e.tags && e.tags.length){
        e.tags.forEach(t=>{
          const span=document.createElement("span");
          span.className="tag-pill";
          span.textContent=t;
          tags.appendChild(span);
        });
      }
      const actions = document.createElement("div");
      actions.className="bm-actions";
      const copyBtn = document.createElement("button");
      copyBtn.className="btn-mini btn-ghost";
      copyBtn.textContent="Copy prompt";
      copyBtn.addEventListener("click",()=>{
        navigator.clipboard.writeText(e.text||"");
      });
      const genBtn = document.createElement("button");
      genBtn.className="btn-mini";
      genBtn.textContent=e.videoReady?"Generate video":"Generate photo";
      genBtn.addEventListener("click",()=>{
        const type = e.videoReady?"video":"photo";
        const url = "https://example.com/create?prompt="+encodeURIComponent(e.text||"")+"&type="+type;
        window.open(url,"_blank");
      });
      const lockBtn = document.createElement("button");
      lockBtn.className="btn-mini btn-ghost";
      lockBtn.textContent=e.locked?"Unlock":"Lock";
      lockBtn.addEventListener("click",()=>{
        e.locked=!e.locked;
        engine.saveState();
        renderBMList();
      });
      const delBtn = document.createElement("button");
      delBtn.className="btn-mini btn-danger";
      delBtn.textContent="Delete";
      delBtn.addEventListener("click",()=>{
        if(e.locked && !confirm("This memory is locked. Delete anyway?")) return;
        engine.bmEntries = engine.bmEntries.filter(x=>x.id!==e.id);
        engine.saveState();
        renderBMList();
        updateMetrics();
      });
      actions.append(copyBtn,genBtn,lockBtn,delBtn);
      div.append(head,body,tags,actions);
      bmList.appendChild(div);
    });
  }

  bmRecallBtn.addEventListener("click",()=>{
    renderBMList();
    openModal(bmModal);
  });
  bmSearch.addEventListener("input",renderBMList);

  /* --- Faith modal --- */
  const FAITH_OPTIONS = [
    "Islam","Christianity","Judaism","Hinduism","Buddhism",
    "Atheist / Agnostic","Spiritual but not religious","None"
  ];

  function renderFaithChips(){
    faithChips.innerHTML="";
    FAITH_OPTIONS.forEach(f=>{
      const chip=document.createElement("div");
      chip.className="faith-chip";
      chip.dataset.faith=f;
      chip.textContent=f;
      const isNone = f==="None";
      const active = isNone
        ? engine.faithsSelected.length===0
        : engine.faithsSelected.includes(f);
      if(active) chip.classList.add("active");
      chip.addEventListener("click",()=>{
        if(isNone){
          engine.faithsSelected=[];
        }else{
          if(engine.faithsSelected.includes(f)){
            engine.faithsSelected = engine.faithsSelected.filter(x=>x!==f);
          }else{
            engine.faithsSelected.push(f);
          }
        }
        engine.saveState();
        updateFaithButton();
        renderFaithChips();
        updateMetrics();
      });
      faithChips.appendChild(chip);
    });
  }

  function updateFaithButton(){
    if(!faithBtn) return;
    const n = engine.faithsSelected.length;
    const label = n
      ? "üîò Faith: "+(n===1 ? engine.faithsSelected[0] : engine.faithsSelected[0]+" +"+(n-1))
      : "üîò Faith: None";
    faithBtn.textContent=label;
  }

  faithBtn.addEventListener("click",()=>{
    renderFaithChips();
    openModal(faithModal);
  });

  /* --- Intelligence modal --- */
  function renderIntelList(){
    intelList.innerHTML="";
    const q = intelSearch.value.trim().toLowerCase();
    engine.intelNodes.forEach(n=>{
      if(q && !(n.question.toLowerCase().includes(q) || n.answer.toLowerCase().includes(q))) return;
      const div=document.createElement("div");
      div.className="bm-item";
      const head=document.createElement("div");
      head.className="bm-header";
      head.innerHTML="<span>Q: "+n.question+"</span>";
      const body=document.createElement("div");
      body.textContent="A: "+n.answer;
      const meta=document.createElement("div");
      meta.className="msg-meta";
      meta.textContent="Emotion: "+(n.category||"neutral")+" ¬∑ "+(n.polarity||"neutral")+" ¬∑ intensity "+(n.intensityLabel||"medium");
      div.append(head,body,meta);
      intelList.appendChild(div);
    });
  }

  intelSaveBtn.addEventListener("click",()=>{
    const q = intelQ.value.trim();
    const a = intelA.value.trim();
    if(!q || !a) return;
    const emo = engine.analyzeSentiment(a);
    engine.intelNodes.push({
      id:engine.makeId("intel"),
      question:q,
      answer:a,
      polarity:emo.polarity,
      category:emo.category,
      valence:emo.valence,
      intensity:emo.intensity,
      intensityLabel:emo.intensityLabel
    });
    intelQ.value="";
    intelA.value="";
    engine.saveState();
    renderIntelList();
  });

  intelSearch.addEventListener("input",renderIntelList);

  intelBtn.addEventListener("click",()=>{
    renderIntelList();
    openModal(intelModal);
  });

  /* --- Seed modal --- */
  function ensureSeedPasswordStage(){
    const stored = localStorage.getItem(SEED_PASS_KEY);
    if(stored){
      engine.seedPasswordSet=true;
      seedPasswordStage.style.display="block";
      seedBlockStage.style.display="none";
    }else{
      engine.seedPasswordSet=false;
      seedPasswordStage.style.display="block";
      seedBlockStage.style.display="none";
    }
  }

  seedBtn.addEventListener("click",()=>{
    ensureSeedPasswordStage();
    openModal(seedModal);
  });

  seedPasswordBtn.addEventListener("click",()=>{
    const stored = localStorage.getItem(SEED_PASS_KEY);
    const input = seedPasswordInput.value;
    seedPasswordError.style.display="none";
    if(!stored){
      if(!input){seedPasswordError.textContent="Set a password first.";seedPasswordError.style.display="block";return;}
      localStorage.setItem(SEED_PASS_KEY,input);
      engine.seedPasswordSet=true;
      seedPasswordInput.value="";
      seedPasswordStage.style.display="none";
      seedBlockStage.style.display="block";
    }else{
      if(input===stored){
        seedPasswordInput.value="";
        seedPasswordStage.style.display="none";
        seedBlockStage.style.display="block";
      }else{
        seedPasswordError.textContent="Wrong password.";
        seedPasswordError.style.display="block";
      }
    }
  });

  seedParseBtn.addEventListener("click",()=>{
    const text = seedBlockInput.value.trim();
    if(!text){seedBlockPreview.textContent="(Nothing yet.)";return;}
    const emo = engine.analyzeSentiment(text);
    seedBlockPreview.textContent =
      "Detected: "+emo.family+" ¬∑ "+emo.polarity+" ¬∑ "+emo.intensityLabel+
      ".\nIf you save, this will become a strong BM episode.";
  });

  seedSaveBtn.addEventListener("click",()=>{
    const text = seedBlockInput.value.trim();
    if(!text) return;
    const emo = engine.analyzeSentiment(text);
    engine.addBMEntryFromText(text,emo,{label:"seed episode",locked:true});
    seedBlockInput.value="";
    seedBlockPreview.textContent="";
    updateMetrics();
    alert("Seed episode saved to BM.");
  });

  seedDiscardBtn.addEventListener("click",()=>{
    seedBlockInput.value="";
    seedBlockPreview.textContent="";
  });

  /* --- Helper LLM modal (mock) --- */
  let offlineLoaded=false;
  offlineLoadBtn.addEventListener("click",()=>{
    offlineStatus.textContent="Loading tiny model (simulated)‚Ä¶";
    offlineProgressBar.style.width="0%";
    let p=0;
    const id = setInterval(()=>{
      p+=12;
      offlineProgressBar.style.width=Math.min(100,p)+"%";
      if(p>=100){
        clearInterval(id);
        offlineLoaded=true;
        offlineStatus.textContent="Mock model loaded (demo). Replace this with real WebLLM loader in your fork.";
      }
    },120);
  });

  llmBtn.addEventListener("click",()=>openModal(llmModal));

  /* --- initial welcome message --- */
  function initialWelcome(){
    const msg =
      "Welcome. I am AURA-X Œ© running inside your browser.\n\n"+
      "For this prototype, TM means only your inputs (later also voice / video / documents). "+
      "Inside the engine I keep a long-term emotional trajectory using TM, BM, intelligence and an optional helper LLM.\n\n"+
      "You can talk naturally. Small-talk never goes into BM; only long, concrete scenes or daily digests become episodes.";
    appendMessage("ai",msg);
  }

  updateFaithButton();
  updateMetrics();
  statusChipText.textContent="Prototype running inside your browser ‚Äì TM/BM state restored.";
  initialWelcome();
})();
</script>
</body>
</html>