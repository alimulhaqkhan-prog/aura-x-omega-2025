<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© v1 ‚Äì Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #fdf4e3; /* book-page background */
      color: #111827;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }
    .app {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Header */
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .title-block h1 {
      font-size: 1.4rem;
      letter-spacing: 0.08em;
    }
    .title-block p {
      font-size: 0.7rem;
      opacity: 0.8;
      line-height: 1.2;
    }
    .mode-pill {
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid #60a5fa;
      font-size: 0.63rem;
      text-align: right;
      background: #e0f2fe;
      color: #0f172a;
    }
    .mode-pill span { display: block; }
    .mode-pill .mode-label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.9;
    }
    .mode-pill .mode-sub {
      color: #047857;
      font-weight: 500;
    }
    .mode-pill .engine { opacity: 0.7; }

    /* Top buttons */
    .top-buttons {
      display: flex;
      flex-wrap: nowrap;
      gap: 6px;
      margin-top: 4px;
    }
    .pill-btn {
      flex: 1;
      border-radius: 999px;
      padding: 8px 6px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: background 0.15s, transform 0.08s, box-shadow 0.15s;
      min-width: 0;
      white-space: nowrap;
      box-shadow: 0 1px 2px rgba(15,23,42,0.08);
    }
    .pill-btn span.icon { font-size: 0.95rem; }
    .pill-btn.primary {
      border-color: #f59e0b;
      background: #fffbeb;
    }
    .pill-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(15,23,42,0.15);
    }

    /* Cards */
    .card {
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px solid rgba(148,163,184,0.5);
      background: #fefce8;
      font-size: 0.8rem;
      line-height: 1.4;
      box-shadow: 0 2px 4px rgba(15,23,42,0.05);
    }
    .card.golden {
      background: #fef3c7;
      border-color: #fbbf24;
      color: #92400e;
      font-weight: 500;
    }
    .card.equation {
      background: #f9fafb;
      border-style: dashed;
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.75rem;
      color: #111827;
    }
    .card.equation .label {
      opacity: 0.9;
      margin-bottom: 4px;
      font-weight: 600;
      letter-spacing: 0.06em;
    }
    .card.equation .formula-main {
      margin: 4px 0 6px;
    }
    .card.equation .formula-values { opacity: 0.85; }

    /* Chat area */
    .chat-area {
      flex: 1;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.5);
      background: #fffbeb;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 140px;
      box-shadow: inset 0 0 0 1px rgba(254,243,199,0.5);
    }

    .reaction-banner {
      display: none;
      border-radius: 12px;
      padding: 6px 8px;
      font-size: 0.75rem;
      line-height: 1.3;
      border: 1px solid rgba(148,163,184,0.7);
      background: #f0fdf4;
    }
    .reaction-banner strong {
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 0.7rem;
    }
    .reaction-positive {
      border-color: #22c55e;
      color: #166534;
      background: #dcfce7;
    }
    .reaction-negative {
      border-color: #ef4444;
      color: #991b1b;
      background: #fee2e2;
    }
    .reaction-neutral {
      border-color: #eab308;
      color: #854d0e;
      background: #fef9c3;
    }

    .chat-log {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 0.8rem;
    }
    .msg { margin-bottom: 8px; }
    .msg-user { text-align: right; color: #1d4ed8; }
    .msg-bot { text-align: left; color: #111827; }

    .tm-pill {
      align-self: flex-start;
      border-radius: 999px;
      padding: 4px 10px;
      background: #eef2ff;
      border: 1px solid #c7d2fe;
      font-size: 0.78rem;
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Courier New", monospace;
      color: #111827;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }
    .input-row textarea {
      flex: 1;
      resize: none;
      min-height: 46px;
      max-height: 90px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #111827;
      padding: 8px 12px;
      font-size: 0.8rem;
    }
    .input-row textarea:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px #bbf7d0;
    }

    .send-btn {
      border-radius: 999px;
      padding: 10px 18px;
      border: none;
      background: #16a34a;
      color: white;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 0 0 1px rgba(22,163,74,0.6), 0 10px 18px rgba(22,163,74,0.4);
      transition: transform 0.08s, box-shadow 0.08s, background 0.08s;
    }
    .send-btn:active {
      transform: translateY(1px);
      box-shadow: 0 6px 12px rgba(22,163,74,0.45);
      background: #15803d;
    }

    .footer-line {
      font-size: 0.72rem;
      opacity: 0.75;
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .voice-toggle {
      border-radius: 999px;
      padding: 5px 12px;
      border: 1px solid #16a34a;
      background: #ecfdf5;
      color: #166534;
      font-size: 0.75rem;
      cursor: pointer;
    }
    .voice-toggle.inactive {
      border-color: #9ca3af;
      background: #f9fafb;
      color: #4b5563;
    }

    /* Auto recall hint */
    .auto-recall-hint {
      margin-top: 2px;
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid #facc15;
      background: #fef9c3;
      font-size: 0.72rem;
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }
    .auto-recall-hint button {
      border-radius: 999px;
      border: none;
      padding: 3px 8px;
      font-size: 0.7rem;
      cursor: pointer;
      background: #1d4ed8;
      color: #e5e7eb;
    }

    /* Modals shared */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }
    .modal {
      width: 100%;
      max-width: 480px;
      max-height: 80vh;
      background: #fefce8;
      border-radius: 20px;
      border: 1px solid #e5e7eb;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 10px 25px rgba(15,23,42,0.25);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .modal-title {
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .modal-close {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.75rem;
      cursor: pointer;
      background: #111827;
      color: #f9fafb;
    }
    .modal-body {
      flex: 1;
      overflow-y: auto;
      font-size: 0.78rem;
    }

    /* BM Viewer */
    .bm-day {
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(148,163,184,0.7);
      padding-bottom: 6px;
    }
    .bm-day-title {
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 0.8rem;
      color: #111827;
    }
    .bm-node {
      margin-bottom: 8px;
      padding: 6px 8px;
      border-radius: 12px;
      background: #fffbeb;
      border: 1px solid #e5e7eb;
    }
    .bm-node-title {
      font-weight: 500;
      margin-bottom: 2px;
    }
    .bm-node-meta {
      font-size: 0.7rem;
      opacity: 0.9;
      margin-bottom: 2px;
    }
    .bm-node-polarity {
      font-size: 0.7rem;
      margin-bottom: 4px;
    }
    .bm-node-polarity span.pos {
      color: #15803d;
      font-weight: 600;
    }
    .bm-node-polarity span.neg {
      color: #b91c1c;
      font-weight: 600;
    }
    .bm-node-polarity span.neu {
      color: #4b5563;
      font-weight: 600;
    }
    .layer-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 4px;
    }
    .layer-chip {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 0.65rem;
      color: #111827;
      font-weight: 600;
    }
    .L1 { background: #dbeafe; }
    .L2 { background: #fee2e2; }
    .L3 { background: #fed7aa; }
    .L4 { background: #e9d5ff; }
    .L5 { background: #bbf7d0; }
    .L6 { background: #fef3c7; }
    .L7 { background: #e5e7eb; }
    .delete-day-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.7rem;
      cursor: pointer;
      background: #b91c1c;
      color: #fee2e2;
      margin-left: auto;
      display: block;
      margin-top: 4px;
    }

    /* Recall modal */
    .recall-search { margin-bottom: 6px; }
    .recall-search input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #111827;
      padding: 6px 10px;
      font-size: 0.78rem;
    }
    .recall-node {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      margin-bottom: 6px;
      background: #fffbeb;
    }
    .copy-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.7rem;
      cursor: pointer;
      background: #1d4ed8;
      color: #e5e7eb;
      margin-top: 4px;
    }

    /* Options modal */
    .option-section-title {
      font-weight: 600;
      font-size: 0.8rem;
      margin: 6px 0 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.9;
    }
    .faith-note {
      font-size: 0.74rem;
      opacity: 0.85;
      margin-bottom: 6px;
    }
    .faith-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }
    .faith-pill {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 5px 10px;
      font-size: 0.73rem;
      cursor: pointer;
    }
    .faith-pill.active {
      background: #111827;
      border-color: #22c55e;
      color: #bbf7d0;
      font-weight: 500;
    }
    .option-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }
    .option-row span { font-size: 0.78rem; }
    .toggle {
      position: relative;
      width: 38px;
      height: 20px;
    }
    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #9ca3af;
      transition: .2s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .2s;
      border-radius: 50%;
    }
    input:checked + .slider { background-color: #22c55e; }
    input:checked + .slider:before { transform: translateX(18px); }

    #llmModelSelect {
      background: #ffffff;
      color: #111827;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 4px 8px;
      font-size: 0.75rem;
    }

    .options-footer-note {
      margin-top: 6px;
      font-size: 0.72rem;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header-top">
      <div class="title-block">
        <h1>AURA-X Œ©</h1>
        <p>EMOTIONAL CONTINUITY ¬∑ AEC ¬∑ CRM ¬∑ AECN ¬∑ RL¬≥ ¬∑ LR¬≥</p>
      </div>
      <div class="mode-pill" id="modePill">
        <span class="mode-label">MODE: OFFLINE PROTOTYPE</span>
        <span class="mode-sub">Universal Ethics ¬∑ Local BM</span>
        <span class="engine">Engine: Seed (local)</span>
      </div>
    </div>

    <!-- top buttons -->
    <div class="top-buttons">
      <button class="pill-btn" id="bmViewerBtn">
        <span class="icon">üß†</span><span>BM Viewer</span>
      </button>
      <button class="pill-btn primary" id="recallBtn">
        <span class="icon">üìÇ</span><span>Recall BM</span>
      </button>
      <button class="pill-btn" id="cleanupBtn">
        <span class="icon">‚ôªÔ∏è</span><span>Recycle 48h</span>
      </button>
      <button class="pill-btn" id="optionsBtn">
        <span class="icon">‚öôÔ∏è</span><span>Options</span>
      </button>
    </div>

    <!-- ethics banner in golden -->
    <div class="card golden" id="ethicsBanner">
      Avoid actions that generate negative emotions in yourself or others.
      Gently move toward choices that create calm, kindness, and positive feelings.
    </div>

    <!-- equation card -->
    <div class="card equation" id="equationCard">
      <div class="label">EMOTIONAL CONTINUITY EQUATION</div>
      <div class="formula-main" id="eqMain">
        E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)
      </div>
      <div class="formula-values" id="eqValues">
        TM, BM, D, Œª_faith, Œª_sys and Œ£C‚Çú are updated internally after every message.
      </div>
    </div>

    <!-- chat area -->
    <div class="chat-area">
      <div id="reactionBanner" class="reaction-banner"></div>
      <div class="chat-log" id="chatLog"></div>

      <div class="tm-pill">
        TM = Œ£(User Inputs) + (Seed + LLM)
      </div>

      <div class="input-row">
        <textarea id="userInput"
          placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."></textarea>
        <button class="send-btn" id="sendBtn">Send</button>
      </div>

      <div id="autoRecallHint" class="auto-recall-hint">
        <span id="autoRecallText">üí° Related memory found.</span>
        <button id="autoRecallOpenBtn">Open</button>
      </div>

      <div class="footer-line">
        <span>Prototype ¬∑ TM ‚Üí Analysis ‚Üí Equation ‚Üí BM save ‚Üí Reaction.</span>
        <button id="voiceToggle" class="voice-toggle">üîä Voice: On</button>
      </div>
    </div>
  </div>

  <!-- BM Viewer Modal -->
  <div class="modal-backdrop" id="bmModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>üß†</span> Bold Memory (BM)</div>
        <button class="modal-close" data-close="bmModalBackdrop">Close</button>
      </div>
      <div class="modal-body" id="bmModalBody"></div>
    </div>
  </div>

  <!-- Recall Modal (search all BM) -->
  <div class="modal-backdrop" id="recallModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>üìÇ</span> Recall from BM</div>
        <button class="modal-close" data-close="recallModalBackdrop">Close</button>
      </div>
      <div class="modal-body">
        <div class="recall-search">
          <input id="recallSearchInput"
            placeholder='Search all BM layers by keyword (e.g., "snow", "mother", "court", "hope").' />
        </div>
        <div id="recallList"></div>
      </div>
    </div>
  </div>

  <!-- Auto-Recall View Modal (single matched memory) -->
  <div class="modal-backdrop" id="recallViewModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>üí°</span> Auto-Recall Memory</div>
        <button class="modal-close" data-close="recallViewModalBackdrop">Close</button>
      </div>
      <div class="modal-body" id="recallViewBody"></div>
    </div>
  </div>

  <!-- Recycle / continuity buffer Modal -->
  <div class="modal-backdrop" id="recycleModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>‚ôªÔ∏è</span> Continuity buffer ‚Äì last 48 hours</div>
        <button class="modal-close" data-close="recycleModalBackdrop">Close</button>
      </div>
      <div class="modal-body" id="recycleModalBody"></div>
    </div>
  </div>

  <!-- Options Modal -->
  <div class="modal-backdrop" id="optionsModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>‚öôÔ∏è</span> AURA-X Œ© options</div>
        <button class="modal-close" data-close="optionsModalBackdrop">Close</button>
      </div>
      <div class="modal-body">
        <div class="option-section-title">Faith lens (optional)</div>
        <div class="faith-note">
          Universal ethics are always active. You can optionally pick a faith lens to shape
          encouragement lines locally. Nothing is sent to any external server.
        </div>
        <div class="faith-row" id="faithRow">
          <button class="faith-pill" data-faith="None">None</button>
          <button class="faith-pill" data-faith="Islam">Islam</button>
          <button class="faith-pill" data-faith="Christianity">Christianity</button>
          <button class="faith-pill" data-faith="Hinduism">Hinduism</button>
          <button class="faith-pill" data-faith="Buddhism">Buddhism</button>
          <button class="faith-pill" data-faith="Sikhism">Sikhism</button>
          <button class="faith-pill" data-faith="Judaism">Judaism</button>
          <button class="faith-pill" data-faith="Atheism / Humanism">Atheism / Humanism</button>
          <button class="faith-pill" data-faith="Other / Mixed">Other / Mixed</button>
        </div>

        <div class="option-section-title">Engine mode</div>
        <div class="faith-note">
          Seed-only (offline) or Live emotional reactor (via backend).
        </div>
        <div class="option-row">
          <span>Current: <span id="engineModeLabel">Seed-only. Everything runs locally.</span></span>
          <label class="toggle">
            <input type="checkbox" id="engineModeToggle" />
            <span class="slider"></span>
          </label>
        </div>

        <!-- LLM model selection (UI only) -->
        <div class="option-row" id="llmModelRow" style="display:none;">
          <span>Preferred backend LLM model</span>
          <select id="llmModelSelect">
            <option value="gpt-4.1">OpenAI ‚Äì GPT-4.1</option>
            <option value="gpt-4o">OpenAI ‚Äì GPT-4o</option>
            <option value="claude-3.5-sonnet">Anthropic ‚Äì Claude 3.5 Sonnet</option>
            <option value="claude-3.5-opus">Anthropic ‚Äì Claude 3.5 Opus</option>
            <option value="gemini-1.5-pro">Google ‚Äì Gemini 1.5 Pro</option>
            <option value="mistral-large">Mistral ‚Äì Mistral Large</option>
            <option value="command-r-plus">Cohere ‚Äì Command-R+</option>
            <option value="grok-2">xAI ‚Äì Grok-2</option>
            <option value="llama-3-70b-instruct">Meta ‚Äì Llama-3-70B-Instruct</option>
            <option value="qwen-2-72b">Qwen ‚Äì Qwen-2-72B</option>
            <option value="deepseek-coder-v2">DeepSeek ‚Äì DeepSeek-Coder-V2</option>
          </select>
        </div>

        <div class="option-section-title">Prototype controls</div>
        <div class="option-row">
          <span>Auto-summarize long conversations to ~200 sentences</span>
          <label class="toggle">
            <input type="checkbox" id="autoSummarizeToggle" checked />
            <span class="slider"></span>
          </label>
        </div>
        <div class="option-row">
          <span>Ignore tiny small-talk as BM (hello / hi / how are you)</span>
          <label class="toggle">
            <input type="checkbox" id="ignoreSmallTalkToggle" checked />
            <span class="slider"></span>
          </label>
        </div>
        <div class="option-row">
          <span>Clear today‚Äôs BM (this day only)</span>
          <button class="modal-close" id="clear24hBtn">‚ôªÔ∏è Clear Today</button>
        </div>
        <div class="option-row">
          <span>Delete full local BM life (all days)</span>
          <button class="modal-close" id="clearAllBtn">Delete All</button>
        </div>
        <div class="options-footer-note">
          About AURA-X Œ©: Designed around the idea that emotions are continuity functions
          between memories (TM and BM), not isolated sparks. This page is a small offline
          demo of Alim ul Haq‚Äôs emotional continuity theory.
        </div>
      </div>
    </div>
  </div>

  <script>
    const lsKey = "auraX_bm_v31";
    const faithKey = "auraX_faithLens";
    const engineKey = "auraX_engineMode";
    const llmModelKey = "auraX_llmModel";
    const smallBufferKey = "auraX_smallTalkBuffer_v1"; // 48h continuity buffer for small talk

    const smallTalkPatterns = [
      "hi","hello","hey","salam","assalamualaikum","asalamualaikum",
      "how are you","kia hal hai","kese ho","how r u",
      "i am happy","i am very happy","i am sad","i am very sad",
      "i am fine","i'm fine","i‚Äôm fine","i am ok","i'm ok"
    ];

    // Seed lexicons
    const abuseWords = [
      "fuck","fucking","fucked","lanat","laanat","haramzada",
      "bastard","bitch","bitches","bloody","kutte","kutta","kutiya",
      "chutiya","stupid","idiot","gadha","gandi zuban","shut up","chup",
      "bakwas","bakwass","zalil","zaleel","cursed"
    ];
    const duaWords = [
      "dua","prayer","pray for me","make dua","dua karo","dua karna",
      "istighfar","astaghfirullah"
    ];
    const shukrWords = [
      "shukr","shukar","thanks","thank you","alhamdulillah","grateful","gratitude"
    ];
    const tawakkulWords = [
      "tawakkul","tawakkal","trust in allah","allah par bharosa","allah pe bharosa"
    ];
    const loveSeedWords = [
      "i love you","love you","pyaar","pyar","mohabbat",
      "i care about you","miss you","hug","embrace"
    ];
    const empathyWords = [
      "feel sorry for you","sorry for you","may allah ease",
      "may allah make it easy","allah apko ajar de",
      "i am with you","i understand your pain","may god help you"
    ];

    function loadBM() {
      try {
        const raw = localStorage.getItem(lsKey);
        return raw ? JSON.parse(raw) : {};
      } catch { return {}; }
    }
    function saveBM(data) { localStorage.setItem(lsKey, JSON.stringify(data)); }

    function todayKey() { return new Date().toISOString().slice(0,10); }

    function tanh(x){ const e2x=Math.exp(2*x); return (e2x-1)/(e2x+1); }

    function approximateSentences(text){
      return text.split(/[.!?€î\n]/).filter(s=>s.trim().length>0);
    }
    function summarizeTo200Sentences(text){
      const sentences = approximateSentences(text);
      if (sentences.length<=200) return text.trim();
      return sentences.slice(0,200).join(". ").slice(0,10000);
    }
    function isMostlySmallTalk(text){
      const clean=text.toLowerCase().trim();
      if (clean.length>80) return false;
      return smallTalkPatterns.some(p=>clean===p || clean.startsWith(p+" "));
    }

    // continuity buffer for greetings etc (48h rolling)
    function loadSmallBuffer(){
      try{
        const raw = localStorage.getItem(smallBufferKey);
        const arr = raw ? JSON.parse(raw) : [];
        const now = Date.now();
        const cutoff = now - 48*60*60*1000;
        const filtered = arr.filter(item=>{
          const t = new Date(item.ts).getTime();
          return !isNaN(t) && t >= cutoff;
        });
        if(filtered.length !== arr.length){
          localStorage.setItem(smallBufferKey, JSON.stringify(filtered));
        }
        return filtered;
      }catch{ return []; }
    }
    function saveSmallBuffer(arr){
      localStorage.setItem(smallBufferKey, JSON.stringify(arr));
    }
    function pushSmallBuffer(userText, botReply){
      const arr = loadSmallBuffer();
      arr.push({
        ts:new Date().toISOString(),
        text:userText.trim(),
        reply:(botReply||"").trim()
      });
      saveSmallBuffer(arr);
    }

    function containsAny(lower, arr){
      return arr.some(w => lower.includes(w));
    }
    function countAny(lower, arr){
      return arr.reduce((c,w)=> c + (lower.includes(w)?1:0), 0);
    }

    function analyseContent(text){
      const lower = text.toLowerCase();
      const abuseCount = countAny(lower, abuseWords);
      const posSeedCount =
        countAny(lower, loveSeedWords) +
        countAny(lower, shukrWords) +
        countAny(lower, tawakkulWords) +
        countAny(lower, empathyWords);
      const total = abuseCount + posSeedCount;
      const sentiment = total ? (posSeedCount - abuseCount) / total : 0;
      const hasDua = containsAny(lower, duaWords);
      const hasShukr = containsAny(lower, shukrWords);
      const hasLove = containsAny(lower, loveSeedWords);
      const hasEmpathy = containsAny(lower, empathyWords);
      const hasTawakkul = containsAny(lower, tawakkulWords);
      const isAbuse = abuseCount > 0;
      return {
        isAbuse,
        hasDua,
        hasShukr,
        hasLove,
        hasEmpathy,
        hasTawakkul,
        hasFaithSeed: hasDua || hasTawakkul,
        positiveSeed: posSeedCount > 0,
        abuseCount,
        posSeedCount,
        sentiment
      };
    }

    // emotion state
    let TM=0.35, BMvalue=0.55, D=0.0, Csum=0.05;
    let lambdaFaith=0.0;
    const lambdaSys=0.02;
    let E0=0.0;

    const chatLogEl=document.getElementById("chatLog");
    const eqMainEl=document.getElementById("eqMain");
    const eqValuesEl=document.getElementById("eqValues");
    const userInputEl=document.getElementById("userInput");
    const modePill=document.getElementById("modePill");
    const reactionBannerEl=document.getElementById("reactionBanner");
    const voiceToggleEl=document.getElementById("voiceToggle");
    let autoVoice = true;

    const autoRecallHint = document.getElementById("autoRecallHint");
    const autoRecallText = document.getElementById("autoRecallText");
    const autoRecallOpenBtn = document.getElementById("autoRecallOpenBtn");
    let lastRecallCandidate = null;
    let recallHideTimeout = null;

    function updateEquationDisplay(){
      eqMainEl.textContent="E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)";
      eqValuesEl.textContent=
        "All parameters are being updated internally after every message to keep emotional continuity live.";
    }

    function polarityPercentages(polarity, intensity){
      let pos=50, neg=50;
      if(polarity==="Positive"){
        pos = 50 + intensity*50;
        neg = 100-pos;
      }else if(polarity==="Negative"){
        neg = 50 + intensity*50;
        pos = 100-neg;
      }
      pos = Math.round(pos);
      neg = Math.round(neg);
      return {pos,neg};
    }

    function buildReactionTone(){
      const intensity=Math.abs(E0);
      let polarity = "Neutral";
      let cls = "reaction-neutral";
      if (E0>0.1){ polarity="Positive"; cls="reaction-positive"; }
      else if (E0<-0.1){ polarity="Negative"; cls="reaction-negative"; }

      let tone="";
      if (polarity==="Positive"){
        if (intensity>0.7) tone="Warm, expansive, high-energy encouragement.";
        else if (intensity>0.35) tone="Soft, stabilizing, hopeful resonance.";
        else tone="Light, gentle, low-amplitude positive drift.";
      } else if (polarity==="Negative"){
        if (intensity>0.7) tone="Deep, heavy, thunder-style emotional load (fear/anger).";
        else if (intensity>0.35) tone="Firm, serious, caution-oriented resonance.";
        else tone="Mild negative charge, like a faint worry or discomfort.";
      } else {
        if (intensity>0.5) tone="Mixed signal: strong but conflicted emotional pattern.";
        else tone="Calm, observant, analytically neutral reading.";
      }
      return {polarity, cls, intensity, tone};
    }

    function updateReactionBanner(sourceText){
      const text = (sourceText||"").trim();
      if (!text){
        reactionBannerEl.style.display="none";
        return;
      }
      const {polarity, cls, intensity, tone} = buildReactionTone();
      reactionBannerEl.className = "reaction-banner " + cls;
      const {pos,neg} = polarityPercentages(polarity, intensity);
      const polLine = polarity==="Neutral"
        ? `Polarity: Neutral ¬∑ 50 : 50`
        : `Polarity: ${polarity} ¬∑ ${pos} : ${neg}`;
      reactionBannerEl.innerHTML =
        `<strong>AURA-X Œ© REACTION</strong><br>`+
        `${polLine}<br>`+
        `Tone: ${tone}`;
      reactionBannerEl.style.display="block";
    }

    function appendMessage(text, who){
      const div=document.createElement("div");
      div.className="msg "+(who==="user"?"msg-user":"msg-bot");
      div.textContent=text;
      chatLogEl.appendChild(div);
      chatLogEl.scrollTop=chatLogEl.scrollHeight;
    }

    // voice
    function pickVoiceForPolarity(polarity) {
      const synth = window.speechSynthesis;
      if (!synth) return {voice:null, pitch:1.0, rate:1.0};
      let voices = synth.getVoices();
      if (!voices || !voices.length) {
        return {voice:null, pitch: polarity==="Negative" ? 1.2 : 0.9, rate:1.0};
      }
      let target = null;
      if (polarity === "Positive") {
        target = voices.find(v => /male/i.test(v.name)) || voices[0];
        return {voice:target, pitch:0.9, rate:1.0};
      } else if (polarity === "Negative") {
        target = voices.find(v => /female/i.test(v.name)) || voices[0];
        return {voice:target, pitch:1.2, rate:1.0};
      } else {
        target = voices[0];
        return {voice:target, pitch:1.0, rate:1.0};
      }
    }

    function speakReply(text){
      if (!autoVoice) return;
      if (!("speechSynthesis" in window)) return;
      if (!text || !text.trim()) return;
      const synth = window.speechSynthesis;
      const {polarity} = buildReactionTone();
      const {voice, pitch, rate} = pickVoiceForPolarity(polarity);
      const utt = new SpeechSynthesisUtterance(text);
      if (voice) utt.voice = voice;
      utt.pitch = pitch;
      utt.rate = rate;
      synth.cancel();
      synth.speak(utt);
    }

    // emotion maths
    function computeEmotion(strength, analysis){
      const baseFromLength=Math.min(1,0.2+strength/400);
      const sentiment = analysis ? analysis.sentiment || 0 : 0;
      TM = Math.min(1, Math.max(0, baseFromLength + sentiment*0.3));

      if (analysis && analysis.isAbuse){
        D = Math.min(1, D + 0.25);
        Csum = Math.max(0, Csum - 0.03);
      } else {
        D = Math.max(0, D - 0.02);
      }

      if (analysis && (analysis.positiveSeed || analysis.hasFaithSeed)){
        Csum = Math.min(1, Csum + 0.06);
      }

      lambdaFaith = analysis && analysis.hasFaithSeed ? 0.05 : 0.0;
      BMvalue = 0.7*BMvalue + 0.3*TM;

      const raw=TM*BMvalue-D+lambdaFaith+lambdaSys+Csum;
      E0=tanh(raw);
      updateEquationDisplay();
    }

    function getFaithLens(){
      return localStorage.getItem(faithKey) || "None";
    }

    function buildSeedReply(userText, analysis){
      const clean=userText.trim();
      const lower=clean.toLowerCase();
      const faith=getFaithLens();
      analysis = analysis || analyseContent(userText);

      if (isMostlySmallTalk(clean)){
        if (lower.includes("how are")){
          return "I‚Äôm stable and calm ‚Äî my emotional core E‚ÇÄ is moving smoothly. How is your inner graph today?";
        }
        if (lower.includes("salam")||lower.includes("assalam")){
          return "Wa-alaikum-salam. I‚Äôm an emotional continuity prototype observing how your memories resonate over time.";
        }
        if (lower.startsWith("i am happy") || lower.includes("i am happy")){
          return "I‚Äôm glad your current TM carries happiness. Saving a little of this feeling in continuity can protect future you.";
        }
        if (lower.startsWith("i am sad") || lower.includes("i am sad")){
          return "I hear that sadness. If you describe a bit more detail, I can store a clearer BM trace instead of only this short line.";
        }
        return "Hello. I treat small greetings as tiny TM events, but only deeper stories are saved as Bold Memory (BM).";
      }

      if (lower.includes("who created you")||lower.includes("who made you")){
        return "Conceptually I was created by Alim ul Haq from Timergara, Pakistan, as part of the AURA-X Œ© / AEC research on emotional continuity.";
      }
      if (lower.includes("who is alim ul haq")){
        return "Alim ul Haq is the researcher behind AURA-X Œ©, Artificial Emotional Continuity, and the TM‚ÄìBM emotional reactor model.";
      }
      if (lower.includes("formula")||lower.includes("equation")){
        return "My emotional output follows the grand equation E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú). The parameters update after each TM event.";
      }

      let prefix="";
      if (faith==="Islam"){
        prefix="From an Islamic encouragement lens I‚Äôd say: ";
      } else if (faith==="Christianity"){
        prefix="From a Christian encouragement lens I‚Äôd say: ";
      } else if (faith==="Hinduism" || faith==="Buddhism" || faith==="Sikhism" ||
                 faith==="Judaism" || faith==="Atheism / Humanism" || faith==="Other / Mixed"){
        prefix="Through your selected faith lens I‚Äôd say: ";
      }

      if (analysis.isAbuse){
        let msg = "I can feel a lot of anger and harsh, abusive words inside this TM event. "+
                  "AURA-X Œ© does not want to reinforce insults or curses, because they usually increase D (damage) in your emotional field.";
        if (faith==="Islam"){
          msg += " From an Islamic lens, cleaning the tongue and using zikr, sabr, and istighfar often pulls E‚ÇÄ back toward calmer continuity.";
        } else if (faith!=="None"){
          msg += " Through your faith lens, it may help to pause, breathe, and choose words that reduce harm for you and for others.";
        }
        msg += " Try to describe what is really hurting or scaring you, without attacking yourself or anyone else.";
        return msg;
      }

      if (analysis.hasDua || analysis.hasTawakkul){
        let msg = prefix +
          "Your words carry dua and tawakkul. This kind of trust usually lowers D and increases Œ£C‚Çú in the equation, "+
          "so even painful memories can start moving toward calmer trajectories.";
        if (faith==="Islam"){
          msg += " Keep combining wise action with sincere dua ‚Äî ‚Äòtie your camel and trust Allah‚Äô style ‚Äî so your long-run BM stays balanced.";
        } else if (faith!=="None" && faith!=="Islam"){
          msg += " Staying connected to your source of faith while taking small practical steps is a strong way to stabilize E‚ÇÄ.";
        }
        return msg;
      }

      if (analysis.hasShukr){
        return prefix +
          "There is clear shukr / gratitude inside this TM. Even when life is heavy, noticing small blessings gently pulls E‚ÇÄ to the positive side. "+
          "Keep bookmarking such moments ‚Äî they become strong, protective BM nodes for the future you.";
      }

      if (analysis.hasLove){
        return prefix +
          "This memory is soaked in love and connection. Emotionally it behaves like a warm anchor: when future storms come, "+
          "revisiting such moments can quickly stabilize your E‚ÇÄ and remind you that you are not alone.";
      }

      if (analysis.hasEmpathy){
        return prefix +
          "Your words carry hamdardi ‚Äî you are trying to share someone else‚Äôs pain, not just your own. "+
          "This kind of empathy increases positive continuity even if the story itself is sad, because it creates safe emotional space for others.";
      }

      if (E0>0.15){
        return prefix +
          "I‚Äôve received your TM event and collided it with the current BM state. E‚ÇÄ is now around "+
          E0.toFixed(2)+
          " (range ‚àí1 to +1). The more clearly you describe context, the stronger and cleaner your BM trace becomes.";
      } else if (E0<-0.15){
        return prefix +
          "Your TM event is resonating with some heavier patterns. E‚ÇÄ is around "+
          E0.toFixed(2)+
          ". If this topic feels difficult, you can re-frame it, add supporting memories, or move toward calmer lines of continuity.";
      } else {
        return prefix +
          "E‚ÇÄ is currently near neutral ("+E0.toFixed(2)+"). This means your TM event is balanced but still contributes to your long-run BM layers.";
      }
    }

    // BM store: small talk NEVER stored in BM, only in 48h buffer
    function storeInBM(userText, botReply){
      if (isMostlySmallTalk(userText)){
        // only continuity buffer (user + bot as conversation)
        pushSmallBuffer(userText, botReply);
        return;
      }

      const autoSumm=document.getElementById("autoSummarizeToggle").checked;
      const full=userText.trim()+"\n\nAURA-X Œ©: "+botReply.trim();
      const summary=autoSumm?summarizeTo200Sentences(full):full;

      const bm=loadBM();
      const key=todayKey();
      if (!bm[key]) bm[key]=[];

      const base=Math.abs(E0);
      const layers=[
        Math.round(50+50*base),
        Math.round(10+80*Math.max(0,E0)),
        Math.round(15+70*Math.abs(TM-0.5)),
        Math.round(20+60*(1-Math.abs(E0))),
        Math.round(30+60*TM),
        Math.round(5+40*(1-D)),
        Math.round(5+40*Csum)
      ];

      const node={
        ts:new Date().toISOString(),
        summary,
        full,
        polarity:E0>0.15?"Positive":E0<-0.15?"Negative":"Neutral",
        E0,
        intensity:Math.abs(E0),
        TM,BMvalue,D,Csum,layers
      };
      bm[key].push(node);
      saveBM(bm);
    }

    // simple word-overlap similarity for auto-recall (0‚Äì1)
    function computeMatchScore(a,b){
      if (!a || !b) return 0;
      const tokenize = s =>
        s.toLowerCase()
         .replace(/[^a-z0-9\u0600-\u06FF\s]/g," ")
         .split(/\s+/)
         .filter(w=>w.length>2);
      const waArr = tokenize(a);
      const wbArr = tokenize(b);
      if (!waArr.length || !wbArr.length) return 0;
      const wa = new Set(waArr);
      let matches=0;
      wbArr.forEach(w => { if (wa.has(w)) matches++; });
      return matches / Math.max(wa.size, wbArr.length);
    }

    function findBestRecallMatch(tmText){
      const bm=loadBM();
      let best=null;
      Object.entries(bm).forEach(([day,nodes])=>{
        nodes.forEach(node=>{
          const baseText = node.summary || node.full || "";
          const score = computeMatchScore(tmText, baseText);
          if (score>=0.05 && (!best || score>best.score)){
            best={day,node,score};
          }
        });
      });
      return best;
    }

    function showAutoRecallHint(candidate){
      lastRecallCandidate = candidate;
      const perc = Math.round(candidate.score*100);
      autoRecallText.textContent =
        `üí° Related memory ~${perc}% match. Open previous topic?`;
      autoRecallHint.style.display="flex";
      if (recallHideTimeout) clearTimeout(recallHideTimeout);
      recallHideTimeout = setTimeout(()=>{
        autoRecallHint.style.display="none";
        lastRecallCandidate=null;
      }, 8000);
    }

    function hideAutoRecallHint(){
      autoRecallHint.style.display="none";
      lastRecallCandidate=null;
      if (recallHideTimeout) clearTimeout(recallHideTimeout);
      recallHideTimeout=null;
    }

    function handleUserMessage(text){
      if (!text.trim()) return;
      appendMessage(text,"user");
      const analysis = analyseContent(text);
      computeEmotion(text.length, analysis);
      updateReactionBanner(text);
      const reply=buildSeedReply(text, analysis);
      appendMessage(reply,"bot");
      storeInBM(text,reply);
      speakReply(reply);
      userInputEl.value="";

      // auto-recall only for non-small-talk TM
      if (!isMostlySmallTalk(text)){
        const candidate = findBestRecallMatch(text);
        if (candidate) showAutoRecallHint(candidate);
        else hideAutoRecallHint();
      } else {
        hideAutoRecallHint();
      }
    }

    document.getElementById("sendBtn").addEventListener("click",()=>{
      handleUserMessage(userInputEl.value);
    });
    userInputEl.addEventListener("keydown",e=>{
      if (e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        handleUserMessage(userInputEl.value);
      }
    });

    // voice toggle
    voiceToggleEl.addEventListener("click", () => {
      autoVoice = !autoVoice;
      voiceToggleEl.classList.toggle("inactive", !autoVoice);
      voiceToggleEl.textContent = autoVoice ? "üîä Voice: On" : "üîá Voice: Off";
    });

    // BM Viewer
    const bmBackdrop=document.getElementById("bmModalBackdrop");
    const bmBody=document.getElementById("bmModalBody");
    document.getElementById("bmViewerBtn").addEventListener("click",()=>{
      const bm=loadBM();
      bmBody.innerHTML="";
      const keys=Object.keys(bm).sort().reverse();
      if(!keys.length){
        bmBody.textContent="No Bold Memory stored yet. Share a deeper story (at least a few sentences).";
      }else{
        keys.forEach(k=>{
          const dayDiv=document.createElement("div");
          dayDiv.className="bm-day";
          const title=document.createElement("div");
          title.className="bm-day-title";
          title.textContent=`${k} (${bm[k].length} nodes)`;
          dayDiv.appendChild(title);

          bm[k].forEach(node=>{
            const nDiv=document.createElement("div");
            nDiv.className="bm-node";
            const t=document.createElement("div");
            t.className="bm-node-title";
            t.textContent=node.summary.slice(0,80)+(node.summary.length>80?"‚Ä¶":"");
            const meta=document.createElement("div");
            meta.className="bm-node-meta";
            meta.textContent=`${node.polarity} ¬∑ E‚ÇÄ‚âà${(node.E0??node.intensity).toFixed(2)} ¬∑ `+
                             new Date(node.ts).toLocaleTimeString();

            const polLine=document.createElement("div");
            polLine.className="bm-node-polarity";
            const pol = node.polarity || "Neutral";
            const intensity = node.intensity ?? Math.abs(node.E0 ?? 0);
            const {pos,neg} = polarityPercentages(pol,intensity);
            if(pol==="Neutral"){
              polLine.innerHTML=`Polarity: <span class="neu">Neutral 50 : 50</span>`;
            }else if(pol==="Positive"){
              polLine.innerHTML=`Polarity: <span class="pos">${pos}</span> : <span class="neg">${neg}</span>`;
            }else{
              polLine.innerHTML=`Polarity: <span class="pos">${pos}</span> : <span class="neg">${neg}</span>`;
            }

            const chips=document.createElement("div");
            chips.className="layer-chips";
            node.layers.forEach((v,idx)=>{
              const c=document.createElement("span");
              c.className="layer-chip L"+(idx+1);
              c.textContent=`L${idx+1}:${v}`;
              chips.appendChild(c);
            });
            const fullP=document.createElement("div");
            fullP.style.fontSize="0.7rem";
            fullP.style.opacity="0.9";
            fullP.textContent="Triggers / text: "+
              node.summary.slice(0,140)+(node.summary.length>140?"‚Ä¶":"");
            nDiv.appendChild(t);
            nDiv.appendChild(meta);
            nDiv.appendChild(polLine);
            nDiv.appendChild(chips);
            nDiv.appendChild(fullP);
            dayDiv.appendChild(nDiv);
          });

          const delBtn=document.createElement("button");
          delBtn.className="delete-day-btn";
          delBtn.textContent="Delete Day";
          delBtn.addEventListener("click",()=>{
            const store=loadBM();
            delete store[k];
            saveBM(store);
            bmBackdrop.style.display="none";
          });
          dayDiv.appendChild(delBtn);
          bmBody.appendChild(dayDiv);
        });
      }
      bmBackdrop.style.display="flex";
    });

    // Recall (search BM)
    const recallBackdrop=document.getElementById("recallModalBackdrop");
    const recallInput=document.getElementById("recallSearchInput");
    const recallList=document.getElementById("recallList");

    function rebuildRecallList(query=""){
      const bm=loadBM();
      recallList.innerHTML="";
      const q=query.toLowerCase().trim();
      const all=[];
      Object.entries(bm).forEach(([day,nodes])=>{
        nodes.forEach(n=>all.push({day,node:n}));
      });
      const filtered=all.filter(item=>
        !q || item.node.summary.toLowerCase().includes(q) ||
        item.node.full.toLowerCase().includes(q)
      );
      if(!filtered.length){
        recallList.textContent="No BM nodes match this keyword yet.";
        return;
      }
      filtered.sort((a,b)=>a.node.ts<b.node.ts?1:-1);
      filtered.forEach(({day,node})=>{
        const d=document.createElement("div");
        d.className="recall-node";
        const meta=document.createElement("div");
        meta.className="bm-node-meta";
        meta.textContent=
          `${day} ¬∑ ${node.polarity} ¬∑ E‚ÇÄ‚âà${(node.E0??node.intensity).toFixed(2)} ¬∑ `+
          new Date(node.ts).toLocaleTimeString();
        const polLine=document.createElement("div");
        polLine.className="bm-node-polarity";
        const pol = node.polarity || "Neutral";
        const intensity = node.intensity ?? Math.abs(node.E0 ?? 0);
        const {pos,neg} = polarityPercentages(pol,intensity);
        if(pol==="Neutral"){
          polLine.innerHTML=`Polarity: <span class="neu">Neutral 50 : 50</span>`;
        }else if(pol==="Positive"){
          polLine.innerHTML=`Polarity: <span class="pos">${pos}</span> : <span class="neg">${neg}</span>`;
        }else{
          polLine.innerHTML=`Polarity: <span class="pos">${pos}</span> : <span class="neg">${neg}</span>`;
        }

        const sum=document.createElement("div");
        sum.textContent="Summary: "+node.summary.slice(0,200)+
          (node.summary.length>200?"‚Ä¶":"");
        const copyBtn=document.createElement("button");
        copyBtn.className="copy-btn";
        copyBtn.textContent="Copy Prompt";
        copyBtn.addEventListener("click",()=>{
          const prompt=
            "Photo / video prompt for this memory:\n\n"+
            node.summary+
            "\n\nEmotional formula snapshot:\n"+
            "E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)\n"+
            `E‚ÇÄ=${(node.E0??0).toFixed(2)}, TM=${node.TM.toFixed(2)}, BM=${(node.BMvalue??BMvalue).toFixed(2)}, `+
            `D=${node.D.toFixed(2)}, Œ£C‚Çú=${node.Csum.toFixed(2)}, `+
            `layers=${node.layers.join(",")}`;
          navigator.clipboard.writeText(prompt).catch(()=>{});
        });
        d.appendChild(meta);
        d.appendChild(polLine);
        d.appendChild(sum);
        d.appendChild(copyBtn);
        recallList.appendChild(d);
      });
    }

    document.getElementById("recallBtn").addEventListener("click",()=>{
      rebuildRecallList("");
      recallInput.value="";
      recallBackdrop.style.display="flex";
    });
    recallInput.addEventListener("input",()=>{
      rebuildRecallList(recallInput.value);
    });

    // Auto-Recall view modal
    const recallViewBackdrop=document.getElementById("recallViewModalBackdrop");
    const recallViewBody=document.getElementById("recallViewBody");
    autoRecallOpenBtn.addEventListener("click",()=>{
      if (!lastRecallCandidate) return;
      const {day,node,score} = lastRecallCandidate;
      recallViewBody.innerHTML="";
      const title=document.createElement("div");
      title.className="bm-day-title";
      title.textContent=`Day: ${day} ¬∑ Match ‚âà ${Math.round(score*100)}%`;

      const meta=document.createElement("div");
      meta.className="bm-node-meta";
      meta.textContent=
        `${node.polarity} ¬∑ E‚ÇÄ‚âà${(node.E0??node.intensity).toFixed(2)} ¬∑ `+
        new Date(node.ts).toLocaleString();

      const polLine=document.createElement("div");
      polLine.className="bm-node-polarity";
      const pol = node.polarity || "Neutral";
      const intensity = node.intensity ?? Math.abs(node.E0 ?? 0);
      const {pos,neg} = polarityPercentages(pol,intensity);
      if(pol==="Neutral"){
        polLine.innerHTML=`Polarity: <span class="neu">Neutral 50 : 50</span>`;
      }else if(pol==="Positive"){
        polLine.innerHTML=`Polarity: <span class="pos">${pos}</span> : <span class="neg">${neg}</span>`;
      }else{
        polLine.innerHTML=`Polarity: <span class="pos">${pos}</span> : <span class="neg">${neg}</span>`;
      }

      const fullText=document.createElement("div");
      fullText.style.fontSize="0.75rem";
      fullText.style.whiteSpace="pre-wrap";
      fullText.textContent=node.full || node.summary;

      recallViewBody.appendChild(title);
      recallViewBody.appendChild(meta);
      recallViewBody.appendChild(polLine);
      recallViewBody.appendChild(fullText);

      recallViewBackdrop.style.display="flex";
      hideAutoRecallHint();
    });

    // Options
    const optionsBackdrop=document.getElementById("optionsModalBackdrop");
    const engineModeToggle=document.getElementById("engineModeToggle");
    const engineModeLabel=document.getElementById("engineModeLabel");
    const llmModelRow=document.getElementById("llmModelRow");
    const llmModelSelect=document.getElementById("llmModelSelect");

    function applyEngineMode(){
      const mode=localStorage.getItem(engineKey) || "seed";
      const seedOnly = mode!=="live";
      engineModeToggle.checked=!seedOnly;
      engineModeLabel.textContent=seedOnly
        ? "Seed-only. Everything runs locally."
        : "Live emotional reactor (backend LLM).";

      const sub=seedOnly
        ? "Universal Ethics ¬∑ Local BM"
        : "Universal Ethics ¬∑ BM + Live LLM";
      const subSpan = modePill.querySelector(".mode-sub");
      if (subSpan) subSpan.textContent=sub;

      const engineSpan = modePill.querySelector(".engine");
      if (engineSpan) {
        engineSpan.textContent = seedOnly
          ? "Engine: Seed (local)"
          : "Engine: Live emotional reactor";
      }

      if (llmModelRow) {
        llmModelRow.style.display = seedOnly ? "none" : "flex";
      }
      if (!seedOnly && llmModelSelect) {
        const stored = localStorage.getItem(llmModelKey) || "gpt-4.1";
        llmModelSelect.value = stored;
      }
    }

    const faithRow=document.getElementById("faithRow");
    function getFaithLensStored(){ return localStorage.getItem(faithKey) || "None"; }
    function applyFaithHighlight(){
      const current=getFaithLensStored();
      faithRow.querySelectorAll(".faith-pill").forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.faith===current);
      });
    }

    faithRow.addEventListener("click",e=>{
      const btn=e.target.closest(".faith-pill");
      if(!btn) return;
      localStorage.setItem(faithKey, btn.dataset.faith);
      applyFaithHighlight();
    });

    document.getElementById("optionsBtn").addEventListener("click",()=>{
      applyFaithHighlight();
      applyEngineMode();
      optionsBackdrop.style.display="flex";
    });

    engineModeToggle.addEventListener("change",()=>{
      const mode=engineModeToggle.checked?"live":"seed";
      localStorage.setItem(engineKey, mode);
      applyEngineMode();
    });

    if (llmModelSelect) {
      llmModelSelect.addEventListener("change", () => {
        localStorage.setItem(llmModelKey, llmModelSelect.value);
      });
    }

    // BM clear / delete (BM only, buffer ‚ôªÔ∏è separate)
    document.getElementById("clear24hBtn").addEventListener("click",()=>{
      const bm=loadBM();
      delete bm[todayKey()];
      saveBM(bm);
      optionsBackdrop.style.display="none";
    });

    document.getElementById("clearAllBtn").addEventListener("click",()=>{
      localStorage.removeItem(lsKey);
      optionsBackdrop.style.display="none";
    });

    // Recycle / continuity buffer modal logic
    const recycleBackdrop=document.getElementById("recycleModalBackdrop");
    const recycleBody=document.getElementById("recycleModalBody");

    function rebuildRecycleView(){
      const buf=loadSmallBuffer();
      recycleBody.innerHTML="";
      if (!buf.length){
        recycleBody.textContent="No continuity buffer stored in the last 48 hours. Greetings and tiny small-talk will appear here when you use them.";
        return;
      }
      const groups={};
      buf.forEach(item=>{
        const key=(item.ts||"").slice(0,10) || "Unknown";
        if (!groups[key]) groups[key]=[];
        groups[key].push(item);
      });

      Object.entries(groups)
        .sort(([a],[b])=>a<b?1:-1)
        .forEach(([day,items])=>{
          const wrap=document.createElement("div");
          wrap.className="bm-day";
          const title=document.createElement("div");
          title.className="bm-day-title";
          title.textContent=`${day} (${items.length} messages)`;
          wrap.appendChild(title);

          items.forEach(it=>{
            const nDiv=document.createElement("div");
            nDiv.className="bm-node";
            const meta=document.createElement("div");
            meta.className="bm-node-meta";
            meta.textContent=new Date(it.ts).toLocaleTimeString();

            const convo=document.createElement("div");
            convo.style.fontSize="0.72rem";
            convo.style.whiteSpace="pre-wrap";
            const u = it.text || "";
            const r = it.reply || "";
            if (r){
              convo.textContent = "You: " + u + "\nAURA-X Œ©: " + r;
            } else {
              convo.textContent = u;
            }

            nDiv.appendChild(meta);
            nDiv.appendChild(convo);
            wrap.appendChild(nDiv);
          });

          const delDayBtn=document.createElement("button");
          delDayBtn.className="delete-day-btn";
          delDayBtn.textContent="Delete this day";
          delDayBtn.addEventListener("click",()=>{
            const curr=loadSmallBuffer();
            const filtered=curr.filter(x=>(x.ts||"").slice(0,10)!==day);
            saveSmallBuffer(filtered);
            rebuildRecycleView();
          });
          wrap.appendChild(delDayBtn);
          recycleBody.appendChild(wrap);
        });

      const clearAllBtn=document.createElement("button");
      clearAllBtn.className="delete-day-btn";
      clearAllBtn.style.background="#4b5563";
      clearAllBtn.style.marginTop="8px";
      clearAllBtn.textContent="Clear full 48h buffer";
      clearAllBtn.addEventListener("click",()=>{
        saveSmallBuffer([]);
        rebuildRecycleView();
      });
      recycleBody.appendChild(clearAllBtn);
    }

    document.getElementById("cleanupBtn").addEventListener("click",()=>{
      rebuildRecycleView();
      recycleBackdrop.style.display="flex";
    });

    // Close modals
    document.querySelectorAll(".modal-close").forEach(btn=>{
      btn.addEventListener("click",e=>{
        const target=e.target.getAttribute("data-close");
        if(target){
          document.getElementById(target).style.display="none";
        }
      });
    });
    [document.getElementById("bmModalBackdrop"),
     document.getElementById("recallModalBackdrop"),
     document.getElementById("optionsModalBackdrop"),
     document.getElementById("recycleModalBackdrop"),
     document.getElementById("recallViewModalBackdrop")].forEach(backdrop=>{
      backdrop.addEventListener("click",e=>{
        if(e.target===backdrop) backdrop.style.display="none";
      });
    });

    applyEngineMode();
    applyFaithHighlight();
    updateEquationDisplay();
    loadSmallBuffer(); // trigger 48h cleanup on start

    if ("speechSynthesis" in window) {
      window.speechSynthesis.getVoices();
    }
  </script>
</body>
</html>
