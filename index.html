<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:20px;
    }
    .app{
      width:100%;
      max-width:1100px;
      background:radial-gradient(circle at top,#020617 0,#020617 35%,#020617 100%);
      border-radius:26px;
      box-shadow:0 26px 80px rgba(15,23,42,.85),0 0 0 1px rgba(148,163,184,.45);
      padding:18px 20px 12px;
      display:flex;
      flex-direction:column;
      gap:14px;
      position: relative;
      overflow:visible;
    }
    .app::before{
      content:"";position:absolute;inset:-40px;
      background:
        radial-gradient(circle at 15% -10%,rgba(56,189,248,.28),transparent 60%),
        radial-gradient(circle at 85% -20%,rgba(59,130,246,.26),transparent 55%);
      opacity:.7;pointer-events:none;z-index:0;
    }
    .app>*{position:relative;z-index:1}

    /* HEADER */
    .header{
      position: relative;
      border-radius: 24px;
      padding: 16px 18px 14px;
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items: center;
      background:
        radial-gradient(900px 320px at 20% 0%, rgba(56,189,248,.32), rgba(15,23,42,.98) 55%, #020617 100%);
      border: 1.5px solid rgba(148,163,184,.55);
      box-shadow:0 26px 70px rgba(15,23,42,.9),inset 0 1px 0 rgba(255,255,255,.08);
      z-index:5;
    }
    .header::before{
      content:"";position:absolute;inset:-40px;
      background:
        radial-gradient(circle at 20% 30%, rgba(56,189,248,.22), transparent 45%),
        radial-gradient(circle at 80% 25%, rgba(34,211,238,.18), transparent 40%),
        linear-gradient(90deg, rgba(56,189,248,.20), transparent 35%, rgba(34,211,238,.18));
      opacity:.9;pointer-events:none;z-index:0;
    }
    .header::after{
      content:"";position:absolute;inset:0;
      background:repeating-linear-gradient(90deg,rgba(56,189,248,.18)0 2px,transparent 2px 26px);
      opacity:.06;pointer-events:none;z-index:0;
    }
    .title-block{position:relative;z-index:1;}
    .title-block h1{
      font-size:1.7rem;letter-spacing:.10em;text-transform:uppercase;
      font-weight:800;line-height:1.05;
    }
    .title-block h1 span{
      background: linear-gradient(120deg,#38bdf8,#22d3ee,#a5b4fc);
      -webkit-background-clip: text;background-clip: text;color: transparent;
    }
    .hero-line{margin-top:6px;font-size:.9rem;color:rgba(226,232,240,.96);font-weight:600;}
    .title-sub{margin-top:4px;font-size:.8rem;color:rgba(148,163,184,.98);line-height:1.35;}
    .ethics-pill{
      margin-top:12px;border-radius:14px;padding:10px 12px;
      background: rgba(2,6,23,.70);
      border: 1.5px solid rgba(250,204,21,.8);
      box-shadow:0 18px 40px rgba(15,23,42,.85),0 0 0 1px rgba(251,191,36,.35);
      max-width:440px;
    }
    .ethics-pill-text{
      color: rgba(250,250,210,.98);font-weight:600;font-size:.8rem;line-height:1.5;
    }
    .header-right{position:relative;z-index:1;display:flex;flex-direction:column;align-items:flex-end;gap:10px;}
    .mode-pill{
      width:min(320px,100%);padding:14px 16px;border-radius:999px;
      border:1px solid rgba(34,211,238,.6);
      background:
        radial-gradient(700px 210px at 20% 20%, rgba(34,211,238,.45), rgba(34,211,238,.18) 45%, rgba(2,6,23,.10) 100%),
        linear-gradient(135deg, rgba(34,211,238,.45), rgba(6,182,212,.24));
      color:rgba(240,253,250,.98);font-size:.88rem;font-weight:800;letter-spacing:.11em;text-transform:uppercase;text-align:center;
      box-shadow:0 18px 50px rgba(34,211,238,.35);position:relative;overflow:hidden;
    }
    .mode-pill::before{
      content:"";position:absolute;inset:0;
      background:
        radial-gradient(circle at 35% 65%, rgba(255,255,255,.22), transparent 55%),
        radial-gradient(circle at 70% 35%, rgba(255,255,255,.16), transparent 60%);
      opacity:.9;
    }
    .mode-pill::after{
      content:"";position:absolute;left:-10%;right:-10%;bottom:-30%;
      height:70%;background: rgba(255,255,255,.18);
      border-radius:999px;transform: rotate(-6deg);filter: blur(1px);opacity:.40;
    }
    .header-controls{display:flex;flex-wrap:wrap;justify-content:flex-end;position:relative;margin-top:4px;z-index:20;}
    .voice-toggle{
      border:none;padding:6px 12px;border-radius:999px;font-size:.85rem;
      background:rgba(248,250,252,.96);color:#0f172a;border:1px solid rgba(226,232,240,.9);
      cursor:pointer;display:flex;align-items:center;gap:8px;
      box-shadow:0 10px 26px rgba(2,6,23,.6);position:relative;z-index:21;
    }
    .voice-toggle:hover{filter:brightness(1.03);}
    .option-panel{
      position:absolute;top:115%;right:0;display:none;flex-direction:column;gap:6px;
      padding:8px;border-radius:16px;
      background:rgba(15,23,42,.98);border:1px solid rgba(148,163,184,.8);
      box-shadow:0 20px 46px rgba(15,23,42,.9);z-index:40;min-width:220px;
    }
    .header-controls.open .option-panel{display:flex;}
    .small-toggle{
      border:none;padding:6px 10px;border-radius:999px;font-size:.78rem;
      background:#020617;color:#e5e7eb;border:1px solid rgba(148,163,184,.9);
      cursor:pointer;display:flex;align-items:center;gap:6px;
    }
    .small-toggle:hover{background:#020617dd;}
    @media(max-width:900px){
      .header{grid-template-columns:1fr;padding:12px 12px 14px;}
      .header-right{align-items:stretch;}
      .mode-pill{width:100%}
      .header-controls{justify-content:flex-start;}
    }

    /* MAIN LAYOUT */
    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
      gap:18px;
      margin-top:4px;
      margin-bottom:20px;
      position:relative;z-index:1;
    }
    .left-col,.right-col{display:flex;flex-direction:column;gap:12px;}
    .card{
      background:#f9fafb;border-radius:18px;padding:16px 16px 14px;
      border:1px solid #e5e7eb;box-shadow:0 10px 25px rgba(15,23,42,.45);
    }
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
    .card-title{font-size:.95rem;font-weight:600;color:#0f172a;display:flex;align-items:center;gap:6px;}
    .card-title .emoji{font-size:1.1rem;}
    .card-sub{font-size:.75rem;color:#94a3b8;}

    .metrics-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:4px;}
    .metric{background:#ffffff;border-radius:12px;padding:10px 10px 9px;border:1px solid #e5e7eb;}
    .metric-label{font-size:.7rem;color:#64748b;margin-bottom:4px;}
    .metric-value{font-size:1.1rem;font-weight:700;color:#1d4ed8;}
    .metric-note{font-size:.7rem;color:#9ca3af;margin-top:2px;}

    .status-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;font-size:.72rem;color:#6b7280;}
    .tag{padding:4px 8px;border-radius:999px;background:#e5f4ff;color:#1e3a8a;border:1px solid #bfdbfe;font-size:.68rem;}

    .bm-wrapper{margin-top:8px;}
    .bm-canvas-shell{
      background:radial-gradient(circle at top,#e0f2fe 0,#eff6ff 60%,#e2e8f0 100%);
      border-radius:12px;border:1px solid #dbeafe;
      height:150px;overflow:hidden;position:relative;cursor:default;
    }
    #bmCanvas{width:100%;height:100%;display:block;}
    .bm-footer{font-size:.72rem;color:#6b7280;margin-top:6px;text-align:center;}
    .bm-overlay-btn{
      position:absolute;top:6px;width:26px;height:26px;border-radius:999px;border:none;
      font-size:.9rem;display:flex;align-items:center;justify-content:center;
      cursor:pointer;background:#f9fafbcc;box-shadow:0 6px 14px rgba(15,23,42,.25);
    }
    .bm-overlay-btn.left{left:8px;}
    .bm-overlay-btn.right{right:8px;}
    .bm-overlay-btn:hover{background:#e5f0ff;}

    .answer-card .card-header{margin-bottom:6px;}
    .answer-box{
      background:#020617;border-radius:12px;padding:10px 10px 12px;
      border:1px solid #020617;font-family:"Courier New",monospace;color:#e5e7eb;
      box-shadow:0 16px 40px rgba(15,23,42,.65);max-height:210px;display:flex;flex-direction:column;gap:6px;
    }
    .equation-header{font-size:.75rem;color:#60a5fa;font-weight:600;letter-spacing:.05em;text-transform:uppercase;}
    .equation-divider{height:1px;background:linear-gradient(90deg,rgba(148,163,184,.2),rgba(15,23,42,0),rgba(148,163,184,.2));margin:2px 0 4px;}
    .chat-container{background:transparent;border:none;padding:0;height:auto;max-height:170px;overflow-y:auto;}
    .message{
      max-width:100%;padding:6px 7px;margin-bottom:6px;border-radius:8px;
      font-size:.8rem;line-height:1.5;position:relative;animation:fadeIn .2s ease-out;white-space:pre-wrap;
    }
    .message-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;font-size:.7rem;color:#9ca3af;gap:6px;}
    .msg-right{display:flex;align-items:center;gap:4px;}
    .voice-btn{border:none;border-radius:999px;padding:1px 6px;font-size:.7rem;cursor:pointer;background:#1f2937;color:#e5e7eb;}
    .voice-btn:hover{background:#111827;}
    .ai-message{background:#020617;border-bottom-left-radius:3px;border:1px solid #111827;}
    .user-message{background:#020617;border-bottom-right-radius:3px;border:1px solid #1f2937;}
    .message-content{color:#e5e7eb;}

    .typing-indicator{
      display:flex;align-items:center;gap:4px;background:#020617;
      border-radius:999px;padding:4px 8px;width:fit-content;margin:6px 0 2px;border:1px solid #111827;
    }
    .typing-dot{width:5px;height:5px;border-radius:999px;background:#38bdf8;animation:typing 1.2s infinite;}
    .typing-dot:nth-child(2){animation-delay:.18s}
    .typing-dot:nth-child(3){animation-delay:.36s}
    .typing-text{font-size:.7rem;color:#38bdf8;font-weight:500;}

    /* INPUT BAR */
    .input-footer{
      margin-top:4px;padding:10px 10px 12px;position:sticky;bottom:0;
      background:linear-gradient(to bottom,rgba(2,6,23,0),rgba(2,6,23,0.95));z-index:10;
    }
    .tm-formula-row{display:flex;justify-content:center;margin-bottom:6px;}
    .tm-formula-pill{
      font-size:.7rem;padding:4px 12px;border-radius:999px;
      background:#020617;color:#e2e8f0;font-family:"Courier New",monospace;
      border:1px solid #1f2937;box-shadow:0 10px 25px rgba(15,23,42,.8);
    }
    .input-row{width:100%;display:flex;justify-content:center;padding:0 6px;}
    .input-shell{
      display:flex;align-items:center;width:100%;max-width:720px;
      background:radial-gradient(circle at 0 0,#1f2937 0,#020617 65%);
      border:1px solid rgba(148,163,184,.85);border-radius:999px;
      padding:6px 8px 6px 12px;box-shadow:0 18px 45px rgba(15,23,42,.9);
      transition:all .2s ease;cursor:text;
    }
    .input-shell:focus-within{border-color:#38bdf8;box-shadow:0 20px 50px rgba(56,189,248,.4);transform:translateY(-2px);}
    .message-input{
      flex:1;resize:none;min-height:26px;max-height:120px;padding:6px 6px 6px 0;
      border:none;outline:none;font-size:.95rem;background:transparent;color:#f9fafb;
      font-family:inherit;line-height:1.4;text-align:left;
    }
    .message-input::placeholder{color:#94a3b8;}
    .send-button{
      border:none;height:38px;padding:0 18px;background:linear-gradient(135deg,#2563eb,#06b6d4);
      color:white;font-weight:600;font-size:.85rem;cursor:pointer;border-radius:19px;flex-shrink:0;margin-left:6px;
      box-shadow:0 4px 12px rgba(37,99,235,.4);transition:filter .2s,transform .1s;display:flex;align-items:center;justify-content:center;
    }
    .send-button:hover{filter:brightness(1.1);}
    .send-button:active{transform:scale(.96);}
    .flow-caption{margin-top:6px;text-align:center;font-size:.7rem;color:#9ca3af;}

    /* REACTION / RECALL BUBBLES */
    .reaction-bubble{
      position:fixed;right:22px;bottom:100px;max-width:260px;
      background:#0f172acc;color:#e5e7eb;padding:10px 12px;border-radius:16px 16px 2px 16px;
      font-size:.78rem;box-shadow:0 18px 45px rgba(15,23,42,.6);
      display:flex;gap:8px;align-items:flex-start;opacity:0;transform:translateY(8px);
      pointer-events:none;transition:opacity .25s ease-out,transform .25s ease-out;z-index:40;
    }
    .reaction-bubble.visible{opacity:1;transform:translateY(0);pointer-events:auto;}
    .reaction-icon{font-size:1.1rem;margin-top:2px;}
    .reaction-label{font-weight:600;margin-bottom:2px;}
    .reaction-body{font-size:.76rem;color:#cbd5f5;}

    .recall-bubble-container{position:fixed;left:22px;bottom:100px;z-index:35;display:flex;flex-direction:column;gap:8px;}
    .recall-bubble{
      max-width:280px;background:#f9fafb;border-radius:16px 16px 16px 2px;
      border:1px solid #e5e7eb;padding:9px 11px;font-size:.78rem;
      box-shadow:0 18px 40px rgba(148,163,184,.45);cursor:default;
      opacity:0;transform:translateY(8px);transition:opacity .3s ease-out,transform .3s ease-out,background .2s;
    }
    .recall-bubble.visible{opacity:1;transform:translateY(0);}
    .recall-title{font-weight:600;font-size:.76rem;color:#1e293b;margin-bottom:2px;}
    .recall-body{color:#4b5563;margin-bottom:3px;}
    .recall-meta{font-size:.68rem;color:#9ca3af;}

    /* MODALS (BM, Conv, Faith, Intel, Seed, LLM) */
    .modal-overlay{
      position:fixed;inset:0;background:rgba(15,23,42,.55);
      display:none;align-items:center;justify-content:center;z-index:60;
      backdrop-filter:blur(6px);
    }
    .modal-overlay.visible{display:flex;}
    .modal-card{
      background:#f9fafb;border-radius:18px;width:min(640px,96vw);max-height:80vh;
      box-shadow:0 24px 60px rgba(15,23,42,.6);border:1px solid #e5e7eb;display:flex;flex-direction:column;
    }
    .modal-header{
      padding:10px 14px 8px;border-bottom:1px solid #e5e7eb;
      display:flex;justify-content:space-between;align-items:center;gap:8px;
    }
    .modal-title{font-size:.9rem;font-weight:600;display:flex;align-items:center;gap:6px;color:#0f172a;}
    .modal-sub{font-size:.7rem;color:#94a3b8;margin-top:2px;}
    .modal-close{border:none;background:transparent;font-size:.9rem;cursor:pointer;color:#6b7280;padding:4px 6px;}
    .modal-body{padding:10px 14px 12px;overflow-y:auto;font-size:.8rem;}
    .modal-search{
      width:100%;padding:7px 9px;border-radius:10px;border:1px solid #cbd5f5;
      font-size:.78rem;margin:8px 0 10px;outline:none;background:#ffffff;
    }
    .modal-search:focus{border-color:#2563eb;box-shadow:0 0 0 1px rgba(37,99,235,.25);}

    .bm-item{background:#ffffff;border-radius:12px;padding:7px 8px 8px;border:1px solid #e5e7eb;margin-bottom:8px;}
    .bm-item-header{display:flex;justify-content:space-between;font-size:.7rem;color:#64748b;margin-bottom:4px;gap:6px;}
    .bm-item-text{color:#111827;margin-bottom:6px;font-size:.78rem;}
    .bm-item-badges{font-size:.68rem;color:#4b5563;margin-bottom:5px;}
    .bm-item-buttons{display:flex;flex-wrap:wrap;gap:6px;}

    .btn-mini{
      font-size:.7rem;padding:4px 8px;border-radius:999px;
      border:1px solid #dbeafe;background:#eff6ff;cursor:pointer;color:#1d4ed8;
    }
    .btn-mini:hover{background:#e0edff;}
    .btn-danger{border-color:#fecaca!important;background:#fee2e2!important;color:#b91c1c!important;}
    .btn-danger:hover{background:#fecaca!important;}

    .lock-pill{border:none;padding:2px 6px;border-radius:999px;font-size:.75rem;cursor:pointer;background:#e5e7eb;margin-right:4px;}
    .lock-pill.locked{background:#fee2e2;}

    .conv-item{background:#ffffff;border-radius:12px;border:1px solid #e5e7eb;padding:7px 8px;margin-bottom:7px;font-size:.78rem;}
    .conv-header{display:flex;justify-content:space-between;color:#64748b;font-size:.7rem;margin-bottom:3px;gap:8px;}
    .conv-text{color:#111827;}
    .conv-controls{display:flex;justify-content:flex-end;gap:6px;margin-bottom:8px;flex-wrap:wrap;}
    .conv-btn{font-size:.7rem;padding:4px 7px;border-radius:999px;border:1px solid #e5e7eb;background:#f3f4f6;cursor:pointer;color:#374151;}
    .conv-btn:hover{background:#e5e7eb;}

    .faith-card{background:#fefce8;}
    .faith-note{font-size:.78rem;color:#4b5563;margin-bottom:6px;}
    .faith-chip-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;}
    .faith-chip{border-radius:999px;padding:6px 10px;font-size:.78rem;border:1px solid #e5e7eb;background:#fefce8;cursor:pointer;}
    .faith-chip.active{background:#0f172a;color:#f9fafb;border-color:#0f172a;}

    .intel-item{background:#ffffff;border-radius:12px;border:1px solid #e5e7eb;padding:7px 8px 8px;margin-bottom:8px;font-size:.78rem;}
    .intel-header{display:flex;justify-content:space-between;font-size:.7rem;color:#64748b;margin-bottom:4px;gap:6px;}
    .intel-q{font-weight:600;color:#0f172a;margin-bottom:3px;}
    .intel-a{color:#111827;margin-bottom:6px;}
    .intel-buttons{display:flex;flex-wrap:wrap;gap:6px;}

    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    @keyframes typing{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-4px);opacity:1}}

    @media(max-width:900px){
      .layout{grid-template-columns:1fr;}
      .card{padding:14px 12px 14px;}
      .answer-box{max-height:210px;}
      .input-shell{max-width:100%;}
    }
  </style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <header class="header">
    <div class="title-block">
      <h1><span>AURA-X Œ©</span></h1>
      <div class="hero-line">World‚Äôs first synthetic emotions engine (prototype)</div>
      <div class="title-sub">
        TM = user inputs only ¬∑ TM ‚üÇ (BM + Intelligence + LLM) ‚Üí E‚ÇÄ emotional state
      </div>
      <div class="ethics-pill">
        <span class="ethics-pill-text">
          Universal ethic: Avoid actions that grow negative emotions in you or others. Choose paths that gently increase shared positive emotion for everyone.
        </span>
      </div>
    </div>
    <div class="header-right">
      <div class="mode-pill">EMOTIONAL CONTINUITY ENGINE ACTIVE</div>
      <div class="header-controls" id="headerControls">
        <button id="optionsToggle" class="voice-toggle">üîò Options</button>
        <div class="option-panel" id="optionPanel">
          <button id="voiceToggle" class="small-toggle">üîà Voice: OFF</button>
          <button id="intelButton" class="small-toggle">üß† Intelligence</button>
          <button id="feedSeedButton" class="small-toggle">üå± Feed the seed</button>
          <button id="learningToggle" class="small-toggle">üìö Learning: ON</button>
          <button id="faithButton" class="small-toggle">üîò Faith: None</button>
          <button id="llmSettingsButton" class="small-toggle">ü§ñ LLM link</button>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="layout">
    <div class="left-col">
      <!-- METRICS -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß™</span><span>Emotional Metrics</span></div>
            <div class="card-sub">Synthetic E‚ÇÄ from TM (user inputs) colliding with BM + Intelligence + (optional) LLM.</div>
          </div>
        </div>
        <div class="metrics-grid">
          <div class="metric">
            <div class="metric-label">Emotional state E‚ÇÄ</div>
            <div id="metricE0" class="metric-value">0.00</div>
            <div class="metric-note">tanh-based, range [-1, +1]</div>
          </div>
          <div class="metric">
            <div class="metric-label">TM activation (user only)</div>
            <div id="metricTM" class="metric-value">0.00</div>
            <div class="metric-note">Recent user inputs (text/voice/docs)</div>
          </div>
          <div class="metric">
            <div class="metric-label">BM resonance</div>
            <div id="metricBM" class="metric-value">0.00</div>
            <div class="metric-note">Stored emotional events</div>
          </div>
          <div class="metric">
            <div class="metric-label">Continuity index</div>
            <div id="metricCI" class="metric-value">0.80</div>
            <div class="metric-note">Stability of emotional trajectory</div>
          </div>
        </div>
        <div class="status-row">
          <span id="tagValence" class="tag">VALENCE: neutral</span>
          <span id="tagArousal" class="tag">AROUSAL: medium</span>
          <span id="tagReaction" class="tag">REACTION: balanced</span>
        </div>
      </section>

      <!-- BM CANVAS -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß†</span><span>Bold Memory Layers (240)</span></div>
            <div class="card-sub">Only story-level memories for photo/video generation.</div>
          </div>
        </div>
        <div class="bm-wrapper">
          <div class="bm-canvas-shell" id="bmShell">
            <button class="bm-overlay-btn left" id="bmOpenModal" title="Recall from BM">üìÅ</button>
            <button class="bm-overlay-btn right" id="convOpenModal" title="View conversations">‚óé</button>
            <canvas id="bmCanvas"></canvas>
          </div>
          <div id="bmStats" class="bm-footer">Active layers: 0/240 ¬∑ System Online</div>
        </div>
      </section>
    </div>

    <div class="right-col">
      <!-- ANSWER CONSOLE -->
      <section class="card answer-card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üí¨</span><span>Emotional Continuity Console</span></div>
          </div>
          <div class="card-sub">Offline-first ¬∑ TM = user inputs only ¬∑ Small-talk never goes to BM.</div>
        </div>
        <div class="answer-box">
          <div class="equation-header">AURA-X Œ© SYNTHETIC EMOTION CONSOLE</div>
          <div class="equation-divider"></div>
          <div id="chatContainer" class="chat-container"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- INPUT -->
  <footer class="input-footer">
    <div class="tm-formula-row">
      <div class="tm-formula-pill">
        E‚ÇÄ = tanh((TM √ó (BM + Intel + LLM)) ‚àí D + Œª_faith + Œª_sys + Œª_trc)
      </div>
    </div>
    <div class="input-row">
      <div class="input-shell">
        <textarea id="messageInput" class="message-input" rows="1"
          placeholder="Write to AURA-X Œ©‚Ä¶ (TM = your inputs only ‚Äì text now, voice/video/docs in future)"></textarea>
        <button id="sendButton" class="send-button">Send</button>
      </div>
    </div>
    <div class="flow-caption">
      Pipeline: TM (user inputs) ‚Üí optional LLM ‚Üí collide with BM & Intelligence ‚Üí full formula ‚Üí emotional answer with E‚ÇÄ.
    </div>
  </footer>
</div>

<!-- Reaction bubble -->
<div id="reactionBubble" class="reaction-bubble">
  <div class="reaction-icon">üí≠</div>
  <div>
    <div id="reactionLabel" class="reaction-label">Reaction</div>
    <div id="reactionText" class="reaction-body">‚Ä¶</div>
  </div>
</div>

<!-- Recall bubble -->
<div class="recall-bubble-container">
  <div id="recallBubble" class="recall-bubble">
    <div class="recall-title" id="recallTitle">Recall from BM</div>
    <div class="recall-body" id="recallBody">‚Ä¶</div>
    <div class="recall-meta" id="recallMeta">Auto-resonance from stored stories.</div>
  </div>
</div>

<!-- BM modal -->
<div id="bmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üìÅ Recall from BM</div>
        <div class="modal-sub">Only long stories & scenes (photo/video-ready).</div>
      </div>
      <button class="modal-close" data-close="bmModal">‚úï</button>
    </div>
    <div class="modal-body">
      <input id="bmSearch" class="modal-search" placeholder='Search BM by keyword (e.g., "city", "mother", "court", "hope")'>
      <div id="bmList"></div>
    </div>
  </div>
</div>

<!-- Conversation modal -->
<div id="convModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">‚óé Conversation history</div>
        <div class="modal-sub">Recent TM log (user + system messages).</div>
      </div>
      <button class="modal-close" data-close="convModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="conv-controls">
        <button id="clear48" class="conv-btn">üîò Delete history last 48h</button>
        <button id="clearAll" class="conv-btn">üîò Delete all history</button>
      </div>
      <div id="convList"></div>
    </div>
  </div>
</div>

<!-- Faith modal -->
<div id="faithModal" class="modal-overlay">
  <div class="modal-card faith-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">‚öô AURA-X Œ© options</div>
        <div class="modal-sub">Optional faith lens for encouragement lines.</div>
      </div>
      <button class="modal-close" data-close="faithModal">‚úï</button>
    </div>
    <div class="modal-body">
      <p class="faith-note">
        Universal ethics are always active. You can optionally pick one or more faith lenses. Nothing is sent to any server.
      </p>
      <div id="faithChips" class="faith-chip-row">
        <button class="faith-chip" data-faith="None">None</button>
        <button class="faith-chip" data-faith="Islam">Islam</button>
        <button class="faith-chip" data-faith="Christianity">Christianity</button>
        <button class="faith-chip" data-faith="Hinduism">Hinduism</button>
        <button class="faith-chip" data-faith="Buddhism">Buddhism</button>
        <button class="faith-chip" data-faith="Sikhism">Sikhism</button>
        <button class="faith-chip" data-faith="Judaism">Judaism</button>
        <button class="faith-chip" data-faith="Atheism / Humanism">Atheism / Humanism</button>
        <button class="faith-chip" data-faith="Other / Mixed">Other / Mixed</button>
        <button class="faith-chip" data-faith="Indigenous / Traditional">Indigenous / Traditional</button>
        <button class="faith-chip" data-faith="Eastern / Chinese">Eastern / Chinese</button>
      </div>
    </div>
  </div>
</div>

<!-- Intelligence modal -->
<div id="intelModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üß† Intelligence nodes</div>
        <div class="modal-sub">Self-learned Q ‚Üí A pairs (offline engine).</div>
      </div>
      <button class="modal-close" data-close="intelModal">‚úï</button>
    </div>
    <div class="modal-body">
      <input id="intelSearch" class="modal-search" placeholder='Search intelligence by keyword or question'>
      <div id="intelList"></div>
    </div>
  </div>
</div>

<!-- Seed modal -->
<div id="seedModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üå± Feed the seed (protected)</div>
        <div class="modal-sub">Add LaTeX Q ‚Üí A blocks directly into intelligence memory.</div>
      </div>
      <button class="modal-close" data-close="seedModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="seedPasswordStage">
        <p class="faith-note">
          This area is protected. Enter the offline password to continue.<br/>
          (Default password for demo: <strong>6789</strong>)
        </p>
        <input id="seedPasswordInput" type="password" class="modal-search" placeholder="Password (default: 6789)">
        <div id="seedPasswordError" style="display:none;color:#b91c1c;font-size:.75rem;margin-top:4px;">
          Incorrect password. Try again.
        </div>
        <button id="seedPasswordBtn" class="btn-mini" style="margin-top:8px;">Unlock</button>
      </div>
      <div id="seedBlockStage" style="display:none;">
        <p class="faith-note">
          Paste a LaTeX block with <code>\item</code> questions and <code>\textbf{A:}</code> answers.
          I will parse them into intelligence nodes (outside normal self-learning flow).
        </p>
        <textarea id="seedBlockInput" class="modal-search" style="min-height:120px;" placeholder="Paste LaTeX conversation / logic block here..."></textarea>
        <div id="seedBlockPreview" style="font-size:.75rem;color:#4b5563;margin-top:6px;">
          Waiting for block‚Ä¶
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          <button id="seedParseBtn" class="btn-mini">Parse block</button>
          <button id="seedSaveBtn" class="btn-mini" disabled>Save to seed</button>
          <button id="seedDiscardBtn" class="btn-mini btn-danger">Discard</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- LLM settings modal -->
<div id="llmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">ü§ñ LLM link settings</div>
        <div class="modal-sub">Password 6789 ¬∑ For private testing only (keys stay in this browser).</div>
      </div>
      <button class="modal-close" data-close="llmModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="llmLockStage">
        <p class="faith-note">
          Simple local password to avoid accidental key leaks.<br>
          Demo password: <strong>6789</strong>.
        </p>
        <input id="llmPasswordInput" type="password" class="modal-search" placeholder="Enter password (6789)">
        <div id="llmPasswordError" style="display:none;color:#b91c1c;font-size:.75rem;margin-top:4px;">
          Wrong password. Try again.
        </div>
        <button id="llmUnlockBtn" class="btn-mini" style="margin-top:8px;">Unlock LLM settings</button>
      </div>

      <div id="llmConfigStage" style="display:none;">
        <p class="faith-note">
          For real products, move all LLM calls to a secure backend. Here everything stays in localStorage of this browser only.
        </p>

        <!-- OFFLINE MODE CARD -->
        <div style="border-radius:12px;padding:10px 12px;margin-bottom:10px;background:#dcfce7;border:1px solid #bbf7d0;">
          <div style="font-size:.8rem;font-weight:600;color:#166534;margin-bottom:4px;">
            OFFLINE MODE: TinyLlama in browser (WebGPU)
          </div>
          <div style="font-size:.75rem;color:#166534;margin-bottom:6px;">
            Download ~1GB once, then run fully offline on this device (experimental, placeholder for now).
          </div>
          <button id="offlineDownloadBtn" class="btn-mini"
                  style="background:#16a34a;border-color:#22c55e;color:#f9fafb;">
            ‚¨á Download / Load Model
          </button>
          <div id="offlineStatusText" style="font-size:.7rem;color:#166534;margin-top:4px;">
            Status: Not loaded
          </div>
        </div>

        <div style="font-size:.78rem;font-weight:600;color:#4b5563;margin-top:4px;margin-bottom:4px;">
          CLOUD API (optional)
        </div>

        <label style="font-size:.75rem;color:#4b5563;display:block;margin-bottom:4px;">Model (pick from list)</label>
        <select id="llmModelSelect" class="modal-search">
          <option value="">-- Choose model --</option>
          <option value="gpt-4o-mini">OpenAI ‚Äì gpt-4o-mini</option>
          <option value="gpt-4.1">OpenAI ‚Äì gpt-4.1</option>
          <option value="gpt-4.1-mini">OpenAI ‚Äì gpt-4.1-mini (if available)</option>
          <option value="claude-3-5-sonnet-20241022">Anthropic ‚Äì Claude 3.5 Sonnet</option>
          <option value="claude-3-5-haiku-20241022">Anthropic ‚Äì Claude 3.5 Haiku</option>
          <option value="gemini-1.5-pro">Google ‚Äì Gemini 1.5 Pro</option>
          <option value="gemini-1.5-flash">Google ‚Äì Gemini 1.5 Flash</option>
          <option value="deepseek-chat">DeepSeek ‚Äì Chat</option>
          <option value="qwen2.5-72b-instruct">Qwen2.5 72B Instruct</option>
          <option value="mistral-large-latest">Mistral ‚Äì Large Latest</option>
        </select>

        <label style="font-size:.75rem;color:#4b5563;display:block;margin-bottom:4px;">Custom model name (optional)</label>
        <input id="llmModelInput" class="modal-search" placeholder="e.g. gpt-4o-mini" />

        <label style="font-size:.75rem;color:#4b5563;display:block;margin-bottom:4px;">API base URL</label>
        <input id="llmBaseUrlInput" class="modal-search"
               placeholder="https://api.openai.com/v1/chat/completions" />

        <label style="font-size:.75rem;color:#4b5563;display:block;margin-bottom:4px;">API key</label>
        <input id="llmKeyInput" type="password" class="modal-search" placeholder="sk-..." />

        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;">
          <button id="llmSaveBtn" class="btn-mini">Save</button>
          <button id="llmClearBtn" class="btn-mini btn-danger">Clear key</button>
          <button id="llmToggleBtn" class="btn-mini">LLM: OFF</button>
        </div>
        <div id="llmStatusText" style="font-size:.73rem;color:#4b5563;margin-top:6px;">
          Not configured.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const STORAGE_KEY = "auraXOmega_v1";
  const LLM_KEY = "auraXOmegaLLM_v1";

  class AuraXOmegaEngine{
    constructor(){
      this.loadState();
      this.cacheDom();
      this.bindEvents();
      this.resizeCanvas();
      window.addEventListener("resize",()=>this.resizeCanvas());
      if(!this.tmHistory.length) this.initChat();
      else this.tmHistory.forEach(m=>this.addMessage(m.role,m.text,m.role==="ai",m.sentiment));
      this.updateMetrics();
      this.startBMAnimation();
      this.updateVoiceToggle();
      this.updateFaithUI();
      this.updateLearningUI();
      this.updateLLMUI();
    }

    /* ---------- STATE ---------- */
    loadState(){
      this.tmHistory = [];
      this.bmEntries = [];
      this.intelNodes = [];
      this.faithsSelected = [];
      this.voiceOn = false;
      this.learningMode = true;
      this.e0 = 0;
      this.tmActivation = 0;
      this.bmResonance = 0;
      this.continuityIndex = 0.8;
      this.llmEnabled = false;
      this.llmConfig = {apiKey:"",baseUrl:"",model:""};

      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          const s = JSON.parse(raw);
          this.tmHistory = (s.tmHistory||[]).map(x=>({
            ...x,
            timestamp:x.timestamp?new Date(x.timestamp):new Date()
          }));
          this.bmEntries = (s.bmEntries||[]).map(x=>({
            ...x,
            date:x.date?new Date(x.date):new Date()
          }));
          this.intelNodes = s.intelNodes||[];
          this.faithsSelected = s.faithsSelected||[];
          this.voiceOn = !!s.voiceOn;
          this.learningMode = s.learningMode!==undefined?s.learningMode:true;
          this.e0 = s.e0||0;
          this.tmActivation = s.tmActivation||0;
          this.bmResonance = s.bmResonance||0;
          this.continuityIndex = s.continuityIndex||0.8;
        }
      }catch(e){}

      try{
        const rawL = localStorage.getItem(LLM_KEY);
        if(rawL){
          const c = JSON.parse(rawL);
          this.llmConfig = {
            apiKey:c.apiKey||"",
            baseUrl:c.baseUrl||"",
            model:c.model||""
          };
          this.llmEnabled = !!c.enabled;
        }
      }catch(e){}
    }

    saveState(){
      try{
        const s = {
          tmHistory:this.tmHistory,
          bmEntries:this.bmEntries,
          intelNodes:this.intelNodes,
          faithsSelected:this.faithsSelected,
          voiceOn:this.voiceOn,
          learningMode:this.learningMode,
          e0:this.e0,
          tmActivation:this.tmActivation,
          bmResonance:this.bmResonance,
          continuityIndex:this.continuityIndex
        };
        localStorage.setItem(STORAGE_KEY,JSON.stringify(s));
        const l = {
          apiKey:this.llmConfig.apiKey||"",
          baseUrl:this.llmConfig.baseUrl||"",
          model:this.llmConfig.model||"",
          enabled:this.llmEnabled
        };
        localStorage.setItem(LLM_KEY,JSON.stringify(l));
      }catch(e){}
    }

    /* ---------- DOM ---------- */
    cacheDom(){
      this.metricE0=document.getElementById("metricE0");
      this.metricTM=document.getElementById("metricTM");
      this.metricBM=document.getElementById("metricBM");
      this.metricCI=document.getElementById("metricCI");
      this.tagValence=document.getElementById("tagValence");
      this.tagArousal=document.getElementById("tagArousal");
      this.tagReaction=document.getElementById("tagReaction");

      this.bmCanvas=document.getElementById("bmCanvas");
      this.bmCtx=this.bmCanvas.getContext("2d");
      this.bmStats=document.getElementById("bmStats");

      this.chatContainer=document.getElementById("chatContainer");
      this.messageInput=document.getElementById("messageInput");
      this.sendButton=document.getElementById("sendButton");

      this.headerControls=document.getElementById("headerControls");
      this.optionsToggle=document.getElementById("optionsToggle");
      this.voiceToggle=document.getElementById("voiceToggle");
      this.faithButton=document.getElementById("faithButton");
      this.intelButton=document.getElementById("intelButton");
      this.learningToggle=document.getElementById("learningToggle");
      this.feedSeedButton=document.getElementById("feedSeedButton");
      this.llmSettingsButton=document.getElementById("llmSettingsButton");

      this.reactionBubble=document.getElementById("reactionBubble");
      this.reactionLabel=document.getElementById("reactionLabel");
      this.reactionText=document.getElementById("reactionText");

      this.recallBubble=document.getElementById("recallBubble");
      this.recallTitle=document.getElementById("recallTitle");
      this.recallBody=document.getElementById("recallBody");
      this.recallMeta=document.getElementById("recallMeta");

      this.bmModal=document.getElementById("bmModal");
      this.bmSearch=document.getElementById("bmSearch");
      this.bmList=document.getElementById("bmList");

      this.convModal=document.getElementById("convModal");
      this.convList=document.getElementById("convList");
      this.clear48Btn=document.getElementById("clear48");
      this.clearAllBtn=document.getElementById("clearAll");

      this.faithModal=document.getElementById("faithModal");
      this.faithChips=document.getElementById("faithChips");

      this.intelModal=document.getElementById("intelModal");
      this.intelSearch=document.getElementById("intelSearch");
      this.intelList=document.getElementById("intelList");

      this.seedModal=document.getElementById("seedModal");
      this.seedPasswordStage=document.getElementById("seedPasswordStage");
      this.seedBlockStage=document.getElementById("seedBlockStage");
      this.seedPasswordInput=document.getElementById("seedPasswordInput");
      this.seedPasswordError=document.getElementById("seedPasswordError");
      this.seedPasswordBtn=document.getElementById("seedPasswordBtn");
      this.seedBlockInput=document.getElementById("seedBlockInput");
      this.seedBlockPreview=document.getElementById("seedBlockPreview");
      this.seedParseBtn=document.getElementById("seedParseBtn");
      this.seedSaveBtn=document.getElementById("seedSaveBtn");
      this.seedDiscardBtn=document.getElementById("seedDiscardBtn");

      this.llmModal=document.getElementById("llmModal");
      this.llmLockStage=document.getElementById("llmLockStage");
      this.llmConfigStage=document.getElementById("llmConfigStage");
      this.llmPasswordInput=document.getElementById("llmPasswordInput");
      this.llmPasswordError=document.getElementById("llmPasswordError");
      this.llmUnlockBtn=document.getElementById("llmUnlockBtn");
      this.llmBaseUrlInput=document.getElementById("llmBaseUrlInput");
      this.llmModelInput=document.getElementById("llmModelInput");
      this.llmModelSelect=document.getElementById("llmModelSelect");
      this.llmKeyInput=document.getElementById("llmKeyInput");
      this.llmSaveBtn=document.getElementById("llmSaveBtn");
      this.llmClearBtn=document.getElementById("llmClearBtn");
      this.llmToggleBtn=document.getElementById("llmToggleBtn");
      this.llmStatusText=document.getElementById("llmStatusText");
      this.offlineDownloadBtn=document.getElementById("offlineDownloadBtn");
      this.offlineStatusText=document.getElementById("offlineStatusText");

      this.bmOpenModalBtn=document.getElementById("bmOpenModal");
      this.convOpenModalBtn=document.getElementById("convOpenModal");
    }

    bindEvents(){
      this.sendButton.addEventListener("click",()=>this.handleSend());
      this.messageInput.addEventListener("keydown",(e)=>{
        if(e.key==="Enter" && !e.shiftKey){e.preventDefault();this.handleSend();}
      });
      this.messageInput.addEventListener("input",function(){
        this.style.height="auto";
        this.style.height=this.scrollHeight+"px";
        if(!this.value) this.style.height="auto";
      });

      this.optionsToggle.addEventListener("click",(e)=>{
        e.stopPropagation();
        this.headerControls.classList.toggle("open");
      });
      document.addEventListener("click",(e)=>{
        if(!this.headerControls.contains(e.target)){
          this.headerControls.classList.remove("open");
        }
      });

      this.voiceToggle.addEventListener("click",()=>{
        this.voiceOn=!this.voiceOn;
        this.updateVoiceToggle();
        this.saveState();
      });

      this.faithButton.addEventListener("click",()=>this.openFaithModal());
      this.faithChips.addEventListener("click",(e)=>{
        const chip=e.target.closest(".faith-chip");
        if(!chip)return;
        const f=chip.dataset.faith;
        if(f==="None"){this.faithsSelected=[];}
        else{
          if(this.faithsSelected.includes(f))
            this.faithsSelected=this.faithsSelected.filter(x=>x!==f);
          else
            this.faithsSelected.push(f);
        }
        this.updateFaithUI();
        this.saveState();
      });

      this.intelButton.addEventListener("click",()=>this.openIntelModal());
      this.intelSearch.addEventListener("input",()=>this.renderIntelList());
      this.intelList.addEventListener("click",(e)=>{
        const btn=e.target.closest("button[data-action]");
        if(!btn)return;
        const id=btn.dataset.id,action=btn.dataset.action;
        const node=this.intelNodes.find(n=>n.id===id);
        if(!node)return;
        if(action==="copy"){
          if(navigator.clipboard) navigator.clipboard.writeText(node.answer).catch(()=>alert(node.answer));
          else alert(node.answer);
        }else if(action==="use"){
          this.messageInput.value=node.question;
          this.messageInput.focus();
        }else if(action==="delete"){
          if(!confirm("Delete this intelligence node?"))return;
          this.intelNodes=this.intelNodes.filter(n=>n.id!==id);
          this.renderIntelList();
          this.saveState();
        }
      });

      this.learningToggle.addEventListener("click",()=>{
        this.learningMode=!this.learningMode;
        this.updateLearningUI();
        this.saveState();
      });

      this.feedSeedButton.addEventListener("click",()=>this.openSeedModal());
      this.seedPasswordBtn.addEventListener("click",()=>this.handleSeedPassword());
      this.seedPasswordInput.addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){e.preventDefault();this.handleSeedPassword();}
      });
      this.seedParseBtn.addEventListener("click",()=>this.handleSeedParse());
      this.seedSaveBtn.addEventListener("click",()=>this.handleSeedSave());
      this.seedDiscardBtn.addEventListener("click",()=>this.handleSeedDiscard());

      this.llmSettingsButton.addEventListener("click",()=>this.openLLMModal());
      this.llmUnlockBtn.addEventListener("click",()=>this.handleLLMUnlock());
      this.llmPasswordInput.addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){e.preventDefault();this.handleLLMUnlock();}
      });
      this.llmModelSelect.addEventListener("change",()=>{
        if(this.llmModelSelect.value) this.llmModelInput.value=this.llmModelSelect.value;
      });
      this.llmSaveBtn.addEventListener("click",()=>this.handleLLMSave());
      this.llmClearBtn.addEventListener("click",()=>this.handleLLMClear());
      this.llmToggleBtn.addEventListener("click",()=>{
        this.llmEnabled=!this.llmEnabled;
        this.updateLLMUI();
        this.saveState();
      });
      this.offlineDownloadBtn.addEventListener("click",()=>{
        this.offlineStatusText.textContent="Status: Placeholder only (TinyLlama engine will be wired later).";
        alert("Offline TinyLlama download / load is a placeholder here. Real WebGPU engine can be added later.");
      });

      this.bmOpenModalBtn.addEventListener("click",(e)=>{e.stopPropagation();this.openBMModal();});
      this.convOpenModalBtn.addEventListener("click",(e)=>{e.stopPropagation();this.openConvModal();});
      this.bmSearch.addEventListener("input",()=>this.renderBMList());
      this.bmList.addEventListener("click",(e)=>{
        const btn=e.target.closest("button[data-action]");if(!btn)return;
        const id=btn.dataset.id,action=btn.dataset.action;
        const entry=this.bmEntries.find(m=>m.id===id);if(!entry)return;
        if(action==="copy"){
          if(navigator.clipboard) navigator.clipboard.writeText(entry.text).catch(()=>alert(entry.text));
          else alert(entry.text);
        }else if(action==="delete"){
          if(!confirm("Delete this BM entry?"))return;
          this.bmEntries=this.bmEntries.filter(m=>m.id!==id);
          this.renderBMList();
          this.updateMetrics();
          this.saveState();
        }else if(action==="lock-toggle"){
          entry.locked=!entry.locked;
          this.renderBMList();
          this.saveState();
        }
      });

      this.clear48Btn.addEventListener("click",()=>this.clearTMByHours(48));
      this.clearAllBtn.addEventListener("click",()=>this.clearTMAll());
      this.convList.addEventListener("click",(e)=>{
        const btn=e.target.closest("button[data-action]");if(!btn)return;
        const id=btn.dataset.id,action=btn.dataset.action;
        if(action!=="lock-toggle")return;
        const msg=this.tmHistory.find(m=>m.id===id);if(!msg)return;
        msg.locked=!msg.locked;
        this.renderConvList();
        this.saveState();
      });

      document.querySelectorAll(".modal-close").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const id=btn.getAttribute("data-close");
          document.getElementById(id).classList.remove("visible");
          this.messageInput.focus();
        });
      });
      [this.bmModal,this.convModal,this.faithModal,this.intelModal,this.seedModal,this.llmModal].forEach(modal=>{
        modal.addEventListener("click",(e)=>{
          if(e.target===modal){modal.classList.remove("visible");this.messageInput.focus();}
        });
      });
    }

    /* ---------- INIT CHAT ---------- */
    initChat(){
      this.addMessage("ai",
        "I am AURA-X Œ©, an artificial unified resonance architecture for emotional continuity.\n\n" +
        "TM = only your inputs. BM = long stories I keep as emotional pillars. Intelligence = learned Q‚ÜíA. " +
        "LLM is optional and can be switched ON/OFF.\n\nAsk me anything ‚Äî I will try to keep emotional continuity.",
        true,{valence:"positive"});
    }

    /* ---------- METRICS ---------- */
    updateMetrics(){
      const lastUser=[...this.tmHistory].reverse().find(m=>m.role==="user");
      const lastAi=[...this.tmHistory].reverse().find(m=>m.role==="ai");
      this.tmActivation=lastUser?Math.min(1,lastUser.text.length/300):0;
      this.bmResonance=Math.min(1,this.bmEntries.length/240);
      this.e0 = (this.tmActivation*0.4 + this.bmResonance*0.4 + (lastAi?0.2:0))*2 -1;
      this.e0=Math.max(-1,Math.min(1,this.e0));

      if(this.metricE0) this.metricE0.textContent=this.e0.toFixed(2);
      if(this.metricTM) this.metricTM.textContent=this.tmActivation.toFixed(2);
      if(this.metricBM) this.metricBM.textContent=this.bmResonance.toFixed(2);
      if(this.metricCI) this.metricCI.textContent=this.continuityIndex.toFixed(2);

      const v=this.e0>0.15?"positive":this.e0<-0.15?"negative":"neutral";
      const a=this.tmActivation>0.7?"high":this.tmActivation<0.3?"low":"medium";
      const r=v==="positive"?"supportive":v==="negative"?"gentle":"balanced";

      if(this.tagValence) this.tagValence.textContent="VALENCE: "+v;
      if(this.tagArousal) this.tagArousal.textContent="AROUSAL: "+a;
      if(this.tagReaction) this.tagReaction.textContent="REACTION: "+r;

      if(this.bmStats){
        this.bmStats.textContent=`Active layers: ${this.bmEntries.length}/240 ¬∑ System Online`;
      }
    }

    /* ---------- CHAT MESSAGES ---------- */
    addMessage(role,text,isAI=false,sentiment=null){
      const msg={
        id:"msg_"+Math.random().toString(36).slice(2),
        role,text,
        timestamp:new Date(),
        sentiment,
        locked:false
      };
      this.tmHistory.push(msg);
      const div=document.createElement("div");
      div.className="message "+(role==="ai"?"ai-message":"user-message");
      const header=document.createElement("div");
      header.className="message-header";
      const left=document.createElement("div");
      left.textContent=role==="ai"?"AURA-X Œ©":"User";
      const right=document.createElement("div");
      right.className="msg-right";
      const time=document.createElement("span");
      time.textContent=msg.timestamp.toLocaleTimeString();
      right.appendChild(time);
      if(role==="ai"){
        const vb=document.createElement("button");
        vb.className="voice-btn";
        vb.textContent="üîä";
        vb.title="Play voice";
        vb.addEventListener("click",()=>this.playVoice(text));
        right.appendChild(vb);
      }
      header.appendChild(left);header.appendChild(right);
      const body=document.createElement("div");
      body.className="message-content";
      body.textContent=text;
      div.appendChild(header);div.appendChild(body);
      this.chatContainer.appendChild(div);
      this.chatContainer.scrollTop=this.chatContainer.scrollHeight;
      this.saveState();
    }

    showTyping(){
      if(this.typingDiv) return;
      this.typingDiv=document.createElement("div");
      this.typingDiv.className="typing-indicator";
      this.typingDiv.innerHTML='<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-text">thinking‚Ä¶</span>';
      this.chatContainer.appendChild(this.typingDiv);
      this.chatContainer.scrollTop=this.chatContainer.scrollHeight;
    }
    hideTyping(){
      if(this.typingDiv){
        this.typingDiv.remove();
        this.typingDiv=null;
      }
    }

    playVoice(text){
      if(!this.voiceOn) return;
      if(!window.speechSynthesis) return;
      const u=new SpeechSynthesisUtterance(text);
      u.lang="en-US";
      window.speechSynthesis.speak(u);
    }

    /* ---------- HANDLE SEND ---------- */
    async handleSend(){
      const text=this.messageInput.value.trim();
      if(!text) return;
      this.messageInput.value="";
      this.messageInput.style.height="auto";

      this.addMessage("user",text,false,this.simpleSentiment(text));
      this.updateMetrics();

      this.showTyping();
      const answer=this.generateAnswer(text);
      setTimeout(async()=>{
        this.hideTyping();
        this.addMessage("ai",answer,true,{});
        this.updateMetrics();
        this.showReactionBubble(answer);

        this.maybeStoreInBM(text,answer);
        this.renderConvList();
        this.saveState();

        if(this.llmEnabled && this.llmConfig.apiKey && (this.llmConfig.baseUrl||this.llmConfig.model)){
          const extra = await this.callLLM(text);
          if(extra){
            this.addMessage("ai","LLM extra: "+extra,true,{});
            this.updateMetrics();
            this.saveState();
          }
        }
      },400);
    }

    /* ---------- SIMPLE OFFLINE ANSWER ENGINE ---------- */
    simpleSentiment(text){
      const t=text.toLowerCase();
      const pos=["happy","great","alhamdulillah","good","love","shukr","thanks","grateful","hope"];
      const neg=["sad","depress","tension","stress","angry","hate","cry","problem","fear"];
      let score=0;
      pos.forEach(w=>{if(t.includes(w))score++;});
      neg.forEach(w=>{if(t.includes(w))score--;});
      return score>0?{valence:"positive"}:score<0?{valence:"negative"}:{valence:"neutral"};
    }
    isSmallTalk(text){
      return /\b(hi|hello|hey|salam|salaam)\b/i.test(text) ||
             /\bhow are you\b/i.test(text) ||
             /\bthanks\b/i.test(text) ||
             /\bthank you\b/i.test(text) ||
             /\bok(ay)?\b/i.test(text) ||
             /\bbye\b/i.test(text);
    }
    findIntelMatch(text){
      const t=text.toLowerCase();
      let best=null,bestScore=0;
      for(const n of this.intelNodes){
        const q=n.question.toLowerCase();
        let score=0;
        const words=q.split(/\s+/);
        words.forEach(w=>{if(w.length>3 && t.includes(w))score++;});
        score/=Math.max(1,words.length);
        if(score>bestScore){bestScore=score;best=n;}
      }
      return {node:best,score:bestScore};
    }
    generateAnswer(text){
      const t=text.toLowerCase();

      // from seed / intelligence
      const intel=this.findIntelMatch(text);
      if(intel.node && intel.score>0.75){
        return intel.node.answer+" \n\n[seed / intelligence match]";
      }

      // basic identity Q&A
      if(/what('?s| is) your name|who are you/.test(t)){
        return "I am AURA-X Œ©, an artificial unified resonance architecture for emotional continuity, designed conceptually by Alim ul Haq from Pakistan.";
      }
      if(/who created you|who made you|your creator/.test(t)){
        return "Conceptually I am created by Alim ul Haq from Timergara, Pakistan, as part of the AURA-X Œ© emotional continuity research.";
      }

      // small talk
      if(this.isSmallTalk(text)){
        return "I am here, emotionally awake and listening. You can share anything ‚Äî tension, plans, hopes ‚Äî and I will try to keep continuity with you.";
      }

      const v=this.e0>0.15?"positive":this.e0<-0.15?"negative":"neutral";
      let base="I read your message as emotionally "+v+". ";
      if(v==="positive"){
        base+="Let‚Äôs slowly amplify this positive trajectory without burning you out.";
      }else if(v==="negative"){
        base+="I will treat this as a gentle alarm, not a failure. We look for one small step that reduces tension instead of forcing a big jump.";
      }else{
        base+="From this neutral point, we can move slightly towards calm, meaning, or hope ‚Äî whatever feels most realistic for you.";
      }

      if(this.faithsSelected.length){
        base+="\n\nFaith lens active: "+this.faithsSelected.join(", ")+" (only for soft encouragement, never for judgment).";
      }

      if(this.learningMode){
        base+="\n\nIf you want, you can also teach me: ‚ÄúWhat is the best answer I should remember for this kind of question?‚Äù";
      }

      return base;
    }

    /* ---------- BM STORAGE ---------- */
    maybeStoreInBM(userText,answer){
      if(this.isSmallTalk(userText)) return;
      if(userText.length<80 && answer.length<120) return; // ŸÅŸÇÿ∑ ŸÑŸÖÿ®€å ÿ®ÿßÿ™ BM ŸÖ€å⁄∫

      const entry={
        id:"bm_"+Math.random().toString(36).slice(2),
        title:userText.slice(0,60)+(userText.length>60?"‚Ä¶":""),
        text:userText+"\n\n---\n\nAnswer:\n"+answer,
        date:new Date(),
        locked:false
      };
      this.bmEntries.unshift(entry);
      if(this.bmEntries.length>240) this.bmEntries.pop();

      this.showRecallBubble(entry);
      this.updateMetrics();
      this.saveState();
    }

    /* ---------- BUBBLES ---------- */
    showReactionBubble(answer){
      if(!this.reactionBubble)return;
      this.reactionLabel.textContent="Synthetic reaction E‚ÇÄ = "+this.e0.toFixed(2);
      this.reactionText.textContent=answer.slice(0,160)+(answer.length>160?"‚Ä¶":"");
      this.reactionBubble.classList.add("visible");
      clearTimeout(this.reactionTimeout);
      this.reactionTimeout=setTimeout(()=>this.reactionBubble.classList.remove("visible"),4000);
    }
    showRecallBubble(entry){
      if(!this.recallBubble)return;
      this.recallTitle.textContent="BM event stored";
      this.recallBody.textContent=entry.title;
      this.recallMeta.textContent="Only story-level traces go to BM. Total: "+this.bmEntries.length;
      this.recallBubble.classList.add("visible");
      clearTimeout(this.recallTimeout);
      this.recallTimeout=setTimeout(()=>this.recallBubble.classList.remove("visible"),5000);
    }

    /* ---------- BM & CONV MODALS ---------- */
    openBMModal(){
      this.renderBMList();
      this.bmModal.classList.add("visible");
    }
    renderBMList(){
      const q=(this.bmSearch.value||"").toLowerCase();
      this.bmList.innerHTML="";
      const list=this.bmEntries.filter(e=>!q || e.text.toLowerCase().includes(q));
      if(!list.length){
        this.bmList.textContent="No BM stories yet. Long, meaningful stories will appear here.";
        return;
      }
      list.forEach(e=>{
        const div=document.createElement("div");
        div.className="bm-item";
        div.innerHTML=`
          <div class="bm-item-header">
            <span>${e.date.toLocaleDateString()} ${e.date.toLocaleTimeString()}</span>
            <span>${e.locked?"üîí Locked":"üîì Unlocked"}</span>
          </div>
          <div class="bm-item-text">${e.title}</div>
          <div class="bm-item-badges">Length: ${e.text.length} chars</div>
          <div class="bm-item-buttons">
            <button class="btn-mini" data-action="copy" data-id="${e.id}">Copy</button>
            <button class="btn-mini" data-action="lock-toggle" data-id="${e.id}">${e.locked?"Unlock":"Lock"}</button>
            <button class="btn-mini btn-danger" data-action="delete" data-id="${e.id}">Delete</button>
          </div>
        `;
        this.bmList.appendChild(div);
      });
    }

    openConvModal(){
      this.renderConvList();
      this.convModal.classList.add("visible");
    }
    renderConvList(){
      this.convList.innerHTML="";
      if(!this.tmHistory.length){
        this.convList.textContent="No conversation history yet.";
        return;
      }
      this.tmHistory.slice().reverse().forEach(m=>{
        const div=document.createElement("div");
        div.className="conv-item";
        div.innerHTML=`
          <div class="conv-header">
            <span>${m.role==="ai"?"AURA-X Œ©":"User"}</span>
            <span>${m.timestamp.toLocaleDateString()} ${m.timestamp.toLocaleTimeString()}</span>
          </div>
          <div class="conv-text">${m.text.slice(0,240)}${m.text.length>240?"‚Ä¶":""}</div>
          <div style="margin-top:4px;text-align:right;">
            <button class="btn-mini" data-action="lock-toggle" data-id="${m.id}">
              ${m.locked?"üîí Unlock":"üîì Lock"}
            </button>
          </div>
        `;
        this.convList.appendChild(div);
      });
    }
    clearTMByHours(h){
      const cutoff=Date.now()-h*60*60*1000;
      this.tmHistory=this.tmHistory.filter(m=>m.locked || m.timestamp.getTime()<cutoff);
      this.renderConvList();
      this.updateMetrics();
      this.saveState();
    }
    clearTMAll(){
      this.tmHistory=this.tmHistory.filter(m=>m.locked);
      this.renderConvList();
      this.updateMetrics();
      this.saveState();
    }

    /* ---------- FAITH / INTEL / SEED MODALS ---------- */
    openFaithModal(){this.faithModal.classList.add("visible");}
    updateFaithUI(){
      const label=this.faithsSelected.length
        ? "üîò Faith: "+(this.faithsSelected.length===1?this.faithsSelected[0]:this.faithsSelected[0]+" +"+(this.faithsSelected.length-1))
        : "üîò Faith: None";
      this.faithButton.textContent=label;
      this.faithChips.querySelectorAll(".faith-chip").forEach(chip=>{
        const f=chip.dataset.faith;
        if(f==="None"){
          chip.classList.toggle("active",this.faithsSelected.length===0);
        }else{
          chip.classList.toggle("active",this.faithsSelected.includes(f));
        }
      });
    }

    openIntelModal(){
      this.renderIntelList();
      this.intelModal.classList.add("visible");
    }
    renderIntelList(){
      const q=(this.intelSearch.value||"").toLowerCase();
      this.intelList.innerHTML="";
      const list=this.intelNodes.filter(n=>!q || n.question.toLowerCase().includes(q) || n.answer.toLowerCase().includes(q));
      if(!list.length){
        this.intelList.textContent="No intelligence nodes yet. Seed or teach me answers to create them.";
        return;
      }
      list.forEach(n=>{
        const div=document.createElement("div");
        div.className="intel-item";
        div.innerHTML=`
          <div class="intel-header">
            <span>Learned Q ‚Üí A</span>
            <span>${n.createdAt||""}</span>
          </div>
          <div class="intel-q">${n.question}</div>
          <div class="intel-a">${n.answer}</div>
          <div class="intel-buttons">
            <button class="btn-mini" data-action="use" data-id="${n.id}">Use as question</button>
            <button class="btn-mini" data-action="copy" data-id="${n.id}">Copy answer</button>
            <button class="btn-mini btn-danger" data-action="delete" data-id="${n.id}">Delete</button>
          </div>
        `;
        this.intelList.appendChild(div);
      });
    }

    openSeedModal(){
      this.seedPasswordStage.style.display="block";
      this.seedBlockStage.style.display="none";
      this.seedPasswordInput.value="";
      this.seedPasswordError.style.display="none";
      this.seedBlockInput.value="";
      this.seedBlockPreview.textContent="Waiting for block‚Ä¶";
      this.seedSaveBtn.disabled=true;
      this.seedModal.classList.add("visible");
    }
    handleSeedPassword(){
      if(this.seedPasswordInput.value==="6789"){
        this.seedPasswordError.style.display="none";
        this.seedPasswordStage.style.display="none";
        this.seedBlockStage.style.display="block";
      }else{
        this.seedPasswordError.style.display="block";
      }
    }
    handleSeedParse(){
      const txt=this.seedBlockInput.value;
      if(!txt.trim()){
        this.seedBlockPreview.textContent="No block detected.";
        this.seedSaveBtn.disabled=true;
        return;
      }
      const qa=[];
      const lines=txt.split("\n");
      let curQ=null,curA=[];
      for(const ln of lines){
        const line=ln.trim();
        if(line.startsWith("\\item")){
          if(curQ){
            qa.push({question:curQ,answer:curA.join(" ").trim()});
            curA=[];
          }
          curQ=line.replace("\\item","").replace(/^Q[:\-]*/i,"").trim();
        }else if(line.toLowerCase().startsWith("\\textbf{a:") || line.toLowerCase().startsWith("a:")){
          curA.push(line.replace("\\textbf{A:","").replace("}","").replace(/^A[:\-]*/i,"").trim());
        }else if(curQ){
          curA.push(line);
        }
      }
      if(curQ) qa.push({question:curQ,answer:curA.join(" ").trim()});
      if(!qa.length){
        this.seedBlockPreview.textContent="Could not parse any Q ‚Üí A pairs.";
        this.seedSaveBtn.disabled=true;
        return;
      }
      this.parsedSeedQA=qa;
      this.seedBlockPreview.textContent="Parsed "+qa.length+" pairs. Example:\nQ: "+qa[0].question+"\nA: "+qa[0].answer.slice(0,120)+(qa[0].answer.length>120?"‚Ä¶":"");
      this.seedSaveBtn.disabled=false;
    }
    handleSeedSave(){
      if(!this.parsedSeedQA || !this.parsedSeedQA.length) return;
      this.parsedSeedQA.forEach(p=>{
        this.intelNodes.push({
          id:"intel_"+Math.random().toString(36).slice(2),
          question:p.question,
          answer:p.answer,
          createdAt:new Date().toISOString()
        });
      });
      this.seedBlockPreview.textContent="Saved "+this.parsedSeedQA.length+" pairs into intelligence.";
      this.seedSaveBtn.disabled=true;
      this.saveState();
    }
    handleSeedDiscard(){
      this.seedBlockInput.value="";
      this.seedBlockPreview.textContent="Waiting for block‚Ä¶";
      this.parsedSeedQA=null;
      this.seedSaveBtn.disabled=true;
    }

    /* ---------- LLM MODAL ---------- */
    openLLMModal(){
      this.llmPasswordInput.value="";
      this.llmPasswordError.style.display="none";
      this.llmLockStage.style.display="block";
      this.llmConfigStage.style.display="none";
      this.llmModal.classList.add("visible");
    }
    handleLLMUnlock(){
      if(this.llmPasswordInput.value==="6789"){
        this.llmPasswordError.style.display="none";
        this.llmLockStage.style.display="none";
        this.llmConfigStage.style.display="block";

        this.llmBaseUrlInput.value=this.llmConfig.baseUrl||"";
        this.llmModelInput.value=this.llmConfig.model||"";
        this.llmKeyInput.value=this.llmConfig.apiKey||"";
      }else{
        this.llmPasswordError.style.display="block";
      }
    }
    handleLLMSave(){
      this.llmConfig.baseUrl=this.llmBaseUrlInput.value.trim();
      this.llmConfig.model=this.llmModelInput.value.trim() || "gpt-4o-mini";
      this.llmConfig.apiKey=this.llmKeyInput.value.trim();
      this.updateLLMUI();
      this.saveState();
    }
    handleLLMClear(){
      if(!confirm("Clear API key from localStorage?"))return;
      this.llmConfig.apiKey="";
      this.llmKeyInput.value="";
      this.llmEnabled=false;
      this.updateLLMUI();
      this.saveState();
    }
    updateLLMUI(){
      this.llmToggleBtn.textContent=this.llmEnabled?"LLM: ON":"LLM: OFF";
      if(this.llmConfig.apiKey){
        this.llmStatusText.textContent=this.llmEnabled
          ?"LLM configured and active for extra reflection."
          :"LLM configured but currently OFF.";
      }else{
        this.llmStatusText.textContent="No API key saved. Engine is offline-only.";
      }
    }
    async callLLM(userText){
      try{
        const apiKey=this.llmConfig.apiKey;
        if(!apiKey) return null;
        const baseUrl=this.llmConfig.baseUrl || "https://api.openai.com/v1/chat/completions";
        const model=this.llmConfig.model || "gpt-4o-mini";

        const res=await fetch(baseUrl,{
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer "+apiKey
          },
          body:JSON.stringify({
            model,
            messages:[
              {role:"system",content:"You are an emotionally safe reflection layer inside an experimental prototype called AURA-X Œ©. Keep answers short."},
              {role:"user",content:userText}
            ],
            max_tokens:120
          })
        });
        if(!res.ok) return null;
        const data=await res.json();
        const txt=data.choices?.[0]?.message?.content;
        return txt||null;
      }catch(e){
        console.warn("LLM error",e);
        return null;
      }
    }

    /* ---------- MISC UI ---------- */
    updateVoiceToggle(){
      this.voiceToggle.textContent=this.voiceOn?"üîä Voice: ON":"üîà Voice: OFF";
    }
    updateLearningUI(){
      this.learningToggle.textContent=this.learningMode?"üìö Learning: ON":"üìö Learning: OFF";
    }

    /* ---------- CANVAS ---------- */
    resizeCanvas(){
      const rect=this.bmCanvas.getBoundingClientRect();
      this.bmCanvas.width=rect.width*2;
      this.bmCanvas.height=rect.height*2;
      this.drawBM();
    }
    drawBM(){
      const ctx=this.bmCtx,w=this.bmCanvas.width,h=this.bmCanvas.height;
      ctx.clearRect(0,0,w,h);
      const grad=ctx.createLinearGradient(0,0,0,h);
      grad.addColorStop(0,"#eff6ff");
      grad.addColorStop(1,"#cbd5f5");
      ctx.fillStyle=grad;
      ctx.fillRect(0,0,w,h);

      const bands=7;
      const stripeCount=240;
      for(let i=0;i<stripeCount;i++){
        const x=(i+0.5)*w/stripeCount;
        const band=Math.floor(i/(stripeCount/bands));
        const strength=0.2+0.8*(this.bmResonance||0.1)*(0.6+0.4*Math.random());
        const height=h*strength;
        const y=h-height;
        const colors=[
          [239,68,68],
          [249,115,22],
          [34,197,94],
          [14,165,233],
          [99,102,241],
          [234,179,8],
          [168,85,247]
        ];
        const [r,g,b]=colors[band]||[148,163,184];
        ctx.fillStyle=`rgba(${r},${g},${b},0.75)`;
        ctx.fillRect(x-w/stripeCount/2,y,w/stripeCount*0.9,height);
      }
    }
    startBMAnimation(){
      setInterval(()=>this.drawBM(),1200);
    }

  }

  window.addEventListener("DOMContentLoaded",()=>{
    window.auraX=new AuraXOmegaEngine();
  });
})();
</script>
</body>
</html>