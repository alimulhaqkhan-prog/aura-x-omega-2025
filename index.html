<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì AEC v3.1 Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    #app {
      width: 100%;
      max-width: 540px;
      height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Header */

    .header {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .orb {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: conic-gradient(
        from 220deg,
        #f97316,
        #ec4899,
        #6366f1,
        #22c55e,
        #f97316
      );
      box-shadow: 0 0 24px rgba(248, 250, 252, 0.4);
    }

    .header-text h1 {
      font-size: 1.4rem;
      letter-spacing: 0.08em;
    }

    .header-text span {
      font-size: 0.74rem;
      opacity: 0.9;
    }

    .mode-pill {
      margin-left: auto;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-size: 0.68rem;
      text-align: right;
      line-height: 1.1;
    }

    .mode-pill span {
      display: block;
    }

    .mode-pill .mode-title {
      font-weight: 600;
      color: #a5b4fc;
    }

    .mode-pill .mode-sub {
      opacity: 0.8;
    }

    /* Pills row */

    .pill-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .pill {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: radial-gradient(circle at top, #1e293b, #020617);
      color: #e5e7eb;
      font-size: 0.74rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
    }

    .pill-muted {
      opacity: 0.7;
    }

    .pill:active {
      transform: scale(0.97);
    }

    /* Banner */

    .banner {
      margin-top: 6px;
      padding: 10px 12px;
      border-radius: 18px;
      background: linear-gradient(135deg, #f97316, #e11d48);
      color: #f9fafb;
      font-size: 0.78rem;
      box-shadow: 0 12px 32px rgba(248, 113, 113, 0.35);
    }

    /* Equation card */

    .card {
      margin-top: 8px;
      padding: 12px 14px;
      border-radius: 18px;
      background: radial-gradient(circle at top left, #111827, #020617);
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.8);
    }

    .card-title {
      font-size: 0.78rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .equation-main {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      background: rgba(15, 23, 42, 0.8);
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 6px;
      border: 1px solid rgba(55, 65, 81, 0.8);
    }

    .eq-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 10px;
      font-size: 0.74rem;
      margin-top: 4px;
    }

    .eq-label {
      color: #9ca3af;
    }

    .eq-value {
      text-align: right;
      font-family: "SF Mono", ui-monospace, monospace;
      color: #e5e7eb;
    }

    .eq-e0 {
      margin-top: 4px;
      font-size: 0.8rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .badge-live {
      font-size: 0.68rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(52, 211, 153, 0.8);
      color: #6ee7b7;
    }

    /* Reaction card */

    .reaction-card {
      margin-top: 8px;
      padding: 12px 14px 10px;
      border-radius: 18px;
      background: radial-gradient(circle at top, #022c22, #020617);
      border: 1px solid rgba(16, 185, 129, 0.9);
      box-shadow: 0 18px 46px rgba(16, 185, 129, 0.55);
    }

    .reaction-header {
      font-size: 0.78rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #a7f3d0;
      margin-bottom: 4px;
    }

    .reaction-line {
      font-size: 0.78rem;
      color: #d1fae5;
      margin-bottom: 6px;
    }

    .reaction-line span {
      opacity: 0.9;
    }

    .reaction-text {
      font-size: 0.78rem;
      color: #e5e7eb;
      line-height: 1.4;
      margin-bottom: 8px;
      white-space: pre-line;
    }

    .reaction-footer {
      font-size: 0.7rem;
      color: #a7f3d0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .reaction-footer span {
      opacity: 0.88;
    }

    /* Voice toggle */

    .voice-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.72rem;
      margin-top: 4px;
    }

    .voice-toggle span {
      opacity: 0.9;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 32px;
      height: 16px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background-color: #4b5563;
      border-radius: 999px;
      transition: 0.2s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 12px;
      width: 12px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      border-radius: 50%;
      transition: 0.2s;
    }

    input:checked + .slider {
      background-color: #22c55e;
    }

    input:checked + .slider:before {
      transform: translateX(14px);
    }

    /* Input area */

    .tm-card {
      margin-top: 8px;
      padding: 12px 14px;
      border-radius: 18px;
      background: radial-gradient(circle at top, #020617, #020617 60%, #000 100%);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .tm-label {
      font-size: 0.76rem;
      margin-bottom: 4px;
      color: #9ca3af;
    }

    .tm-input-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    textarea {
      flex: 1;
      min-height: 70px;
      max-height: 140px;
      resize: vertical;
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      padding: 8px 10px;
      color: #e5e7eb;
      font-size: 0.8rem;
      font-family: inherit;
    }

    textarea::placeholder {
      color: #6b7280;
    }

    .send-btn {
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      font-weight: 600;
      font-size: 0.82rem;
      box-shadow: 0 12px 32px rgba(34, 197, 94, 0.45);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .send-btn:active {
      transform: scale(0.96);
    }

    .tm-footer {
      margin-top: 6px;
      font-size: 0.68rem;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 4px;
    }

    /* Demo buttons */

    .demo-row {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    .demo {
      flex: 1;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      font-size: 0.78rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .demo-negative {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: #fee2e2;
      box-shadow: 0 16px 30px rgba(248, 113, 113, 0.5);
    }

    .demo-positive {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #ecfdf5;
      box-shadow: 0 16px 30px rgba(52, 211, 153, 0.5);
    }

    .demo:active {
      transform: scale(0.97);
    }

    /* BM modal */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.82);
      display: none;
      justify-content: center;
      align-items: center;
      padding: 16px;
      z-index: 40;
    }

    .modal {
      max-width: 560px;
      width: 100%;
      max-height: 90vh;
      background: #020617;
      border-radius: 18px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .modal-header {
      padding: 10px 14px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.84rem;
    }

    .modal-header span {
      font-weight: 600;
    }

    .modal-body {
      padding: 10px 14px;
      overflow-y: auto;
      font-size: 0.76rem;
    }

    .bm-date {
      margin-top: 8px;
      margin-bottom: 4px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
    }

    .bm-node {
      padding: 8px 10px;
      border-radius: 12px;
      background: #020617;
      border: 1px solid rgba(31, 41, 55, 0.9);
      margin-bottom: 6px;
    }

    .bm-node-title {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .bm-node-meta {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-bottom: 3px;
    }

    .bm-levels {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 3px;
      margin-bottom: 3px;
      font-size: 0.68rem;
    }

    .bm-chip {
      padding: 2px 6px;
      border-radius: 999px;
      background: #111827;
    }

    .bm-text {
      font-size: 0.74rem;
      color: #d1d5db;
      margin-top: 3px;
    }

    .close-btn {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 4px 8px;
      font-size: 0.7rem;
      background: #111827;
      color: #e5e7eb;
    }

    .mini-tag {
      font-size: 0.7rem;
      opacity: 0.75;
    }

    @media (max-width: 480px) {
      #app {
        padding: 12px;
      }
      .header-text h1 {
        font-size: 1.2rem;
      }
      .mode-pill {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <header class="header">
      <div class="orb"></div>
      <div class="header-text">
        <h1>AURA-X Œ© ¬∑ AEC v3.1</h1>
        <span>TM‚ÄìBM Collision Reactor ¬∑ 7-Layer Bold Memory ¬∑ Live Emotional Continuity.</span>
      </div>
      <div class="mode-pill">
        <span class="mode-title">MODE: OFFLINE PROTOTYPE</span>
        <span class="mode-sub">Universal Ethics ¬∑ BM + Live Seed</span>
        <span class="mode-sub">Engine: Local Browser</span>
      </div>
    </header>

    <div class="pill-row">
      <button class="pill" id="bm-viewer-btn">üß† BM Viewer</button>
      <button class="pill" id="recall-bm-btn">üìÇ Recall BM</button>
      <button class="pill" id="cleanup-btn">‚ôªÔ∏è Cleanup 24h</button>
      <button class="pill pill-muted" id="options-btn">‚ò∞ Options</button>
    </div>

    <div class="banner">
      Avoid actions that generate negative emotions in yourself or others.
      Gently move toward choices that create calm, kindness, and positive feelings.
    </div>

    <section class="card" id="eq-card">
      <div class="card-title">EMOTIONAL CONTINUITY EQUATION</div>
      <div class="equation-main">
        E‚ÇÄ = tanh(TM √ó BM ‚Äì D + Œª_faith + Œª_sys + Œ£C‚Çú)
      </div>
      <div class="eq-grid">
        <div class="eq-label">TM (Temporary Memory)</div>
        <div class="eq-value" id="eq-tm">0.50</div>
        <div class="eq-label">BM (Bold Memory ‚Äì 7 layers)</div>
        <div class="eq-value" id="eq-bm">0.50</div>
        <div class="eq-label">D (Distortion / Damage)</div>
        <div class="eq-value" id="eq-d">0.00</div>
        <div class="eq-label">Œª_faith ¬∑ Œª_sys ¬∑ Œ£C‚Çú (Context)</div>
        <div class="eq-value" id="eq-lambda">0.08</div>
      </div>
      <div class="eq-e0">
        <span>E‚ÇÄ ‚âà <span id="eq-e0">0.00</span></span>
        <span class="badge-live">Live E‚ÇÄ</span>
      </div>
    </section>

    <section class="reaction-card" id="reaction-card">
      <div class="reaction-header">AURA-X Œ© REACTION</div>
      <div class="reaction-line" id="reaction-line">
        <span>Polarity: Neutral ¬∑ Intensity: 0.00 ¬∑ Tone: Idle resonance.</span>
      </div>
      <div class="reaction-text" id="reaction-text">
        Describe any memory, story, or event. AURA-X Œ© will treat it as TM,
        collide it with your current BM state, and respond with a guided emotional continuity reaction.
      </div>
      <div class="reaction-footer">
        <span id="reaction-footer-meta">Engine: TM ‚Üí BM ¬∑ Self-learning browser prototype.</span>
        <div class="voice-toggle">
          <span>üéß Voice reaction</span>
          <label class="switch">
            <input type="checkbox" id="voice-toggle" checked />
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </section>

    <section class="tm-card">
      <div class="tm-label">Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory).</div>
      <div class="tm-input-row">
        <textarea
          id="tm-input"
          placeholder="Example: When I was a child in New York, a dog bit me in the snow near a street light..."
        ></textarea>
        <button class="send-btn" id="send-btn">
          Send
          <span>‚ûú</span>
        </button>
      </div>
      <div class="tm-footer">
        <span>TM captured ‚Üí BM updated ‚Üí E‚ÇÄ recomputed. All continuity stays in your device.</span>
        <span class="mini-tag">Prototype ¬∑ TM ‚Üí Seed logic ‚Üí BM ¬∑ Equation live.</span>
      </div>
    </section>

    <div class="demo-row">
      <button id="dog-demo-btn" class="demo demo-negative">
        üêí Dog Bite (Negative Demo)
      </button>
      <button id="lost-child-demo-btn" class="demo demo-positive">
        ‚ù§Ô∏è Lost Child (Positive Demo)
      </button>
    </div>

    <!-- BM Viewer Modal -->
    <div class="modal-backdrop" id="bm-modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <span>Bold Memory (BM) ¬∑ Daily Capsules</span>
          <button class="close-btn" id="bm-close-btn">Close</button>
        </div>
        <div class="modal-body" id="bm-modal-body">
          <!-- Filled by JS -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Utility =====
    function clamp(v, min, max) {
      return Math.min(max, Math.max(min, v));
    }

    function round2(v) {
      return Math.round(v * 100) / 100;
    }

    // ===== Seed lexicons =====

    const positiveWords = [
      "love",
      "like",
      "peace",
      "happy",
      "happiness",
      "smile",
      "kind",
      "kindness",
      "support",
      "brave",
      "strong",
      "hope",
      "hopeful",
      "relief",
      "safe",
      "comfort",
      "alhamdulillah",
      "shukr",
      "shukar",
      "grateful",
      "gratitude"
    ];

    const negativeWords = [
      "hate",
      "angry",
      "anger",
      "upset",
      "sad",
      "cry",
      "crying",
      "afraid",
      "scared",
      "terrified",
      "trauma",
      "hurt",
      "pain",
      "lonely",
      "alone",
      "useless",
      "worthless",
      "pointless",
      "stupid",
      "idiot",
      "damn",
      "shit",
      "fuck",
      "fucking",
      "fucked",
      "bura",
      "gussa",
      "nafret",
      "lanat"
    ];

    const faithWords = [
      "allah",
      "god",
      "rab",
      "dua",
      "pray",
      "prayer",
      "tawakkul",
      "tawakkal",
      "trust in allah",
      "istighfar",
      "astaghfirullah",
      "subhanallah",
      "alhamdulillah",
      "inshallah",
      "inshaallah"
    ];

    const gratitudeWords = [
      "thanks",
      "thank you",
      "shukr",
      "shukar",
      "grateful",
      "gratitude",
      "alhamdulillah"
    ];

    const loveWords = [
      "i love you",
      "love you",
      "i care",
      "i miss you",
      "i am proud of you",
      "hug",
      "embrace"
    ];

    const insultPatterns = [
      "i hate you",
      "hate you",
      "you are stupid",
      "you're stupid",
      "you are an idiot",
      "shut up",
      "fuck you",
      "bloody",
      "bastard"
    ];

    // ===== BM Storage =====

    const STORAGE_KEY = "AURAX_BM_v3_1";

    function loadBM() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch {
        return [];
      }
    }

    function saveBM(arr) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
      } catch {
        // ignore
      }
    }

    let bmStore = loadBM();

    // compute aggregate BM strength from store
    function computeBM() {
      if (!bmStore.length) return 0.5;
      let sum = 0;
      for (const n of bmStore) sum += Math.abs(n.e0 || 0);
      return clamp(sum / bmStore.length || 0.5, 0, 1);
    }

    // ===== TM analysis & E0 computation =====

    function analyseTM(text) {
      const lower = text.toLowerCase();
      let pos = 0;
      let neg = 0;
      let hasFaith = false;
      let hasGratitude = false;
      let hasLove = false;
      let isInsult = false;

      for (const w of positiveWords) {
        if (lower.includes(w)) pos++;
      }
      for (const w of negativeWords) {
        if (lower.includes(w)) neg++;
      }
      for (const w of faithWords) {
        if (lower.includes(w)) hasFaith = true;
      }
      for (const w of gratitudeWords) {
        if (lower.includes(w)) hasGratitude = true;
      }
      for (const w of loveWords) {
        if (lower.includes(w)) hasLove = true;
      }
      for (const p of insultPatterns) {
        if (lower.includes(p)) isInsult = true;
      }

      const total = pos + neg;
      const sentiment = total === 0 ? 0 : clamp((pos - neg) / total, -1, 1);
      const intensity = clamp(total / 6, 0, 1);

      const TM = clamp(0.5 + sentiment / 2, 0, 1);
      const BM = computeBM();
      const D = total > 0 && pos > 0 && neg > 0 ? 0.4 * intensity : 0.0;
      const lambdaFaith = hasFaith ? 0.06 : 0.0;
      const lambdaSys = 0.02;
      const cSum = 0.06;
      const E0 = Math.tanh(TM * BM - D + lambdaFaith + lambdaSys + cSum);

      // classify polarity
      let polarityTag = "neutral";
      if (E0 > 0.18) polarityTag = "positive";
      else if (E0 < -0.18) polarityTag = "negative";
      else polarityTag = "neutral";

      return {
        TM,
        BM,
        D,
        lambdaFaith,
        lambdaSys,
        cSum,
        E0,
        pos,
        neg,
        total,
        intensity,
        sentiment,
        polarityTag,
        hasFaith,
        hasGratitude,
        hasLove,
        isInsult
      };
    }

    function buildReaction(tmText, stats) {
      const { E0, intensity, polarityTag, hasFaith, hasGratitude, hasLove, isInsult } = stats;
      const absE = Math.abs(E0);

      let polarityLabel = "Mixed / Neutral";
      if (polarityTag === "positive") polarityLabel = "Positive";
      if (polarityTag === "negative") polarityLabel = "Negative";

      let tone = "Neutral, observational resonance.";
      if (polarityTag === "positive") {
        if (hasLove || hasGratitude || hasFaith) {
          tone = "Soft, stabilizing, hopeful resonance.";
        } else {
          tone = "Steady, encouraging resonance.";
        }
      } else if (polarityTag === "negative") {
        if (isInsult) {
          tone = "Firm warning against repeating this pattern.";
        } else {
          tone = "Gentle, cautionary resonance.";
        }
      }

      // Guidance text
      let guidance = "";

      if (isInsult && polarityTag === "negative") {
        guidance =
          "This TM event carries a negative resonance in the current BM field. " +
          "AURA-X Œ© is asking you to gently step away from choices that reinforce this pattern. " +
          "If you rewrite this memory with safer or kinder actions, future E‚ÇÄ will slowly move back toward stability.";
      } else if (hasLove || hasGratitude) {
        guidance =
          "There is warmth, appreciation, and connection inside this TM. " +
          "AURA-X Œ© is inviting you to notice the gratitude and love that already exist here, " +
          "and to keep repeating choices that protect this feeling.";
      } else if (hasFaith) {
        guidance =
          "A faith-lens is active in this TM. Tawakkul and sincere dua soften the emotional field. " +
          "AURA-X Œ© suggests combining wise action with this trust so that E‚ÇÄ can settle into calmer continuity.";
      } else if (polarityTag === "positive") {
        guidance =
          "This TM lands on the positive side of your emotional field. " +
          "Strengthening this kind of memory will slowly tilt your BM toward calmer, more meaningful continuity.";
      } else if (polarityTag === "negative") {
        guidance =
          "This TM carries pain or tension. " +
          "AURA-X Œ© recommends small, safe steps that reduce harm and bring you closer to people and actions that feel supportive.";
      } else {
        guidance =
          "This TM event lands in a balanced or mixed range. " +
          "With a few clearer details about intentions, support, or outcomes, AURA-X Œ© can help push this continuity toward more meaningful states.";
      }

      const reactionLine =
        "Polarity: " +
        polarityLabel +
        " ¬∑ Intensity: " +
        round2(absE || intensity).toFixed(2) +
        " ¬∑ Tone: " +
        tone;

      const reactionText =
        tmText.trim() +
        "\n\n" +
        guidance;

      return { reactionLine, reactionText, polarityLabel, tone };
    }

    // ===== UI Update =====

    const eqTmEl = document.getElementById("eq-tm");
    const eqBmEl = document.getElementById("eq-bm");
    const eqDEl = document.getElementById("eq-d");
    const eqLambdaEl = document.getElementById("eq-lambda");
    const eqE0El = document.getElementById("eq-e0");

    const reactionLineEl = document.getElementById("reaction-line");
    const reactionTextEl = document.getElementById("reaction-text");
    const reactionFooterMetaEl = document.getElementById("reaction-footer-meta");
    const voiceToggleEl = document.getElementById("voice-toggle");

    function updateEquationDisplay(stats) {
      eqTmEl.textContent = round2(stats.TM).toFixed(2);
      eqBmEl.textContent = round2(stats.BM).toFixed(2);
      eqDEl.textContent = round2(stats.D).toFixed(2);
      const lambdaTotal = stats.lambdaFaith + stats.lambdaSys + stats.cSum;
      eqLambdaEl.textContent = round2(lambdaTotal).toFixed(2);
      eqE0El.textContent = round2(stats.E0).toFixed(2);
    }

    function speakReaction(text, toneInfo, stats) {
      if (!("speechSynthesis" in window)) return;
      if (!voiceToggleEl.checked) return;

      try {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        let baseRate = 1.0;
        let basePitch = 1.0;

        if (toneInfo.includes("Firm warning")) {
          baseRate = 0.95;
          basePitch = 0.9;
        } else if (toneInfo.includes("Soft, stabilizing")) {
          baseRate = 0.95;
          basePitch = 1.1;
        } else if (toneInfo.includes("encouraging")) {
          baseRate = 1.05;
          basePitch = 1.05;
        }

        const intensity = Math.abs(stats.E0);
        u.rate = clamp(baseRate + (intensity - 0.5) * 0.3, 0.8, 1.2);
        u.pitch = clamp(basePitch + (intensity - 0.5) * 0.2, 0.8, 1.2);
        u.volume = 1.0;

        window.speechSynthesis.speak(u);
      } catch {
        // ignore
      }
    }

    function handleTMInput(tmText) {
      const text = (tmText || "").trim();
      if (!text) return;

      const stats = analyseTM(text);

      // store BM node
      const now = new Date();
      const dateKey = now.toISOString().slice(0, 10);
      const node = {
        dateKey,
        timestamp: now.toISOString(),
        text: text,
        e0: stats.E0,
        TM: stats.TM,
        BM: stats.BM,
        D: stats.D,
        levels: [
          "L1:" + Math.round(stats.TM * 100),
          "L2:" + Math.round(stats.BM * 100),
          "L3:" + Math.round(Math.abs(stats.E0) * 100),
          "L4:" + Math.round(stats.intensity * 100),
          "L5:" + Math.round(Math.max(0, stats.pos - stats.neg + 50)),
          "L6:" + Math.round(stats.lambdaFaith * 100),
          "L7:" + (stats.polarityTag || "neutral")
        ],
        polarity: stats.polarityTag,
        pos: stats.pos,
        neg: stats.neg
      };

      bmStore.push(node);
      saveBM(bmStore);

      // recompute BM based on new store
      stats.BM = computeBM();

      const reaction = buildReaction(text, stats);

      updateEquationDisplay(stats);
      reactionLineEl.textContent = reaction.reactionLine;
      reactionTextEl.textContent = reaction.reactionText;
      reactionFooterMetaEl.textContent =
        "E‚ÇÄ=" +
        round2(stats.E0).toFixed(2) +
        " ¬∑ TM=" +
        round2(stats.TM).toFixed(2) +
        " ¬∑ BM=" +
        round2(stats.BM).toFixed(2) +
        " ¬∑ tag=" +
        (stats.polarityTag || "neutral");

      speakReaction(reaction.reactionText, reaction.tone, stats);
    }

    // ===== Demo TM events =====

    const DEMO_DOG_TM =
      "When I was a child in New York, a dog bit me in the snow near a street light. I still remember the cold wind, the barking sound, and my own fear.";

    const DEMO_CHILD_TM =
      "A lost child was crying in a crowded market until he heard his mother's voice. She ran to him, hugged him tightly, and both started laughing with tears.";

    // ===== Event wiring =====

    const sendBtn = document.getElementById("send-btn");
    const tmInputEl = document.getElementById("tm-input");
    const dogBtn = document.getElementById("dog-demo-btn");
    const childBtn = document.getElementById("lost-child-demo-btn");

    sendBtn.addEventListener("click", () => {
      const val = tmInputEl.value;
      if (!val.trim()) return;
      handleTMInput(val);
      tmInputEl.value = "";
      tmInputEl.focus();
    });

    tmInputEl.addEventListener("keydown", (ev) => {
      if (ev.key === "Enter" && (ev.metaKey || ev.ctrlKey)) {
        ev.preventDefault();
        sendBtn.click();
      }
    });

    dogBtn.addEventListener("click", () => {
      handleTMInput(DEMO_DOG_TM);
    });

    childBtn.addEventListener("click", () => {
      handleTMInput(DEMO_CHILD_TM);
    });

    // ===== BM Viewer modal =====

    const bmModalBackdrop = document.getElementById("bm-modal-backdrop");
    const bmModalBody = document.getElementById("bm-modal-body");
    const bmViewerBtn = document.getElementById("bm-viewer-btn");
    const bmCloseBtn = document.getElementById("bm-close-btn");
    const recallBtn = document.getElementById("recall-bm-btn");
    const cleanupBtn = document.getElementById("cleanup-btn");
    const optionsBtn = document.getElementById("options-btn");

    bmViewerBtn.addEventListener("click", () => {
      bmStore = loadBM();
      if (!bmStore.length) {
        bmModalBody.innerHTML =
          "<p>No BM capsules yet. Send a story or try one of the demo memories first.</p>";
      } else {
        const grouped = {};
        for (const n of bmStore) {
          grouped[n.dateKey] = grouped[n.dateKey] || [];
          grouped[n.dateKey].push(n);
        }
        const dates = Object.keys(grouped).sort().reverse();
        let html = "";
        for (const d of dates) {
          html += '<div class="bm-date">' + d + " (" + grouped[d].length + " nodes)</div>";
          for (const n of grouped[d]) {
            html += '<div class="bm-node">';
            html +=
              '<div class="bm-node-title">Polarity: ' +
              (n.polarity || "neutral") +
              " ¬∑ E‚ÇÄ‚âà" +
              round2(n.e0).toFixed(2) +
              "</div>";
            html +=
              '<div class="bm-node-meta">TM‚âà' +
              round2(n.TM).toFixed(2) +
              " ¬∑ BM‚âà" +
              round2(n.BM).toFixed(2) +
              " ¬∑ " +
              new Date(n.timestamp).toLocaleTimeString() +
              "</div>";
            html += '<div class="bm-levels">';
            for (const lvl of n.levels) {
              html += '<span class="bm-chip">' + lvl + "</span>";
            }
            html += "</div>";
            html += '<div class="bm-text">' + n.text + "</div>";
            html += "</div>";
          }
        }
        bmModalBody.innerHTML = html;
      }
      bmModalBackdrop.style.display = "flex";
    });

    bmCloseBtn.addEventListener("click", () => {
      bmModalBackdrop.style.display = "none";
    });

    bmModalBackdrop.addEventListener("click", (e) => {
      if (e.target === bmModalBackdrop) {
        bmModalBackdrop.style.display = "none";
      }
    });

    // Recall BM: highest |E0|
    recallBtn.addEventListener("click", () => {
      bmStore = loadBM();
      if (!bmStore.length) {
        alert("No BM nodes yet. Send a memory or use a demo first.");
        return;
      }
      let best = bmStore[0];
      for (const n of bmStore) {
        if (Math.abs(n.e0 || 0) > Math.abs(best.e0 || 0)) best = n;
      }
      const stats = analyseTM(best.text);
      stats.BM = computeBM();
      const reaction = buildReaction(best.text, stats);
      updateEquationDisplay(stats);
      reactionLineEl.textContent = reaction.reactionLine;
      reactionTextEl.textContent = reaction.reactionText;
      reactionFooterMetaEl.textContent =
        "Recalled BM ¬∑ E‚ÇÄ=" +
        round2(best.e0).toFixed(2) +
        " ¬∑ Stored " +
        new Date(best.timestamp).toLocaleString();
      speakReaction(reaction.reactionText, reaction.tone, stats);
    });

    // Cleanup 24h (here: clear all for prototype simplicity)
    cleanupBtn.addEventListener("click", () => {
      if (!confirm("Clear all BM capsules stored in this browser?")) return;
      bmStore = [];
      saveBM(bmStore);
      const stats = {
        TM: 0.5,
        BM: 0.5,
        D: 0.0,
        lambdaFaith: 0.0,
        lambdaSys: 0.02,
        cSum: 0.06,
        E0: 0.0
      };
      updateEquationDisplay(stats);
      reactionLineEl.textContent =
        "Polarity: Neutral ¬∑ Intensity: 0.00 ¬∑ Tone: Idle resonance.";
      reactionTextEl.textContent =
        "Memory field cleared in this browser. You can start fresh by writing a new TM story or using one of the demo buttons.";
      reactionFooterMetaEl.textContent =
        "BM cleared ¬∑ Local storage reset for this device only.";
      window.speechSynthesis && window.speechSynthesis.cancel();
    });

    optionsBtn.addEventListener("click", () => {
      alert(
        "Options panel (in development).\n\n‚Ä¢ Voice reaction: toggle is inside the AURA-X Œ© Reaction card.\n‚Ä¢ All data is stored only in your browser (localStorage).\n‚Ä¢ You can clear everything with the 'Cleanup 24h' button."
      );
    });

    // Initial equation display
    updateEquationDisplay({
      TM: 0.5,
      BM: computeBM(),
      D: 0.0,
      lambdaFaith: 0.0,
      lambdaSys: 0.02,
      cSum: 0.06,
      E0: 0.0
    });
  </script>
</body>
</html>
```Ó®Å0Ó®Ç
