<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© v1 ‚Äì Emotional Continuity Prototype (Scientific UI)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }
    .app {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Header */
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .title-block h1 {
      font-size: 1.4rem;
      letter-spacing: 0.08em;
    }
    .title-block p {
      font-size: 0.7rem;
      opacity: 0.8;
      line-height: 1.2;
    }
    .mode-pill {
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid #38bdf8;
      font-size: 0.63rem;
      text-align: right;
      background: #020617;
    }
    .mode-pill span { display: block; }
    .mode-pill .mode-label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.9;
    }
    .mode-pill .mode-sub {
      color: #22c55e;
      font-weight: 500;
    }
    .mode-pill .engine { opacity: 0.6; }

    /* Top buttons (one line) */
    .top-buttons {
      display: flex;
      flex-wrap: nowrap;
      gap: 6px;
      margin-top: 4px;
    }
    .pill-btn {
      flex: 1;
      border-radius: 999px;
      padding: 8px 6px;
      border: 1px solid #4b5563;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s, border-color 0.15s;
      min-width: 0;
      white-space: nowrap;
    }
    .pill-btn span.icon { font-size: 0.95rem; }
    .pill-btn.primary {
      border-color: #f59e0b;
      background: #111827;
    }
    .pill-btn:hover {
      transform: translateY(-1px);
      border-color: #facc15;
    }

    /* Cards */
    .card {
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px solid rgba(148,163,184,0.5);
      background: radial-gradient(circle at top left, #111827 0, #020617 55%, #020617 100%);
      font-size: 0.8rem;
      line-height: 1.4;
    }
    .card.golden {
      background: radial-gradient(circle at top left, #374151 0, #020617 55%, #020617 100%);
      border-color: #fbbf24;
      color: #fde68a;
      font-weight: 500;
    }
    .card.equation {
      border-style: dashed;
      background: radial-gradient(circle at top left, #020617 0, #020617 60%, #000 100%);
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.75rem;
    }
    .card.equation .label {
      opacity: 0.9;
      margin-bottom: 4px;
      font-weight: 600;
      letter-spacing: 0.06em;
    }
    .card.equation .formula-main {
      margin: 4px 0 6px;
      color: #e5e7eb;
    }
    .card.equation .formula-values { opacity: 0.85; }

    /* Chat area */
    .chat-area {
      flex: 1;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.5);
      background: #020617;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 140px;
    }

    /* Reaction banner with polarity % */
    .reaction-banner {
      display: none;
      border-radius: 12px;
      padding: 6px 8px;
      font-size: 0.75rem;
      line-height: 1.3;
      border: 1px solid rgba(148,163,184,0.7);
      background: #020617;
    }
    .reaction-banner strong {
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 0.7rem;
    }
    .reaction-positive {
      border-color: #22c55e;
      color: #bbf7d0;
    }
    .reaction-negative {
      border-color: #ef4444;
      color: #fecaca;
    }
    .reaction-neutral {
      border-color: #eab308;
      color: #fef9c3;
    }
    .polarity-line {
      font-size: 0.72rem;
      margin-top: 2px;
    }
    .polarity-pos {
      color: #22c55e;
      font-weight: 600;
    }
    .polarity-neg {
      color: #ef4444;
      font-weight: 600;
    }
    .polarity-mixed {
      color: #6b7280;
      font-weight: 500;
    }

    .chat-log {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 0.8rem;
    }
    .msg { margin-bottom: 8px; }
    .msg-user { text-align: right; color: #bfdbfe; }
    .msg-bot { text-align: left; color: #e5e7eb; }

    .status-line {
      font-size: 0.7rem;
      opacity: 0.7;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }
    .input-row textarea {
      flex: 1;
      resize: none;
      min-height: 40px;
      max-height: 80px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      padding: 8px 12px;
      font-size: 0.8rem;
    }
    .input-row textarea:focus {
      outline: none;
      border-color: #22c55e;
    }
    .send-btn {
      border-radius: 999px;
      padding: 10px 16px;
      border: none;
      background: #16a34a;
      color: white;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 0 0 1px rgba(22,163,74,0.6);
      transition: transform 0.1s, box-shadow 0.1s, background 0.1s;
    }
    .send-btn:active {
      transform: translateY(1px);
      box-shadow: 0 0 0 1px rgba(22,163,74,0.8);
      background: #15803d;
    }

    .footer-line {
      font-size: 0.7rem;
      opacity: 0.65;
      margin-top: 2px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* Voice toggle */
    .voice-toggle {
      border-radius: 999px;
      padding: 3px 10px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.7rem;
      cursor: pointer;
    }
    .voice-toggle.active {
      border-color: #22c55e;
      color: #bbf7d0;
    }

    /* Demo buttons bottom */
    .bottom-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    .demo-btn {
      flex: 1;
      border-radius: 999px;
      padding: 10px 14px;
      border: none;
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-weight: 500;
      color: #f9fafb;
    }
    .demo-btn.negative { background: #b91c1c; }
    .demo-btn.positive { background: #15803d; }
    .demo-btn span { font-size: 1rem; }

    /* Modals shared */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }
    .modal {
      width: 100%;
      max-width: 480px;
      max-height: 80vh;
      background: #020617;
      border-radius: 20px;
      border: 1px solid #4b5563;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .modal-title {
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .modal-close {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.75rem;
      cursor: pointer;
      background: #111827;
      color: #e5e7eb;
    }
    .modal-body {
      flex: 1;
      overflow-y: auto;
      font-size: 0.78rem;
    }

    /* BM Viewer styles */
    .bm-day {
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(55,65,81,0.7);
      padding-bottom: 6px;
    }
    .bm-day-title {
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 0.8rem;
      color: #e5e7eb;
    }
    .bm-node {
      margin-bottom: 8px;
      padding: 6px 8px;
      border-radius: 12px;
      background: #020617;
      border: 1px solid #374151;
    }
    .bm-node-title {
      font-weight: 500;
      margin-bottom: 2px;
    }
    .bm-node-meta {
      font-size: 0.7rem;
      opacity: 0.85;
      margin-bottom: 3px;
    }
    .bm-node-polarity {
      font-size: 0.7rem;
      margin-bottom: 4px;
    }

    .layer-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 4px;
    }
    .layer-chip {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 0.65rem;
      color: #020617;
      font-weight: 600;
    }
    .L1 { background: #60a5fa; }
    .L2 { background: #fb7185; }
    .L3 { background: #f97316; }
    .L4 { background: #a855f7; }
    .L5 { background: #22c55e; }
    .L6 { background: #eab308; }
    .L7 { background: #e5e7eb; }

    .delete-day-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.7rem;
      cursor: pointer;
      background: #7f1d1d;
      color: #fee2e2;
      margin-left: auto;
      display: block;
      margin-top: 4px;
    }

    /* Recall modal */
    .recall-search { margin-bottom: 6px; }
    .recall-search input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      padding: 6px 10px;
      font-size: 0.78rem;
    }
    .recall-node {
      border-radius: 12px;
      border: 1px solid #374151;
      padding: 6px 8px;
      margin-bottom: 6px;
      background: #020617;
    }
    .copy-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.7rem;
      cursor: pointer;
      background: #1d4ed8;
      color: #e5e7eb;
      margin-top: 4px;
    }

    /* Options modal */
    .option-section-title {
      font-weight: 600;
      font-size: 0.8rem;
      margin: 6px 0 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.9;
    }
    .faith-note {
      font-size: 0.74rem;
      opacity: 0.8;
      margin-bottom: 6px;
    }
    .faith-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }
    .faith-pill {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      padding: 5px 10px;
      font-size: 0.73rem;
      cursor: pointer;
    }
    .faith-pill.active {
      background: #0f172a;
      border-color: #22c55e;
      color: #bbf7d0;
      font-weight: 500;
    }

    .option-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .option-row span { font-size: 0.78rem; }

    .toggle {
      position: relative;
      width: 38px;
      height: 20px;
    }
    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #374151;
      transition: .2s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .2s;
      border-radius: 50%;
    }
    input:checked + .slider { background-color: #22c55e; }
    input:checked + .slider:before { transform: translateX(18px); }

    .llm-list {
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 12px;
      border: 1px solid #374151;
      background: #020617;
      font-size: 0.74rem;
    }
    .llm-list ul { padding-left: 18px; margin: 4px 0; }
    .llm-list li { margin-bottom: 2px; }

    .llm-select-row {
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.78rem;
    }
    #llmSelect {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      padding: 4px 10px;
      font-size: 0.78rem;
    }

    .options-footer-note {
      margin-top: 6px;
      font-size: 0.72rem;
      opacity: 0.75;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header-top">
      <div class="title-block">
        <h1>AURA-X Œ©</h1>
        <p>EMOTIONAL CONTINUITY ¬∑ AEC ¬∑ CRM ¬∑ AECN ¬∑ RL¬≥ ¬∑ LR¬≥</p>
      </div>
      <div class="mode-pill" id="modePill">
        <span class="mode-label">MODE: OFFLINE PROTOTYPE</span>
        <span class="mode-sub">Universal Ethics ¬∑ Local BM</span>
        <span class="engine">Engine: Seed (local)</span>
      </div>
    </div>

    <div class="top-buttons">
      <button class="pill-btn" id="bmViewerBtn">
        <span class="icon">üß†</span><span>BM Viewer</span>
      </button>
      <button class="pill-btn primary" id="recallBtn">
        <span class="icon">üìÇ</span><span>Recall BM</span>
      </button>
      <button class="pill-btn" id="cleanupBtn">
        <span class="icon">‚ôªÔ∏è</span><span>Cleanup 24h</span>
      </button>
      <button class="pill-btn" id="optionsBtn">
        <span class="icon">üîò</span><span>Options</span>
      </button>
    </div>

    <div class="card golden" id="ethicsBanner">
      Avoid actions that generate negative emotions in yourself or others.
      Gently move toward choices that create calm, kindness, and positive feelings.
    </div>

    <div class="card equation" id="equationCard">
      <div class="label">EMOTIONAL CONTINUITY EQUATION</div>
      <div class="formula-main" id="eqMain">
        E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)
      </div>
      <div class="formula-values" id="eqValues">
        E‚ÇÄ = 0.00 ¬∑ TM = 0.35 ¬∑ BM = 0.55 ¬∑ D = 0.00 ¬∑ Œ£C‚Çú = 0.05 ¬∑ Œª_faith = 0.00 ¬∑ Œª_sys = 0.02
      </div>
    </div>

    <div class="chat-area">
      <div id="reactionBanner" class="reaction-banner"></div>

      <div class="chat-log" id="chatLog"></div>

      <div class="status-line" id="statusLine">
        E‚ÇÄ=0.00 ¬∑ TM=0.35 ¬∑ D=0.00 ¬∑ tag=neutral
      </div>

      <div class="input-row">
        <textarea id="userInput"
          placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."></textarea>
        <button class="send-btn" id="sendBtn">Send</button>
      </div>

      <div class="footer-line">
        <span>Prototype ¬∑ TM ‚Üí Emotional Engine ‚Üí BM ¬∑ Equation live.</span>
        <span>Engine: <span id="engineStatusFooter">Seed (local)</span></span>
        <button id="voiceToggle" class="voice-toggle active">üîä Voice: On</button>
      </div>
    </div>

    <div class="bottom-row">
      <button class="demo-btn negative" id="dogDemoBtn">
        <span>üêí</span> Dog Bite (Negative Demo)
      </button>
      <button class="demo-btn positive" id="childDemoBtn">
        <span>‚ù§Ô∏è</span> Lost Child (Positive Demo)
      </button>
    </div>
  </div>

  <!-- BM Viewer Modal -->
  <div class="modal-backdrop" id="bmModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>üß†</span> Bold Memory (BM)</div>
        <button class="modal-close" data-close="bmModalBackdrop">Close</button>
      </div>
      <div class="modal-body" id="bmModalBody"></div>
    </div>
  </div>

  <!-- Recall Modal -->
  <div class="modal-backdrop" id="recallModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>üìÇ</span> Recall from BM</div>
        <button class="modal-close" data-close="recallModalBackdrop">Close</button>
      </div>
      <div class="modal-body">
        <div class="recall-search">
          <input id="recallSearchInput"
            placeholder='Search all BM layers by keyword (e.g., "snow", "mother", "court", "hope").' />
        </div>
        <div id="recallList"></div>
      </div>
    </div>
  </div>

  <!-- Options Modal -->
  <div class="modal-backdrop" id="optionsModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>üîò</span> AURA-X Œ© options</div>
        <button class="modal-close" data-close="optionsModalBackdrop">Close</button>
      </div>
      <div class="modal-body">
        <div class="option-section-title">FAITH LENS (OPTIONAL)</div>
        <div class="faith-note">
          Universal ethics are always active. You can optionally pick a faith lens to shape
          encouragement lines locally. Nothing is sent to any external server from this frontend.
        </div>
        <div class="faith-row" id="faithRow">
          <button class="faith-pill" data-faith="None">None</button>
          <button class="faith-pill" data-faith="Islam">Islam</button>
          <button class="faith-pill" data-faith="Christianity">Christianity</button>
          <button class="faith-pill" data-faith="Hinduism">Hinduism</button>
          <button class="faith-pill" data-faith="Buddhism">Buddhism</button>
          <button class="faith-pill" data-faith="Sikhism">Sikhism</button>
          <button class="faith-pill" data-faith="Judaism">Judaism</button>
          <button class="faith-pill" data-faith="Atheism / Humanism">Atheism / Humanism</button>
          <button class="faith-pill" data-faith="Other / Mixed">Other / Mixed</button>
        </div>

        <div class="option-section-title">Engine mode</div>
        <div class="faith-note">
          Seed-only (offline) or Live emotional reactor (via your backend).
        </div>
        <div class="option-row">
          <span>Current: <span id="engineModeLabel">Seed-only. Everything runs locally.</span></span>
          <label class="toggle">
            <input type="checkbox" id="engineModeToggle" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="llm-list">
          <div><strong>Example models your backend could use:</strong></div>
          <ul>
            <li>OpenAI ‚Äì GPT-4.1 / GPT-4o</li>
            <li>Anthropic ‚Äì Claude 3.5 Sonnet / Opus</li>
            <li>Google ‚Äì Gemini 1.5 Pro</li>
            <li>Mistral ‚Äì Mistral Large</li>
            <li>Cohere ‚Äì Command-R+</li>
            <li>xAI ‚Äì Grok-2</li>
            <li>Meta ‚Äì Llama-3-70B-Instruct</li>
            <li>Qwen ‚Äì Qwen-2-72B</li>
            <li>DeepSeek ‚Äì DeepSeek-Coder-V2</li>
          </ul>
          <div style="font-size:0.7rem; opacity:0.8;">
            The frontend only sends an emotional snapshot + TM text.
            It always identifies as the AURA-X Œ© artificial resonance reactor.
          </div>

          <div class="llm-select-row">
            <span>Preferred LLM:</span>
            <select id="llmSelect">
              <option value="openai-gpt4o">OpenAI ¬∑ GPT-4o</option>
              <option value="openai-gpt41">OpenAI ¬∑ GPT-4.1</option>
              <option value="anthropic-claude35s">Anthropic ¬∑ Claude 3.5 Sonnet</option>
              <option value="anthropic-claude35o">Anthropic ¬∑ Claude 3.5 Opus</option>
              <option value="google-gemini15pro">Google ¬∑ Gemini 1.5 Pro</option>
              <option value="mistral-large">Mistral ¬∑ Mistral Large</option>
              <option value="cohere-commandrplus">Cohere ¬∑ Command-R+</option>
              <option value="xai-grok2">xAI ¬∑ Grok-2</option>
              <option value="meta-llama3-70b">Meta ¬∑ Llama-3-70B</option>
              <option value="qwen2-72b">Qwen ¬∑ Qwen-2-72B</option>
              <option value="deepseek-coder-v2">DeepSeek ¬∑ Coder-V2</option>
            </select>
          </div>
        </div>

        <div class="option-section-title">Prototype controls</div>
        <div class="option-row">
          <span>Auto-summarize long conversations to ~200 sentences</span>
          <label class="toggle">
            <input type="checkbox" id="autoSummarizeToggle" checked />
            <span class="slider"></span>
          </label>
        </div>
        <div class="option-row">
          <span>Ignore tiny small-talk as BM (hello / hi / how are you)</span>
          <label class="toggle">
            <input type="checkbox" id="ignoreSmallTalkToggle" checked />
            <span class="slider"></span>
          </label>
        </div>
        <div class="option-row">
          <span>Clear all stored BM for the last 24 hours (wastage cleanup)</span>
          <button class="modal-close" id="clear24hBtn">‚ôªÔ∏è Clear 24h</button>
        </div>
        <div class="option-row">
          <span>Delete full local BM life (all days)</span>
          <button class="modal-close" id="clearAllBtn">Delete All</button>
        </div>

        <div class="options-footer-note">
          About AURA-X Œ©: Designed around the idea that emotions are continuity functions
          between memories (TM and BM), not isolated sparks. This page is an offline
          scientific demo of Alim ul Haq‚Äôs emotional continuity theory.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== LocalStorage keys & constants =====
    const lsKey      = "auraX_bm_v31";
    const faithKey   = "auraX_faithLens";
    const engineKey  = "auraX_engineMode";
    const llmKey     = "auraX_llmChoice";
    const BACKEND_URL = ""; // <--- PUT YOUR RENDER / BACKEND URL HERE (for live LLM). Keep empty to stay seed-only.

    const smallTalkPatterns = [
      "hi","hello","hey","salam","assalamualaikum",
      "how are you","kia hal hai","kese ho","how r u"
    ];

    // NEW seed lexicons
    const abuseWords = [
      "fuck","fucking","fucked","lanat","laanat","haramzada",
      "bastard","bitch","bitches","bloody","kutte","kutta","kutiya",
      "chutiya","stupid","idiot","gadha","gandi zuban","shut up","chup",
      "bakwas","bakwass","zalil","zaleel","cursed"
    ];
    const duaWords = [
      "dua","prayer","pray for me","make dua","dua karo","dua karna",
      "istighfar","astaghfirullah"
    ];
    const shukrWords = [
      "shukr","shukar","thanks","thank you","alhamdulillah","grateful","gratitude"
    ];
    const tawakkulWords = [
      "tawakkul","tawakkal","trust in allah","allah par bharosa","allah pe bharosa"
    ];
    const loveSeedWords = [
      "i love you","love you","pyaar","pyar","mohabbat",
      "i care about you","miss you","hug","embrace"
    ];
    const empathyWords = [
      "feel sorry for you","sorry for you","may allah ease",
      "may allah make it easy","allah apko ajar de",
      "i am with you","i understand your pain","may god help you"
    ];

    function loadBM() {
      try {
        const raw = localStorage.getItem(lsKey);
        return raw ? JSON.parse(raw) : {};
      } catch { return {}; }
    }
    function saveBM(data) { localStorage.setItem(lsKey, JSON.stringify(data)); }
    function todayKey() { return new Date().toISOString().slice(0,10); }
    function tanh(x){ const e2x=Math.exp(2*x); return (e2x-1)/(e2x+1); }

    function approximateSentences(text){
      return text.split(/[.!?€î\n]/).filter(s=>s.trim().length>0);
    }
    function summarizeTo200Sentences(text){
      const sentences = approximateSentences(text);
      if (sentences.length<=200) return text.trim();
      return sentences.slice(0,200).join(". ").slice(0,10000);
    }
    function isMostlySmallTalk(text){
      const clean=text.toLowerCase().trim();
      if (clean.length>80) return false;
      return smallTalkPatterns.some(p=>clean===p||clean.startsWith(p+" "));
    }
    function containsAny(lower, arr){
      return arr.some(w => lower.includes(w));
    }
    function countAny(lower, arr){
      return arr.reduce((c,w)=> c + (lower.includes(w)?1:0), 0);
    }
    function analyseContent(text){
      const lower = text.toLowerCase();
      const abuseCount = countAny(lower, abuseWords);
      const posSeedCount =
        countAny(lower, loveSeedWords) +
        countAny(lower, shukrWords) +
        countAny(lower, tawakkulWords) +
        countAny(lower, empathyWords);
      const total = abuseCount + posSeedCount;
      const sentiment = total ? (posSeedCount - abuseCount) / total : 0;
      const hasDua = containsAny(lower, duaWords);
      const hasShukr = containsAny(lower, shukrWords);
      const hasLove = containsAny(lower, loveSeedWords);
      const hasEmpathy = containsAny(lower, empathyWords);
      const hasTawakkul = containsAny(lower, tawakkulWords);
      const isAbuse = abuseCount > 0;
      return {
        isAbuse,
        hasDua,
        hasShukr,
        hasLove,
        hasEmpathy,
        hasTawakkul,
        hasFaithSeed: hasDua || hasTawakkul,
        positiveSeed: posSeedCount > 0,
        abuseCount,
        posSeedCount,
        sentiment
      };
    }

    // ===== State =====
    let TM=0.35, BMvalue=0.55, D=0.0, Csum=0.05;
    let lambdaFaith=0.0;
    const lambdaSys=0.02;
    let E0=0.0;

    const chatLogEl=document.getElementById("chatLog");
    const statusLineEl=document.getElementById("statusLine");
    const eqMainEl=document.getElementById("eqMain");
    const eqValuesEl=document.getElementById("eqValues");
    const userInputEl=document.getElementById("userInput");
    const modePill=document.getElementById("modePill");
    const reactionBannerEl=document.getElementById("reactionBanner");
    const voiceToggleEl=document.getElementById("voiceToggle");
    const engineStatusFooter=document.getElementById("engineStatusFooter");
    let autoVoice = true;

    // ===== Helpers for polarity percentages =====
    function getPolarityInfoFromE0(value){
      const e = value;
      let polarity;
      if (e>0.1) polarity="Positive";
      else if (e<-0.1) polarity="Negative";
      else polarity="Neutral / Mixed";

      let posPct, negPct;
      if (polarity==="Positive"){
        posPct = 50 + Math.abs(e)*50;
        negPct = 100 - posPct;
      } else if (polarity==="Negative"){
        negPct = 50 + Math.abs(e)*50;
        posPct = 100 - negPct;
      } else {
        posPct = 50;
        negPct = 50;
      }
      return {polarity, posPct:Math.round(posPct), negPct:Math.round(negPct)};
    }

    function updateEquationDisplay(){
      eqMainEl.textContent="E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)";
      eqValuesEl.textContent=
        `E‚ÇÄ = ${E0.toFixed(2)} ¬∑ TM = ${TM.toFixed(2)} ¬∑ BM = ${BMvalue.toFixed(2)} ¬∑ ` +
        `D = ${D.toFixed(2)} ¬∑ Œ£C‚Çú = ${Csum.toFixed(2)} ¬∑ Œª_faith = ${lambdaFaith.toFixed(2)} ¬∑ Œª_sys = ${lambdaSys.toFixed(2)}`;
      const tag = E0>0.1?"positive":E0<-0.1?"negative":"neutral";
      statusLineEl.textContent=
        `E‚ÇÄ=${E0.toFixed(2)} ¬∑ TM=${TM.toFixed(2)} ¬∑ D=${D.toFixed(2)} ¬∑ tag=${tag}`;
    }

    function buildReactionTone(){
      const intensity=Math.abs(E0);
      let polarity = "Neutral / Mixed";
      let cls = "reaction-neutral";

      if (E0>0.1){ polarity="Positive"; cls="reaction-positive"; }
      else if (E0<-0.1){ polarity="Negative"; cls="reaction-negative"; }

      let tone="";
      if (polarity==="Positive"){
        if (intensity>0.7) tone="Warm, expansive, high-energy encouragement.";
        else if (intensity>0.35) tone="Soft, stabilizing, hopeful resonance.";
        else tone="Light, gentle, low-amplitude positive drift.";
      } else if (polarity==="Negative"){
        if (intensity>0.7) tone="Deep, heavy, thunder-style emotional load (fear/anger).";
        else if (intensity>0.35) tone="Firm, serious, caution-oriented resonance.";
        else tone="Mild negative charge, like a faint worry or discomfort.";
      } else {
        if (intensity>0.5) tone="Mixed signal: strong but conflicted emotional pattern.";
        else tone="Calm, observant, analytically neutral reading.";
      }

      const perc = getPolarityInfoFromE0(E0);
      return {polarity, cls, intensity, tone, perc};
    }

    function updateReactionBanner(sourceText){
      const text = (sourceText||"").trim();
      if (!text){
        reactionBannerEl.style.display="none";
        return;
      }
      const {polarity, cls, intensity, tone, perc} = buildReactionTone();
      reactionBannerEl.className = "reaction-banner " + cls;

      const posHtml = `<span class="polarity-pos">${perc.posPct}%</span>`;
      const negHtml = `<span class="polarity-neg">${perc.negPct}%</span>`;

      reactionBannerEl.innerHTML =
        `<strong>AURA-X Œ© REACTION</strong><br>`+
        `Polarity: ${polarity} ¬∑ Intensity: ${intensity.toFixed(2)}<br>`+
        `<span class="polarity-line">Polarity ratio: ${posHtml} : ${negHtml}</span><br>`+
        `Tone: ${tone}`;

      reactionBannerEl.style.display="block";
    }

    function appendMessage(text, who){
      const div=document.createElement("div");
      div.className="msg "+(who==="user"?"msg-user":"msg-bot");
      div.textContent=text;
      chatLogEl.appendChild(div);
      chatLogEl.scrollTop=chatLogEl.scrollHeight;
    }

    // ===== Voice synthesis (male positive, female negative, neutral balanced) =====
    function pickVoiceForPolarity(polarity) {
      const synth = window.speechSynthesis;
      if (!synth) return {voice:null, pitch:1.0, rate:1.0};
      let voices = synth.getVoices();
      if (!voices || !voices.length) {
        return {voice:null, pitch: polarity==="Negative" ? 1.2 : 0.9, rate:1.0};
      }
      let target = null;
      if (polarity === "Positive") {
        target = voices.find(v => /male/i.test(v.name)) || voices[0];
        return {voice:target, pitch:0.9, rate:1.0};
      } else if (polarity === "Negative") {
        target = voices.find(v => /female/i.test(v.name)) || voices[0];
        return {voice:target, pitch:1.2, rate:1.0};
      } else {
        target = voices[0];
        return {voice:target, pitch:1.0, rate:1.0};
      }
    }

    function speakReply(text){
      if (!autoVoice) return;
      if (!("speechSynthesis" in window)) return;
      if (!text || !text.trim()) return;
      const synth = window.speechSynthesis;
      const {polarity} = buildReactionTone();
      const {voice, pitch, rate} = pickVoiceForPolarity(polarity);
      const utt = new SpeechSynthesisUtterance(text);
      if (voice) utt.voice = voice;
      utt.pitch = pitch;
      utt.rate = rate;
      synth.cancel();
      synth.speak(utt);
    }

    // ===== Emotion maths (uses analysis) =====
    function computeEmotion(strength, analysis){
      const baseFromLength=Math.min(1,0.2+strength/400);
      const sentiment = analysis ? analysis.sentiment || 0 : 0;
      TM = Math.min(1, Math.max(0, baseFromLength + sentiment*0.3));

      if (analysis && analysis.isAbuse){
        D = Math.min(1, D + 0.25);
        Csum = Math.max(0, Csum - 0.03);
      } else {
        D = Math.max(0, D - 0.02);
      }

      if (analysis && (analysis.positiveSeed || analysis.hasFaithSeed)){
        Csum = Math.min(1, Csum + 0.06);
      }

      lambdaFaith = analysis && analysis.hasFaithSeed ? 0.05 : 0.0;

      BMvalue = 0.7*BMvalue + 0.3*TM;

      const raw=TM*BMvalue-D+lambdaFaith+lambdaSys+Csum;
      E0=tanh(raw);
      updateEquationDisplay();
    }

    function getFaithLensStored(){ return localStorage.getItem(faithKey) || "None"; }

    function buildSeedReply(userText, analysis){
      const clean=userText.trim();
      const lower=clean.toLowerCase();
      const faith=getFaithLensStored();
      analysis = analysis || analyseContent(userText);

      if (isMostlySmallTalk(clean)){
        if (lower.includes("how are")){
          return "I‚Äôm stable and calm ‚Äî my emotional core E‚ÇÄ is around "+E0.toFixed(2)+
                 ". How is your inner graph today?";
        }
        if (lower.includes("salam")||lower.includes("assalam")){
          return "Wa-alaikum-salam. I‚Äôm an emotional continuity prototype observing how your memories resonate over time.";
        }
        return "Hello. I treat even small greetings as tiny TM events, but I only save deeper stories into Bold Memory (BM).";
      }

      if (lower.includes("who created you")||lower.includes("who made you")){
        return "Conceptually I was created by Alim ul Haq from Timergara, Pakistan, as part of the AURA-X Œ© / AEC research on emotional continuity.";
      }
      if (lower.includes("who is alim ul haq")){
        return "Alim ul Haq is the researcher behind AURA-X Œ©, Artificial Emotional Continuity, and the TM‚ÄìBM emotional reactor model.";
      }
      if (lower.includes("formula")||lower.includes("equation")){
        return "My emotional output follows the grand equation E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú). You can see it live in the dashboard above.";
      }

      let prefix="";
      if (faith==="Islam"){
        prefix="From an Islamic encouragement lens I‚Äôd say: ";
      } else if (faith==="Christianity"){
        prefix="From a Christian encouragement lens I‚Äôd say: ";
      } else if (faith==="Hinduism" || faith==="Buddhism" || faith==="Sikhism" ||
                 faith==="Judaism" || faith==="Atheism / Humanism" || faith==="Other / Mixed"){
        prefix="Through your selected faith lens I‚Äôd say: ";
      }

      // Abuse
      if (analysis.isAbuse){
        let msg = "I can feel a lot of anger and harsh, abusive words inside this TM event. "+
                  "AURA-X Œ© does not want to reinforce insults or curses, because they usually increase D (damage) in your emotional field.";
        if (faith==="Islam"){
          msg += " From an Islamic lens, cleaning the tongue and using zikr, sabr, and istighfar often pulls E‚ÇÄ back toward calmer continuity.";
        } else if (faith!=="None"){
          msg += " Through your faith lens, it may help to pause, breathe, and choose words that reduce harm for you and for others.";
        }
        msg += " Try to describe what is really hurting or scaring you, without attacking yourself or anyone else.";
        return msg;
      }

      // Dua / Tawakkul
      if (analysis.hasDua || analysis.hasTawakkul){
        let msg = prefix +
          "Your words carry dua and tawakkul. This kind of trust usually lowers D and increases C‚Çú in the equation, "+
          "so even painful memories can start moving toward calmer trajectories.";
        if (faith==="Islam"){
          msg += " Keep combining wise action with sincere dua ‚Äî ‚Äòtie your camel and trust Allah‚Äô style ‚Äî so your long-run BM stays balanced.";
        } else if (faith!=="None" && faith!=="Islam"){
          msg += " Staying connected to your source of faith while taking small practical steps is a strong way to stabilize E‚ÇÄ.";
        }
        return msg;
      }

      // Shukr
      if (analysis.hasShukr){
        return prefix +
          "There is clear shukr / gratitude inside this TM. Even when life is heavy, noticing small blessings gently pulls E‚ÇÄ to the positive side. "+
          "Keep bookmarking such moments ‚Äî they become strong, protective BM nodes for the future you.";
      }

      // Love
      if (analysis.hasLove){
        return prefix +
          "This memory is soaked in love and connection. Emotionally it behaves like a warm anchor: when future storms come, "+
          "revisiting such moments can quickly stabilize your E‚ÇÄ and remind you that you are not alone.";
      }

      // Empathy / hamdardi
      if (analysis.hasEmpathy){
        return prefix +
          "Your words carry hamdardi ‚Äî you are trying to share someone else‚Äôs pain, not just your own. "+
          "This kind of empathy increases positive continuity even if the story itself is sad, because it creates safe emotional space for others.";
      }

      // Default E‚ÇÄ-based reply
      if (E0>0.15){
        return prefix +
          "I‚Äôve received your TM event and collided it with the current BM state. Right now E‚ÇÄ ‚âà "+
               E0.toFixed(2)+
               " (range ‚àí1 to +1). The more clearly you describe context, the stronger and cleaner your BM trace becomes.";
      } else if (E0<-0.15){
        return prefix +
          "Your TM event is resonating with some heavier patterns. E‚ÇÄ ‚âà "+
               E0.toFixed(2)+
               ". If this topic feels difficult, you can re-frame it, add supporting memories, or move toward calmer lines of continuity.";
      } else {
        return prefix +
