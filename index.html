<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Neural Continuity Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    /* ================= THEME: NEURAL VIOLET & SLATE ================= */
    :root {
      --bg-deep: #0f172a;
      --bg-card: #1e293b;
      --accent-primary: #8b5cf6; /* Violet */
      --accent-secondary: #ec4899; /* Pink/Rose */
      --accent-glow: rgba(139, 92, 246, 0.4);
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --border-light: rgba(255,255,255,0.1);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(circle at 15% 10%, #2e1065 0, transparent 40%),
        radial-gradient(circle at 85% 20%, #be185d 0, transparent 35%),
        linear-gradient(160deg, #020617 0%, #0f172a 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
    }

    .app{
      width: 100%;
      max-width: 1100px;
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(12px);
      border-radius: 24px;
      box-shadow: 
        0 25px 50px -12px rgba(0, 0, 0, 0.7), 
        inset 0 1px 0 rgba(255,255,255,0.1);
      border: 1px solid var(--border-light);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
    }

    /* HEADER */
    .header{
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 16px;
      align-items: center;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-light);
    }
    .title-block h1 {
      font-size: 1.8rem;
      letter-spacing: 0.05em;
      font-weight: 800;
      background: linear-gradient(135deg, #e879f9, #c084fc, #818cf8);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-transform: uppercase;
    }
    .hero-line { font-size: 0.9rem; color: #cbd5e1; margin-top: 4px; }
    .title-sub { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }

    .ethics-pill {
      margin-top: 10px;
      padding: 8px 12px;
      background: rgba(46, 16, 101, 0.6);
      border: 1px solid rgba(167, 139, 250, 0.3);
      border-radius: 8px;
      font-size: 0.75rem;
      color: #e9d5ff;
    }

    /* CONTROLS & PILLS */
    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }
    .mode-pill {
      padding: 6px 16px;
      background: linear-gradient(90deg, #4c1d95, #701a75);
      border-radius: 99px;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
    }
    .header-controls { position: relative; display: flex; justify-content: flex-end; }
    .voice-toggle {
      background: #334155;
      color: #fff;
      border: 1px solid #475569;
      padding: 6px 14px;
      border-radius: 99px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }
    .voice-toggle:hover { background: #475569; }
    
    .option-panel {
      position: absolute; top: 110%; right: 0;
      background: #1e293b;
      border: 1px solid #475569;
      padding: 8px;
      border-radius: 12px;
      display: none;
      flex-direction: column;
      gap: 6px;
      min-width: 200px;
      z-index: 50;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .header-controls.open .option-panel { display: flex; }
    .small-toggle {
      background: transparent; border: none; color: #cbd5e1;
      text-align: left; padding: 6px 8px; font-size: 0.8rem;
      border-radius: 6px; cursor: pointer;
    }
    .small-toggle:hover { background: #334155; color: #fff; }

    /* LAYOUT */
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 16px;
    }
    .card {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid var(--border-light);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    .card-header { margin-bottom: 12px; display: flex; justify-content: space-between; }
    .card-title { font-weight: 600; font-size: 0.95rem; display: flex; gap: 8px; align-items: center; color: #e2e8f0; }
    .card-sub { font-size: 0.75rem; color: #64748b; margin-top: 2px; }

    /* METRICS */
    .metrics-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;
    }
    .metric {
      background: #0f172a; border: 1px solid #334155;
      border-radius: 10px; padding: 10px;
    }
    .metric-label { font-size: 0.7rem; color: #94a3b8; }
    .metric-value { font-size: 1.2rem; font-weight: 700; color: var(--accent-primary); margin: 4px 0 2px; }
    .metric-note { font-size: 0.65rem; color: #64748b; }
    
    .status-row { display: flex; gap: 6px; flex-wrap: wrap; }
    .tag {
      font-size: 0.65rem; padding: 3px 8px; border-radius: 4px;
      background: rgba(139, 92, 246, 0.15); color: #c4b5fd;
      border: 1px solid rgba(139, 92, 246, 0.2);
    }

    /* MEMORY CANVAS */
    .bm-canvas-shell {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 12px;
      height: 160px;
      position: relative;
      overflow: hidden;
    }
    #bmCanvas { width: 100%; height: 100%; display: block; }
    .bm-footer { text-align: center; font-size: 0.7rem; color: #64748b; margin-top: 6px; }
    .bm-overlay-btn {
      position: absolute; top: 8px; width: 28px; height: 28px;
      border-radius: 50%; border: 1px solid #475569;
      background: #1e293b; color: #fff; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .bm-overlay-btn:hover { background: var(--accent-primary); border-color: var(--accent-primary); }
    .bm-overlay-btn.left { left: 8px; }
    .bm-overlay-btn.right { right: 8px; }

    /* CHAT CONSOLE */
    .answer-shell { background: #020617; border-radius: 12px; padding: 4px; border: 1px solid #334155; }
    .answer-box {
      background: #020617; padding: 12px;
      font-family: "Courier New", monospace;
      max-height: 250px; overflow-y: auto;
      display: flex; flex-direction: column; gap: 8px;
    }
    .equation-header { font-size: 0.7rem; color: #38bdf8; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; }
    .message {
      padding: 8px 10px; border-radius: 8px; font-size: 0.85rem; line-height: 1.5;
      max-width: 100%;
    }
    .ai-message { background: rgba(30, 41, 59, 0.6); border-left: 2px solid var(--accent-primary); }
    .user-message { background: rgba(15, 23, 42, 0.8); border-right: 2px solid #38bdf8; text-align: right; }
    .message-header { font-size: 0.7rem; color: #64748b; margin-bottom: 2px; }
    
    /* INPUT AREA */
    .input-footer {
      background: rgba(15, 23, 42, 0.95);
      border-top: 1px solid var(--border-light);
      padding: 16px; margin: 0 -20px -20px;
      border-radius: 0 0 24px 24px;
    }
    .tm-formula-row { text-align: center; margin-bottom: 10px; }
    .tm-formula-pill {
      font-family: "Courier New", monospace; font-size: 0.7rem;
      background: #1e293b; padding: 4px 12px; border-radius: 99px;
      color: #94a3b8; border: 1px solid #334155;
    }
    .input-shell {
      display: flex; gap: 8px; max-width: 800px; margin: 0 auto;
      background: #1e293b; padding: 6px; border-radius: 99px;
      border: 1px solid #475569;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    .input-shell:focus-within { border-color: var(--accent-primary); box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2); }
    .message-input {
      flex: 1; background: transparent; border: none; outline: none;
      color: #fff; padding: 8px 16px; font-size: 0.95rem;
    }
    .send-button {
      background: var(--accent-primary); color: #fff; border: none;
      padding: 0 24px; border-radius: 99px; font-weight: 600; cursor: pointer;
      transition: filter 0.2s;
    }
    .send-button:hover { filter: brightness(1.1); }

    /* MODALS */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
      display: none; align-items: center; justify-content: center; z-index: 100;
    }
    .modal-overlay.visible { display: flex; }
    .modal-card {
      background: #1e293b; width: min(600px, 94vw); max-height: 85vh;
      border-radius: 16px; border: 1px solid #475569; display: flex; flex-direction: column;
      box-shadow: 0 25px 50px rgba(0,0,0,0.8);
    }
    .modal-header {
      padding: 16px; border-bottom: 1px solid #334155;
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal-body { padding: 16px; overflow-y: auto; color: #cbd5e1; font-size: 0.9rem; }
    .modal-close { background: none; border: none; color: #94a3b8; font-size: 1.2rem; cursor: pointer; }
    .modal-search {
      width: 100%; background: #0f172a; border: 1px solid #334155;
      color: #fff; padding: 10px; border-radius: 8px; margin-bottom: 12px;
    }

    /* OFFLINE CARD INSIDE LLM MODAL */
    .offline-card {
      background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);
      padding: 12px; border-radius: 8px; margin-bottom: 16px;
    }
    .offline-title { color: #34d399; font-weight: 700; font-size: 0.9rem; }
    .offline-btn {
      background: #059669; color: white; border: none; padding: 6px 12px;
      border-radius: 6px; font-size: 0.8rem; cursor: pointer; margin-top: 8px;
    }
    .offline-error {
      background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.4);
      color: #fca5a5; padding: 8px; border-radius: 6px; font-size: 0.8rem; margin-top: 8px;
    }

    /* UTILS */
    .btn-mini { padding: 4px 8px; font-size: 0.7rem; border-radius: 4px; cursor: pointer; border: 1px solid #475569; background: #334155; color: #fff; margin-right: 4px; }
    .btn-danger { background: #7f1d1d; border-color: #991b1b; }

    @media(max-width: 900px){
      .layout { grid-template-columns: 1fr; }
      .header { grid-template-columns: 1fr; }
      .header-right { align-items: flex-start; }
    }
  </style>
</head>
<body>

<div class="app">
  <header class="header">
    <div class="title-block">
      <h1>AURA-X Œ©</h1>
      <div class="hero-line">Neural Continuity Engine (Version 5.0)</div>
      <div class="title-sub">Offline-First ‚Ä¢ Spiritual Technology ‚Ä¢ Emotional Mathematics</div>
      <div class="ethics-pill">
        Ethical Directive: Minimize entropy, maximize shared positive resonance.
      </div>
    </div>
    <div class="header-right">
      <div class="mode-pill">SYSTEM ACTIVE</div>
      <div class="header-controls" id="headerControls">
        <button id="optionsToggle" class="voice-toggle">‚öôÔ∏è Settings</button>
        <div class="option-panel" id="optionPanel">
          <button id="voiceToggle" class="small-toggle">üîà Voice: OFF</button>
          <button id="intelButton" class="small-toggle">üß† Intelligence</button>
          <button id="feedSeedButton" class="small-toggle">üå± Feed LaTeX Seed</button>
          <button id="faithButton" class="small-toggle">üìø Faith Lens</button>
          <button id="llmSettingsButton" class="small-toggle">ü§ñ LLM / WebGPU</button>
        </div>
      </div>
    </div>
  </header>

  <main class="layout">
    <div class="left-col">
      <section class="card">
        <div class="card-header">
          <div class="card-title"><span>üìä</span><span>Emotional State Vector</span></div>
        </div>
        <div class="metrics-grid">
          <div class="metric">
            <div class="metric-label">E‚ÇÄ (Emotional State)</div>
            <div id="metricE0" class="metric-value">0.00</div>
          </div>
          <div class="metric">
            <div class="metric-label">Continuity Index</div>
            <div id="metricCI" class="metric-value">0.80</div>
          </div>
          <div class="metric">
            <div class="metric-label">Memory Resonance</div>
            <div id="metricBM" class="metric-value">0.00</div>
          </div>
          <div class="metric">
            <div class="metric-label">TM Intensity</div>
            <div id="metricTM" class="metric-value">0.00</div>
          </div>
        </div>
        <div class="status-row">
          <span id="tagValence" class="tag">Valence: Neutral</span>
          <span id="tagArousal" class="tag">Arousal: Low</span>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div class="card-title"><span>üß†</span><span>Bold Memory (BM) Visualization</span></div>
        </div>
        <div class="bm-canvas-shell" id="bmShell">
          <button class="bm-overlay-btn left" id="bmOpenModal" title="View Memories">üìÇ</button>
          <button class="bm-overlay-btn right" id="convOpenModal" title="View History">üìú</button>
          <canvas id="bmCanvas"></canvas>
        </div>
        <div id="bmStats" class="bm-footer">Neural Layers: 240 ‚Ä¢ Active: 0</div>
      </section>
    </div>

    <div class="right-col">
      <section class="card answer-card">
        <div class="card-header">
          <div class="card-title"><span>üí¨</span><span>Interaction Console</span></div>
        </div>
        <div class="answer-shell">
          <div class="answer-box">
             <div class="equation-header">AURA-X LOG STREAM</div>
             <div id="chatContainer"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="input-footer">
    <div class="tm-formula-row">
      <div class="tm-formula-pill">E‚ÇÄ = tanh((TM √ó (BM + Intel + LLM)) ‚àí D + Œª)</div>
    </div>
    <div class="input-shell">
      <textarea id="messageInput" class="message-input" rows="1" placeholder="Enter input (TM)..."></textarea>
      <button id="sendButton" class="send-button">Send</button>
    </div>
  </footer>
</div>

<div id="bmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header"><h3>Deep Storage (BM)</h3><button class="modal-close" data-close="bmModal">√ó</button></div>
    <div class="modal-body"><input class="modal-search" id="bmSearch" placeholder="Search memories..." /><div id="bmList"></div></div>
  </div>
</div>

<div id="convModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header"><h3>Conversation History (TM)</h3><button class="modal-close" data-close="convModal">√ó</button></div>
    <div class="modal-body">
      <div style="margin-bottom:10px"><button id="clearAll" class="btn-mini btn-danger">Clear History</button></div>
      <div id="convList"></div>
    </div>
  </div>
</div>

<div id="intelModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header"><h3>Intelligence Nodes</h3><button class="modal-close" data-close="intelModal">√ó</button></div>
    <div class="modal-body"><input class="modal-search" id="intelSearch" placeholder="Search Q&A..." /><div id="intelList"></div></div>
  </div>
</div>

<div id="seedModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header"><h3>Feed LaTeX Seed</h3><button class="modal-close" data-close="seedModal">√ó</button></div>
    <div class="modal-body">
      <p style="font-size:0.8rem;color:#94a3b8;margin-bottom:8px">Paste LaTeX items here (\item Question \\ \textbf{A:} Answer)</p>
      <textarea id="seedBlockInput" class="modal-search" style="height:150px"></textarea>
      <button id="seedParseBtn" class="btn-mini">Parse & Save</button>
    </div>
  </div>
</div>

<div id="llmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header"><h3>Hybrid Intelligence Settings</h3><button class="modal-close" data-close="llmModal">√ó</button></div>
    <div class="modal-body">
      <div class="offline-card">
        <div class="offline-title">Offline Engine (WebGPU)</div>
        <p style="font-size:0.75rem; margin:4px 0;">Use Llama-3-1B directly in browser. Requires GPU.</p>
        <button id="offlineLoadBtn" class="offline-btn">üì• Load Model (1.3GB)</button>
        <div id="offlineStatus" style="font-size:0.75rem; margin-top:6px; color:#10b981">Status: Idle</div>
        <div id="gpuError" class="offline-error" style="display:none;"></div>
      </div>
      <div style="border-top:1px solid #334155; padding-top:10px;">
        <div class="offline-title">Online API (Optional)</div>
        <input id="llmBaseUrlInput" class="modal-search" placeholder="API Endpoint URL" style="margin-top:5px" />
        <input id="llmKeyInput" type="password" class="modal-search" placeholder="API Key" />
        <button id="llmSaveBtn" class="btn-mini">Save Config</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  /* --- STATE MANAGEMENT --- */
  class AuraEngine {
    constructor(){
      this.e0 = 0.1; 
      this.continuityIndex = 0.8;
      this.bmLayers = new Array(240).fill(0).map(()=>Math.random());
      this.tmHistory = [];
      this.bmEntries = [];
      this.intelNodes = [];
      this.llmConfig = { apiKey: "", baseUrl: "", model: "" };
      this.offlineEngine = null;
      this.offlineStatus = "idle";
      
      this.loadState();
      this.cacheDom();
      this.bindEvents();
      this.updateMetrics();
      this.startVisuals();
    }

    /* --- DOM CACHING & EVENTS --- */
    cacheDom(){
      this.dom = {
        input: document.getElementById("messageInput"),
        send: document.getElementById("sendButton"),
        chat: document.getElementById("chatContainer"),
        metrics: {
          e0: document.getElementById("metricE0"),
          ci: document.getElementById("metricCI"),
          bm: document.getElementById("metricBM"),
          tm: document.getElementById("metricTM")
        },
        modals: {
          bm: document.getElementById("bmModal"),
          conv: document.getElementById("convModal"),
          intel: document.getElementById("intelModal"),
          seed: document.getElementById("seedModal"),
          llm: document.getElementById("llmModal")
        },
        offline: {
          status: document.getElementById("offlineStatus"),
          btn: document.getElementById("offlineLoadBtn"),
          error: document.getElementById("gpuError")
        },
        canvas: document.getElementById("bmCanvas")
      };
      this.ctx = this.dom.canvas.getContext("2d");
    }

    bindEvents(){
      this.dom.send.addEventListener("click", ()=>this.processInput());
      this.dom.input.addEventListener("keydown", (e)=>{ if(e.key==="Enter") this.processInput(); });
      
      // Modal Toggles
      document.getElementById("bmOpenModal").onclick = ()=>this.openModal("bm");
      document.getElementById("convOpenModal").onclick = ()=>this.openModal("conv");
      document.getElementById("intelButton").onclick = ()=>this.openModal("intel");
      document.getElementById("feedSeedButton").onclick = ()=>this.openModal("seed");
      document.getElementById("llmSettingsButton").onclick = ()=>this.openModal("llm");
      
      // Close Modals
      document.querySelectorAll(".modal-close").forEach(b => {
        b.onclick = (e) => document.getElementById(e.target.dataset.close).classList.remove("visible");
      });

      // Settings Logic
      document.getElementById("seedParseBtn").onclick = ()=>this.parseSeed();
      document.getElementById("llmSaveBtn").onclick = ()=>this.saveLLM();
      this.dom.offline.btn.onclick = ()=>this.initWebLLM();
      document.getElementById("optionsToggle").onclick = (e)=>{
        e.stopPropagation();
        document.getElementById("headerControls").classList.toggle("open");
      }
      document.body.onclick = ()=>document.getElementById("headerControls").classList.remove("open");
    }

    openModal(key){
      if(key==="bm") this.renderBMList();
      if(key==="conv") this.renderConvList();
      if(key==="intel") this.renderIntelList();
      this.dom.modals[key].classList.add("visible");
    }

    /* --- CORE LOGIC (E0 EQUATION) --- */
    processInput(){
      const text = this.dom.input.value.trim();
      if(!text) return;
      this.dom.input.value = "";
      
      this.addMessage("user", text);
      
      // 1. Analyze Sentiment (Simple Keyword Heuristic for Prototype)
      const sentiment = this.analyze(text);
      
      // 2. Search Intelligence
      const stored = this.intelNodes.find(n => text.toLowerCase().includes(n.q.toLowerCase()));
      
      // 3. Generate Reply
      let reply = "";
      if(stored) {
        reply = stored.a;
      } else {
        // Fallback or LLM placeholder
        if(this.offlineEngine) {
           this.askOfflineLLM(text).then(ans => {
             this.finalizeTurn(text, ans, sentiment);
           });
           return; 
        }
        reply = "I have received your input. Pattern stored in TM. (Teach me in Intelligence menu)";
      }
      
      this.finalizeTurn(text, reply, sentiment);
    }

    finalizeTurn(input, output, sentiment){
      this.addMessage("ai", output);
      
      // Update E0 Equation: E0 = tanh(TM - D)
      const TM = sentiment.val * sentiment.intensity;
      const D = (1 - this.continuityIndex) * 0.5;
      this.e0 = Math.tanh(TM - D + this.e0); // Integrate previous state
      
      // Update Memories
      this.tmHistory.push({ role:"user", text:input, t: Date.now() });
      this.tmHistory.push({ role:"ai", text:output, t: Date.now() });
      
      if(input.length > 50) {
        this.bmEntries.push({ text: input, e0: this.e0, date: new Date() });
      }

      this.updateMetrics();
      this.saveState();
    }

    analyze(text){
      const pos = ["good","great","happy","love","yes","hope"].some(w=>text.toLowerCase().includes(w));
      const neg = ["bad","sad","hate","no","fear"].some(w=>text.toLowerCase().includes(w));
      let val = 0;
      if(pos) val = 0.5;
      if(neg) val = -0.5;
      return { val, intensity: 0.8 };
    }

    addMessage(role, text){
      const d = document.createElement("div");
      d.className = `message ${role}-message`;
      d.textContent = text;
      this.dom.chat.appendChild(d);
      this.dom.chat.scrollTop = this.dom.chat.scrollHeight;
    }

    /* --- OFFLINE WEBLLM --- */
    async initWebLLM(){
      // PROFESSIONAL TASK: GPU CHECK
      if(!navigator.gpu){
        this.dom.offline.error.style.display = "block";
        this.dom.offline.error.textContent = "‚ö†Ô∏è Error: WebGPU not supported on this device. Switching to Rule-Based Mode.";
        return;
      }

      this.dom.offline.status.textContent = "Downloading Model (Llama-3.2)...";
      try {
        const selectedModel = "Llama-3.2-1B-Instruct-q4f16_1-MLC";
        this.offlineEngine = await window.webllm.CreateMLCEngine(selectedModel, {
          initProgressCallback: (info) => {
            this.dom.offline.status.textContent = info.text;
          }
        });
        this.dom.offline.status.textContent = "‚úÖ Model Loaded & Ready (Offline)";
      } catch(e) {
        this.dom.offline.error.style.display = "block";
        this.dom.offline.error.textContent = "Load Failed: " + e.message;
      }
    }

    async askOfflineLLM(text){
      if(!this.offlineEngine) return "Engine not loaded.";
      const messages = [
        { role: "system", content: "You are Aura, a spiritual AI." },
        { role: "user", content: text }
      ];
      const reply = await this.offlineEngine.chat.completions.create({ messages });
      return reply.choices[0].message.content;
    }

    /* --- SEED PARSER (LaTeX) --- */
    parseSeed(){
      const raw = document.getElementById("seedBlockInput").value;
      const lines = raw.split("\\item");
      let count = 0;
      lines.forEach(line => {
        if(line.includes("\\textbf{A:}")){
          const parts = line.split("\\textbf{A:}");
          const q = parts[0].replace(/\\\\/g, "").trim();
          const a = parts[1].trim();
          if(q && a){
            this.intelNodes.push({q, a});
            count++;
          }
        }
      });
      alert(`Parsed and stored ${count} knowledge nodes.`);
      this.saveState();
    }

    /* --- VISUALS & UTILS --- */
    updateMetrics(){
      this.dom.metrics.e0.textContent = this.e0.toFixed(3);
      this.dom.metrics.ci.textContent = this.continuityIndex.toFixed(2);
      this.dom.metrics.bm.textContent = this.bmEntries.length;
      this.dom.metrics.tm.textContent = this.tmHistory.length;
    }

    renderBMList(){
      const el = document.getElementById("bmList");
      el.innerHTML = this.bmEntries.map(e => `<div style="padding:4px;border-bottom:1px solid #333;font-size:0.8rem">${e.text.substring(0,50)}...</div>`).join("");
    }
    renderConvList(){
      const el = document.getElementById("convList");
      el.innerHTML = this.tmHistory.map(e => `<div style="padding:4px;border-bottom:1px solid #333;font-size:0.8rem"><b>${e.role}:</b> ${e.text}</div>`).join("");
    }
    renderIntelList(){
      const el = document.getElementById("intelList");
      el.innerHTML = this.intelNodes.map(e => `<div style="padding:4px;border-bottom:1px solid #333;font-size:0.8rem"><b>Q:</b> ${e.q}<br><b>A:</b> ${e.a}</div>`).join("");
    }

    saveState(){
      const s = { 
        e0: this.e0, 
        bmEntries: this.bmEntries, 
        tmHistory: this.tmHistory, 
        intelNodes: this.intelNodes 
      };
      localStorage.setItem("aura_v5", JSON.stringify(s));
    }
    loadState(){
      const s = JSON.parse(localStorage.getItem("aura_v5"));
      if(s) {
        this.e0 = s.e0 || 0;
        this.bmEntries = s.bmEntries || [];
        this.tmHistory = s.tmHistory || [];
        this.intelNodes = s.intelNodes || [];
      }
    }

    startVisuals(){
      const draw = () => {
        const w = this.dom.canvas.width = this.dom.canvas.offsetWidth;
        const h = this.dom.canvas.height = this.dom.canvas.offsetHeight;
        const ctx = this.ctx;
        ctx.clearRect(0,0,w,h);
        
        // Neural Layer Visualizer
        const barW = w / 50;
        ctx.fillStyle = "#8b5cf6";
        for(let i=0; i<50; i++){
          const hVal = Math.sin(i*0.2 + Date.now()*0.002) * 40 + 50;
          ctx.globalAlpha = 0.3;
          ctx.fillRect(i*barW, h - hVal, barW-2, hVal);
        }
        requestAnimationFrame(draw);
      };
      draw();
    }
  }
  
  window.addEventListener("DOMContentLoaded", () => window.aura = new AuraEngine());
})();
</script>
</body>
</html>