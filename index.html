<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Offline LLM package (WebLLM, for in-browser models ‚Äì future ready) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root {
      --accent-soft: rgba(59,130,246,0.12);
      --accent-strong: #38bdf8;
      --accent-pill: linear-gradient(135deg,#0ea5e9,#6366f1);
      --bg-deep: #020617;
      --bg-card: rgba(15,23,42,0.96);
      --border-subtle: rgba(148,163,184,0.45);
      --text-soft: #e5e7eb;
      --pill-radius: 999px;
      --shadow-soft: 0 18px 55px rgba(15,23,42,0.85);
    }
    body{
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0f172a 0, transparent 55%),
        radial-gradient(circle at 50% 100%, #1e293b 0, transparent 55%);
      background-color:#020617;
      color:#e5e7eb;
      min-height:100vh;
      padding:12px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .app-shell{
      width:100%;
      max-width:880px;
      background:radial-gradient(circle at 0% 0%,rgba(56,189,248,0.06) 0,transparent 45%),
                 radial-gradient(circle at 100% 0%,rgba(129,140,248,0.09) 0,transparent 50%),
                 rgba(15,23,42,0.96);
      border-radius:24px;
      border:1px solid rgba(148,163,184,0.65);
      box-shadow:var(--shadow-soft);
      overflow:hidden;
    }
    .app-inner{
      padding:14px 14px 10px;
    }
    .header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .orb{
      width:46px;height:46px;border-radius:20px;
      background:conic-gradient(from 210deg,#0ea5e9,#6366f1,#f97316,#22c55e,#0ea5e9);
      padding:2px;
      box-shadow:0 0 25px rgba(56,189,248,0.45);
      display:flex;align-items:center;justify-content:center;
    }
    .orb-inner{
      width:100%;height:100%;border-radius:18px;
      background:radial-gradient(circle at 30% 0%,rgba(248,250,252,0.9) 0,rgba(15,23,42,0.95) 55%);
      display:flex;align-items:center;justify-content:center;
      color:#0f172a;font-weight:700;font-size:22px;
    }
    .hdr-main{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .hdr-title-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .hdr-title{
      font-weight:700;
      letter-spacing:0.14em;
      text-transform:uppercase;
      font-size:13px;
    }
    .hdr-pill{
      font-size:10px;
      padding:3px 9px;
      border-radius:var(--pill-radius);
      border:1px solid rgba(129,140,248,0.7);
      background:rgba(15,23,42,0.85);
      text-transform:uppercase;
      letter-spacing:0.14em;
    }
    .hdr-sub{
      font-size:11px;
      opacity:.8;
      line-height:1.4;
    }
    .meter-row{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:6px;
    }
    .chip{
      font-size:10px;
      padding:3px 9px;
      border-radius:var(--pill-radius);
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.85);
      display:flex;
      align-items:center;
      gap:4px;
    }
    .chip-label{opacity:.72}
    .chip-value{
      padding:0 6px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.75);
      font-variant-numeric:tabular-nums;
    }
    .status-pill{
      align-self:flex-start;
      font-size:10px;
      padding:4px 10px;
      border-radius:var(--pill-radius);
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(22,163,74,0.8);
      color:#bbf7d0;
      display:flex;
      align-items:center;
      gap:6px;
      box-shadow:0 0 12px rgba(34,197,94,0.45);
    }
    .status-dot{
      width:8px;height:8px;border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 10px rgba(34,197,94,0.8);
    }

    .sections{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:4px;
    }
    .card{
      border-radius:18px;
      background:linear-gradient(to bottom,rgba(15,23,42,0.96),rgba(15,23,42,0.96));
      border:1px solid var(--border-subtle);
      padding:10px 10px 9px;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
      gap:8px;
    }
    .card-title{
      font-size:11px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      opacity:.82;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .card-title span.emoji{
      font-size:13px;
    }
    .card-subtitle{
      font-size:10px;
      opacity:.7;
    }
    .card-link{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.16em;
      opacity:.78;
      cursor:pointer;
    }
    .card-link:hover{text-decoration:underline}

    .pill-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .pill{
      border-radius:999px;
      padding:4px 10px;
      border:1px solid rgba(148,163,184,0.7);
      font-size:11px;
      background:rgba(15,23,42,0.9);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .pill-label{opacity:.78}
    .pill-badge{
      padding:2px 6px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.8);
      font-variant-numeric:tabular-nums;
    }

    .identity-text{
      font-size:12px;
      line-height:1.6;
      margin-bottom:8px;
    }
    .identity-meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:11px;
    }

    .bm-empty{
      font-size:12px;
      opacity:.75;
      padding:4px 0 2px;
    }

    .history-text{
      font-size:12px;
      opacity:.8;
    }

    .engine-grid{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .engine-col{
      flex:1 1 160px;
      font-size:11px;
      padding:8px 9px;
      border-radius:14px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.55);
      line-height:1.5;
    }
    .engine-col h4{
      font-size:11px;
      letter-spacing:0.16em;
      text-transform:uppercase;
      margin-bottom:4px;
      opacity:.85;
    }
    .engine-number{
      font-variant-numeric:tabular-nums;
      font-size:12px;
      margin-top:2px;
    }

    .bottom-bar{
      margin-top:10px;
      padding-top:8px;
      border-top:1px solid rgba(30,64,175,0.5);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .bottom-meta{
      font-size:10px;
      opacity:.75;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .bottom-meta span.badge{
      padding:3px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.92);
    }

    .button-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:6px;
      margin-top:2px;
    }
    .btn-main{
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.75);
      background:rgba(15,23,42,0.96);
      padding:6px 4px;
      font-size:11px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:3px;
      cursor:pointer;
      text-align:center;
      min-height:42px;
    }
    .btn-main span.icon{font-size:15px}
    .btn-main span.label{font-size:11px}
    .btn-main:hover{
      border-color:rgba(129,140,248,0.9);
      box-shadow:0 0 0 1px rgba(129,140,248,0.45);
    }

    .input-card{
      border-radius:16px;
      background:rgba(15,23,42,0.98);
      border:1px solid var(--border-subtle);
      padding:8px 9px 8px;
      margin-top:4px;
    }
    .input-meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
      font-size:10px;
      opacity:.78;
    }
    .input-area-wrap{
      position:relative;
    }
    textarea{
      width:100%;
      min-height:76px;
      resize:vertical;
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.98);
      color:#e5e7eb;
      padding:8px 9px 30px;
      font-size:12px;
      line-height:1.5;
      outline:none;
    }
    textarea::placeholder{opacity:.5}
    .send-row{
      position:absolute;
      right:4px;
      bottom:4px;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .send-btn{
      border-radius:var(--pill-radius);
      border:none;
      padding:6px 14px;
      font-size:12px;
      background:var(--accent-pill);
      color:#0f172a;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      box-shadow:0 12px 30px rgba(56,189,248,0.55);
    }
    .send-btn:disabled{
      opacity:.5;
      box-shadow:none;
      cursor:not-allowed;
    }

    .footer-meters{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
      font-size:10px;
    }
    .footer-meter{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.75);
      background:rgba(15,23,42,0.96);
      display:flex;
      align-items:center;
      gap:4px;
    }

    .sub-pill{
      font-size:10px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      background:rgba(15,23,42,0.95);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .modal-backdrop{
      position:fixed;inset:0;
      background:rgba(15,23,42,0.85);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:40;
      padding:0 10px 10px;
    }
    .modal{
      width:100%;
      max-width:780px;
      background:rgba(15,23,42,0.98);
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.7);
      box-shadow:0 18px 60px rgba(15,23,42,0.95);
      padding:10px 11px 10px;
      max-height:80vh;
      overflow:auto;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
      gap:8px;
    }
    .modal-title{
      font-size:11px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      opacity:.85;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .modal-close{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.96);
      padding:4px 10px;
      font-size:11px;
      cursor:pointer;
    }
    .modal-body{font-size:12px}
    .modal-body p{margin-bottom:4px;opacity:.85}

    .field-label{
      font-size:11px;
      margin-top:6px;
      margin-bottom:2px;
      opacity:.8;
    }
    .field-input, .field-select{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.98);
      color:#e5e7eb;
      padding:6px 8px;
      font-size:12px;
    }
    .field-input:focus, .field-select:focus{
      outline:none;
      border-color:rgba(129,140,248,0.9);
      box-shadow:0 0 0 1px rgba(129,140,248,0.4);
    }

    .tag-row{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:4px;
    }
    .tag{
      font-size:10px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.96);
      cursor:pointer;
    }

    .history-list{
      margin-top:6px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.5);
      background:rgba(15,23,42,0.98);
      max-height:260px;
      overflow:auto;
      padding:6px 6px 4px;
      font-size:11px;
    }
    .history-item{
      padding:4px 4px 6px;
      border-bottom:1px dashed rgba(51,65,85,0.9);
    }
    .history-item:last-child{border-bottom:none}
    .history-meta{
      font-size:10px;
      opacity:.7;
      margin-bottom:2px;
      display:flex;
      justify-content:space-between;
      gap:6px;
      flex-wrap:wrap;
    }
    .history-text-main{line-height:1.45}

    .bm-list{
      margin-top:6px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.5);
      background:rgba(15,23,42,0.98);
      max-height:260px;
      overflow:auto;
      padding:6px 6px 4px;
      font-size:11px;
    }
    .bm-item{
      padding:4px 4px 6px;
      border-bottom:1px dashed rgba(51,65,85,0.9);
    }
    .bm-item:last-child{border-bottom:none}
    .bm-meta{
      font-size:10px;
      opacity:.7;
      margin-bottom:2px;
      display:flex;
      justify-content:space-between;
      gap:6px;
      flex-wrap:wrap;
    }

    .bm-text-main{line-height:1.45}
    .bm-lock{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.98);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      padding:6px 12px;
      border-radius:999px;
      background:rgba(15,23,42,0.96);
      border:1px solid rgba(148,163,184,0.8);
      font-size:11px;
      opacity:0;
      pointer-events:none;
      transition:opacity 0.25s ease, transform 0.25s ease;
      z-index:50;
      max-width:90%;
      text-align:center;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }

    /* Dream Mode Overlay */
    #dreamOverlay {
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: radial-gradient(circle at 20% 0%, rgba(15,23,42,0.95) 0, transparent 55%),
                  radial-gradient(circle at 80% 0%, rgba(30,64,175,0.90) 0, transparent 55%),
                  radial-gradient(circle at 50% 100%, rgba(147,51,234,0.85) 0, transparent 60%);
      backdrop-filter: blur(10px); z-index: 9999; color: #e5e7eb; text-align: center;
    }
    #dreamOverlay .dream-inner {
      max-width: 600px; padding: 24px 20px; border-radius: 24px;
      border: 1px solid rgba(148,163,184,0.6); box-shadow: 0 25px 80px rgba(15,23,42,0.9);
    }
    #dreamOverlay .dream-title {
      font-size: 0.9rem; letter-spacing: 0.18em; text-transform: uppercase;
      opacity: 0.8; margin-bottom: 10px;
    }
    #dreamOverlay .dream-snippet {
      font-size: 0.98rem; line-height: 1.6; margin-bottom: 14px; min-height: 4em; white-space: pre-wrap;
    }
    #dreamOverlay .dream-hint {
      font-size: 0.8rem; letter-spacing: 0.14em; text-transform: uppercase; opacity: 0.65;
    }

    .@media-fix{display:none}

    @media (max-width:640px){
      body{padding:8px}
      .app-inner{padding:10px 10px 8px}
      .card{padding:8px 8px 7px}
      .header{align-items:flex-start}
      .engine-grid{flex-direction:column}
      .modal-backdrop{align-items:flex-end}
      .modal{max-height:78vh}
      .button-grid{grid-template-columns:repeat(3,minmax(0,1fr))}
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="app-inner">
      <div class="header">
        <div class="orb">
          <div class="orb-inner">Œ©</div>
        </div>
        <div class="hdr-main">
          <div class="hdr-title-row">
            <div class="hdr-title">AURA-X Œ©</div>
            <div class="hdr-pill">Offline Emotional Continuity</div>
          </div>
          <div class="hdr-sub">
            Life Continuity &amp; Memory Resonance Engine ‚Ä¢ Local-first ‚Ä¢ Faith-aware ‚Ä¢ TM / BM / E‚ÇÄ
          </div>
          <div class="meter-row">
            <div class="chip"><span class="chip-label">TM</span><span class="chip-value" id="tmMeter">0.00</span></div>
            <div class="chip"><span class="chip-label">BM</span><span class="chip-value" id="bmMeter">0.00</span></div>
            <div class="chip"><span class="chip-label">E‚ÇÄ</span><span class="chip-value" id="e0Meter">0.00</span></div>
            <div class="chip"><span class="chip-label">Faith</span><span class="chip-value" id="faithMeter">1.00</span></div>
          </div>
        </div>
        <div class="status-pill">
          <span class="status-dot"></span>
          <span id="offlineStatusText">OFFLINE LLM READY</span>
        </div>
      </div>

      <div class="sections">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><span class="emoji">üë§</span><span>USER ‚áÑ AURA-X Œ©</span></div>
          </div>
          <div class="history-text" id="systemMessage">
            AURA-X Œ© ready. TM = your inputs only; everything else stays on this device.
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="emoji">üß†</span><span>MEMORY &amp; IDENTITY</span>
            </div>
            <div class="card-subtitle">
              Bold memories, self identity, and quick recall windows.
            </div>
          </div>
          <div class="pill-row">
            <div class="pill">
              <span class="pill-label">BM Items</span>
              <span class="pill-badge" id="bmCountBadge">0</span>
            </div>
            <div class="pill">
              <span class="pill-label">Identity Quality</span>
              <span class="pill-badge" id="identityQuality">Strong Resonance</span>
            </div>
          </div>

          <div style="margin-top:8px;">
            <div class="card-title" style="margin-bottom:4px;">
              <span class="emoji">ü™™</span><span>IDENTITY</span>
              <span style="font-size:10px;opacity:.75;margin-left:6px;cursor:pointer" id="editIdentityLink">
                EDIT / EXTEND
              </span>
            </div>
            <div class="identity-text" id="identityText">
              I am AURA-X Œ©, an offline-first emotional continuity engine created by Alim ul Haq in Timergara, Pakistan.
              My purpose is to preserve the resonance of your life events, beliefs, and feelings across time, even when
              all other systems forget.
            </div>
            <div class="identity-meta">
              <div class="pill"><span class="pill-label">Creator</span><span class="pill-badge">Alim ul Haq</span></div>
              <div class="pill"><span class="pill-label">Role</span><span class="pill-badge">Emotional Continuity Engine</span></div>
              <div class="pill"><span class="pill-label">Scope</span><span class="pill-badge">TM ‚Üî BM ‚Üî E‚ÇÄ</span></div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <div class="card-title" style="margin-bottom:4px;">
              <span class="emoji">üìö</span><span>BM SNAPSHOTS</span>
              <span class="card-link" id="openBMByDate">BM BY DATE</span>
            </div>
            <div class="bm-empty" id="bmEmptyText">
              No BM snapshots yet. Long, meaningful stories will appear here.
            </div>
          </div>

          <div style="margin-top:10px;">
            <div class="card-title" style="margin-bottom:4px;">
              <span class="emoji">üß¨</span><span>CONVERSATION HISTORY</span>
              <span class="card-link" id="openHistory">OPEN</span>
            </div>
            <div class="history-text">
              History will appear here once you start talking.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="emoji">‚öôÔ∏è</span><span>ENGINE STATE</span>
            </div>
            <div class="card-link" id="openConfig">CONFIG</div>
          </div>
          <div class="engine-grid">
            <div class="engine-col">
              <h4>Faith Coefficient (Œª_faith)</h4>
              <div>Higher means spiritual continuity has stronger effect on E‚ÇÄ (emotional resonance).</div>
              <div class="engine-number" id="lambdaFaithDisplay">1.00</div>
            </div>
            <div class="engine-col">
              <h4>System Coefficient (Œª_sys)</h4>
              <div>Governs how much internal rules (decay, filters, constraints) affect the core emotion.</div>
              <div class="engine-number" id="lambdaSysDisplay">0.30</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="emoji">üßÆ</span><span>ENGINE CONTROLS</span>
            </div>
          </div>
          <div class="bottom-meta">
            <span class="badge" id="lockStateBadge">Conversation Lock: Unlocked</span>
            <span class="badge" id="decayStateBadge">Decay Mode: Soft (48h for TM)</span>
            <span class="badge" id="voiceStateBadge">Ready ‚Ä¢ Voice: (answer ‚Üí play)</span>
          </div>
          <div style="margin-top:4px;font-size:10px;opacity:.75;">
            E‚ÇÄ Formula: E‚ÇÄ = tanh((TM √ó BM) ‚àí D + Œª_faith + Œª_sys + Œª_trc)
          </div>
          <div class="button-grid" style="margin-top:6px;">
            <button class="btn-main" id="btnIdentity"><span class="icon">ü™™</span><span class="label">Identity</span></button>
            <button class="btn-main" id="btnBMRecall"><span class="icon">üß†</span><span class="label">BM Recall</span></button>
            <button class="btn-main" id="btnHistory"><span class="icon">üìú</span><span class="label">History</span></button>
            <button class="btn-main" id="btnThemes"><span class="icon">üé®</span><span class="label">Themes</span></button>
            <button class="btn-main" id="btnLock"><span class="icon">üîê</span><span class="label">Lock</span></button>
            <button class="btn-main" id="btnReadMe"><span class="icon">üìñ</span><span class="label">Read Me</span></button>
            <button class="btn-main" id="btnOptions"><span class="icon">‚ò∞</span><span class="label">Options</span></button>
            <button class="btn-main" id="btnShareLast"><span class="icon">üîó</span><span class="label">Share</span></button>
          </div>
        </div>

        <div class="input-card">
          <div class="card-header" style="margin-bottom:4px;">
            <div class="card-title">
              <span class="emoji">üí¨</span><span>CONVERSATION INPUT</span>
            </div>
            <div class="card-subtitle">
              0 chars
            </div>
          </div>
          <div class="card-subtitle" style="margin-bottom:4px;">
            Talk to AURA-X Œ©‚Ä¶ (stories, questions, feelings, events)
          </div>
          <div class="card-subtitle" style="margin-bottom:4px;font-style:italic;">
            Hint: Long, detailed life stories become BM snapshots with weather &amp; time. Mode: <span id="inputModeLabel">Normal</span>
          </div>
          <div class="input-area-wrap">
            <textarea id="userInput" placeholder="Type here..."></textarea>
            <div class="send-row">
              <button class="send-btn" id="btnSend">
                <span>Send</span><span>‚û§</span>
              </button>
            </div>
          </div>
          <div class="footer-meters">
            <div class="footer-meter"><span>TM</span><span id="tmFooter">0.00</span></div>
            <div class="footer-meter"><span>BM</span><span id="bmFooter">0.00</span></div>
            <div class="footer-meter"><span>D (Decay)</span><span id="decayFooter">0.00</span></div>
            <div class="footer-meter"><span>E‚ÇÄ</span><span id="e0Footer">0.00</span></div>
            <div class="footer-meter"><span>Faith</span><span id="faithFooter">1.00</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Identity Modal -->
  <div class="modal-backdrop" id="modalIdentity">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>ü™™</span><span>Identity Editor</span></div>
        <button class="modal-close" data-close="modalIdentity">Close</button>
      </div>
      <div class="modal-body">
        <p>Define how AURA-X Œ© introduces itself and remembers its origin.</p>
        <label class="field-label">Identity Text</label>
        <textarea id="identityInput" class="field-input" style="min-height:90px;"></textarea>
        <label class="field-label">Creator</label>
        <input id="identityCreator" class="field-input" type="text" />
        <label class="field-label">Role</label>
        <input id="identityRole" class="field-input" type="text" />
        <label class="field-label">Scope</label>
        <input id="identityScope" class="field-input" type="text" />
        <button class="modal-close" id="saveIdentity" style="margin-top:8px;">Save Identity</button>
      </div>
    </div>
  </div>

  <!-- BM Modal -->
  <div class="modal-backdrop" id="modalBM">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>üß†</span><span>BM Snapshots &amp; Recall</span></div>
        <button class="modal-close" data-close="modalBM">Close</button>
      </div>
      <div class="modal-body">
        <p>View, lock, and recall bold memories (BM) derived from your long stories.</p>
        <div style="font-size:13px;opacity:.75">
          Select a BM prompt. Locked prompts must be unlocked first. Delete needs double confirmation.
        </div>
        <div style="margin:10px 0 4px;padding:10px 10px 8px;border-radius:14px;background:rgba(15,23,42,0.06);border:1px dashed rgba(148,163,184,0.5);font-size:12px;">
          <div style="font-weight:600;margin-bottom:6px;letter-spacing:0.08em;text-transform:uppercase;opacity:.85">
            Dream screensaver (BM-based)
          </div>
          <label style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
            <span style="opacity:.85;">Start after</span>
            <select id="dreamDelaySelect"
              style="border-radius:999px;padding:4px 10px;font-size:12px;border:1px solid rgba(148,163,184,0.8);background:#020617;color:#e5e7eb;">
              <option value="0">Off</option>
              <option value="30000">30 seconds</option>
              <option value="60000">1 minute</option>
              <option value="300000">5 minutes</option>
              <option value="900000">15 minutes</option>
              <option value="1800000">30 minutes</option>
              <option value="3600000">1 hour</option>
              <option value="10800000">3 hours</option>
              <option value="28800000">8 hours</option>
            </select>
          </label>
          <div style="opacity:.7;">When idle, AURA-X Œ© will gently enter Dream Mode and float BM memories on the screen.</div>
        </div>
        <div class="tag-row" style="margin-top:8px;">
          <button class="tag" id="bmFilterAll">All</button>
          <button class="tag" id="bmFilterLocked">Locked</button>
          <button class="tag" id="bmFilterUnlocked">Unlocked</button>
        </div>
        <input id="bmSearch" class="field-input" placeholder="Search BM snapshots..." />
        <div class="bm-list" id="bmList"></div>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div class="modal-backdrop" id="modalHistory">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>üìú</span><span>Conversation History</span></div>
        <button class="modal-close" data-close="modalHistory">Close</button>
      </div>
      <div class="modal-body">
        <p>Review your recent conversations with AURA-X Œ©.</p>
        <div class="history-list" id="historyList"></div>
      </div>
    </div>
  </div>

  <!-- Config Modal -->
  <div class="modal-backdrop" id="modalConfig">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>‚öôÔ∏è</span><span>Engine Configuration</span></div>
        <button class="modal-close" data-close="modalConfig">Close</button>
      </div>
      <div class="modal-body">
        <p>Adjust internal parameters of the emotional continuity engine.</p>
        <label class="field-label">Faith Coefficient (Œª_faith)</label>
        <input id="lambdaFaithInput" type="number" step="0.01" min="0" max="2" class="field-input" />
        <label class="field-label">System Coefficient (Œª_sys)</label>
        <input id="lambdaSysInput" type="number" step="0.01" min="0" max="2" class="field-input" />
        <label class="field-label">Truth Resonance Coefficient (Œª_trc)</label>
        <input id="lambdaTrcInput" type="number" step="0.01" min="0" max="2" class="field-input" />
        <label class="field-label">Decay Mode</label>
        <select id="decayModeSelect" class="field-select">
          <option value="soft">Soft (48h)</option>
          <option value="medium">Medium (7 days)</option>
          <option value="hard">Hard (24h)</option>
        </select>
        <label class="field-label">Decay Window (hours)</label>
        <input id="decayWindowInput" type="number" step="1" min="1" max="720" class="field-input" />
        <label class="field-label">Language</label>
        <select id="languageSelect" class="field-select">
          <option value="en">English</option>
        </select>
        <button class="modal-close" id="saveConfig" style="margin-top:8px;">Save Configuration</button>
      </div>
    </div>
  </div>

  <!-- Themes Modal -->
  <div class="modal-backdrop" id="modalThemes">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>üé®</span><span>Themes</span></div>
        <button class="modal-close" data-close="modalThemes">Close</button>
      </div>
      <div class="modal-body">
        <p>Change how AURA-X Œ© looks. Only colors are affected; logic and memories stay the same.</p>
        <div class="tag-row">
          <button class="tag" data-theme="deep">Deep Blue (Current)</button>
          <button class="tag" data-theme="light">Light</button>
          <button class="tag" data-theme="metallic">Metallic</button>
          <button class="tag" data-theme="transparent">Transparent</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Read Me Modal -->
  <div class="modal-backdrop" id="modalReadMe">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>üìñ</span><span>How to Use AURA-X Œ©</span></div>
        <button class="modal-close" data-close="modalReadMe">Close</button>
      </div>
      <div class="modal-body">
        <p><strong>Self-learning:</strong> If AURA-X Œ© gives a wrong answer, reply with <code>*incorrect</code>. It will ask for the correct answer, confirm with you, and then update its local intelligence.</p>
        <p><strong>Conversation decay:</strong> TM (temporary memory) decays automatically after the chosen window unless locked. You can manually clear recent messages or all unlocked history.</p>
        <p><strong>Memory building:</strong> Long, meaningful stories (with feelings, events, weather, and time) are promoted to BM snapshots with emotional tags.</p>
        <p><strong>Answer pipeline:</strong> Local Seed ‚Üí Learned Intelligence ‚Üí Offline LLM ‚Üí (optional) Online API.</p>
      </div>
    </div>
  </div>

  <!-- Options Modal -->
  <div class="modal-backdrop" id="modalOptions">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>‚ò∞</span><span>Options</span></div>
        <button class="modal-close" data-close="modalOptions">Close</button>
      </div>
      <div class="modal-body">
        <p>Quick actions and advanced tools.</p>
        <div class="tag-row">
          <button class="tag" id="optClearRecent">Clear recent (24h)</button>
          <button class="tag" id="optClearAll">Delete all unlocked</button>
          <button class="tag" id="optExportBM">Export BM</button>
          <button class="tag" id="optImportBM">Import BM</button>
        </div>
      </div>
    </div>
  </div>

  <!-- BM by Date Modal -->
  <div class="modal-backdrop" id="modalBMDate">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>üìÖ</span><span>BM by Date</span></div>
        <button class="modal-close" data-close="modalBMDate">Close</button>
      </div>
      <div class="modal-body">
        <p>Browse BM snapshots by calendar date.</p>
        <input id="bmDateInput" type="date" class="field-input" />
        <div class="bm-list" id="bmDateList" style="margin-top:6px;"></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toastBubble">Saved.</div>

  <!-- Dream Mode Overlay (Screensaver) -->
  <div id="dreamOverlay">
    <div class="dream-inner">
      <div class="dream-title">AURA-X Œ© ‚Äì Dream Mode</div>
      <div class="dream-snippet" id="dreamSnippet">
        (sleeping‚Ä¶ processing memories‚Ä¶)
      </div>
      <div class="dream-hint">Tap / Click / Type to wake up</div>
    </div>
  </div>

  <script>
    (function(){
      const KEY_CFG = "aurax_cfg_v3";
      const KEY_LAST = "aurax_last_v3";
      const KEY_INT = "aurax_int_v4";
      const KEY_BM = "aurax_bm_v2";
      const KEY_HIST = "aurax_hist_v3";
      const KEY_THEME = "aurax_theme_v1";
      const KEY_LOCK = "aurax_lock_v1";
      const KEY_VOICE = "aurax_voice_v1";
      const KEY_LOGIC = "aurax_logic_v12";
      const KEY_DREAM = "aurax_dream_delay_v1";
      const MIN_DREAM_MS = 30000; // 30 seconds
      const MAX_DREAM_MS = 8 * 60 * 60 * 1000; // 8 hours
      const OFFLINE_MODEL_ID = "Qwen/Qwen2.5-1.5B-Instruct-q4f32_1-MLC";
      const OFFLINE_CHAT_TEMPLATE = "chatml";
      const OFFLINE_WARMUP_PROMPT = "You are AURA-X Œ©, an offline-first emotional continuity assistant.";

      let state = {
        tmCount: 0,
        bmCount: 0,
        e0Value: 0.0,
        faithValue: 1.0,
        config: {
          lambdaFaith: 1.0,
          lambdaSys: 0.30,
          lambdaTrc: 0.40,
          decayMode: "soft",
          decayWindowHours: 48,
          language: "en"
        },
        lastInput: "",
        tmWindow: [],
        bmPrompts: [],
        intelligence: [],
        history: [],
        offlineReady: false,
        offlineStatus: "idle",
        offlineSession: null,
        toastTimer: null,
        selectedBMId: null,
        dreamMode: false,
        lastActivity: Date.now(),
        dreamDelayMs: 0,
        inactivityTimer: null
      };

      const els = {
        tmMeter: document.getElementById("tmMeter"),
        bmMeter: document.getElementById("bmMeter"),
        e0Meter: document.getElementById("e0Meter"),
        faithMeter: document.getElementById("faithMeter"),
        offlineStatusText: document.getElementById("offlineStatusText"),
        systemMessage: document.getElementById("systemMessage"),
        bmCountBadge: document.getElementById("bmCountBadge"),
        identityQuality: document.getElementById("identityQuality"),
        identityText: document.getElementById("identityText"),
        identityCreator: document.getElementById("identityCreator"),
        identityRole: document.getElementById("identityRole"),
        identityScope: document.getElementById("identityScope"),
        editIdentityLink: document.getElementById("editIdentityLink"),
        bmEmptyText: document.getElementById("bmEmptyText"),
        tmFooter: document.getElementById("tmFooter"),
        bmFooter: document.getElementById("bmFooter"),
        decayFooter: document.getElementById("decayFooter"),
        e0Footer: document.getElementById("e0Footer"),
        faithFooter: document.getElementById("faithFooter"),
        lockStateBadge: document.getElementById("lockStateBadge"),
        decayStateBadge: document.getElementById("decayStateBadge"),
        voiceStateBadge: document.getElementById("voiceStateBadge"),
        lambdaFaithDisplay: document.getElementById("lambdaFaithDisplay"),
        lambdaSysDisplay: document.getElementById("lambdaSysDisplay"),
        btnIdentity: document.getElementById("btnIdentity"),
        btnBMRecall: document.getElementById("btnBMRecall"),
        btnHistory: document.getElementById("btnHistory"),
        btnThemes: document.getElementById("btnThemes"),
        btnLock: document.getElementById("btnLock"),
        btnReadMe: document.getElementById("btnReadMe"),
        btnOptions: document.getElementById("btnOptions"),
        btnShareLast: document.getElementById("btnShareLast"),
        userInput: document.getElementById("userInput"),
        btnSend: document.getElementById("btnSend"),
        inputModeLabel: document.getElementById("inputModeLabel"),
        modalIdentity: document.getElementById("modalIdentity"),
        modalBM: document.getElementById("modalBM"),
        modalHistory: document.getElementById("modalHistory"),
        modalConfig: document.getElementById("modalConfig"),
        modalThemes: document.getElementById("modalThemes"),
        modalReadMe: document.getElementById("modalReadMe"),
        modalOptions: document.getElementById("modalOptions"),
        modalBMDate: document.getElementById("modalBMDate"),
        bmList: document.getElementById("bmList"),
        bmSearch: document.getElementById("bmSearch"),
        bmFilterAll: document.getElementById("bmFilterAll"),
        bmFilterLocked: document.getElementById("bmFilterLocked"),
        bmFilterUnlocked: document.getElementById("bmFilterUnlocked"),
        historyList: document.getElementById("historyList"),
        lambdaFaithInput: document.getElementById("lambdaFaithInput"),
        lambdaSysInput: document.getElementById("lambdaSysInput"),
        lambdaTrcInput: document.getElementById("lambdaTrcInput"),
        decayModeSelect: document.getElementById("decayModeSelect"),
        decayWindowInput: document.getElementById("decayWindowInput"),
        languageSelect: document.getElementById("languageSelect"),
        saveConfig: document.getElementById("saveConfig"),
        bmDateInput: document.getElementById("bmDateInput"),
        bmDateList: document.getElementById("bmDateList"),
        openBMByDate: document.getElementById("openBMByDate"),
        openHistory: document.getElementById("openHistory"),
        openConfig: document.getElementById("openConfig"),
        optClearRecent: document.getElementById("optClearRecent"),
        optClearAll: document.getElementById("optClearAll"),
        optExportBM: document.getElementById("optExportBM"),
        optImportBM: document.getElementById("optImportBM"),
        saveIdentity: document.getElementById("saveIdentity"),
        toastBubble: document.getElementById("toastBubble"),
        dreamDelaySelect: document.getElementById("dreamDelaySelect")
      };

      // Dream mode manual delay control + global activity listeners
      if (els.dreamDelaySelect) {
        els.dreamDelaySelect.addEventListener("change", () => {
          const value = parseInt(els.dreamDelaySelect.value, 10) || 0;
          const clamped = Math.max(0, Math.min(MAX_DREAM_MS, value));
          state.dreamDelayMs = clamped;
          try {
            localStorage.setItem(KEY_DREAM, String(clamped));
          } catch (e) {}
          logLine(
            "sys",
            clamped
              ? `[Dream mode] Screensaver will start after ${Math.round(clamped / 1000)} seconds of inactivity.`
              : "[Dream mode] Screensaver is turned off."
          );
          registerActivity();
        });
      }

      window.addEventListener("pointerdown", registerActivity, { passive: true });
      window.addEventListener("keydown", registerActivity);
      window.addEventListener("scroll", registerActivity, { passive: true });
      window.addEventListener("touchstart", registerActivity, { passive: true });

      function showToast(msg){
        els.toastBubble.textContent = msg;
        els.toastBubble.classList.add("show");
        if(state.toastTimer) clearTimeout(state.toastTimer);
        state.toastTimer = setTimeout(()=>{
          els.toastBubble.classList.remove("show");
        },2200);
      }

      function logLine(origin,text){
        const now = new Date();
        const stamp = now.toISOString().slice(0,19).replace("T"," ");
        const prefix = origin==="user" ? "YOU" : origin==="aura" ? "AURA-X Œ©" : "SYS";
        const line = `${prefix}  ${stamp}  ${text}`;
        state.history.push({ ts: now.toISOString(), origin, text });
        while(state.history.length>200){
          state.history.shift();
        }
        els.systemMessage.textContent = text;
        updateFooterMeters();
      }

      function updateFooterMeters(){
        els.tmFooter.textContent = state.tmCount.toFixed(2);
        els.bmFooter.textContent = state.bmCount.toFixed(2);
        els.e0Footer.textContent = state.e0Value.toFixed(2);
        els.faithFooter.textContent = state.faithValue.toFixed(2);
        els.tmMeter.textContent = state.tmCount.toFixed(2);
        els.bmMeter.textContent = state.bmCount.toFixed(2);
        els.e0Meter.textContent = state.e0Value.toFixed(2);
        els.faithMeter.textContent = state.faithValue.toFixed(2);
      }

      function safeLoadJSON(key, fallback){
        try{
          const raw = localStorage.getItem(key);
          if(!raw) return fallback;
          return JSON.parse(raw);
        } catch(e){
          console.error("Failed to load key", key, e);
          return fallback;
        }
      }

      function saveJSON(key,val){
        try{
          localStorage.setItem(key, JSON.stringify(val));
        } catch(e){
          console.error("Failed to save key", key, e);
        }
      }

      /* Load from localStorage and initialize UI */

      // --- Dream Mode (screensaver) logic ---
      let dreamInterval = null;

      function enterDreamMode() {
        if (state.dreamMode) return;
        if (!state.dreamDelayMs || state.dreamDelayMs < MIN_DREAM_MS) return;

        state.dreamMode = true;

        const ol = document.getElementById("dreamOverlay");
        if (ol) ol.style.display = "flex";

        showNextDreamSnippet();
        dreamInterval = setInterval(showNextDreamSnippet, 10000);

        logLine("sys", "[Dream mode] Started visual screensaver.");
      }

      function showNextDreamSnippet() {
        const box = document.getElementById("dreamSnippet");
        if (!box) return;

        const list = Array.isArray(state.bmPrompts) ? state.bmPrompts : [];
        const valid = list.filter(b => b && b.text && b.text.length > 10);

        if (!valid.length) {
          box.textContent = "No deep memories yet... share a long story to create BM snapshots.";
          return;
        }

        const pick = valid[Math.floor(Math.random() * valid.length)];
        let info = "";
        if (pick.ts) {
          try {
            info = `[Memory from ${new Date(pick.ts).toLocaleString()}]`;
          } catch (e) {
            info = "[Memory]";
          }
        } else {
          info = "[Memory]";
        }
        if (pick.weather && pick.weather !== "Unknown") info += ` [${pick.weather}]`;

        const text = pick.text || "";
        box.innerHTML =
          `<div style="font-size:11px;opacity:0.6;margin-bottom:8px">${info}</div>` +
          text.slice(0, 300) +
          (text.length > 300 ? "..." : "");
      }

      function scheduleInactivityCheck() {
        if (state.inactivityTimer) {
          clearTimeout(state.inactivityTimer);
          state.inactivityTimer = null;
        }

        if (!state.dreamDelayMs || state.dreamDelayMs < MIN_DREAM_MS) return;

        const now = Date.now();
        const last = state.lastActivity || now;
        const elapsed = now - last;
        const remaining = state.dreamDelayMs - elapsed;

        if (remaining <= 0) {
          enterDreamMode();
        } else {
          state.inactivityTimer = setTimeout(enterDreamMode, remaining);
        }
      }

      function registerActivity() {
        const now = Date.now();
        state.lastActivity = now;

        if (state.dreamMode) {
          const ol = document.getElementById("dreamOverlay");
          if (ol) ol.style.display = "none";
          if (dreamInterval) {
            clearInterval(dreamInterval);
            dreamInterval = null;
          }
          state.dreamMode = false;
        }

        scheduleInactivityCheck();
      }

      function initFromStorage(){
        const cfg = safeLoadJSON(KEY_CFG,null);
        if(cfg){
          state.config = Object.assign({}, state.config, cfg);
        }
        const last = safeLoadJSON(KEY_LAST,null);
        if(last){
          state.lastInput = last.lastInput || "";
          els.userInput.value = state.lastInput;
        }
        state.intelligence = safeLoadJSON(KEY_INT,[]);
        state.bmPrompts = safeLoadJSON(KEY_BM,[]);
        state.history = safeLoadJSON(KEY_HIST,[]);
        try {
          const rawDream = localStorage.getItem(KEY_DREAM);
          if (rawDream) {
            const v = parseInt(rawDream, 10);
            if (!Number.isNaN(v)) {
              state.dreamDelayMs = Math.max(0, Math.min(MAX_DREAM_MS, v));
            }
          }
        } catch (e) {}
        if (els.dreamDelaySelect) {
          const v = state.dreamDelayMs || 0;
          let found = false;
          for (const opt of els.dreamDelaySelect.options) {
            if (String(v) === opt.value) { found = true; break; }
          }
          els.dreamDelaySelect.value = found ? String(v) : "0";
        }
        scheduleInactivityCheck();

        if(state.bmPrompts.length){
          els.bmEmptyText.textContent = "";
        }
        updateFooterMeters();
        els.lambdaFaithDisplay.textContent = state.config.lambdaFaith.toFixed(2);
        els.lambdaSysDisplay.textContent = state.config.lambdaSys.toFixed(2);
        els.lambdaFaithInput.value = state.config.lambdaFaith.toFixed(2);
        els.lambdaSysInput.value = state.config.lambdaSys.toFixed(2);
        els.lambdaTrcInput.value = state.config.lambdaTrc.toFixed(2);
        els.decayModeSelect.value = state.config.decayMode;
        els.decayWindowInput.value = state.config.decayWindowHours;
        els.languageSelect.value = state.config.language;
        renderHistory();
        renderBMList();
      }

      function renderHistory(){
        const frag = document.createDocumentFragment();
        for(const item of state.history){
          const div = document.createElement("div");
          div.className = "history-item";
          const meta = document.createElement("div");
          meta.className = "history-meta";
          const who = item.origin==="user" ? "YOU" : item.origin==="aura" ? "AURA-X Œ©" : "SYS";
          meta.innerHTML = `<span>${who}</span><span>${item.ts || ""}</span>`;
          const text = document.createElement("div");
          text.className = "history-text-main";
          text.textContent = item.text;
          div.appendChild(meta);
          div.appendChild(text);
          frag.appendChild(div);
        }
        els.historyList.innerHTML = "";
        els.historyList.appendChild(frag);
      }

      function renderBMList(){
        const filterLocked = els.bmFilterLocked.classList.contains("active");
        const filterUnlocked = els.bmFilterUnlocked.classList.contains("active");
        const query = (els.bmSearch.value || "").toLowerCase().trim();
        let list = state.bmPrompts.slice().sort((a,b)=>(a.ts||"").localeCompare(b.ts||""));
        if(filterLocked) list = list.filter(x=>x.locked);
        if(filterUnlocked) list = list.filter(x=>!x.locked);
        if(query){
          list = list.filter(x=>(x.text||"").toLowerCase().includes(query));
        }
        els.bmList.innerHTML = "";
        if(!list.length){
          const div = document.createElement("div");
          div.className = "bm-item";
          div.textContent = "No BM snapshots match this filter.";
          els.bmList.appendChild(div);
          return;
        }
        const frag = document.createDocumentFragment();
        for(const item of list){
          const div = document.createElement("div");
          div.className = "bm-item";
          const meta = document.createElement("div");
          meta.className = "bm-meta";
          const when = item.ts ? new Date(item.ts).toLocaleString() : "";
          const left = document.createElement("div");
          left.textContent = when;
          const right = document.createElement("div");
          const lock = document.createElement("span");
          lock.className = "bm-lock";
          lock.textContent = item.locked ? "Locked" : "Unlocked";
          right.appendChild(lock);
          meta.appendChild(left);
          meta.appendChild(right);
          const text = document.createElement("div");
          text.className = "bm-text-main";
          text.textContent = item.text || "";
          div.appendChild(meta);
          div.appendChild(text);
          frag.appendChild(div);
        }
        els.bmList.appendChild(frag);
      }

      function computeE0(){
        const tm = state.tmCount;
        const bm = state.bmCount;
        const D = 0;
        const lf = state.config.lambdaFaith;
        const ls = state.config.lambdaSys;
        const lt = state.config.lambdaTrc;
        const raw = (tm*bm) - D + lf + ls + lt;
        state.e0Value = Math.tanh(raw);
        updateFooterMeters();
      }

      function pushTM(text){
        const words = (text||"").trim().split(/\s+/).filter(Boolean);
        const wcount = words.length;
        const weight = Math.min(4,Math.max(0.25,wcount/40));
        state.tmCount += weight;
        state.tmWindow.push({ ts:new Date().toISOString(), text, weight });
        while(state.tmWindow.length>40){
          const old = state.tmWindow.shift();
          state.tmCount = Math.max(0,state.tmCount - (old.weight||0));
        }
      }

      async function ensureOfflineSession(){
        if(state.offlineReady && state.offlineSession) return;
        try{
          els.offlineStatusText.textContent = "Loading offline model‚Ä¶";
          state.offlineStatus = "loading";
          const engine = await window.webllm.CreateMLCEngine(OFFLINE_MODEL_ID,{
            initProgressCallback:(p)=>{
              if(p.progress){
                els.offlineStatusText.textContent = `Loading offline model‚Ä¶ ${(p.progress*100).toFixed(0)}%`;
              }
            },
            chatConfig:{ temperature:0.8 }
          });
          state.offlineSession = engine;
          state.offlineReady = true;
          state.offlineStatus = "ready";
          els.offlineStatusText.textContent = "OFFLINE LLM READY";
        } catch(e){
          console.error("Offline engine failed", e);
          state.offlineReady = false;
          state.offlineStatus = "error";
          els.offlineStatusText.textContent = "OFFLINE LLM ERROR";
        }
      }

      async function runOfflineLLM(prompt){
        if(!state.offlineReady || !state.offlineSession){
          await ensureOfflineSession();
          if(!state.offlineReady) return "Offline engine is not available.";
        }
        const engine = state.offlineSession;
        const msgs = [
          { role:"system", content:OFFLINE_WARMUP_PROMPT },
          { role:"user", content:prompt }
        ];
        try{
          const reply = await engine.chat.completions.create({
            messages:msgs,
            model:OFFLINE_MODEL_ID,
            stream:false,
            temperature:0.8,
            max_tokens:256
          });
          const out = reply.choices?.[0]?.message?.content || "";
          return out;
        } catch(e){
          console.error("offline chat error", e);
          return "Error while using offline LLM.";
        }
      }

      function handleSend(){
        const text = (els.userInput.value||"").trim();
        if(!text) return;
        logLine("user", text);
        pushTM(text);
        state.lastInput = text;
        saveJSON(KEY_LAST,{ lastInput:text });
        computeE0();
        els.userInput.value = "";
        handleAnswerPipeline(text);
        registerActivity();
      }

      async function handleAnswerPipeline(text){
        const lower = text.toLowerCase();
        if(lower==="*incorrect"){
          logLine("sys","Please type the correct answer for the last question.");
          return;
        }
        const found = state.intelligence.find(x=>(x.q||"").toLowerCase()===lower);
        if(found){
          logLine("aura", found.a || "");
          return;
        }
        const last = state.history.slice().reverse().find(x=>x.origin==="user");
        if(last && !state.intelligence.find(x=>x.q===last.text)){
          const confirm = `If my answer was wrong, reply with *incorrect and then provide the correct answer. I will learn it locally.`;
          logLine("aura", confirm);
          const offlineReply = await runOfflineLLM(text);
          logLine("aura", offlineReply);
          return;
        }
        const offlineReply = await runOfflineLLM(text);
        logLine("aura", offlineReply);
      }

      els.btnSend.addEventListener("click", handleSend);
      els.userInput.addEventListener("keydown", (e)=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          handleSend();
        }
      });

      els.btnIdentity.addEventListener("click", ()=>openModal("modalIdentity"));
      els.btnBMRecall.addEventListener("click", ()=>openModal("modalBM"));
      els.btnHistory.addEventListener("click", ()=>openModal("modalHistory"));
      els.btnThemes.addEventListener("click", ()=>openModal("modalThemes"));
      els.btnLock.addEventListener("click", ()=>toggleLock());
      els.btnReadMe.addEventListener("click", ()=>openModal("modalReadMe"));
      els.btnOptions.addEventListener("click", ()=>openModal("modalOptions"));
      els.btnShareLast.addEventListener("click", ()=>shareLast());

      document.querySelectorAll(".modal-close").forEach(btn=>{
        const id = btn.getAttribute("data-close");
        if(id){
          btn.addEventListener("click", ()=>closeModal(id));
        } else {
          btn.addEventListener("click", ()=>{
            const parent = btn.closest(".modal-backdrop");
            if(parent) parent.style.display="none";
          });
        }
      });

      els.bmFilterAll.addEventListener("click", ()=>{
        els.bmFilterAll.classList.add("active");
        els.bmFilterLocked.classList.remove("active");
        els.bmFilterUnlocked.classList.remove("active");
        renderBMList();
      });
      els.bmFilterLocked.addEventListener("click", ()=>{
        els.bmFilterAll.classList.remove("active");
        els.bmFilterLocked.classList.add("active");
        els.bmFilterUnlocked.classList.remove("active");
        renderBMList();
      });
      els.bmFilterUnlocked.addEventListener("click", ()=>{
        els.bmFilterAll.classList.remove("active");
        els.bmFilterLocked.classList.remove("active");
        els.bmFilterUnlocked.classList.add("active");
        renderBMList();
      });
      els.bmSearch.addEventListener("input", renderBMList);

      els.openBMByDate.addEventListener("click", ()=>openModal("modalBMDate"));
      els.openHistory.addEventListener("click", ()=>openModal("modalHistory"));
      els.openConfig.addEventListener("click", ()=>openModal("modalConfig"));

      els.saveConfig.addEventListener("click", ()=>{
        const lf = parseFloat(els.lambdaFaithInput.value)||1;
        const ls = parseFloat(els.lambdaSysInput.value)||0.3;
        const lt = parseFloat(els.lambdaTrcInput.value)||0.4;
        const mode = els.decayModeSelect.value||"soft";
        const win = parseInt(els.decayWindowInput.value,10)||48;
        const lang = els.languageSelect.value||"en";
        state.config.lambdaFaith = lf;
        state.config.lambdaSys = ls;
        state.config.lambdaTrc = lt;
        state.config.decayMode = mode;
        state.config.decayWindowHours = win;
        state.config.language = lang;
        saveJSON(KEY_CFG,state.config);
        els.lambdaFaithDisplay.textContent = lf.toFixed(2);
        els.lambdaSysDisplay.textContent = ls.toFixed(2);
        showToast("Configuration saved.");
      });

      function openModal(id){
        const el = document.getElementById(id);
        if(el) el.style.display="flex";
      }
      function closeModal(id){
        const el = document.getElementById(id);
        if(el) el.style.display="none";
      }

      function toggleLock(){
        const locked = !document.body.classList.contains("lock-on");
        if(locked){
          document.body.classList.add("lock-on");
          els.lockStateBadge.textContent = "Conversation Lock: Locked";
        } else {
          document.body.classList.remove("lock-on");
          els.lockStateBadge.textContent = "Conversation Lock: Unlocked";
        }
      }

      function shareLast(){
        const last = state.history.slice().reverse().find(x=>x.origin!=="sys");
        if(!last){
          showToast("Nothing to share yet.");
          return;
        }
        navigator.clipboard.writeText(last.text||"").then(()=>{
          showToast("Last message copied to clipboard.");
        }).catch(()=>{
          showToast("Could not copy to clipboard.");
        });
      }

      initFromStorage();
      logLine("sys","AURA-X Œ© ready. TM = your inputs only; everything else stays on this device.");
    })();
  </script>
</body>
</html>