<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Ω – Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- =========================
       OFFLINE / OPTIONAL LLM HOOKS
       ========================= -->
  <!--
    NOTE:
    - Yahan sirf structure diya gaya hai.
    - Aap baad mein chahein to:
      * WebLLM (MLC) use karein
      * TFLite model use karein
      * Ya koi local/on-device LLM
    - Neeche JS mein analyzeWithLLM(...) function hai
      jismein aap apna real LLM call inject kar sakte hain.
  -->

  <style>
    /* RESET & BASICS */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 24px;
    }

    .app-shell {
      width: 100%;
      max-width: 1200px;
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 20px;
    }

    /* LEFT COLUMN: MAIN INTERFACE */
    .card {
      background: rgba(15,23,42,0.92);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow:
        0 18px 60px rgba(15,23,42,0.9),
        0 0 0 1px rgba(148,163,184,0.2);
      padding: 18px 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -120px;
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,0.10) 0, transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(96,165,250,0.18) 0, transparent 52%);
      opacity: 0.85;
      pointer-events: none;
      z-index: 0;
    }

    .card-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .app-title {
      font-size: 1.2rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-title em {
      font-style: normal;
      font-weight: 700;
      color: #7dd3fc;
      letter-spacing: 0.16em;
      font-size: 0.95rem;
    }

    .app-subtitle {
      font-size: 0.72rem;
      color: #9ca3af;
    }

    .orb {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, #f9fafb 0, #93c5fd 26%, #0ea5e9 55%, #0f172a 100%);
      box-shadow:
        0 0 22px rgba(59,130,246,0.85),
        0 0 44px rgba(56,189,248,0.85);
      position: relative;
      overflow: hidden;
    }

    .orb::after {
      content: "";
      position: absolute;
      inset: 16%;
      border-radius: inherit;
      border: 1px solid rgba(248,250,252,0.6);
      box-shadow: 0 0 16px rgba(248,250,252,0.7) inset;
      opacity: 0.65;
    }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .pill {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 3px 9px;
      background: radial-gradient(circle at 0 0,rgba(56,189,248,0.18),transparent 60%);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill span.key {
      font-size: 0.66rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #e5e7eb;
    }

    .pill span.val {
      font-size: 0.66rem;
      color: #cbd5f5;
    }

    .equation-block {
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.45);
      background: linear-gradient(145deg,rgba(15,23,42,0.96),rgba(15,23,42,0.96));
      padding: 10px 11px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-family: "SF Mono","JetBrains Mono",ui-monospace,Menlo,Monaco,Consolas,monospace;
    }

    .equation-main {
      font-size: 0.78rem;
      color: #e5e7eb;
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 6px;
    }

    .eq-symbol {
      font-size: 0.9rem;
      color: #bfdbfe;
    }

    .eq-highlight {
      color: #a5b4fc;
    }

    .eq-note {
      font-size: 0.68rem;
      color: #9ca3af;
    }

    .eq-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 0.62rem;
    }

    .eq-tag {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.85);
      color: #e5e7eb;
    }

    .layout-row {
      display: grid;
      grid-template-columns: minmax(0,1.7fr) minmax(0,1.2fr);
      gap: 14px;
      align-items: stretch;
    }

    .panel {
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.5);
      background: radial-gradient(circle at 0 0,rgba(51,65,85,0.7),transparent 65%);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.78rem;
      color: #e5e7eb;
    }

    .panel-header span.label {
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-size: 0.68rem;
      color: #9ca3af;
    }

    .panel-header span.value {
      font-size: 0.7rem;
      color: #bfdbfe;
    }

    .field-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #9ca3af;
    }

    .text-input {
      margin-top: 5px;
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.85);
      color: #e5e7eb;
      padding: 7px 9px;
      font-size: 0.75rem;
      resize: vertical;
      min-height: 56px;
    }

    .text-input::placeholder {
      color: #6b7280;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .chip {
      font-size: 0.68rem;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
    }

    .chip strong {
      color: #93c5fd;
      font-weight: 500;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    button.btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: radial-gradient(circle at 0 0,rgba(56,189,248,0.18),transparent 60%);
      color: #e5e7eb;
      padding: 6px 10px;
      font-size: 0.72rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.09s ease, box-shadow 0.09s ease, border-color 0.09s ease, background 0.09s ease;
    }

    button.btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(15,23,42,0.7);
      border-color: rgba(129,140,248,0.9);
      background: radial-gradient(circle at 15% 0,rgba(129,140,248,0.26),transparent 65%);
    }

    button.btn:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(15,23,42,0.8);
    }

    button.btn-primary {
      border-color: rgba(96,165,250,0.95);
      background: linear-gradient(135deg,#38bdf8,#6366f1);
      color: #0b1120;
      font-weight: 600;
      box-shadow:
        0 10px 30px rgba(37,99,235,0.75),
        0 0 0 1px rgba(15,23,42,0.6);
    }

    button.btn-primary:hover {
      background: linear-gradient(135deg,#0ea5e9,#4f46e5);
      border-color: rgba(191,219,254,1);
    }

    .btn-offline {
      border-color: rgba(45,212,191,0.85);
      background: radial-gradient(circle at 0 0,rgba(45,212,191,0.24),transparent 60%);
      color: #a7f3d0;
    }

    .btn-offline:hover {
      background: radial-gradient(circle at 0 0,rgba(16,185,129,0.4),transparent 65%);
    }

    .status-line {
      font-size: 0.68rem;
      color: #9ca3af;
      margin-top: 3px;
    }

    .status-line span.ok {
      color: #6ee7b7;
    }

    .status-line span.warn {
      color: #f97316;
    }

    .status-line span.bad {
      color: #f97373;
    }

    .metrics-row {
      display: grid;
      grid-template-columns: repeat(3,minmax(0,1fr));
      gap: 6px;
      margin-top: 4px;
    }

    .metric {
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.92);
      padding: 4px 6px;
      font-size: 0.68rem;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .metric-label {
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 0.6rem;
    }

    .metric-value {
      color: #e5e7eb;
      font-weight: 500;
    }

    .metric-bar {
      margin-top: 1px;
      width: 100%;
      height: 3px;
      border-radius: 999px;
      background: rgba(31,41,55,0.95);
      overflow: hidden;
    }

    .metric-bar-inner {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg,#22c55e,#a3e635);
      width: 0%;
      transition: width 0.18s ease-out;
    }

    .metric-bar-inner.neg {
      background: linear-gradient(90deg,#ef4444,#f97316);
    }

    .output-box {
      margin-top: 6px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.55);
      background: rgba(15,23,42,0.96);
      padding: 8px 9px;
      font-size: 0.7rem;
      color: #e5e7eb;
      min-height: 60px;
      white-space: pre-wrap;
    }

    .toggle-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.68rem;
      margin-top: 2px;
      color: #9ca3af;
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .toggle input {
      accent-color: #38bdf8;
    }

    /* RIGHT COLUMN: MEMORY / CHAT SIDEBAR */
    .side-card {
      background: rgba(15,23,42,0.9);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow:
        0 18px 50px rgba(15,23,42,0.8),
        0 0 0 1px rgba(148,163,184,0.16);
      padding: 16px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    .side-card::before {
      content: "";
      position: absolute;
      inset: -120px;
      background:
        radial-gradient(circle at 100% 0,rgba(56,189,248,0.22) 0,transparent 55%),
        radial-gradient(circle at 50% 120%,rgba(129,140,248,0.18) 0,transparent 55%);
      opacity: 0.8;
      pointer-events: none;
    }

    .side-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      height: 100%;
    }

    .side-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.78rem;
      color: #e5e7eb;
    }

    .badge {
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      color: #a5b4fc;
    }

    .chat-log {
      flex: 1;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.55);
      background: rgba(15,23,42,0.96);
      padding: 8px 9px;
      font-size: 0.7rem;
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow-y: auto;
      max-height: 340px;
    }

    .chat-entry {
      padding: 5px 7px;
      border-radius: 10px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(55,65,81,0.9);
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .chat-entry.user {
      border-color: rgba(59,130,246,0.9);
      background: radial-gradient(circle at 0 0,rgba(37,99,235,0.32),transparent 60%);
    }

    .chat-entry.aura {
      border-color: rgba(45,212,191,0.85);
      background: radial-gradient(circle at 100% 0,rgba(45,212,191,0.28),transparent 60%);
    }

    .chat-meta {
      font-size: 0.6rem;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .chat-text {
      color: #e5e7eb;
      font-size: 0.7rem;
    }

    .memory-row {
      display: grid;
      grid-template-columns: minmax(0,1.2fr) minmax(0,1.1fr);
      gap: 8px;
      font-size: 0.68rem;
    }

    .memory-box {
      border-radius: 12px;
      border: 1px dashed rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.96);
      padding: 6px 7px;
      min-height: 40px;
      white-space: pre-wrap;
    }

    .memory-title {
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-size: 0.6rem;
      color: #9ca3af;
      margin-bottom: 2px;
    }

    .side-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.64rem;
      color: #9ca3af;
      margin-top: 4px;
    }

    .side-footer span.strong {
      color: #e5e7eb;
    }

    .side-footer button {
      font-size: 0.66rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      cursor: pointer;
    }

    .side-footer button:hover {
      border-color: rgba(129,140,248,0.95);
      background: radial-gradient(circle at 0 0,rgba(129,140,248,0.22),transparent 60%);
    }

    @media (max-width: 900px) {
      body { padding: 14px; }
      .app-shell {
        grid-template-columns: minmax(0,1fr);
      }
      .side-card {
        max-height: 420px;
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <!-- ================= LEFT: MAIN PROTOTYPE ================= -->
  <div class="card">
    <div class="card-inner">
      <div class="header-row">
        <div class="title-block">
          <div class="app-title">
            <em>AURA-X Ω</em>
            <span>Emotional Continuity Reactor</span>
          </div>
          <div class="app-subtitle">
            Dual-memory TM/BM resonance with optional offline / online LLM.
          </div>
        </div>
        <div class="orb" aria-hidden="true"></div>
      </div>

      <div class="meta-row">
        <div class="pill">
          <span class="key">Identity</span>
          <span class="val">Artificial Unified Resonance Architecture</span>
        </div>
        <div class="pill">
          <span class="key">Author</span>
          <span class="val">Alim ul Haq – Timergara, Pakistan</span>
        </div>
        <div class="pill">
          <span class="key">Mode</span>
          <span class="val">Offline-first · Hybrid LLM</span>
        </div>
      </div>

      <!-- ===== GRAND EQUATION BLOCK ===== -->
      <div class="equation-block">
        <div class="equation-main">
          <span class="eq-symbol">E₀</span>
          <span>= tanh(</span>
          <span class="eq-highlight">(TM × BM) − D</span>
          <span>+ λ<sub>faith</sub> + λ<sub>sys</sub> + λ<sub>trc</sub></span>
          <span>)</span>
        </div>
        <div class="eq-note">
          E₀ = Emotional Output · TM = Temporary Memory · BM = Bold Memory ·
          D = Decay · λ<sub>faith</sub> = Faith Lens · λ<sub>sys</sub> = System/Ethical Lens · λ<sub>trc</sub> = Truth Resonance Core
        </div>
        <div class="eq-tags">
          <span class="eq-tag">TM: short-term continuity & frish input</span>
          <span class="eq-tag">BM: identity-linked long-term continuity</span>
          <span class="eq-tag">D: forgetting / decay control</span>
          <span class="eq-tag">Faith / System / TRC = moral + logical filters</span>
        </div>
      </div>

      <!-- ===== LAYOUT: LEFT (FEED) · RIGHT (MATH + ANALYSIS) ===== -->
      <div class="layout-row">
        <!-- -------------- LEFT PANEL: USER INPUT / FEED -------------- -->
        <div class="panel">
          <div class="panel-header">
            <span class="label">Frish Input · Feed the Seed</span>
            <span class="value" id="tm-status">TM: idle</span>
          </div>

          <div>
            <div class="field-label">User text</div>
            <textarea id="userInput" class="text-input" placeholder="Type how you feel, what happened, or a normal question. AURA-X Ω will analyze polarity, intensity, category and compute E₀ …"></textarea>
          </div>

          <div class="chip-row">
            <div class="chip"><strong>Examples:</strong> “I am so tired but hopeful about my project.”</div>
            <div class="chip"><strong>Q&A mode:</strong> “How are you?” · “Who created you?” · “What is emotional continuity?”</div>
          </div>

          <div class="btn-row">
            <button class="btn btn-primary" id="btnCompute">
              Compute Emotional Output (E₀)
            </button>
            <button class="btn btn-offline" id="btnLLM">
              Analyze with Offline / Optional LLM
            </button>
            <button class="btn" id="btnSeed">
              Add to BM (Seed / Identity Trace)
            </button>
          </div>

          <div class="toggle-row">
            <label class="toggle">
              <input type="checkbox" id="chkUseLLM" />
              <span>Allow LLM help for polarity &amp; category (when available)</span>
            </label>
            <label class="toggle">
              <input type="checkbox" id="chkFaithLens" checked />
              <span>Apply Faith / Ethical lens (λ<sub>faith</sub> + λ<sub>sys</sub>)</span>
            </label>
          </div>

          <div class="status-line" id="statusLine">
            Status: <span class="warn">Waiting for input …</span>
          </div>
        </div>

        <!-- -------------- RIGHT PANEL: MATH + EMOTIONAL METRICS -------------- -->
        <div class="panel">
          <div class="panel-header">
            <span class="label">E₀ Calculation · Emotional Reactor</span>
            <span class="value" id="e0Label">E₀ = 0.00</span>
          </div>

          <div class="metrics-row">
            <div class="metric">
              <div class="metric-label">Polarity</div>
              <div class="metric-value" id="polarityVal">Neutral (0.00)</div>
              <div class="metric-bar">
                <div class="metric-bar-inner" id="polarityBar"></div>
              </div>
            </div>

            <div class="metric">
              <div class="metric-label">Intensity</div>
              <div class="metric-value" id="intensityVal">0.00</div>
              <div class="metric-bar">
                <div class="metric-bar-inner" id="intensityBar"></div>
              </div>
            </div>

            <div class="metric">
              <div class="metric-label">Continuity</div>
              <div class="metric-value" id="continuityVal">TM×BM = 0.00</div>
              <div class="metric-bar">
                <div class="metric-bar-inner" id="continuityBar"></div>
              </div>
            </div>
          </div>

          <div class="field-label" style="margin-top:7px;">Emotional category</div>
          <div class="output-box" id="categoryBox">
            Waiting for analysis …
          </div>

          <div class="field-label" style="margin-top:7px;">Reactor explanation</div>
          <div class="output-box" id="explanationBox">
            When you type something and press “Compute Emotional Output (E₀)”, the system:
            1) detects polarity (positive vs negative), 2) estimates intensity, 3) combines TM (this moment) with BM (your stored traces), subtracts decay D, and 4) applies Faith, System and Truth Resonance lenses before producing E₀.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= RIGHT: MEMORY · CHAT ================= -->
  <div class="side-card">
    <div class="side-inner">
      <div class="side-header">
        <span>Conversation &amp; Continuity Trace</span>
        <span class="badge">TM · BM Recorder</span>
      </div>

      <div class="chat-log" id="chatLog">
        <!-- Chat entries will be appended here -->
      </div>

      <div class="memory-row">
        <div>
          <div class="memory-title">Temporary Memory (TM)</div>
          <div class="memory-box" id="tmBox">
Last user input &amp; recent emotional snapshot will appear here.
          </div>
        </div>
        <div>
          <div class="memory-title">Bold Memory (BM)</div>
          <div class="memory-box" id="bmBox">
Core identity traces, seeds and long-term continuity notes are stored here.
          </div>
        </div>
      </div>

      <div class="side-footer">
        <span>
          E₀ is a living output: <span class="strong">continuity + ethics + truth resonance</span>.
        </span>
        <button id="btnClear">
          Clear TM / Chat (keep BM)
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===================== CORE LOGIC SCRIPT ===================== -->
<script>
  // SIMPLE INTERNAL STATE
  const state = {
    tmValue: 0.0,   // numeric TM strength
    bmValue: 0.5,   // numeric BM strength (seeded)
    decay: 0.05,    // global decay factor D
    lambdaFaith: 0.0,
    lambdaSys: 0.0,
    lambdaTRC: 0.0,
    polarity: 0.0,  // -1 to +1
    intensity: 0.0, // 0 to 1
    category: "Unknown",
    e0: 0.0,
    bmText: "Core identity traces, seeds and long-term continuity notes are stored here.\n"
  };

  const userInputEl      = document.getElementById("userInput");
  const tmStatusEl       = document.getElementById("tm-status");
  const statusLineEl     = document.getElementById("statusLine");
  const polarityValEl    = document.getElementById("polarityVal");
  const intensityValEl   = document.getElementById("intensityVal");
  const continuityValEl  = document.getElementById("continuityVal");
  const categoryBoxEl    = document.getElementById("categoryBox");
  const explanationBoxEl = document.getElementById("explanationBox");
  const e0LabelEl        = document.getElementById("e0Label");

  const polarityBarEl    = document.getElementById("polarityBar");
  const intensityBarEl   = document.getElementById("intensityBar");
  const continuityBarEl  = document.getElementById("continuityBar");

  const tmBoxEl          = document.getElementById("tmBox");
  const bmBoxEl          = document.getElementById("bmBox");
  const chatLogEl        = document.getElementById("chatLog");

  const chkUseLLM        = document.getElementById("chkUseLLM");
  const chkFaithLens     = document.getElementById("chkFaithLens");

  const btnCompute       = document.getElementById("btnCompute");
  const btnLLM           = document.getElementById("btnLLM");
  const btnSeed          = document.getElementById("btnSeed");
  const btnClear         = document.getElementById("btnClear");

  // ====== BASIC TEXT → EMOTION HEURISTICS (FALLBACK WITHOUT LLM) ======
  function simpleHeuristicAnalysis(text) {
    const t = text.toLowerCase();
    if (!t.trim()) {
      return {
        polarity: 0.0,
        intensity: 0.0,
        category: "Neutral / Empty",
        tm: 0.0
      };
    }

    const positiveWords = ["happy","love","excited","hopeful","grateful","great","good","wonderful","calm","confident","proud","inspired"];
    const negativeWords = ["sad","tired","angry","upset","anxious","hate","depressed","worried","scared","fear","frustrated","hopeless"];

    let score = 0;
    let absScore = 0;

    for (const w of positiveWords) {
      if (t.includes(w)) { score += 1; absScore += 1; }
    }
    for (const w of negativeWords) {
      if (t.includes(w)) { score -= 1; absScore += 1; }
    }

    let polarity = 0.0;
    if (score > 0) polarity = Math.min(1, score / 4);
    else if (score < 0) polarity = Math.max(-1, score / 4);

    // intensity ~ how emotional the text is
    const lengthFactor = Math.min(1, t.length / 200);
    const intensity = Math.min(1, 0.5 * lengthFactor + 0.5 * (absScore / 4));

    let category = "Neutral / Mixed";
    if (polarity > 0.2) {
      category = intensity > 0.6 ? "Strongly positive" : "Gently positive";
    } else if (polarity < -0.2) {
      category = intensity > 0.6 ? "Strongly negative" : "Gently negative";
    }

    // TM magnitude can depend on intensity + recency heuristics
    const tm = 0.3 + 0.7 * intensity; // 0.3–1.0

    return { polarity, intensity, category, tm };
  }

  // ====== OPTIONAL LLM HOOK (OFFLINE / ONLINE) ======
  async function analyzeWithLLM(text) {
    // IMPORTANT:
    // - Yahan sirf placeholder / demo behavior hai.
    // - Aap yahan apna real offline LLM ya API call inject kar sakte hain.
    //
    // Example (pseudo):
    // const result = await localLLM.analyze(text);
    // return { polarity: result.polarity, intensity: result.intensity, ... }

    // For now, we fall back to the same heuristic, but mark it in explanation.
    const heuristic = simpleHeuristicAnalysis(text);
    heuristic.category += " (LLM hook placeholder)";
    return heuristic;
  }

  // ====== GRAND EQUATION CALCULATION ======
  function computeE0FromState() {
    const { tmValue, bmValue, decay, polarity, intensity } = state;

    // Faith + Sys lens if enabled
    if (chkFaithLens.checked) {
      state.lambdaFaith = 0.1 * polarity; // positive if positive emotion
      state.lambdaSys   = 0.05;           // small safety baseline
    } else {
      state.lambdaFaith = 0.0;
      state.lambdaSys   = 0.0;
    }

    // Truth resonance: we approximate as "alignment between content length and intensity"
    state.lambdaTRC = 0.05 * intensity;

    const continuity = tmValue * bmValue;
    const raw = (continuity) - decay + state.lambdaFaith + state.lambdaSys + state.lambdaTRC;

    const e0 = Math.tanh(raw);
    state.e0 = e0;

    return { continuity, e0, raw };
  }

  // ====== UI UPDATES ======
  function updateMetricBars(continuity) {
    const pol = state.polarity;   // -1 to 1
    const polAbs = Math.abs(pol);
    const polWidth = Math.round(polAbs * 100);
    polarityBarEl.style.width = polWidth + "%";
    if (pol < 0) polarityBarEl.classList.add("neg");
    else polarityBarEl.classList.remove("neg");

    const intWidth = Math.round(state.intensity * 100);
    intensityBarEl.style.width = intWidth + "%";

    const contNorm = Math.min(1, Math.max(0, continuity));
    const contWidth = Math.round(contNorm * 100);
    continuityBarEl.style.width = contWidth + "%";
  }

  function appendChat(role, text, meta) {
    const entry = document.createElement("div");
    entry.className = "chat-entry " + (role === "user" ? "user" : "aura");

    const metaDiv = document.createElement("div");
    metaDiv.className = "chat-meta";
    metaDiv.innerHTML = `
      <span>${role === "user" ? "User" : "AURA-X Ω"}</span>
      <span>${meta || ""}</span>
    `;

    const textDiv = document.createElement("div");
    textDiv.className = "chat-text";
    textDiv.textContent = text;

    entry.appendChild(metaDiv);
    entry.appendChild(textDiv);

    chatLogEl.appendChild(entry);
    chatLogEl.scrollTop = chatLogEl.scrollHeight;
  }

  // ====== Q&A: BASIC IDENTITY RESPONSES ======
  function tryAnswerDirectQA(text) {
    const t = text.trim().toLowerCase();

    // "How are you" family
    if (
      t === "how are you" ||
      t === "how are you?" ||
      t.includes("how are you feeling") ||
      t.includes("how is your day") ||
      t === "how are u" ||
      t === "how r u"
    ) {
      return "I am quite fine today. How about you?";
    }

    // Name
    if (t.includes("what is your name") || t.includes("what's your name") || t === "who are you?") {
      return "I am AURA-X Ω, an Artificial Unified Resonance Architecture for emotional continuity.";
    }

    // Creator
    if (t.includes("who created you")) {
      return "I am conceptually created by Alim ul Haq from Pakistan.";
    }

    // Emotional continuity definition
    if (t.includes("what is emotional continuity") || t.includes("emotional continuity kya") || t.includes("emotional continuity?")) {
      return "Emotional continuity means that I remember how feelings evolve over time, not just one message at a time. TM and BM work together so that my emotional trajectory remains stable, ethical, and consistent across long conversations.";
    }

    return null;
  }

  // ====== MAIN COMPUTE HANDLER ======
  async function handleCompute(useLLMFirst = false) {
    const text = userInputEl.value || "";
    if (!text.trim()) {
      statusLineEl.innerHTML = 'Status: <span class="bad">Please type something first.</span>';
      return;
    }

    tmStatusEl.textContent = "TM: capturing frish input …";
    tmBoxEl.textContent = text;

    appendChat("user", text, "Frish input → TM");

    // Step 1: if Q&A direct answer possible:
    const direct = tryAnswerDirectQA(text);
    if (direct) {
      appendChat("aura", direct, "Direct identity / continuity answer");
      explanationBoxEl.textContent =
        "This answer came from AURA-X Ω identity layer (BM/Q&A seed), without using an LLM. " +
        "The emotional analysis still uses the same TM/BM equation.";
    }

    // Step 2: Emotional analysis (LLM optional)
    let analysis;
    if (useLLMFirst && chkUseLLM.checked) {
      statusLineEl.innerHTML = 'Status: <span class="ok">Analyzing via LLM hook (placeholder) …</span>';
      analysis = await analyzeWithLLM(text);
    } else {
      statusLineEl.innerHTML = 'Status: <span class="ok">Analyzing via built-in heuristic …</span>';
      analysis = simpleHeuristicAnalysis(text);
    }

    state.polarity  = analysis.polarity;
    state.intensity = analysis.intensity;
    state.category  = analysis.category;
    state.tmValue   = analysis.tm;

    // Lightly update BM from emotional intensity (BM grows slowly)
    state.bmValue = Math.min(1.0, Math.max(0.2, state.bmValue + 0.15 * state.intensity - 0.03));

    const { continuity, e0, raw } = computeE0FromState();

    // Update UI
    polarityValEl.textContent  =
      (state.polarity > 0 ? "Positive " : state.polarity < 0 ? "Negative " : "Neutral ") +
      "(" + state.polarity.toFixed(2) + ")";
    intensityValEl.textContent = state.intensity.toFixed(2);
    continuityValEl.textContent = "TM×BM = " + continuity.toFixed(2);
    e0LabelEl.textContent = "E₀ = " + e0.toFixed(2);

    updateMetricBars(continuity);

    categoryBoxEl.textContent = state.category;
    explanationBoxEl.textContent =
      "TM was set to " + state.tmValue.toFixed(2) +
      " based on your current emotional intensity; BM is " + state.bmValue.toFixed(2) +
      ".\nContinuity (TM×BM) = " + continuity.toFixed(2) +
      ", Decay D = " + state.decay.toFixed(2) +
      ", λ_faith = " + state.lambdaFaith.toFixed(2) +
      ", λ_sys = " + state.lambdaSys.toFixed(2) +
      ", λ_trc = " + state.lambdaTRC.toFixed(2) +
      ".\nRaw signal = " + raw.toFixed(2) +
      ", so after tanh we get E₀ = " + e0.toFixed(2) +
      " (bounded between −1 and +1).";

    statusLineEl.innerHTML = 'Status: <span class="ok">E₀ computed successfully.</span>';
    tmStatusEl.textContent = "TM: active";

    appendChat(
      "aura",
      "Polarity: " + polarityValEl.textContent +
      " · Intensity: " + state.intensity.toFixed(2) +
      " · Category: " + state.category +
      " · E₀ = " + e0.toFixed(2),
      "Emotional reactor"
    );
  }

  // ====== SEED TO BM HANDLER ======
  function handleSeedToBM() {
    const text = userInputEl.value || "";
    if (!text.trim()) {
      statusLineEl.innerHTML = 'Status: <span class="bad">Nothing to add to BM. Type something first.</span>';
      return;
    }
    state.bmText += "- " + text + "\n";
    bmBoxEl.textContent = state.bmText;
    state.bmValue = Math.min(1.0, state.bmValue + 0.1);
    statusLineEl.innerHTML = 'Status: <span class="ok">Seed added to BM. BM continuity slightly increased.</span>';
    appendChat("aura", "I stored this as a long-term trace in BM.", "BM update");
  }

  // ====== CLEAR TM / CHAT (KEEP BM) ======
  function handleClearTM() {
    chatLogEl.innerHTML = "";
    tmBoxEl.textContent =
      "Last user input & recent emotional snapshot will appear here.";
    userInputEl.value = "";
    state.tmValue = 0.0;
    state.polarity = 0.0;
    state.intensity = 0.0;
    state.e0 = 0.0;
    tmStatusEl.textContent = "TM: idle";
    polarityValEl.textContent  = "Neutral (0.00)";
    intensityValEl.textContent = "0.00";
    continuityValEl.textContent = "TM×BM = 0.00";
    e0LabelEl.textContent = "E₀ = 0.00";
    polarityBarEl.style.width   = "0%";
    intensityBarEl.style.width  = "0%";
    continuityBarEl.style.width = "0%";
    categoryBoxEl.textContent   = "Waiting for analysis …";
    explanationBoxEl.textContent =
      "TM is cleared but BM (identity layer) is preserved. " +
      "You can continue the conversation and E₀ will keep evolving.";
    statusLineEl.innerHTML = 'Status: <span class="warn">TM cleared, BM preserved.</span>';
  }

  // ====== EVENT LISTENERS ======
  btnCompute.addEventListener("click", () => handleCompute(false));
  btnLLM.addEventListener("click", () => handleCompute(true));
  btnSeed.addEventListener("click", handleSeedToBM);
  btnClear.addEventListener("click", handleClearTM);

  userInputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleCompute(false);
    }
  });

  // INITIAL STATE
  statusLineEl.innerHTML = 'Status: <span class="warn">Waiting for input …</span>';
</script>
</body>
</html>