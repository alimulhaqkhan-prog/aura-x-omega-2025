<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Î© â€“ Masterpiece Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Offline LLM package (WebLLM, future use â€“ safe stub for now) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: radial-gradient(circle at 0% 0%, #0b1120 0, #020617 45%, #000 100%);
      --card-bg: rgba(15, 23, 42, 0.96);
      --card-border: rgba(148, 163, 184, 0.3);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.18);
      --accent-strong: rgba(56, 189, 248, 0.4);
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #fb7185;
      --success: #22c55e;
      --shadow-soft: 0 24px 80px rgba(15, 23, 42, 0.9);
      --radius-xl: 1.5rem;
    }

    body.theme-light {
      --bg: radial-gradient(circle at 0% 0%, #e5e7eb 0, #f9fafb 45%, #e5e7eb 100%);
      --card-bg: rgba(255, 255, 255, 0.98);
      --card-border: rgba(148, 163, 184, 0.6);
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.12);
      --accent-strong: rgba(37, 99, 235, 0.25);
      --text-main: #0f172a;
      --text-soft: #6b7280;
      --shadow-soft: 0 20px 60px rgba(15, 23, 42, 0.25);
    }

    body.theme-metallic {
      --bg: radial-gradient(circle at 0% 0%, #020617 0, #111827 40%, #020617 100%);
      --card-bg: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(31,41,55,0.98));
      --card-border: linear-gradient(120deg, rgba(148,163,184,0.7), rgba(75,85,99,0.4));
      --accent: #fbbf24;
      --accent-soft: rgba(251, 191, 36, 0.14);
      --accent-strong: rgba(251, 191, 36, 0.32);
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --shadow-soft: 0 26px 80px rgba(15, 23, 42, 0.96);
    }

    body {
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 1100px;
      margin: auto;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(28px);
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      border: 1px solid transparent;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .app-shell::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      padding: 1px;
      background: radial-gradient(circle at 0 0, var(--accent-strong), transparent 55%);
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      mask-composite: exclude;
      pointer-events: none;
    }

    .top-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.28);
      background: radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.14), transparent 55%);
    }

    .icon-button {
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      color: var(--text-main);
      width: 38px;
      height: 38px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.15s ease-out;
    }

    .icon-button:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      transform: translateY(-1px);
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      min-width: 0;
    }

    .app-title {
      font-size: 1.2rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .app-title span.badge {
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 0.63rem;
      text-transform: uppercase;
      border: 1px solid var(--accent-strong);
      background: var(--accent-soft);
      color: var(--accent);
    }

    .app-subtitle {
      font-size: 0.76rem;
      color: var(--text-soft);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-chips {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      gap: 6px;
      max-width: 280px;
    }

    .chip {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.85);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .chip-label {
      color: var(--text-soft);
    }

    .chip-value {
      font-variant-numeric: tabular-nums;
      font-weight: 500;
    }

    .chip.energy {
      border-color: var(--accent-strong);
      background: var(--accent-soft);
    }

    .main-layout {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr);
      flex: 1;
      min-height: 0;
    }

    @media (min-width: 900px) {
      .main-layout {
        grid-template-columns: minmax(0, 2.3fr) minmax(260px, 1fr);
      }
    }

    .chat-panel {
      border-right: 1px solid rgba(148, 163, 184, 0.3);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    @media (max-width: 899px) {
      .chat-panel {
        border-right: none;
      }
    }

    .chat-history {
      flex: 1;
      min-height: 0;
      padding: 14px 16px 6px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    .msg-row {
      margin-bottom: 8px;
      display: flex;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .msg-bubble {
      max-width: 100%;
      padding: 8px 11px;
      border-radius: 12px;
      font-size: 0.86rem;
      line-height: 1.4;
      position: relative;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .msg-row.user .msg-bubble {
      background: linear-gradient(135deg, var(--accent), #4ade80);
      color: #0f172a;
      border-bottom-right-radius: 4px;
    }

    .msg-row.aura .msg-bubble {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      border-bottom-left-radius: 4px;
    }

    .msg-meta {
      display: flex;
      justify-content: flex-end;
      font-size: 0.66rem;
      color: var(--text-soft);
      margin-top: 1px;
      gap: 4px;
    }

    .msg-row.aura .msg-meta {
      justify-content: flex-start;
    }

    .chat-input-row {
      padding: 8px 10px 10px;
      border-top: 1px solid rgba(148, 163, 184, 0.35);
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: radial-gradient(circle at 50% 0%, rgba(15,23,42,0.9), rgba(15,23,42,0.7));
    }

    .chat-input-inner {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    #userInput {
      flex: 1;
      resize: none;
      min-height: 48px;
      max-height: 120px;
      border-radius: 999px;
      padding: 9px 12px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 0.86rem;
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      outline: none;
      line-height: 1.4;
    }

    body.theme-light #userInput {
      background: rgba(249, 250, 251, 0.98);
    }

    #userInput::placeholder {
      color: var(--text-soft);
    }

    .chat-buttons {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .pill-button {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.2), rgba(15, 23, 42, 0.96));
      padding: 6px 10px;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      color: var(--text-main);
      cursor: pointer;
      min-width: 40px;
      transition: all 0.12s ease-out;
    }

    .pill-button span.label {
      display: none;
    }

    @media (min-width: 480px) {
      .pill-button span.label {
        display: inline;
      }
    }

    .pill-button.primary {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .pill-button:hover {
      transform: translateY(-0.5px);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .learn-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.72rem;
      color: var(--text-soft);
      gap: 8px;
      padding: 0 4px 2px;
    }

    .learn-row span {
      opacity: 0.9;
    }

    .learn-actions {
      display: flex;
      gap: 4px;
    }

    .tiny-button {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 0.7rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.92);
      color: var(--text-main);
      cursor: pointer;
    }

    .tiny-button.ok {
      border-color: var(--success);
      color: var(--success);
    }

    .tiny-button.bad {
      border-color: var(--danger);
      color: var(--danger);
    }

    .side-panel {
      display: none;
      flex-direction: column;
      padding: 10px 10px 12px;
      gap: 8px;
      min-height: 0;
    }

    @media (min-width: 900px) {
      .side-panel {
        display: flex;
      }
    }

    .side-card {
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.96);
      padding: 8px 10px 9px;
      font-size: 0.78rem;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 0;
    }

    body.theme-light .side-card {
      background: rgba(249, 250, 251, 0.96);
    }

    .side-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 2px;
    }

    .side-card-title {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
    }

    .pill-tag {
      border-radius: 999px;
      padding: 2px 6px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-size: 0.65rem;
      color: var(--accent);
    }

    .side-card-body {
      font-size: 0.76rem;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 0;
    }

    .side-list {
      list-style: none;
      max-height: 120px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .side-list li {
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid transparent;
      margin-bottom: 3px;
      cursor: default;
    }

    .side-list li span.date {
      font-size: 0.64rem;
      color: var(--text-soft);
      display: block;
    }

    .side-list li span.text {
      font-size: 0.74rem;
      color: var(--text-main);
    }

    .side-list li.highlight {
      border-color: var(--accent-strong);
      background: var(--accent-soft);
    }

    .field-row {
      display: flex;
      gap: 4px;
      margin-bottom: 4px;
    }

    .field-row input,
    .field-row textarea,
    .field-row select {
      width: 100%;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      font-size: 0.74rem;
      padding: 4px 6px;
      outline: none;
      resize: vertical;
    }

    body.theme-light .field-row input,
    body.theme-light .field-row textarea,
    body.theme-light .field-row select {
      background: rgba(249, 250, 251, 0.98);
    }

    .field-row textarea {
      min-height: 40px;
    }

    .field-label {
      font-size: 0.7rem;
      color: var(--text-soft);
      margin-bottom: 2px;
    }

    .options-panel {
      position: absolute;
      inset: 0 auto auto 0;
      left: 10px;
      top: 56px;
      width: min(320px, 92vw);
      z-index: 30;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.98);
      backdrop-filter: blur(26px);
      padding: 9px 10px 10px;
      box-shadow: 0 22px 70px rgba(15, 23, 42, 0.95);
    }

    body.theme-light .options-panel {
      background: rgba(255, 255, 255, 0.98);
    }

    .options-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .options-title {
      font-size: 0.78rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
    }

    .opt-btn {
      font-size: 0.7rem;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      padding: 6px 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      cursor: pointer;
      text-align: center;
      min-height: 52px;
      transition: all 0.12s ease-out;
    }

    .opt-btn span.icon {
      font-size: 1.1rem;
    }

    .opt-btn span.label {
      font-size: 0.68rem;
    }

    .opt-btn:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      transform: translateY(-1px);
    }

    .hidden {
      display: none !important;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      z-index: 40;
      background: rgba(15, 23, 42, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px;
    }

    .modal {
      width: 100%;
      max-width: 480px;
      max-height: 90vh;
      border-radius: 18px;
      background: rgba(15, 23, 42, 0.98);
      border: 1px solid rgba(148, 163, 184, 0.5);
      box-shadow: 0 24px 80px rgba(15, 23, 42, 0.95);
      display: flex;
      flex-direction: column;
      padding: 10px 12px 12px;
      font-size: 0.8rem;
    }

    body.theme-light .modal {
      background: rgba(255, 255, 255, 0.99);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .modal-title {
      font-size: 0.82rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .modal-body {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding-right: 4px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .modal-footer {
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    .badge-chip {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      padding: 2px 8px;
      font-size: 0.68rem;
      display: inline-flex;
      gap: 4px;
      align-items: center;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .slider-row label {
      flex: 0 0 70px;
      font-size: 0.74rem;
      color: var(--text-soft);
    }

    .slider-row input[type="range"] {
      flex: 1;
    }

    .slider-row span.value {
      width: 30px;
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-size: 0.72rem;
    }

    .readme-list {
      padding-left: 16px;
    }

    .readme-list li {
      margin-bottom: 4px;
    }

    .note-text {
      font-size: 0.72rem;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .code-inline {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.74rem;
      background: rgba(15, 23, 42, 0.92);
      padding: 2px 4px;
      border-radius: 6px;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    body.theme-light .code-inline {
      background: rgba(243, 244, 246, 0.98);
    }
  </style>
</head>
<body class="theme-cosmic">
  <div class="app-shell">
    <header class="top-bar">
      <button class="icon-button" id="btnOptions" title="Quick Controls">
        â˜°
      </button>

      <div class="title-block">
        <div class="app-title">
          AURA-X Î©
          <span class="badge">OFFLINE PROTOTYPE</span>
        </div>
        <div class="app-subtitle">
          Artificial Emotional Continuity Â· TM Ã— BM Â· Faith Lens Â· Self-Learning
        </div>
      </div>

      <div class="status-chips">
        <div class="chip">
          <span class="chip-label">TM</span>
          <span class="chip-value" id="chipTM">0.00</span>
        </div>
        <div class="chip">
          <span class="chip-label">BM</span>
          <span class="chip-value" id="chipBM">0.00</span>
        </div>
        <div class="chip energy">
          <span class="chip-label">Eâ‚€</span>
          <span class="chip-value" id="chipE">0.00</span>
        </div>
        <div class="chip">
          <span class="chip-label">Continuity</span>
          <span class="chip-value" id="chipCont">0%</span>
        </div>
      </div>
    </header>

    <div class="main-layout">
      <!-- CHAT PANEL -->
      <section class="chat-panel">
        <div id="chatHistory" class="chat-history">
          <!-- No default messages â€“ pure conversation space -->
        </div>

        <div class="chat-input-row">
          <div class="learn-row">
            <span>Last answer quality:</span>
            <div class="learn-actions">
              <button class="tiny-button ok" id="btnMarkCorrect">Correct âœ“</button>
              <button class="tiny-button bad" id="btnMarkIncorrect">Incorrect âœ•</button>
            </div>
          </div>

          <div class="chat-input-inner">
            <textarea id="userInput" placeholder="Ask Aura X Î© anythingâ€¦"></textarea>
            <div class="chat-buttons">
              <button class="pill-button primary" id="btnSend">
                âž¤ <span class="label">Send</span>
              </button>
              <button class="pill-button" id="btnSpeak">
                ðŸ”Š <span class="label">Voice</span>
              </button>
            </div>
          </div>

          <div class="note-text">
            Tip: First answer comes from Seed & Learned Intelligence. If nothing matches, Aura will ask you to teach it.
          </div>
        </div>
      </section>

      <!-- SIDE PANEL (DESKTOP) -->
      <aside class="side-panel">
        <!-- Identity -->
        <div class="side-card">
          <div class="side-card-header">
            <div class="side-card-title">Identity Snapshot</div>
            <span class="pill-tag">USER DNA</span>
          </div>
          <div class="side-card-body">
            <div class="field-label">Name Â· Role</div>
            <div id="identityNameRole">Not set yet</div>

            <div class="field-label">Core Intent</div>
            <div id="identityIntent" class="note-text">
              Open Identity panel from Quick Controls to configure your deep profile.
            </div>
          </div>
        </div>

        <!-- BM overview -->
        <div class="side-card">
          <div class="side-card-header">
            <div class="side-card-title">Bold Memory</div>
            <span class="pill-tag" id="bmCountTag">0 items</span>
          </div>
          <div class="side-card-body">
            <ul class="side-list" id="bmList">
              <!-- BM items preview -->
            </ul>
          </div>
        </div>

        <!-- Recent pings -->
        <div class="side-card">
          <div class="side-card-header">
            <div class="side-card-title">Recent Pings</div>
            <span class="pill-tag">LAST 60 MIN</span>
          </div>
          <div class="side-card-body">
            <ul class="side-list" id="pingList">
              <!-- Short summary of last few messages -->
            </ul>
          </div>
        </div>
      </aside>
    </div>

    <!-- QUICK CONTROLS PANEL -->
    <div class="options-panel hidden" id="optionsPanel">
      <div class="options-header">
        <div class="options-title">Quick Controls</div>
        <button class="tiny-button" id="btnCloseOptions">Close</button>
      </div>
      <div class="options-grid">
        <button class="opt-btn" data-action="history">
          <span class="icon">ðŸ•’</span>
          <span class="label">Conversation</span>
        </button>
        <button class="opt-btn" data-action="bm">
          <span class="icon">ðŸ§ </span>
          <span class="label">BM Recall</span>
        </button>
        <button class="opt-btn" data-action="seed">
          <span class="icon">ðŸŒ±</span>
          <span class="label">Feed the Seed</span>
        </button>
        <button class="opt-btn" data-action="identity">
          <span class="icon">ðŸªª</span>
          <span class="label">Identity</span>
        </button>
        <button class="opt-btn" data-action="faith">
          <span class="icon">âœ¨</span>
          <span class="label">Faith Lens</span>
        </button>
        <button class="opt-btn" data-action="themes">
          <span class="icon">ðŸŽ¨</span>
          <span class="label">Themes</span>
        </button>
        <button class="opt-btn" data-action="readme">
          <span class="icon">ðŸ“–</span>
          <span class="label">Read Me</span>
        </button>
        <button class="opt-btn" data-action="purge">
          <span class="icon">ðŸ§¹</span>
          <span class="label">Decay Now</span>
        </button>
        <button class="opt-btn" data-action="export">
          <span class="icon">ðŸ“¦</span>
          <span class="label">Export JSON</span>
        </button>
      </div>
    </div>
  </div>

  <!-- MODALS ROOT (created dynamically) -->
  <div id="modalRoot"></div>

  <script>
    // ===== AURA-X Î© MASTERPIECE CORE =====

    // --- Storage keys ---
    const STORAGE_KEYS = {
      CHAT: "aura_chat_v3",
      BM: "aura_bm_v3",
      LEARNED: "aura_learned_v3",
      IDENTITY: "aura_identity_v3",
      FAITH: "aura_faith_v3",
      THEME: "aura_theme_v3"
    };

    // --- Seed Knowledge (short, clean, extend later) ---
    const seedKnowledge = [
      {
        patterns: ["hi", "hello", "hey", "salam", "assalam"],
        answer:
          "Hello, I am AURA-X Î© â€“ an offline emotional continuity engine created by Alim ul Haq. How can we think together today?"
      },
      {
        patterns: ["who created you", "who made you", "who is your creator"],
        answer:
          "I was designed and imagined by Alim ul Haq (Investor Point Research Cell â€“ Timergara, Pakistan) as part of the Emotional Continuity / AURA-X Î© experiments."
      },
      {
        patterns: ["who are you", "what are you"],
        answer:
          "I am AURA-X Î©, an Artificial Emotional Intelligence prototype. My core job is to keep continuity between your Temporary Memory (TM) and Bold Memory (BM) with minimal decay."
      },
      {
        patterns: ["what is tm", "temporary memory"],
        answer:
          "TM (Temporary Memory) is the short-lived layer of your experience: the last moments, the current context, what just happened in this conversation. It decays fast unless promoted into BM."
      },
      {
        patterns: ["what is bm", "bold memory", "bold memories"],
        answer:
          "BM (Bold Memory) holds the episodes that matter: lessons, decisions, emotional checkpoints. In AURA-X Î©, BM is stored explicitly and can be recalled by date or theme."
      },
      {
        patterns: ["what is continuity", "life continuity", "emotional continuity"],
        answer:
          "Continuity here means your story doesnâ€™t restart every time. AURA-X Î© tries to connect your present (TM) with your stored episodes (BM) so your life feels like a single ongoing narrative."
      }
    ];

    // --- Runtime state ---
    let chatHistory = [];
    let boldMemory = [];
    let learnedPairs = [];
    let identity = null;
    let faithParams = { lambdaFaith: 0.5, lambdaSys: 0.5, lambdaTrc: 0.5 };
    let lastAuraAnswer = null;
    let lastUserQuestion = null;

    const DECAY_MS = 48 * 60 * 60 * 1000; // 48 hours

    // --- DOM references ---
    const chatHistoryEl = document.getElementById("chatHistory");
    const userInputEl = document.getElementById("userInput");
    const btnSend = document.getElementById("btnSend");
    const btnSpeak = document.getElementById("btnSpeak");
    const btnMarkCorrect = document.getElementById("btnMarkCorrect");
    const btnMarkIncorrect = document.getElementById("btnMarkIncorrect");

    const chipTM = document.getElementById("chipTM");
    const chipBM = document.getElementById("chipBM");
    const chipE = document.getElementById("chipE");
    const chipCont = document.getElementById("chipCont");

    const btnOptions = document.getElementById("btnOptions");
    const optionsPanel = document.getElementById("optionsPanel");
    const btnCloseOptions = document.getElementById("btnCloseOptions");

    const bmListEl = document.getElementById("bmList");
    const bmCountTag = document.getElementById("bmCountTag");
    const pingListEl = document.getElementById("pingList");
    const identityNameRoleEl = document.getElementById("identityNameRole");
    const identityIntentEl = document.getElementById("identityIntent");
    const modalRoot = document.getElementById("modalRoot");

    // ===== Util functions =====
    function saveJSON(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (e) {
        console.warn("LocalStorage save error", key, e);
      }
    }

    function loadJSON(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch (e) {
        console.warn("LocalStorage load error", key, e);
        return fallback;
      }
    }

    function nowTs() {
      return Date.now();
    }

    function fmtTime(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function fmtDate(ts) {
      const d = new Date(ts);
      return d.toLocaleDateString([], { year: "numeric", month: "short", day: "numeric" });
    }

    function softIncludes(text, pattern) {
      const t = text.toLowerCase();
      const p = pattern.toLowerCase();
      return t.includes(p);
    }

    function clamp01(x) {
      return Math.max(0, Math.min(1, x));
    }

    function tanh(x) {
      const e2x = Math.exp(2 * x);
      return (e2x - 1) / (e2x + 1);
    }

    // ===== Modal helpers =====
    function closeAllModals() {
      modalRoot.innerHTML = "";
    }

    function showModal({ id, title, bodyBuilder, footerBuilder }) {
      closeAllModals();
      const backdrop = document.createElement("div");
      backdrop.className = "modal-backdrop";
      backdrop.dataset.modalId = id;

      const modal = document.createElement("div");
      modal.className = "modal";

      const header = document.createElement("div");
      header.className = "modal-header";
      const hTitle = document.createElement("div");
      hTitle.className = "modal-title";
      hTitle.textContent = title;
      const btnX = document.createElement("button");
      btnX.className = "tiny-button";
      btnX.textContent = "Close";
      btnX.addEventListener("click", closeAllModals);
      header.appendChild(hTitle);
      header.appendChild(btnX);

      const body = document.createElement("div");
      body.className = "modal-body";
      if (bodyBuilder) bodyBuilder(body);

      const footer = document.createElement("div");
      footer.className = "modal-footer";
      if (footerBuilder) footerBuilder(footer);

      modal.appendChild(header);
      modal.appendChild(body);
      modal.appendChild(footer);
      backdrop.appendChild(modal);

      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) closeAllModals();
      });

      modalRoot.appendChild(backdrop);
    }

    // ===== TM / BM / E0 computation =====
    function recomputeMetrics() {
      const now = nowTs();
      const last60 = chatHistory.filter((m) => now - m.ts <= 60 * 60 * 1000);
      const tmScore = clamp01(last60.length / 16); // heuristic

      const bmItems = boldMemory.length;
      const bmScore = clamp01(bmItems / 24); // heuristic

      const oldest = chatHistory.length ? chatHistory[0].ts : now;
      const lifeSpanHours = (now - oldest) / (60 * 60 * 1000);
      const decayFactor = clamp01(lifeSpanHours / 48); // reaches 1 when 48h span

      const lf = faithParams.lambdaFaith || 0;
      const ls = faithParams.lambdaSys || 0;
      const lt = faithParams.lambdaTrc || 0;

      const raw = tmScore * bmScore - decayFactor + lf + ls + lt;
      const e0 = tanh(raw);

      chipTM.textContent = tmScore.toFixed(2);
      chipBM.textContent = bmScore.toFixed(2);
      chipE.textContent = e0.toFixed(2);

      const continuity = clamp01((tmScore + bmScore) / 2) * 100;
      chipCont.textContent = continuity.toFixed(0) + "%";
    }

    function applyDecay() {
      const now = nowTs();
      const before = chatHistory.length;
      chatHistory = chatHistory.filter((m) => !m.locked && now - m.ts <= DECAY_MS);
      if (chatHistory.length !== before) {
        saveJSON(STORAGE_KEYS.CHAT, chatHistory);
      }
      recomputeMetrics();
      renderChat();
      renderPings();
    }

    // ===== Rendering =====
    function renderChat() {
      chatHistoryEl.innerHTML = "";
      chatHistory.forEach((msg) => {
        const row = document.createElement("div");
        row.className = "msg-row " + (msg.role === "user" ? "user" : "aura");

        const bubble = document.createElement("div");
        bubble.className = "msg-bubble";
        bubble.textContent = msg.text;

        const meta = document.createElement("div");
        meta.className = "msg-meta";
        const who = document.createElement("span");
        who.textContent = msg.role === "user" ? "You" : "Aura X Î©";
        const when = document.createElement("span");
        when.textContent = fmtTime(msg.ts);
        meta.appendChild(who);
        meta.appendChild(when);

        row.appendChild(bubble);
        row.appendChild(meta);
        chatHistoryEl.appendChild(row);
      });

      chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
    }

    function renderBM() {
      bmListEl.innerHTML = "";
      boldMemory
        .slice()
        .sort((a, b) => b.ts - a.ts)
        .slice(0, 20)
        .forEach((item, idx) => {
          const li = document.createElement("li");
          if (idx === 0) li.classList.add("highlight");
          const dateSpan = document.createElement("span");
          dateSpan.className = "date";
          dateSpan.textContent = fmtDate(item.ts);
          const textSpan = document.createElement("span");
          textSpan.className = "text";
          textSpan.textContent = item.summary;
          li.appendChild(dateSpan);
          li.appendChild(textSpan);
          bmListEl.appendChild(li);
        });

      bmCountTag.textContent = boldMemory.length + " items";
    }

    function renderPings() {
      const now = nowTs();
      pingListEl.innerHTML = "";
      chatHistory
        .filter((m) => now - m.ts <= 60 * 60 * 1000)
        .slice(-20)
        .reverse()
        .forEach((m) => {
          const li = document.createElement("li");
          const dateSpan = document.createElement("span");
          dateSpan.className = "date";
          dateSpan.textContent = fmtTime(m.ts);
          const textSpan = document.createElement("span");
          textSpan.className = "text";
          textSpan.textContent =
            (m.role === "user" ? "You: " : "Aura: ") + (m.text.length > 64 ? m.text.slice(0, 64) + "â€¦" : m.text);
          li.appendChild(dateSpan);
          li.appendChild(textSpan);
          pingListEl.appendChild(li);
        });
    }

    function renderIdentity() {
      if (!identity) {
        identityNameRoleEl.textContent = "Not set yet";
        identityIntentEl.textContent = "Open Identity panel from Quick Controls to configure your deep profile.";
        return;
      }
      const name = identity.name || "Unknown";
      const role = identity.role || "Human";
      identityNameRoleEl.textContent = name + " Â· " + role;
      identityIntentEl.textContent = identity.intent || "No core intent configured yet.";
    }

    // ===== Chat & learning =====
    function addMessage(role, text, extra = {}) {
      const msg = {
        role,
        text,
        ts: nowTs(),
        locked: !!extra.locked
      };
      chatHistory.push(msg);
      saveJSON(STORAGE_KEYS.CHAT, chatHistory);
      renderChat();
      renderPings();
      recomputeMetrics();
      return msg;
    }

    function findInSeed(userText) {
      const text = userText.toLowerCase();
      for (const item of seedKnowledge) {
        for (const pattern of item.patterns) {
          if (softIncludes(text, pattern)) {
            return item.answer;
          }
        }
      }
      return null;
    }

    function findInLearned(userText) {
      const text = userText.toLowerCase();
      for (const item of learnedPairs) {
        if (softIncludes(text, item.q.toLowerCase())) {
          return item.a;
        }
      }
      return null;
    }

    async function tryOfflineLLM(userText) {
      // SAFE STUB:
      // Here you can plug WebLLM when you are ready.
      // For now we return null so that the engine falls back to a friendly â€œteach meâ€ answer.
      // Example when you are ready (pseudo):
      // const engine = await window.webllm.CreateMLCEngine("gemma-2-2b-it-q4f16_1-MLC", { ... });
      // const reply = await engine.chat.completions.create({ messages: [...], stream: false });
      // return reply.choices[0].message.content;
      return null;
    }

    async function generateAuraAnswer(userText) {
      const fromSeed = findInSeed(userText);
      if (fromSeed) {
        return { source: "seed", text: fromSeed };
      }

      const fromLearned = findInLearned(userText);
      if (fromLearned) {
        return { source: "learned", text: fromLearned };
      }

      const fromLLM = await tryOfflineLLM(userText);
      if (fromLLM) {
        return { source: "offline-llm", text: fromLLM };
      }

      const generic =
        "I do not have a precise answer for this yet.\n\n" +
        "If you want, mark my answer as Incorrect and then teach me the correct response â€“ I will store it as Learned Intelligence for similar questions.";
      return { source: "fallback", text: generic };
    }

    async function handleSend() {
      const text = userInputEl.value.trim();
      if (!text) return;
      userInputEl.value = "";
      userInputEl.style.height = "48px";

      lastUserQuestion = text;
      addMessage("user", text);

      const aura = await generateAuraAnswer(text);
      lastAuraAnswer = aura.text;

      const taggedText =
        aura.text +
        "\n\n" +
        "[source: " +
        aura.source.toUpperCase() +
        (aura.source === "fallback" ? " Â· ready to learn" : "") +
        "]";
      addMessage("aura", taggedText);
    }

    function handleSpeak() {
      if (!lastAuraAnswer) return;
      if (!("speechSynthesis" in window)) {
        alert("Speech synthesis is not supported in this browser.");
        return;
      }
      const utter = new SpeechSynthesisUtterance(lastAuraAnswer);
      utter.lang = "en-US";
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    function handleMarkCorrect() {
      if (!lastUserQuestion || !lastAuraAnswer) return;
      // Optionally we could store as learned as well
      alert("Noted as correct. This will help you trust the current seed/intelligence more.");
    }

    function handleMarkIncorrect() {
      if (!lastUserQuestion) {
        alert("Ask something first, then you can mark the answer as incorrect.");
        return;
      }
      // Ask for correct answer inside a modal
      showModal({
        id: "teachModal",
        title: "Teach Aura X Î©",
        bodyBuilder: (body) => {
          const p = document.createElement("p");
          p.textContent =
            "You marked the last answer as incorrect. Please provide the correct answer for this question:";
          body.appendChild(p);

          const qLabel = document.createElement("div");
          qLabel.className = "field-label";
          qLabel.textContent = "Question";
          body.appendChild(qLabel);

          const qText = document.createElement("div");
          qText.className = "code-inline";
          qText.textContent = lastUserQuestion;
          body.appendChild(qText);

          const aLabel = document.createElement("div");
          aLabel.className = "field-label";
          aLabel.textContent = "Correct answer";
          body.appendChild(aLabel);

          const row = document.createElement("div");
          row.className = "field-row";
          const textarea = document.createElement("textarea");
          textarea.placeholder = "Type the correct answer hereâ€¦";
          row.appendChild(textarea);
          body.appendChild(row);

          body.dataset.answerFieldId = "teachArea"; // marker
          textarea.id = "teachArea";
        },
        footerBuilder: (footer) => {
          const btnCancel = document.createElement("button");
          btnCancel.className = "tiny-button";
          btnCancel.textContent = "Cancel";
          btnCancel.addEventListener("click", closeAllModals);

          const btnSave = document.createElement("button");
          btnSave.className = "tiny-button ok";
          btnSave.textContent = "Save";
          btnSave.addEventListener("click", () => {
            const ta = document.getElementById("teachArea");
            const ans = ta ? ta.value.trim() : "";
            if (!ans) {
              alert("Please enter the correct answer first.");
              return;
            }
            learnedPairs.push({ q: lastUserQuestion, a: ans, ts: nowTs() });
            saveJSON(STORAGE_KEYS.LEARNED, learnedPairs);
            closeAllModals();
            alert("Saved. Next time a similar question appears, Aura will use your taught answer first.");
          });

          footer.appendChild(btnCancel);
          footer.appendChild(btnSave);
        }
      });
    }

    // ===== Quick Controls actions =====
    function openConversationModal() {
      showModal({
        id: "history",
        title: "Conversation History (Decays after 48h)",
        bodyBuilder: (body) => {
          if (!chatHistory.length) {
            const p = document.createElement("p");
            p.textContent = "No messages yet. Start a conversation first.";
            body.appendChild(p);
            return;
          }
          chatHistory
            .slice()
            .reverse()
            .forEach((m) => {
              const block = document.createElement("div");
              block.style.marginBottom = "6px";

              const head = document.createElement("div");
              head.className = "field-label";
              head.textContent = (m.role === "user" ? "You" : "Aura") + " Â· " + fmtDate(m.ts) + " " + fmtTime(m.ts);
              block.appendChild(head);

              const text = document.createElement("div");
              text.textContent = m.text;
              block.appendChild(text);

              body.appendChild(block);
            });
        }
      });
    }

    function openBMModal() {
      showModal({
        id: "bm",
        title: "Bold Memory Recall",
        bodyBuilder: (body) => {
          if (!boldMemory.length) {
            const p = document.createElement("p");
            p.textContent = "No Bold Memories yet. Use Feed the Seed to promote something into BM.";
            body.appendChild(p);
            return;
          }

          const grouped = {};
          boldMemory.forEach((item) => {
            const d = fmtDate(item.ts);
            grouped[d] = grouped[d] || [];
            grouped[d].push(item);
          });

          Object.keys(grouped)
            .sort((a, b) => new Date(b) - new Date(a))
            .forEach((d) => {
              const h = document.createElement("div");
              h.className = "field-label";
              h.textContent = d;
              body.appendChild(h);

              grouped[d].forEach((item) => {
                const block = document.createElement("div");
                block.style.marginBottom = "4px";
                const tag = document.createElement("span");
                tag.className = "badge-chip";
                tag.textContent = item.tag || "Episode";
                const txt = document.createElement("span");
                txt.style.display = "block";
                txt.style.marginTop = "2px";
                txt.textContent = item.summary;
                block.appendChild(tag);
                block.appendChild(txt);
                body.appendChild(block);
              });
            });
        }
      });
    }

    function openSeedModal() {
      showModal({
        id: "seed",
        title: "Feed the Seed",
        bodyBuilder: (body) => {
          const p = document.createElement("p");
          p.textContent = "Create a Bold Memory + Learned Q&A from your own insight or episode.";
          body.appendChild(p);

          const l1 = document.createElement("div");
          l1.className = "field-label";
          l1.textContent = "Summary (will appear in BM list)";
          body.appendChild(l1);
          const row1 = document.createElement("div");
          row1.className = "field-row";
          const t1 = document.createElement("textarea");
          t1.id = "seedSummary";
          t1.placeholder = "Example: Realized that continuity is more important than perfection.";
          row1.appendChild(t1);
          body.appendChild(row1);

          const l2 = document.createElement("div");
          l2.className = "field-label";
          l2.textContent = "Optional tag (e.g. FAITH, BUSINESS, HEALTH)";
          body.appendChild(l2);
          const row2 = document.createElement("div");
          row2.className = "field-row";
          const t2 = document.createElement("input");
          t2.id = "seedTag";
          t2.placeholder = "Tag";
          row2.appendChild(t2);
          body.appendChild(row2);

          const l3 = document.createElement("div");
          l3.className = "field-label";
          l3.textContent = "Question form (so Aura can recall this as Q&A)";
          body.appendChild(l3);
          const row3 = document.createElement("div");
          row3.className = "field-row";
          const t3 = document.createElement("textarea");
          t3.id = "seedQ";
          t3.placeholder = "Example: What did I learn about continuity vs perfection?";
          row3.appendChild(t3);
          body.appendChild(row3);

          const l4 = document.createElement("div");
          l4.className = "field-label";
          l4.textContent = "Answer form (exact wording you want Aura to use)";
          body.appendChild(l4);
          const row4 = document.createElement("div");
          row4.className = "field-row";
          const t4 = document.createElement("textarea");
          t4.id = "seedA";
          t4.placeholder = "Type the answer you want Aura to giveâ€¦";
          row4.appendChild(t4);
          body.appendChild(row4);
        },
        footerBuilder: (footer) => {
          const btnCancel = document.createElement("button");
          btnCancel.className = "tiny-button";
          btnCancel.textContent = "Cancel";
          btnCancel.addEventListener("click", closeAllModals);

          const btnSave = document.createElement("button");
          btnSave.className = "tiny-button ok";
          btnSave.textContent = "Save Seed";
          btnSave.addEventListener("click", () => {
            const summary = document.getElementById("seedSummary").value.trim();
            const tag = document.getElementById("seedTag").value.trim();
            const q = document.getElementById("seedQ").value.trim();
            const a = document.getElementById("seedA").value.trim();
            if (!summary) {
              alert("Summary is required.");
              return;
            }
            boldMemory.push({ summary, tag, ts: nowTs(), locked: true });
            saveJSON(STORAGE_KEYS.BM, boldMemory);

            if (q && a) {
              learnedPairs.push({ q, a, ts: nowTs() });
              saveJSON(STORAGE_KEYS.LEARNED, learnedPairs);
            }

            closeAllModals();
            renderBM();
            recomputeMetrics();
            alert("Saved into Bold Memory" + (q && a ? " and Learned Intelligence." : "."));
          });

          footer.appendChild(btnCancel);
          footer.appendChild(btnSave);
        }
      });
    }

    function openIdentityModal() {
      showModal({
        id: "identity",
        title: "Deep Profiling â€“ Identity",
        bodyBuilder: (body) => {
          const current = identity || {};
          const section = document.createElement("div");
          section.innerHTML =
            "<p>Basic identity + emotional orientation. This is not a CV â€“ it is your internal profile for AURA-X Î©.</p>";
          body.appendChild(section);

          const fields = [
            ["Name", "name", "Your name as you want it storedâ€¦"],
            ["Primary role", "role", "Example: AI Researcher Â· Builder Â· Teacher"],
            ["Core intent", "intent", "Why are you talking to Aura? Long-term purposeâ€¦"],
            ["Biggest fear", "fear", "Optional, emotional vulnerability pointâ€¦"],
            ["North-star project", "project", "Your main project / dream Aura should align withâ€¦"]
          ];

          fields.forEach(([label, key, placeholder]) => {
            const l = document.createElement("div");
            l.className = "field-label";
            l.textContent = label;
            body.appendChild(l);
            const row = document.createElement("div");
            row.className = "field-row";
            const el = document.createElement(key === "name" || key === "role" ? "input" : "textarea");
            el.id = "id_" + key;
            el.placeholder = placeholder;
            el.value = current[key] || "";
            row.appendChild(el);
            body.appendChild(row);
          });
        },
        footerBuilder: (footer) => {
          const btnCancel = document.createElement("button");
          btnCancel.className = "tiny-button";
          btnCancel.textContent = "Cancel";
          btnCancel.addEventListener("click", closeAllModals);

          const btnSave = document.createElement("button");
          btnSave.className = "tiny-button ok";
          btnSave.textContent = "Save Identity";
          btnSave.addEventListener("click", () => {
            identity = {
              name: document.getElementById("id_name").value.trim(),
              role: document.getElementById("id_role").value.trim(),
              intent: document.getElementById("id_intent").value.trim(),
              fear: document.getElementById("id_fear").value.trim(),
              project: document.getElementById("id_project").value.trim(),
              ts: nowTs()
            };
            saveJSON(STORAGE_KEYS.IDENTITY, identity);
            renderIdentity();
            closeAllModals();
          });

          footer.appendChild(btnCancel);
          footer.appendChild(btnSave);
        }
      });
    }

    function openFaithModal() {
      showModal({
        id: "faith",
        title: "Faith / System / Truth Resonance (Î» parameters)",
        bodyBuilder: (body) => {
          const p = document.createElement("p");
          p.textContent =
            "These sliders influence the emotional energy Eâ‚€ = tanh((TM Ã— BM) âˆ’ D + Î»_faith + Î»_sys + Î»_trc). They do not change the text of answers, but they affect the continuity indicators.";
          body.appendChild(p);

          const params = [
            ["Î»_faith", "lambdaFaith"],
            ["Î»_sys", "lambdaSys"],
            ["Î»_trc", "lambdaTrc"]
          ];

          params.forEach(([label, key]) => {
            const row = document.createElement("div");
            row.className = "slider-row";
            const lbl = document.createElement("label");
            lbl.textContent = label;
            const slider = document.createElement("input");
            slider.type = "range";
            slider.min = "-1";
            slider.max = "1";
            slider.step = "0.1";
            slider.value = faithParams[key] ?? 0;
            slider.id = "faith_" + key;
            const valSpan = document.createElement("span");
            valSpan.className = "value";
            valSpan.textContent = slider.value;
            slider.addEventListener("input", () => {
              valSpan.textContent = slider.value;
            });
            row.appendChild(lbl);
            row.appendChild(slider);
            row.appendChild(valSpan);
            body.appendChild(row);
          });
        },
        footerBuilder: (footer) => {
          const btnCancel = document.createElement("button");
          btnCancel.className = "tiny-button";
          btnCancel.textContent = "Cancel";
          btnCancel.addEventListener("click", closeAllModals);

          const btnSave = document.createElement("button");
          btnSave.className = "tiny-button ok";
          btnSave.textContent = "Apply";
          btnSave.addEventListener("click", () => {
            faithParams = {
              lambdaFaith: parseFloat(document.getElementById("faith_lambdaFaith").value),
              lambdaSys: parseFloat(document.getElementById("faith_lambdaSys").value),
              lambdaTrc: parseFloat(document.getElementById("faith_lambdaTrc").value)
            };
            saveJSON(STORAGE_KEYS.FAITH, faithParams);
            closeAllModals();
            recomputeMetrics();
          });

          footer.appendChild(btnCancel);
          footer.appendChild(btnSave);
        }
      });
    }

    function openThemesModal() {
      showModal({
        id: "themes",
        title: "UI Themes",
        bodyBuilder: (body) => {
          const p = document.createElement("p");
          p.textContent = "Choose how Aura X Î© feels visually. Only colors change â€“ logic stays the same.";
          body.appendChild(p);

          const row = document.createElement("div");
          row.style.display = "flex";
          row.style.gap = "6px";
          row.style.marginTop = "6px";

          const themes = [
            ["Cosmic", "theme-cosmic"],
            ["Light", "theme-light"],
            ["Metallic", "theme-metallic"]
          ];

          themes.forEach(([label, cls]) => {
            const btn = document.createElement("button");
            btn.className = "tiny-button";
            btn.textContent = label;
            btn.addEventListener("click", () => {
              setTheme(cls);
            });
            row.appendChild(btn);
          });

          body.appendChild(row);
        }
      });
    }

    function openReadmeModal() {
      showModal({
        id: "readme",
        title: "AURA-X Î© Prototype â€“ How to use",
        bodyBuilder: (body) => {
          const ul = document.createElement("ul");
          ul.className = "readme-list";
          const points = [
            "Type in the chat box to start a conversation. No system message is shown â€“ it is just you and Aura.",
            "Aura answers from Seed Knowledge first, then from Learned Intelligence (things you taught it).",
            "If an answer is wrong, press Incorrect and teach the correct answer. Aura will remember it for similar questions.",
            "Use Feed the Seed to save important episodes into Bold Memory (BM) + optional Q&A.",
            "Conversation history decays automatically after ~48 hours unless explicitly locked.",
            "Use Identity panel to define who you are, your intent, fears, and north-star project.",
            "Faith Lens sliders only influence the Eâ‚€ / continuity metrics â€“ not the literal text output.",
            "Themes only change color style. Logic, formula and learning remain exactly the same.",
            "WebLLM hook is already wired as a safe stub â€“ you can later connect a real model in tryOfflineLLM()."
          ];
          points.forEach((t) => {
            const li = document.createElement("li");
            li.textContent = t;
            ul.appendChild(li);
          });
          body.appendChild(ul);
        }
      });
    }

    function handleExport() {
      const payload = {
        chat: chatHistory,
        boldMemory,
        learnedPairs,
        identity,
        faithParams
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "aura-x-omega-export.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    // ===== Themes =====
    function setTheme(cls) {
      document.body.className = cls;
      saveJSON(STORAGE_KEYS.THEME, { theme: cls });
    }

    // ===== Event wiring =====
    btnSend.addEventListener("click", handleSend);
    btnSpeak.addEventListener("click", handleSpeak);
    btnMarkCorrect.addEventListener("click", handleMarkCorrect);
    btnMarkIncorrect.addEventListener("click", handleMarkIncorrect);

    userInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    userInputEl.addEventListener("input", () => {
      userInputEl.style.height = "auto";
      userInputEl.style.height = Math.min(userInputEl.scrollHeight, 120) + "px";
    });

    btnOptions.addEventListener("click", () => {
      optionsPanel.classList.toggle("hidden");
    });

    btnCloseOptions.addEventListener("click", () => {
      optionsPanel.classList.add("hidden");
    });

    optionsPanel.addEventListener("click", (e) => {
      const btn = e.target.closest(".opt-btn");
      if (!btn) return;
      const action = btn.dataset.action;
      if (action === "history") openConversationModal();
      else if (action === "bm") openBMModal();
      else if (action === "seed") openSeedModal();
      else if (action === "identity") openIdentityModal();
      else if (action === "faith") openFaithModal();
      else if (action === "themes") openThemesModal();
      else if (action === "readme") openReadmeModal();
      else if (action === "purge") {
        if (confirm("Apply decay to conversation history now? (BM and Learned Intelligence are not deleted)")) {
          applyDecay();
        }
      } else if (action === "export") {
        handleExport();
      }
    });

    document.addEventListener("click", (e) => {
      if (
        !optionsPanel.classList.contains("hidden") &&
        !optionsPanel.contains(e.target) &&
        e.target !== btnOptions
      ) {
        optionsPanel.classList.add("hidden");
      }
    });

    // ===== Initial load =====
    function init() {
      chatHistory = loadJSON(STORAGE_KEYS.CHAT, []);
      boldMemory = loadJSON(STORAGE_KEYS.BM, []);
      learnedPairs = loadJSON(STORAGE_KEYS.LEARNED, []);
      identity = loadJSON(STORAGE_KEYS.IDENTITY, null);
      faithParams = loadJSON(STORAGE_KEYS.FAITH, { lambdaFaith: 0.5, lambdaSys: 0.5, lambdaTrc: 0.5 });

      const themeData = loadJSON(STORAGE_KEYS.THEME, null);
      if (themeData && themeData.theme) {
        document.body.className = themeData.theme;
      }

      applyDecay(); // also recomputes metrics + renders chat
      renderBM();
      renderIdentity();
      renderPings();
    }

    init();
  </script>
</body>
</html>