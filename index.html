<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Emotional Continuity Engine (Prototype)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Optional offline LLM (WebLLM). Fails silently if not supported -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    :root{
      --bg:#020617;
      --bg-soft:#02081b;
      --card:#020617;
      --card-soft:#02081b;
      --card-soft-2:#02091e;
      --accent:#0ea5e9;
      --accent-2:#38bdf8;
      --accent-soft:#0ea5e933;
      --accent-strong:#0ea5e9;
      --text-main:#e5e7eb;
      --text-soft:#9ca3af;
      --text-softer:#6b7280;
      --border-soft:#1f2937;
      --danger:#ef4444;
      --shadow-soft:0 22px 45px rgba(0,0,0,0.7);
      --radius-xl:24px;
      --radius-lg:18px;
      --radius-md:14px;
      --radius-pill:999px;
    }

    *{box-sizing:border-box;margin:0;padding:0;}

    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 15% 0%, #0f172a 0, transparent 55%),
        radial-gradient(circle at 85% 0%, #0ea5e9 0, transparent 50%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:var(--text-main);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:20px 10px 40px;
    }

    .shell{
      width:100%;
      max-width:1120px;
      background:radial-gradient(circle at top left,#0b1220 0,rgba(15,23,42,0.85) 42%,#020617 80%);
      border-radius:32px;
      box-shadow:var(--shadow-soft);
      padding:20px 16px 24px;
      border:1px solid rgba(148,163,184,0.35);
      position:relative;
      overflow:hidden;
    }

    .shell::before{
      content:"";
      position:absolute;
      right:-80px;
      top:-40px;
      width:220px;
      height:220px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#e0f2fe 0,#38bdf8 35%,#0369a1 75%,transparent 100%);
      opacity:0.92;
      filter:blur(1px);
      box-shadow:0 0 45px rgba(56,189,248,0.85);
      pointer-events:none;
    }

    .shell-inner{
      position:relative;
      z-index:2;
    }

    .top-row{
      display:flex;
      gap:18px;
      align-items:flex-start;
      flex-wrap:wrap;
    }

    .hero-card{
      flex:1.4;
      min-width:260px;
      background:radial-gradient(circle at top,#0f172a 0,#020617 65%);
      border-radius:var(--radius-xl);
      padding:20px 18px 18px;
      border:1px solid rgba(148,163,184,0.55);
      box-shadow:0 18px 40px rgba(15,23,42,0.9);
      position:relative;
      overflow:hidden;
    }

    .hero-title{
      font-size:1.9rem;
      letter-spacing:0.18em;
      font-weight:700;
      color:#e0f2fe;
    }
    .hero-title span{
      color:var(--accent-2);
    }

    .hero-sub{
      margin-top:6px;
      font-size:0.96rem;
      color:var(--text-soft);
    }
    .hero-sub b{color:#e5e7eb;}

    .hero-ethic{
      margin-top:18px;
      padding:14px 14px 13px;
      border-radius:18px;
      border:1px solid rgba(250,250,250,0.22);
      background:linear-gradient(135deg,#020617,#020617 40%,#02081b 100%);
      font-size:0.86rem;
      color:#fef9c3;
      line-height:1.44;
    }

    .hero-ethic-title{
      font-size:0.82rem;
      font-weight:600;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:#fde68a;
      margin-bottom:4px;
    }

    .hero-main-button{
      margin-top:14px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:11px 22px;
      border-radius:999px;
      border:none;
      background:linear-gradient(120deg,#22c1c3,#0ea5e9,#38bdf8);
      color:white;
      font-size:0.84rem;
      letter-spacing:0.14em;
      text-transform:uppercase;
      font-weight:600;
      cursor:default;
      box-shadow:0 12px 28px rgba(56,189,248,0.55);
    }

    .hero-meta{
      margin-top:16px;
      display:flex;
      flex-wrap:wrap;
      gap:7px;
      font-size:0.75rem;
      color:var(--text-softer);
    }

    .hero-meta span{
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.55);
      background:radial-gradient(circle at top left,#020617 0,#02081b 60%);
    }

    .top-controls{
      flex:0 0 150px;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
      min-width:140px;
    }

    .options-btn{
      padding:9px 16px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:radial-gradient(circle at top left,#020617 0,#02081b 70%);
      color:#e5e7eb;
      font-size:0.82rem;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }

    .options-btn span.icon{
      width:18px;
      height:18px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.75rem;
    }

    .small-note{
      font-size:0.75rem;
      color:var(--text-softer);
      max-width:190px;
      text-align:right;
    }

    .main-grid{
      margin-top:18px;
      display:grid;
      grid-template-columns: minmax(0,0.9fr) minmax(0,1.1fr);
      gap:16px;
    }

    @media(max-width:880px){
      .main-grid{
        grid-template-columns:1fr;
      }
      .top-row{
        flex-direction:column;
      }
      .top-controls{
        align-items:flex-start;
      }
      .small-note{text-align:left;max-width:none;}
    }

    .card{
      background:radial-gradient(circle at top,#020617 0,#02081b 65%);
      border-radius:var(--radius-xl);
      border:1px solid rgba(148,163,184,0.5);
      padding:14px 14px 15px;
      box-shadow:0 18px 38px rgba(15,23,42,0.85);
      position:relative;
      overflow:hidden;
    }

    .card + .card{margin-top:12px;}

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }

    .card-title{
      font-size:0.9rem;
      letter-spacing:0.16em;
      text-transform:uppercase;
      color:#c7d2fe;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .card-title .icon-emoji{font-size:1.05rem;}

    .card-sub{
      font-size:0.8rem;
      color:var(--text-softer);
      margin-bottom:8px;
    }

    .metrics-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
      margin-top:4px;
    }

    .metric-box{
      padding:9px 10px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,0.5);
      background:radial-gradient(circle at top left,#020617 0,#02081b 65%);
      display:flex;
      flex-direction:column;
      gap:3px;
      min-height:62px;
    }

    .metric-label{
      font-size:0.72rem;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--text-softer);
    }

    .metric-value{
      font-size:1rem;
      font-weight:600;
      color:#e5e7eb;
    }

    .metric-hint{
      font-size:0.72rem;
      color:var(--text-softer);
    }

    .metric-tags{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:0.7rem;
    }

    .tag-pill{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      background:radial-gradient(circle at top left,#020617 0,#02081b 70%);
      color:var(--text-soft);
    }

    .bm-chart{
      margin-top:10px;
      height:110px;
      border-radius:18px;
      border:1px dashed rgba(148,163,184,0.65);
      background:radial-gradient(circle at top,#020617 0,#02081b 70%);
      padding:7px 10px;
      display:flex;
      align-items:flex-end;
      gap:2px;
      overflow:hidden;
    }
    .bm-bar{
      flex:1;
      border-radius:999px 999px 0 0;
      background:linear-gradient(to top,#0ea5e9,#22c55e);
      transform-origin:bottom;
      opacity:0.9;
    }

    .bm-footer{
      margin-top:6px;
      font-size:0.75rem;
      color:var(--text-softer);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .bm-footer button{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      background:radial-gradient(circle at top left,#020617 0,#02081b 70%);
      color:var(--text-soft);
      font-size:0.72rem;
      cursor:pointer;
    }

    .chat-card{
      background:radial-gradient(circle at top,#020617 0,#02081b 65%);
      border-radius:var(--radius-xl);
      border:1px solid rgba(148,163,184,0.55);
      padding:14px 14px 12px;
      box-shadow:0 18px 36px rgba(15,23,42,0.9);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .chat-header-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }

    .chat-sub{
      font-size:0.8rem;
      color:var(--text-softer);
    }

    .chat-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .btn-mini{
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:radial-gradient(circle at top left,#020617 0,#02081b 70%);
      color:var(--text-soft);
      font-size:0.72rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .btn-danger{
      border-color:rgba(248,113,113,0.9);
      color:#fecaca;
    }

    .chat-log{
      margin-top:6px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.6);
      background:radial-gradient(circle at top left,#020617 0,#02081b 75%);
      padding:10px 10px;
      max-height:260px;
      min-height:160px;
      overflow-y:auto;
      font-size:0.82rem;
    }

    .message{
      margin-bottom:8px;
      padding:7px 9px;
      border-radius:12px;
      background:rgba(15,23,42,0.85);
      border:1px solid rgba(148,163,184,0.4);
    }

    .message.user-message{
      background:rgba(15,23,42,0.6);
    }

    .message-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:0.74rem;
      margin-bottom:3px;
      color:var(--text-softer);
    }

    .msg-right{
      display:flex;
      gap:4px;
      align-items:center;
    }

    .voice-btn{
      border:none;
      background:none;
      cursor:pointer;
      font-size:0.86rem;
    }

    .message-content{
      font-size:0.82rem;
      color:var(--text-main);
      line-height:1.4;
      white-space:pre-wrap;
    }

    .typing-indicator{
      display:flex;
      align-items:center;
      gap:4px;
      margin-top:4px;
      font-size:0.76rem;
      color:var(--text-softer);
    }

    .typing-dot{
      width:5px;
      height:5px;
      border-radius:999px;
      background:var(--text-softer);
      animation:dotPulse 1s infinite ease-in-out;
    }
    .typing-dot:nth-child(2){animation-delay:0.16s;}
    .typing-dot:nth-child(3){animation-delay:0.32s;}
    @keyframes dotPulse{
      0%,80%,100%{transform:scale(0.7);opacity:0.3;}
      40%{transform:scale(1);opacity:0.9;}
    }

    .typing-text{margin-left:4px;}

    .chat-input-row{
      margin-top:8px;
      display:flex;
      gap:8px;
      align-items:flex-end;
    }

    .chat-input-row textarea{
      flex:1;
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.6);
      background:radial-gradient(circle at top left,#020617 0,#02081b 75%);
      color:var(--text-main);
      padding:9px 10px;
      font-size:0.84rem;
      resize:vertical;
      min-height:60px;
      max-height:140px;
    }

    .chat-input-row textarea::placeholder{
      color:var(--text-softer);
    }

    .chat-send-btn{
      flex:0 0 auto;
      border:none;
      border-radius:18px;
      padding:9px 16px;
      background:linear-gradient(120deg,#0ea5e9,#22c55e);
      color:white;
      font-weight:600;
      font-size:0.84rem;
      cursor:pointer;
      box-shadow:0 12px 26px rgba(34,197,94,0.55);
      display:flex;
      align-items:center;
      gap:5px;
    }

    .chat-send-btn:disabled{
      opacity:0.6;
      cursor:default;
      box-shadow:none;
    }

    .pipe-row{
      margin-top:14px;
      border-radius:var(--radius-lg);
      border:1px solid rgba(148,163,184,0.5);
      background:radial-gradient(circle at top left,#020617 0,#02081b 70%);
      padding:10px 12px;
      font-size:0.76rem;
      color:var(--text-softer);
      position:relative;
      overflow:hidden;
    }

    .pipe-row .formula{
      font-family:"SF Mono","JetBrains Mono",ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:0.78rem;
      color:#e5e7eb;
      margin-bottom:4px;
    }

    .pipe-row .pipe-text{
      font-size:0.75rem;
      color:var(--text-softer);
    }

    .pipe-row::after{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at left,rgba(56,189,248,0.15) 0,transparent 55%);
      opacity:0.7;
      pointer-events:none;
    }

    .footer-note{
      margin-top:10px;
      font-size:0.74rem;
      color:var(--text-softer);
    }

    /* Modals (same UI, cleaned) */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.8);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:30;
      padding:16px;
    }

    .modal-overlay.visible{display:flex;}

    .modal-card{
      width:100%;
      max-width:520px;
      border-radius:24px;
      background:radial-gradient(circle at top,#020617 0,#02081b 70%);
      border:1px solid rgba(148,163,184,0.75);
      padding:14px 14px 16px;
      box-shadow:0 20px 45px rgba(0,0,0,0.9);
      max-height:90vh;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
    }

    .modal-title{
      font-size:0.96rem;
      color:#e5e7eb;
      font-weight:600;
    }

    .modal-sub{
      font-size:0.75rem;
      color:var(--text-softer);
      margin-top:2px;
    }

    .modal-close{
      border:none;
      background:none;
      color:var(--text-soft);
      font-size:0.9rem;
      cursor:pointer;
    }

    .modal-body{
      font-size:0.8rem;
      color:var(--text-soft);
      overflow-y:auto;
      padding-right:4px;
    }

    .modal-section-title{
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:var(--text-soft);
      margin-top:8px;
      margin-bottom:4px;
    }

    .modal-search{
      width:100%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:radial-gradient(circle at top left,#020617 0,#02081b 70%);
      color:var(--text-main);
      padding:7px 10px;
      font-size:0.8rem;
      margin-bottom:6px;
    }

    .modal-search::placeholder{color:var(--text-softer);}

    .faith-note{
      font-size:0.75rem;
      color:#e5e7eb;
      margin-bottom:6px;
    }

    .offline-card{
      padding:8px 9px;
      border-radius:16px;
      border:1px dashed rgba(148,163,184,0.7);
      background:radial-gradient(circle at top left,#020617 0,#02081b 70%);
      margin-bottom:9px;
      font-size:0.78rem;
    }
    .offline-title{font-weight:600;font-size:0.78rem;color:#e5e7eb;margin-bottom:2px;}
    .offline-sub{font-size:0.74rem;color:var(--text-softer);}

    .offline-progress-bar{
      margin-top:6px;
      width:100%;
      height:6px;
      border-radius:999px;
      background:#020617;
      overflow:hidden;
      border:1px solid rgba(148,163,184,0.5);
    }
    .offline-progress-fill{
      height:100%;
      width:10%;
      border-radius:999px;
      background:linear-gradient(90deg,#0ea5e9,#22c55e);
      transition:width .25s ease-out;
    }
    .offline-status-line{
      margin-top:4px;
      font-size:0.73rem;
      color:var(--text-softer);
    }

    .recall-bubble{
      position:fixed;
      left:16px;
      bottom:20px;
      max-width:280px;
      background:radial-gradient(circle at top left,#020617 0,#02081b 70%);
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.8);
      padding:9px 11px;
      font-size:0.78rem;
      color:var(--text-main);
      box-shadow:0 16px 34px rgba(0,0,0,0.9);
      opacity:0;
      pointer-events:none;
      transform:translateY(15px);
      transition:opacity .25s ease-out,transform .25s ease-out;
      z-index:25;
    }
    .recall-bubble.visible{
      opacity:1;
      pointer-events:auto;
      transform:translateY(0);
    }
    .recall-title{
      font-size:0.76rem;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--text-soft);
      margin-bottom:4px;
    }
    .recall-meta{
      margin-top:4px;
      font-size:0.72rem;
      color:var(--text-softer);
    }
  </style>
</head>
<body>
<div class="shell">
  <div class="shell-inner">

    <!-- Top row -->
    <div class="top-row">
      <div class="hero-card">
        <div class="hero-title">AURA-X <span>Œ©</span></div>
        <div class="hero-sub">
          Offline emotional continuity engine (prototype).<br/>
          <b>TM = user inputs only.</b> Internal layers keep continuity & emotional trajectory.
        </div>
        <div class="hero-ethic">
          <div class="hero-ethic-title">Universal ethic</div>
          <div>
            Avoid actions that grow negative emotions in you or others.
            Move gently toward choices that increase shared positive feeling for everyone.
          </div>
        </div>
        <button class="hero-main-button">
          EMOTIONAL CONTINUITY ENGINE ACTIVE
        </button>
        <div class="hero-meta">
          <span>Dual-memory TM/BM resonance</span>
          <span>Optional helper LLM (online/offline)</span>
          <span>Small-talk never goes to BM</span>
        </div>
      </div>

      <div class="top-controls">
        <button id="optionsBtn" class="options-btn">
          <span class="icon">‚öôÔ∏è</span>
          <span>Options</span>
        </button>
        <div class="small-note">
          Faith & system filters stay local.
          All continuity layers live inside this browser only.
        </div>
      </div>
    </div>

    <!-- Main grid -->
    <div class="main-grid">

      <!-- Left column -->
      <div>
        <div class="card">
          <div class="card-header">
            <div class="card-title"><span class="icon-emoji">üß™</span>Emotional metrics</div>
          </div>
          <div class="card-sub">
            Internal state based on TM (your inputs) colliding with BM,
            Intelligence and optional helper LLM.
          </div>
          <div class="metrics-grid">
            <div class="metric-box">
              <div class="metric-label">Emotional state E‚ÇÄ</div>
              <div id="metricE0" class="metric-value">0.000</div>
              <div class="metric-hint">tanh-based, range [-1, +1]</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">TM activation (user only)</div>
              <div id="metricTM" class="metric-value">0.00</div>
              <div class="metric-hint">Recent user inputs (text/voice/docs)</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">BM resonance</div>
              <div id="metricBM" class="metric-value">0.00</div>
              <div class="metric-hint">Stored emotional events</div>
            </div>
            <div class="metric-box">
              <div class="metric-label">Continuity index</div>
              <div id="metricCI" class="metric-value">0.000</div>
              <div class="metric-hint">Stability of emotional trajectory</div>
            </div>
          </div>
          <div class="metric-tags">
            <span id="tagValence" class="tag-pill">VALENCE: neutral</span>
            <span id="tagArousal" class="tag-pill">AROUSAL: medium</span>
            <span id="tagReaction" class="tag-pill">REACTION: balanced</span>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="card-header">
            <div class="card-title"><span class="icon-emoji">üß†</span>Bold Memory layers (240)</div>
          </div>
          <div class="card-sub">
            Only story-level memories for future photo/video scenes.
          </div>
          <div id="bmChart" class="bm-chart"></div>
          <div class="bm-footer">
            <span id="bmStats">Active layers: 0/240 ¬∑ System idle</span>
            <button id="bmViewBtn">View BM / edit</button>
          </div>
        </div>
      </div>

      <!-- Right column: chat -->
      <div>
        <div class="chat-card">
          <div class="card-header chat-header-row">
            <div>
              <div class="card-title"><span class="icon-emoji">üí¨</span>Emotional continuity console</div>
              <div class="chat-sub">
                Offline-first ¬∑ TM = your inputs only. Small-talk never goes to BM.
              </div>
            </div>
            <div class="chat-buttons">
              <button id="historyBtn" class="btn-mini">Conversation history</button>
              <button id="seedBtn" class="btn-mini">Feed TM / Seed</button>
              <button id="llmBtn" class="btn-mini">LLM link</button>
            </div>
          </div>

          <div id="chatLog" class="chat-log"></div>

          <div class="chat-input-row">
            <textarea
              id="userInput"
              placeholder="Talk to AURA-X Œ©‚Ä¶ (TM = your inputs only, BM = long-term identity traces).">
            </textarea>
            <button id="sendBtn" class="chat-send-btn">
              <span>Send</span> ‚ûú
            </button>
          </div>
        </div>

        <div class="pipe-row">
          <div class="formula">
            E‚ÇÄ = tanh( (TM √ó (BM + Intel + LLM)) ‚àí D + Œª_faith + Œª_sys + Œª_trc )
          </div>
          <div class="pipe-text">
            Pipeline: TM (your inputs) ‚Üí optional helper LLM ‚Üí collide with BM & Intelligence ‚Üí
            full formula ‚Üí answer + updated emotional metrics.
          </div>
        </div>

        <div class="footer-note">
          E‚ÇÄ is a living output: continuity + ethics + truth resonance. System does not store raw secrets;
          only abstract emotional traces inside BM.
        </div>
      </div>
    </div>
  </div>

  <!-- Recall bubble -->
  <div id="recallBubble" class="recall-bubble">
    <div class="recall-title">BM resonance snapshot</div>
    <div id="recallBody"></div>
    <div id="recallMeta" class="recall-meta"></div>
  </div>
</div>

<!-- BM modal -->
<div id="bmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üß† Bold Memory recorder</div>
        <div class="modal-sub">
          Only identity-linked traces. Small-talk and random noise never appear here.
        </div>
      </div>
      <button class="modal-close" data-close="bmModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="modal-section-title">Recent BM entries</div>
      <div id="bmList" style="font-size:.78rem;color:#e5e7eb;"></div>
    </div>
  </div>
</div>

<!-- History modal -->
<div id="historyModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üìú Conversation & continuity trace</div>
        <div class="modal-sub">
          TM = chat log; BM = distilled events only. You can export or clear TM safely.
        </div>
      </div>
      <button class="modal-close" data-close="historyModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="historyContent" style="font-size:.78rem;color:#e5e7eb;white-space:pre-wrap;"></div>
      <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">
        <button id="exportHistoryBtn" class="btn-mini">Export TM</button>
        <button id="clearTMBtn" class="btn-mini btn-danger">Clear TM / chat (keep BM)</button>
      </div>
    </div>
  </div>
</div>

<!-- Seed / LaTeX modal -->
<div id="seedModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üîê Seed / identity trace</div>
        <div class="modal-sub">
          Parse LaTeX Q&A blocks into Intelligence nodes (no raw secrets; only behaviour / logic).
        </div>
      </div>
      <button class="modal-close" data-close="seedModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="seedPasswordStage">
        <p class="faith-note">
          This area is protected. Enter the offline password to continue.<br/>
          Demo password: <strong>6789</strong>.
        </p>
        <input id="seedPasswordInput" type="password" class="modal-search"
               placeholder="Password (default: 6789)">
        <div id="seedPasswordError"
             style="display:none;color:#fca5a5;font-size:.75rem;margin-top:4px;">
          Incorrect password. Try again.
        </div>
        <button id="seedPasswordBtn" class="btn-mini" style="margin-top:6px;">Unlock</button>
      </div>

      <div id="seedBlockStage" style="display:none;">
        <p class="faith-note">
          Paste a LaTeX block with <code>\item</code> questions and
          <code>\textbf{A:}</code> answers.<br/>
          Optional metadata at beginning of answer:
          <code>[polarity=positive; code=E031; intensity=0.8]</code>.
        </p>
        <textarea id="seedBlockInput" class="modal-search" style="min-height:120px;"
                  placeholder="Paste LaTeX conversation / logic block here."></textarea>
        <div id="seedBlockPreview"
             style="font-size:.74rem;color:#9ca3af;margin-top:4px;">
          Waiting for block‚Ä¶
        </div>
        <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">
          <button id="seedParseBtn" class="btn-mini">Parse block</button>
          <button id="seedSaveBtn" class="btn-mini" disabled>Save to seed</button>
          <button id="seedDiscardBtn" class="btn-mini btn-danger">Discard</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- LLM + offline engine modal -->
<div id="llmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">ü§ñ LLM link & offline engine</div>
        <div class="modal-sub">
          Password 6789 ¬∑ Keys stay inside this browser only.
        </div>
      </div>
      <button class="modal-close" data-close="llmModal">‚úï</button>
    </div>
    <div class="modal-body">

      <div id="llmLockStage">
        <p class="faith-note">
          Simple local password to avoid accidental key leaks.<br/>
          Demo password: <strong>6789</strong>.
        </p>
        <input id="llmPasswordInput" type="password" class="modal-search"
               placeholder="Enter password (6789)">
        <div id="llmPasswordError"
             style="display:none;color:#fca5a5;font-size:.75rem;margin-top:4px;">
          Wrong password. Try again.
        </div>
        <button id="llmUnlockBtn" class="btn-mini" style="margin-top:6px;">Unlock LLM settings</button>
      </div>

      <div id="llmConfigStage" style="display:none;">
        <div class="offline-card">
          <div class="offline-title">OFFLINE MODE: In-browser model (WebGPU).</div>
          <div class="offline-sub">
            Suggested demo: <strong>Llama-3.2-1B-Instruct</strong> (~1.3 GB, downloaded once, then runs fully offline).
          </div>
          <div class="offline-progress-bar">
            <div id="offlineProgressFill" class="offline-progress-fill"></div>
          </div>
          <div id="offlineProgressText" class="offline-status-line">
            Offline engine idle.
          </div>
          <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;">
            <button id="offlineLoadBtn" class="btn-mini">Load / wake offline model</button>
          </div>
        </div>

        <div class="modal-section-title">Online LLM (optional)</div>
        <input id="llmBaseUrl" class="modal-search"
               placeholder="Base URL (e.g. https://api.openai.com/v1/chat/completions)">
        <input id="llmModel" class="modal-search"
               placeholder="Model name (kept blank / generic by default)">
        <input id="llmApiKey" class="modal-search" type="password"
               placeholder="API key (stored only in this browser)">
        <div style="font-size:.74rem;color:#9ca3af;margin-bottom:6px;">
          This prototype posts <code>{ model, messages[] }</code> JSON to the URL above using
          <code>Authorization: Bearer &lt;key&gt;</code>. Use any compatible OpenAI-style API
          (OpenAI / xAI / DeepSeek etc.).
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          <button id="llmSaveBtn" class="btn-mini">Save config locally</button>
          <button id="llmClearBtn" class="btn-mini btn-danger">Clear stored key</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {

  class AuraXOmegaEngine {
    constructor(){
      // DOM
      this.chatContainer = document.getElementById("chatLog");
      this.userInput      = document.getElementById("userInput");
      this.sendBtn        = document.getElementById("sendBtn");

      this.metricE0  = document.getElementById("metricE0");
      this.metricTM  = document.getElementById("metricTM");
      this.metricBM  = document.getElementById("metricBM");
      this.metricCI  = document.getElementById("metricCI");
      this.tagValence = document.getElementById("tagValence");
      this.tagArousal = document.getElementById("tagArousal");
      this.tagReaction = document.getElementById("tagReaction");
      this.bmChart   = document.getElementById("bmChart");
      this.bmStats   = document.getElementById("bmStats");

      this.optionsBtn = document.getElementById("optionsBtn");
      this.bmViewBtn  = document.getElementById("bmViewBtn");
      this.historyBtn = document.getElementById("historyBtn");
      this.seedBtn    = document.getElementById("seedBtn");
      this.llmBtn     = document.getElementById("llmBtn");

      this.bmModal       = document.getElementById("bmModal");
      this.historyModal  = document.getElementById("historyModal");
      this.seedModal     = document.getElementById("seedModal");
      this.llmModal      = document.getElementById("llmModal");
      this.bmList        = document.getElementById("bmList");
      this.historyContent = document.getElementById("historyContent");

      this.exportHistoryBtn = document.getElementById("exportHistoryBtn");
      this.clearTMBtn       = document.getElementById("clearTMBtn");

      this.seedPasswordStage = document.getElementById("seedPasswordStage");
      this.seedBlockStage    = document.getElementById("seedBlockStage");
      this.seedPasswordInput = document.getElementById("seedPasswordInput");
      this.seedPasswordError = document.getElementById("seedPasswordError");
      this.seedPasswordBtn   = document.getElementById("seedPasswordBtn");
      this.seedBlockInput    = document.getElementById("seedBlockInput");
      this.seedBlockPreview  = document.getElementById("seedBlockPreview");
      this.seedParseBtn      = document.getElementById("seedParseBtn");
      this.seedSaveBtn       = document.getElementById("seedSaveBtn");
      this.seedDiscardBtn    = document.getElementById("seedDiscardBtn");

      this.llmPasswordInput  = document.getElementById("llmPasswordInput");
      this.llmPasswordError  = document.getElementById("llmPasswordError");
      this.llmUnlockBtn      = document.getElementById("llmUnlockBtn");
      this.llmLockStage      = document.getElementById("llmLockStage");
      this.llmConfigStage    = document.getElementById("llmConfigStage");
      this.llmBaseUrlInput   = document.getElementById("llmBaseUrl");
      this.llmModelInput     = document.getElementById("llmModel");
      this.llmKeyInput       = document.getElementById("llmApiKey");
      this.llmSaveBtn        = document.getElementById("llmSaveBtn");
      this.llmClearBtn       = document.getElementById("llmClearBtn");

      this.offlineLoadBtn     = document.getElementById("offlineLoadBtn");
      this.offlineProgressFill = document.getElementById("offlineProgressFill");
      this.offlineProgressText = document.getElementById("offlineProgressText");

      this.recallBubble = document.getElementById("recallBubble");
      this.recallBody   = document.getElementById("recallBody");
      this.recallMeta   = document.getElementById("recallMeta");

      // State
      this.tmHistory = [];   // {role:"user"/"ai", text, sentiment}
      this.bmEntries = [];   // {text,valence,intensity,category,emotionCode,timestampMs}
      this.intelNodes = [];  // parsed from LaTeX seed
      this.bmLayers  = Array.from({length:240}, () => 0.08 + Math.random()*0.12);
      this.e0 = 0;
      this.lastSentiment = {valence:0,intensity:0,category:"neutral"};
      this.lastResonance = 0.6;
      this.continuityIndex = 0.83;
      this.faithsSelected = [];   // for Œª_faith
      this.voiceOn = true;

      // LLM config
      this.llmConfig = { baseUrl:"", model:"", apiKey:"" };
      this.llmEnabled = false;
      this.offlineEngine = null;
      this.offlineLLMStatus = "idle"; // idle | loading | ready | error
      this.offlineProgress = 0;
      this.offlineProgressTextVal = "Offline engine idle.";

      this.seedParsedBlock = null;

      this.attachEvents();
      this.renderBMChart();
      this.loadLLMConfig();
      this.updateMetrics();
      this.addWelcomeMessage();
    }

    addWelcomeMessage(){
      this.addMessage(
        "ai",
        "I am AURA-X Œ©, an emotional continuity engine. Tell me how you feel or what happened, and I will respond while keeping a gentle long-term trajectory.",
        true,
        null,
        true
      );
    }

    attachEvents(){
      this.sendBtn.addEventListener("click", () => this.handleSend());
      this.userInput.addEventListener("keydown", e => {
        if(e.key === "Enter" && !e.shiftKey){
          e.preventDefault();
          this.handleSend();
        }
      });

      const closeButtons = document.querySelectorAll(".modal-close");
      closeButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-close");
          if(!id) return;
          const el = document.getElementById(id);
          if(el) el.classList.remove("visible");
        });
      });

      this.optionsBtn.addEventListener("click", () => {
        alert("Prototype options: use the three buttons on the right (History, Seed, LLM) to configure continuity and helper models. All data stays inside this browser.");
      });

      this.bmViewBtn.addEventListener("click", () => this.openBMModal());
      this.historyBtn.addEventListener("click", () => this.openHistoryModal());
      this.seedBtn.addEventListener("click", () => this.openSeedModal());
      this.llmBtn.addEventListener("click", () => this.openLLMModal());

      this.exportHistoryBtn.addEventListener("click", () => this.exportHistory());
      this.clearTMBtn.addEventListener("click", () => this.clearTM());

      this.seedPasswordBtn.addEventListener("click", () => this.unlockSeed());
      this.seedParseBtn.addEventListener("click", () => this.parseSeedBlock());
      this.seedSaveBtn.addEventListener("click", () => this.saveSeedBlock());
      this.seedDiscardBtn.addEventListener("click", () => this.discardSeedBlock());

      this.llmUnlockBtn.addEventListener("click", () => this.unlockLLM());
      this.llmSaveBtn.addEventListener("click", () => this.handleLLMSave());
      this.llmClearBtn.addEventListener("click", () => this.handleLLMClear());
      this.offlineLoadBtn.addEventListener("click", () => this.initOfflineLLM());
    }

    // ---------- Chat flow ----------

    async handleSend(){
      const text = (this.userInput.value || "").trim();
      if(!text) return;

      this.userInput.value = "";
      this.addMessage("user", text, false, null, true);
      this.tmHistory.push({role:"user",text});

      const smallTalk = this.isSmallTalk(text);
      const sentiment = this.analyzeSentiment(text);
      const tmOnly = sentiment;

      const typingId = this.showTyping();
      this.sendBtn.disabled = true;

      let llmAnswer = null;
      let intelAnswer = this.answerFromSeed(text);

      try{
        // Optional helper LLMs
        const [offlineAns, onlineAns] = await Promise.all([
          this.callOfflineLLM(text),
          this.callLLM(text)
        ]);
        llmAnswer = onlineAns || offlineAns || null;
      }catch(e){
        console.error("LLM error", e);
        llmAnswer = null;
      }

      // Compose final answer: TM -> Seed Intel -> LLM
      let finalAnswer = "";

      if(intelAnswer){
        finalAnswer = intelAnswer;
      }else if(llmAnswer){
        finalAnswer = llmAnswer;
      }else{
        finalAnswer = this.simpleRuleAnswer(text, sentiment);
      }

      // Update BM & metrics
      this.updateMemoryAndState(text, sentiment, smallTalk, llmAnswer || finalAnswer);
      this.updateMetrics();
      this.updateBMChartVisual();

      this.hideTyping(typingId);
      this.addMessage("ai", finalAnswer, true, sentiment);
      this.tmHistory.push({role:"ai",text:finalAnswer,sentiment});

      this.sendBtn.disabled = false;
      this.maybeShowRecallBubble(sentiment);
    }

    isSmallTalk(text){
      const t = text.toLowerCase();
      const smallWords = ["hi","hello","salam","salaam","how are you","what's up","kia hal","kya haal"];
      return smallWords.some(w => t.includes(w));
    }

    analyzeSentiment(text){
      const t = text.toLowerCase();
      const posWords = ["hope","grateful","happy","excited","alhamdulillah","confident","love","peace"];
      const negWords = ["tired","sad","afraid","angry","anxious","depressed","hopeless","stuck","lost"];

      let score = 0;
      for(const w of posWords) if(t.includes(w)) score += 1;
      for(const w of negWords) if(t.includes(w)) score -= 1;

      let valence = 0;
      if(score > 0) valence = Math.min(1, score/4);
      if(score < 0) valence = Math.max(-1, score/4);

      let intensity = Math.min(1, Math.max(0.1, Math.abs(valence) + (text.length/200)));
      let category = "neutral";
      if(valence > 0.25) category = "hope";
      if(valence < -0.25) category = "stress";

      return { valence, intensity, category };
    }

    simpleRuleAnswer(text, sentiment){
      const v = sentiment.valence;
      const cat = sentiment.category;
      if(cat === "hope" && v > 0.25){
        return "I can feel a hopeful and positive direction in what you said. Keep moving gently in that line; your emotional trajectory looks stable.";
      }
      if(cat === "stress" && v < -0.25){
        return "This feels heavy and stressful. I‚Äôm staying with you in it. Can you describe what is making it feel this intense, step by step, without rushing?";
      }
      return "I‚Äôm listening. Tell me a bit more about what this situation means for you, so I can keep the emotional continuity aligned with your values.";
    }

    textSimilarity(a,b){
      const aa = a.toLowerCase().split(/\W+/).filter(Boolean);
      const bb = b.toLowerCase().split(/\W+/).filter(Boolean);
      if(!aa.length || !bb.length) return 0;
      const setA = new Set(aa);
      const setB = new Set(bb);
      let inter = 0;
      for(const w of setA) if(setB.has(w)) inter++;
      const union = setA.size + setB.size - inter;
      return union ? inter/union : 0;
    }

    // ---------- Seed / Intelligence ----------

    answerFromSeed(text){
      if(!this.intelNodes.length) return null;
      let best = null;
      let bestScore = 0;
      this.intelNodes.forEach(node => {
        const sim = this.textSimilarity(text, node.question);
        if(sim > bestScore){
          bestScore = sim;
          best = node;
        }
      });
      if(best && bestScore > 0.32){
        return best.answer;
      }
      return null;
    }

    unlockSeed(){
      const pwd = (this.seedPasswordInput.value || "").trim();
      if(pwd !== "6789"){
        this.seedPasswordError.style.display = "block";
        return;
      }
      this.seedPasswordError.style.display = "none";
      this.seedPasswordStage.style.display = "none";
      this.seedBlockStage.style.display = "block";
    }

    parseSeedBlock(){
      const raw = (this.seedBlockInput.value || "").trim();
      if(!raw){
        this.seedBlockPreview.textContent = "Nothing to parse yet.";
        this.seedParsedBlock = null;
        this.seedSaveBtn.disabled = true;
        return;
      }
      const lines = raw.split(/\r?\n/);
      const qas = [];
      let currentQ = "";
      let currentA = "";

      for(const line of lines){
        const itemMatch = line.match(/\\item\s*(.*)/);
        if(itemMatch){
          if(currentQ && currentA){
            qas.push({q:currentQ.trim(),a:currentA.trim()});
          }
          currentQ = itemMatch[1] || "";
          currentA = "";
        }else if(line.includes("\\textbf{A:}")){
          const idx = line.indexOf("\\textbf{A:}");
          currentA += line.slice(idx + "\\textbf{A:}".length).trim() + " ";
        }else{
          currentA += line.trim() + " ";
        }
      }
      if(currentQ && currentA){
        qas.push({q:currentQ.trim(),a:currentA.trim()});
      }

      if(!qas.length){
        this.seedBlockPreview.textContent = "Could not detect any \\item / \\textbf{A:} pairs.";
        this.seedParsedBlock = null;
        this.seedSaveBtn.disabled = true;
        return;
      }

      this.seedParsedBlock = qas;
      this.seedSaveBtn.disabled = false;
      this.seedBlockPreview.textContent =
        `Parsed ${qas.length} Q&A pairs. They will be stored as Intelligence nodes only.`;
    }

    saveSeedBlock(){
      if(!this.seedParsedBlock) return;
      this.seedParsedBlock.forEach(item => {
        this.intelNodes.push({
          question:item.q,
          answer:item.a,
          meta:{source:"latex-seed"}
        });
      });
      this.seedParsedBlock = null;
      this.seedBlockInput.value = "";
      this.seedBlockPreview.textContent =
        `Saved. Total Intelligence nodes: ${this.intelNodes.length}.`;
      this.seedSaveBtn.disabled = true;
    }

    discardSeedBlock(){
      this.seedParsedBlock = null;
      this.seedBlockInput.value = "";
      this.seedBlockPreview.textContent = "Discarded current block.";
      this.seedSaveBtn.disabled = true;
    }

    // ---------- LLM config ----------

    unlockLLM(){
      const pwd = (this.llmPasswordInput.value || "").trim();
      if(pwd !== "6789"){
        this.llmPasswordError.style.display = "block";
        return;
      }
      this.llmPasswordError.style.display = "none";
      this.llmLockStage.style.display = "none";
      this.llmConfigStage.style.display = "block";
    }

    loadLLMConfig(){
      try{
        const raw = localStorage.getItem("aura_llm_cfg");
        if(!raw) return;
        const parsed = JSON.parse(raw);
        this.llmConfig = parsed || this.llmConfig;
        this.llmBaseUrlInput.value = this.llmConfig.baseUrl || "";
        this.llmModelInput.value   = this.llmConfig.model || "";
        this.llmKeyInput.value     = this.llmConfig.apiKey || "";
        this.llmEnabled = !!(this.llmConfig.apiKey && this.llmConfig.baseUrl);
      }catch(e){
        console.warn("Failed to load LLM config", e);
      }
    }

    saveLLMConfig(){
      try{
        localStorage.setItem("aura_llm_cfg", JSON.stringify(this.llmConfig));
      }catch(e){
        console.warn("Cannot store LLM config", e);
      }
    }

    updateLLMUI(){
      // (for future visual cues ‚Äì currently kept minimal to avoid UI changes)
    }

    handleLLMSave(){
      this.llmConfig.baseUrl = (this.llmBaseUrlInput.value || "").trim();
      this.llmConfig.model   = (this.llmModelInput.value || "").trim();
      this.llmConfig.apiKey  = (this.llmKeyInput.value || "").trim();
      this.llmEnabled = !!(this.llmConfig.apiKey && this.llmConfig.baseUrl);
      this.updateLLMUI();
      this.saveLLMConfig();
      alert("LLM config saved locally. For real deployments, move keys to a secure backend.");
    }

    handleLLMClear(){
      const ok = confirm("Clear stored API key from this browser?");
      if(!ok) return;
      this.llmConfig.apiKey = "";
      this.llmEnabled = false;
      this.llmKeyInput.value = "";
      this.updateLLMUI();
      this.saveLLMConfig();
    }

    async callLLM(promptText){
      if(!this.llmConfig.apiKey || !this.llmConfig.baseUrl) return null;
      const base  = this.llmConfig.baseUrl;
      const model = this.llmConfig.model || "default-model";

      const payload = {
        model,
        messages:[
          {role:"system",content:"You are a helper LLM plugged into an emotional engine called AURA-X Œ©. Reply clearly and conversationally."},
          {role:"user",content:promptText}
        ],
        max_tokens:256
      };

      const res = await fetch(base,{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":"Bearer "+this.llmConfig.apiKey
        },
        body:JSON.stringify(payload)
      });

      if(!res.ok) throw new Error("LLM HTTP "+res.status);
      const data = await res.json();
      const answer = data.choices && data.choices[0] && data.choices[0].message &&
        data.choices[0].message.content;
      return answer ? answer.trim() : null;
    }

    // ---------- Offline LLM (WebLLM) ----------

    updateOfflineModalUI(){
      const p = Math.round((this.offlineProgress || 0)*100);
      this.offlineProgressFill.style.width = p+"%";
      this.offlineProgressText.textContent = this.offlineProgressTextVal || "Offline engine idle.";
    }

    async initOfflineLLM(){
      if(this.offlineEngine || !window.webllm){
        if(!window.webllm){
          this.offlineProgressTextVal = "WebLLM not available in this browser (WebGPU missing).";
          this.updateOfflineModalUI();
        }
        return;
      }
      try{
        const defaultModelId = "Llama-3.2-1B-Instruct-q4f16_1-MLC";
        this.offlineProgress = 0;
        this.offlineProgressTextVal = "Preparing‚Ä¶";
        this.offlineLLMStatus = "loading";
        this.updateOfflineModalUI();

        this.offlineEngine = await window.webllm.CreateMLCEngine(defaultModelId,{
          initProgressCallback:(info)=>{
            const p = typeof info.progress === "number" ? info.progress : this.offlineProgress;
            this.offlineProgress = p;
            this.offlineProgressTextVal = info.text || "";
            this.updateOfflineModalUI();
          }
        });

        this.offlineLLMStatus = "ready";
        this.offlineProgress = 1;
        this.offlineProgressTextVal = "Model ready.";
        this.updateOfflineModalUI();
      }catch(e){
        console.error("Offline LLM init error", e);
        this.offlineLLMStatus = "error";
        this.offlineProgress = 0;
        this.offlineProgressTextVal = "Error while loading model.";
        this.updateOfflineModalUI();
      }
    }

    async callOfflineLLM(promptText){
      if(!window.webllm) return null;
      if(!this.offlineEngine){
        if(this.offlineLLMStatus === "loading"){
          this.offlineProgressTextVal = "Still downloading in background‚Ä¶";
          this.updateOfflineModalUI();
        }
        return null;
      }
      if(this.offlineLLMStatus !== "ready") return null;

      try{
        const result = await this.offlineEngine.chat.completions.create({
          messages:[
            {role:"system",content:"You are a small offline helper model inside AURA-X Œ©. Answer briefly and clearly."},
          {role:"user",content:promptText}
          ],
          max_tokens:200,
          temperature:0.7
        });
        const text = result && result.choices && result.choices[0] &&
          result.choices[0].message && result.choices[0].message.content;
        return text || null;
      }catch(e){
        console.error("Offline LLM error", e);
        this.offlineLLMStatus = "error";
        this.offlineProgressTextVal = "Error while using model.";
        this.updateOfflineModalUI();
        return null;
      }
    }

    // ---------- Memory / formula ----------

    updateMemoryAndState(text,sentiment,smallTalk,llmAnswer){
      this.lastSentiment = sentiment;
      const now = Date.now();
      const recentBM = this.bmEntries.slice(-12);

      let bmRes = 0.5;
      if(recentBM.length){
        let total = 0;
        recentBM.forEach(entry => {
          const dtHours = (now - entry.timestampMs)/(1000*60*60);
          const timeFactor = Math.exp(-dtHours/24);
          const vSim = 1 - Math.abs(sentiment.valence - entry.valence)/2;
          total += Math.max(0, vSim) * timeFactor;
        });
        bmRes = total / recentBM.length;
      }

      let intelRes = 0;
      if(this.intelNodes.length){
        let total = 0;
        this.intelNodes.forEach(node => {
          const sim = this.textSimilarity(text, node.question+" "+node.answer);
          total += sim;
        });
        intelRes = total / this.intelNodes.length;
      }

      let llmRes = 0;
      if(llmAnswer){
        const sim = this.textSimilarity(text.toLowerCase(), llmAnswer.toLowerCase());
        const sL  = this.analyzeSentiment(llmAnswer);
        const align = 1 - Math.abs(sentiment.valence - sL.valence)/2;
        llmRes = Math.max(0, Math.min(1, 0.5*sim + 0.5*align));
      }

      const combinedRes = this.clamp(
        0,1,
        0.6*bmRes + 0.25*intelRes + 0.15*llmRes
      );
      this.lastResonance = combinedRes;

      const tmMag = Math.min(1, 0.4 + 0.6*((Math.abs(sentiment.valence)+sentiment.intensity)/2));
      const bmMag = Math.min(1, 0.3 + 0.7*Math.min(1, this.bmEntries.length/80));
      const TMxBM = tmMag * bmMag * (0.5 + 0.5*combinedRes);

      const D = 0.15 + 0.25*(1 - this.continuityIndex);
      const lambdaFaith = this.faithsSelected.length ? (0.08 + 0.02*Math.min(this.faithsSelected.length,3)) : 0;
      const lambdaSys   = 0.10;
      const strongTruthCats = ["love","hope","wisdom"];
      const lambdaTrc   = strongTruthCats.includes(sentiment.category) ? 0.12 : 0.04;

      const z = (TMxBM) - D + lambdaFaith + lambdaSys + lambdaTrc;
      this.e0 = Math.tanh(z);

      if(!smallTalk){
        this.bmEntries.push({
          text,
          valence:sentiment.valence,
          intensity:sentiment.intensity,
          category:sentiment.category,
          emotionCode:this.generateEmotionCode(sentiment),
          timestampMs:now
        });
        if(this.bmEntries.length > 240){
          this.bmEntries.shift();
        }
        this.jiggleBMLayers(sentiment);
      }

      // continuity index update
      const baseCI = this.continuityIndex;
      const drift  = 0.005;
      const adjust = 0.06*(1 - Math.abs(this.e0 - baseCI));
      this.continuityIndex = this.clamp(0.55,0.98, baseCI + drift + adjust*(this.e0>=0?1:-1));
    }

    generateEmotionCode(sentiment){
      const prefix = sentiment.valence>0 ? "E+" : sentiment.valence<0 ? "E-" : "E0";
      const mid = sentiment.category === "hope" ? "H" :
                  sentiment.category === "stress" ? "S" : "N";
      const idx = Math.floor(sentiment.intensity*90).toString().padStart(2,"0");
      return `${prefix}${mid}${idx}`;
    }

    jiggleBMLayers(sentiment){
      const sign = sentiment.valence >=0 ? 1 : -1;
      const intensity = Math.max(0.3, sentiment.intensity);
      for(let i=0;i<this.bmLayers.length;i++){
        if(Math.random() < 0.2){
          this.bmLayers[i] = this.clamp(this.bmLayers[i] + sign*0.1*intensity, 0.05, 0.95);
        }
      }
    }

    clamp(v,min,max){ return v<min?min:v>max?max:v; }

    updateMetrics(){
      this.metricE0.textContent = this.e0.toFixed(3);
      const userCount = this.tmHistory.filter(m => m.role==="user").length;
      this.metricTM.textContent = Math.min(1,userCount/40).toFixed(2);
      this.metricBM.textContent = Math.min(1,this.bmEntries.length/80).toFixed(2);
      this.metricCI.textContent = this.continuityIndex.toFixed(3);

      const val = this.e0;
      let valLabel = val>0.25 ? "positive" : val<-0.25 ? "negative" : "neutral";
      this.tagValence.textContent = "VALENCE: "+valLabel;

      const ar = this.lastResonance;
      const arLabel = ar>0.7 ? "high" : ar<0.4 ? "low" : "medium";
      this.tagArousal.textContent = "AROUSAL: "+arLabel;
      this.tagReaction.textContent = "REACTION: "+(valLabel==="negative"?"tense":"balanced");

      const active = this.bmLayers.filter(v => v>0.6).length;
      this.bmStats.textContent = `Active layers: ${active}/${this.bmLayers.length} ¬∑ System online`;
    }

    // ---------- Chat UI helpers ----------

    addMessage(role,text,isAI=false,sentiment=null,skipSpeech=false,isHtml=false){
      const msg = document.createElement("div");
      msg.className = "message "+(role==="ai"?"ai-message":"user-message");

      const header = document.createElement("div");
      header.className = "message-header";
      const left = document.createElement("span");
      left.textContent = role==="ai" ? "AURA-X Œ©" : "You";

      const right = document.createElement("div");
      right.className = "msg-right";

      if(role==="ai"){
        const btn = document.createElement("button");
        btn.className = "voice-btn";
        btn.textContent = "üîä";
        btn.addEventListener("click", () => this.speak(text, sentiment || {polarity:"neutral"}));
        right.appendChild(btn);
      }

      header.appendChild(left);
      header.appendChild(right);

      const body = document.createElement("div");
      body.className = "message-content";
      if(isHtml){
        body.textContent = text;
      }else{
        body.textContent = text;
      }

      msg.appendChild(header);
      msg.appendChild(body);
      this.chatContainer.appendChild(msg);
      this.chatContainer.scrollTop = this.chatContainer.scrollHeight;

      if(role==="ai" && this.voiceOn && !skipSpeech){
        this.speak(text,sentiment);
      }
    }

    speak(text,_sentiment){
      if(!("speechSynthesis" in window)) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "en-US";
      window.speechSynthesis.speak(utter);
    }

    showTyping(){
      const id = "typing-"+Math.random().toString(36).slice(2);
      const wrap = document.createElement("div");
      wrap.id = id;
      wrap.className = "typing-indicator";
      wrap.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div><span class="typing-text">Aura is thinking‚Ä¶</span>';
      this.chatContainer.appendChild(wrap);
      this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
      return id;
    }

    hideTyping(id){
      const el = document.getElementById(id);
      if(el && el.parentNode) el.parentNode.removeChild(el);
    }

    // ---------- BM visual ----------

    renderBMChart(){
      this.bmChart.innerHTML = "";
      this.bmBars = [];
      for(let i=0;i<this.bmLayers.length;i++){
        const bar = document.createElement("div");
        bar.className = "bm-bar";
        const h = 10 + this.bmLayers[i]*80;
        bar.style.height = h+"%";
        this.bmChart.appendChild(bar);
        this.bmBars.push(bar);
      }
    }

    updateBMChartVisual(){
      if(!this.bmBars) return;
      for(let i=0;i<this.bmLayers.length;i++){
        const h = 10 + this.bmLayers[i]*80;
        this.bmBars[i].style.height = h+"%";
      }
    }

    // ---------- Modals ----------

    openBMModal(){
      this.bmList.innerHTML = "";
      if(!this.bmEntries.length){
        this.bmList.textContent = "No BM entries yet. Non-trivial emotional moments will be stored here.";
      }else{
        this.bmEntries.slice().reverse().forEach(entry => {
          const div = document.createElement("div");
          const dt = new Date(entry.timestampMs).toLocaleString();
          div.style.marginBottom = "6px";
          div.innerHTML =
            `<div style="font-size:.75rem;color:#9ca3af;">${dt}</div>`+
            `<div style="margin-top:2px;">${entry.text}</div>`+
            `<div style="margin-top:2px;font-size:.72rem;color:#9ca3af;">`+
            `valence=${entry.valence.toFixed(2)}, intensity=${entry.intensity.toFixed(2)}, `+
            `category=${entry.category}, code=${entry.emotionCode}</div>`;
          this.bmList.appendChild(div);
        });
      }
      this.bmModal.classList.add("visible");
    }

    openHistoryModal(){
      const lines = this.tmHistory.map(m => {
        const who = m.role==="ai" ? "AURA-X Œ©" : "You";
        return `[${who}] ${m.text}`;
      });
      this.historyContent.textContent = lines.join("\n\n") || "No conversation yet.";
      this.historyModal.classList.add("visible");
    }

    openSeedModal(){
      this.seedPasswordStage.style.display = "block";
      this.seedBlockStage.style.display = "none";
      this.seedPasswordInput.value = "";
      this.seedPasswordError.style.display = "none";
      this.seedBlockInput.value = "";
      this.seedBlockPreview.textContent = "Waiting for block‚Ä¶";
      this.seedSaveBtn.disabled = true;
      this.seedModal.classList.add("visible");
    }

    openLLMModal(){
      this.llmPasswordInput.value = "";
      this.llmPasswordError.style.display = "none";
      this.llmLockStage.style.display = "block";
      this.llmConfigStage.style.display = "none";
      this.llmModal.classList.add("visible");
    }

    exportHistory(){
      const blob = new Blob(
        [this.historyContent.textContent || ""],
        {type:"text/plain;charset=utf-8"}
      );
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "aura_tm_history.txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    clearTM(){
      const ok = confirm("Clear TM / chat history? BM (identity traces) will stay intact.");
      if(!ok) return;
      this.tmHistory = [];
      this.chatContainer.innerHTML = "";
      this.addWelcomeMessage();
      this.updateMetrics();
      alert("TM cleared. BM is untouched.");
    }

    maybeShowRecallBubble(sentiment){
      if(!this.recallBubble) return;
      if(this.bmEntries.length===0) return;
      if(Math.random()>0.25) return;

      const last = this.bmEntries[this.bmEntries.length-1];
      this.recallBody.textContent = last.text.length>120 ? last.text.slice(0,120)+"‚Ä¶" : last.text;
      this.recallMeta.textContent = `emotion code: ${last.emotionCode || "E---"}`;
      this.recallBubble.classList.add("visible");
      setTimeout(()=>this.recallBubble.classList.remove("visible"),6500);
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    window.auraX = new AuraXOmegaEngine();
  });

})();
</script>
</body>
</html>