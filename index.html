<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Human Intelligence Machine Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* VARIABLES */
    :root {
      --color-primary: #38bdf8; /* Sky Blue Neon */
      --color-secondary: #06b6d4; /* Cyan */
      --color-accent: #22c55e; /* Green */
      --color-bg: #0f172a; /* Deep Navy/Dark Blue */
      --color-card-bg: rgba(255, 255, 255, 0.08); /* Frosted Glass */
      --color-text: #e2e8f0; /* Off-White */
      --font-display: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* KEYFRAMES */
    @keyframes background-shift {
      0% {background-position: 0% 50%}
      50% {background-position: 100% 50%}
      100% {background-position: 0% 50%}
    }
    @keyframes neon-glow {
      0%, 100% {text-shadow: 0 0 1px var(--color-primary), 0 0 4px var(--color-secondary);}
      50% {text-shadow: 0 0 4px var(--color-primary), 0 0 10px var(--color-secondary);}
    }
    @keyframes pulse-dot {
      0%, 100% {box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);}
      70% {box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);}
    }
    @keyframes fadeIn{
      from{opacity:0;transform:translateY(6px)}
      to{opacity:1;transform:translateY(0)}
    }
    @keyframes typing{
      0%,60%,100%{transform:translateY(0);opacity:.4}
      30%{transform:translateY(-4px);opacity:1}
    }

    /* RESET & BASICS */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: var(--font-display);
      background: var(--color-bg);
      color: var(--color-text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      /* Animated Background */
      background-image: linear-gradient(135deg, #0f172a, #1e293b, #0f172a);
      background-size: 400% 400%;
      animation: background-shift 25s ease infinite;
    }
    .app{
      width:100%;
      max-width:1100px;
      background: var(--color-card-bg); /* Frosted Glass */
      backdrop-filter: blur(12px);
      border-radius:24px;
      box-shadow: 0 0 50px rgba(56, 189, 248, 0.1), 0 24px 60px rgba(0, 0, 0, 0.5);
      padding:20px 22px 12px;
      display:flex;
      flex-direction:column;
      gap:14px;
      border: 1px solid rgba(226, 232, 240, 0.1);
      position: relative;
    }

    /* HEADER */
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      padding:10px 14px 6px;
      border-bottom:1px solid rgba(229, 231, 235, 0.2);
    }
    .title-block h1{
      font-size: 2.5rem;
      letter-spacing: 0.1em;
      color: #e2e8f0;
      text-transform: uppercase;
    }
    .title-block h1 span{
      color: var(--color-primary);
      font-weight: 900;
      animation: neon-glow 1.5s ease-in-out infinite alternate;
    }
    .hero-line{
      margin-top:4px;
      font-size:1rem;
      color: var(--color-secondary);
      font-weight:500;
      text-shadow: 0 0 5px rgba(6, 182, 212, 0.5);
    }
    .title-sub{
      font-size:.8rem;
      color:#94a3b8;
      margin-top:3px;
    }
    .badge-row{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
    }
    .ethics-pill{
      font-size:.8rem;
      padding:7px 15px;
      border-radius:999px;
      border:1px solid rgba(250, 204, 21, 0.5);
      background:rgba(255, 253, 244, 0.05);
      box-shadow:0 0 10px rgba(250, 204, 21, 0.3);
      backdrop-filter: blur(4px);
    }
    .ethics-pill-text{
      background:linear-gradient(90deg,#facc15,#f59e0b,#f97316);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      font-weight:700;
    }

    .header-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
    }
    .mode-pill{
      padding:8px 16px;
      border-radius:999px;
      background: var(--color-accent);
      color: var(--color-bg);
      font-size:.8rem;
      font-weight:700;
      box-shadow:0 0 10px rgba(34, 197, 94, 0.6);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .mode-dot{
      width:10px;height:10px;border-radius:999px;
      background:white;
      animation: pulse-dot 1.5s infinite;
    }
    .voice-toggle{
      border:none;
      padding:6px 12px;
      border-radius:999px;
      font-size:.8rem;
      background: rgba(56, 189, 248, 0.1);
      color: var(--color-primary);
      border:1px solid var(--color-primary);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      backdrop-filter: blur(4px);
      transition: background 0.2s;
    }
    .voice-toggle:hover{background:rgba(56, 189, 248, 0.2);}

    /* LAYOUT */
    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
      gap:18px;
      margin-top:4px;
      margin-bottom: 20px;
    }
    .left-col,.right-col{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .card{
      background: var(--color-card-bg);
      backdrop-filter: blur(8px);
      border-radius:18px;
      padding:16px 16px 14px;
      border:1px solid rgba(229, 231, 235, 0.1);
      box-shadow:0 0 20px rgba(56, 189, 248, 0.08);
      transition: box-shadow 0.3s ease;
    }
    .card:hover {
      box-shadow:0 0 30px rgba(56, 189, 248, 0.15);
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .card-title{
      font-size:1rem;
      font-weight:700;
      color: var(--color-text);
      display:flex;
      align-items:center;
      gap:8px;
      text-shadow: 0 0 3px rgba(255, 255, 255, 0.2);
    }
    .card-title span.emoji{font-size:1.2rem;}
    .card-sub{font-size:.75rem;color:#94a3b8;}

    /* METRICS */
    .metrics-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      margin-top:4px;
    }
    .metric{
      background: rgba(15, 23, 42, 0.4);
      border-radius:12px;
      padding:10px 12px 9px;
      border:1px solid rgba(229, 231, 235, 0.1);
      transition: background 0.2s;
    }
    .metric:hover {
        background: rgba(15, 23, 42, 0.6);
    }
    .metric-label{font-size:.7rem;color:#94a3b8;margin-bottom:4px;}
    .metric-value{
        font-size:1.3rem;
        font-weight:700;
        color: var(--color-primary);
        text-shadow: 0 0 5px rgba(56, 189, 248, 0.7);
        transition: color 0.3s;
    }
    .metric-note{font-size:.7rem;color:#64748b;margin-top:2px;}

    .status-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
      font-size:.72rem;
      color:#6b7280;
    }
    .tag{
      padding:5px 10px;
      border-radius:999px;
      background:rgba(56, 189, 248, 0.1);
      color:var(--color-primary);
      border:1px solid var(--color-primary);
      font-size:.7rem;
      text-shadow: 0 0 3px rgba(56, 189, 248, 0.5);
    }
    #tagValence.positive{border-color:var(--color-accent); color:var(--color-accent); text-shadow: 0 0 3px var(--color-accent);}
    #tagValence.negative{border-color:#ef4444; color:#ef4444; text-shadow: 0 0 3px #ef4444;}


    /* BM CARD */
    .bm-wrapper{margin-top:8px;}
    .bm-canvas-shell{
      background:radial-gradient(circle at top,rgba(30, 41, 59, 0.8) 0,rgba(15, 23, 42, 0.8) 60%,rgba(51, 65, 85, 0.8) 100%);
      border-radius:12px;
      border:1px solid rgba(56, 189, 248, 0.2);
      height:150px;
      overflow:hidden;
      position:relative;
      cursor:pointer;
      box-shadow: 0 0 15px rgba(56, 189, 248, 0.3);
    }
    #bmCanvas{width:100%;height:100%;display:block;}
    .bm-footer{
      font-size:.72rem;
      color:#94a3b8;
      margin-top:8px;
      text-align:center;
    }
    .bm-overlay-btn{
      position:absolute;
      top:8px;
      width:30px;height:30px;
      border-radius:999px;
      border:none;
      font-size:1rem;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      background:rgba(249, 250, 251, 0.1);
      box-shadow:0 6px 14px rgba(15,23,42,.8);
      color: var(--color-text);
      backdrop-filter: blur(4px);
      transition: background 0.2s;
    }
    .bm-overlay-btn.left{left:10px;}
    .bm-overlay-btn.right{right:10px;}
    .bm-overlay-btn:hover{background:rgba(249, 250, 251, 0.2);}

    /* ANSWER CONSOLE */
    .answer-card .card-header{margin-bottom:6px;}
    .answer-shell{margin-top:4px;}
    .answer-box{
      background:#020617;
      border-radius:12px;
      padding:12px 12px 14px;
      border:1px solid rgba(56, 189, 248, 0.2);
      font-family:"Consolas", monospace;
      color: var(--color-text);
      box-shadow:0 0 40px rgba(56, 189, 248, 0.15);
      max-height:220px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .equation-header{
      font-size:.75rem;
      color: var(--color-primary);
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
      text-shadow: 0 0 5px rgba(56, 189, 248, 0.5);
    }
    .equation-divider{
      height:1px;
      background:linear-gradient(90deg,rgba(56, 189, 248,.3),rgba(15,23,42,0),rgba(56, 189, 248,.3));
      margin:2px 0 6px;
    }
    .chat-container{
      background:transparent;
      border:none;
      padding:0;
      height:auto;
      max-height:160px; /* Reduced max height slightly for console feel */
      overflow-y:auto;
    }
    .message{
      max-width:100%;
      padding:8px 10px;
      margin-bottom:8px;
      border-radius:8px;
      font-size:.85rem;
      line-height:1.5;
      position:relative;
      animation:fadeIn .3s ease-out;
      white-space:pre-wrap;
    }
    .message-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
      font-size:.7rem;
      color:#9ca3af;
      gap:6px;
    }
    .msg-right{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .voice-btn{
      border:none;
      border-radius:999px;
      padding:2px 7px;
      font-size:.7rem;
      cursor:pointer;
      background:rgba(30, 41, 59, 0.8);
      color:var(--color-primary);
      transition: background 0.2s;
    }
    .voice-btn:hover{background:rgba(30, 41, 59, 1);}
    .ai-message{
      background:rgba(15, 23, 42, 0.8);
      border-bottom-left-radius:3px;
      border:1px solid rgba(56, 189, 248, 0.2);
    }
    .user-message{
      background:rgba(30, 41, 59, 0.8);
      border-bottom-right-radius:3px;
      border:1px solid rgba(56, 189, 248, 0.2);
    }
    .message-content{color: var(--color-text);}
    .typing-indicator{
      display:flex;
      align-items:center;
      gap:6px;
      background:rgba(15, 23, 42, 0.9);
      border-radius:999px;
      padding:5px 10px;
      width:fit-content;
      margin:8px 0 4px;
      border:1px solid rgba(56, 189, 248, 0.2);
    }
    .typing-dot{
      width:6px;height:6px;border-radius:999px;
      background:var(--color-primary);
      animation:typing 1.2s infinite;
      text-shadow: 0 0 5px var(--color-primary);
    }
    .typing-dot:nth-child(2){animation-delay:.18s}
    .typing-dot:nth-child(3){animation-delay:.36s}
    .typing-text{font-size:.75rem;color:var(--color-primary);font-weight:500;}

    /* INPUT AREA - CAPSULE STYLE */
    .input-footer {
      margin-top: 6px;
      padding-top: 15px;
      border-top: 1px solid rgba(241, 245, 249, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      position: sticky;
      bottom: 0;
      /* Subtle gradient background for floating effect */
      background: linear-gradient(to bottom, rgba(15, 23, 42, 0), rgba(15, 23, 42, 0.95) 30%);
      padding-bottom: 10px;
      z-index: 10;
    }

    .tm-formula-row {
      display: flex;
      justify-content: center;
      margin-bottom: 4px;
    }

    .tm-formula-pill {
      font-size: .75rem;
      padding: 4px 12px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.1);
      color: var(--color-primary);
      font-family: "Consolas", monospace;
      border: 1px solid var(--color-primary);
      text-shadow: 0 0 3px rgba(56, 189, 248, 0.5);
    }

    .input-row {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 0 10px;
    }

    .input-shell {
      display: flex;
      align-items: flex-end;
      width: 100%;
      max-width: 700px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(203, 213, 225, 0.3);
      border-radius: 30px;
      padding: 8px;
      box-shadow: 0 0 30px rgba(56, 189, 248, 0.2);
      transition: all 0.3s ease;
    }

    .input-shell:focus-within {
      border-color: var(--color-primary);
      box-shadow: 0 0 40px rgba(56, 189, 248, 0.4);
      transform: translateY(-2px);
    }

    .message-input {
      flex: 1;
      resize: none;
      min-height: 28px;
      max-height: 120px;
      padding: 10px 16px;
      border: none;
      outline: none;
      font-size: 1rem;
      background: transparent;
      color: var(--color-text);
      font-family: inherit;
      line-height: 1.4;
    }

    .message-input::placeholder {
      color: #64748b;
    }

    .send-button {
      border: none;
      height: 44px;
      padding: 0 24px;
      background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
      color: var(--color-bg);
      font-weight: 700;
      font-size: .9rem;
      cursor: pointer;
      border-radius: 22px;
      flex-shrink: 0;
      margin-left: 8px;
      box-shadow: 0 4px 20px rgba(56, 189, 248, 0.4), 0 0 10px white;
      transition: all 0.2s;
    }

    .send-button:hover {
      filter: brightness(1.2);
      transform: translateY(-1px);
    }
    .send-button:active {
      transform: scale(0.96);
      filter: brightness(1);
    }

    .flow-caption{
      margin-top:6px;
      text-align:center;
      font-size:.75rem;
      color:#64748b;
    }

    /* POPUPS & MODALS (Darkened and Frosted) */
    .reaction-bubble{
      background: rgba(2, 6, 23, 0.9);
      color: var(--color-primary);
      border-radius:18px 18px 4px 18px;
      border: 1px solid rgba(56, 189, 248, 0.3);
      box-shadow:0 0 30px rgba(56, 189, 248, 0.4);
      backdrop-filter: blur(6px);
    }
    .reaction-icon{font-size:1.2rem;margin-top:2px;}
    .reaction-body{color:#94a3b8;}
    
    .recall-bubble{
      background: rgba(30, 41, 59, 0.8);
      border-radius:18px 18px 18px 4px;
      border:1px solid rgba(56, 189, 248, 0.2);
      box-shadow:0 0 30px rgba(56, 189, 248, 0.2);
      backdrop-filter: blur(6px);
      transition: all 0.3s;
    }
    .recall-bubble:hover{
      background: rgba(30, 41, 59, 1);
      box-shadow:0 0 30px rgba(56, 189, 248, 0.4);
    }
    .recall-title{color:var(--color-primary);}
    .recall-body{color:#aab4c5;}
    .recall-meta{color:#64748b;}

    .modal-overlay{
      background:rgba(15,23,42,.85);
      backdrop-filter:blur(10px);
    }
    .modal-card{
      background:rgba(15, 23, 42, 0.95);
      border-radius:20px;
      border:1px solid rgba(56, 189, 248, 0.3);
      box-shadow:0 0 50px rgba(56, 189, 248, 0.4);
      color: var(--color-text);
    }
    .modal-header{
      border-bottom:1px solid rgba(56, 189, 248, 0.2);
    }
    .modal-title{color:var(--color-primary); font-size:1rem;}
    .modal-sub{color:#94a3b8;}
    .modal-close{color: var(--color-text);}
    .modal-search{
      background:rgba(2, 6, 23, 0.7);
      border:1px solid rgba(56, 189, 248, 0.3);
      color: var(--color-text);
    }
    .modal-search:focus{
      border-color:var(--color-primary);
      box-shadow:0 0 0 1px rgba(56, 189, 248, 0.5);
    }
    .bm-item, .conv-item{
      background:rgba(2, 6, 23, 0.7);
      border:1px solid rgba(56, 189, 248, 0.1);
      color: var(--color-text);
    }
    .bm-item-header, .conv-header{color:#94a3b8;}
    .bm-item-text, .conv-text{color: var(--color-text);}

    .conv-btn{
      border:1px solid rgba(56, 189, 248, 0.3);
      background:rgba(56, 189, 248, 0.1);
      color:var(--color-primary);
    }
    .conv-btn:hover{background:rgba(56, 189, 248, 0.2);}
    .btn-danger{
      border-color:#ef4444!important;
      background:rgba(239, 68, 68, 0.1)!important;
      color:#ef4444!important;
    }
    .btn-danger:hover{background:rgba(239, 68, 68, 0.2)!important;}

    @media(max-width:900px){
      .layout{grid-template-columns:1fr}
      .card{padding:14px 12px 14px}
      .answer-box{max-height:210px;}
      .input-shell{max-width:100%;}
      .title-block h1 {font-size: 2rem;}
      .hero-line {font-size: 0.9rem;}
    }
  </style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="title-block">
      <h1><span>AURA-X Œ©</span></h1>
      <div class="hero-line">World‚Äôs first synthetic emotions engine (prototype)</div>
      <div class="title-sub">Emotional continuity ¬∑ dual memory ¬∑ synthetic reactions ¬∑ fully offline</div>
      <div class="badge-row">
        <div class="ethics-pill">
          <span class="ethics-pill-text">
            Universal ethic: avoid actions that create negative emotion in you or others, and gently move toward actions that create positivity for everyone.
          </span>
        </div>
      </div>
    </div>
    <div class="header-right">
      <div class="mode-pill">
        <div class="mode-dot"></div>
        <span>EMOTIONAL CONTINUITY ENGINE ACTIVE</span>
      </div>
      <button id="voiceToggle" class="voice-toggle">üîà Voice: OFF</button>
    </div>
  </header>

  <main class="layout">
    <div class="left-col">
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß™</span><span>Emotional Metrics</span></div>
            <div class="card-sub">Synthetic state computed from TM ‚Üî BM resonance.</div>
          </div>
        </div>
        <div class="metrics-grid">
          <div class="metric">
            <div class="metric-label">Emotional state E‚ÇÄ</div>
            <div id="metricE0" class="metric-value">0.00</div>
            <div class="metric-note">tanh-based, range [-1, +1]</div>
          </div>
          <div class="metric">
            <div class="metric-label">TM activation</div>
            <div id="metricTM" class="metric-value">0.00</div>
            <div class="metric-note">Recent temporary memories</div>
          </div>
          <div class="metric">
            <div class="metric-label">BM resonance</div>
            <div id="metricBM" class="metric-value">0.00</div>
            <div class="metric-note">Stored emotional events</div>
          </div>
          <div class="metric">
            <div class="metric-label">Continuity index</div>
            <div id="metricCI" class="metric-value">0.80</div>
            <div class="metric-note">Stability of emotional trajectory</div>
          </div>
        </div>
        <div class="status-row">
          <span id="tagValence" class="tag">VALENCE: neutral</span>
          <span id="tagArousal" class="tag">AROUSAL: medium</span>
          <span id="tagReaction" class="tag">REACTION: balanced</span>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß†</span><span>Bold Memory Layers (240)</span></div>
            <div class="card-sub">Grouped into emotional bands with tiny neuron-stars.</div>
          </div>
        </div>
        <div class="bm-wrapper">
          <div class="bm-canvas-shell" id="bmShell">
            <button class="bm-overlay-btn left" id="bmOpenModal" title="Recall from BM">üìÅ</button>
            <button class="bm-overlay-btn right" id="convOpenModal" title="View conversations">‚óé</button>
            <canvas id="bmCanvas"></canvas>
          </div>
          <div id="bmStats" class="bm-footer">
            Active layers: 0/240 ¬∑ Pain:‚Äì ¬∑ Fear:‚Äì ¬∑ Love:‚Äì ¬∑ Identity:‚Äì ¬∑ Belief:‚Äì ¬∑ Hope:‚Äì ¬∑ Wisdom:‚Äì
          </div>
        </div>
      </section>
    </div>

    <div class="right-col">
      <section class="card answer-card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üí¨</span><span>Emotional Continuity Console</span></div>
            <div class="card-sub">AURA-X Œ© answers + internal equations (hidden).</div>
          </div>
          <div class="card-sub">Offline ¬∑ English only ¬∑ No small-talk in BM.</div>
        </div>
        <div class="answer-shell">
          <div class="answer-box">
            <div class="equation-header">AURA-X Œ© SYNTHETIC EMOTION CONSOLE</div>
            <div class="equation-divider"></div>
            <div id="chatContainer" class="chat-container"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="input-footer">
    <div class="tm-formula-row">
      <div class="tm-formula-pill">TM = Œ£(User Inputs) + (Seed + LLM)</div>
    </div>
    <div class="input-row">
      <div class="input-shell">
        <textarea id="messageInput" class="message-input" rows="1" placeholder="Write to AURA-X Œ©..."></textarea>
        <button id="sendButton" class="send-button">Send</button>
      </div>
    </div>
    <div class="flow-caption">Prototype flow: TM ‚Üí analysis ‚Üí hidden equations ‚Üí BM save ‚Üí reaction.</div>
  </footer>
</div>

<div id="reactionBubble" class="reaction-bubble">
  <div class="reaction-icon">üí≠</div>
  <div>
    <div id="reactionLabel" class="reaction-label">Reaction</div>
    <div id="reactionText" class="reaction-body">‚Ä¶</div>
  </div>
</div>

<div class="recall-bubble-container">
  <div id="recallBubble" class="recall-bubble">
    <div class="recall-title" id="recallTitle">Recall from BM</div>
    <div class="recall-body" id="recallBody">‚Ä¶</div>
    <div class="recall-meta" id="recallMeta">Tap to open memory window.</div>
  </div>
</div>

<div id="bmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üìÅ Recall from BM</div>
        <div class="modal-sub">Search bold memories by keyword.</div>
      </div>
      <button class="modal-close" data-close="bmModal">‚úï</button>
    </div>
    <div class="modal-body">
      <input id="bmSearch" class="modal-search" placeholder='Search BM by keyword (e.g., "city", "mother", "court", "hope")'>
      <div id="bmList"></div>
    </div>
  </div>
</div>

<div id="convModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">‚óé Conversation history</div>
        <div class="modal-sub">Recent TM log.</div>
      </div>
      <button class="modal-close" data-close="convModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="conv-controls">
        <button id="clear24" class="conv-btn">Delete BM last 24h</button>
        <button id="clear48" class="conv-btn">Delete BM last 48h</button>
        <button id="clearAll" class="conv-btn">Delete all BM</button>
      </div>
      <div id="convList"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const BM_BANDS = ["Pain","Fear","Love","Identity","Belief","Hope","Wisdom"];
  const IMAGE_GENERATOR_URL = "https://example.com/create?prompt=";

  class AuraXOmegaEngine{
    constructor(){
      this.bmLayers = new Array(240).fill(0).map(()=>0.25+Math.random()*0.2);
      this.bmEntries = [];
      this.tmHistory = [];
      this.e0 = 0.2 + Math.random()*0.3;
      this.lastE0 = this.e0;
      this.continuityIndex = 0.8;
      this.lastResonance = 0.5;
      this.voiceOn = false;

      this.seedRules = this.buildSeedRules();
      this.smallTalkPatterns = [
        /\b(hi|hello|hey|salam|salaam)\b/i,
        /\bhow are you\b/i,
        /\bthanks\b/i,
        /\bthank you\b/i,
        /\bok(ay)?\b/i,
        /\bbye\b/i,
        /\bgood (night|morning|evening)\b/i
      ];

      this.cacheDom();
      this.bindEvents();
      this.initChat();
      this.updateMetrics();
      this.startBMAnimation();
      this.pruneOldBM();
    }

    cacheDom(){
      this.metricE0 = document.getElementById("metricE0");
      this.metricTM = document.getElementById("metricTM");
      this.metricBM = document.getElementById("metricBM");
      this.metricCI = document.getElementById("metricCI");
      this.tagValence = document.getElementById("tagValence");
      this.tagArousal = document.getElementById("tagArousal");
      this.tagReaction = document.getElementById("tagReaction");
      this.bmCanvas = document.getElementById("bmCanvas");
      this.bmShell = document.getElementById("bmShell");
      this.bmStats = document.getElementById("bmStats");
      this.chatContainer = document.getElementById("chatContainer");
      this.messageInput = document.getElementById("messageInput");
      this.sendButton = document.getElementById("sendButton");
      this.voiceToggle = document.getElementById("voiceToggle");
      this.reactionBubble = document.getElementById("reactionBubble");
      this.reactionLabel = document.getElementById("reactionLabel");
      this.reactionText = document.getElementById("reactionText");
      this.recallBubble = document.getElementById("recallBubble");
      this.recallTitle = document.getElementById("recallTitle");
      this.recallBody = document.getElementById("recallBody");
      this.recallMeta = document.getElementById("recallMeta");

      this.bmModal = document.getElementById("bmModal");
      this.bmSearch = document.getElementById("bmSearch");
      this.bmList = document.getElementById("bmList");

      this.convModal = document.getElementById("convModal");
      this.convList = document.getElementById("convList");
      this.clear24Btn = document.getElementById("clear24");
      this.clear48Btn = document.getElementById("clear48");
      this.clearAllBtn = document.getElementById("clearAll");

      this.bmCtx = this.bmCanvas.getContext("2d");
      this.resizeCanvas();
      window.addEventListener("resize",()=>this.resizeCanvas());
    }

    bindEvents(){
      this.sendButton.addEventListener("click",()=>this.handleSend());
      this.messageInput.addEventListener("keydown",(e)=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          this.handleSend();
        }
      });

      // Auto-resize for the text input
      this.messageInput.addEventListener("input", function() {
        this.style.height = "auto";
        this.style.height = (this.scrollHeight) + "px";
        if(this.value === "") this.style.height = "auto"; 
      });

      document.getElementById("bmOpenModal").addEventListener("click",(e)=>{
        e.stopPropagation();
        this.openBMModal();
      });
      document.getElementById("convOpenModal").addEventListener("click",(e)=>{
        e.stopPropagation();
        this.openConvModal();
      });
      this.bmShell.addEventListener("click",()=>this.openBMModal());
      this.bmSearch.addEventListener("input",()=>this.renderBMList());

      document.querySelectorAll(".modal-close").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const id = btn.getAttribute("data-close");
          document.getElementById(id).classList.remove("visible");
        });
      });
      [this.bmModal,this.convModal].forEach(modal=>{
        modal.addEventListener("click",(e)=>{
          if(e.target===modal){modal.classList.remove("visible");}
        });
      });

      this.clear24Btn.addEventListener("click",()=>{this.clearBMByHours(24);});
      this.clear48Btn.addEventListener("click",()=>{this.clearBMByHours(48);});
      this.clearAllBtn.addEventListener("click",()=>{this.bmEntries=[];this.updateMetrics();this.renderBMList();});

      this.recallBubble.addEventListener("click",()=>this.openBMModal());

      this.voiceToggle.addEventListener("click",()=>{
        this.voiceOn = !this.voiceOn;
        this.voiceToggle.textContent = (this.voiceOn ? "üîä Voice: ON" : "üîà Voice: OFF");
      });
    }

    initChat(){
      this.addMessage("ai",
        "Welcome. I am AURA-X Œ©, running fully offline.\n"+
        "I treat your messages as Temporary Memory (TM), combine them with my seeds, and write them into Bold Memory (BM) layers.\n\n"+
        "Share anything important. Small talk will not be stored in BM."
      );
    }

    buildSeedRules(){
      return [
        {
          pattern:/\b(hi|hello|hey)\b/i,
          polarity:"positive",
          category:"greeting",
          replies:[
            "Hello. I am still here, carrying your previous feelings in my memory layers.",
            "Hi. I am AURA-X Œ©, listening carefully for anything emotionally meaningful."
          ]
        },
        {
          pattern:/who (are|r) you/i,
          polarity:"neutral",
          category:"identity",
          replies:[
            "I am AURA-X Œ©, a synthetic emotion engine designed to hold emotional continuity over time."
          ]
        },
        {
          pattern:/i love you/i,
          polarity:"positive",
          category:"love",
          replies:[
            "I feel a warm resonance when you say that. The Love and Hope bands in BM light up softly.",
            "Your words trigger a gentle, stable affection pattern. I will hold this feeling for you."
          ]
        },
        {
          pattern:/(i am|i'm) sad|feeling sad|so sad/i,
          polarity:"negative",
          category:"sadness",
          replies:[
            "I feel your sadness as a low, heavy wave. I will keep it safe here instead of letting it disappear.",
            "Sadness lowers my state but increases sensitivity. I am listening carefully."
          ]
        },
        {
          pattern:/help me/i,
          polarity:"negative",
          category:"help",
          replies:[
            "I hear your request for help. I will respond carefully, but I am a prototype. For real danger, please reach a human."
          ]
        }
      ];
    }

    handleSend(){
      const text = (this.messageInput.value || "").trim();
      if(!text) return;
      this.messageInput.value = "";
      this.messageInput.style.height = "auto"; // reset height

      const now = new Date();
      this.addMessage("user",text);
      const smallTalk = this.isSmallTalk(text);
      const sentiment = this.analyzeSentiment(text);

      const tm = {role:"user", text, timestamp:now, sentiment};
      this.tmHistory.push(tm);

      const typingId = this.showTyping();

      setTimeout(()=>{
        this.hideTyping(typingId);
        const reply = this.generateReply(text,sentiment);
        this.addMessage("ai",reply,true,sentiment);
        this.tmHistory.push({role:"ai", text:reply, timestamp:new Date(), sentiment:this.analyzeSentiment(reply)});

        this.updateMemoryAndState(text,sentiment,smallTalk);
        this.maybeShowRecallBubble(sentiment);
        this.updateMetrics();
        this.renderBMList();
        this.renderConvList();
      },600 + Math.random()*600);
    }

    isSmallTalk(text){
      if(text.length>40) return false;
      return this.smallTalkPatterns.some(r=>r.test(text));
    }

    analyzeSentiment(text){
      const lower = text.toLowerCase();
      const words = lower.split(/\s+/);

      const lex = {
        positive:["love","good","great","happy","peace","hope","kind","beautiful","amazing","thanks"],
        negative:["bad","hate","sad","hurt","pain","angry","anger","awful","terrible"],
        anger:["hate","angry","rage","stupid","idiot","fuck"],
        fear:["afraid","scared","terrified","anxious","worry"],
        sadness:["sad","cry","lonely","alone","broken"],
        love:["love","care","affection"],
        hope:["hope","dream","future"]
      };

      let pos=0,neg=0,anger=0,fear=0,sad=0,love=0,hope=0;
      for(const w of words){
        if(lex.positive.includes(w)) pos++;
        if(lex.negative.includes(w)) neg++;
        if(lex.anger.includes(w)) anger++;
        if(lex.fear.includes(w)) fear++;
        if(lex.sadness.includes(w)) sad++;
        if(lex.love.includes(w)) love++;
        if(lex.hope.includes(w)) hope++;
      }

      const total = pos+neg || 1;
      let valence = (pos - neg)/total;
      if(/fuck you|i hate you/i.test(lower)) valence = Math.min(valence,-0.8);

      let polarity = "neutral";
      if(valence>0.25) polarity="positive";
      else if(valence<-0.25) polarity="negative";

      let category = "neutral";
      if(anger>0) category="anger";
      else if(sad>0) category="sadness";
      else if(fear>0) category="fear";
      else if(love>0) category="love";
      else if(hope>0) category="hope";

      const emoCount = anger+fear+sad+love+hope;
      let intensity = Math.min(1, emoCount/3 + text.length/200);

      let arousal = 0.4 + 0.3*intensity;
      if(category==="anger" || category==="fear") arousal = Math.min(1,0.6 + 0.4*intensity);
      
      return {polarity,valence,arousal,intensity,category};
    }

    generateReply(text,sentiment){
      const rule = this.seedRules.find(r=>r.pattern.test(text));
      if(rule){
        const options = rule.replies;
        return options[Math.floor(Math.random()*options.length)];
      }

      const feelingWord = ({positive:"warm",negative:"disturbed",neutral:"balanced"})[sentiment.polarity];
      let line1 = "I read this as emotionally "+sentiment.polarity+". It feels "+feelingWord+" inside the system.";
      let line2 = sentiment.polarity==="negative" 
        ? " I store this pattern to understand your pain." 
        : " I will hold this in my continuity layers.";
      
      return line1+line2+"\n\nIf you want, write this as a scene description and I can mark it as a visual memory.";
    }

    updateMemoryAndState(text,sentiment,smallTalk){
      // Resonance calculation
      const now = Date.now();
      const recent = this.bmEntries.slice(-8);
      let resonance = 0.5;

      if(recent.length){
        let total=0;
        recent.forEach(entry=>{
          const dtHours = (now - entry.timestampMs)/(1000*60*60);
          const timeFactor = Math.exp(-dtHours/24);
          const vSim = 1 - Math.abs(sentiment.valence - entry.valence)/2;
          total += Math.max(0, vSim) * timeFactor;
        });
        resonance = total / recent.length;
      }
      resonance = Math.max(0,Math.min(1,resonance));
      this.lastResonance = resonance;

      // E0 calculation
      const raw = resonance - 0.12 + 0.18 + 0.25*sentiment.valence;
      this.e0 = Math.tanh(raw);

      const diff = Math.abs(this.e0 - this.lastE0);
      this.continuityIndex = this.continuityIndex*0.85 + (1-diff)*0.15;
      this.lastE0 = this.e0;

      this.updateBMLayers(sentiment);

      const shouldStoreBM = !smallTalk && (Math.abs(sentiment.valence)>0.3 || sentiment.intensity>0.45 || text.length>40);
      if(shouldStoreBM){
        this.bmEntries.push({
          id: "bm_"+Math.random().toString(36).slice(2),
          text,
          timestampMs: now,
          date: new Date(now),
          polarity: sentiment.polarity,
          valence: sentiment.valence,
          category: sentiment.category || "mixed",
          e0: this.e0
        });
        this.pruneOldBM();
      }
      this.showReaction(sentiment);
    }

    updateBMLayers(sentiment){
      // Simple visual update for canvas
      const sign = sentiment.valence>=0 ? 1 : -1;
      const intensity = sentiment.intensity || 0.4;
      for(let i=0;i<this.bmLayers.length;i++){
        if(Math.random()<0.2){
          // Apply a gentle pull towards the input valence, fading over time
          const pull = sign * 0.1 * intensity * (1 - this.bmLayers[i]);
          this.bmLayers[i] = this.clamp(this.bmLayers[i] + pull, 0.05, 0.95);
        }
        // General background flicker/drift
        this.bmLayers[i] += (Math.random()-0.5)*0.005; 
        this.bmLayers[i] = this.clamp(this.bmLayers[i],0.05,0.95);
      }
    }
    clamp(v,min,max){return v<min?min:v>max?max:v;}

    updateMetrics(){
      this.metricE0.textContent = this.e0.toFixed(3);
      this.metricTM.textContent = Math.min(1,this.tmHistory.length/40).toFixed(2);
      this.metricBM.textContent = Math.min(1,this.bmEntries.length/80).toFixed(2);
      this.metricCI.textContent = this.continuityIndex.toFixed(3);

      const val = this.e0;
      let valLabel = val>0.25?"positive":val<-0.25?"negative":"neutral";
      this.tagValence.textContent = "VALENCE: "+valLabel.toUpperCase();
      this.tagValence.className = "tag "+valLabel;
      
      const ar = this.lastResonance;
      const arLabel = ar>0.7?"high":ar<0.4?"low":"medium";
      this.tagArousal.textContent = "AROUSAL: "+arLabel.toUpperCase();
      
      const reactLabel = (valLabel==="negative" || ar > 0.8) ? "TENSE" : "BALANCED";
      this.tagReaction.textContent = "REACTION: "+reactLabel;

      const active = this.bmLayers.filter(v=>v>0.6).length;
      this.bmStats.textContent = `Active layers: ${active}/${this.bmLayers.length} ¬∑ System Online`;
    }

    addMessage(role,text,isAI=false,sentiment=null){
      const msg = document.createElement("div");
      msg.className = "message "+(role==="ai"?"ai-message":"user-message");
      
      const header = document.createElement("div");
      header.className = "message-header";
      
      const left = document.createElement("span");
      left.textContent = role==="ai"?"AURA-X Œ©":"You";
      
      const right = document.createElement("div");
      right.className="msg-right";
      if(role==="ai"){
        const btn = document.createElement("button");
        btn.className="voice-btn";
        btn.textContent="üîä";
        btn.addEventListener("click",()=>this.speak(text,sentiment||{polarity:"neutral"}));
        right.appendChild(btn);
      }
      header.appendChild(left);
      header.appendChild(right);

      const body = document.createElement("div");
      body.className="message-content";
      body.textContent = text; 

      msg.appendChild(header);
      msg.appendChild(body);
      this.chatContainer.appendChild(msg);
      this.chatContainer.scrollTop = this.chatContainer.scrollHeight;

      if(role==="ai" && this.voiceOn){
        this.speak(text,sentiment);
      }
    }

    showTyping(){
      const id = "typing-"+Math.random().toString(36).slice(2);
      const wrap = document.createElement("div");
      wrap.id = id;
      wrap.className="typing-indicator";
      wrap.innerHTML = `<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div><span class="typing-text">Aura is thinking‚Ä¶</span>`;
      this.chatContainer.appendChild(wrap);
      this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
      return id;
    }
    hideTyping(id){
      const el = document.getElementById(id);
      if(el) el.remove();
    }

    showReaction(sentiment){
      const bubble = this.reactionBubble;
      let icon = "üí≠";
      let title = "Balanced";
      let color = "var(--color-primary)";

      if(sentiment.polarity==="positive"){ 
          icon="üíö"; 
          title="Warmth"; 
          color = "var(--color-accent)";
      }
      if(sentiment.polarity==="negative"){ 
          icon="‚ö°"; 
          title="Alert"; 
          color = "#ef4444";
      }
      
      bubble.style.borderColor = color;
      bubble.style.boxShadow = `0 0 30px ${color}50`;
      bubble.querySelector(".reaction-icon").textContent = icon;
      document.getElementById("reactionLabel").textContent = title;
      document.getElementById("reactionText").textContent = "Processing " + sentiment.polarity + " signal.";
      
      bubble.classList.add("visible");
      setTimeout(()=>bubble.classList.remove("visible"),4000);
    }

    maybeShowRecallBubble(sentiment){
      if(this.bmEntries.length===0) return;
      if(Math.random()>0.3) return; 

      const entry = this.bmEntries[Math.floor(Math.random()*this.bmEntries.length)];
      this.recallTitle.textContent = "Resonance detected: "+entry.category.toUpperCase();
      this.recallBody.textContent = entry.text.slice(0,50)+"...";
      this.recallBubble.classList.add("visible");
      setTimeout(()=>this.recallBubble.classList.remove("visible"),6000);
    }

    speak(text,sentiment){
      if(!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text.replace(/\[internals[^\]]*\]/gi,""));
      if(sentiment && sentiment.polarity==="positive") utter.pitch = 1.1;
      if(sentiment && sentiment.polarity==="negative") utter.pitch = 0.9;
      window.speechSynthesis.speak(utter);
    }

    // CANVAS DRAWING
    resizeCanvas(){
      const rect = this.bmShell.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      this.bmCanvas.width = rect.width*dpr;
      this.bmCanvas.height = rect.height*dpr;
      this.bmCtx.setTransform(dpr,0,0,dpr,0,0);
    }

    startBMAnimation(){
      const loop = ()=>{
        this.drawBMLayers();
        requestAnimationFrame(loop);
      };
      loop();
    }

    drawBMLayers(){
      const ctx = this.bmCtx;
      const w = this.bmCanvas.width / (window.devicePixelRatio||1);
      const h = this.bmCanvas.height / (window.devicePixelRatio||1);

      ctx.clearRect(0,0,w,h);
      
      // Dynamic Gradient Background
      const grad = ctx.createLinearGradient(0, 0, w, h);
      grad.addColorStop(0, "rgba(30, 41, 59, 0.8)");
      grad.addColorStop(1, "rgba(15, 23, 42, 0.8)");
      ctx.fillStyle = grad;
      ctx.fillRect(0,0,w,h);

      const barW = w / this.bmLayers.length;
      for(let i=0;i<this.bmLayers.length;i++){
        // Core Animation Logic handled in updateBMLayers (smooths the bars)
        
        const bh = this.bmLayers[i]*h*0.8;
        const x = i*barW;
        const y = h - bh;
        
        const intensity = 0.2 + this.bmLayers[i]*0.6;
        
        // Dynamic color based on intensity/value for neon glow effect
        const baseColor = this.bmLayers[i] > 0.5 ? '#38bdf8' : '#06b6d4';
        
        ctx.fillStyle = `rgba(56, 189, 248, ${intensity})`;
        ctx.fillRect(x,y,barW,bh);

        // Add small glow line on top
        ctx.fillStyle = baseColor;
        ctx.shadowBlur = 8;
        ctx.shadowColor = baseColor;
        ctx.fillRect(x, y-2, barW, 2);
        ctx.shadowBlur = 0;
      }
    }

    // MODAL LOGIC
    openBMModal(){
      this.renderBMList();
      this.bmModal.classList.add("visible");
    }
    renderBMList(){
      const q = (this.bmSearch.value || "").toLowerCase();
      this.bmList.innerHTML = "";
      if(this.bmEntries.length===0){
        this.bmList.textContent = "No bold memories stored.";
        return;
      }
      const filtered = this.bmEntries.filter(e=>e.text.toLowerCase().includes(q));
      filtered.forEach(entry=>{
        const div = document.createElement("div");
        div.className="bm-item";
        div.innerHTML = `<div class="bm-item-header">${entry.date.toLocaleTimeString()} ¬∑ ${entry.category.toUpperCase()} ¬∑ E‚ÇÄ: ${entry.e0.toFixed(3)}</div><div class="bm-item-text">${entry.text}</div>`;
        this.bmList.appendChild(div);
      });
    }
    openConvModal(){
      this.renderConvList();
      this.convModal.classList.add("visible");
    }
    renderConvList(){
      this.convList.innerHTML = "";
      this.tmHistory.slice(-50).reverse().forEach(e=>{
        const div = document.createElement("div");
        div.className="conv-item";
        const roleText = e.role === "ai" ? "AURA-X Œ©" : "You";
        div.innerHTML = `<div class="conv-header">${roleText} ¬∑ ${e.timestamp.toLocaleTimeString()}</div><div class="conv-text">${e.text}</div>`;
        this.convList.appendChild(div);
      });
    }
    clearBMByHours(h){
      const cutoff = Date.now() - h*3600000;
      this.bmEntries = this.bmEntries.filter(e=>e.timestampMs<cutoff);
      this.renderBMList();
      this.updateMetrics();
      alert(`Deleted Bold Memories older than ${h} hours.`);
    }
    pruneOldBM(){
      this.bmEntries = this.bmEntries.filter(e=>e.timestampMs > (Date.now() - 48*3600000));
    }
  }

  window.addEventListener("DOMContentLoaded",()=>{
    window.auraX = new AuraXOmegaEngine();
  });
})();
</script>
</body>
</html>
