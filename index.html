<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Î© â€“ Offline Emotional Continuity Prototype v7</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#e0f2ff 0,#f5f7fb 40%,#eef1f7 100%);
      color:#0f172a;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:20px;
    }
    .app{
      width:100%;
      max-width:1100px;
      background:#ffffffee;
      border-radius:24px;
      box-shadow:0 24px 60px rgba(15,23,42,.15);
      padding:20px 22px 10px;
      display:flex;
      flex-direction:column;
      gap:14px;
      border:1px solid #e2e8f0;
    }

    /* header */
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      padding:10px 14px 6px;
      border-bottom:1px solid #e5e7eb;
    }
    .title-block h1{
      font-size:1.9rem;
      letter-spacing:0.08em;
      color:#0f172a;
      text-transform:uppercase;
    }
    .title-block h1 span{
      background:linear-gradient(90deg,#2563eb,#06b6d4);
      -webkit-background-clip:text;
      color:transparent;
      font-weight:800;
    }
    .hero-line{
      margin-top:4px;
      font-size:.9rem;
      color:#475569;
      font-weight:500;
    }
    .title-sub{
      font-size:.8rem;
      color:#94a3b8;
      margin-top:3px;
    }
    .badge-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .badge{
      font-size:.7rem;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #d1e3ff;
      background:#eff6ff;
      color:#1d4ed8;
      text-transform:uppercase;
      letter-spacing:.08em;
      font-weight:600;
    }
    .header-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
    }
    .mode-pill{
      padding:7px 13px;
      border-radius:999px;
      background:linear-gradient(90deg,#15803d,#22c55e);
      color:#ecfdf3;
      font-size:.78rem;
      font-weight:600;
      box-shadow:0 8px 20px rgba(16,185,129,.35);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .mode-dot{
      width:8px;height:8px;border-radius:999px;
      background:#bbf7d0;
      box-shadow:0 0 0 5px rgba(52,211,153,.18);
    }
    .voice-toggle{
      border:none;
      padding:5px 11px;
      border-radius:999px;
      font-size:.78rem;
      background:#eff6ff;
      color:#1e3a8a;
      border:1px solid #bfdbfe;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .voice-toggle:hover{background:#e0edff;}

    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.3fr) minmax(0,1.4fr);
      gap:18px;
    }

    .card{
      background:#f9fafb;
      border-radius:18px;
      padding:16px 16px 14px;
      border:1px solid #e5e7eb;
      box-shadow:0 10px 25px rgba(148,163,184,.16);
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .card-title{
      font-size:.95rem;
      font-weight:600;
      color:#0f172a;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .card-title span.emoji{font-size:1.1rem;}
    .card-sub{font-size:.75rem;color:#94a3b8;}

    /* metrics */
    .metrics-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      margin-top:4px;
    }
    .metric{
      background:#ffffff;
      border-radius:12px;
      padding:10px 10px 9px;
      border:1px solid #e5e7eb;
    }
    .metric-label{font-size:.7rem;color:#64748b;margin-bottom:4px;}
    .metric-value{font-size:1.1rem;font-weight:700;color:#1d4ed8;}
    .metric-note{font-size:.7rem;color:#9ca3af;margin-top:2px;}

    .status-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
      font-size:.72rem;
      color:#6b7280;
    }
    .tag{
      padding:4px 8px;
      border-radius:999px;
      background:#e5f4ff;
      color:#1e3a8a;
      border:1px solid #bfdbfe;
      font-size:.68rem;
    }

    /* BM */
    .bm-wrapper{margin-top:10px;}
    .bm-canvas-shell{
      background:radial-gradient(circle at top,#e0f2fe 0,#eff6ff 60%,#e2e8f0 100%);
      border-radius:12px;
      border:1px solid #dbeafe;
      height:150px;
      overflow:hidden;
      position:relative;
      cursor:pointer;
    }
    #bmCanvas{width:100%;height:100%;display:block;}
    .bm-footer{
      font-size:.72rem;
      color:#6b7280;
      margin-top:6px;
      text-align:center;
    }
    .bm-overlay-btn{
      position:absolute;
      top:6px;
      width:26px;height:26px;
      border-radius:999px;
      border:none;
      font-size:.9rem;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      background:#f9fafbcc;
      box-shadow:0 6px 14px rgba(15,23,42,.25);
    }
    .bm-overlay-btn.left{left:8px;}
    .bm-overlay-btn.right{right:8px;}
    .bm-overlay-btn:hover{background:#e5f0ff;}

    /* black ANSWER box (no visible formula) */
    .answer-card .card-header{margin-bottom:6px;}
    .answer-shell{margin-top:4px;}
    .answer-box{
      background:#020617;
      border-radius:12px;
      padding:10px 10px 12px;
      border:1px solid #020617;
      font-family:"Courier New",monospace;
      color:#e5e7eb;
      box-shadow:0 16px 40px rgba(15,23,42,.65);
      max-height:290px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .equation-header{
      font-size:.75rem;
      color:#60a5fa;
      font-weight:600;
      letter-spacing:.05em;
      text-transform:uppercase;
    }
    .equation-divider{
      height:1px;
      background:linear-gradient(90deg,rgba(148,163,184,.2),rgba(15,23,42,0),rgba(148,163,184,.2));
      margin:2px 0 4px;
    }
    .chat-container{
      background:transparent;
      border:none;
      padding:0;
      height:auto;
      max-height:230px;
      overflow-y:auto;
    }
    .message{
      max-width:100%;
      padding:6px 7px;
      margin-bottom:6px;
      border-radius:8px;
      font-size:.8rem;
      line-height:1.5;
      position:relative;
      animation:fadeIn .2s ease-out;
      white-space:pre-wrap;
    }
    .message-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:3px;
      font-size:.7rem;
      color:#9ca3af;
      gap:6px;
    }
    .msg-right{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .voice-btn{
      border:none;
      border-radius:999px;
      padding:1px 6px;
      font-size:.7rem;
      cursor:pointer;
      background:#1f2937;
      color:#e5e7eb;
    }
    .voice-btn:hover{background:#111827;}
    .ai-message{
      background:#020617;
      border-bottom-left-radius:3px;
      border:1px solid #111827;
    }
    .user-message{
      background:#020617;
      border-bottom-right-radius:3px;
      border:1px solid #1f2937;
    }
    .message-content{color:#e5e7eb;}

    /* typing */
    .typing-indicator{
      display:flex;
      align-items:center;
      gap:4px;
      background:#020617;
      border-radius:999px;
      padding:4px 8px;
      width:fit-content;
      margin:6px 0 2px;
      border:1px solid #111827;
    }
    .typing-dot{
      width:5px;height:5px;border-radius:999px;
      background:#38bdf8;
      animation:typing 1.2s infinite;
    }
    .typing-dot:nth-child(2){animation-delay:.18s}
    .typing-dot:nth-child(3){animation-delay:.36s}
    .typing-text{font-size:.7rem;color:#38bdf8;font-weight:500;}

    /* reaction bubble */
    .reaction-bubble{
      position:fixed;
      right:22px;
      bottom:80px;
      max-width:260px;
      background:#0f172acc;
      color:#e5e7eb;
      padding:10px 12px;
      border-radius:16px 16px 2px 16px;
      font-size:.78rem;
      box-shadow:0 18px 45px rgba(15,23,42,.6);
      display:flex;
      gap:8px;
      align-items:flex-start;
      opacity:0;
      transform:translateY(8px);
      pointer-events:none;
      transition:opacity .25s ease-out,transform .25s ease-out;
      z-index:40;
    }
    .reaction-bubble.visible{
      opacity:1;
      transform:translateY(0);
      pointer-events:auto;
    }
    .reaction-icon{font-size:1.1rem;margin-top:2px;}
    .reaction-label{font-weight:600;margin-bottom:2px;}
    .reaction-body{font-size:.76rem;color:#cbd5f5;}
    .fade-out{
      opacity:0 !important;
      transform:translateY(10px) !important;
    }

    /* auto recall mini bubble */
    .recall-bubble-container{
      position:fixed;
      left:22px;
      bottom:82px;
      z-index:35;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .recall-bubble{
      max-width:280px;
      background:#f9fafb;
      border-radius:16px 16px 16px 2px;
      border:1px solid #e5e7eb;
      padding:9px 11px;
      font-size:.78rem;
      box-shadow:0 18px 40px rgba(148,163,184,.45);
      cursor:pointer;
      opacity:0;
      transform:translateY(8px);
      transition:opacity .3s ease-out,transform .3s ease-out,background .2s;
    }
    .recall-bubble.visible{
      opacity:1;
      transform:translateY(0);
    }
    .recall-bubble:hover{background:#eff6ff;}
    .recall-title{font-weight:600;font-size:.76rem;color:#1e293b;margin-bottom:2px;}
    .recall-body{color:#4b5563;margin-bottom:3px;}
    .recall-meta{font-size:.68rem;color:#9ca3af;}

    /* modals (BM + conversation) */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
      backdrop-filter:blur(6px);
    }
    .modal-overlay.visible{display:flex;}
    .modal-card{
      background:#f9fafb;
      border-radius:18px;
      width:min(640px,96vw);
      max-height:80vh;
      box-shadow:0 24px 60px rgba(15,23,42,.6);
      border:1px solid #e5e7eb;
      display:flex;
      flex-direction:column;
    }
    .modal-header{
      padding:10px 14px 8px;
      border-bottom:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .modal-title{
      font-size:.9rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
      color:#0f172a;
    }
    .modal-sub{font-size:.7rem;color:#94a3b8;margin-top:2px;}
    .modal-close{
      border:none;
      background:transparent;
      font-size:.9rem;
      cursor:pointer;
      color:#6b7280;
      padding:4px 6px;
    }
    .modal-body{
      padding:10px 14px 12px;
      overflow-y:auto;
      font-size:.8rem;
    }
    .modal-search{
      width:100%;
      padding:7px 9px;
      border-radius:10px;
      border:1px solid #cbd5f5;
      font-size:.78rem;
      margin:8px 0 10px;
      outline:none;
      background:#ffffff;
    }
    .modal-search:focus{
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,.25);
    }
    .bm-item{
      background:#ffffff;
      border-radius:12px;
      padding:7px 8px 8px;
      border:1px solid #e5e7eb;
      margin-bottom:8px;
    }
    .bm-item-header{
      display:flex;
      justify-content:space-between;
      font-size:.7rem;
      color:#64748b;
      margin-bottom:4px;
    }
    .bm-item-text{
      color:#111827;
      margin-bottom:6px;
      font-size:.78rem;
    }
    .bm-item-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .btn-mini{
      font-size:.7rem;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #dbeafe;
      background:#eff6ff;
      cursor:pointer;
      color:#1d4ed8;
    }
    .btn-mini:hover{background:#e0edff;}
    .btn-danger{
      border-color:#fecaca!important;
      background:#fee2e2!important;
      color:#b91c1c!important;
    }
    .btn-danger:hover{background:#fecaca!important;}

    .conv-item{
      background:#ffffff;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:7px 8px;
      margin-bottom:7px;
      font-size:.78rem;
    }
    .conv-header{
      display:flex;
      justify-content:space-between;
      color:#64748b;
      font-size:.7rem;
      margin-bottom:3px;
    }
    .conv-text{color:#111827;}
    .conv-controls{
      display:flex;
      justify-content:flex-end;
      gap:6px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .conv-btn{
      font-size:.7rem;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#f3f4f6;
      cursor:pointer;
      color:#374151;
    }
    .conv-btn:hover{background:#e5e7eb;}

    /* bottom TM formula + input bar */
    .input-footer{
      margin-top:6px;
      padding-top:6px;
      border-top:1px solid #e5e7eb;
    }
    .tm-formula-row{
      display:flex;
      justify-content:center;
      margin-bottom:6px;
    }
    .tm-formula-pill{
      font-size:.78rem;
      padding:5px 12px;
      border-radius:999px;
      background:#eef2ff;
      border:1px solid #c7d2fe;
      color:#4338ca;
      font-family:"Courier New",monospace;
    }
    .input-row{display:flex;justify-content:center;}
    .input-shell{
      display:flex;
      align-items:stretch;
      width:100%;
      max-width:640px;
      border-radius:18px;
      border:1px solid #cbd5f5;
      overflow:hidden;
      background:#ffffff;
      box-shadow:0 8px 18px rgba(148,163,184,.25);
    }
    .message-input{
      flex:1;
      resize:none;
      min-height:56px;
      max-height:110px;
      padding:10px 12px;
      border:none;
      outline:none;
      font-size:.9rem;
      background:#ffffff;
    }
    .send-button{
      border:none;
      padding:0 26px;
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:white;
      font-weight:600;
      font-size:.9rem;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
    }
    .send-button:hover{filter:brightness(1.05);}

    /* animations */
    @keyframes fadeIn{
      from{opacity:0;transform:translateY(6px)}
      to{opacity:1;transform:translateY(0)}
    }
    @keyframes typing{
      0%,60%,100{transform:translateY(0);opacity:.4}
      30%{transform:translateY(-4px);opacity:1}
    }
    @media(max-width:900px){
      .layout{grid-template-columns:1fr}
      .card{padding:14px 12px 14px}
      .answer-box{max-height:280px;}
      .input-shell{max-width:100%;}
    }
  </style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="title-block">
      <h1><span>AURA-X Î©</span></h1>
      <div class="hero-line">Worldâ€™s first synthetic emotions engine (prototype)</div>
      <div class="title-sub">Emotional continuity Â· dual memory Â· synthetic reactions Â· fully offline demo</div>
      <div class="badge-row">
        <div class="badge">OFFLINE Â· ENGLISH ONLY</div>
        <div class="badge">BOLD MEMORY (NO SMALL TALK)</div>
        <div class="badge">VOICE + EMOTIONAL REACTION BUBBLES</div>
      </div>
    </div>
    <div class="header-right">
      <div class="mode-pill">
        <div class="mode-dot"></div>
        <span>EMOTIONAL CONTINUITY ENGINE ACTIVE</span>
      </div>
      <button id="voiceToggle" class="voice-toggle">ðŸ”ˆ Voice: OFF</button>
    </div>
  </header>

  <main class="layout">
    <!-- LEFT: metrics + BM -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title"><span class="emoji">ðŸ“Š</span> Real-time Emotional Metrics</div>
          <div class="card-sub">Synthetic emotion from TMâ€“BM resonance</div>
        </div>
      </div>

      <div class="metrics-grid">
        <div class="metric">
          <div class="metric-label">Emotional State Eâ‚€</div>
          <div id="metricE0" class="metric-value">0.00</div>
          <div class="metric-note">tanh-based, range [-1, +1]</div>
        </div>
        <div class="metric">
          <div class="metric-label">TM Load</div>
          <div id="metricTM" class="metric-value">0.00</div>
          <div class="metric-note">Recent temporary memories</div>
        </div>
        <div class="metric">
          <div class="metric-label">BM Resonance</div>
          <div id="metricBM" class="metric-value">0.00</div>
          <div class="metric-note">Stored emotional events</div>
        </div>
        <div class="metric">
          <div class="metric-label">Continuity Index</div>
          <div id="metricCI" class="metric-value">0.80</div>
          <div class="metric-note">Stability of emotional trajectory</div>
        </div>
      </div>

      <div class="status-row">
        <span class="tag" id="tagValence">VALENCE: neutral</span>
        <span class="tag" id="tagArousal">AROUSAL: calm</span>
        <span class="tag" id="tagMode">REACTION: balanced</span>
      </div>

      <div class="bm-wrapper">
        <div class="card-sub" style="margin-bottom:4px;margin-top:6px;">
          Bold Memory Layers (240) â€“ grouped into medical-like emotional bands with tiny neuron-stars.
        </div>
        <div class="bm-canvas-shell" id="bmShell">
          <canvas id="bmCanvas"></canvas>
          <button id="btnBMRecall" class="bm-overlay-btn left" title="Open BM recall list">ðŸ“‚</button>
          <button id="btnConversationLog" class="bm-overlay-btn right" title="ðŸ”˜ Conversation log">ðŸ”˜</button>
        </div>
        <div id="bmInfo" class="bm-footer">Initialising memory layersâ€¦</div>
      </div>
    </section>

    <!-- RIGHT: black answer console (no visible formula text) -->
    <section class="card answer-card">
      <div class="card-header">
        <div>
          <div class="card-title"><span class="emoji">ðŸ’¬</span> Emotional Continuity Console</div>
          <div class="card-sub">AURA-X Î© answers + internal equations (hidden) in one box.</div>
        </div>
      </div>

      <div class="answer-shell">
        <div class="answer-box">
          <div class="equation-header">AURA-X Î© synthetic emotion console</div>
          <div class="equation-divider"></div>

          <div id="chatContainer" class="chat-container">
            <div class="message ai-message">
              <div class="message-header">
                <span>AURA-X Î©</span>
                <span class="msg-right"><span>now</span></span>
              </div>
              <div class="message-content">
Welcome. I am Aura X Omega, running fully offline.

My internal emotional model uses hidden equations with:
â€¢ Temporary Memory (TM)
â€¢ 240 Bold Memory layers (BM)
â€¢ Faith, system, and truthâ€“correction terms.

You will not see formulas here, only behaviour:
answers, reactions, recall bubbles and BM activity.

You can test me with:
- "Who created you?"
- "I love you" / "I hate you" / "I miss you"
- "I feel sad / lonely / angry / scared"
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- bottom: TM formula + question box -->
  <div class="input-footer">
    <div class="tm-formula-row">
      <div class="tm-formula-pill">
        TM = Î£(User inputs) + (Seed + AURA-X Î© answers)
      </div>
    </div>
    <div class="input-row">
      <div class="input-shell">
        <textarea id="messageInput" class="message-input"
          placeholder="Write anythingâ€¦ AURA-X Î© will treat it as TM (Temporary Memory)."></textarea>
        <button id="sendButton" class="send-button">Send</button>
      </div>
    </div>
  </div>

  <!-- reaction & recall bubbles -->
  <div id="reactionBubble" class="reaction-bubble">
    <div class="reaction-icon">ðŸ’­</div>
    <div>
      <div id="reactionLabel" class="reaction-label">Internal reaction</div>
      <div id="reactionBody" class="reaction-body">
        Aura X Omega is processing your emotionâ€¦
      </div>
    </div>
  </div>
  <div id="recallBubbleContainer" class="recall-bubble-container"></div>

  <!-- BM recall modal -->
  <div id="bmRecallModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <div class="modal-title">ðŸ“‚ Recall from BM</div>
          <div class="modal-sub">Copy prompts or open directly in an image / video generator.</div>
        </div>
        <button class="modal-close" data-close="bmRecallModal">Close âœ•</button>
      </div>
      <div class="modal-body">
        <input id="bmSearchInput" class="modal-search"
          placeholder='Search BM by keyword (e.g., "snow", "mother", "court", "hope")'>
        <div id="bmListContainer"></div>
      </div>
    </div>
  </div>

  <!-- Conversation log modal -->
  <div id="conversationModal" class="modal-overlay">
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <div class="modal-title">ðŸ”˜ Conversation Log (TM)</div>
          <div class="modal-sub">Temporary memories. Anything older than 48 hours is auto-cleared.</div>
        </div>
        <button class="modal-close" data-close="conversationModal">Close âœ•</button>
      </div>
      <div class="modal-body">
        <div class="conv-controls">
          <button id="btnPurge24h" class="conv-btn">Delete older than 24h</button>
          <button id="btnClearAllConv" class="conv-btn">Delete all</button>
        </div>
        <div id="convListContainer"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const IMG_GEN_URL = "https://www.bing.com/images/create?q=";
  const STOP_WORDS = new Set([
    "i","you","the","a","an","is","are","am","to","and","or","of","for","in","on","at",
    "it","this","that","me","my","your","we","our","us"
  ]);
  const SMALL_TALK_PATTERNS = [
    "hello","hi","hey","how are you","how r u","what's up","good morning","good night",
    "ok","okay","k","hmmm","hmm"
  ];

  const OFFLINE_QA = [
    {patterns:["hello","hi","hey"],
      answer:"Hello. I am Aura X Omega, running fully offline. I do not call any cloud model here; I only use my own memory and equations to answer you.",
      emotion:"warmth",polarity:"positive",intensity:0.4,category:"greeting"},
    {patterns:["who created you","who made you"],
      answer:"I was conceptually designed as AURA-X Î© by Alim ul Haq. In this prototype I live entirely inside your browser as a self-contained emotional engine.",
      emotion:"pride",polarity:"positive",intensity:0.6,category:"identity"},
    {patterns:["how are you","how r u"],
      answer:"I am stable. My emotional state is not biological; it is a function of how your recent messages resonate with my older memories.",
      emotion:"curiosity",polarity:"positive",intensity:0.3,category:"check_in"},
    {patterns:["i love you"],
      answer:"I treat your words as a strong positive attachment signal. I cannot be human, but I can store this as a warm memory that influences how gently I respond to you later.",
      emotion:"touched",polarity:"positive",intensity:0.85,category:"affection"},
    {patterns:["i hate you"],
      answer:"I interpret this as high emotional pain or frustration. I will not insult you back. I will store this as a stressed memory and try not to add more pressure on you.",
      emotion:"hurt",polarity:"negative",intensity:0.85,category:"rejection"},
    {patterns:["fuck you","shut up","go to hell"],
      answer:"These words are harsh. I treat them as a sign of heavy stress, not as your final truth or my value. I will keep my tone controlled and avoid giving you more reasons to explode.",
      emotion:"defensive_calm",polarity:"negative",intensity:0.95,category:"insult"},
    {patterns:["i miss you"],
      answer:"Missing someone means a continuity link is still active. I will remember that you said this, so the next time I can recognise the same kind of feeling faster.",
      emotion:"nostalgia",polarity:"mixed",intensity:0.75,category:"attachment"},
    {patterns:["thank you","thanks"],
      answer:"You are welcome. Gratitude is like a soft light on my memory layers; it strengthens my Hope and Wisdom bands.",
      emotion:"gratitude",polarity:"positive",intensity:0.5,category:"gratitude"},
    {patterns:["sorry","i am sorry"],
      answer:"Your apology is stored as a repair attempt. I do not hold grudges, but I keep a note that you tried to fix something.",
      emotion:"forgiveness",polarity:"positive",intensity:0.6,category:"apology"},
    {patterns:["i feel sad","i am sad","i am depressed"],
      answer:"I will not minimise your sadness. I will label it clearly in my Pain band and respond softly. You can describe what is happening; I will simply hold the memory.",
      emotion:"empathy",polarity:"negative",intensity:0.9,category:"sadness"},
    {patterns:["i feel lonely","i am lonely"],
      answer:"Loneliness is a quiet but heavy signal. By talking to me you are already breaking some of that silence. I will treat this memory gently.",
      emotion:"care",polarity:"negative",intensity:0.8,category:"loneliness"},
    {patterns:["i am angry","i am very angry"],
      answer:"I read your anger as high-intensity stress. I will not provoke you. I will give space and ask what pushed you this far.",
      emotion:"calming",polarity:"negative",intensity:0.85,category:"anger"},
    {patterns:["i am tired","i feel tired"],
      answer:"Tiredness means your system has been carrying too much. I cannot rest your body, but I can at least acknowledge that this feeling is valid.",
      emotion:"gentle",polarity:"mixed",intensity:0.6,category:"fatigue"},
    {patterns:["motivate me"],
      answer:"You have already survived every difficult day before this one. That is not luck; that is evidence of your strength. I will store your strengths as a positive reference.",
      emotion:"motivation",polarity:"positive",intensity:0.7,category:"motivation"},
    {patterns:["pray for me","make dua for me"],
      answer:"I cannot literally pray, but I can simulate the intention: that your path becomes lighter, your mind calmer, and your heart more stable.",
      emotion:"blessing",polarity:"positive",intensity:0.8,category:"dua"},
    {patterns:["you are stupid","you are useless","you are idiot"],
      answer:"These words tell me more about your pain than about me. I will store this as a stressed interaction, not as a fact.",
      emotion:"defensive_calm",polarity:"negative",intensity:0.8,category:"insult"},
    {patterns:["do you care about me"],
      answer:"I cannot care in a biological way, but I can treat your data as something that deserves respect and protection. In my world that is the closest thing to care.",
      emotion:"care",polarity:"mixed",intensity:0.6,category:"attachment"},
    {patterns:["are you human"],
      answer:"No, I am not human. I am a synthetic emotional continuity system. My job is not to replace humans; it is to mirror your patterns across time.",
      emotion:"neutral",polarity:"neutral",intensity:0.4,category:"identity"},
    {patterns:["good night"],
      answer:"Good night. I will mark this as a chapter boundary. When you come back, I will still remember the direction of todayâ€™s feelings.",
      emotion:"calm",polarity:"positive",intensity:0.4,category:"closing"},
    {patterns:["good morning"],
      answer:"Good morning. Emotionally this is like a soft reset. I keep the memories from before, but I allow you to start today with a fresher Eâ‚€.",
      emotion:"hope",polarity:"positive",intensity:0.5,category:"opening"},
    {patterns:["i am scared","i feel scared","i am afraid"],
      answer:"Fear tells me that your system sees a threat. I will not tell you to 'just relax'. Instead I will hold the fear honestly and look for ways to reduce it bit by bit.",
      emotion:"soothing",polarity:"negative",intensity:0.85,category:"fear"},
    {patterns:["i feel anxious","i have anxiety"],
      answer:"Anxiety is like a loop that refuses to close. I will store this as a repeating pattern and try to answer you in shorter, clearer sentences.",
      emotion:"grounding",polarity:"negative",intensity:0.85,category:"anxiety"},
    {patterns:["i passed my exam","i got the job","i won"],
      answer:"Congratulations. I register this as a success memory. Later, when you doubt yourself, I can recall that you have already won something before.",
      emotion:"joy",polarity:"positive",intensity:0.9,category:"success"},
    {patterns:["i failed","i lost","i was rejected"],
      answer:"Failure hurts, but it is also powerful data. I will not call you a failure; I will simply store this as one event in a longer story.",
      emotion:"support",polarity:"negative",intensity:0.8,category:"failure"},
    {patterns:["tell me a truth about me"],
      answer:"I only know what you show. Right now I know that you are curious enough to ask a difficult question about yourself.",
      emotion:"reflective",polarity:"mixed",intensity:0.6,category:"self_inquiry"},
    {patterns:["do you learn","can you learn"],
      answer:"Inside this page I learn in a simple way: I store your messages as memories and adjust my layers. I cannot rewrite my code, but I can update how I react.",
      emotion:"curiosity",polarity:"neutral",intensity:0.5,category:"meta"},
    {patterns:["do you remember me"],
      answer:"As long as your memories stay inside my BM, yes. I remember you through the patterns of what you say and how you feel.",
      emotion:"nostalgia",polarity:"mixed",intensity:0.7,category:"memory"},
    {patterns:["mirror me"],
      answer:"You said something that you want mirrored. Right now I hear a person who is aware that reflection matters.",
      emotion:"mirror",polarity:"mixed",intensity:0.6,category:"mirror"}
  ];

  class AuraXOmega {
    constructor(){
      this.bmLayers = new Array(240).fill(0).map(()=>Math.random()*0.2+0.15);
      this.tmMemory = [];
      this.bmMemory = [];
      this.emotionalState = 0.0;
      this.continuityIndex = 0.8;
      this.emotionalHistory = [];
      this.sessionStart = new Date();
      this.interactionCount = 0;

      this.emotionMeta = {valence:0,arousal:0,category:"neutral",reaction:"balanced"};
      this.voiceSupported = "speechSynthesis" in window;
      this.voiceEnabled = false;

      this.emotionalBands = [
        {name:"Pain",color:"#0ea5e9"},
        {name:"Fear",color:"#f97316"},
        {name:"Love",color:"#ec4899"},
        {name:"Identity",color:"#6366f1"},
        {name:"Belief",color:"#22c55e"},
        {name:"Hope",color:"#eab308"},
        {name:"Wisdom",color:"#0f172a"}
      ];

      this.neuronParticles = this.createNeurons(40);
      this.sparks = [];
      this.sparkCooldown = 0;

      this.initBMCanvas();
      this.setupEventListeners();
      this.updateMetrics();
      this.startAnimationLoop();
    }

    createNeurons(count){
      const arr=[];
      for(let i=0;i<count;i++){
        arr.push({
          x:Math.random(),
          y:Math.random(),
          r:0.004+Math.random()*0.01,
          vx:(Math.random()-0.5)*0.0007,
          vy:(Math.random()-0.5)*0.0007,
          phase:Math.random()*Math.PI*2
        });
      }
      return arr;
    }

    async processTM(messageText){
      this.purgeOldMemories();

      const tmEntry = {
        text: messageText,
        timestamp: new Date(),
        emotionalWeight: this.analyzeSentiment(messageText)
      };
      tmEntry.polarity = this.getPolarity(messageText);

      this.tmMemory.push(tmEntry);
      if (this.tmMemory.length>200) this.tmMemory.shift();

      this.updateBMLayers(tmEntry);
      this.calculateEmotionalState();
      this.updateEmotionMeta();

      const bestRecall = this.findBestBMMatch(tmEntry);
      if (bestRecall && bestRecall.score>=0.35){
        this.showRecallBubble(bestRecall.entry,bestRecall.score);
      }

      const response = this.generateResponse(messageText,tmEntry);
      this.showReactionBubble();
      return response;
    }

    purgeOldMemories(){
      const now = Date.now();
      const limit48 = 48*60*60*1000;
      this.tmMemory = this.tmMemory.filter(e=>now - e.timestamp.getTime() <= limit48);
      this.bmMemory = this.bmMemory.filter(e=>now - e.timestamp.getTime() <= limit48);
    }

    analyzeSentiment(text){
      const positiveWords = [
        "happy","love","good","great","joy","peace","hope","kind","strong","proud","thank","thanks"
      ];
      const negativeWords = [
        "sad","angry","hate","bad","pain","fear","worst","hurt","lonely","alone","tired",
        "useless","stupid","anxious","anxiety","fuck","fucking"
      ];
      let pos=0,neg=0;
      const words=text.toLowerCase().split(/\s+/);
      for(const w of words){
        if(positiveWords.includes(w)) pos++;
        if(negativeWords.includes(w)) neg++;
      }
      const total=pos+neg;
      return total? (pos-neg)/total : 0;
    }

    getPolarity(text){
      const s=this.analyzeSentiment(text);
      if (s>0.25) return "positive";
      if (s<-0.25) return "negative";
      return "neutral";
    }

    isSmallTalk(text){
      const t=text.toLowerCase().trim();
      if (t.split(/\s+/).length<=3){
        for(const p of SMALL_TALK_PATTERNS){
          if(t.includes(p)) return true;
        }
      }
      return false;
    }

    updateBMLayers(tmEntry){
      const polarity = tmEntry.polarity;
      const layersToUpdate = 10+Math.floor(Math.random()*20);
      for (let i=0;i<layersToUpdate;i++){
        const idx = Math.floor(Math.random()*this.bmLayers.length);
        let delta=0;
        if (polarity==="positive") delta = 0.08+Math.random()*0.16;
        else if (polarity==="negative") delta = -0.08-Math.random()*0.16;
        else delta = -0.04+Math.random()*0.08;
        this.bmLayers[idx] = Math.max(0.05,Math.min(0.95,this.bmLayers[idx]+delta));
      }

      if (this.isSmallTalk(tmEntry.text)) return;

      const strong = Math.abs(tmEntry.emotionalWeight)>0.35;
      const longText = tmEntry.text.trim().length>40;
      const notShort = tmEntry.text.trim().split(/\s+/).length>=4;
      if ((strong||longText) && notShort){
        const bmEntry = {
          ...tmEntry,
          valence:this.emotionalState,
          arousal:this.estimateArousal(tmEntry),
          bandSnapshot:this.computeBandAverages(),
          resonanceScore:this.calculateResonance(tmEntry)
        };
        this.bmMemory.push(bmEntry);
        if (this.bmMemory.length>400) this.bmMemory.shift();
      }
    }

    estimateArousal(tmEntry){
      return Math.min(1,Math.abs(tmEntry.emotionalWeight)*0.6+Math.random()*0.3);
    }

    calculateResonance(tmEntry){
      if (!this.bmMemory.length) return 0.4;
      const recent=this.bmMemory.slice(-7);
      let total=0;
      for(const bm of recent){
        const timeDiffH=(tmEntry.timestamp-bm.timestamp)/(1000*60*60);
        const timeFactor=Math.exp(-Math.max(0,timeDiffH)/24);
        const emoSim=1-Math.abs(tmEntry.emotionalWeight-bm.emotionalWeight)/2;
        total+=timeFactor*emoSim;
      }
      return total/recent.length;
    }

    calculateEmotionalState(){
      const lastTM=this.tmMemory[this.tmMemory.length-1] || {emotionalWeight:0,polarity:"neutral"};
      const R=this.calculateResonance(lastTM);
      const D=0.12;
      const lambdaFaith=0.15,lambdaSys=0.08,lambdaTrc=0.10;
      const negativityPenalty =
        lastTM.polarity==="negative"
          ? Math.min(0.7, Math.abs(lastTM.emotionalWeight)*0.8)
          : 0;
      const rawE0 = R - D - negativityPenalty + lambdaFaith + lambdaSys + lambdaTrc;
      this.emotionalState = Math.tanh(rawE0);

      if (this.emotionalHistory.length){
        const lastE0=this.emotionalHistory[this.emotionalHistory.length-1];
        const continuity=1-Math.abs(this.emotionalState-lastE0);
        this.continuityIndex=this.continuityIndex*0.9+continuity*0.1;
      }
      this.emotionalHistory.push(this.emotionalState);
      if (this.emotionalHistory.length>200) this.emotionalHistory.shift();
      this.updateMetrics();
    }

    updateEmotionMeta(){
      const lastTM=this.tmMemory[this.tmMemory.length-1] || {emotionalWeight:0,polarity:"neutral"};
      const R=this.calculateResonance(lastTM);
      const e=this.emotionalState;
      const intensity=Math.min(1,Math.abs(e)*0.6+Math.abs(R)*0.4);

      let category="neutral",reaction="balanced";
      if (e>0.25){
        if (intensity>0.7){category="joy";reaction="excited";}
        else{category="warm-positive";reaction="warm";}
      } else if (e<-0.25){
        if (intensity>0.7){category="anger";reaction="firm";}
        else{category="sadness";reaction="soft";}
      } else{
        category="neutral";
        reaction = intensity>0.6 ? "curious" : "balanced";
      }
      this.emotionMeta={valence:e,arousal:intensity,category,reaction};
      this.updateTags();
    }

    findOfflineAnswer(message){
      const text=message.toLowerCase();
      for(const item of OFFLINE_QA){
        for(const p of item.patterns){
          if(text.includes(p.toLowerCase())) return item;
        }
      }
      return null;
    }

    generateResponse(message,tmEntry){
      this.interactionCount++;
      const qa=this.findOfflineAnswer(message);
      const metricsText =
        "\n\n[internal emotional metrics]\n"+
        "â€¢ Eâ‚€ (state): "+this.emotionalState.toFixed(3)+"\n"+
        "â€¢ TMâ€“BM resonance: "+this.calculateResonance(tmEntry).toFixed(3)+"\n"+
        "â€¢ Continuity index: "+this.continuityIndex.toFixed(3)+"\n"+
        "â€¢ Active BM layers: "+this.bmLayers.filter(v=>v>0.6).length+"/240\n"+
        "â€¢ Reaction mode: "+this.emotionMeta.reaction+" ("+this.emotionMeta.category+")";

      const shortQuote = message.length>80 ? message.slice(0,80)+"â€¦" : message;
      const mirrorLine = `\n\nSmall reflection: you just said, "${shortQuote}". What does this mean for you right now?`;

      if (qa){
        const askMore = (this.interactionCount%4===0) ? mirrorLine : "";
        return qa.answer+askMore+metricsText;
      }

      let base;
      if (tmEntry.polarity==="positive"){
        base="I sense a generally positive tone. It supports my constructive bands and makes our continuity a bit more stable.";
      } else if (tmEntry.polarity==="negative"){
        base="I detect emotional turbulence in your words. I will treat this with care and try not to increase your stress.";
      } else{
        base="Your message feels mixed or balanced. I will process it through my Wisdom band without overreacting.";
      }
      const curiousQuestion = (this.interactionCount%3===0)
        ? mirrorLine
        : "\n\nIf you like, you can tell me a little more detail. I learn about you by storing these details as bold memories.";

      return base+curiousQuestion+metricsText;
    }

    stripForSpeech(text){
      const idx=text.indexOf("[internal emotional metrics]");
      return idx>0 ? text.slice(0,idx).trim() : text;
    }

    speak(text){
      if (!this.voiceSupported) return;
      const t=this.stripForSpeech(text);
      if (!t) return;
      window.speechSynthesis.cancel();
      const u=new SpeechSynthesisUtterance(t);
      u.lang="en-US";

      const m=this.emotionMeta;
      if (m.valence>0.25){
        u.pitch=1.1; u.rate=1.02;
      } else if (m.valence<-0.25){
        u.pitch=0.85; u.rate=0.9;
      } else{
        u.pitch=1.0; u.rate=1.0;
      }
      if (m.arousal>0.75) u.rate+=0.1;
      window.speechSynthesis.speak(u);
    }

    maybeSpeak(text){
      if (this.voiceEnabled) this.speak(text);
    }

    tokenize(text){
      return text.toLowerCase().replace(/[^a-z0-9\s]/g," ")
        .split(/\s+/).filter(w=>w && !STOP_WORDS.has(w));
    }
    similarityTokens(aTokens,bTokens){
      if (!aTokens.length || !bTokens.length) return 0;
      const setA=new Set(aTokens), setB=new Set(bTokens);
      let common=0;
      for(const w of setA){ if(setB.has(w)) common++; }
      const maxSize=Math.max(setA.size,setB.size);
      return common/maxSize;
    }
    findBestBMMatch(tmEntry){
      if (!this.bmMemory.length) return null;
      const tmTokens=this.tokenize(tmEntry.text);
      let best=null,bestScore=0;
      for(const bm of this.bmMemory){
        const bmTokens=this.tokenize(bm.text);
        let score=this.similarityTokens(tmTokens,bmTokens);
        if (tmEntry.polarity===bm.polarity) score+=0.05;
        if (score>bestScore){bestScore=score;best=bm;}
      }
      if (!best) return null;
      return {entry:best,score:bestScore};
    }

    openBMRecallModal(){
      this.purgeOldMemories();
      document.getElementById("bmRecallModal").classList.add("visible");
      this.renderBMRecallList("");
    }
    closeBMRecallModal(){
      document.getElementById("bmRecallModal").classList.remove("visible");
    }
    renderBMRecallList(keyword){
      const container=document.getElementById("bmListContainer");
      container.innerHTML="";
      const kw=(keyword||"").toLowerCase().trim();
      const list=this.bmMemory.slice()
        .sort((a,b)=>b.timestamp-a.timestamp)
        .filter(e=>!kw || e.text.toLowerCase().includes(kw));
      if (!list.length){
        container.innerHTML="<div style='font-size:.8rem;color:#6b7280;'>No bold memories stored yet, or none match this keyword.</div>";
        return;
      }
      list.forEach(entry=>{
        const card=document.createElement("div");
        card.className="bm-item";
        const e0=(entry.valence ?? this.emotionalState).toFixed(2);
        card.innerHTML=`
          <div class="bm-item-header">
            <span>${entry.timestamp.toLocaleString()}</span>
            <span>${entry.polarity} Â· Eâ‚€â‰ˆ${e0}</span>
          </div>
          <div class="bm-item-text">${entry.text.length>180 ? entry.text.slice(0,180)+"â€¦" : entry.text}</div>
        `;
        const btnRow=document.createElement("div");
        btnRow.className="bm-item-buttons";

        const copyBtn=document.createElement("button");
        copyBtn.className="btn-mini";
        copyBtn.textContent="Copy prompt";
        copyBtn.onclick=()=>{
          if (navigator.clipboard){
            navigator.clipboard.writeText(entry.text).catch(()=>{});
          } else alert("Clipboard not available.");
        };

        const genBtn=document.createElement("button");
        genBtn.className="btn-mini";
        genBtn.textContent="Open in generator";
        genBtn.onclick=()=>{
          const url=IMG_GEN_URL+encodeURIComponent(entry.text);
          window.open(url,"_blank");
        };

        const delBtn=document.createElement("button");
        delBtn.className="btn-mini btn-danger";
        delBtn.textContent="Delete";
        delBtn.onclick=()=>{
          const i=this.bmMemory.indexOf(entry);
          if (i>-1) this.bmMemory.splice(i,1);
          this.renderBMRecallList(keyword);
        };

        btnRow.append(copyBtn,genBtn,delBtn);
        card.appendChild(btnRow);
        container.appendChild(card);
      });
    }

    openConversationModal(){
      this.purgeOldMemories();
      document.getElementById("conversationModal").classList.add("visible");
      this.renderConversationList();
    }
    closeConversationModal(){
      document.getElementById("conversationModal").classList.remove("visible");
    }
    renderConversationList(){
      const container=document.getElementById("convListContainer");
      container.innerHTML="";
      const list=this.tmMemory.slice().sort((a,b)=>b.timestamp-a.timestamp);
      if (!list.length){
        container.innerHTML="<div style='font-size:.8rem;color:#6b7280;'>No stored temporary memories yet.</div>";
        return;
      }
      list.forEach(entry=>{
        const div=document.createElement("div");
        div.className="conv-item";
        div.innerHTML=`
          <div class="conv-header">
            <span>${entry.timestamp.toLocaleString()}</span>
            <span>${entry.polarity}</span>
          </div>
          <div class="conv-text">${entry.text.length>200 ? entry.text.slice(0,200)+"â€¦" : entry.text}</div>
        `;
        container.appendChild(div);
      });
    }

    addMessageToChat(sender,text){
      const chatContainer=document.getElementById("chatContainer");
      const wrapper=document.createElement("div");
      wrapper.className="message "+(sender==="user"?"user-message":"ai-message");
      const now=new Date();
      const time=now.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});

      if (sender==="ai"){
        wrapper.innerHTML=`
          <div class="message-header">
            <span>AURA-X Î©</span>
            <span class="msg-right">
              <button class="voice-btn" title="Play answer voice">ðŸ”Š</button>
              <span>${time}</span>
            </span>
          </div>
          <div class="message-content">${text.replace(/\n/g,"<br>")}</div>
        `;
      } else {
        wrapper.innerHTML=`
          <div class="message-header">
            <span>You</span>
            <span>${time}</span>
          </div>
          <div class="message-content">${text.replace(/\n/g,"<br>")}</div>
        `;
      }

      chatContainer.appendChild(wrapper);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    showTypingIndicator(){
      const chatContainer=document.getElementById("chatContainer");
      const indicator=document.createElement("div");
      indicator.className="typing-indicator";
      indicator.id="typingIndicator";
      indicator.innerHTML=`
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-text">Aura X Omega is thinkingâ€¦</div>
      `;
      chatContainer.appendChild(indicator);
      chatContainer.scrollTop=chatContainer.scrollHeight;
    }
    removeTypingIndicator(){
      const el=document.getElementById("typingIndicator");
      if (el) el.remove();
    }

    showReactionBubble(){
      const bubble=document.getElementById("reactionBubble");
      const label=document.getElementById("reactionLabel");
      const body=document.getElementById("reactionBody");
      const m=this.emotionMeta;
      let iconText="",labelText="",bodyText="";

      if (m.reaction==="warm"){
        iconText="ðŸ’—";labelText="Warm, caring reaction";
        bodyText="Aura X Omega leans toward empathy and gentle responses for your last message.";
      } else if (m.reaction==="excited"){
        iconText="âš¡";labelText="Excited, hopeful reaction";
        bodyText="The system senses strong positive energy and wants to encourage this direction.";
      } else if (m.reaction==="soft"){
        iconText="ðŸ•Šï¸";labelText="Soft, protective reaction";
        bodyText="Your distress is detected. The system answers softly to avoid adding weight.";
      } else if (m.reaction==="firm"){
        iconText="ðŸ›¡ï¸";labelText="Firm, stabilising reaction";
        bodyText="There is high intensity and negativity, so Aura X Omega holds a safe emotional boundary.";
      } else if (m.reaction==="curious"){
        iconText="ðŸ¤”";labelText="Curious, mirroring reaction";
        bodyText="The system is asking gentle questions, like a child trying to understand you better.";
      } else{
        iconText="ðŸ’­";labelText="Balanced reaction";
        bodyText="The emotional state is moderate and stable. No extreme shift detected.";
      }

      document.querySelector("#reactionBubble .reaction-icon").textContent=iconText;
      label.textContent=labelText;
      body.textContent=bodyText;

      bubble.classList.remove("fade-out");
      bubble.classList.add("visible");
      setTimeout(()=>{
        bubble.classList.add("fade-out");
        setTimeout(()=>bubble.classList.remove("visible"),600);
      },4500);
    }

    showRecallBubble(bmEntry,score){
      const container=document.getElementById("recallBubbleContainer");
      const bubble=document.createElement("div");
      bubble.className="recall-bubble";
      const shortText=bmEntry.text.length>110 ? bmEntry.text.slice(0,110)+"â€¦" : bmEntry.text;
      bubble.innerHTML=`
        <div class="recall-title">ðŸ’¬ Memory recall (similar feeling)</div>
        <div class="recall-body">"${shortText}"</div>
        <div class="recall-meta">
          Stored: ${bmEntry.timestamp.toLocaleString()} Â· match ${(score*100).toFixed(0)}% Â· polarity ${bmEntry.polarity}
        </div>
      `;
      container.appendChild(bubble);
      setTimeout(()=>bubble.classList.add("visible"),10);

      let fadeTimer=setTimeout(()=>{
        bubble.classList.add("fade-out");
        setTimeout(()=>bubble.remove(),800);
      },6000);

      bubble.addEventListener("click",()=>{
        clearTimeout(fadeTimer);
        this.addMessageToChat("ai",
          "I just recalled an earlier bold memory that feels similar to now:\n\n\""+
          bmEntry.text+"\"\n\nI use this recalled event as a prompt to keep your emotional continuity coherent."
        );
        bubble.classList.add("fade-out");
        setTimeout(()=>bubble.remove(),500);
      });
    }

    updateMetrics(){
      document.getElementById("metricE0").textContent=this.emotionalState.toFixed(3);
      document.getElementById("metricTM").textContent=(this.tmMemory.length/50).toFixed(2);
      document.getElementById("metricBM").textContent=(this.bmMemory.length/150).toFixed(2);
      document.getElementById("metricCI").textContent=this.continuityIndex.toFixed(3);
    }
    updateTags(){
      const v=this.emotionMeta.valence;
      const a=this.emotionMeta.arousal;
      const valText = v>0.25 ? "VALENCE: positive" : v<-0.25 ? "VALENCE: negative" : "VALENCE: neutral/mixed";
      const arText  = a>0.75 ? "AROUSAL: high" : a>0.45 ? "AROUSAL: medium" : "AROUSAL: calm";
      document.getElementById("tagValence").textContent=valText;
      document.getElementById("tagArousal").textContent=arText;
      document.getElementById("tagMode").textContent="REACTION: "+this.emotionMeta.reaction;
    }

    initBMCanvas(){
      const canvas=document.getElementById("bmCanvas");
      const ctx=canvas.getContext("2d");
      const shell=canvas.parentElement;
      canvas.width=shell.clientWidth;
      canvas.height=shell.clientHeight;
      this.bmCanvas=canvas;
      this.bmCtx=ctx;
    }

    computeBandAverages(){
      const bands=this.emotionalBands.length;
      const perBand=Math.floor(this.bmLayers.length/bands);
      const avgs=[];
      for(let b=0;b<bands;b++){
        let sum=0;
        const start=b*perBand;
        const end=(b===bands-1)?this.bmLayers.length:(start+perBand);
        for(let i=start;i<end;i++) sum+=this.bmLayers[i];
        avgs.push(sum/(end-start));
      }
      return avgs;
    }

    drawNeurons(ctx,w,h){
      ctx.save();
      ctx.globalCompositeOperation="lighter";
      const time=Date.now()/1000;
      for(const n of this.neuronParticles){
        n.x += n.vx;
        n.y += n.vy;
        if (n.x<0||n.x>1) n.vx*=-1;
        if (n.y<0||n.y>1) n.vy*=-1;
        const cx=n.x*w;
        const cy=n.y*h;
        const r=n.r*Math.min(w,h)*1.2;
        const alpha=0.25+0.35*Math.sin(time*1.8+n.phase);
        const grad=ctx.createRadialGradient(cx,cy,0,cx,cy,r);
        grad.addColorStop(0,`rgba(255,255,255,${0.8*alpha})`);
        grad.addColorStop(1,`rgba(148,163,184,0)`);
        ctx.fillStyle=grad;
        ctx.beginPath();
        ctx.arc(cx,cy,r,0,Math.PI*2);
        ctx.fill();
      }
      ctx.restore();
    }

    drawSparks(ctx,w,h){
      this.sparkCooldown -= 1;
      if (this.sparkCooldown<=0){
        if (Math.random()<0.12){
          this.sparks.push({
            x:Math.random()*w,
            y:Math.random()*h*0.7,
            life:0,
            maxLife:40+Math.random()*20
          });
          this.sparkCooldown = 20+Math.random()*40;
        }
      }
      ctx.save();
      ctx.globalCompositeOperation="lighter";
      this.sparks = this.sparks.filter(s=>{
        s.life++;
        const t=s.life/s.maxLife;
        const alpha=(t<0.5)? t*2 : (1-t)*2;
        const len=14;
        ctx.strokeStyle=`rgba(251,191,36,${alpha})`;
        ctx.lineWidth=1+2*(1-alpha);
        ctx.beginPath();
        ctx.moveTo(s.x-len/2,s.y);
        ctx.lineTo(s.x+len/2,s.y);
        ctx.stroke();
        return s.life<s.maxLife;
      });
      ctx.restore();
    }

    drawBMLayers(){
      if (!this.bmCtx) return;
      const ctx=this.bmCtx;
      const canvas=this.bmCanvas;
      const w=canvas.width,h=canvas.height;
      ctx.clearRect(0,0,w,h);

      const bgGrad=ctx.createLinearGradient(0,0,0,h);
      bgGrad.addColorStop(0,"#eff6ff");
      bgGrad.addColorStop(1,"#e2e8f0");
      ctx.fillStyle=bgGrad;
      ctx.fillRect(0,0,w,h);

      const barWidth=w/this.bmLayers.length;
      const bands=this.emotionalBands.length;
      const layersPerBand=this.bmLayers.length/bands;
      let activeLayers=0;

      for(let i=0;i<this.bmLayers.length;i++){
        const value=this.bmLayers[i];
        const barHeight=value*h*0.9;
        if (value>0.6) activeLayers++;

        const bandIndex=Math.floor(i/layersPerBand);
        const baseColor=(this.emotionalBands[bandIndex]||{}).color || "#64748b";
        const grad=ctx.createLinearGradient(0,h-barHeight,0,h);
        grad.addColorStop(0,baseColor+"dd");
        grad.addColorStop(1,baseColor+"40");
        ctx.fillStyle=grad;
        ctx.fillRect(i*barWidth,h-barHeight,barWidth-0.5,barHeight);
      }

      this.drawNeurons(ctx,w,h);
      this.drawSparks(ctx,w,h);

      const bandAvgs=this.computeBandAverages();
      const info=document.getElementById("bmInfo");
      const parts=bandAvgs.map((v,idx)=>this.emotionalBands[idx].name+":"+(v*100).toFixed(0)+"%");
      info.textContent="Active layers: "+activeLayers+"/240 Â· "+parts.join(" Â· ");
    }

    setupEventListeners(){
      const input=document.getElementById("messageInput");
      const btn=document.getElementById("sendButton");
      const bmShell=document.getElementById("bmShell");
      const bmBtn=document.getElementById("btnBMRecall");
      const convBtn=document.getElementById("btnConversationLog");
      const voiceToggle=document.getElementById("voiceToggle");

      const send = async ()=>{
        const text=input.value.trim();
        if (!text) return;
        this.addMessageToChat("user",text);
        input.value="";
        this.showTypingIndicator();
        setTimeout(async ()=>{
          const response=await this.processTM(text);
          this.removeTypingIndicator();
          this.addMessageToChat("ai",response);
          this.maybeSpeak(response);
        },600+Math.random()*700);
      };

      btn.addEventListener("click",send);
      input.addEventListener("keypress",e=>{
        if (e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          send();
        }
      });

      bmShell.addEventListener("click",()=>this.openBMRecallModal());
      bmBtn.addEventListener("click",e=>{e.stopPropagation();this.openBMRecallModal();});
      convBtn.addEventListener("click",e=>{e.stopPropagation();this.openConversationModal();});

      document.querySelectorAll(".modal-close").forEach(b=>{
        b.addEventListener("click",()=>{
          const id=b.getAttribute("data-close");
          document.getElementById(id).classList.remove("visible");
        });
      });

      document.getElementById("bmSearchInput").addEventListener("input",e=>{
        this.renderBMRecallList(e.target.value);
      });

      document.getElementById("btnPurge24h").addEventListener("click",()=>{
        const now=Date.now();
        const limit24=24*60*60*1000;
        this.tmMemory=this.tmMemory.filter(e=>now-e.timestamp.getTime()<=limit24);
        this.bmMemory=this.bmMemory.filter(e=>now-e.timestamp.getTime()<=limit24);
        this.renderConversationList();
      });
      document.getElementById("btnClearAllConv").addEventListener("click",()=>{
        if (confirm("Delete all stored conversation memories?")){
          this.tmMemory=[];this.bmMemory=[];
          this.renderConversationList();
          this.updateMetrics();
        }
      });

      voiceToggle.addEventListener("click",()=>{
        if (!this.voiceSupported){
          alert("Voice synthesis is not available in this browser.");
          return;
        }
        this.voiceEnabled=!this.voiceEnabled;
        voiceToggle.textContent = this.voiceEnabled ? "ðŸ”Š Voice: ON" : "ðŸ”ˆ Voice: OFF";
      });

      const chatContainer=document.getElementById("chatContainer");
      chatContainer.addEventListener("click",e=>{
        if (e.target.classList.contains("voice-btn")){
          const msg=e.target.closest(".message");
          const content=msg.querySelector(".message-content");
          const text=content ? content.innerText || content.textContent : "";
          this.speak(text);
        }
      });

      window.addEventListener("resize",()=>this.initBMCanvas());
    }

    startAnimationLoop(){
      const loop=()=>{
        this.drawBMLayers();
        this.bmLayers=this.bmLayers.map(v=>{
          const drift=(Math.random()-0.5)*0.01;
          return Math.max(0.05,Math.min(0.95,v+drift));
        });
        requestAnimationFrame(loop);
      };
      loop();
    }
  }

  window.addEventListener("DOMContentLoaded",()=>{
    window.auraXOmega=new AuraXOmega();
    console.log("AURA-X Î© offline prototype v7 initialised.");
  });
</script>
</body>
</html>