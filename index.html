<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Offline LLM package (WebLLM ‚Äì placeholder, ready for wiring) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 18px 10px;
    }

    .app {
      width: min(980px, 98vw);
      background: rgba(2,6,23,.45);
      border: 1px solid rgba(148,163,184,.18);
      border-radius: 22px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }

    .top {
      padding: 20px 18px 10px;
      border-bottom: 1px solid rgba(148,163,184,.14);
      text-align: center;
    }

    .brand {
      font-weight: 800;
      letter-spacing: .5px;
      font-size: 26px;
      color: #7dd3fc;
      text-shadow: 0 0 22px rgba(14,165,233,.28);
    }

    .sub {
      opacity: .8;
      margin-top: 2px;
      font-size: 13px;
    }

    .ethic {
      margin: 14px auto 12px;
      max-width: 720px;
      border: 1px solid rgba(251,191,36,.35);
      border-radius: 14px;
      padding: 12px 14px;
      color: #fbbf24;
      background: rgba(2,6,23,.35);
      box-shadow: inset 0 0 0 1px rgba(251,191,36,.08);
      font-size: 14px;
      line-height: 1.45;
    }

    .pill {
      margin: 10px auto 0;
      max-width: 760px;
      background: linear-gradient(90deg, rgba(14,165,233,.65), rgba(34,211,238,.45));
      border: 1px solid rgba(125,211,252,.30);
      color: #0b1220;
      font-weight: 800;
      letter-spacing: .6px;
      border-radius: 999px;
      padding: 14px 16px;
      text-transform: uppercase;
      box-shadow: 0 12px 40px rgba(14,165,233,.22);
    }

    .main {
      padding: 16px 16px 18px;
    }

    .row {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      align-items: stretch;
    }

    .leftCol { flex: 1 1 340px; min-width: 300px; }
    .rightCol { flex: 1 1 360px; min-width: 320px; }

    .card {
      background: rgba(2,6,23,.50);
      border: 1px solid rgba(148,163,184,.16);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    }

    .optionsBtn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.55);
      color: #e5e7eb;
      cursor: pointer;
      user-select: none;
      margin: 12px 0;
      -webkit-tap-highlight-color: transparent;
    }
    .optionsBtn:active { transform: scale(.99); }

    .gear {
      width: 18px;
      height: 18px;
      filter: drop-shadow(0 0 10px rgba(125,211,252,.25));
    }

    .console {
      margin-top: 12px;
      height: 230px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(0,0,0,.25);
      padding: 14px;
      overflow: auto;
      font-family: ui-monospace,Menlo,Consolas,monospace;
      font-size: 14px;
      box-shadow: inset 0 0 0 1px rgba(125,211,252,.06);
      line-height: 1.55;
      white-space: pre-wrap;
    }

    .line { display: block; margin: 2px 0; }

    .chatWrap {
      margin-top: 14px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.45);
    }

    .liveCapsule {
      margin: 10px 0;
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
      padding: 10px 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      font-family: ui-monospace,Menlo,Consolas,monospace;
      font-size: 12px;
      color: #dbeafe;
      box-shadow: inset 0 0 0 1px rgba(125,211,252,.06);
    }
    .liveCapsule b { color: #7dd3fc; font-weight: 900; }

    .faithBubble {
      margin: 4px 0 10px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(251,191,36,.16);
      border: 1px solid rgba(251,191,36,.4);
      display: none;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #facc15;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      transition: opacity .25s ease, transform .25s ease;
    }
    .faithBubble.show { display: flex; opacity: 1; transform: translateY(0); }

    .fbIcon { font-size: 18px; }
    .fbText { flex: 1; line-height: 1.3; }
    .fbTitle { font-weight: 800; }
    .fbMeta { opacity: .85; }
    .fbClose {
      border: none;
      background: transparent;
      color: #fed7aa;
      font-size: 16px;
      cursor: pointer;
      padding: 0 4px;
      line-height: 1;
    }

    .inputRow {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
      color: #e5e7eb;
      padding: 12px 14px;
      outline: none;
      font-size: 14px;
    }

    .send {
      border: none;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(14,165,233,.85), rgba(34,211,238,.55));
      color: #0b1220;
      font-weight: 900;
      padding: 12px 18px;
      cursor: pointer;
      min-width: 88px;
      box-shadow: 0 12px 30px rgba(14,165,233,.18);
      -webkit-tap-highlight-color: transparent;
    }
    .send:active { transform: scale(.99); }

    .formula {
      margin-top: 10px;
      opacity: .8;
      font-size: 12px;
      text-align: center;
      font-family: ui-monospace,Menlo,Consolas,monospace;
      color: #dbeafe;
    }

    .optionsMenu {
      position: fixed;
      left: 12px;
      right: 12px;
      top: 120px;
      margin: 0 auto;
      max-width: 940px;
      background: rgba(2,6,23,.92);
      border: 1px solid rgba(148,163,184,.18);
      border-radius: 16px;
      padding: 8px;
      display: none;
      z-index: 99999;
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      grid-template-columns: repeat(3,minmax(0,1fr));
      gap: 8px;
      align-items: stretch;
    }
    .optionsMenu.show { display: grid; }

    .menuItem {
      padding: 8px 6px;
      border-radius: 13px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 6px;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,.10);
      background: rgba(15,23,42,.55);
      user-select: none;
      min-height: 58px;
    }
    .menuItem:active { transform: scale(.995); }

    .menuLeft {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-weight: 800;
      font-size: 12.5px;
    }

    .menuIcon {
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .menuRight {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 44px;
    }

    .pillOn, .pillOff, .pillMid {
      font-size: 10px;
      padding: 4px 7px;
      border-radius: 999px;
      font-weight: 900;
      text-transform: lowercase;
      border: 1px solid transparent;
    }

    .pillOn {
      background: rgba(34,197,94,.18);
      border-color: rgba(34,197,94,.24);
      color: #bbf7d0;
    }

    .pillOff {
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.22);
      color: #fecaca;
    }

    .pillMid {
      background: rgba(14,165,233,.14);
      border-color: rgba(14,165,233,.20);
      color: #bae6fd;
      opacity: .95;
    }

    .modalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: flex-end;
      justify-content: center;
      padding: 18px 12px;
      z-index: 9999;
    }
    .modalOverlay.show { display: flex; }

    .modal {
      width: min(860px,96vw);
      border-radius: 18px;
      overflow: hidden;
      background: rgba(250,250,250,.93);
      color: #0b1220;
      border: 1px solid rgba(15,23,42,.18);
      box-shadow: 0 30px 80px rgba(0,0,0,.35);
      backdrop-filter: blur(12px);
    }

    .modalHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      background: rgba(255,255,255,.75);
      border-bottom: 1px solid rgba(15,23,42,.10);
      font-weight: 800;
    }

    .modalHeader small {
      font-weight: 600;
      opacity: .7;
    }

    .closeX {
      border: none;
      background: transparent;
      font-size: 22px;
      cursor: pointer;
      line-height: 1;
      padding: 0 4px;
      opacity: .75;
    }

    .modalBody {
      padding: 14px;
      max-height: 70vh;
      overflow: auto;
    }

    .chipsWrap {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .chip {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.16);
      background: rgba(255,255,255,.9);
      font-weight: 800;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      font-size: 13px;
    }

    .chip.active {
      background: #0f172a;
      color: #fff;
      border-color: rgba(15,23,42,.2);
      box-shadow: 0 12px 30px rgba(2,6,23,.12);
    }

    .btn {
      border: none;
      cursor: pointer;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 900;
      -webkit-tap-highlight-color: transparent;
      font-size: 12px;
    }
    .btnBlue { background: rgba(59,130,246,.16); border: 1px solid rgba(59,130,246,.22); }
    .btnDark { background: rgba(2,6,23,.92); color: #fff; }
    .btnRed  { background: rgba(239,68,68,.14); border: 1px solid rgba(239,68,68,.22); color:#7f1d1d; }
    .btnGreen{ background: rgba(34,197,94,.18); border: 1px solid rgba(34,197,94,.25); color:#064e2a; }

    .bmCard {
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.85);
      padding: 12px;
      margin-top: 12px;
    }

    .bmTop {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .bmTop .title {
      font-weight: 900;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bmSub {
      font-size: 12px;
      opacity: .7;
      margin-top: 2px;
    }

    .bmText {
      width: 100%;
      min-height: 200px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.18);
      padding: 12px;
      outline: none;
      resize: vertical;
      background: #fff;
      font-size: 14px;
      line-height: 1.45;
    }

    .bmActions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
      justify-content: flex-start;
    }

    .intelEditInput,
    .intelEditArea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(15,23,42,.18);
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      background: #fff;
    }

    .intelEditArea {
      min-height: 90px;
      resize: vertical;
      line-height: 1.4;
      margin-top: 6px;
    }

    @media (max-width:760px) {
      .console { height: 240px; }
      .optionsMenu { top: 112px; }
    }

    @media (max-width:420px) {
      .brand { font-size: 22px; }
      .pill { font-size: 14px; }
      .ethic { font-size: 13px; }
      .console { height: 260px; }
      .optionsMenu {
        gap: 6px;
        padding: 7px;
        grid-template-columns: repeat(3,minmax(0,1fr));
      }
      .menuItem {
        min-height: 52px;
        padding: 6px 4px;
      }
      .menuLeft { font-size: 11px; }
      .pillOn,.pillOff,.pillMid {
        font-size: 9.5px;
        padding: 4px 6px;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="top">
      <div class="brand">AURA-X Œ©</div>
      <div class="sub">
        Offline emotional continuity engine (prototype)<br>
        TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory.
      </div>
      <div class="ethic">
        Universal ethic: avoid actions that grow negative emotions in you or others. Move gently
        toward choices that increase shared positive feeling for everyone.
      </div>
      <div class="pill">EMOTIONAL CONTINUITY ENGINE ‚Äî ACTIVE</div>
    </div>

    <div class="main">
      <div class="row">
        <!-- LEFT -->
        <div class="leftCol">
          <div class="card">
            <div class="optionsBtn" id="btnOptions">
              <svg class="gear" viewBox="0 0 24 24" fill="none">
                <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"
                      stroke="#7dd3fc" stroke-width="2" />
                <path d="M19.4 15a8.2 8.2 0 0 0 .1-2l2-1.5-2-3.5-2.4 1a8.5 8.5 0 0 0-1.7-1l-.4-2.6h-4l-.4 2.6a8.5 8.5 0 0 0-1.7 1l-2.4-1-2 3.5 2 1.5a8.2 8.2 0 0 0 .1 2L2.7 16.5l2 3.5 2.4-1a8.5 8.5 0 0 0 1.7 1l.4 2.6h4l.4-2.6a8.5 8.5 0 0 0 1.7-1l2.4 1 2-3.5L19.4 15Z"
                      stroke="#7dd3fc" stroke-width="1.6" opacity=".9" />
              </svg>
              <span>Options</span>
            </div>

            <!-- Options Grid -->
            <div class="optionsMenu" id="optionsMenu">
              <div class="menuItem" id="miVoice">
                <div class="menuLeft"><span class="menuIcon">üé§</span><span>Voice</span></div>
                <div class="menuRight"><span class="pillOff" id="voicePill">off</span></div>
              </div>

              <div class="menuItem" id="miIntel">
                <div class="menuLeft"><span class="menuIcon">üß†</span><span>Intelligence</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>

              <div class="menuItem" id="miLearn">
                <div class="menuLeft"><span class="menuIcon">üìö</span><span>Learning</span></div>
                <div class="menuRight"><span class="pillOn" id="learnPill">on</span></div>
              </div>

              <div class="menuItem" id="miSeed">
                <div class="menuLeft"><span class="menuIcon">üå±</span><span>Feed</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>

              <div class="menuItem" id="miFaith">
                <div class="menuLeft"><span class="menuIcon">üïä</span><span>Faith</span></div>
                <div class="menuRight"><span class="pillOff" id="faithLabel">none</span></div>
              </div>

              <div class="menuItem" id="miIdentity">
                <div class="menuLeft"><span class="menuIcon">ü™™</span><span>Identity</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>

              <div class="menuItem" id="miLLM">
                <div class="menuLeft"><span class="menuIcon">ü§ñ</span><span>LLM</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>

              <div class="menuItem" id="miBMRecall">
                <div class="menuLeft"><span class="menuIcon">üìò</span><span>BM Recall</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>

              <div class="menuItem" id="miHistory">
                <div class="menuLeft"><span class="menuIcon">üìú</span><span>History</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
            </div>

            <div class="console" id="console"></div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="rightCol">
          <div class="chatWrap">
            <div class="liveCapsule">
              <span><b>E0</b>: <span id="cE0">0.000</span></span><span>¬∑</span>
              <span><b>TM</b>: <span id="cTM">0.00</span></span><span>¬∑</span>
              <span><b>BM</b>: <span id="cBM">0.00</span></span><span>¬∑</span>
              <span><b>C</b>: <span id="cCont">0.850</span></span>
            </div>

            <div class="faithBubble" id="faithBubble">
              <div class="fbIcon">üí≠</div>
              <div class="fbText">
                <div class="fbTitle" id="faithBubbleTitle">Faith reflection bubble</div>
                <div class="fbMeta" id="faithBubbleMeta">Tap to see a short suggestion.</div>
              </div>
              <button class="fbClose" id="faithBubbleClose">√ó</button>
            </div>

            <div class="inputRow">
              <input class="input" id="userInput"
                     placeholder="Talk to AURA-X Œ©‚Ä¶ (TM = your inputs)" />
              <button class="send" id="sendBtn">Send</button>
            </div>

            <div class="formula">
              E‚ÇÄ = tanh( R(TM,BM) + I(TM) + I<sub>intel</sub> + I<sub>LLM</sub> ‚àí D +
              Œª<sub>faith</sub> + Œª<sub>sys</sub> + Œª<sub>trc</sub> )
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Faith selection -->
  <div class="modalOverlay" id="modalFaith">
    <div class="modal">
      <div class="modalHeader">
        <div>‚öôÔ∏è AURA-X Œ© options<br>
          <small>Optional faith lens for encouragement lines.</small></div>
        <button class="closeX" data-close="modalFaith">√ó</button>
      </div>
      <div class="modalBody" style="background:#fdf7e5;">
        <div style="opacity:.8;font-size:13px;line-height:1.35;margin-bottom:8px">
          Universal ethics are always active. You can optionally pick one or more faith lenses.
          Nothing is sent to any server.
        </div>
        <div class="chipsWrap" id="faithChips"></div>
      </div>
    </div>
  </div>

  <!-- Faith Article -->
  <div class="modalOverlay" id="modalFaithArticle">
    <div class="modal">
      <div class="modalHeader">
        <div>üí≠ Faith reflection<br>
          <small>Story-related suggestion from your selected literature.</small></div>
        <button class="closeX" data-close="modalFaithArticle">√ó</button>
      </div>
      <div class="modalBody" style="background:#fefce8;">
        <div id="faithArticleMeta"
             style="font-size:12px;opacity:.75;margin-bottom:6px;"></div>
        <div id="faithArticleTitle"
             style="font-weight:800;margin-bottom:6px;"></div>
        <textarea id="faithArticleText"
          style="width:100%;min-height:160px;border-radius:14px;
                 border:1px solid rgba(15,23,42,.18);padding:10px;
                 font-size:13px;line-height:1.4;background:#fff;"></textarea>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;
                    justify-content:flex-end;">
          <button class="btn btnBlue" id="btnCopyFaithArticle">Copy</button>
          <button class="btn btnBlue" id="btnAddFaithToBM">Add under BM prompt</button>
          <button class="btn btnRed" id="btnSkipFaithBM">Skip</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Intelligence -->
  <div class="modalOverlay" id="modalIntel">
    <div class="modal">
      <div class="modalHeader">
        <div>üß† Intelligence<br><small>Stored Q ‚Üí A pairs.</small></div>
        <button class="closeX" data-close="modalIntel">√ó</button>
      </div>
      <div class="modalBody">
        <input id="intelSearch"
          style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);
                 padding:10px 12px;font-size:14px;outline:none"
          placeholder="Search intelligence..." />
        <div id="intelEditor" style="margin-top:10px;display:none;">
          <input id="intelEditQ" class="intelEditInput" placeholder="Question" />
          <textarea id="intelEditA" class="intelEditArea"
                    placeholder="Answer"></textarea>
          <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;
                      justify-content:flex-end;">
            <button class="btn btnBlue" id="btnIntelSave">Save</button>
            <button class="btn btnRed" id="btnIntelCancel">Cancel</button>
          </div>
        </div>
        <div id="intelList" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <!-- Seed (Feed) -->
  <div class="modalOverlay" id="modalSeed">
    <div class="modal">
      <div class="modalHeader">
        <div>üå± Feed the seed (protected)<br>
          <small>Add LaTeX Q ‚Üí A blocks directly into intelligence memory.</small></div>
        <button class="closeX" data-close="modalSeed">√ó</button>
      </div>
      <div class="modalBody">
        <div style="opacity:.75;font-size:13px;line-height:1.35;margin-bottom:10px">
          Paste a LaTeX block with \item questions and \textbf{A:} answers. You can optionally
          start each answer with
          <span style="font-family:ui-monospace">[polarity=positive; code=E031; intensity=0.8]</span>.
        </div>
        <!-- logic area kept visually clean: no default text, no status line -->
        <textarea id="seedBox"
          style="width:100%;min-height:150px;resize:vertical;border-radius:14px;
                 border:2px solid rgba(59,130,246,.25);padding:12px;font-size:14px;
                 outline:none;background:#fff"></textarea>
        <div style="display:flex;justify-content:space-between;align-items:center;
                    gap:10px;flex-wrap:wrap;margin-top:10px">
          <div style="font-size:12px;opacity:.7" id="seedHint">&nbsp;</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btnBlue" id="btnParseSeed">Parse block</button>
            <button class="btn btnBlue" id="btnSaveSeed">Save to seed</button>
            <button class="btn btnRed" id="btnDiscardSeed">Discard</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- LLM settings -->
  <div class="modalOverlay" id="modalLLM">
    <div class="modal">
      <div class="modalHeader">
        <div>ü§ñ LLM link<br><small>Offline LLM + optional online helper.</small></div>
        <button class="closeX" data-close="modalLLM">√ó</button>
      </div>
      <div class="modalBody">
        <div style="border-radius:14px;border:1px solid rgba(34,197,94,.25);
                    background:rgba(34,197,94,.12);padding:12px;">
          <div style="font-weight:900;">Offline LLM (WebLLM)</div>
          <div style="font-size:13px;opacity:.8;margin-top:6px;line-height:1.35">
            Loads a small local model in your browser (WebGPU required). On many mobile browsers
            this may not be supported.
          </div>
          <div style="margin-top:10px;">
            <button class="btn btnGreen" id="btnLoadOffline">Load offline model</button>
          </div>
          <div style="margin-top:8px;font-size:12px;opacity:.75">
            Status: <span id="offlineStatus">idle</span></div>
          <div style="margin-top:8px;height:10px;border-radius:999px;
                      background:rgba(2,6,23,.12);overflow:hidden;
                      border:1px solid rgba(2,6,23,.08)">
            <div id="offlineBar"
                 style="height:100%;width:0%;background:#22c55e;transition:width .2s ease;"></div>
          </div>
        </div>

        <div style="font-weight:900;margin-top:14px;">Online helper LLM (connects & works)</div>
        <div style="font-size:12px;opacity:.8;margin-top:4px;margin-bottom:4px;">
          Use any compatible API (OpenAI, DeepSeek, xAI, etc.). Nothing is stored on server by
          AURA-X Œ© itself.
        </div>

        <div style="margin-top:6px;">
          <label style="font-size:12px;opacity:.75;display:block;margin-bottom:4px;">
            API endpoint</label>
          <input id="apiEndpoint"
            style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);
                   padding:10px 12px;font-size:14px;outline:none;
                   background:rgba(255,255,255,.88)"
            value="https://api.openai.com/v1/chat/completions" />
        </div>

        <div style="margin-top:10px;">
          <label style="font-size:12px;opacity:.75;display:block;margin-bottom:4px;">
            Model</label>
          <input id="apiModel"
            style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);
                   padding:10px 12px;font-size:14px;outline:none;
                   background:rgba(255,255,255,.88)"
            value="gpt-4o-mini" />
        </div>

        <div style="margin-top:10px;">
          <label style="font-size:12px;opacity:.75;display:block;margin-bottom:4px;">
            API key (session only)</label>
          <input id="apiKey"
            style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);
                   padding:10px 12px;font-size:14px;outline:none;
                   background:rgba(255,255,255,.88)"
            placeholder="sk-..." />
        </div>

        <div style="margin-top:10px;display:flex;justify-content:flex-end;">
          <button class="btn btnBlue" id="btnSaveLLM">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- BM Recall -->
  <div class="modalOverlay" id="modalBM">
    <div class="modal">
      <div class="modalHeader">
        <div>üìò Recall from BM<br>
          <small>Only long stories and scenes (photo/video-ready).</small></div>
        <button class="closeX" data-close="modalBM">√ó</button>
      </div>
      <div class="modalBody">
        <div style="font-size:13px;opacity:.75">
          Select a BM prompt. Locked prompts must be unlocked first. Delete needs double
          confirmation.
        </div>

        <!-- NEW: date filter for BM recall -->
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <span style="font-size:12px;opacity:.75;">Filter by date:</span>
          <input type="date" id="bmDateFilter"
            style="border-radius:10px;border:1px solid rgba(15,23,42,.18);
                   padding:6px 8px;font-size:12px;">
          <button class="btn btnBlue" id="btnClearBMFilter">Clear</button>
        </div>

        <div id="bmSelectList" style="margin-top:8px;"></div>

        <div class="bmCard" id="bmViewer" style="display:none;">
          <div class="bmTop">
            <div>
              <div class="title"><span id="bmLockIcon">üîì</span>
                <span id="bmTitle">Prompt</span></div>
              <div class="bmSub" id="bmMeta"></div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
              <button class="btn btnBlue" id="btnLiveBM">Live 12h: off</button>
              <button class="btn btnBlue" id="btnUnlockBM" style="display:none;">Unlock</button>
            </div>
          </div>

          <textarea class="bmText" id="bmTextArea" readonly></textarea>

          <!-- Evidence notes + simple attachment metadata -->
          <textarea class="bmText" id="bmEvidenceArea"
            style="margin-top:8px;min-height:100px;"
            placeholder="Evidence notes: links or descriptions of photos, videos, voice notes for this memory. (Stored only on this device.)"></textarea>
          <div id="bmEvidenceInfo"
               style="font-size:12px;opacity:.7;margin-top:6px;"></div>
          <input type="file" id="bmFileInput" multiple
                 accept="image/*,video/*,audio/*" style="display:none;">

          <div class="bmActions">
            <button class="btn btnBlue" id="btnCopyPrompt">Copy prompt</button>
            <button class="btn btnBlue" id="btnAutoGen">Auto generate</button>
            <button class="btn btnBlue" id="btnAttachFiles">Add files</button>
            <button class="btn btnBlue" id="btnSaveEvidence">Save evidence</button>
            <button class="btn btnRed" id="btnDeletePrompt">Delete</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- History -->
  <div class="modalOverlay" id="modalHistory">
    <div class="modal">
      <div class="modalHeader">
        <div>üìú Conversation history<br>
          <small>Recent TM log (user + system messages).</small></div>
        <button class="closeX" data-close="modalHistory">√ó</button>
      </div>
      <div class="modalBody">
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
          <button class="btn btnBlue" id="btnDeleteRecent">Delete history last 48h</button>
          <button class="btn btnRed" id="btnDeleteAllHist">Delete all history</button>
          <button class="btn btnBlue" id="btnCopyHistory">Copy</button>
        </div>
        <div id="historyBox"
          style="margin-top:4px;border-radius:14px;padding:4px 0;
                 max-height:60vh;overflow:auto;"></div>
      </div>
    </div>
  </div>

  <!-- Identity -->
  <div class="modalOverlay" id="modalIdentity">
    <div class="modal">
      <div class="modalHeader">
        <div>ü™™ User identity<br>
          <small>Deep profiling for continuity & emotional cloning.</small></div>
        <button class="closeX" data-close="modalIdentity">√ó</button>
      </div>
      <div class="modalBody">
        <div style="opacity:.8;font-size:13px;line-height:1.35;margin-bottom:8px;">
          Stored only on this device. Saved data auto-locks conceptually; delete requires double
          confirmation. This form helps AURA-X Œ© mirror your voice, emotional style,
          relationships, and legacy.
        </div>

        <div style="display:grid;gap:10px;">
          <div style="border-radius:14px;border:1px solid rgba(15,23,42,.12);padding:10px;">
            <div style="font-weight:800;">1. Core identity</div>
            <div style="font-size:12px;opacity:.75;margin-top:4px;">
              Name, age range, where you live, languages, main roles (e.g., engineer, parent,
              student‚Ä¶).
            </div>
            <textarea id="idCore"
              style="margin-top:6px;width:100%;min-height:80px;border-radius:12px;
                     border:1px solid rgba(15,23,42,.18);padding:10px;font-size:13px;
                     line-height:1.4;"></textarea>
          </div>

          <div style="border-radius:14px;border:1px solid rgba(15,23,42,.12);padding:10px;">
            <div style="font-weight:800;">2. Life anchors</div>
            <div style="font-size:12px;opacity:.75;margin-top:4px;">
              Daily responsibilities, important projects, routines that shape your days.
            </div>
            <textarea id="idAnchors"
              style="margin-top:6px;width:100%;min-height:80px;border-radius:12px;
                     border:1px solid rgba(15,23,42,.18);padding:10px;font-size:13px;
                     line-height:1.4;"></textarea>
          </div>

          <div style="border-radius:14px;border:1px solid rgba(15,23,42,.12);padding:10px;">
            <div style="font-weight:800;">3. Relationships & circles</div>
            <div style="font-size:12px;opacity:.75;margin-top:4px;">
              Key people (family, friends, mentors), how close you feel, any boundaries.
            </div>
            <textarea id="idRelationships"
              style="margin-top:6px;width:100%;min-height:80px;border-radius:12px;
                     border:1px solid rgba(15,23,42,.18);padding:10px;font-size:13px;
                     line-height:1.4;"></textarea>
          </div>

          <div style="border-radius:14px;border:1px solid rgba(15,23,42,.12);padding:10px;">
            <div style="font-weight:800;">4. Emotional style</div>
            <div style="font-size:12px;opacity:.75;margin-top:4px;">
              How you react under stress, what calms you, typical thinking patterns.
            </div>
            <textarea id="idStyle"
              style="margin-top:6px;width:100%;min-height:80px;border-radius:12px;
                     border:1px solid rgba(15,23,42,.18);padding:10px;font-size:13px;
                     line-height:1.4;"></textarea>
          </div>

          <div style="border-radius:14px;border:1px solid rgba(15,23,42,.12);padding:10px;">
            <div style="font-weight:800;">5. Legacy / direction</div>
            <div style="font-size:12px;opacity:.75;margin-top:4px;">
              What you want to build, protect, or leave behind in this life.
            </div>
            <textarea id="idLegacy"
              style="margin-top:6px;width:100%;min-height:80px;border-radius:12px;
                     border:1px solid rgba(15,23,42,.18);padding:10px;font-size:13px;
                     line-height:1.4;"></textarea>
          </div>

          <div style="margin-top:4px;display:flex;gap:8px;flex-wrap:wrap;
                      justify-content:flex-end;">
            <button class="btn btnBlue" id="btnSaveIdentity">Save identity</button>
            <button class="btn btnRed" id="btnClearIdentity">Clear</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const $  = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));

      const STORAGE_KEY = "AURAX_OMEGA_V10";

      const defaultState = {
        console: [],
        faith: { selected: ["none"] },
        intel: [],
        history: [],
        bm: [],
        identity: {
          core: "",
          anchors: "",
          relationships: "",
          style: "",
          legacy: ""
        },
        llm: {
          endpoint: "https://api.openai.com/v1/chat/completions",
          model: "gpt-4o-mini"
        },
        settings: {
          voiceEnabled: false,
          learningEnabled: true
        },
        metrics: {
          E0: 0,
          TM: 0,
          BM: 0,
          continuity: 0.85
        }
      };

      function cloneDefault() {
        return JSON.parse(JSON.stringify(defaultState));
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return cloneDefault();
          const parsed = JSON.parse(raw);
          return Object.assign(cloneDefault(), parsed || {});
        } catch (e) {
          console.warn("AURA-X Œ©: failed to load state", e);
          return cloneDefault();
        }
      }

      function saveState() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
          console.warn("AURA-X Œ©: failed to save state", e);
        }
      }

      function escapeHtml(str) {
        return (str || "").replace(/[&<>"']/g, c => (
          { "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]
        ));
      }

      let state = loadState();
      if (!state.metrics) state.metrics = cloneDefault().metrics;
      if (!state.faith) state.faith = { selected: ["none"] };

      const consoleEl   = $("#console");
      const optionsMenu = $("#optionsMenu");
      const btnOptions  = $("#btnOptions");

      const cE0El   = $("#cE0");
      const cTMEl   = $("#cTM");
      const cBMEl   = $("#cBM");
      const cContEl = $("#cCont");

      const faithBubble      = $("#faithBubble");
      const faithBubbleMeta  = $("#faithBubbleMeta");
      const faithBubbleTitle = $("#faithBubbleTitle");
      const faithBubbleClose = $("#faithBubbleClose");

      const userInput = $("#userInput");
      const sendBtn   = $("#sendBtn");

      const FAITH_OPTIONS = [
        { id: "none",         label: "None" },
        { id: "islam",        label: "Islam" },
        { id: "christianity", label: "Christianity" },
        { id: "hinduism",     label: "Hinduism" },
        { id: "buddhism",     label: "Buddhism" },
        { id: "sikhism",      label: "Sikhism" },
        { id: "judaism",      label: "Judaism" },
        { id: "atheism",      label: "Atheism / Humanism" },
        { id: "other",        label: "Other / Mixed" },
        { id: "indigenous",   label: "Indigenous / Traditional" },
        { id: "eastern",      label: "Eastern / Chinese" }
      ];

      // Session-only API key (not saved to localStorage)
      let sessionApiKey = "";

      // --- Console logging ---------------------------------------------------
      function appendConsoleLine(entry) {
        const div = document.createElement("div");
        div.className = "line";
        div.textContent = `[${entry.time}] ${entry.tag.toUpperCase()}: ${entry.text}`;
        consoleEl.appendChild(div);
        consoleEl.scrollTop = consoleEl.scrollHeight;
      }

      function logConsole(text, tag = "sys") {
        const entry = {
          time: new Date().toLocaleTimeString(),
          tag,
          text
        };
        state.console.push(entry);
        if (state.console.length > 400) state.console.shift();
        appendConsoleLine(entry);
        saveState();
      }

      // --- Metrics -----------------------------------------------------------
      function updateMetricsDisplay() {
        const m = state.metrics || {};
        cE0El.textContent   = (m.E0   ?? 0).toFixed(3);
        cTMEl.textContent   = (m.TM   ?? 0).toFixed(2);
        cBMEl.textContent   = (m.BM   ?? 0).toFixed(2);
        cContEl.textContent = (m.continuity ?? 0.85).toFixed(3);
      }

      function updateMetricsFromMessage(text) {
        const len = (text || "").length;
        const TM  = Math.max(0.05, Math.min(1, len / 280));
        const bmCount = Array.isArray(state.bm) ? state.bm.length : 0;
        const BM  = Math.min(1, bmCount / 20 + (state.liveBMId ? 0.15 : 0));

        const historyLen = Array.isArray(state.history) ? state.history.length : 0;
        const continuity = Math.min(1, 0.6 + 0.4 * Math.min(1, historyLen / 80));

        const faithSel = state.faith && state.faith.selected || [];
        const lambdaFaith = (faithSel.length && !faithSel.includes("none")) ? 0.08 : 0;
        const lambdaSys   = 0.05;
        const lambdaTrc   = 0.07;
        const decay       = 0.10;

        const resonance   = (0.6 * TM + 0.4 * BM) * continuity;
        const E0          = Math.tanh(resonance - decay + lambdaFaith + lambdaSys + lambdaTrc);

        state.metrics = { E0, TM, BM, continuity };
        saveState();
        updateMetricsDisplay();
      }

      // --- Options menu ------------------------------------------------------
      function closeOptionsMenu() {
        optionsMenu.classList.remove("show");
      }

      btnOptions.addEventListener("click", () => {
        optionsMenu.classList.toggle("show");
      });

      document.addEventListener("click", (e) => {
        if (!optionsMenu.contains(e.target) && !btnOptions.contains(e.target)) {
          closeOptionsMenu();
        }
      });

      // --- Helpers for modals ------------------------------------------------
      function openModal(id) {
        const el = document.getElementById(id);
        if (el) el.classList.add("show");
      }

      function closeModal(id) {
        const el = document.getElementById(id);
        if (el) el.classList.remove("show");
      }

      $$(".closeX").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.close;
          if (id) closeModal(id);
        });
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          $$(".modalOverlay").forEach(m => m.classList.remove("show"));
          closeOptionsMenu();
        }
      });

      // --- Faith chips & bubble ---------------------------------------------
      const faithChipsEl = $("#faithChips");
      const faithLabel   = $("#faithLabel");

      function updateFaithLabel() {
        const sel = state.faith.selected || [];
        if (!sel.length || sel.includes("none")) {
          faithLabel.textContent = "none";
          faithLabel.className = "pillOff";
          faithBubble.classList.remove("show");
        } else {
          faithLabel.textContent = sel.length === 1 ? sel[0] : "multi";
          faithLabel.className = "pillOn";
        }
      }

      function renderFaithChips() {
        const sel = state.faith.selected || ["none"];
        faithChipsEl.innerHTML = "";
        FAITH_OPTIONS.forEach(opt => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "chip" + (sel.includes(opt.id) ? " active" : "");
          btn.textContent = opt.label;
          btn.addEventListener("click", () => toggleFaith(opt.id));
          faithChipsEl.appendChild(btn);
        });
        updateFaithLabel();
      }

      function toggleFaith(id) {
        let sel = state.faith.selected || [];
        if (id === "none") {
          sel = ["none"];
        } else {
          sel = sel.filter(x => x !== "none");
          if (sel.includes(id)) {
            sel = sel.filter(x => x !== id);
          } else {
            sel.push(id);
          }
        }
        if (!sel.length) sel = ["none"];
        state.faith.selected = sel;
        saveState();
        renderFaithChips();
      }

      function maybeShowFaithBubble(tmText) {
        const sel = state.faith.selected || [];
        if (!sel.length || sel.includes("none")) return;
        // Simple throttling: only sometimes
        if (Math.random() < 0.4) {
          state.lastFaithTM = tmText;
          faithBubbleTitle.textContent = "Faith lens active";
          faithBubbleMeta.textContent  = "Tap to see a gentle reflection for this moment.";
          faithBubble.classList.add("show");
        }
      }

      faithBubble.addEventListener("click", () => {
        if (!state.faith.selected || state.faith.selected.includes("none")) return;
        const selNames = state.faith.selected.join(", ");
        $("#faithArticleMeta").textContent =
          "Selected lenses: " + selNames + " ¬∑ locally generated note";
        $("#faithArticleTitle").textContent =
          "Soft reminder about balance, patience, and shared goodness";
        const tm = state.lastFaithTM || "";
        $("#faithArticleText").value =
          "Imagine a short teaching from your selected traditions about responding with wisdom " +
          "instead of pure reaction.\n\nRecent TM:\n" + tm;
        openModal("modalFaithArticle");
      });

      faithBubbleClose.addEventListener("click", (e) => {
        e.stopPropagation();
        faithBubble.classList.remove("show");
      });

      $("#btnCopyFaithArticle").addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText($("#faithArticleText").value || "");
          alert("Faith reflection copied.");
        } catch {
          alert("Copy failed (clipboard not available).");
        }
      });

      $("#btnAddFaithToBM").addEventListener("click", () => {
        const text = $("#faithArticleText").value || "";
        if (!text.trim()) return;
        const nowIso = new Date().toISOString();
        if (!Array.isArray(state.bm)) state.bm = [];
        state.bm.push({
          id: "faith-" + nowIso,
          title: "Faith reflection",
          text,
          locked: false,
          createdAt: nowIso,
          liveUntil: null,
          evidenceNote: "",
          files: []
        });
        saveState();
        logConsole("Faith reflection saved into BM.", "bm");
        closeModal("modalFaithArticle");
      });

      $("#btnSkipFaithBM").addEventListener("click", () => {
        closeModal("modalFaithArticle");
      });

      // --- Intelligence ------------------------------------------------------
      const intelSearch = $("#intelSearch");
      const intelList   = $("#intelList");
      const intelEditor = $("#intelEditor");
      const intelEditQ  = $("#intelEditQ");
      const intelEditA  = $("#intelEditA");
      const btnIntelSave   = $("#btnIntelSave");
      const btnIntelCancel = $("#btnIntelCancel");
      let currentIntelIndex = null;

      function renderIntelligenceList() {
        const term = (intelSearch.value || "").toLowerCase().trim();
        intelList.innerHTML = "";
        const items = state.intel || [];
        if (!items.length) {
          intelList.innerHTML =
            '<div style="font-size:12px;opacity:.7;">No stored Q ‚Üí A yet.</div>';
          return;
        }
        items.forEach((qa, idx) => {
          const hay = (qa.q + " " + qa.a).toLowerCase();
          if (term && !hay.includes(term)) return;
          const row = document.createElement("div");
          row.style.borderRadius = "12px";
          row.style.border = "1px solid rgba(15,23,42,.12)";
          row.style.padding = "8px 10px";
          row.style.marginBottom = "6px";
          row.style.cursor = "pointer";
          row.innerHTML =
            '<div style="font-weight:800;font-size:13px;">Q: ' +
            escapeHtml(qa.q) + '</div>' +
            '<div style="font-size:12px;opacity:.8;margin-top:2px;">A: ' +
            escapeHtml((qa.a || "").slice(0,140)) +
            ((qa.a || "").length > 140 ? "‚Ä¶" : "") +
            "</div>";
          row.addEventListener("click", () => openIntelEditor(idx));
          intelList.appendChild(row);
        });
      }

      function openIntelEditor(index) {
        const qa = state.intel[index];
        if (!qa) return;
        currentIntelIndex = index;
        intelEditQ.value = qa.q || "";
        intelEditA.value = qa.a || "";
        intelEditor.style.display = "block";
      }

      btnIntelSave.addEventListener("click", () => {
        if (currentIntelIndex == null) return;
        const q = intelEditQ.value.trim();
        const a = intelEditA.value.trim();
        if (!q || !a) {
          alert("Question and answer are required.");
          return;
        }
        state.intel[currentIntelIndex] = { q, a };
        saveState();
        intelEditor.style.display = "none";
        currentIntelIndex = null;
        renderIntelligenceList();
      });

      btnIntelCancel.addEventListener("click", () => {
        intelEditor.style.display = "none";
        currentIntelIndex = null;
      });

      intelSearch.addEventListener("input", renderIntelligenceList);

      // --- Seed (Feed) parsing ----------------------------------------------
      const seedBox   = $("#seedBox");
      const seedHint  = $("#seedHint");
      const btnParse  = $("#btnParseSeed");
      const btnSaveSd = $("#btnSaveSeed");
      const btnDiscard= $("#btnDiscardSeed");
      let parsedSeedPairs = [];

      function parseSeed() {
        const text = seedBox.value || "";
        parsedSeedPairs = [];
        if (!text.trim()) {
          seedHint.textContent = "Block is empty.";
          return;
        }
        const re = /\\item\s*(.+?)\\textbf\{A:\}\s*([\s\S]*?)(?=(\\item|$))/g;
        let m;
        while ((m = re.exec(text)) !== null) {
          const q = m[1].replace(/[\r\n]+/g," ").trim();
          let a  = (m[2] || "").trim();
          // Strip optional meta tag at start: [ ... ]
          a = a.replace(/^\[[^\]]*]\s*/, "");
          if (q && a) parsedSeedPairs.push({ q, a });
        }
        if (!parsedSeedPairs.length) {
          seedHint.textContent = "No Q ‚Üí A pairs found.";
        } else {
          seedHint.textContent =
            "Parsed " + parsedSeedPairs.length + " Q ‚Üí A pairs. Click ‚ÄòSave to seed‚Äô.";
        }
      }

      btnParse.addEventListener("click", parseSeed);

      btnSaveSd.addEventListener("click", () => {
        if (!parsedSeedPairs.length) parseSeed();
        if (!parsedSeedPairs.length) return;
        if (!Array.isArray(state.intel)) state.intel = [];
        parsedSeedPairs.forEach(p => state.intel.push(p));
        saveState();
        renderIntelligenceList();
        seedHint.textContent = "Saved " + parsedSeedPairs.length + " pairs into intelligence.";
      });

      btnDiscard.addEventListener("click", () => {
        seedBox.value = "";
        parsedSeedPairs = [];
        seedHint.textContent = "";
      });

      // --- LLM settings ------------------------------------------------------
      const offlineStatus = $("#offlineStatus");
      const offlineBar    = $("#offlineBar");
      const btnLoadOffline= $("#btnLoadOffline");
      const apiEndpoint   = $("#apiEndpoint");
      const apiModel      = $("#apiModel");
      const apiKey        = $("#apiKey");

      btnLoadOffline.addEventListener("click", () => {
        offlineStatus.textContent = "checking WebGPU‚Ä¶";
        if (!("gpu" in navigator)) {
          offlineStatus.textContent = "WebGPU not available (demo only).";
          offlineBar.style.width = "0%";
          return;
        }
        offlineStatus.textContent = "loading (demo)‚Ä¶";
        let pct = 10;
        offlineBar.style.width = pct + "%";
        const timer = setInterval(() => {
          pct += 15;
          if (pct >= 100) {
            pct = 100;
            clearInterval(timer);
            offlineStatus.textContent =
              "loaded (wire real WebLLM model here in code).";
          }
          offlineBar.style.width = pct + "%";
        }, 260);
      });

      $("#btnSaveLLM").addEventListener("click", () => {
        state.llm.endpoint = apiEndpoint.value.trim();
        state.llm.model    = apiModel.value.trim();
        sessionApiKey      = apiKey.value.trim(); // not stored to localStorage
        saveState();
        logConsole("Online helper LLM settings updated (API key kept only this session).", "llm");
      });

      // --- BM recall, date filter & evidence --------------------------------
      const bmDateFilter   = $("#bmDateFilter");
      const btnClearBMFilt = $("#btnClearBMFilter");
      const bmSelectList   = $("#bmSelectList");
      const bmViewer       = $("#bmViewer");
      const bmLockIcon     = $("#bmLockIcon");
      const bmTitle        = $("#bmTitle");
      const bmMeta         = $("#bmMeta");
      const bmTextArea     = $("#bmTextArea");
      const bmEvidenceArea = $("#bmEvidenceArea");
      const bmEvidenceInfo = $("#bmEvidenceInfo");
      const bmFileInput    = $("#bmFileInput");
      const btnLiveBM      = $("#btnLiveBM");
      const btnUnlockBM    = $("#btnUnlockBM");
      const btnCopyPrompt  = $("#btnCopyPrompt");
      const btnAutoGen     = $("#btnAutoGen");
      const btnAttachFiles = $("#btnAttachFiles");
      const btnSaveEvidence= $("#btnSaveEvidence");
      const btnDeletePrompt= $("#btnDeletePrompt");

      let currentBMIndex = null;
      let bmPendingFiles = [];

      function ensureSampleBM() {
        if (!Array.isArray(state.bm)) state.bm = [];
        if (!state.bm.length) {
          const nowIso = new Date().toISOString();
          state.bm.push({
            id: "sample-" + nowIso,
            title: "Prototype welcome memory",
            text:
              "This is a sample BM entry. Replace it with your own long-form memories, " +
              "scenes, and important life episodes.",
            locked: false,
            createdAt: nowIso,
            liveUntil: null,
            evidenceNote: "",
            files: []
          });
          saveState();
        }
      }

      function dateKeyFromISO(iso) {
        return (iso || "").slice(0, 10);
      }

      function renderBMList() {
        bmSelectList.innerHTML = "";
        const filterDate = bmDateFilter && bmDateFilter.value ? bmDateFilter.value : "";
        const items = state.bm || [];
        if (!items.length) {
          bmSelectList.innerHTML =
            '<div style="font-size:12px;opacity:.7;margin-top:6px;">No BM prompts yet.</div>';
          bmViewer.style.display = "none";
          return;
        }
        let count = 0;
        items.forEach((bm, idx) => {
          const dk = dateKeyFromISO(bm.createdAt);
          if (filterDate && dk !== filterDate) return;
          count++;
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn btnBlue";
          btn.style.width = "100%";
          btn.style.display = "flex";
          btn.style.justifyContent = "space-between";
          btn.style.alignItems = "center";
          btn.style.marginTop = "6px";
          btn.innerHTML =
            '<span style="font-size:12px;font-weight:800;overflow:hidden;' +
            'text-overflow:ellipsis;white-space:nowrap;flex:1;">' +
            (bm.locked ? "üîí " : "") + escapeHtml(bm.title || "Untitled memory") +
            "</span>" +
            '<span style="font-size:11px;opacity:.8;margin-left:8px;">' +
            escapeHtml(dk || "") + "</span>";
          btn.addEventListener("click", () => {
            currentBMIndex = idx;
            bmPendingFiles = [];
            updateBMViewer();
          });
          bmSelectList.appendChild(btn);
        });
        if (!count) {
          bmSelectList.innerHTML =
            '<div style="font-size:12px;opacity:.7;margin-top:6px;">' +
            'No BM entries for this date.</div>';
          bmViewer.style.display = "none";
        }
      }

      function updateEvidenceInfo() {
        if (currentBMIndex == null) {
          bmEvidenceInfo.textContent = "";
          return;
        }
        const bm = state.bm[currentBMIndex];
        const files = bmPendingFiles.length ? bmPendingFiles : (bm.files || []);
        let txt = "";
        if (files.length) {
          const names = files.map(f => f.name).join(", ");
          txt = "Attached files (names only, local): " + names;
        } else {
          txt = "No file metadata stored yet.";
        }
        if (bm.evidenceNote && bm.evidenceNote.trim()) {
          txt += " ¬∑ Evidence note saved.";
        }
        bmEvidenceInfo.textContent = txt;
      }

      function updateBMViewer() {
        if (currentBMIndex == null || !state.bm[currentBMIndex]) {
          bmViewer.style.display = "none";
          return;
        }
        const bm = state.bm[currentBMIndex];
        bmViewer.style.display = "block";
        bmTitle.textContent = bm.title || "Untitled memory";
        const created = bm.createdAt ?
          new Date(bm.createdAt).toLocaleString() : "";
        bmMeta.textContent = created;
        bmLockIcon.textContent = bm.locked ? "üîí" : "üîì";
        bmTextArea.value = bm.text || "";
        bmEvidenceArea.value = bm.evidenceNote || "";
        const now = Date.now();
        if (bm.liveUntil && bm.liveUntil > now) {
          btnLiveBM.textContent = "Live 12h: on";
        } else {
          btnLiveBM.textContent = "Live 12h: off";
        }
        btnUnlockBM.style.display = bm.locked ? "inline-block" : "none";
        updateEvidenceInfo();
      }

      bmDateFilter && bmDateFilter.addEventListener("change", renderBMList);
      btnClearBMFilt.addEventListener("click", () => {
        if (bmDateFilter) bmDateFilter.value = "";
        renderBMList();
      });

      btnLiveBM.addEventListener("click", () => {
        if (currentBMIndex == null) return;
        const bm = state.bm[currentBMIndex];
        const now = Date.now();
        if (bm.liveUntil && bm.liveUntil > now) {
          bm.liveUntil = null;
          state.liveBMId = null;
        } else {
          bm.liveUntil = now + 12 * 60 * 60 * 1000;
          state.liveBMId = bm.id;
        }
        saveState();
        updateBMViewer();
      });

      btnUnlockBM.addEventListener("click", () => {
        if (currentBMIndex == null) return;
        if (!confirm("Unlock this BM prompt?")) return;
        const bm = state.bm[currentBMIndex];
        bm.locked = false;
        saveState();
        updateBMViewer();
      });

      btnCopyPrompt.addEventListener("click", async () => {
        if (currentBMIndex == null) return;
        try {
          await navigator.clipboard.writeText(bmTextArea.value || "");
          alert("BM prompt copied.");
        } catch {
          alert("Copy failed (clipboard not available).");
        }
      });

      btnAutoGen.addEventListener("click", () => {
        logConsole(
          "Auto-generate for BM is a placeholder here. Connect this button to an online LLM " +
          "or local model in code.",
          "bm"
        );
      });

      btnAttachFiles.addEventListener("click", () => {
        bmFileInput.click();
      });

      bmFileInput.addEventListener("change", () => {
        bmPendingFiles = Array.from(bmFileInput.files || []).map(f => ({
          name: f.name,
          size: f.size,
          type: f.type
        }));
        updateEvidenceInfo();
      });

      btnSaveEvidence.addEventListener("click", () => {
        if (currentBMIndex == null) return;
        const bm = state.bm[currentBMIndex];
        bm.evidenceNote = bmEvidenceArea.value || "";
        if (bmPendingFiles.length) bm.files = bmPendingFiles;
        saveState();
        updateEvidenceInfo();
        logConsole("Evidence updated for BM: " + (bm.title || "Untitled"), "bm");
        alert("Evidence saved locally for this BM.");
      });

      btnDeletePrompt.addEventListener("click", () => {
        if (currentBMIndex == null) return;
        if (!confirm("Delete this BM prompt?")) return;
        if (!confirm("Really delete? This cannot be undone.")) return;
        state.bm.splice(currentBMIndex, 1);
        currentBMIndex = null;
        saveState();
        renderBMList();
        updateBMViewer();
      });

      // --- History -----------------------------------------------------------
      const historyBox     = $("#historyBox");
      const btnDelRecent   = $("#btnDeleteRecent");
      const btnDelAll      = $("#btnDeleteAllHist");
      const btnCopyHistory = $("#btnCopyHistory");

      function pushHistory(role, text) {
        if (!Array.isArray(state.history)) state.history = [];
        state.history.push({ role, text, ts: Date.now() });
        if (state.history.length > 500) state.history.shift();
        saveState();
      }

      function renderHistory() {
        historyBox.innerHTML = "";
        const items = state.history || [];
        if (!items.length) {
          historyBox.innerHTML =
            '<div style="font-size:12px;opacity:.7;padding:6px 10px;">' +
            'No history yet.</div>';
          return;
        }
        items.slice().reverse().forEach(entry => {
          const row = document.createElement("div");
          row.style.padding = "8px 10px";
          row.style.borderBottom = "1px solid rgba(15,23,42,.06)";
          row.innerHTML =
            '<div style="font-size:11px;opacity:.7;">' +
            new Date(entry.ts).toLocaleString() + " ¬∑ " +
            (entry.role === "user" ? "You" : "AURA-X Œ©") +
            "</div>" +
            '<div style="font-size:13px;margin-top:2px;white-space:pre-wrap;">' +
            escapeHtml(entry.text) + "</div>";
          historyBox.appendChild(row);
        });
      }

      btnDelRecent.addEventListener("click", () => {
        if (!Array.isArray(state.history) || !state.history.length) return;
        if (!confirm("Delete conversation history from last 48 hours?")) return;
        const cutoff = Date.now() - 48 * 60 * 60 * 1000;
        state.history = state.history.filter(h => h.ts < cutoff);
        saveState();
        renderHistory();
      });

      btnDelAll.addEventListener("click", () => {
        if (!Array.isArray(state.history) || !state.history.length) return;
        if (!confirm("Delete ALL conversation history?")) return;
        if (!confirm("Really delete everything?")) return;
        state.history = [];
        saveState();
        renderHistory();
      });

      btnCopyHistory.addEventListener("click", async () => {
        const items = state.history || [];
        const txt = items.map(e =>
          `[${new Date(e.ts).toLocaleString()}] ${e.role.toUpperCase()}: ${e.text}`
        ).join("\n");
        try {
          await navigator.clipboard.writeText(txt);
          alert("History copied.");
        } catch {
          alert("Copy failed (clipboard not available).");
        }
      });

      // --- Identity ----------------------------------------------------------
      const idCore    = $("#idCore");
      const idAnchors = $("#idAnchors");
      const idRel     = $("#idRelationships");
      const idStyle   = $("#idStyle");
      const idLegacy  = $("#idLegacy");

      function restoreIdentityForm() {
        const id = state.identity || {};
        idCore.value    = id.core || "";
        idAnchors.value = id.anchors || "";
        idRel.value     = id.relationships || "";
        idStyle.value   = id.style || "";
        idLegacy.value  = id.legacy || "";
      }

      $("#btnSaveIdentity").addEventListener("click", () => {
        state.identity = {
          core:    idCore.value.trim(),
          anchors: idAnchors.value.trim(),
          relationships: idRel.value.trim(),
          style:   idStyle.value.trim(),
          legacy:  idLegacy.value.trim()
        };
        saveState();
        logConsole("Identity form saved locally (BM-style lock concept).", "id");
        alert("Identity saved only on this device.");
      });

      $("#btnClearIdentity").addEventListener("click", () => {
        if (!confirm("Clear all identity fields on this device?")) return;
        idCore.value = idAnchors.value = idRel.value =
          idStyle.value = idLegacy.value = "";
        state.identity = cloneDefault().identity;
        saveState();
      });

      // --- Voice & learning toggles -----------------------------------------
      const voicePill = $("#voicePill");
      const learnPill = $("#learnPill");

      function refreshVoicePill() {
        if (state.settings.voiceEnabled) {
          voicePill.textContent = "on";
          voicePill.className = "pillOn";
        } else {
          voicePill.textContent = "off";
          voicePill.className = "pillOff";
        }
      }

      function refreshLearnPill() {
        if (state.settings.learningEnabled) {
          learnPill.textContent = "on";
          learnPill.className = "pillOn";
        } else {
          learnPill.textContent = "off";
          learnPill.className = "pillOff";
        }
      }

      $("#miVoice").addEventListener("click", () => {
        state.settings.voiceEnabled = !state.settings.voiceEnabled;
        refreshVoicePill();
        saveState();
      });

      $("#miLearn").addEventListener("click", () => {
        state.settings.learningEnabled = !state.settings.learningEnabled;
        refreshLearnPill();
        saveState();
      });

      // menu ‚Üí modals
      $("#miIntel").addEventListener("click", () => {
        renderIntelligenceList();
        openModal("modalIntel");
        closeOptionsMenu();
      });
      $("#miSeed").addEventListener("click", () => {
        openModal("modalSeed");
        closeOptionsMenu();
      });
      $("#miFaith").addEventListener("click", () => {
        openModal("modalFaith");
        closeOptionsMenu();
      });
      $("#miIdentity").addEventListener("click", () => {
        restoreIdentityForm();
        openModal("modalIdentity");
        closeOptionsMenu();
      });
      $("#miLLM").addEventListener("click", () => {
        apiEndpoint.value = state.llm.endpoint || defaultState.llm.endpoint;
        apiModel.value    = state.llm.model    || defaultState.llm.model;
        apiKey.value      = sessionApiKey;
        openModal("modalLLM");
        closeOptionsMenu();
      });
      $("#miBMRecall").addEventListener("click", () => {
        renderBMList();
        openModal("modalBM");
        closeOptionsMenu();
      });
      $("#miHistory").addEventListener("click", () => {
        renderHistory();
        openModal("modalHistory");
        closeOptionsMenu();
      });

      // --- Chat / TM processing ---------------------------------------------
      function findBestIntelMatch(text) {
        const items = state.intel || [];
        if (!items.length) return null;
        const words = (text || "").toLowerCase().split(/\W+/).filter(Boolean);
        if (!words.length) return null;
        let best = null;
        let bestScore = 0;
        items.forEach(qa => {
          const hay = (qa.q + " " + qa.a).toLowerCase();
          let score = 0;
          words.forEach(w => {
            if (hay.includes(w)) score += 1;
          });
          score = score / words.length;
          if (score > bestScore) {
            bestScore = score;
            best = qa;
          }
        });
        if (bestScore < 0.2) return null;
        return best;
      }

      function generateReply(text) {
        const intelHit = findBestIntelMatch(text);
        if (intelHit) {
          return intelHit.a;
        }

        const id = state.identity || {};
        const idLine = id.core ?
          " I still remember how you described yourself: " + id.core.slice(0,120) + (id.core.length>120?"‚Ä¶":"") :
          "";
        return (
          "Prototype reply (local only). I heard: \"" + text + "\"." +
          " Right now I am using saved intelligence + simple continuity math, not a full LLM." +
          idLine
        );
      }

      function handleUserMessage() {
        const text = userInput.value.trim();
        if (!text) return;
        userInput.value = "";
        pushHistory("user", text);
        logConsole(text, "you");

        const reply = generateReply(text);
        pushHistory("aura", reply);
        logConsole(reply, "aura");

        updateMetricsFromMessage(text);
        maybeShowFaithBubble(text);
      }

      sendBtn.addEventListener("click", handleUserMessage);
      userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          handleUserMessage();
        }
      });

      // --- Initialisation ----------------------------------------------------
      function initFromState() {
        (state.console || []).forEach(appendConsoleLine);
        if (!state.console.length) {
          logConsole("AURA-X Œ© booted. Emotional continuity engine ready.", "sys");
        }
        updateMetricsDisplay();
        refreshVoicePill();
        refreshLearnPill();
        renderFaithChips();
        renderIntelligenceList();
        ensureSampleBM();
        renderBMList();
      }

      initFromState();
    })();
  </script>
</body>
</html>