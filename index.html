<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype (MLC Thinking Bridge)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* RESET & BASICS */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:20px;
    }
    .app{
      width:100%;
      max-width:1100px;
      background:radial-gradient(circle at top,#020617 0,#020617 35%,#020617 100%);
      border-radius:26px;
      box-shadow:
        0 26px 80px rgba(15,23,42,.85),
        0 0 0 1px rgba(148,163,184,.45);
      padding:18px 20px 12px;
      display:flex;
      flex-direction:column;
      gap:14px;
      position: relative;
      overflow:hidden;
    }
    .app::before{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(circle at 15% -10%,rgba(56,189,248,.28),transparent 60%),
        radial-gradient(circle at 85% -20%,rgba(59,130,246,.26),transparent 55%);
      opacity:.7;
      pointer-events:none;
      z-index:0;
    }
    .app > *{position:relative; z-index:1;}

    /* ===================== HERO HEADER ===================== */
    .header{
      position: sticky;          /* ‚úÖ makes dropdown reliably overlay below content */
      top: 10px;
      z-index: 1000;             /* ‚úÖ above metrics cards */
      border-radius: 24px;
      padding: 16px 18px 14px;
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items: center;
      background:
        radial-gradient(900px 320px at 20% 0%, rgba(56,189,248,.32), rgba(15,23,42,.98) 55%, #020617 100%);
      border: 1.5px solid rgba(148,163,184,.55);
      box-shadow:
        0 26px 70px rgba(15,23,42,.9),
        inset 0 1px 0 rgba(255,255,255,.08);
      backdrop-filter: blur(8px);
    }
    .header::before{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(circle at 20% 30%, rgba(56,189,248,.22), transparent 45%),
        radial-gradient(circle at 80% 25%, rgba(34,211,238,.18), transparent 40%),
        linear-gradient(90deg, rgba(56,189,248,.20), transparent 35%, rgba(34,211,238,.18));
      opacity:.9;
      pointer-events:none;
      z-index:0;
    }
    .header::after{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(90deg,rgba(56,189,248,.18)0 2px,transparent 2px 26px);
      opacity:.06;
      pointer-events:none;
      z-index:0;
    }

    .title-block{position:relative; z-index:1;}
    .title-block h1{
      font-size: 1.7rem;
      letter-spacing: .10em;
      text-transform: uppercase;
      font-weight: 800;
      line-height: 1.05;
    }
    .title-block h1 span{
      background: linear-gradient(120deg,#38bdf8,#22d3ee,#a5b4fc);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .hero-line{
      margin-top: 6px;
      font-size: .9rem;
      color: rgba(226,232,240,.96);
      font-weight: 600;
    }
    .title-sub{
      margin-top: 4px;
      font-size: .8rem;
      color: rgba(148,163,184,.98);
      line-height: 1.35;
    }

    .badge-row{margin-top: 12px; display:flex; flex-wrap:wrap;}
    .ethics-pill{
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(2,6,23,.70);
      border: 1.5px solid rgba(250,204,21,.8);
      box-shadow: 0 18px 40px rgba(15,23,42,.85), 0 0 0 1px rgba(251,191,36,.35);
      max-width: 440px;
    }
    .ethics-pill-text{
      color: rgba(250,250,210,.98);
      font-weight: 600;
      font-size: .8rem;
      line-height: 1.5;
    }

    .header-right{
      position:relative;
      z-index:1;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:10px;
    }
    .mode-pill{
      width: min(320px, 100%);
      padding: 14px 16px;
      border-radius: 999px;
      border: 1px solid rgba(34,211,238,.6);
      background:
        radial-gradient(700px 210px at 20% 20%, rgba(34,211,238,.45), rgba(34,211,238,.18) 45%, rgba(2,6,23,.10) 100%),
        linear-gradient(135deg, rgba(34,211,238,.45), rgba(6,182,212,.24));
      color: rgba(240,253,250,.98);
      font-size: .88rem;
      font-weight: 800;
      letter-spacing: .11em;
      text-transform: uppercase;
      text-align: center;
      box-shadow: 0 18px 50px rgba(34,211,238,.35);
      position: relative;
      overflow:hidden;
    }
    .mode-pill::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 35% 65%, rgba(255,255,255,.22), transparent 55%),
        radial-gradient(circle at 70% 35%, rgba(255,255,255,.16), transparent 60%);
      opacity:.9;
    }
    .mode-pill::after{
      content:"";
      position:absolute; left:-10%; right:-10%; bottom:-30%;
      height:70%;
      background: rgba(255,255,255,.18);
      border-radius: 999px;
      transform: rotate(-6deg);
      filter: blur(1px);
      opacity:.40;
    }

    .header-controls{
      display:flex;
      flex-wrap:wrap;
      justify-content:flex-end;
      position:relative;
      margin-top:4px;
      z-index: 2000; /* ‚úÖ */
    }
    .voice-toggle{
      border:none;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: .85rem;
      background: rgba(248,250,252,.96);
      color: #0f172a;
      border: 1px solid rgba(226,232,240,.9);
      cursor: pointer;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 10px 26px rgba(2,6,23,.6);
      position: relative;
      z-index: 2001;
    }
    .voice-toggle:hover{filter: brightness(1.03);}

    .option-panel{
      position:absolute;
      top:115%;
      right:0;
      display:none;
      flex-direction:column;
      gap:6px;
      padding:8px;
      border-radius:16px;
      background:rgba(15,23,42,.98);
      border:1px solid rgba(148,163,184,.8);
      box-shadow:0 20px 46px rgba(15,23,42,.9);
      z-index:99999; /* ‚úÖ above all */
      min-width:210px;
    }
    .header-controls.open .option-panel{display:flex;}
    .small-toggle{
      border:none;
      padding:7px 10px;
      border-radius:999px;
      font-size:.78rem;
      background:#020617;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.9);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .small-toggle:hover{background:#020617dd;}

    @media(max-width:900px){
      .header{grid-template-columns:1fr; padding:12px 12px 14px;}
      .header-right{align-items:stretch}
      .mode-pill{width:100%}
      .header-controls{justify-content:flex-start;}
    }

    /* LAYOUT */
    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
      gap:18px;
      margin-top:4px;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
    }
    .left-col,.right-col{display:flex; flex-direction:column; gap:12px;}

    .card{
      background:#f9fafb;
      border-radius:18px;
      padding:16px 16px 14px;
      border:1px solid #e5e7eb;
      box-shadow:0 10px 25px rgba(15,23,42,.45);
    }
    .card-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;}
    .card-title{font-size:.95rem; font-weight:600; color:#0f172a; display:flex; align-items:center; gap:6px;}
    .card-title span.emoji{font-size:1.1rem;}
    .card-sub{font-size:.75rem;color:#94a3b8;}

    .metrics-grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; margin-top:4px;}
    .metric{background:#ffffff; border-radius:12px; padding:10px 10px 9px; border:1px solid #e5e7eb;}
    .metric-label{font-size:.7rem;color:#64748b;margin-bottom:4px;}
    .metric-value{font-size:1.1rem;font-weight:700;color:#1d4ed8;}
    .metric-note{font-size:.7rem;color:#9ca3af;margin-top:2px;}

    .status-row{display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; font-size:.72rem; color:#6b7280;}
    .tag{padding:4px 8px; border-radius:999px; background:#e5f4ff; color:#1e3a8a; border:1px solid #bfdbfe; font-size:.68rem;}

    .bm-wrapper{margin-top:8px;}
    .bm-canvas-shell{
      background:radial-gradient(circle at top,#e0f2fe 0,#eff6ff 60%,#e2e8f0 100%);
      border-radius:12px;
      border:1px solid #dbeafe;
      height:150px;
      overflow:hidden;
      position:relative;
      cursor:default;
    }
    #bmCanvas{width:100%;height:100%;display:block;}
    .bm-footer{font-size:.72rem; color:#6b7280; margin-top:6px; text-align:center;}
    .bm-overlay-btn{
      position:absolute;
      top:6px;
      width:26px;height:26px;
      border-radius:999px;
      border:none;
      font-size:.9rem;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      background:#f9fafbcc;
      box-shadow:0 6px 14px rgba(15,23,42,.25);
      z-index: 5;
    }
    .bm-overlay-btn.left{left:8px;}
    .bm-overlay-btn.right{right:8px;}
    .bm-overlay-btn:hover{background:#e5f0ff;}

    .answer-box{
      background:#020617;
      border-radius:12px;
      padding:10px 10px 12px;
      border:1px solid #020617;
      font-family:"Courier New",monospace;
      color:#e5e7eb;
      box-shadow:0 16px 40px rgba(15,23,42,.65);
      max-height:110px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .equation-header{font-size:.75rem; color:#60a5fa; font-weight:600; letter-spacing:.05em; text-transform:uppercase;}
    .equation-divider{height:1px; background:linear-gradient(90deg,rgba(148,163,184,.2),rgba(15,23,42,0),rgba(148,163,184,.2)); margin:2px 0 4px;}
    .chat-container{background:transparent; border:none; padding:0; height:auto; max-height:90px; overflow-y:auto;}
    .message{
      max-width:100%;
      padding:6px 7px;
      margin-bottom:6px;
      border-radius:8px;
      font-size:.8rem;
      line-height:1.5;
      position:relative;
      animation:fadeIn .2s ease-out;
      white-space:pre-wrap;
    }
    .message-header{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:3px; font-size:.7rem; color:#9ca3af; gap:6px;
    }
    .msg-right{display:flex; align-items:center; gap:4px;}
    .voice-btn{
      border:none; border-radius:999px; padding:1px 6px; font-size:.7rem;
      cursor:pointer; background:#1f2937; color:#e5e7eb;
    }
    .voice-btn:hover{background:#111827;}
    .ai-message{background:#020617; border-bottom-left-radius:3px; border:1px solid #111827;}
    .user-message{background:#020617; border-bottom-right-radius:3px; border:1px solid #1f2937;}
    .message-content{color:#e5e7eb;}

    .typing-indicator{
      display:flex; align-items:center; gap:4px;
      background:#020617; border-radius:999px; padding:4px 8px;
      width:fit-content; margin:6px 0 2px; border:1px solid #111827;
    }
    .typing-dot{width:5px;height:5px;border-radius:999px; background:#38bdf8; animation:typing 1.2s infinite;}
    .typing-dot:nth-child(2){animation-delay:.18s}
    .typing-dot:nth-child(3){animation-delay:.36s}
    .typing-text{font-size:.7rem;color:#38bdf8;font-weight:500;}

    /* ======= INPUT FOOTER (fixed usability) ======= */
    .input-footer{
      margin-top: 6px;
      padding-top: 10px;
      border-top: 1px solid #f1f5f9;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      position: sticky;
      bottom: 0;
      background: linear-gradient(to bottom, rgba(15,23,42,0), rgba(15,23,42,0.95) 15%);
      padding-bottom: 10px;
      z-index: 20;
    }
    .tm-formula-row{display:flex; justify-content:center; margin-bottom:2px;}
    .tm-formula-pill{
      font-size: .7rem;
      padding: 3px 10px;
      border-radius: 999px;
      background: #f1f5f9;
      color: #64748b;
      font-family: "Courier New", monospace;
      border: 1px solid #e2e8f0;
      user-select: none;
    }
    .input-row{width:100%; display:flex; justify-content:center; padding:0 10px;}
    .input-shell{
      display:flex;
      align-items:stretch;
      width:100%;
      max-width:700px;
      background:#fffbea;
      border:1px solid #cbd5e1;
      border-radius:26px;
      padding:6px;
      box-shadow:0 10px 30px -5px rgba(15,23,42,0.5);
      transition: all .2s ease;
    }
    .input-shell:focus-within{
      border-color:#3b82f6;
      box-shadow:0 12px 35px -5px rgba(59,130,246,0.35);
      transform: translateY(-2px);
    }
    .message-input{
      flex:1;
      resize:none;
      min-height:44px;          /* ‚úÖ easier tap + cursor */
      max-height:140px;
      padding:12px 14px;
      border:none;
      outline:none;
      font-size:.95rem;
      background:transparent;
      color:#0f172a;
      font-family: inherit;
      line-height:1.4;
      width:100%;
      pointer-events:auto;
    }
    .message-input::placeholder{color:#94a3b8;}
    .send-button{
      border:none;
      min-width:92px;
      padding:0 18px;
      background: linear-gradient(135deg, #2563eb, #06b6d4);
      color:#fff;
      font-weight:700;
      font-size:.85rem;
      cursor:pointer;
      border-radius:20px;
      flex-shrink:0;
      margin-left:6px;
      box-shadow:0 4px 12px rgba(37,99,235,0.4);
      transition: filter .2s, transform .1s;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .send-button:hover{filter:brightness(1.1);}
    .send-button:active{transform:scale(.96);}
    .flow-caption{margin-top:4px; text-align:center; font-size:.7rem; color:#9ca3af;}

    .reaction-bubble{
      position:fixed;
      right:22px;
      bottom:100px;
      max-width:260px;
      background:#0f172acc;
      color:#e5e7eb;
      padding:10px 12px;
      border-radius:16px 16px 2px 16px;
      font-size:.78rem;
      box-shadow:0 18px 45px rgba(15,23,42,.6);
      display:flex;
      gap:8px;
      align-items:flex-start;
      opacity:0;
      transform:translateY(8px);
      pointer-events:none;
      transition:opacity .25s ease-out,transform .25s ease-out;
      z-index:9999;
    }
    .reaction-bubble.visible{opacity:1; transform:translateY(0); pointer-events:auto;}
    .reaction-icon{font-size:1.1rem;margin-top:2px;}
    .reaction-label{font-weight:600;margin-bottom:2px;}
    .reaction-body{font-size:.76rem;color:#cbd5f5;}

    /* MODALS */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 999999;
      backdrop-filter:blur(6px);
    }
    .modal-overlay.visible{display:flex;}
    .modal-card{
      background:#f9fafb;
      border-radius:18px;
      width:min(680px,96vw);
      max-height:82vh;
      box-shadow:0 24px 60px rgba(15,23,42,.6);
      border:1px solid #e5e7eb;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .modal-header{
      padding:10px 14px 8px;
      border-bottom:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .modal-title{
      font-size:.9rem;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:6px;
      color:#0f172a;
    }
    .modal-sub{font-size:.72rem;color:#64748b;margin-top:2px;}
    .modal-close{
      border:none; background:transparent; font-size:1rem;
      cursor:pointer; color:#6b7280; padding:4px 8px;
    }
    .modal-body{
      padding:12px 14px 14px;
      overflow-y:auto;
      font-size:.85rem;
      color:#0f172a;
    }
    .modal-search{
      width:100%;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid #cbd5f5;
      font-size:.85rem;
      outline:none;
      background:#ffffff;
    }
    .modal-search:focus{border-color:#2563eb; box-shadow:0 0 0 2px rgba(37,99,235,.18);}
    .btn-row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .btn-mini{
      font-size:.82rem;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #dbeafe;
      background:#eff6ff;
      cursor:pointer;
      color:#1d4ed8;
      font-weight:700;
    }
    .btn-mini:hover{background:#e0edff;}
    .btn-danger{
      border-color:#fecaca!important;
      background:#fee2e2!important;
      color:#b91c1c!important;
    }

    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)}}
    @keyframes typing{0%,60%,100%{transform:translateY(0);opacity:.4} 30%{transform:translateY(-4px);opacity:1}}
    @media(max-width:900px){
      .layout{grid-template-columns:1fr}
      .card{padding:14px 12px 14px}
      .answer-box{max-height:110px;}
      .input-shell{max-width:100%;}
    }
  </style>
</head>
<body>

<div class="app">
  <header class="header">
    <div class="title-block">
      <h1><span>AURA-X Œ©</span></h1>
      <div class="hero-line">World‚Äôs first synthetic emotions engine (prototype)</div>
      <div class="title-sub">Emotional continuity ¬∑ dual memory ¬∑ synthetic reactions ¬∑ fully offline</div>
      <div class="badge-row">
        <div class="ethics-pill">
          <span class="ethics-pill-text">
            Universal ethic: Avoid actions that grow negative emotions in you or others. Choose paths that gently increase shared positive emotion for everyone.
          </span>
        </div>
      </div>
    </div>

    <div class="header-right">
      <div class="mode-pill">EMOTIONAL CONTINUITY ENGINE ACTIVE</div>
      <div class="header-controls" id="headerControls">
        <button id="optionsToggle" class="voice-toggle">üîò Options</button>
        <div class="option-panel" id="optionPanel">
          <button id="voiceToggle" class="small-toggle">üîà Voice: OFF</button>
          <button id="intelButton" class="small-toggle">üß† Intelligence</button>
          <button id="feedSeedButton" class="small-toggle">üå± Feed the seed</button>
          <button id="learningToggle" class="small-toggle">üìö Learning: ON</button>
          <button id="faithButton" class="small-toggle">üîò Faith: None</button>

          <!-- ‚úÖ NEW: MLC Thinking Bridge -->
          <button id="mlcThinkingBtn" class="small-toggle">üß† Offline LLM (MLC) ‚Äì Thinking</button>
        </div>
      </div>
    </div>
  </header>

  <main class="layout">
    <div class="left-col">
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß™</span><span>Emotional Metrics</span></div>
            <div class="card-sub">Synthetic state computed from TM ‚Üî BM resonance.</div>
          </div>
        </div>
        <div class="metrics-grid">
          <div class="metric">
            <div class="metric-label">Emotional state E‚ÇÄ</div>
            <div id="metricE0" class="metric-value">0.00</div>
            <div class="metric-note">tanh-based, range [-1, +1]</div>
          </div>
          <div class="metric">
            <div class="metric-label">TM activation</div>
            <div id="metricTM" class="metric-value">0.00</div>
            <div class="metric-note">Recent temporary memories</div>
          </div>
          <div class="metric">
            <div class="metric-label">BM resonance</div>
            <div id="metricBM" class="metric-value">0.00</div>
            <div class="metric-note">Stored emotional events</div>
          </div>
          <div class="metric">
            <div class="metric-label">Continuity index</div>
            <div id="metricCI" class="metric-value">0.80</div>
            <div class="metric-note">Stability of emotional trajectory</div>
          </div>
        </div>
        <div class="status-row">
          <span id="tagValence" class="tag">VALENCE: neutral</span>
          <span id="tagArousal" class="tag">AROUSAL: medium</span>
          <span id="tagReaction" class="tag">REACTION: balanced</span>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß†</span><span>Bold Memory Layers (240)</span></div>
            <div class="card-sub">Only story-level memories for photo/video generation.</div>
          </div>
        </div>
        <div class="bm-wrapper">
          <div class="bm-canvas-shell" id="bmShell">
            <button class="bm-overlay-btn left" id="bmOpenModal" title="Recall from BM">üìÅ</button>
            <button class="bm-overlay-btn right" id="convOpenModal" title="View conversations">‚óé</button>
            <canvas id="bmCanvas"></canvas>
          </div>
          <div id="bmStats" class="bm-footer">Active layers: 0/240 ¬∑ System Online</div>
        </div>
      </section>
    </div>

    <div class="right-col">
      <section class="card answer-card">
        <div class="card-header">
          <div class="card-title"><span class="emoji">üí¨</span><span>Emotional Continuity Console</span></div>
          <div class="card-sub">Offline ¬∑ Seed + BM + optional MLC thinking.</div>
        </div>
        <div class="answer-shell">
          <div class="answer-box">
            <div class="equation-header">AURA-X Œ© SYNTHETIC EMOTION CONSOLE</div>
            <div class="equation-divider"></div>
            <div id="chatContainer" class="chat-container"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="input-footer">
    <div class="tm-formula-row">
      <div class="tm-formula-pill">E‚ÇÄ = tanh((TM √ó BM) ‚àí D + Œª_faith + Œª_sys + Œª_trc)</div>
    </div>
    <div class="input-row">
      <div class="input-shell">
        <textarea id="messageInput" class="message-input" rows="1" placeholder="Write to AURA-X Œ©..."></textarea>
        <button id="sendButton" class="send-button">Send</button>
      </div>
    </div>
    <div class="flow-caption">Flow: TM ‚Üí (Seed/BM/MLC) ‚Üí equation scan ‚Üí emotion ‚Üí reply.</div>
  </footer>
</div>

<div id="reactionBubble" class="reaction-bubble">
  <div class="reaction-icon">üí≠</div>
  <div>
    <div id="reactionLabel" class="reaction-label">Reaction</div>
    <div id="reactionText" class="reaction-body">‚Ä¶</div>
  </div>
</div>

<!-- ‚úÖ MLC THINKING MODAL (Password + Copy + Paste Back) -->
<div id="mlcModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üß† Offline Thinking via MLC Chat</div>
        <div class="modal-sub">TM stays user-only. Paste back MLC answer as LLM_ANSWER for formula scan.</div>
      </div>
      <button class="modal-close" data-close="mlcModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="mlcPasswordStage">
        <div style="font-size:.85rem;color:#334155;line-height:1.5;">
          This area is protected.<br>
          Enter password to use MLC thinking. (Default: <b>6789</b>)
        </div>
        <input id="mlcPasswordInput" type="password" class="modal-search" placeholder="Password (default: 6789)">
        <div id="mlcPasswordError" style="display:none;color:#b91c1c;font-size:.8rem;margin-top:6px;">
          Incorrect password. Try again.
        </div>
        <div class="btn-row">
          <button id="mlcUnlockBtn" class="btn-mini">Unlock</button>
          <button class="btn-mini btn-danger" data-close="mlcModal">Close</button>
        </div>
      </div>

      <div id="mlcUseStage" style="display:none;">
        <div style="font-size:.85rem;color:#334155;line-height:1.55;">
          1) Tap <b>Copy TM Prompt</b> ‚Üí it will copy to clipboard.<br>
          2) Open <b>MLC Chat</b> app ‚Üí paste ‚Üí get answer.<br>
          3) Come back and paste answer below ‚Üí tap <b>Use as LLM Answer</b>.
        </div>

        <div class="btn-row">
          <button id="mlcCopyBtn" class="btn-mini">üìã Copy TM Prompt</button>
          <button id="mlcOpenBtn" class="btn-mini">üì≤ Try open MLC Chat</button>
        </div>

        <div style="margin-top:10px;font-size:.8rem;color:#64748b;">
          Paste MLC answer (this becomes <b>LLM_ANSWER</b>, not TM):
        </div>
        <textarea id="mlcAnswerInput" class="modal-search" style="min-height:120px;" placeholder="Paste MLC response here..."></textarea>

        <div class="btn-row">
          <button id="mlcUseBtn" class="btn-mini">‚úÖ Use as LLM Answer</button>
          <button id="mlcClearBtn" class="btn-mini btn-danger">Clear</button>
        </div>

        <div id="mlcStatus" style="margin-top:10px;font-size:.8rem;color:#0f172a;background:#eff6ff;border:1px solid #dbeafe;border-radius:12px;padding:10px;display:none;"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const BM_BANDS = ["Pain","Fear","Love","Identity","Belief","Hope","Wisdom"];
  const BAND_RGB = [
    [239,68,68],[249,115,22],[34,197,94],[14,165,233],[99,102,241],[234,179,8],[168,85,247]
  ];
  const STORAGE_KEY = "auraXOmegaState_v6_mlc";

  class AuraXOmegaEngine{
    constructor(){
      const saved = this.loadState();

      this.bmLayers = new Array(240).fill(0).map(()=>0.25+Math.random()*0.2);
      this.bmEntries = [];
      this.tmHistory = [];
      this.intelNodes = [];
      this.e0 = 0.2 + Math.random()*0.3;
      this.lastE0 = this.e0;
      this.continuityIndex = 0.8;
      this.lastResonance = 0.5;
      this.learningMode = true;
      this.lastAnsweredQuestion = null;
      this.voiceOn = false;
      this.faithsSelected = [];

      // ‚úÖ MLC bridge state
      this.lastTMForMLC = "";
      this.lastLLMAnswer = "";
      this.mlcUnlocked = false;

      if(saved){
        this.bmLayers = saved.bmLayers || this.bmLayers;
        this.bmEntries = (saved.bmEntries || []).map(e=>({
          ...e,
          id: e.id || this.makeId("bm"),
          timestampMs: e.timestampMs || (e.date ? new Date(e.date).getTime() : Date.now()),
          date: e.date ? new Date(e.date) : new Date(e.timestampMs || Date.now()),
          locked: !!e.locked
        }));
        this.tmHistory = (saved.tmHistory || []).map(e=>({
          id: e.id || this.makeId("tm"),
          role: e.role || "user",
          text: e.text || "",
          timestamp: e.timestamp ? new Date(e.timestamp) : new Date(),
          sentiment: e.sentiment || null,
          locked: !!e.locked
        }));
        this.intelNodes = (saved.intelNodes || []).map(n=>({
          ...n,
          id: n.id || this.makeId("intel"),
          createdAt: n.createdAt ? new Date(n.createdAt) : new Date()
        }));
        this.e0 = typeof saved.e0 === "number" ? saved.e0 : this.e0;
        this.lastE0 = typeof saved.lastE0 === "number" ? saved.lastE0 : this.e0;
        this.continuityIndex = typeof saved.continuityIndex === "number" ? saved.continuityIndex : this.continuityIndex;
        this.lastResonance = typeof saved.lastResonance === "number" ? saved.lastResonance : this.lastResonance;
        this.learningMode = typeof saved.learningMode === "boolean" ? saved.learningMode : this.learningMode;
        this.lastAnsweredQuestion = saved.lastAnsweredQuestion || null;
        this.voiceOn = (typeof saved.voiceOn === "boolean") ? saved.voiceOn : this.voiceOn;
        this.faithsSelected = Array.isArray(saved.faithsSelected) ? saved.faithsSelected : this.faithsSelected;

        // ‚úÖ restore MLC bridge data
        this.lastTMForMLC = saved.lastTMForMLC || "";
        this.lastLLMAnswer = saved.lastLLMAnswer || "";
      }

      this.smallTalkPatterns = [
        /\b(hi|hello|hey|salam|salaam)\b/i,
        /\bhow are you\b/i,
        /\bthanks\b/i,
        /\bthank you\b/i,
        /\bok(ay)?\b/i,
        /\bbye\b/i,
        /\bgood (night|morning|evening)\b/i
      ];

      this.cacheDom();
      this.updateVoiceToggleLabel();
      this.updateLearningUI();
      this.bindEvents();

      if(this.tmHistory.length){
        this.tmHistory.forEach(m=>{
          this.addMessage(m.role, m.text, m.role==="ai", m.sentiment || null);
        });
      }else{
        this.initChat();
      }

      this.updateMetrics();
      this.startBMAnimation();
      this.pruneOldBM();
      this.saveState();
    }

    makeId(prefix){ return prefix + "_" + Math.random().toString(36).slice(2); }

    loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){ return null; }
    }

    saveState(){
      try{
        const state = {
          bmLayers: this.bmLayers,
          bmEntries: this.bmEntries,
          tmHistory: this.tmHistory,
          intelNodes: this.intelNodes,
          e0: this.e0,
          lastE0: this.lastE0,
          continuityIndex: this.continuityIndex,
          lastResonance: this.lastResonance,
          voiceOn: this.voiceOn,
          faithsSelected: this.faithsSelected,
          learningMode: this.learningMode,
          lastAnsweredQuestion: this.lastAnsweredQuestion,
          lastTMForMLC: this.lastTMForMLC,
          lastLLMAnswer: this.lastLLMAnswer
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }catch(e){}
    }

    cacheDom(){
      this.metricE0 = document.getElementById("metricE0");
      this.metricTM = document.getElementById("metricTM");
      this.metricBM = document.getElementById("metricBM");
      this.metricCI = document.getElementById("metricCI");
      this.tagValence = document.getElementById("tagValence");
      this.tagArousal = document.getElementById("tagArousal");
      this.tagReaction = document.getElementById("tagReaction");
      this.bmCanvas = document.getElementById("bmCanvas");
      this.bmShell = document.getElementById("bmShell");
      this.bmStats = document.getElementById("bmStats");
      this.chatContainer = document.getElementById("chatContainer");
      this.messageInput = document.getElementById("messageInput");
      this.sendButton = document.getElementById("sendButton");

      this.voiceToggle = document.getElementById("voiceToggle");
      this.learningToggle = document.getElementById("learningToggle");
      this.optionsToggle = document.getElementById("optionsToggle");
      this.headerControls = document.getElementById("headerControls");

      // reaction
      this.reactionBubble = document.getElementById("reactionBubble");
      this.reactionLabel = document.getElementById("reactionLabel");
      this.reactionText = document.getElementById("reactionText");

      // ‚úÖ MLC modal
      this.mlcModal = document.getElementById("mlcModal");
      this.mlcPasswordStage = document.getElementById("mlcPasswordStage");
      this.mlcUseStage = document.getElementById("mlcUseStage");
      this.mlcPasswordInput = document.getElementById("mlcPasswordInput");
      this.mlcPasswordError = document.getElementById("mlcPasswordError");
      this.mlcUnlockBtn = document.getElementById("mlcUnlockBtn");
      this.mlcThinkingBtn = document.getElementById("mlcThinkingBtn");
      this.mlcCopyBtn = document.getElementById("mlcCopyBtn");
      this.mlcOpenBtn = document.getElementById("mlcOpenBtn");
      this.mlcAnswerInput = document.getElementById("mlcAnswerInput");
      this.mlcUseBtn = document.getElementById("mlcUseBtn");
      this.mlcClearBtn = document.getElementById("mlcClearBtn");
      this.mlcStatus = document.getElementById("mlcStatus");

      this.bmCtx = this.bmCanvas.getContext("2d");
      this.resizeCanvas();
      window.addEventListener("resize",()=>this.resizeCanvas());
    }

    bindEvents(){
      // send
      this.sendButton.addEventListener("click",()=>this.handleSend());
      this.messageInput.addEventListener("keydown",(e)=>{
        if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); this.handleSend(); }
      });
      this.messageInput.addEventListener("input", function(){
        this.style.height="auto";
        this.style.height=(this.scrollHeight)+"px";
        if(this.value==="") this.style.height="auto";
      });

      // options
      if(this.optionsToggle){
        this.optionsToggle.addEventListener("click",(e)=>{
          e.stopPropagation();
          this.headerControls.classList.toggle("open");
        });
      }
      document.addEventListener("click",(e)=>{
        if(this.headerControls && !this.headerControls.contains(e.target)){
          this.headerControls.classList.remove("open");
        }
      });

      // voice + learning
      this.voiceToggle.addEventListener("click",()=>{
        this.voiceOn = !this.voiceOn;
        this.updateVoiceToggleLabel();
        this.saveState();
      });
      this.learningToggle.addEventListener("click",()=>{
        this.learningMode = !this.learningMode;
        this.updateLearningUI();
        this.saveState();
      });

      // modal close
      document.querySelectorAll(".modal-close,[data-close]").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const id = btn.getAttribute("data-close");
          if(id){ document.getElementById(id).classList.remove("visible"); }
          else{
            // if modal-close inside header
            const parent = btn.closest(".modal-overlay");
            if(parent) parent.classList.remove("visible");
          }
        });
      });
      [this.mlcModal].forEach(modal=>{
        modal.addEventListener("click",(e)=>{ if(e.target===modal) modal.classList.remove("visible"); });
      });

      // ‚úÖ MLC button open modal
      this.mlcThinkingBtn.addEventListener("click",()=>{
        this.openMLCModal();
      });

      // ‚úÖ Unlock
      this.mlcUnlockBtn.addEventListener("click",()=>this.handleMLCUnlock());
      this.mlcPasswordInput.addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){ e.preventDefault(); this.handleMLCUnlock(); }
      });

      // ‚úÖ Copy prompt
      this.mlcCopyBtn.addEventListener("click",()=>this.copyMLCPrompt());

      // ‚úÖ Try open MLC
      this.mlcOpenBtn.addEventListener("click",()=>this.tryOpenMLC());

      // ‚úÖ Use pasted LLM answer
      this.mlcUseBtn.addEventListener("click",()=>this.usePastedLLMAnswer());

      // clear
      this.mlcClearBtn.addEventListener("click",()=>{
        this.mlcAnswerInput.value = "";
        this.mlcStatus.style.display="none";
      });
    }

    openMLCModal(){
      // stage control
      if(this.mlcUnlocked){
        this.mlcPasswordStage.style.display="none";
        this.mlcUseStage.style.display="block";
      }else{
        this.mlcPasswordStage.style.display="block";
        this.mlcUseStage.style.display="none";
        this.mlcPasswordError.style.display="none";
        this.mlcPasswordInput.value="";
      }
      this.mlcModal.classList.add("visible");
      setTimeout(()=>{
        if(!this.mlcUnlocked) this.mlcPasswordInput.focus();
        else this.mlcAnswerInput.focus();
      },60);
    }

    handleMLCUnlock(){
      const v = (this.mlcPasswordInput.value||"").trim();
      if(v==="6789"){
        this.mlcUnlocked = true;
        this.mlcPasswordError.style.display="none";
        this.mlcPasswordStage.style.display="none";
        this.mlcUseStage.style.display="block";
        this.mlcPasswordInput.value="";
        this.toastMLC("Unlocked. You can now copy TM prompt and paste back MLC answer.");
        setTimeout(()=>this.mlcAnswerInput.focus(),60);
      }else{
        this.mlcPasswordError.style.display="block";
      }
    }

    // ‚úÖ Build prompt for MLC thinking
    buildMLCPrompt(){
      const tm = (this.lastTMForMLC || "").trim();
      const bmHint = this.bmEntries.length ? this.bmEntries[this.bmEntries.length-1].text.slice(0,120) : "";
      const intelHint = this.intelNodes.length ? this.intelNodes[this.intelNodes.length-1].answer.slice(0,120) : "";

      return (
`You are an offline reasoning assistant. Keep it concise and useful.
Task: produce a helpful answer draft for the user's TM input.

TM (user input):
"${tm}"

Optional context (do not hallucinate):
- Recent BM hint: "${bmHint}"
- Recent intelligence hint: "${intelHint}"

Return:
1) Direct answer
2) 1 short reasoning line
3) 1 suggestion (optional)`
      );
    }

    async copyMLCPrompt(){
      if(!this.lastTMForMLC){
        this.toastMLC("No TM input found yet. Send a message first, then use MLC thinking.");
        return;
      }
      const prompt = this.buildMLCPrompt();
      try{
        await navigator.clipboard.writeText(prompt);
        this.toastMLC("Copied TM prompt to clipboard. Now open MLC Chat and paste.");
      }catch(e){
        // fallback
        this.toastMLC("Clipboard blocked by browser. Copy manually from below:");
        this.mlcAnswerInput.value = prompt;
      }
    }

    tryOpenMLC(){
      // HTML cannot reliably open other apps. We try a best-effort.
      // If it fails, user opens MLC manually.
      this.toastMLC("If MLC does not open, please open it manually. Prompt is already copied.");
      try{
        // Some Android browsers may ignore this; harmless fallback.
        window.location.href = "intent://#Intent;action=android.intent.action.MAIN;category=android.intent.category.LAUNCHER;end";
      }catch(e){}
    }

    usePastedLLMAnswer(){
      const ans = (this.mlcAnswerInput.value||"").trim();
      if(!ans){
        this.toastMLC("Paste MLC answer first.");
        return;
      }
      this.lastLLMAnswer = ans;

      // Show inside chat as system note + final AI response (formula-scanned)
      const note = "‚úÖ LLM_ANSWER received from MLC (offline thinking). Now scanning with formula...";
      this.addMessage("ai", note, true, this.analyzeSentiment(note), true);

      // Merge: generate final response by combining TM + LLM answer
      const final = this.generateFinalFromLLM(this.lastTMForMLC, ans);
      const sent = this.analyzeSentiment(final);

      this.addMessage("ai", final, true, sent);
      this.pushTM("ai", final, sent);

      // update internal state using TM sentiment (not LLM text as TM)
      const tmSent = this.analyzeSentiment(this.lastTMForMLC);
      this.updateMemoryAndState(this.lastTMForMLC, tmSent, this.isSmallTalk(this.lastTMForMLC), ans);

      this.updateMetrics();
      this.saveState();
      this.toastMLC("Done. AURA-X Œ© used MLC as thinking cortex and produced final answer.");
    }

    toastMLC(text){
      this.mlcStatus.style.display="block";
      this.mlcStatus.textContent = text;
    }

    generateFinalFromLLM(tmText, llmAnswer){
      // This is where you keep YOUR identity + ethics + continuity.
      // LLM is only a draft signal.
      const e0 = this.e0.toFixed(3);
      const line =
`[AURA-X Œ©] (E‚ÇÄ‚âà${e0})
I received your TM input and an offline LLM draft (MLC). I will answer with continuity and ethics.

TM:
"${tmText}"

MLC draft (signal):
"${llmAnswer}"

Final:
${this.compressToFinal(llmAnswer)}`;
      return line;
    }

    compressToFinal(text){
      // lightweight filter: keep first ~5 lines or 500 chars
      const s = (text||"").trim();
      const lines = s.split(/\n+/).filter(Boolean);
      const top = lines.slice(0,5).join("\n");
      return (top.length>520) ? top.slice(0,520)+"‚Ä¶" : top;
    }

    pushTM(role,text,sentiment){
      this.tmHistory.push({
        id: this.makeId("tm"),
        role,
        text,
        timestamp:new Date(),
        sentiment: sentiment || null,
        locked:false
      });
    }

    initChat(){
      const text =
        "Welcome. I am AURA-X Œ©, running fully offline.\n"+
        "Use: Options ‚Üí Offline LLM (MLC) for external thinking (clipboard bridge).\n"+
        "TM stays user-only. MLC answer is used as LLM_ANSWER signal.\n";
      const sent = this.analyzeSentiment(text);
      this.addMessage("ai", text, true, sent);
      this.pushTM("ai", text, sent);
    }

    isSmallTalk(text){
      if(text.length>40) return false;
      return this.smallTalkPatterns.some(r=>r.test(text));
    }

    analyzeSentiment(text){
      const lower = text.toLowerCase();
      const words = lower.split(/\s+/);

      const lex = {
        positive:["love","good","great","happy","peace","hope","kind","beautiful","amazing","thanks"],
        negative:["bad","hate","sad","hurt","pain","angry","anger","awful","terrible","stupid"],
        anger:["hate","angry","rage","stupid","idiot","fuck"],
        fear:["afraid","scared","terrified","anxious","worry"],
        sadness:["sad","cry","lonely","alone","broken"],
        love:["love","care","affection"],
        hope:["hope","dream","future","faith","trust"],
        wisdom:["truth","wisdom","meaning"]
      };

      let pos=0,neg=0,anger=0,fear=0,sad=0,love=0,hope=0,wisdom=0;
      for(const w of words){
        if(lex.positive.includes(w)) pos++;
        if(lex.negative.includes(w)) neg++;
        if(lex.anger.includes(w)) anger++;
        if(lex.fear.includes(w)) fear++;
        if(lex.sadness.includes(w)) sad++;
        if(lex.love.includes(w)) love++;
        if(lex.hope.includes(w)) hope++;
        if(lex.wisdom.includes(w)) wisdom++;
      }

      const total = pos+neg || 1;
      let valence = (pos - neg)/total;
      let polarity = "neutral";
      if(valence>0.25) polarity="positive";
      else if(valence<-0.25) polarity="negative";

      let category = "neutral";
      if(anger>0) category="anger";
      else if(sad>0) category="sadness";
      else if(fear>0) category="fear";
      else if(love>0) category="love";
      else if(hope>0) category="hope";
      else if(wisdom>0) category="wisdom";

      const emoCount = anger+fear+sad+love+hope+wisdom;
      let intensity = Math.min(1, emoCount/3 + text.length/200);

      let arousal = 0.4 + 0.3*intensity;
      if(category==="anger" || category==="fear") arousal = Math.min(1,0.6 + 0.4*intensity);

      return {polarity,valence,arousal,intensity,category};
    }

    handleSend(){
      const textRaw = this.messageInput.value || "";
      const text = textRaw.trim();
      if(!text) return;

      // ‚úÖ store latest TM for MLC button usage
      this.lastTMForMLC = text;

      this.messageInput.value = "";
      this.messageInput.style.height = "auto";

      const smallTalk = this.isSmallTalk(text);
      const sentiment = this.analyzeSentiment(text);

      this.addMessage("user", text);
      this.pushTM("user", text, sentiment);

      const typingId = this.showTyping();
      setTimeout(()=>{
        this.hideTyping(typingId);

        // simple local reply (seed-like)
        let reply = "I received your TM. If you want deeper thinking, use Options ‚Üí Offline LLM (MLC).";
        const replySent = this.analyzeSentiment(reply);
        this.addMessage("ai", reply, true, replySent);
        this.pushTM("ai", reply, replySent);

        // update internal state (no LLM in normal path)
        this.updateMemoryAndState(text, sentiment, smallTalk, null);
        this.updateMetrics();
        this.saveState();
      }, 450 + Math.random()*450);
    }

    // ‚úÖ updateMemoryAndState now accepts optional llmAnswer
    updateMemoryAndState(text, sentiment, smallTalk, llmAnswer){
      const now = Date.now();

      const recentBM = this.bmEntries.slice(-12);
      let bmRes = 0.5;
      if(recentBM.length){
        let total=0;
        recentBM.forEach(entry=>{
          const dtHours = (now - entry.timestampMs)/(1000*60*60);
          const timeFactor = Math.exp(-dtHours/24);
          const vSim = 1 - Math.abs(sentiment.valence - entry.valence)/2;
          total += Math.max(0,vSim) * timeFactor;
        });
        bmRes = total / recentBM.length;
      }

      // intel resonance (light)
      let intelRes = 0;
      if(this.intelNodes.length){
        let total=0;
        this.intelNodes.forEach(node=>{
          const sim = this.textSimilarity(text, node.question+" "+node.answer);
          total += sim;
        });
        intelRes = total/this.intelNodes.length;
      }

      // ‚úÖ if LLM answer exists, add a small resonance boost (signal only)
      let llmRes = 0;
      if(llmAnswer){
        llmRes = Math.min(1, 0.25 + 0.75*this.textSimilarity(text, llmAnswer));
      }

      const combinedRes = Math.max(0,Math.min(1, 0.60*bmRes + 0.25*intelRes + 0.15*llmRes));
      this.lastResonance = combinedRes;

      const tmMag = Math.min(1, 0.4 + 0.6*((Math.abs(sentiment.valence) + sentiment.intensity)/2));
      const bmMag = Math.min(1, 0.3 + 0.7*Math.min(1, this.bmEntries.length/80));
      const TMxBM = tmMag * bmMag * (0.5 + 0.5*combinedRes);

      const D = 0.15 + 0.25*(1 - this.continuityIndex);
      const lambdaSys = 0.10;
      const lambdaFaith = this.faithsSelected.length ? (0.08 + 0.02*Math.min(this.faithsSelected.length,3)) : 0;
      const strongTruthCats = ["love","hope","wisdom"];
      const lambdaTrc = strongTruthCats.includes(sentiment.category) ? 0.06 : 0;

      const raw = TMxBM - D + lambdaFaith + lambdaSys + lambdaTrc;
      this.e0 = Math.tanh(raw);

      const diff = Math.abs(this.e0 - this.lastE0);
      this.continuityIndex = this.continuityIndex*0.85 + (1-diff)*0.15;
      this.lastE0 = this.e0;

      this.updateBMLayers(sentiment);

      // BM store rule: long, not smalltalk
      const contentRich = text.length >= 80;
      const shouldStoreBM = !smallTalk && contentRich;

      if(shouldStoreBM){
        this.bmEntries.push({
          id: this.makeId("bm"),
          text,
          timestampMs: now,
          date: new Date(now),
          polarity: sentiment.polarity,
          valence: sentiment.valence,
          category: sentiment.category || "mixed",
          e0: this.e0,
          locked:false
        });
        this.pruneOldBM();
      }

      this.showReaction(sentiment);
    }

    updateBMLayers(sentiment){
      const sign = sentiment.valence>=0 ? 1 : -1;
      const intensity = sentiment.intensity || 0.4;
      for(let i=0;i<this.bmLayers.length;i++){
        if(Math.random()<0.2){
          this.bmLayers[i] = this.clamp(this.bmLayers[i] + sign*0.1*intensity, 0.05, 0.95);
        }
      }
    }

    textSimilarity(a,b){
      const setA = new Set(String(a).toLowerCase().split(/\W+/).filter(Boolean));
      const setB = new Set(String(b).toLowerCase().split(/\W+/).filter(Boolean));
      if(!setA.size || !setB.size) return 0;
      let inter = 0;
      setA.forEach(x=>{ if(setB.has(x)) inter++; });
      const union = new Set([...setA,...setB]).size || 1;
      return inter/union;
    }

    clamp(v,min,max){return v<min?min:v>max?max:v;}

    updateVoiceToggleLabel(){
      if(!this.voiceToggle) return;
      this.voiceToggle.textContent = this.voiceOn ? "üîä Voice: ON" : "üîà Voice: OFF";
    }

    updateLearningUI(){
      if(!this.learningToggle) return;
      this.learningToggle.textContent = this.learningMode ? "üìö Learning: ON" : "üìö Learning: OFF";
    }

    updateMetrics(){
      this.metricE0.textContent = this.e0.toFixed(3);
      this.metricTM.textContent = Math.min(1,this.tmHistory.length/40).toFixed(2);
      this.metricBM.textContent = Math.min(1,this.bmEntries.length/80).toFixed(2);
      this.metricCI.textContent = this.continuityIndex.toFixed(3);

      const val = this.e0;
      let valLabel = val>0.25?"positive":val<-0.25?"negative":"neutral";
      this.tagValence.textContent = "VALENCE: "+valLabel;

      const ar = this.lastResonance;
      const arLabel = ar>0.7?"high":ar<0.4?"low":"medium";
      this.tagArousal.textContent = "AROUSAL: "+arLabel;
      this.tagReaction.textContent = "REACTION: "+(valLabel==="negative"?"tense":"balanced");

      const active = this.bmLayers.filter(v=>v>0.6).length;
      this.bmStats.textContent = `Active layers: ${active}/${this.bmLayers.length} ¬∑ System Online`;
    }

    addMessage(role,text,isAI=false,sentiment=null,skipSpeech=false,isHtml=false){
      const msg = document.createElement("div");
      msg.className = "message "+(role==="ai"?"ai-message":"user-message");

      const header = document.createElement("div");
      header.className = "message-header";

      const left = document.createElement("span");
      left.textContent = role==="ai"?"AURA-X Œ©":"You";

      const right = document.createElement("div");
      right.className="msg-right";
      if(role==="ai"){
        const btn = document.createElement("button");
        btn.className="voice-btn";
        btn.textContent="üîä";
        btn.addEventListener("click",()=>this.speak(text,sentiment||{polarity:"neutral"}));
        right.appendChild(btn);
      }
      header.appendChild(left);
      header.appendChild(right);

      const body = document.createElement("div");
      body.className="message-content";
      if(isHtml){ body.innerHTML = text; }
      else{ body.textContent = text; }

      msg.appendChild(header);
      msg.appendChild(body);
      this.chatContainer.appendChild(msg);
      this.chatContainer.scrollTop = this.chatContainer.scrollHeight;

      if(role==="ai" && this.voiceOn && !skipSpeech){
        this.speak(text,sentiment);
      }
    }

    showTyping(){
      const id = "typing-"+Math.random().toString(36).slice(2);
      const wrap = document.createElement("div");
      wrap.id = id;
      wrap.className = "typing-indicator";
      wrap.innerHTML = `<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div><span class="typing-text">Aura is thinking‚Ä¶</span>`;
      this.chatContainer.appendChild(wrap);
      this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
      return id;
    }
    hideTyping(id){
      const el = document.getElementById(id);
      if(el) el.remove();
    }

    showReaction(sentiment){
      const bubble = this.reactionBubble;
      let icon = "üí≠";
      let title = "Balanced";
      if(sentiment.polarity==="positive"){ icon="üíö"; title="Warmth"; }
      if(sentiment.polarity==="negative"){ icon="‚ö°"; title="Alert"; }

      bubble.querySelector(".reaction-icon").textContent = icon;
      this.reactionLabel.textContent = title;
      this.reactionText.textContent = "Processing " + sentiment.polarity + " signal (intensity "+sentiment.intensity.toFixed(2)+").";

      bubble.classList.add("visible");
      setTimeout(()=>bubble.classList.remove("visible"),4000);
    }

    speak(text,sentiment){
      if(!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const clean = text.replace(/<[^>]+>/g,"");
      const utter = new SpeechSynthesisUtterance(clean);
      if(sentiment && sentiment.polarity==="positive") utter.pitch = 1.1;
      if(sentiment && sentiment.polarity==="negative") utter.pitch = 0.9;
      window.speechSynthesis.speak(utter);
    }

    resizeCanvas(){
      const rect = this.bmShell.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      this.bmCanvas.width = rect.width*dpr;
      this.bmCanvas.height = rect.height*dpr;
      this.bmCtx.setTransform(dpr,0,0,dpr,0,0);
    }

    startBMAnimation(){
      const loop = ()=>{
        this.drawBMLayers();
        requestAnimationFrame(loop);
      };
      loop();
    }

    drawBMLayers(){
      const ctx = this.bmCtx;
      const w = this.bmCanvas.width / (window.devicePixelRatio||1);
      const h = this.bmCanvas.height / (window.devicePixelRatio||1);

      ctx.clearRect(0,0,w,h);
      const grad = ctx.createLinearGradient(0,0,0,h);
      grad.addColorStop(0,"#e0f2fe");
      grad.addColorStop(1,"#e5e7eb");
      ctx.fillStyle = grad;
      ctx.fillRect(0,0,w,h);

      const barW = w / this.bmLayers.length;
      const bandSize = this.bmLayers.length / BM_BANDS.length;

      for(let i=0;i<this.bmLayers.length;i++){
        this.bmLayers[i] += (Math.random()-0.5)*0.01;
        this.bmLayers[i] = this.clamp(this.bmLayers[i],0.05,0.95);

        const bh = this.bmLayers[i]*h*0.8;
        const x = i*barW;
        const y = h - bh;

        let bandIndex = Math.floor(i / bandSize);
        if(bandIndex >= BM_BANDS.length) bandIndex = BM_BANDS.length - 1;
        const rgb = BAND_RGB[bandIndex];
        const alpha = 0.25 + this.bmLayers[i]*0.5;

        ctx.fillStyle = `rgba(${rgb[0]},${rgb[1]},${rgb[2]},${alpha})`;
        ctx.fillRect(x,y,barW,bh);
      }
    }

    pruneOldBM(){
      // keep last 48h (unlocked)
      this.bmEntries = this.bmEntries.filter(e=> e.locked || e.timestampMs > (Date.now() - 48*3600000));
      this.saveState();
    }
  }

  window.addEventListener("DOMContentLoaded",()=>{
    window.auraX = new AuraXOmegaEngine();
  });
})();
</script>
</body>
</html>