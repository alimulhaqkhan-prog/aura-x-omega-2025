<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Emotional Continuity Prototype (AEC v3.1)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #fdf4e3; /* book-page background */
      color: #111827;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Header */
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    .subtitle {
      font-size: 11px;
      opacity: 0.8;
    }

    .badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .badge {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(4px);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .badge-pill {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 500;
    }

    .badge-version {
      background: #ecfeff;
      border-color: #67e8f9;
      color: #0369a1;
    }

    .badge-equation {
      background: #f5f3ff;
      border-color: #c4b5fd;
      color: #4c1d95;
    }

    .engine-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: #eef2ff;
      color: #1e3a8a;
    }

    .engine-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }

    .engine-dot.offline {
      background: #f97316;
      box-shadow: 0 0 0 4px rgba(248, 113, 113, 0.25);
    }

    /* Toolbar buttons */
    .toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-chip {
      flex: 1 1 0;
      min-width: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.18);
      background: rgba(255, 255, 255, 0.9);
      font-size: 12px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(15, 23, 42, 0.08);
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        background 0.08s ease;
    }

    .btn-chip span.icon {
      font-size: 14px;
    }

    .btn-chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(15, 23, 42, 0.12);
      background: #fefce8;
    }

    .btn-chip.secondary {
      background: #ecfeff;
    }

    .btn-chip.danger {
      background: #fef2f2;
      border-color: #fecaca;
    }

    /* Ethics banner */
    .ethics-banner {
      padding: 10px 12px;
      border-radius: 16px;
      background: #fefce8;
      border: 1px solid rgba(234, 179, 8, 0.3);
      font-size: 12px;
      line-height: 1.4;
      color: #854d0e;
    }

    /* Equation box */
    .equation-card {
      padding: 10px 12px;
      border-radius: 18px;
      background: rgba(255, 255, 255, 0.95);
      border: 1px dashed rgba(15, 23, 42, 0.16);
      font-size: 12px;
      line-height: 1.4;
    }

    .equation-title {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .equation-body {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      margin-bottom: 4px;
    }

    .equation-note {
      font-size: 11px;
      color: #6b7280;
    }

    /* Reaction card */
    .reaction-card {
      padding: 10px 12px;
      border-radius: 18px;
      background: #ecfdf3;
      border: 1px solid rgba(22, 163, 74, 0.3);
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .reaction-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 2px;
    }

    .reaction-title {
      font-size: 13px;
      font-weight: 600;
      color: #166534;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .reaction-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
      color: #166534;
    }

    .reaction-meta strong {
      font-weight: 600;
    }

    .reaction-body {
      font-size: 12px;
      color: #14532d;
    }

    .reaction-engine-status {
      font-size: 11px;
      color: #166534;
      opacity: 0.9;
      margin-top: 2px;
    }

    /* Chat area */
    .chat-shell {
      flex: 1 1 0;
      min-height: 0;
      border-radius: 20px;
      border: 1px solid rgba(15, 23, 42, 0.16);
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.3),
        0 6px 14px rgba(15, 23, 42, 0.12);
    }

    .chat-log {
      flex: 1 1 0;
      min-height: 0;
      overflow-y: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 13px;
    }

    .message-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .msg-label {
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .msg-user {
      align-self: flex-end;
      max-width: 90%;
      background: #fefce8;
      border-radius: 14px 14px 0 14px;
      padding: 6px 8px;
      border: 1px solid rgba(202, 138, 4, 0.25);
    }

    .msg-reactor {
      align-self: flex-start;
      max-width: 92%;
      background: #ecfdf3;
      border-radius: 14px 14px 14px 0;
      padding: 6px 8px;
      border: 1px solid rgba(22, 163, 74, 0.25);
    }

    .msg-time {
      font-size: 10px;
      color: #9ca3af;
      margin-top: 2px;
    }

    /* Input area */
    .input-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: #6b7280;
      flex-wrap: wrap;
    }

    .tm-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #e0f2fe;
      border: 1px solid rgba(37, 99, 235, 0.3);
      font-size: 11px;
      color: #1d4ed8;
      white-space: nowrap;
    }

    .voice-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #ecfdf3;
      border: 1px solid rgba(22, 163, 74, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .voice-pill span.icon {
      font-size: 14px;
    }

    .input-row {
      margin-top: 4px;
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .input-row textarea {
      flex: 1 1 0;
      resize: none;
      min-height: 52px;
      max-height: 96px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(15, 23, 42, 0.18);
      font-family: inherit;
      font-size: 13px;
      outline: none;
      background: #fffdf7;
    }

    .input-row textarea:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.35);
    }

    .btn-send {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      box-shadow: 0 8px 16px rgba(22, 163, 74, 0.4);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        filter 0.08s ease;
      min-width: 84px;
    }

    .btn-send:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 4px 10px rgba(22, 163, 74, 0.4);
      filter: brightness(0.96);
    }

    .footer-trace {
      margin-top: 4px;
      font-size: 10px;
      color: #9ca3af;
      text-align: center;
    }

    .footer-trace strong {
      font-weight: 600;
      color: #4b5563;
    }

    /* BM viewer modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 30;
      padding: 16px;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal {
      max-width: 480px;
      width: 100%;
      max-height: 80vh;
      background: #f9fafb;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.4);
      border: 1px solid rgba(15, 23, 42, 0.25);
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 10px 14px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.12);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .modal-title {
      font-size: 14px;
      font-weight: 600;
    }

    .modal-badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e0f2fe;
      border: 1px solid rgba(59, 130, 246, 0.4);
      color: #1d4ed8;
    }

    .modal-close {
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: #fee2e2;
      color: #b91c1c;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
    }

    .modal-body {
      padding: 10px 14px 12px;
      overflow-y: auto;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .layer-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid rgba(15, 23, 42, 0.08);
    }

    .layer-label {
      font-size: 11px;
      font-weight: 600;
      color: #4b5563;
    }

    .layer-polarity {
      font-size: 11px;
    }

    .layer-polarity.positive {
      color: #16a34a;
    }

    .layer-polarity.negative {
      color: #b91c1c;
    }

    .layer-intensity {
      font-size: 11px;
      color: #6b7280;
    }

    .empty-note {
      font-size: 12px;
      color: #6b7280;
      font-style: italic;
    }

    .hint-text {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <div class="header-top">
      <div class="title-block">
        <div class="title">AURA-X Œ© &mdash; Emotional Continuity Reactor</div>
        <div class="subtitle">
          TM ¬∑ BM ¬∑ AEC ¬∑ CRM ¬∑ AECN ¬∑ RL¬≥ ¬∑ LR¬≥ &mdash; Prototype v3.1
        </div>
        <div class="badges">
          <div class="badge badge-version">Œ© v1 Beta Extended + TRC</div>
          <div class="badge badge-equation">
            E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª<sub>faith</sub> + Œª<sub>sys</sub> + Œ£C‚Çú)
          </div>
        </div>
      </div>
      <div class="engine-pill" id="engine-pill">
        <div class="engine-dot offline" id="engine-dot"></div>
        <div id="engine-label">Seed Engine</div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <button class="btn-chip" id="btn-bm-viewer">
        <span class="icon">üß†</span><span>BM Viewer</span>
      </button>
      <button class="btn-chip secondary" id="btn-recall-bm">
        <span class="icon">üìú</span><span>Recall BM</span>
      </button>
      <button class="btn-chip danger" id="btn-recycle">
        <span class="icon">‚ôªÔ∏è</span><span>Recycle 48h</span>
      </button>
      <button class="btn-chip secondary" id="btn-options">
        <span class="icon">‚öôÔ∏è</span><span>Options</span>
      </button>
    </div>

    <!-- Ethics Banner -->
    <div class="ethics-banner">
      Avoid actions that generate negative emotions in yourself or others.  
      Gently move toward choices that create calm, kindness, and positive
      feelings.
    </div>

    <!-- Equation Box -->
    <div class="equation-card">
      <div class="equation-title">EMOTIONAL CONTINUITY EQUATION</div>
      <div class="equation-body">
        E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª<sub>faith</sub> + Œª<sub>sys</sub> + Œ£C‚Çú)
      </div>
      <div class="equation-note">
        All parameters are updated after every message to keep emotional
        continuity live.
      </div>
    </div>

    <!-- Reaction Card -->
    <div class="reaction-card">
      <div class="reaction-header">
        <div class="reaction-title">AURA-X Œ© REACTION</div>
        <div class="reaction-meta" id="reaction-meta">
          <span><strong>Polarity:</strong> Neutral ¬∑ <span id="polarity-ratio">50 : 50</span></span>
          <span id="tone-label">Tone: Balanced, low-amplitude drift.</span>
        </div>
      </div>
      <div class="reaction-body" id="reaction-text">
        Backend not available, using local seed engine only.
      </div>
      <div class="reaction-engine-status" id="reaction-engine-status">
        Engine: Seed-only continuity. Waiting for LLM reactor‚Ä¶
      </div>
    </div>

    <!-- Main Chat Shell -->
    <div class="chat-shell">
      <div class="chat-log" id="chat-log">
        <!-- Messages will be appended here -->
      </div>

      <div class="input-meta-row">
        <div class="tm-pill">TM = Œ£(User Inputs) + (Seed + LLM)</div>
        <div class="voice-pill">
          <span class="icon">üîä</span><span id="voice-status">Voice: On</span>
        </div>
      </div>

      <div class="input-row">
        <textarea
          id="input"
          placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."
        ></textarea>
        <button class="btn-send" id="btn-send">
          <span>Send</span>
        </button>
      </div>

      <div class="footer-trace">
        Prototype ¬∑ <strong>TM ‚Üí Analysis ‚Üí Equation ‚Üí BM save ‚Üí Reaction</strong>
      </div>
    </div>
  </div>

  <!-- BM Viewer Modal -->
  <div class="modal-backdrop" id="bm-modal">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title">BM Viewer ¬∑ 7 Layers</div>
          <div class="modal-badge">Stored locally in your browser</div>
        </div>
        <button class="modal-close" id="bm-close">&times;</button>
      </div>
      <div class="modal-body" id="bm-body">
        <!-- Layers inserted via JS -->
      </div>
    </div>
  </div>

  <script>
    /************************************************************
     * AURA-X Œ© FRONTEND ‚Äì Emotional Continuity Prototype v3.1
     * Backend: aura-x-omega-backend-2.onrender.com
     ************************************************************/

    const BACKEND_URL =
      "https://aura-x-omega-backend-2.onrender.com/react";

    const STORAGE_KEY = "aura_x_omega_bm_v3_1";

    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("btn-send");
    const chatLog = document.getElementById("chat-log");

    const engineDot = document.getElementById("engine-dot");
    const engineLabel = document.getElementById("engine-label");
    const reactionText = document.getElementById("reaction-text");
    const reactionMeta = document.getElementById("reaction-meta");
    const reactionEngineStatus = document.getElementById(
      "reaction-engine-status"
    );
    const polarityRatioEl = document.getElementById("polarity-ratio");
    const toneLabelEl = document.getElementById("tone-label");

    const bmModal = document.getElementById("bm-modal");
    const bmBody = document.getElementById("bm-body");
    const bmBtn = document.getElementById("btn-bm-viewer");
    const bmClose = document.getElementById("bm-close");
    const recallBtn = document.getElementById("btn-recall-bm");
    const recycleBtn = document.getElementById("btn-recycle");

    /********************** BM STORAGE **************************/

    function loadBM() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          return {
            layers: {
              L1: null,
              L2: null,
              L3: null,
              L4: null,
              L5: null,
              L6: null,
              L7: null,
            },
            history: [],
          };
        }
        return JSON.parse(raw);
      } catch (e) {
        console.warn("Failed to parse BM store", e);
        return {
          layers: {
            L1: null,
            L2: null,
            L3: null,
            L4: null,
            L5: null,
            L6: null,
            L7: null,
          },
          history: [],
        };
      }
    }

    function saveBM(store) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
      } catch (e) {
        console.warn("Failed to save BM", e);
      }
    }

    function updateBMLayersFromReaction(tmText, reaction) {
      const store = loadBM();
      const now = new Date().toISOString();

      const entry = {
        id: now,
        tm: tmText,
        reactionText: reaction.text,
        polarity: reaction.polarity,
        ratio: reaction.ratio,
        tone: reaction.tone,
        engine: reaction.engine,
        timestamp: now,
      };

      // shift through layers (simple compression)
      store.layers.L7 = store.layers.L6;
      store.layers.L6 = store.layers.L5;
      store.layers.L5 = store.layers.L4;
      store.layers.L4 = store.layers.L3;
      store.layers.L3 = store.layers.L2;
      store.layers.L2 = store.layers.L1;
      store.layers.L1 = entry;

      store.history.unshift(entry);
      if (store.history.length > 200) {
        store.history.pop();
      }

      saveBM(store);
    }

    /**************** SEED ENGINE (LOCAL FALLBACK) **************/

    function seedReact(tmText) {
      const lower = tmText.toLowerCase();
      let polarity = "Neutral";
      let ratio = "50 : 50";
      let tone =
        "Balanced, neutral drift with gentle curiosity toward clarity.";
      let text =
        "I am using the local seed engine. I received your TM and I am holding it in a calm, observing way. " +
        "Nothing urgent feels dominant; we can slowly move this memory toward clarity and gentle insight.";

      if (lower.includes("sad") || lower.includes("hurt")) {
        polarity = "Negative-leaning";
        ratio = "30 : 70";
        tone = "Soft sadness with protective, stabilizing intent.";
        text =
          "I can feel a gentle negative drift in this TM &mdash; something like sadness or hurt. " +
          "Let us hold it carefully, without judgement, and look for one small step that reduces pain instead of amplifying it.";
      } else if (
        lower.includes("happy") ||
        lower.includes("excited") ||
        lower.includes("success")
      ) {
        polarity = "Positive-leaning";
        ratio = "70 : 30";
        tone = "Warm, grateful, low-amplitude joy.";
        text =
          "This TM carries a positive resonance &mdash; something like quiet happiness or achievement. " +
          "Let us anchor this feeling inside BM so that future difficult moments can borrow strength from it.";
      }

      return {
        text,
        polarity,
        ratio,
        tone,
        engine: "seed",
      };
    }

    /*********************** UI HELPERS *************************/

    function appendUserMessage(text) {
      const row = document.createElement("div");
      row.className = "message-row";

      const label = document.createElement("div");
      label.className = "msg-label";
      label.textContent = "TM ¬∑ USER INPUT";
      row.appendChild(label);

      const bubble = document.createElement("div");
      bubble.className = "msg-user";
      bubble.innerHTML = text.replace(/\n/g, "<br>");
      row.appendChild(bubble);

      const time = document.createElement("div");
      time.className = "msg-time";
      time.textContent = new Date().toLocaleTimeString();
      row.appendChild(time);

      chatLog.appendChild(row);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function appendReactorMessage(reaction) {
      const row = document.createElement("div");
      row.className = "message-row";

      const label = document.createElement("div");
      label.className = "msg-label";
      label.textContent = "Œ© ¬∑ REACTOR";
      row.appendChild(label);

      const bubble = document.createElement("div");
      bubble.className = "msg-reactor";
      bubble.innerHTML = reaction.text;
      row.appendChild(bubble);

      const time = document.createElement("div");
      time.className = "msg-time";
      time.textContent =
        reaction.engine === "llm"
          ? "LLM Reactor ¬∑ " + new Date().toLocaleTimeString()
          : "Seed Engine ¬∑ " + new Date().toLocaleTimeString();
      row.appendChild(time);

      chatLog.appendChild(row);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function setEngineStatus(engine) {
      if (engine === "llm") {
        engineDot.classList.remove("offline");
        engineLabel.textContent = "LLM Emotional Reactor";
        reactionEngineStatus.textContent =
          "Engine: Live LLM reactor connected to AURA-X Œ© backend.";
      } else {
        engineDot.classList.add("offline");
        engineLabel.textContent = "Seed Engine";
        reactionEngineStatus.textContent =
          "Engine: Seed-only continuity. Waiting for LLM reactor‚Ä¶";
      }
    }

    function applyReactionToHeader(reaction) {
      polarityRatioEl.textContent = reaction.ratio || "50 : 50";
      toneLabelEl.textContent =
        "Tone: " + (reaction.tone || "Balanced, neutral drift.");
      reactionText.innerHTML = reaction.text;
      const engineLabelTxt =
        reaction.engine === "llm" ? "LLM reactor" : "seed engine";
      reactionEngineStatus.textContent =
        "Engine: " + engineLabelTxt + " ¬∑ emotional continuity updated.";
    }

    /******************* BACKEND CALL ***************************/

    async function sendToBackend(tmText) {
      const bmStore = loadBM();
      const payload = {
        tmText,
        bmSnapshot: bmStore.layers,
      };

      try {
        const res = await fetch(BACKEND_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          throw new Error("Non-200 response from backend");
        }

        const data = await res.json();

        const reaction = {
          text:
            data.reactionText ||
            data.reply ||
            data.message ||
            "LLM reactor responded, but without a clear message field.",
          polarity:
            data.polarity || data.emotionPolarity || "Positive-leaning",
          ratio: data.ratio || data.polarityRatio || "58 : 42",
          tone:
            data.tone ||
            data.emotionalTone ||
            "Light, gentle, low-amplitude positive drift.",
          engine: data.engine === "seed" ? "seed" : "llm",
        };

        return reaction;
      } catch (err) {
        console.warn("Backend call failed, falling back to seed engine:", err);
        return null;
      }
    }

    /********************* MAIN SEND FLOW ************************/

    async function handleSend() {
      const text = inputEl.value.trim();
      if (!text) return;

      inputEl.value = "";
      appendUserMessage(text);

      // Try backend first
      let reaction = await sendToBackend(text);

      if (reaction) {
        setEngineStatus("llm");
      } else {
        // Fallback to seed engine
        reaction = seedReact(text);
        setEngineStatus("seed");
      }

      applyReactionToHeader(reaction);
      appendReactorMessage(reaction);
      updateBMLayersFromReaction(text, reaction);
    }

    sendBtn.addEventListener("click", handleSend);

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    /*********************** BM VIEWER **************************/

    function renderBMModal() {
      const store = loadBM();
      bmBody.innerHTML = "";

      const layers = store.layers;

      const layerNames = [
        "L1 ¬∑ Fresh (0‚Äì48h)",
        "L2 ¬∑ Recent (2‚Äì7 days)",
        "L3 ¬∑ Weekly",
        "L4 ¬∑ Monthly",
        "L5 ¬∑ Yearly",
        "L6 ¬∑ Deep Archive",
        "L7 ¬∑ Resonant Trace",
      ];

      const keys = ["L1", "L2", "L3", "L4", "L5", "L6", "L7"];

      let hasAny = false;

      keys.forEach((key, idx) => {
        const entry = layers[key];
        const row = document.createElement("div");
        row.className = "layer-row";

        const left = document.createElement("div");
        const label = document.createElement("div");
        label.className = "layer-label";
        label.textContent = layerNames[idx];
        left.appendChild(label);

        const snippet = document.createElement("div");
        snippet.className = "hint-text";
        if (entry && entry.tm) {
          hasAny = true;
          const plain = entry.tm.replace(/\s+/g, " ").trim();
          snippet.textContent =
            plain.length > 70 ? plain.slice(0, 70) + "‚Ä¶" : plain;
        } else {
          snippet.textContent = "Empty ¬∑ nothing stored in this layer yet.";
        }
        left.appendChild(snippet);

        const right = document.createElement("div");
        right.style.textAlign = "right";

        const pol = document.createElement("div");
        pol.className = "layer-polarity";
        if (entry && entry.polarity) {
          const isPos = entry.polarity.toLowerCase().includes("positive");
          pol.classList.add(isPos ? "positive" : "negative");
          pol.textContent = entry.polarity;
        } else {
          pol.textContent = "Neutral";
        }
        right.appendChild(pol);

        const intensity = document.createElement("div");
        intensity.className = "layer-intensity";
        intensity.textContent = entry && entry.ratio ? entry.ratio : "50 : 50";
        right.appendChild(intensity);

        row.appendChild(left);
        row.appendChild(right);
        bmBody.appendChild(row);
      });

      if (!hasAny) {
        const note = document.createElement("div");
        note.className = "empty-note";
        note.textContent =
          "No BM entries yet. Send a few messages and the reactor will start layering your memories.";
        bmBody.appendChild(note);
      }
    }

    bmBtn.addEventListener("click", () => {
      renderBMModal();
      bmModal.classList.add("active");
    });

    bmClose.addEventListener("click", () => {
      bmModal.classList.remove("active");
    });

    bmModal.addEventListener("click", (e) => {
      if (e.target === bmModal) {
        bmModal.classList.remove("active");
      }
    });

    /*********************** RECALL / RECYCLE *******************/

    recallBtn.addEventListener("click", () => {
      const store = loadBM();
      const last = store.history[0];

      if (!last) {
        alert("No BM stored yet. Send a message first.");
        return;
      }

      inputEl.value =
        "Recall thread:\n" +
        last.tm +
        "\n\nŒ© last reaction: " +
        (last.reactionText || "") +
        "\n\nContinue emotional continuity from here‚Ä¶";
      inputEl.focus();
    });

    recycleBtn.addEventListener("click", () => {
      if (
        !confirm(
          "Recycle 48h: This will softly clear the freshest L1 layer so new memories can enter. Continue?"
        )
      ) {
        return;
      }
      const store = loadBM();
      store.layers.L1 = null;
      saveBM(store);
      alert("L1 recycled. Emotional continuity will now lean on deeper layers.");
    });

    /*********************** INITIAL STATE **********************/

    // On first load, show short hint message in chat
    (function init() {
      const hintRow = document.createElement("div");
      hintRow.className = "message-row";

      const label = document.createElement("div");
      label.className = "msg-label";
      label.textContent = "Œ© ¬∑ HINT";
      hintRow.appendChild(label);

      const bubble = document.createElement("div");
      bubble.className = "msg-reactor";
      bubble.innerHTML =
        "Welcome to <strong>AURA-X Œ©</strong>. This prototype treats every message as TM, " +
        "passes it through the Emotional Continuity Equation, then stores a compressed trace in BM (L1‚ÄìL7). " +
        "Send any thought, memory, or feeling and notice how the reactor keeps continuity over time.";
      hintRow.appendChild(bubble);

      chatLog.appendChild(hintRow);
      chatLog.scrollTop = chatLog.scrollHeight;

      setEngineStatus("seed");
    })();
  </script>
</body>
</html>
