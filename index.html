<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äî Emotional Continuity</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5ecde;
      --card: #ffffff;
      --accent: #2f855a;
      --accent-soft: #e6f4ec;
      --border: #e0d4c4;
      --text-main: #2d3748;
      --text-soft: #4a5568;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }
    .page {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px 16px 80px;
    }
    header {
      text-align: center;
      padding: 18px 10px 10px;
    }
    header h1 {
      margin: 0 0 4px;
      font-size: 1.6rem;
      letter-spacing: 0.04em;
    }
    header .subtitle {
      font-size: 0.78rem;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }
    .top-badge {
      margin: 14px auto 10px;
      padding: 8px 14px;
      border-radius: 999px;
      background: #d0e6ff;
      font-size: 0.78rem;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    .top-badge strong {
      font-weight: 600;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0 8px;
      align-items: center;
      justify-content: center;
    }
    .pill-btn {
      border-radius: 999px;
      padding: 6px 14px;
      border: 1px solid var(--border);
      background: #faf5ef;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .pill-btn span.dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #e53e3e;
    }
    .pill-btn.active span.dot {
      background: #38a169;
    }
    .pill-btn.mode-live {
      background: #276749;
      color: #fff;
      border-color: #276749;
    }
    .pill-btn.mode-local {
      background: #744210;
      color: #fff;
      border-color: #744210;
    }

    .select {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 5px 10px;
      font-size: 0.8rem;
      background: #faf5ef;
    }

    .card {
      background: var(--card);
      border-radius: 18px;
      padding: 14px 16px;
      margin-top: 10px;
      border: 1px solid var(--border);
    }
    .card-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .equation-box {
      font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 0.88rem;
      background: #edf2f7;
      border-radius: 12px;
      padding: 10px 12px;
      white-space: nowrap;
      overflow-x: auto;
    }
    textarea {
      width: 100%;
      min-height: 96px;
      resize: vertical;
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      font-size: 0.95rem;
      font-family: inherit;
      background: #fdfaf5;
    }
    textarea:focus {
      outline: 2px solid #c6f6d5;
      border-color: #38a169;
    }
    .send-row {
      display: flex;
      margin-top: 10px;
      justify-content: flex-end;
    }
    .btn-send {
      border-radius: 999px;
      border: none;
      padding: 10px 30px;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(56, 161, 105, 0.45);
    }
    .btn-send:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(56, 161, 105, 0.4);
    }

    .reaction-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .reaction-body {
      font-size: 0.92rem;
      color: var(--text-soft);
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .reaction-note {
      font-size: 0.8rem;
      color: #718096;
      margin-top: 8px;
    }

    .bm-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .bm-chip {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.78rem;
      background: #f7fafc;
      border: 1px solid #e2e8f0;
    }
    .bm-chip.active {
      background: var(--accent-soft);
      border-color: #48bb78;
    }
    .polarity-row {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
    }
    .polarity-bar {
      flex: 1;
      height: 8px;
      border-radius: 999px;
      overflow: hidden;
      background: #e2e8f0;
      display: flex;
    }
    .polarity-pos {
      height: 100%;
      background: #48bb78;
    }
    .polarity-neg {
      height: 100%;
      background: #fc8181;
    }
    .footer-note {
      font-size: 0.75rem;
      color: #a0aec0;
      text-align: center;
      margin-top: 12px;
    }

    .toolbar-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    .toolbar-btn {
      border-radius: 24px;
      padding: 7px 12px;
      font-size: 0.8rem;
      border: 1px solid var(--border);
      background: #fffaf0;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: #2d3748;
      color: #f7fafc;
      padding: 8px 14px;
      font-size: 0.8rem;
      border-radius: 999px;
      box-shadow: 0 5px 14px rgba(0, 0, 0, 0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 999;
    }
    .toast.show {
      opacity: 1;
      pointer-events: auto;
    }

    @media (min-width: 700px) {
      header h1 { font-size: 1.9rem; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>AURA-X Œ© ‚Äî Emotional Continuity</h1>
      <div class="subtitle">TM √ó BM ¬∑ AEC ¬∑ CRM ¬∑ AECN ¬∑ LR¬≥</div>
      <div class="top-badge">
        <strong>MODE: <span id="mode-label">LOCAL</span></strong>
        <span id="mode-subtitle">Universal Ethics ¬∑ Local TM√óBM reactor</span>
      </div>
    </header>

    <!-- Toggle row -->
    <div class="pill-row">
      <button id="mode-btn" class="pill-btn mode-local">
        <span class="dot"></span><span id="mode-btn-text">Mode: LOCAL</span>
      </button>

      <button id="faith-btn" class="pill-btn">
        <span class="dot"></span>Faith Lens: <span id="faith-label">OFF</span>
      </button>

      <button id="voice-btn" class="pill-btn">
        <span class="dot"></span>Voice: <span id="voice-label">OFF</span>
      </button>

      <select id="engine-select" class="select">
        <option value="openai">Engine: OpenAI (GPT)</option>
        <option value="claude">Engine: Claude</option>
        <option value="gemini">Engine: Gemini</option>
      </select>
    </div>

    <!-- Equation card -->
    <div class="card">
      <div class="card-title">Emotional Continuity Equation</div>
      <div class="equation-box">
        E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)
      </div>
      <p style="font-size:0.82rem; color:#4a5568; margin-top:6px;">
        All parameters are updated after every message to keep emotional continuity live.
      </p>
    </div>

    <!-- Input -->
    <div class="card">
      <textarea
        id="tm-input"
        placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."></textarea>
      <div class="send-row">
        <button id="send-btn" class="btn-send">Send</button>
      </div>
    </div>

    <!-- Reaction -->
    <div class="card" id="reaction-card">
      <div class="reaction-title">AURA-X Œ© Reaction</div>
      <div class="reaction-body" id="reaction-body">
        Local MODE: Feelings processed as TM√óBM continuity.
        <br /><br />
        Your message will appear here.
      </div>
      <div class="reaction-note" id="reaction-note">
        Local reactor uses only on-page TM√óBM equation. LIVE mode uses remote LLM reactor.
      </div>
    </div>

    <!-- Bold Memory & Polarity -->
    <div class="card">
      <div class="card-title">Bold Memory Layers (L1‚ÄìL7)</div>
      <div class="bm-row" id="bm-row">
        <span class="bm-chip active">L1</span>
        <span class="bm-chip">L2</span>
        <span class="bm-chip">L3</span>
        <span class="bm-chip">L4</span>
        <span class="bm-chip">L5</span>
        <span class="bm-chip">L6</span>
        <span class="bm-chip">L7</span>
      </div>

      <div class="polarity-row">
        <span>Polarity:</span>
        <div class="polarity-bar">
          <div id="pol-pos" class="polarity-pos" style="width: 70%;"></div>
          <div id="pol-neg" class="polarity-neg" style="width: 30%;"></div>
        </div>
        <span id="pol-label">Positive 70 : 30</span>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="card">
      <div class="toolbar-row">
        <button class="toolbar-btn" id="bm-viewer-btn">üß† BM Viewer</button>
        <button class="toolbar-btn" id="bm-recall-btn">üîÅ Recall 48h</button>
        <button class="toolbar-btn" id="bm-recycle-btn">‚ôª Recycle BM</button>
        <button class="toolbar-btn" id="options-btn">‚öô Options</button>
      </div>
      <div class="footer-note">
        Prototype ¬∑ TM ‚Üí Analysis ‚Üí Equation ‚Üí BM save ‚Üí Reaction.
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // -------- CONFIG --------
    const backendBaseUrl = "https://aura-x-omega-backend-1.onrender.com"; // change if needed
    const STORAGE_KEY = "aurax_bm_log_v1";

    let currentMode = "LOCAL"; // LOCAL or LIVE
    let faithOn = false;
    let voiceOn = false;
    let currentEngine = "openai";

    const tmInput = document.getElementById("tm-input");
    const sendBtn = document.getElementById("send-btn");
    const modeBtn = document.getElementById("mode-btn");
    const modeBtnText = document.getElementById("mode-btn-text");
    const modeLabel = document.getElementById("mode-label");
    const modeSubtitle = document.getElementById("mode-subtitle");
    const faithBtn = document.getElementById("faith-btn");
    const faithLabel = document.getElementById("faith-label");
    const voiceBtn = document.getElementById("voice-btn");
    const voiceLabel = document.getElementById("voice-label");
    const engineSelect = document.getElementById("engine-select");
    const reactionBody = document.getElementById("reaction-body");
    const reactionNote = document.getElementById("reaction-note");
    const polPos = document.getElementById("pol-pos");
    const polNeg = document.getElementById("pol-neg");
    const polLabel = document.getElementById("pol-label");
    const toast = document.getElementById("toast");

    // -------- UTIL --------
    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2500);
    }

    function saveBMEntry(entry) {
      try {
        const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
        arr.push(entry);
        // keep last 100
        while (arr.length > 100) arr.shift();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
      } catch (e) {
        console.warn("BM save failed", e);
      }
    }

    function getBMEntries() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      } catch {
        return [];
      }
    }

    function computeLocalEmotion(text) {
      const lower = text.toLowerCase();
      let score = 0;
      const posWords = ["love", "shukriya", "thanks", "great", "amazing", "khushi", "happy", "peace"];
      const negWords = ["sad", "hate", "gham", "dard", "angry", "naraz", "tension"];

      posWords.forEach(w => { if (lower.includes(w)) score += 2; });
      negWords.forEach(w => { if (lower.includes(w)) score -= 2; });

      // length effect
      score += Math.sign(text.length - 40);

      // faith lens slight bias
      if (faithOn) score += 1;

      // clamp
      if (score > 6) score = 6;
      if (score < -6) score = -6;

      const pos = 50 + score * 5;
      const posPct = Math.min(95, Math.max(5, pos));
      const negPct = 100 - posPct;

      return { posPct, negPct };
    }

    function updatePolarityDisplay(posPct, negPct) {
      polPos.style.width = posPct + "%";
      polNeg.style.width = negPct + "%";
      const label =
        posPct >= 50
          ? "Positive " + Math.round(posPct) + " : " + Math.round(negPct)
          : "Negative " + Math.round(negPct) + " : " + Math.round(posPct);
      polLabel.textContent = label;
    }

    function speak(text) {
      if (!voiceOn) return;
      if (!("speechSynthesis" in window)) {
        showToast("Voice not supported in this browser.");
        return;
      }
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "en-US";
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    // -------- MODE TOGGLES --------
    modeBtn.addEventListener("click", () => {
      currentMode = currentMode === "LOCAL" ? "LIVE" : "LOCAL";

      const isLive = currentMode === "LIVE";
      modeBtn.classList.toggle("mode-live", isLive);
      modeBtn.classList.toggle("mode-local", !isLive);
      modeBtnText.textContent = "Mode: " + currentMode;
      modeLabel.textContent = currentMode;

      if (isLive) {
        modeSubtitle.textContent =
          "Universal Ethics ¬∑ BM + Live LLM ¬∑ Engine: " +
          engineSelect.options[engineSelect.selectedIndex].text;
      } else {
        modeSubtitle.textContent =
          "Universal Ethics ¬∑ Local TM√óBM emotional reactor";
      }
    });

    faithBtn.addEventListener("click", () => {
      faithOn = !faithOn;
      faithBtn.classList.toggle("active", faithOn);
      faithLabel.textContent = faithOn ? "ON" : "OFF";
      showToast("Faith lens " + (faithOn ? "enabled" : "disabled"));
    });

    voiceBtn.addEventListener("click", () => {
      voiceOn = !voiceOn;
      voiceBtn.classList.toggle("active", voiceOn);
      voiceLabel.textContent = voiceOn ? "ON" : "OFF";
      showToast("Voice " + (voiceOn ? "enabled" : "disabled"));
    });

    engineSelect.addEventListener("change", () => {
      currentEngine = engineSelect.value;
      if (currentMode === "LIVE") {
        modeSubtitle.textContent =
          "Universal Ethics ¬∑ BM + Live LLM ¬∑ Engine: " +
          engineSelect.options[engineSelect.selectedIndex].text;
      }
    });

    // -------- BM viewer dummy --------
    document.getElementById("bm-viewer-btn").addEventListener("click", () => {
      const entries = getBMEntries();
      if (!entries.length) {
        alert("BM Viewer: no stored layers yet.");
        return;
      }
      const text = entries
        .slice(-10)
        .map(
          (e, idx) =>
            `${idx + 1}. [${new Date(e.time).toLocaleString()}] P:${Math.round(
              e.posPct
            )} : ${Math.round(e.negPct)}  ‚Üí  ${e.text}`
        )
        .join("\n\n");
      alert("Last BM entries:\n\n" + text);
    });

    document
      .getElementById("bm-recall-btn")
      .addEventListener("click", () => {
        const entries = getBMEntries();
        const cutoff = Date.now() - 48 * 60 * 60 * 1000;
        const recent = entries.filter(e => e.time >= cutoff);
        alert(
          "Recall 48h:\n\n" +
            (recent[0]
              ? recent
                  .slice(-8)
                  .map(
                    e =>
                      "[" +
                      new Date(e.time).toLocaleTimeString() +
                      "] " +
                      e.text
                  )
                  .join("\n")
              : "No BM entries in last 48 hours.")
        );
      });

    document
      .getElementById("bm-recycle-btn")
      .addEventListener("click", () => {
        localStorage.removeItem(STORAGE_KEY);
        showToast("BM recycled (local store cleared).");
      });

    document.getElementById("options-btn").addEventListener("click", () => {
      alert(
        "AURA-X Œ© Options (prototype):\n\n" +
          "- Mode: LOCAL / LIVE\n" +
          "- Faith Lens ON/OFF\n" +
          "- Voice ON/OFF\n" +
          "- Engine: OpenAI / Claude / Gemini (if backend keys exist)"
      );
    });

    // -------- SEND HANDLER --------
    sendBtn.addEventListener("click", async () => {
      const text = tmInput.value.trim();
      if (!text) {
        showToast("Write something first.");
        return;
      }

      const { posPct, negPct } = computeLocalEmotion(text);
      updatePolarityDisplay(posPct, negPct);

      const bmEntry = {
        time: Date.now(),
        text,
        posPct,
        negPct,
        mode: currentMode
      };
      saveBMEntry(bmEntry);

      // Default local reaction text
      let finalReply =
        "Local MODE: Feelings processed as TM√óBM continuity.\n\n" +
        "Your message was:\n" +
        text;

      // If LIVE ‚Üí call backend
      if (currentMode === "LIVE") {
        try {
          reactionBody.textContent =
            "AURA-X Œ© is contacting live reactor (" +
            currentEngine +
            ")‚Ä¶";

          const resp = await fetch(backendBaseUrl + "/api/react", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              tm: text,
              engine: currentEngine
            })
          });

          const data = await resp.json();
          console.log("Backend response:", data);

          if (data.ok && data.reply) {
            finalReply =
              "AURA-X Œ© (LIVE ‚Äì " +
              (data.engine || currentEngine) +
              "):\n\n" +
              data.reply;
            reactionNote.textContent =
              "Live MODE: Remote LLM reactor + local TM√óBM continuity.";
          } else {
            finalReply =
              "AURA-X Œ© backend error, using local emotional continuity.\n\n" +
              (data.reply || "") +
              "\n\nLocal reflection on your message:\n" +
              text;
            reactionNote.textContent =
              "Backend error: " +
              (data.error || "Unknown") +
              ". Local reactor is still active.";
          }
        } catch (err) {
          console.error(err);
          finalReply =
            "AURA-X Œ© could not reach backend. Local TM√óBM reactor is replying.\n\n" +
            "Your message was:\n" +
            text;
          reactionNote.textContent =
            "Network error while calling backend. Local reactor only.";
        }
      } else {
        reactionNote.textContent =
          "Local MODE: TM√óBM equation only. LIVE mode adds remote LLM reactor.";
      }

      reactionBody.textContent = finalReply;
      speak(finalReply);
      tmInput.value = "";
    });
  </script>
</body>
</html>
