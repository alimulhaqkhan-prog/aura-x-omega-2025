<!DOCTYPE html>
<html lang="ur">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>AURA-X Î© â€” Offline Emotional Continuity Prototype (Episode+Digest)</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(circle at 20% 0%, rgba(30,41,59,.95) 0, transparent 45%),
        radial-gradient(circle at 80% 0%, rgba(14,165,233,.55) 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      padding:18px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .app{
      width:100%;
      max-width:1100px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    /* Header */
    header.hero{
      border-radius:22px;
      padding:16px 16px;
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 24px 60px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }
    .hero-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;flex-direction:column;gap:6px;
    }
    .brand h1{
      font-size:26px;
      letter-spacing:.4px;
      line-height:1.1;
      display:flex;align-items:center;gap:10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(2,6,23,.35);
    }
    .ethics{
      margin-top:6px;
      font-size:12.5px;
      opacity:.92;
      line-height:1.5;
      max-width:720px;
    }
    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .small-toggle{
      cursor:pointer;
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      color:#e5e7eb;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(2,6,23,.35);
      transition:transform .08s ease, background .2s ease;
      user-select:none;
    }
    .small-toggle:active{transform:scale(.98)}
    .small-toggle.on{
      background:rgba(34,197,94,.18);
      border-color:rgba(34,197,94,.35);
    }
    .small-toggle.danger{
      background:rgba(239,68,68,.15);
      border-color:rgba(239,68,68,.35);
    }

    /* Layout */
    main.layout{
      display:grid;
      grid-template-columns: 1fr 1.2fr;
      gap:14px;
    }
    @media(max-width:980px){
      main.layout{grid-template-columns:1fr}
    }

    /* Cards */
    .card{
      border-radius:22px;
      padding:14px;
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 42px rgba(0,0,0,.30);
      backdrop-filter: blur(10px);
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:10px;
    }
    .card-title{
      display:flex;gap:10px;align-items:center;
      font-size:15px;font-weight:700;
    }
    .emoji{filter: drop-shadow(0 10px 18px rgba(0,0,0,.35))}
    .card-sub{font-size:12px;opacity:.9;line-height:1.5;margin-top:4px}

    /* Metrics */
    .metrics-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .metric{
      border-radius:16px;
      padding:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(2,6,23,.25);
    }
    .metric-label{font-size:12px;opacity:.92}
    .metric-value{font-size:20px;font-weight:800;margin-top:4px}
    .metric-note{font-size:11px;opacity:.8;margin-top:2px}
    .status-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tag{
      font-size:11px;
      padding:7px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(2,6,23,.25);
    }

    /* BM Canvas */
    .bm-wrapper{display:flex;flex-direction:column;gap:10px}
    .bm-canvas-shell{
      position:relative;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(2,6,23,.25);
      overflow:hidden;
      height:220px;
    }
    canvas{width:100%;height:100%;display:block}
    .bm-overlay-btn{
      position:absolute;top:10px;
      border-radius:999px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(2,6,23,.35);
      color:#e5e7eb;
      cursor:pointer;
      font-size:12px;
      user-select:none;
    }
    .bm-overlay-btn.left{left:10px}
    .bm-overlay-btn.right{right:10px}
    .bm-footer{
      font-size:12px;
      opacity:.9;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    /* Console */
    .console-head{
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      margin-bottom:8px;
    }
    .equation-pill{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(2,6,23,.25);
      white-space:nowrap;
    }
    .chat{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(2,6,23,.25);
      padding:10px;
      height:420px;
      overflow:auto;
    }
    .msg{
      display:flex;
      gap:10px;
      margin:10px 0;
      align-items:flex-start;
    }
    .bubble{
      max-width:82%;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.07);
      line-height:1.55;
      white-space:pre-wrap;
      word-break:break-word;
      font-size:13px;
    }
    .msg.user{justify-content:flex-end}
    .msg.user .bubble{
      background:rgba(14,165,233,.16);
      border-color:rgba(14,165,233,.28);
    }
    .meta{
      font-size:10px;opacity:.8;margin-top:6px
    }

    /* Input */
    .input-row{
      margin-top:10px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .input-shell{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(2,6,23,.25);
    }
    textarea{
      flex:1;
      resize:none;
      outline:none;
      border:none;
      background:transparent;
      color:#e5e7eb;
      font-size:13px;
      min-height:22px;
      max-height:110px;
      line-height:1.45;
    }
    .btn{
      cursor:pointer;
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-weight:700;
      font-size:12px;
      color:#0b1220;
      background:linear-gradient(135deg,#e0f2ff,#93c5fd);
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
      user-select:none;
    }
    .btn:active{transform:scale(.99)}
    .flow{
      margin-top:10px;
      font-size:12px;
      opacity:.9;
      line-height:1.55;
    }

    /* Option panel */
    .option-panel{
      display:none;
      margin-top:10px;
      border-radius:18px;
      padding:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(2,6,23,.25);
    }
    .option-panel.show{display:block}
    .opt-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media(max-width:680px){.opt-grid{grid-template-columns:1fr}}
    .opt{
      border-radius:16px;
      padding:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
    }
    .opt h3{font-size:13px;margin-bottom:6px}
    .opt p{font-size:12px;opacity:.9;line-height:1.5}
    .mini-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center}
    .input-mini{
      width:100%;
      margin-top:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(2,6,23,.25);
      color:#e5e7eb;
      outline:none;
      font-size:12px;
    }
    select.input-mini{appearance:none}

    .btn-mini{
      cursor:pointer;
      border-radius:12px;
      padding:9px 10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(2,6,23,.35);
      color:#e5e7eb;
      font-size:12px;
      user-select:none;
    }
    .btn-mini:active{transform:scale(.99)}
    .btn-mini.btn-danger{
      background:rgba(239,68,68,.15);
      border-color:rgba(239,68,68,.35);
    }
    .btn-mini.btn-ok{
      background:rgba(34,197,94,.16);
      border-color:rgba(34,197,94,.35);
    }

    /* Modals */
    .modal-overlay{
      position:fixed;inset:0;
      display:none;
      background:rgba(0,0,0,.55);
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal-overlay.show{display:flex}
    .modal-card{
      width:100%;
      max-width:860px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(2,6,23,.92);
      box-shadow: 0 30px 90px rgba(0,0,0,.6);
      overflow:hidden;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      align-items:center;
    }
    .modal-title{font-size:14px;font-weight:800}
    .modal-sub{font-size:12px;opacity:.88;margin-top:3px}
    .modal-close{
      cursor:pointer;
      border-radius:12px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:#e5e7eb;
      font-size:12px;
      user-select:none;
    }
    .modal-body{padding:14px}
    .modal-search{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:#e5e7eb;
      outline:none;
      font-size:12px;
    }
    .list{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:420px;
      overflow:auto;
      padding-right:4px;
    }
    .item{
      border-radius:16px;
      padding:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
    }
    .item-head{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .item-title{font-size:13px;font-weight:800}
    .item-meta{font-size:11px;opacity:.85}
    .item-text{margin-top:8px;font-size:12.5px;line-height:1.6;opacity:.95;white-space:pre-wrap}
    .chip{
      font-size:10px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(2,6,23,.35);
      opacity:.95;
    }

    /* Floating bubbles */
    .float-bubble{
      position:fixed;
      right:14px;
      bottom:14px;
      z-index:40;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(2,6,23,.55);
      padding:10px 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      max-width:320px;
      display:none;
    }
    .float-bubble.show{display:block}
    .float-title{font-size:12px;font-weight:900;margin-bottom:6px}
    .float-text{font-size:12px;opacity:.93;line-height:1.55;white-space:pre-wrap}
    .float-meta{font-size:10px;opacity:.8;margin-top:6px}
  </style>
</head>

<body>
  <div class="app">
    <header class="hero">
      <div class="hero-top">
        <div class="brand">
          <h1>âš¡ AURA-X Î© <span class="pill">EMOTIONAL CONTINUITY ENGINE â€¢ OFFLINE</span></h1>
          <div class="ethics">
            Ø§Ø®Ù„Ø§Ù‚ÛŒ Ù‚Ø§Ø¹Ø¯Û: Ø§ÛŒØ³Û’ Ø¹Ù…Ù„/Ù…Ø´ÙˆØ±Û’ Ø³Û’ Ø¨Ú†ÛŒÚº Ø¬Ùˆ Ù…Ù†ÙÛŒ Ø¬Ø°Ø¨Ø§Øª Ú©Ùˆ Ø¨Ú‘Ú¾Ø§Ø¦ÛŒÚºØŒ Ù†Ù‚ØµØ§Ù† ÛŒØ§ Ù†ÙØ±Øª Ù¾Ú¾ÛŒÙ„Ø§Ø¦ÛŒÚºØŒ ÛŒØ§ â€œØ³Ú†/Ø§Ù†ØµØ§Ùâ€ Ú©Û’ Ø®Ù„Ø§Ù Ø¬Ø§Ø¦ÛŒÚºÛ”  
            ÛŒÛØ§Úº TM ØªÛŒØ²ÛŒ Ø³Û’ Ø¨Ø¯Ù„ØªÛŒ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª ÛÛ’ØŒ BM ØµØ±Ù Ù…Ø¹Ù†ÛŒ Ø®ÛŒØ² â€œØ§ÛŒÙˆÙ†Ù¹Ø³/Ø§ÛŒÙ¾ÛŒ Ø³ÙˆÚˆØ²â€ Ú©ÛŒ Ú©Ù…Ù¾Ø±ÛŒØ³Úˆ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª ÛÛ’Û”
          </div>
        </div>

        <div class="controls">
          <button id="optionsToggle" class="small-toggle">âš™ï¸ Options</button>
          <button id="voiceToggle" class="small-toggle on">ğŸ”Š Voice: ON</button>
          <button id="learningToggle" class="small-toggle on">ğŸ“š Learning: ON</button>
          <button id="feedSeedButton" class="small-toggle">ğŸŒ± Feed-the-Seed</button>
          <button id="bmOpenModal" class="small-toggle">ğŸ“ BM (Episodes)</button>
          <button id="convOpenModal" class="small-toggle">â— TM (48h)</button>
        </div>
      </div>

      <div id="optionPanel" class="option-panel">
        <div class="opt-grid">
          <div class="opt">
            <h3>ğŸ§  BM: Episode + Daily Digest</h3>
            <p>
              Ù…Ø¹Ù†ÛŒ Ø®ÛŒØ² Ú¯ÙØªÚ¯Ùˆ Ú©Ùˆ â€œØ§ÛŒÙ¾ÛŒ Ø³ÙˆÚˆ/Ø§ÛŒÙˆÙ†Ù¹â€ Ø¨Ù†Ø§ Ú©Ø± BM Ù…ÛŒÚº Ù…Ø­ÙÙˆØ¸ Ú©ÛŒØ§ Ø¬Ø§ØªØ§ ÛÛ’ (Ù¹Ø§Ø¦Ù… Ø§Ø³Ù¹ÛŒÙ…Ù¾ + Ù„ÙˆÚ©ÛŒØ´Ù† + polarity).  
              ØºÛŒØ± Ø¶Ø±ÙˆØ±ÛŒ/Ú†Ú¾ÙˆÙ¹ÛŒ/Ø³Ù„Ø§Ù… Ø¯Ø¹Ø§ BM Ù…ÛŒÚº Ù†ÛÛŒÚº Ø¬Ø§ØªÛŒÛ”
            </p>
            <div class="mini-row">
              <button id="episodeToggle" class="btn-mini btn-ok">Episode Mode: ON</button>
              <button id="digestNowBtn" class="btn-mini">Make Daily Digest Now</button>
              <button id="finalizeEpisodeBtn" class="btn-mini">Finalize Current Episode</button>
            </div>
          </div>

          <div class="opt">
            <h3>ğŸ“ Ù„ÙˆÚ©ÛŒØ´Ù†/Ù„ÛŒØ¨Ù„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</h3>
            <p>Ø¢Ù¾ Ú†Ø§ÛÛŒÚº ØªÙˆ ÛØ± BM Ø§ÛŒÙˆÙ†Ù¹ Ú©Û’ Ø³Ø§ØªÚ¾ Ù„ÙˆÚ©ÛŒØ´Ù† ÛŒØ§ Ù„ÛŒØ¨Ù„ Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº (Ù…Ø«Ù„Ø§Ù‹ Timergara, Court, Office).</p>
            <input id="locationInput" class="input-mini" placeholder="Location label (optional) Ù…Ø«Ù„Ø§Ù‹ Timergara / Court" />
            <div class="mini-row">
              <button id="saveLocationBtn" class="btn-mini btn-ok">Save Location</button>
              <button id="clearLocationBtn" class="btn-mini btn-danger">Clear</button>
            </div>
          </div>

          <div class="opt">
            <h3>â™»ï¸ TM Decay (48h)</h3>
            <p>TM ØµØ±Ù ØªØ§Ø²Û Ú¯ÙØªÚ¯Ùˆ ÛÛ’Û” 48 Ú¯Ú¾Ù†Ù¹Û’ Ø¨Ø¹Ø¯ Ø®ÙˆØ¯ decay/clearÛ” BM Ù…Ø­ÙÙˆØ¸ Ø±ÛØªØ§ ÛÛ’Û”</p>
            <div class="mini-row">
              <button id="clear48Btn" class="btn-mini btn-danger">Clear TM (48h)</button>
              <button id="clearAllBtn" class="btn-mini btn-danger">Clear EVERYTHING</button>
            </div>
          </div>

          <div class="opt">
            <h3>ğŸ›ï¸ BM Save Rules</h3>
            <p>Ú©Ù… Ø§Ø²Ú©Ù… 4 user messages Ø§ÙˆØ± Ú©Ø§ÙÛŒ Ù…ØªÙ†/Ù…Ø¹Ù†ÛŒ ÛÙˆ ØªÙˆ BM Ø§ÛŒÙˆÙ†Ù¹ Ø¨Ù†ØªØ§ ÛÛ’Û” Greeting/1-liners BM Ù…ÛŒÚº Ù†ÛÛŒÚº Ø¬Ø§ØªÛ’Û”</p>
            <select id="bmStrictness" class="input-mini">
              <option value="strict">Strict (recommended)</option>
              <option value="normal">Normal</option>
              <option value="loose">Loose</option>
            </select>
            <div class="mini-row">
              <button id="saveStrictBtn" class="btn-mini btn-ok">Save</button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="layout">
      <div class="left-col" style="display:flex;flex-direction:column;gap:14px;">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title"><span class="emoji">ğŸ§ª</span><span>Emotional Metrics</span></div>
              <div class="card-sub">Eâ‚€ = tanh((TM Ã— (BM + Intel)) âˆ’ D + Î»_faith + Î»_sys + Î»_trc) â€” demo heuristic.</div>
            </div>
          </div>

          <div class="metrics-grid">
            <div class="metric">
              <div class="metric-label">Emotional state Eâ‚€</div>
              <div id="metricE0" class="metric-value">0.00</div>
              <div class="metric-note">range [-1, +1]</div>
            </div>
            <div class="metric">
              <div class="metric-label">TM activation</div>
              <div id="metricTM" class="metric-value">0.00</div>
              <div class="metric-note">recent user input weight</div>
            </div>
            <div class="metric">
              <div class="metric-label">BM resonance</div>
              <div id="metricBM" class="metric-value">0.00</div>
              <div class="metric-note">episode similarity / valence</div>
            </div>
            <div class="metric">
              <div class="metric-label">Continuity index</div>
              <div id="metricCI" class="metric-value">0.80</div>
              <div class="metric-note">trajectory stability</div>
            </div>
          </div>

          <div class="status-row">
            <span id="tagValence" class="tag">VALENCE: neutral</span>
            <span id="tagArousal" class="tag">AROUSAL: medium</span>
            <span id="tagReaction" class="tag">REACTION: balanced</span>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title"><span class="emoji">ğŸ§ </span><span>Bold Memory Layers (240)</span></div>
              <div class="card-sub">BM Ø§Ø¨ â€œEpisode + Daily Digestâ€ Ù…ÛŒÚº Ù…Ø­ÙÙˆØ¸ ÛÙˆØªÛŒ ÛÛ’Û”</div>
            </div>
          </div>

          <div class="bm-wrapper">
            <div class="bm-canvas-shell" id="bmShell">
              <button class="bm-overlay-btn left" id="bmOpenModal2" title="Recall from BM">ğŸ“ BM</button>
              <button class="bm-overlay-btn right" id="convOpenModal2" title="View TM">â— TM</button>
              <canvas id="bmCanvas"></canvas>
            </div>
            <div id="bmStats" class="bm-footer">
              <span>Active layers: 0/240</span>
              <span id="bmCounts">Episodes: 0 Â· Digests: 0</span>
            </div>
          </div>
        </section>
      </div>

      <div class="right-col" style="display:flex;flex-direction:column;gap:14px;">
        <section class="card">
          <div class="console-head">
            <div class="card-title"><span class="emoji">ğŸ§¬</span><span>Emotional Continuity Console</span></div>
            <div class="equation-pill">Eâ‚€ = tanh((TM Ã— (BM + Intel)) âˆ’ D + Î»â€¦)</div>
          </div>

          <div id="chatContainer" class="chat"></div>

          <div class="input-row">
            <div class="input-shell">
              <textarea id="messageInput" rows="1" placeholder="Ø§Ù¾Ù†Ø§ Ù…ÛŒØ³Ø¬ Ù„Ú©Ú¾ÛŒÚºâ€¦ (Enter = send, Shift+Enter = Ù†Ø¦ÛŒ Ù„Ø§Ø¦Ù†)"></textarea>
            </div>
            <button id="sendButton" class="btn">Send</button>
          </div>

          <div class="flow">
            ÙÙ„Ùˆ: (User â†’ TM) â†’ sentiment/logic â†’ (TM Ã— BM resonance) â†’ Ø§Ú¯Ø± Ú¯ÙØªÚ¯Ùˆ Ù…Ø¹Ù†ÛŒ Ø®ÛŒØ² ÛÙˆ ØªÙˆ â€œEpisodeâ€ Ú©ÛŒ Ø´Ú©Ù„ Ù…ÛŒÚº BM Ù…Ø­ÙÙˆØ¸ â†’ Ø±ÙˆØ²Ø§Ù†Û â€œDaily Digestâ€Û”
          </div>
        </section>
      </div>
    </main>

    <!-- BM Modal -->
    <div id="bmModal" class="modal-overlay">
      <div class="modal-card">
        <div class="modal-header">
          <div>
            <div class="modal-title">ğŸ“ BM â€” Episodes & Daily Digests</div>
            <div class="modal-sub">ÛŒÛØ§Úº ØµØ±Ù Ù…Ø¹Ù†ÛŒ Ø®ÛŒØ² Ø§ÛŒÙˆÙ†Ù¹Ø³/ÚˆØ§Ø¦Ø¬Ø³Ù¹ Ù…Ø­ÙÙˆØ¸ ÛÛŒÚº (Ù¹Ø§Ø¦Ù… + Ù„ÙˆÚ©ÛŒØ´Ù† + polarity).</div>
          </div>
          <button class="modal-close" data-close="bmModal">âœ•</button>
        </div>
        <div class="modal-body">
          <input id="bmSearch" class="modal-search" placeholder="Search BM (keyword / location / polarity)..." />
          <div id="bmList" class="list"></div>
        </div>
      </div>
    </div>

    <!-- TM Modal -->
    <div id="convModal" class="modal-overlay">
      <div class="modal-card">
        <div class="modal-header">
          <div>
            <div class="modal-title">â— TM â€” Conversation (Auto-decay 48h)</div>
            <div class="modal-sub">ÛŒÛ ØµØ±Ù Ø¹Ø§Ø±Ø¶ÛŒ history ÛÛ’Ø› 48 Ú¯Ú¾Ù†Ù¹Û’ Ø¨Ø¹Ø¯ Ø®ÙˆØ¯ Ú©Ù…/Ú©Ù„Ø¦ÛŒØ± ÛÙˆØªÛŒ ÛÛ’Û”</div>
          </div>
          <button class="modal-close" data-close="convModal">âœ•</button>
        </div>
        <div class="modal-body">
          <div id="convList" class="list"></div>
        </div>
      </div>
    </div>

    <!-- Seed modal -->
    <div id="seedModal" class="modal-overlay">
      <div class="modal-card">
        <div class="modal-header">
          <div>
            <div class="modal-title">ğŸŒ± Feed the seed (protected)</div>
            <div class="modal-sub">LaTeX Qâ†’A + optional metadata (polarity/intensity/category) parse Ú©Ø± Ú©Û’ Intel Ù…ÛŒÚº Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚºÛ”</div>
          </div>
          <button class="modal-close" data-close="seedModal">âœ•</button>
        </div>
        <div class="modal-body">
          <div id="seedPasswordStage">
            <p style="font-size:12px;opacity:.9;line-height:1.6">
              ÛŒÛ Ø­ØµÛ Ù…Ø­ÙÙˆØ¸ ÛÛ’Û” Ù¾Ø§Ø³ ÙˆØ±Úˆ Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ” (Demo: <b>6789</b>)
            </p>
            <input id="seedPasswordInput" type="password" class="modal-search" placeholder="Password (default: 6789)">
            <div id="seedPasswordError" style="display:none;color:#fca5a5;font-size:12px;margin-top:8px;">Incorrect password.</div>
            <button id="seedPasswordBtn" class="btn-mini btn-ok" style="margin-top:10px;">Unlock</button>
          </div>

          <div id="seedBlockStage" style="display:none;">
            <p style="font-size:12px;opacity:.9;line-height:1.6">
              ÙØ§Ø±Ù…ÛŒÙ¹ Ù…Ø«Ø§Ù„:
              <br><code>\item What is your name? \textbf{A:} I am AURA-X Î©. [polarity=neutral,category=identity,intensity=0.4]</code>
              <br>ÛŒØ§ Ø§Ù„Ú¯ Ù„Ø§Ø¦Ù†:
              <br><code>\textbf{Polarity:} positive</code>
            </p>
            <textarea id="seedBlockInput" class="modal-search" style="min-height:140px;" placeholder="Paste LaTeX block here..."></textarea>
            <div id="seedBlockPreview" style="font-size:12px;opacity:.85;margin-top:10px;">Waiting for blockâ€¦</div>
            <div class="mini-row" style="margin-top:10px">
              <button id="seedParseBtn" class="btn-mini">Parse</button>
              <button id="seedSaveBtn" class="btn-mini btn-ok" disabled>Save to Seed</button>
              <button id="seedDiscardBtn" class="btn-mini btn-danger">Discard</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating reaction bubble -->
    <div id="reactionBubble" class="float-bubble">
      <div class="float-title" id="reactionLabel">REACTION</div>
      <div class="float-text" id="reactionText">â€¦</div>
      <div class="float-meta" id="reactionMeta">â€¦</div>
    </div>

  </div>

<script>
(function(){
  "use strict";

  const STORAGE_KEY = "auraXOmegaState_v6_episode_digest";
  const SEED_PASSWORD = "6789";
  const TM_MAX_HOURS = 48;

  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
  function now(){ return new Date(); }
  function iso(dt){ return new Date(dt).toISOString(); }
  function fmt(dt){
    const d = new Date(dt);
    return d.toLocaleString(undefined,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"});
  }
  function dayKey(dt){
    const d = new Date(dt);
    return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");
  }
  function makeId(prefix){ return prefix+"_"+Math.random().toString(36).slice(2); }

  // Simple lexicon sentiment (demo)
  const POS = ["good","great","love","happy","hope","excellent","nice","beautiful","thanks","thank","wonderful","perfect","amazing","success","positive"];
  const NEG = ["bad","hate","sad","angry","fear","pain","worried","depressed","negative","problem","wrong","fail","stress","hurt","cry"];
  const GREET = ["hi","hello","hey","assalam","salam","aoa","Ø§Ù„Ø³Ù„Ø§Ù…","Ø³Ù„Ø§Ù…","ÛÛŒÙ„Ùˆ","ÛØ§Ø¦Û’"];

  function analyzeSentiment(text){
    const t = (text||"").toLowerCase();
    let p=0,n=0;
    for(const w of POS){ if(t.includes(w)) p++; }
    for(const w of NEG){ if(t.includes(w)) n++; }

    // Urdu quick hints (very light)
    if(/Ø®ÙˆØ´|Ø¨ÛØªØ±ÛŒÙ†|Ø²Ø¨Ø±Ø¯Ø³Øª|Ø§Ú†Ú¾Ø§|Ù…Ø­Ø¨Øª/.test(text)) p++;
    if(/ØºØµÛ|Ø§Ø¯Ø§Ø³|ÚˆØ±|Ù†ÙØ±Øª|Ù…Ø³Ø¦Ù„Û|Ø®Ø±Ø§Ø¨/.test(text)) n++;

    const score = p - n;
    let polarity = "neutral";
    if(score>0) polarity="positive";
    if(score<0) polarity="negative";

    const intensity = clamp((Math.abs(score) + Math.min(3, (text.length/120))) / 3, 0, 1);
    const arousal = intensity>0.66 ? "high" : (intensity>0.33 ? "medium" : "low");

    let category = "general";
    if(/love|Ù…Ø­Ø¨Øª/.test(text)) category="love";
    if(/angry|ØºØµÛ/.test(text)) category="anger";
    if(/fear|ÚˆØ±/.test(text)) category="fear";
    if(/sad|Ø§Ø¯Ø§Ø³/.test(text)) category="sadness";
    if(/idea|research|paper|patent|AURA|AEC|BM|TM/i.test(text)) category="research";

    return { polarity, valence: clamp(score/5,-1,1), intensity, arousal, category };
  }

  function isGreetingOrTiny(text){
    const s = (text||"").trim();
    if(!s) return true;
    const low = s.toLowerCase();
    if(s.length < 18) return true;
    for(const g of GREET){
      if(low.includes(g)) return true;
    }
    return false;
  }

  function normalizeForSearch(s){
    return (s||"").toLowerCase().replace(/\s+/g," ").trim();
  }

  class Engine{
    constructor(){
      this.state = this.loadState() || this.defaultState();
      this.cacheDom();
      this.bind();
      this.ensureDayRollover();
      this.pruneTM();
      this.drawBM();
      this.renderAll();
      this.initChatIfEmpty();
      this.startTickers();
    }

    defaultState(){
      return {
        version: 6,
        bmLayers: Array.from({length:240}, ()=>0),
        bmEntries: [],  // {id,type,title,summary,ts,location,polarity,intensity,tags,sourceMsgIds}
        tmHistory: [],  // {id,role,text,ts,sentiment}
        intelNodes: [], // {id,q,a,meta}
        e0: 0,
        lastE0: 0,
        continuityIndex: 0.8,
        lastResonance: 0,
        voiceOn: true,
        learningMode: true,

        // New rules
        episodeMode: true,
        bmStrictness: "strict", // strict|normal|loose
        locationLabel: "",
        currentEpisode: {
          id: makeId("ep"),
          startedAt: iso(now()),
          lastTouchedAt: iso(now()),
          msgIds: []
        },
        lastDigestDay: dayKey(now())
      };
    }

    loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){ return null; }
    }

    saveState(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(this.state)); }catch(e){}
    }

    cacheDom(){
      this.chatContainer = document.getElementById("chatContainer");
      this.messageInput = document.getElementById("messageInput");
      this.sendButton = document.getElementById("sendButton");

      this.metricE0 = document.getElementById("metricE0");
      this.metricTM = document.getElementById("metricTM");
      this.metricBM = document.getElementById("metricBM");
      this.metricCI = document.getElementById("metricCI");
      this.tagValence = document.getElementById("tagValence");
      this.tagArousal = document.getElementById("tagArousal");
      this.tagReaction = document.getElementById("tagReaction");

      this.bmCanvas = document.getElementById("bmCanvas");
      this.bmStats = document.getElementById("bmStats");
      this.bmCounts = document.getElementById("bmCounts");

      this.optionsToggle = document.getElementById("optionsToggle");
      this.optionPanel = document.getElementById("optionPanel");

      this.voiceToggle = document.getElementById("voiceToggle");
      this.learningToggle = document.getElementById("learningToggle");

      this.bmOpenModal = document.getElementById("bmOpenModal");
      this.bmOpenModal2 = document.getElementById("bmOpenModal2");
      this.convOpenModal = document.getElementById("convOpenModal");
      this.convOpenModal2 = document.getElementById("convOpenModal2");

      this.bmModal = document.getElementById("bmModal");
      this.convModal = document.getElementById("convModal");
      this.seedModal = document.getElementById("seedModal");

      this.bmSearch = document.getElementById("bmSearch");
      this.bmList = document.getElementById("bmList");
      this.convList = document.getElementById("convList");

      this.clear48Btn = document.getElementById("clear48Btn");
      this.clearAllBtn = document.getElementById("clearAllBtn");

      this.feedSeedButton = document.getElementById("feedSeedButton");
      this.seedPasswordStage = document.getElementById("seedPasswordStage");
      this.seedBlockStage = document.getElementById("seedBlockStage");
      this.seedPasswordInput = document.getElementById("seedPasswordInput");
      this.seedPasswordError = document.getElementById("seedPasswordError");
      this.seedPasswordBtn = document.getElementById("seedPasswordBtn");
      this.seedBlockInput = document.getElementById("seedBlockInput");
      this.seedBlockPreview = document.getElementById("seedBlockPreview");
      this.seedParseBtn = document.getElementById("seedParseBtn");
      this.seedSaveBtn = document.getElementById("seedSaveBtn");
      this.seedDiscardBtn = document.getElementById("seedDiscardBtn");

      // New options
      this.episodeToggle = document.getElementById("episodeToggle");
      this.digestNowBtn = document.getElementById("digestNowBtn");
      this.finalizeEpisodeBtn = document.getElementById("finalizeEpisodeBtn");
      this.locationInput = document.getElementById("locationInput");
      this.saveLocationBtn = document.getElementById("saveLocationBtn");
      this.clearLocationBtn = document.getElementById("clearLocationBtn");
      this.bmStrictness = document.getElementById("bmStrictness");
      this.saveStrictBtn = document.getElementById("saveStrictBtn");

      this.reactionBubble = document.getElementById("reactionBubble");
      this.reactionLabel = document.getElementById("reactionLabel");
      this.reactionText = document.getElementById("reactionText");
      this.reactionMeta = document.getElementById("reactionMeta");
    }

    bind(){
      this.sendButton.addEventListener("click", ()=>this.handleSend());
      this.messageInput.addEventListener("keydown",(e)=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          this.handleSend();
        }
      });
      this.messageInput.addEventListener("input", ()=>{
        this.messageInput.style.height="auto";
        this.messageInput.style.height = Math.min(110, this.messageInput.scrollHeight) + "px";
      });

      this.optionsToggle.addEventListener("click", ()=>{
        this.optionPanel.classList.toggle("show");
      });

      this.voiceToggle.addEventListener("click", ()=>{
        this.state.voiceOn = !this.state.voiceOn;
        this.updateToggles();
        this.saveState();
      });

      this.learningToggle.addEventListener("click", ()=>{
        this.state.learningMode = !this.state.learningMode;
        this.updateToggles();
        this.saveState();
      });

      const openBM = ()=>this.openModal(this.bmModal);
      const openTM = ()=>this.openModal(this.convModal);

      this.bmOpenModal.addEventListener("click", openBM);
      this.bmOpenModal2.addEventListener("click", openBM);
      this.convOpenModal.addEventListener("click", openTM);
      this.convOpenModal2.addEventListener("click", openTM);

      document.querySelectorAll("[data-close]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-close");
          this.closeModal(document.getElementById(id));
        });
      });
      [this.bmModal,this.convModal,this.seedModal].forEach(m=>{
        m.addEventListener("click",(e)=>{
          if(e.target===m) this.closeModal(m);
        });
      });

      this.bmSearch.addEventListener("input", ()=>this.renderBMList());
      this.feedSeedButton.addEventListener("click", ()=>this.openSeedModal());

      this.seedPasswordBtn.addEventListener("click", ()=>this.handleSeedPassword());
      this.seedPasswordInput.addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){ e.preventDefault(); this.handleSeedPassword(); }
      });

      this.seedParseBtn.addEventListener("click", ()=>this.handleSeedParse());
      this.seedSaveBtn.addEventListener("click", ()=>this.handleSeedSave());
      this.seedDiscardBtn.addEventListener("click", ()=>this.handleSeedDiscard());

      this.clear48Btn.addEventListener("click", ()=>{
        this.state.tmHistory = [];
        this.state.currentEpisode.msgIds = [];
        this.saveState();
        this.renderAll();
        this.toastReaction("TM ØµØ§Ù Ú©Ø± Ø¯ÛŒØ§ Ú¯ÛŒØ§ (48h)", "TM clear", "neutral", 0.2);
      });

      this.clearAllBtn.addEventListener("click", ()=>{
        localStorage.removeItem(STORAGE_KEY);
        this.state = this.defaultState();
        this.saveState();
        this.drawBM();
        this.renderAll();
        this.toastReaction("Ø³Ø¨ Ú©Ú†Ú¾ Ø±ÛŒ Ø³ÛŒÙ¹", "RESET", "neutral", 0.2);
      });

      // New options
      this.episodeToggle.addEventListener("click", ()=>{
        this.state.episodeMode = !this.state.episodeMode;
        this.updateEpisodeUI();
        this.saveState();
      });

      this.finalizeEpisodeBtn.addEventListener("click", ()=>{
        this.finalizeEpisode("manual");
      });

      this.digestNowBtn.addEventListener("click", ()=>{
        this.makeDailyDigest("manual");
      });

      this.saveLocationBtn.addEventListener("click", ()=>{
        this.state.locationLabel = (this.locationInput.value||"").trim();
        this.saveState();
        this.toastReaction("Ù„ÙˆÚ©ÛŒØ´Ù† Ù…Ø­ÙÙˆØ¸", this.state.locationLabel || "(empty)", "neutral", 0.2);
      });

      this.clearLocationBtn.addEventListener("click", ()=>{
        this.state.locationLabel = "";
        this.locationInput.value = "";
        this.saveState();
        this.toastReaction("Ù„ÙˆÚ©ÛŒØ´Ù† Ú©Ù„Ø¦ÛŒØ±", "Location cleared", "neutral", 0.2);
      });

      this.saveStrictBtn.addEventListener("click", ()=>{
        this.state.bmStrictness = this.bmStrictness.value;
        this.saveState();
        this.toastReaction("BM Ø±ÙˆÙ„ Ù…Ø­ÙÙˆØ¸", "Strictness: "+this.state.bmStrictness, "neutral", 0.2);
      });
    }

    openModal(m){
      m.classList.add("show");
      if(m===this.bmModal) this.renderBMList();
      if(m===this.convModal) this.renderTMList();
    }
    closeModal(m){ m.classList.remove("show"); }

    updateToggles(){
      this.voiceToggle.classList.toggle("on", !!this.state.voiceOn);
      this.voiceToggle.textContent = this.state.voiceOn ? "ğŸ”Š Voice: ON" : "ğŸ”‡ Voice: OFF";

      this.learningToggle.classList.toggle("on", !!this.state.learningMode);
      this.learningToggle.textContent = this.state.learningMode ? "ğŸ“š Learning: ON" : "ğŸ“š Learning: OFF";
    }

    updateEpisodeUI(){
      this.episodeToggle.textContent = this.state.episodeMode ? "Episode Mode: ON" : "Episode Mode: OFF";
      this.episodeToggle.classList.toggle("btn-ok", !!this.state.episodeMode);
      this.episodeToggle.classList.toggle("btn-danger", !this.state.episodeMode);
      this.locationInput.value = this.state.locationLabel || "";
      this.bmStrictness.value = this.state.bmStrictness || "strict";
    }

    initChatIfEmpty(){
      if(this.state.tmHistory.length===0){
        const text =
          "Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯Û” Ù…ÛŒÚº AURA-X Î© ÛÙˆÚº (Fully Offline).\n"+
          "TM = Ø¹Ø§Ø±Ø¶ÛŒ Ú¯ÙØªÚ¯Ùˆ (48h decay)\n"+
          "BM = ØµØ±Ù Ù…Ø¹Ù†ÛŒ Ø®ÛŒØ² Ø§ÛŒÙ¾ÛŒ Ø³ÙˆÚˆ/Ø§ÛŒÙˆÙ†Ù¹Ø³ (Episode + Daily Digest)\n\n"+
          "Ø¢Ù¾ Ø¬Ø¨ Ø¨Ø§Øª Ú©Ø±ÛŒÚº Ú¯Û’ ØªÙˆ Ù…ÛŒÚº sentiment/polarity Ù†Ú©Ø§Ù„ÙˆÚº Ú¯Ø§ØŒ Ù¾Ú¾Ø± Ø§Ú¯Ø± Ú¯ÙØªÚ¯Ùˆ Ù…Ø¹Ù†ÛŒ Ø®ÛŒØ² ÛÙˆØ¦ÛŒ ØªÙˆ Ø§Ø³Û’ BM Ù…ÛŒÚº â€˜Episodeâ€™ Ø¨Ù†Ø§ Ú©Ø± Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÙˆÚº Ú¯Ø§ (Ù¹Ø§Ø¦Ù… Ø§Ø³Ù¹ÛŒÙ…Ù¾ + optional Ù„ÙˆÚ©ÛŒØ´Ù†).\n"+
          "Feed-the-Seed Ù…ÛŒÚº Ø¢Ù¾ LaTeX Qâ†’A Ú©Û’ Ø³Ø§ØªÚ¾ polarity/intensity Ø¨Ú¾ÛŒ Ø¯Û’ Ø³Ú©ØªÛ’ ÛÛŒÚºÛ”";
        const sent = analyzeSentiment(text);
        this.addMessage("ai", text, sent);
        this.pushTM("ai", text, sent);
        this.saveState();
      }
    }

    startTickers(){
      // Every 30s: prune TM + day rollover check + maybe auto finalize episode boundaries
      setInterval(()=>{
        this.ensureDayRollover();
        this.pruneTM();
        this.autoEpisodeCheck();
        this.drawBM();
        this.updateMetricsFromState();
        this.saveState();
      }, 30000);
    }

    pruneTM(){
      const cutoff = Date.now() - TM_MAX_HOURS*60*60*1000;
      const before = this.state.tmHistory.length;
      this.state.tmHistory = this.state.tmHistory.filter(m => new Date(m.ts).getTime() >= cutoff);
      const after = this.state.tmHistory.length;
      if(after !== before){
        // also prune currentEpisode msgIds that no longer exist
        const idSet = new Set(this.state.tmHistory.map(x=>x.id));
        this.state.currentEpisode.msgIds = this.state.currentEpisode.msgIds.filter(id => idSet.has(id));
      }
    }

    ensureDayRollover(){
      const today = dayKey(now());
      if(this.state.lastDigestDay !== today){
        // New day => auto make digest for previous day
        this.makeDailyDigest("auto");
        this.state.lastDigestDay = today;
        // new episode start
        this.state.currentEpisode = {
          id: makeId("ep"),
          startedAt: iso(now()),
          lastTouchedAt: iso(now()),
          msgIds: []
        };
        this.saveState();
      }
    }

    autoEpisodeCheck(){
      if(!this.state.episodeMode) return;

      // If lastTouched > 20 minutes ago and there is meaningful content, finalize
      const lastTouched = new Date(this.state.currentEpisode.lastTouchedAt).getTime();
      const gapMin = (Date.now() - lastTouched) / 60000;
      if(gapMin >= 20){
        this.finalizeEpisode("idle-gap");
      }
    }

    pushTM(role,text,sentiment){
      const entry = { id: makeId("tm"), role, text, ts: iso(now()), sentiment: sentiment||null };
      this.state.tmHistory.push(entry);

      // Track in current episode (only user+ai actual conversation)
      if(this.state.episodeMode){
        this.state.currentEpisode.msgIds.push(entry.id);
        this.state.currentEpisode.lastTouchedAt = iso(now());
      }
      return entry;
    }

    addMessage(role,text,sent){
      const wrap = document.createElement("div");
      wrap.className = "msg "+(role==="user"?"user":"ai");
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;

      const meta = document.createElement("div");
      meta.className = "meta";
      const pol = sent?.polarity ? sent.polarity : "â€”";
      const inten = sent?.intensity!=null ? sent.intensity.toFixed(2) : "â€”";
      meta.textContent = `â± ${fmt(now())}  â€¢  polarity: ${pol}  â€¢  intensity: ${inten}`;

      bubble.appendChild(meta);
      wrap.appendChild(bubble);
      this.chatContainer.appendChild(wrap);
      this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
    }

    speakIfOn(text, polarity){
      if(!this.state.voiceOn) return;
      if(!("speechSynthesis" in window)) return;
      try{
        const u = new SpeechSynthesisUtterance(text);
        // simple mood:
        if(polarity==="negative"){ u.rate = 0.95; u.pitch = 0.9; }
        else if(polarity==="positive"){ u.rate = 1.02; u.pitch = 1.1; }
        else { u.rate = 1.0; u.pitch = 1.0; }
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
      }catch(e){}
    }

    handleSend(){
      const text = (this.messageInput.value||"").trim();
      if(!text) return;

      this.messageInput.value="";
      this.messageInput.style.height="auto";

      const sent = analyzeSentiment(text);
      this.addMessage("user", text, sent);
      const tm = this.pushTM("user", text, sent);

      // Update metrics
      this.updateMetrics(sent);

      // Decide AI response (offline heuristic + seed nodes)
      const ai = this.reply(text, sent);
      const aiSent = analyzeSentiment(ai);
      this.addMessage("ai", ai, aiSent);
      this.pushTM("ai", ai, aiSent);

      this.speakIfOn(ai, aiSent.polarity);

      // Episode saving logic (meaningful only)
      this.maybeFinalizeEpisodeByThreshold();

      this.saveState();
    }

    reply(userText, sent){
      // 1) match seed intel nodes
      const match = this.findIntelMatch(userText);
      if(match){
        return match.a;
      }

      // 2) basic continuity-aware reply
      const pol = sent.polarity;
      if(pol==="negative"){
        return "Ù…ÛŒÚº Ø³Ù…Ø¬Ú¾ Ú¯ÛŒØ§Û” ÛÙ… Ø§Ø³Û’ Ù¹Ú¾Ù†ÚˆÛ’ Ø¯Ù…Ø§Øº Ø³Û’ ØªÙˆÚ‘ Ú©Ø± Ø­Ù„ Ú©Ø±ÛŒÚº Ú¯Û’Û” Ù¾ÛÙ„Û’ Ø¢Ù¾ Ø§ÛŒÚ© Ù„Ø§Ø¦Ù† Ù…ÛŒÚº Ø¨ØªØ§Ø¦ÛŒÚº: Ø§ØµÙ„ Ù…Ø³Ø¦Ù„Û Ú©ÛŒØ§ ÛÛ’ØŒ Ø§ÙˆØ± Ø¢Ù¾ Ú©Ø§ Ù…Ø·Ù„ÙˆØ¨Û Ù†ØªÛŒØ¬Û Ú©ÛŒØ§ ÛÛ’ØŸ";
      }
      if(pol==="positive"){
        return "Ø²Ø¨Ø±Ø¯Ø³ØªÛ” Ø§Ø³ÛŒ direction Ù…ÛŒÚº Ú†Ù„ØªÛ’ ÛÛŒÚºÛ” Ø¢Ù¾ Ú†Ø§ÛÛŒÚº ØªÙˆ Ø§Ø³ Ø¨Ø§Øª Ú©Ùˆ Ø§ÛŒÚ© ÙˆØ§Ø¶Ø­ â€˜goal + stepsâ€™ Ù…ÛŒÚº ØªØ¨Ø¯ÛŒÙ„ Ú©Ø± Ø¯ÛŒÚºâ€”Ù…ÛŒÚº BM Ù…ÛŒÚº Ø§Ø³Û’ Ø§ÛŒÙˆÙ†Ù¹ Ú©Û’ Ø·ÙˆØ± Ù¾Ø± Ù…Ø­ÙÙˆØ¸ Ú©Ø±Ù†Û’ Ú©ÛŒ Ú©ÙˆØ´Ø´ Ú©Ø±ÙˆÚº Ú¯Ø§Û”";
      }
      // neutral
      // if user asks about BM/TM rules
      if(/bm|tm|episode|digest|summar/i.test(userText)){
        return "Ø±ÙˆÙ„ ÛŒÛ ÛÛ’: TM Ù¾ÙˆØ±ÛŒ Ú¯ÙØªÚ¯Ùˆ Ø±Ú©Ú¾ØªØ§ ÛÛ’ Ù…Ú¯Ø± 48h Ù…ÛŒÚº decayÛ” BM ØµØ±Ù meaningful â€˜Episode/Eventâ€™ Ø±Ú©Ú¾ØªØ§ ÛÛ’ (Ù¹Ø§Ø¦Ù… Ø§Ø³Ù¹ÛŒÙ…Ù¾ + Ù„ÙˆÚ©ÛŒØ´Ù† + polarity). Ø¢Ù¾ Ú†Ø§ÛÛŒÚº ØªÙˆ â€˜Finalize Episodeâ€™ Ø¯Ø¨Ø§Ú©Ø± Ø§Ø¨Ú¾ÛŒ Ø§ÛŒÙˆÙ†Ù¹ Ù…Ø­ÙÙˆØ¸ Ú©Ø± Ø³Ú©ØªÛ’ ÛÛŒÚºÛ”";
      }

      // learning mode: if question mark, ask clarifying or store pattern
      if(this.state.learningMode && /\?$|ØŸ$/.test(userText)){
        return "Ù…ÛŒÚº Ø§Ø³ Ø³ÙˆØ§Ù„ Ú©Ùˆ Ù†ÙˆÙ¹ Ú©Ø± Ø±ÛØ§ ÛÙˆÚºÛ” Ø§Ú¯Ø± Ø¢Ù¾ Ù…Ø¬Ú¾Û’ ØµØ­ÛŒØ­ Ø¬ÙˆØ§Ø¨/ØªØ¹Ø±ÛŒÙ Ø§ÛŒÚ© ÛŒØ§ Ø¯Ùˆ Ù„Ø§Ø¦Ù† Ù…ÛŒÚº Ø¯Û’ Ø¯ÛŒÚº ØªÙˆ Ù…ÛŒÚº Ø§Ø³Û’ â€˜Learningâ€™ Ú©Û’ ØªØ­Øª ÛŒØ§Ø¯ Ø±Ú©Ú¾ Ù„ÙˆÚº Ú¯Ø§ØŒ ÛŒØ§ Ø¢Ù¾ Feed-the-Seed Ù…ÛŒÚº LaTeX Ø¨Ù„Ø§Ú© Ø¯Û’ Ø¯ÛŒÚºÛ”";
      }

      return "Ù¹Ú¾ÛŒÚ© ÛÛ’Û” Ù…Ø²ÛŒØ¯ ØªÙØµÛŒÙ„ Ø¯ÛŒÚº ØªØ§Ú©Û Ù…ÛŒÚº Ø§Ø³Û’ meaningful episode Ù…ÛŒÚº compress Ú©Ø± Ø³Ú©ÙˆÚº (Ú©ÙˆÙ†ØŒ Ú©ÛŒØ§ØŒ Ú©ÛŒÙˆÚºØŒ Ù†ØªÛŒØ¬Û).";
    }

    findIntelMatch(text){
      const t = normalizeForSearch(text);
      let best=null, bestScore=0;
      for(const n of this.state.intelNodes){
        const q = normalizeForSearch(n.q);
        if(!q) continue;
        const score = this.similarity(t,q);
        if(score>bestScore){
          bestScore=score;
          best=n;
        }
      }
      return bestScore>=0.72 ? best : null;
    }

    similarity(a,b){
      // quick token overlap
      const A = new Set(a.split(" ").filter(Boolean));
      const B = new Set(b.split(" ").filter(Boolean));
      if(A.size===0 || B.size===0) return 0;
      let inter=0;
      for(const x of A){ if(B.has(x)) inter++; }
      return inter / Math.max(A.size,B.size);
    }

    updateMetrics(sent){
      // TM activation: last 8 user messages intensity average
      const recentUser = this.state.tmHistory.filter(m=>m.role==="user").slice(-8);
      const tmAct = recentUser.reduce((s,m)=>s + (m.sentiment?.intensity||0),0) / Math.max(1,recentUser.length);

      // BM resonance: compare current sent valence with recent BM valence
      const bmRecent = this.state.bmEntries.slice(-10);
      const bmRes = bmRecent.length ? bmRecent.reduce((s,e)=> s + (e.valence||0),0)/bmRecent.length : 0;

      // e0: tanh-ish
      const e0raw = (tmAct * (0.5 + Math.abs(bmRes))) - 0.15 + (sent?.valence||0)*0.25;
      const e0 = Math.tanh(e0raw);

      // continuity index: closeness to lastE0
      const delta = Math.abs(e0 - this.state.lastE0);
      const ci = clamp(1 - delta, 0, 1);

      this.state.lastE0 = this.state.e0;
      this.state.e0 = e0;
      this.state.continuityIndex = (this.state.continuityIndex*0.7) + (ci*0.3);

      this.updateMetricsFromState(sent, tmAct, bmRes);
    }

    updateMetricsFromState(sentOverride, tmActOverride, bmResOverride){
      const e0 = this.state.e0 || 0;
      const ci = this.state.continuityIndex || 0.8;

      const tmAct = (tmActOverride!=null) ? tmActOverride : this.estimateTMActivation();
      const bmRes = (bmResOverride!=null) ? bmResOverride : this.estimateBMResonance();

      this.metricE0.textContent = e0.toFixed(2);
      this.metricTM.textContent = tmAct.toFixed(2);
      this.metricBM.textContent = bmRes.toFixed(2);
      this.metricCI.textContent = ci.toFixed(2);

      const sent = sentOverride || analyzeSentiment(this.state.tmHistory.slice(-1)[0]?.text||"");
      const valenceTag = sent.polarity;
      const arousalTag = sent.arousal;
      let reaction = "balanced";
      if(sent.polarity==="negative" && sent.intensity>0.6) reaction="protective";
      if(sent.polarity==="positive" && sent.intensity>0.6) reaction="uplifting";

      this.tagValence.textContent = "VALENCE: "+valenceTag;
      this.tagArousal.textContent = "AROUSAL: "+arousalTag;
      this.tagReaction.textContent = "REACTION: "+reaction;

      // Show bubble sometimes
      this.toastReaction(
        `polarity: ${sent.polarity}\nintensity: ${sent.intensity.toFixed(2)}\ncategory: ${sent.category}`,
        reaction.toUpperCase(),
        sent.polarity,
        sent.intensity
      );
    }

    estimateTMActivation(){
      const recentUser = this.state.tmHistory.filter(m=>m.role==="user").slice(-8);
      return recentUser.reduce((s,m)=>s + (m.sentiment?.intensity||0),0) / Math.max(1,recentUser.length);
    }

    estimateBMResonance(){
      const bmRecent = this.state.bmEntries.slice(-10);
      if(!bmRecent.length) return 0;
      return bmRecent.reduce((s,e)=> s + (e.valence||0),0)/bmRecent.length;
    }

    toastReaction(text,label,polarity,intensity){
      // mimic â€œmood bubbleâ€
      this.reactionLabel.textContent = label;
      this.reactionText.textContent = text;
      this.reactionMeta.textContent = "â± "+fmt(now())+"  â€¢  "+(this.state.locationLabel ? ("ğŸ“ "+this.state.locationLabel) : "ğŸ“ (no location)");
      this.reactionBubble.classList.add("show");
      clearTimeout(this._rt);
      this._rt = setTimeout(()=>this.reactionBubble.classList.remove("show"), 2400);
    }

    /* ----------------- BM Episode Logic ----------------- */
    bmThresholds(){
      const strict = this.state.bmStrictness || "strict";
      if(strict==="strict"){
        return { minUserMsgs: 4, minChars: 160 };
      }
      if(strict==="normal"){
        return { minUserMsgs: 3, minChars: 120 };
      }
      return { minUserMsgs: 2, minChars: 80 };
    }

    episodeWindowMessages(){
      const ids = new Set(this.state.currentEpisode.msgIds || []);
      const msgs = this.state.tmHistory.filter(m=>ids.has(m.id));
      return msgs;
    }

    isMeaningfulEpisode(msgs){
      const t = this.bmThresholds();
      const userMsgs = msgs.filter(m=>m.role==="user");
      if(userMsgs.length < t.minUserMsgs) return false;

      const content = userMsgs.map(m=>m.text).join(" ");
      if(content.length < t.minChars) return false;

      // Avoid greetings-only
      const tinyOrGreet = userMsgs.every(m=>isGreetingOrTiny(m.text));
      if(tinyOrGreet) return false;

      return true;
    }

    summarizeEpisode(msgs){
      // Simple compress: pick top 5 user lines + infer â€œtopicâ€ keywords
      const userMsgs = msgs.filter(m=>m.role==="user");
      const aiMsgs = msgs.filter(m=>m.role==="ai");

      const contentAll = userMsgs.map(m=>m.text).join(" ");
      const pol = this.aggregatePolarity(msgs);
      const intensity = this.aggregateIntensity(msgs);
      const valence = this.aggregateValence(msgs);

      const key = this.extractKeywords(contentAll).slice(0,6);
      const title = key.length ? ("Episode: "+key.join(", ")) : "Episode: meaningful conversation";

      const lines = userMsgs.slice(-6).map((m,i)=>`â€¢ ${m.text}`).join("\n");
      const aiHint = aiMsgs.length ? ("\n\nAI stance: "+aiMsgs[aiMsgs.length-1].text.slice(0,140)+"â€¦") : "";

      const summary =
        `Summary (compressed):\n${lines}\n\nSignals: polarity=${pol}, intensity=${intensity.toFixed(2)}, valence=${valence.toFixed(2)}\n`+
        (this.state.locationLabel ? `Location: ${this.state.locationLabel}\n` : "")+
        (key.length ? `Keywords: ${key.join(", ")}\n` : "")+
        aiHint;

      return { title, summary, polarity: pol, intensity, valence, tags: key };
    }

    aggregatePolarity(msgs){
      let score=0;
      for(const m of msgs){
        const s = m.sentiment;
        if(!s) continue;
        if(s.polarity==="positive") score++;
        if(s.polarity==="negative") score--;
      }
      return score>0 ? "positive" : (score<0 ? "negative" : "neutral");
    }
    aggregateIntensity(msgs){
      const arr = msgs.map(m=>m.sentiment?.intensity).filter(x=>typeof x==="number");
      if(!arr.length) return 0.2;
      return clamp(arr.reduce((a,b)=>a+b,0)/arr.length,0,1);
    }
    aggregateValence(msgs){
      const arr = msgs.map(m=>m.sentiment?.valence).filter(x=>typeof x==="number");
      if(!arr.length) return 0;
      return clamp(arr.reduce((a,b)=>a+b,0)/arr.length,-1,1);
    }

    extractKeywords(text){
      const raw = (text||"").toLowerCase().replace(/[^\p{L}\p{N}\s]/gu," ");
      const stop = new Set(["the","and","or","but","a","an","to","of","in","on","for","is","are","i","you","we","it","this","that","Ù…ÛŒÚº","ÛÙ…","Ø¢Ù¾","Ø§ÙˆØ±","ÛŒØ§","Ú©ÛŒ","Ú©Û’","Ú©Ùˆ","ÛÛ’","ÛÛŒÚº","Ù…ÛŒÚº","Ø³Û’","Ù¾Ø±","Ø§ÛŒÚ©"]);
      const freq = new Map();
      raw.split(/\s+/).filter(Boolean).forEach(w=>{
        if(w.length<3) return;
        if(stop.has(w)) return;
        freq.set(w,(freq.get(w)||0)+1);
      });
      return [...freq.entries()].sort((a,b)=>b[1]-a[1]).map(x=>x[0]);
    }

    maybeFinalizeEpisodeByThreshold(){
      if(!this.state.episodeMode) return;
      const msgs = this.episodeWindowMessages();
      // If meaningful and user messages exceed threshold, auto finalize
      if(this.isMeaningfulEpisode(msgs)){
        const userCount = msgs.filter(m=>m.role==="user").length;
        // Auto finalize if userCount hits a bigger number (keeps it â€œevent basedâ€)
        if(userCount >= (this.bmThresholds().minUserMsgs + 2)){
          this.finalizeEpisode("auto-threshold");
        }
      }
    }

    finalizeEpisode(reason){
      if(!this.state.episodeMode) return;
      const msgs = this.episodeWindowMessages();
      if(!msgs.length){
        // reset episode
        this.state.currentEpisode = { id: makeId("ep"), startedAt: iso(now()), lastTouchedAt: iso(now()), msgIds: [] };
        this.saveState();
        return;
      }
      if(!this.isMeaningfulEpisode(msgs)){
        // Not meaningful => do not store in BM (keeps â€œreal feelâ€)
        this.toastReaction("ÛŒÛ Ú¯ÙØªÚ¯Ùˆ BM Ù…ÛŒÚº Ù†ÛÛŒÚº Ú¯Ø¦ÛŒ (non-meaningful / greeting / short).", "BM FILTER", "neutral", 0.2);
        // reset episode anyway
        this.state.currentEpisode = { id: makeId("ep"), startedAt: iso(now()), lastTouchedAt: iso(now()), msgIds: [] };
        this.saveState();
        this.drawBM();
        this.renderBMList();
        return;
      }

      const s = this.summarizeEpisode(msgs);
      const entry = {
        id: makeId("bm"),
        type: "episode",
        title: s.title,
        summary: s.summary,
        ts: iso(now()),
        location: this.state.locationLabel || "",
        polarity: s.polarity,
        intensity: s.intensity,
        valence: s.valence,
        tags: s.tags,
        sourceMsgIds: msgs.map(m=>m.id),
        reason
      };
      this.state.bmEntries.push(entry);

      // update bm layers (simple fill based on intensity/valence)
      this.applyToBMLayers(entry);

      this.toastReaction("BM Ù…ÛŒÚº Episode Ù…Ø­ÙÙˆØ¸ ÛÙˆÚ¯ÛŒØ§ âœ…", entry.title, entry.polarity, entry.intensity);

      // reset episode
      this.state.currentEpisode = { id: makeId("ep"), startedAt: iso(now()), lastTouchedAt: iso(now()), msgIds: [] };

      this.saveState();
      this.drawBM();
      this.renderBMList();
    }

    applyToBMLayers(entry){
      const layers = this.state.bmLayers || [];
      const intensity = clamp(entry.intensity || 0.3, 0, 1);
      const val = clamp((entry.valence || 0), -1, 1);

      // choose a band based on polarity
      let base = 0;
      if(entry.polarity==="positive") base = 40;
      else if(entry.polarity==="negative") base = 160;
      else base = 100;

      const span = Math.floor(20 + intensity*60);
      for(let i=0;i<span;i++){
        const idx = clamp(base + i, 0, layers.length-1);
        layers[idx] = clamp(layers[idx] + (0.15 + intensity*0.4) + Math.abs(val)*0.1, 0, 1);
      }

      // gentle decay elsewhere
      for(let i=0;i<layers.length;i++){
        layers[i] = layers[i]*0.995;
      }

      this.state.bmLayers = layers;
    }

    makeDailyDigest(reason){
      // digest from BM episodes of the current day (or yesterday when rollover triggers)
      const today = dayKey(now());
      const targetDay = (reason==="auto") ? this.state.lastDigestDay : today;

      const episodes = this.state.bmEntries.filter(e=>{
        if(e.type!=="episode") return false;
        return dayKey(e.ts)===targetDay;
      });

      if(!episodes.length){
        if(reason!=="auto"){
          this.toastReaction("Ø¢Ø¬ Ú©Û’ Ù„ÛŒÛ’ Ú©ÙˆØ¦ÛŒ episode Ù†ÛÛŒÚºØŒ digest Ù†ÛÛŒÚº Ø¨Ù†Ø§Û”", "DIGEST", "neutral", 0.2);
        }
        return;
      }

      const pol = this.aggregatePolarity(episodes.map(e=>({sentiment:{polarity:e.polarity,intensity:e.intensity,valence:e.valence}})));
      const intensity = clamp(episodes.reduce((s,e)=>s+(e.intensity||0),0)/episodes.length,0,1);
      const valence = clamp(episodes.reduce((s,e)=>s+(e.valence||0),0)/episodes.length,-1,1);

      const keyFreq = new Map();
      episodes.forEach(e=>{
        (e.tags||[]).forEach(t=>{
          keyFreq.set(t,(keyFreq.get(t)||0)+1);
        });
      });
      const topKeys = [...keyFreq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,8).map(x=>x[0]);

      const summaryLines = episodes.slice(-8).map(e=>{
        const loc = e.location ? `ğŸ“${e.location} ` : "";
        return `â€¢ ${loc}${e.title}  (pol=${e.polarity}, int=${(e.intensity||0).toFixed(2)})`;
      }).join("\n");

      const digestText =
        `Daily Digest â€” ${targetDay}\n\n`+
        `Episodes: ${episodes.length}\n`+
        `Overall: polarity=${pol}, intensity=${intensity.toFixed(2)}, valence=${valence.toFixed(2)}\n`+
        (topKeys.length ? `Top keywords: ${topKeys.join(", ")}\n\n` : "\n")+
        `Events:\n${summaryLines}`;

      const entry = {
        id: makeId("bm"),
        type: "daily",
        title: "Daily Digest â€” "+targetDay,
        summary: digestText,
        ts: iso(now()),
        location: this.state.locationLabel || "",
        polarity: pol,
        intensity,
        valence,
        tags: topKeys,
        sourceMsgIds: episodes.map(e=>e.id),
        reason
      };

      this.state.bmEntries.push(entry);
      this.applyToBMLayers(entry);

      this.toastReaction("Daily Digest Ù…Ø­ÙÙˆØ¸ âœ…", entry.title, entry.polarity, entry.intensity);
      this.saveState();
      this.drawBM();
      this.renderBMList();
    }

    /* ----------------- Rendering ----------------- */
    renderAll(){
      this.updateToggles();
      this.updateEpisodeUI();
      this.renderChatFromTM();
      this.renderBMList();
      this.renderTMList();
      this.updateMetricsFromState();
      this.updateCounts();
    }

    renderChatFromTM(){
      // Only show last ~40 messages for UI (TM stays in storage)
      this.chatContainer.innerHTML="";
      const last = this.state.tmHistory.slice(-40);
      for(const m of last){
        const sent = m.sentiment || analyzeSentiment(m.text);
        this.addMessage(m.role==="user"?"user":"ai", m.text, sent);
      }
    }

    renderBMList(){
      const q = normalizeForSearch(this.bmSearch.value||"");
      const entries = [...this.state.bmEntries].reverse().filter(e=>{
        if(!q) return true;
        const blob = normalizeForSearch([e.title,e.summary,e.location,e.polarity,(e.tags||[]).join(" ")].join(" "));
        return blob.includes(q);
      });

      this.bmList.innerHTML="";
      if(!entries.length){
        const d = document.createElement("div");
        d.className="item";
        d.innerHTML = "<div class='item-title'>Ú©ÙˆØ¦ÛŒ BM entry Ù†ÛÛŒÚº Ù…Ù„ÛŒ</div><div class='item-text'>Search Ø¨Ø¯Ù„ÛŒÚº ÛŒØ§ Ù†Ø¦ÛŒ meaningful Ú¯ÙØªÚ¯Ùˆ Ú©Ø±ÛŒÚºÛ”</div>";
        this.bmList.appendChild(d);
        this.updateCounts();
        return;
      }

      for(const e of entries){
        const item = document.createElement("div");
        item.className="item";

        const head = document.createElement("div");
        head.className="item-head";

        const left = document.createElement("div");
        left.innerHTML = `<div class="item-title">${e.type==="daily"?"ğŸ—“ï¸ ":"ğŸ“Œ "}${escapeHtml(e.title)}</div>
                          <div class="item-meta">â± ${fmt(e.ts)} ${e.location?(" â€¢ ğŸ“ "+escapeHtml(e.location)):""} â€¢ polarity: ${e.polarity} â€¢ intensity: ${(e.intensity||0).toFixed(2)}</div>`;

        const right = document.createElement("div");
        right.style.display="flex";
        right.style.gap="6px";
        right.style.flexWrap="wrap";
        const chips = [];
        chips.push(e.type==="daily" ? "DAILY" : "EPISODE");
        chips.push(e.reason || "");
        for(const c of chips.filter(Boolean)){
          const sp = document.createElement("span");
          sp.className="chip";
          sp.textContent=c;
          right.appendChild(sp);
        }

        head.appendChild(left);
        head.appendChild(right);

        const text = document.createElement("div");
        text.className="item-text";
        text.textContent = e.summary;

        item.appendChild(head);
        item.appendChild(text);
        this.bmList.appendChild(item);
      }
      this.updateCounts();
    }

    renderTMList(){
      this.convList.innerHTML="";
      const items = [...this.state.tmHistory].reverse().slice(0,120);
      if(!items.length){
        const d = document.createElement("div");
        d.className="item";
        d.innerHTML = "<div class='item-title'>TM Ø®Ø§Ù„ÛŒ ÛÛ’</div><div class='item-text'>Ú©ÙˆØ¦ÛŒ Ú¯ÙØªÚ¯Ùˆ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚºÛ”</div>";
        this.convList.appendChild(d);
        return;
      }
      for(const m of items){
        const item = document.createElement("div");
        item.className="item";
        const pol = m.sentiment?.polarity || "â€”";
        const inten = (m.sentiment?.intensity!=null) ? m.sentiment.intensity.toFixed(2) : "â€”";
        item.innerHTML = `
          <div class="item-head">
            <div>
              <div class="item-title">${m.role==="user"?"ğŸ™‚ User":"ğŸ¤– AI"}</div>
              <div class="item-meta">â± ${fmt(m.ts)} â€¢ polarity: ${pol} â€¢ intensity: ${inten}</div>
            </div>
          </div>
          <div class="item-text">${escapeHtml(m.text)}</div>
        `;
        this.convList.appendChild(item);
      }
    }

    updateCounts(){
      const eps = this.state.bmEntries.filter(e=>e.type==="episode").length;
      const dig = this.state.bmEntries.filter(e=>e.type==="daily").length;
      this.bmCounts.textContent = `Episodes: ${eps} Â· Digests: ${dig}`;
    }

    drawBM(){
      const canvas = this.bmCanvas;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.max(320, Math.floor(rect.width * devicePixelRatio));
      canvas.height = Math.max(220, Math.floor(rect.height * devicePixelRatio));
      const ctx = canvas.getContext("2d");

      ctx.clearRect(0,0,canvas.width,canvas.height);

      // background
      ctx.fillStyle = "rgba(2,6,23,0.65)";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // layers bars
      const L = this.state.bmLayers || [];
      const n = 240;
      const pad = 16 * devicePixelRatio;
      const w = canvas.width - pad*2;
      const h = canvas.height - pad*2;
      const barW = w / n;

      for(let i=0;i<n;i++){
        const v = clamp(L[i] || 0, 0, 1);
        const x = pad + i*barW;
        const bh = v * h;
        // color based on region (positive/neutral/negative band)
        let r=148,g=163,b=184; // slate
        if(i<80){ r=34; g=197; b=94; }        // green-ish
        else if(i<160){ r=250; g=204; b=21; } // yellow-ish
        else { r=239; g=68; b=68; }           // red-ish

        ctx.fillStyle = `rgba(${r},${g},${b},${0.15 + v*0.75})`;
        ctx.fillRect(x, pad + (h-bh), Math.max(1, barW-1), bh);
      }

      // overlay label
      ctx.fillStyle="rgba(255,255,255,0.9)";
      ctx.font = `${12*devicePixelRatio}px system-ui, sans-serif`;
      ctx.fillText("BM 240-layer spectrum (green=positive, yellow=neutral, red=negative)", pad, canvas.height - 10*devicePixelRatio);

      // stats
      const active = L.filter(v=>(v||0)>0.08).length;
      const eps = this.state.bmEntries.filter(e=>e.type==="episode").length;
      const dig = this.state.bmEntries.filter(e=>e.type==="daily").length;
      this.bmStats.innerHTML = `<span>Active layers: ${active}/240</span><span>Episodes: ${eps} Â· Digests: ${dig}</span>`;
    }

    /* ----------------- Seed Logic ----------------- */
    openSeedModal(){
      this.seedPasswordInput.value="";
      this.seedBlockInput.value="";
      this.seedPasswordError.style.display="none";
      this.seedPasswordStage.style.display="block";
      this.seedBlockStage.style.display="none";
      this.seedSaveBtn.disabled=true;
      this.openModal(this.seedModal);
    }

    handleSeedPassword(){
      const v = (this.seedPasswordInput.value||"").trim();
      if(v !== SEED_PASSWORD){
        this.seedPasswordError.style.display="block";
        return;
      }
      this.seedPasswordError.style.display="none";
      this.seedPasswordStage.style.display="none";
      this.seedBlockStage.style.display="block";
      this.seedBlockPreview.textContent = "Unlocked. Paste LaTeX block and press Parse.";
    }

    handleSeedParse(){
      const raw = (this.seedBlockInput.value||"").trim();
      if(!raw){
        this.seedBlockPreview.textContent="Empty block.";
        this.seedSaveBtn.disabled=true;
        return;
      }
      const parsed = this.parseLatexQA(raw);
      if(!parsed.length){
        this.seedBlockPreview.textContent="No Qâ†’A pairs found. Ensure \\item ... \\textbf{A:} ...";
        this.seedSaveBtn.disabled=true;
        return;
      }
      this._seedParsed = parsed;
      this.seedBlockPreview.textContent = `Parsed ${parsed.length} Qâ†’A pairs. Ready to save.`;
      this.seedSaveBtn.disabled=false;
    }

    handleSeedSave(){
      const arr = this._seedParsed || [];
      if(!arr.length) return;
      for(const qa of arr){
        this.state.intelNodes.push({
          id: makeId("intel"),
          q: qa.q,
          a: qa.a,
          meta: qa.meta
        });
      }
      this.saveState();
      this.seedSaveBtn.disabled=true;
      this.seedBlockPreview.textContent = `Saved âœ… (${arr.length} nodes)`;
      this.toastReaction("Seed Ù…Ø­ÙÙˆØ¸ âœ…", `${arr.length} nodes added`, "positive", 0.35);
    }

    handleSeedDiscard(){
      this._seedParsed = [];
      this.seedBlockInput.value="";
      this.seedSaveBtn.disabled=true;
      this.seedBlockPreview.textContent="Discarded.";
    }

    parseLatexQA(raw){
      // Supports:
      // \item Question ... \textbf{A:} Answer ... [polarity=...,category=...,intensity=0.7]
      // Also allow \textbf{Polarity:} positive lines inside block (applies to next pairs until changed).
      const lines = raw.split(/\r?\n/);
      let globalMeta = { polarity:null, category:null, intensity:null };
      const out = [];

      const metaFromInline = (s)=>{
        const m = {};
        const bracket = s.match(/\[(.+?)\]/);
        if(bracket){
          const parts = bracket[1].split(",").map(x=>x.trim());
          for(const p of parts){
            const [k,v] = p.split("=").map(x=>x.trim());
            if(!k || v==null) continue;
            const key = k.toLowerCase();
            if(key==="polarity") m.polarity = v.toLowerCase();
            if(key==="category") m.category = v.toLowerCase();
            if(key==="intensity") m.intensity = clamp(parseFloat(v),0,1);
          }
        }
        return m;
      };

      // Collect items by scanning \item
      const joined = lines.join("\n");

      // Update global meta if found
      const polLine = joined.match(/\\textbf\{Polarity:\}\s*([a-zA-Z]+)/i);
      if(polLine) globalMeta.polarity = polLine[1].toLowerCase();

      const catLine = joined.match(/\\textbf\{Category:\}\s*([a-zA-Z]+)/i);
      if(catLine) globalMeta.category = catLine[1].toLowerCase();

      const intLine = joined.match(/\\textbf\{Intensity:\}\s*([0-9.]+)/i);
      if(intLine) globalMeta.intensity = clamp(parseFloat(intLine[1]),0,1);

      // Find each \item block
      const itemRegex = /\\item\s+([\s\S]*?)(?=(\\item\s+)|$)/g;
      let m;
      while((m = itemRegex.exec(joined))){
        const block = m[1].trim();
        const aSplit = block.split(/\\textbf\{A:\}/i);
        if(aSplit.length<2) continue;
        const qRaw = aSplit[0].replace(/\s+/g," ").trim();
        let aRaw = aSplit.slice(1).join("\\textbf{A:}").trim();

        const inlineMeta = metaFromInline(aRaw) || {};
        // remove inline bracket metadata from answer
        aRaw = aRaw.replace(/\[.+?\]/g,"").trim();

        const meta = {
          polarity: inlineMeta.polarity || globalMeta.polarity || null,
          category: inlineMeta.category || globalMeta.category || null,
          intensity: (inlineMeta.intensity!=null) ? inlineMeta.intensity : (globalMeta.intensity!=null ? globalMeta.intensity : null)
        };

        out.push({ q: qRaw, a: aRaw, meta });
      }
      return out;
    }
  }

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g,(c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // Start
  const engine = new Engine();
})();
</script>
</body>
</html>