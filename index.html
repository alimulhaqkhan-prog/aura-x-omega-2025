<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© v1 ‚Äì Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }
    .app {
      width: 100%;
      max-width: 480px;
      height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .title-block h1 {
      font-size: 1.4rem;
      letter-spacing: 0.08em;
    }
    .title-block p {
      font-size: 0.7rem;
      opacity: 0.8;
      line-height: 1.2;
    }
    .mode-pill {
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid #38bdf8;
      font-size: 0.63rem;
      text-align: right;
      background: #020617;
    }
    .mode-pill span { display: block; }
    .mode-pill .mode-label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.9;
    }
    .mode-pill .mode-sub {
      color: #22c55e;
      font-weight: 500;
    }
    .mode-pill .engine { opacity: 0.6; }

    .top-buttons {
      display: flex;
      flex-wrap: nowrap;
      gap: 6px;
      margin-top: 4px;
    }
    .pill-btn {
      flex: 1;
      border-radius: 999px;
      padding: 8px 6px;
      border: 1px solid #4b5563;
      background: rgba(15,23,42,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s, border-color 0.2s;
      min-width: 0;
      white-space: nowrap;
    }
    .pill-btn span.icon { font-size: 0.95rem; }
    .pill-btn.primary {
      border-color: #f59e0b;
      background: rgba(24, 18, 6, 0.9);
    }
    .pill-btn:hover {
      transform: translateY(-1px);
      border-color: #facc15;
    }

    .card {
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px solid rgba(148,163,184,0.4);
      background: radial-gradient(circle at top left, #1f2937 0, #020617 55%, #020617 100%);
      font-size: 0.8rem;
      line-height: 1.4;
    }
    .card.golden {
      background: radial-gradient(circle at top left, #713f12 0, #1f2937 55%, #020617 100%);
      border-color: #fbbf24;
      color: #fde68a;
      font-weight: 500;
    }
    .card.equation {
      border-style: dashed;
      background: radial-gradient(circle at top left, #0f172a 0, #020617 60%, #000 100%);
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.75rem;
    }
    .card.equation .label {
      opacity: 0.9;
      margin-bottom: 4px;
      font-weight: 600;
      letter-spacing: 0.06em;
    }

    .chat-area {
      flex: 1;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 140px;
    }

    .reaction-banner {
      display: none;
      border-radius: 12px;
      padding: 6px 8px;
      font-size: 0.75rem;
      line-height: 1.3;
      border: 1px solid rgba(148,163,184,0.5);
      background: radial-gradient(circle at top left, #020617 0, #020617 50%, #000 100%);
    }
    .reaction-banner strong {
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 0.7rem;
    }
    .reaction-positive {
      border-color: #22c55e;
      color: #bbf7d0;
    }
    .reaction-negative {
      border-color: #ef4444;
      color: #fecaca;
    }
    .reaction-neutral {
      border-color: #eab308;
      color: #fef9c3;
    }

    .chat-log {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 0.8rem;
    }
    .msg { margin-bottom: 8px; }
    .msg-user { text-align: right; color: #bfdbfe; }
    .msg-bot { text-align: left; color: #e5e7eb; }

    .status-line {
      font-size: 0.7rem;
      opacity: 0.7;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }
    .input-row textarea {
      flex: 1;
      resize: none;
      min-height: 40px;
      max-height: 80px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      padding: 8px 12px;
      font-size: 0.8rem;
    }
    .input-row textarea:focus {
      outline: none;
      border-color: #22c55e;
    }

    .send-btn {
      border-radius: 999px;
      padding: 10px 16px;
      border: none;
      background: #16a34a;
      color: white;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 0 0 1px rgba(22,163,74,0.6), 0 10px 18px rgba(22,163,74,0.4);
      transition: transform 0.1s, box-shadow 0.1s, background 0.1s;
    }
    .send-btn:active {
      transform: translateY(1px);
      box-shadow: 0 6px 12px rgba(22,163,74,0.5);
      background: #15803d;
    }

    .footer-line {
      font-size: 0.7rem;
      opacity: 0.65;
      margin-top: 2px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .voice-toggle {
      border-radius: 999px;
      padding: 3px 10px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.7rem;
      cursor: pointer;
    }
    .voice-toggle.active {
      border-color: #22c55e;
      color: #bbf7d0;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }
    .modal {
      width: 100%;
      max-width: 480px;
      max-height: 80vh;
      background: #020617;
      border-radius: 20px;
      border: 1px solid #4b5563;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .modal-title {
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .modal-close {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.75rem;
      cursor: pointer;
      background: #111827;
      color: #e5e7eb;
    }
    .modal-body {
      flex: 1;
      overflow-y: auto;
      font-size: 0.78rem;
    }

    .bm-day {
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(55,65,81,0.7);
      padding-bottom: 6px;
    }
    .bm-day-title {
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 0.8rem;
      color: #e5e7eb;
    }
    .bm-node {
      margin-bottom: 8px;
      padding: 6px 8px;
      border-radius: 12px;
      background: #020617;
      border: 1px solid #374151;
    }
    .bm-node-title {
      font-weight: 500;
      margin-bottom: 2px;
    }
    .bm-node-meta {
      font-size: 0.7rem;
      opacity: 0.8;
      margin-bottom: 4px;
    }
    .polarity-line {
      font-size: 0.72rem;
      margin-bottom: 4px;
    }
    .polarity-line .label {
      opacity: 0.8;
      margin-right: 4px;
    }
    .polarity-line .pos {
      color: #22c55e;
      font-weight: 600;
    }
    .polarity-line .neg {
      color: #f97316;
      font-weight: 600;
    }
    .layer-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 4px;
    }
    .layer-chip {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 0.65rem;
      color: #020617;
      font-weight: 600;
    }
    .L1 { background: #60a5fa; }
    .L2 { background: #fb7185; }
    .L3 { background: #f97316; }
    .L4 { background: #a855f7; }
    .L5 { background: #22c55e; }
    .L6 { background: #eab308; }
    .L7 { background: #e5e7eb; }
    .delete-day-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.7rem;
      cursor: pointer;
      background: #7f1d1d;
      color: #fee2e2;
      margin-left: auto;
      display: block;
      margin-top: 4px;
    }

    .recall-search { margin-bottom: 6px; }
    .recall-search input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      padding: 6px 10px;
      font-size: 0.78rem;
    }
    .recall-node {
      border-radius: 12px;
      border: 1px solid #374151;
      padding: 6px 8px;
      margin-bottom: 6px;
      background: #020617;
    }
    .copy-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.7rem;
      cursor: pointer;
      background: #1d4ed8;
      color: #e5e7eb;
      margin-top: 4px;
    }

    .option-section-title {
      font-weight: 600;
      font-size: 0.8rem;
      margin: 6px 0 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.9;
    }
    .faith-note {
      font-size: 0.74rem;
      opacity: 0.8;
      margin-bottom: 6px;
    }
    .faith-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }
    .faith-pill {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      padding: 5px 10px;
      font-size: 0.73rem;
      cursor: pointer;
    }
    .faith-pill.active {
      background: #0f172a;
      border-color: #22c55e;
      color: #bbf7d0;
      font-weight: 500;
    }
    .option-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }
    .option-row span { font-size: 0.78rem; }
    .toggle {
      position: relative;
      width: 38px;
      height: 20px;
    }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #374151;
      transition: .2s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .2s;
      border-radius: 50%;
    }
    input:checked + .slider { background-color: #22c55e; }
    input:checked + .slider:before { transform: translateX(18px); }

    #llmModelSelect {
      background: #020617;
      color: #e5e7eb;
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 4px 8px;
      font-size: 0.75rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header-top">
      <div class="title-block">
        <h1>AURA-X Œ©</h1>
        <p>EMOTIONAL CONTINUITY ¬∑ AEC ¬∑ CRM ¬∑ AECN ¬∑ RL¬≥ ¬∑ LR¬≥</p>
      </div>
      <div class="mode-pill" id="modePill">
        <span class="mode-label">MODE: OFFLINE PROTOTYPE</span>
        <span class="mode-sub">Universal Ethics ¬∑ Local BM</span>
        <span class="engine">Engine: Seed (local)</span>
      </div>
    </div>

    <div class="top-buttons">
      <button class="pill-btn" id="bmViewerBtn">
        <span class="icon">üß†</span><span>BM Viewer</span>
      </button>
      <button class="pill-btn primary" id="recallBtn">
        <span class="icon">üìÇ</span><span>Recall BM</span>
      </button>
      <button class="pill-btn" id="cleanupBtn">
        <span class="icon">‚ôªÔ∏è</span><span>Cleanup 24h</span>
      </button>
      <button class="pill-btn" id="optionsBtn">
        <span class="icon">üîò</span><span>Options</span>
      </button>
    </div>

    <div class="card golden" id="ethicsBanner">
      Avoid actions that generate negative emotions in yourself or others.
      Gently move toward choices that create calm, kindness, and positive feelings.
    </div>

    <div class="card equation" id="equationCard">
      <div class="label">EMOTIONAL CONTINUITY EQUATION</div>
      <div class="formula-main" id="eqMain">
        E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)
      </div>
      <div class="formula-values" id="eqValues">
        E‚ÇÄ = 0.00 ¬∑ TM = 0.35 ¬∑ BM = 0.55 ¬∑ D = 0.00 ¬∑ Œ£C‚Çú = 0.05 ¬∑ Œª_faith = 0.00 ¬∑ Œª_sys = 0.02
      </div>
    </div>

    <div class="chat-area">
      <div id="reactionBanner" class="reaction-banner"></div>
      <div class="chat-log" id="chatLog"></div>
      <div class="status-line" id="statusLine">
        E‚ÇÄ=0.00 ¬∑ TM=0.35 ¬∑ D=0.00 ¬∑ tag=neutral
      </div>
      <div class="input-row">
        <textarea id="userInput"
          placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."></textarea>
        <button class="send-btn" id="sendBtn">Send</button>
      </div>
      <div class="footer-line">
        <span>Prototype ¬∑ TM ‚Üí Engine ‚Üí BM ¬∑ Equation live.</span>
        <span id="engineFooterLabel">Engine: Seed (local)</span>
        <button id="voiceToggle" class="voice-toggle active">üîä Voice: On</button>
      </div>
    </div>
  </div>

  <!-- BM Viewer Modal -->
  <div class="modal-backdrop" id="bmModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>üß†</span> Bold Memory (BM)</div>
        <button class="modal-close" data-close="bmModalBackdrop">Close</button>
      </div>
      <div class="modal-body" id="bmModalBody"></div>
    </div>
  </div>

  <!-- Recall Modal -->
  <div class="modal-backdrop" id="recallModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>üìÇ</span> Recall from BM</div>
        <button class="modal-close" data-close="recallModalBackdrop">Close</button>
      </div>
      <div class="modal-body">
        <div class="recall-search">
          <input id="recallSearchInput"
            placeholder='Search all BM layers by keyword (e.g., "snow", "mother", "court", "hope").' />
        </div>
        <div id="recallList"></div>
      </div>
    </div>
  </div>

  <!-- Options Modal -->
  <div class="modal-backdrop" id="optionsModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span>üîò</span> AURA-X Œ© options</div>
        <button class="modal-close" data-close="optionsModalBackdrop">Close</button>
      </div>
      <div class="modal-body">
        <div class="option-section-title">FAITH LENS (OPTIONAL)</div>
        <div class="faith-note">
          Universal ethics are always active. You can optionally pick a faith lens to shape
          encouragement lines locally. Nothing is sent to any external server.
        </div>
        <div class="faith-row" id="faithRow">
          <button class="faith-pill" data-faith="None">None</button>
          <button class="faith-pill" data-faith="Islam">Islam</button>
          <button class="faith-pill" data-faith="Christianity">Christianity</button>
          <button class="faith-pill" data-faith="Hinduism">Hinduism</button>
          <button class="faith-pill" data-faith="Buddhism">Buddhism</button>
          <button class="faith-pill" data-faith="Sikhism">Sikhism</button>
          <button class="faith-pill" data-faith="Judaism">Judaism</button>
          <button class="faith-pill" data-faith="Atheism / Humanism">Atheism / Humanism</button>
          <button class="faith-pill" data-faith="Other / Mixed">Other / Mixed</button>
        </div>

        <div class="option-section-title">Engine mode</div>
        <div class="faith-note">
          Seed-only (offline) or Live emotional reactor (via backend).
        </div>
        <div class="option-row">
          <span>Current: <span id="engineModeLabel">Seed-only. Everything runs locally.</span></span>
          <label class="toggle">
            <input type="checkbox" id="engineModeToggle" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="option-row" id="llmModelRow" style="display:none;">
          <span>Preferred backend LLM model</span>
          <select id="llmModelSelect">
            <option value="gpt-4o-mini">OpenAI ‚Äì GPT-4o-mini</option>
          </select>
        </div>

        <div class="option-section-title">Prototype controls</div>
        <div class="option-row">
          <span>Auto-summarize long conversations to ~200 sentences</span>
          <label class="toggle">
            <input type="checkbox" id="autoSummarizeToggle" checked />
            <span class="slider"></span>
          </label>
        </div>
        <div class="option-row">
          <span>Ignore tiny small-talk as BM (hello / hi / how are you)</span>
          <label class="toggle">
            <input type="checkbox" id="ignoreSmallTalkToggle" checked />
            <span class="slider"></span>
          </label>
        </div>
        <div class="option-row">
          <span>Clear all stored BM for the last 24 hours (wastage cleanup)</span>
          <button class="modal-close" id="clear24hBtn">‚ôªÔ∏è Clear 24h</button>
        </div>
        <div class="option-row">
          <span>Delete full local BM life (all days)</span>
          <button class="modal-close" id="clearAllBtn">Delete All</button>
        </div>
        <div class="options-footer-note">
          About AURA-X Œ©: Designed around the idea that emotions are continuity functions
          between memories (TM and BM), not isolated sparks. This page is a small offline
          + online demo of Alim ul Haq‚Äôs emotional continuity theory.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const BACKEND_URL = "https://aura-x-backend-jliz.onrender.com"; // apna Render URL

    const lsKey = "auraX_bm_v31";
    const faithKey = "auraX_faithLens";
    const engineKey = "auraX_engineMode";
    const llmModelKey = "auraX_llmModel";

    const smallTalkPatterns = [
      "hi","hello","hey","salam","assalamualaikum",
      "how are you","kia hal hai","kese ho","how r u"
    ];

    const abuseWords = [
      "fuck","fucking","fucked","lanat","laanat","haramzada",
      "bastard","bitch","bitches","bloody","kutte","kutta","kutiya",
      "chutiya","stupid","idiot","gadha","gandi zuban","shut up","chup",
      "bakwas","bakwass","zalil","zaleel","cursed"
    ];
    const duaWords = [
      "dua","prayer","pray for me","make dua","dua karo","dua karna",
      "istighfar","astaghfirullah"
    ];
    const shukrWords = [
      "shukr","shukar","thanks","thank you","alhamdulillah","grateful","gratitude"
    ];
    const tawakkulWords = [
      "tawakkul","tawakkal","trust in allah","allah par bharosa","allah pe bharosa"
    ];
    const loveSeedWords = [
      "i love you","love you","pyaar","pyar","mohabbat",
      "i care about you","miss you","hug","embrace"
    ];
    const empathyWords = [
      "feel sorry for you","sorry for you","may allah ease",
      "may allah make it easy","allah apko ajar de",
      "i am with you","i understand your pain","may god help you"
    ];

    function loadBM(){
      try {
        const raw = localStorage.getItem(lsKey);
        return raw ? JSON.parse(raw) : {};
      } catch { return {}; }
    }
    function saveBM(data){ localStorage.setItem(lsKey, JSON.stringify(data)); }
    function todayKey(){ return new Date().toISOString().slice(0,10); }
    function tanh(x){ const e2x=Math.exp(2*x); return (e2x-1)/(e2x+1); }
    function approximateSentences(text){
      return text.split(/[.!?€î\n]/).filter(s=>s.trim().length>0);
    }
    function summarizeTo200Sentences(text){
      const sentences = approximateSentences(text);
      if (sentences.length<=200) return text.trim();
      return sentences.slice(0,200).join(". ").slice(0,10000);
    }
    function isMostlySmallTalk(text){
      const clean=text.toLowerCase().trim();
      if (clean.length>80) return false;
      return smallTalkPatterns.some(p=>clean===p||clean.startsWith(p+" "));
    }
    function containsAny(lower, arr){
      return arr.some(w => lower.includes(w));
    }
    function countAny(lower, arr){
      return arr.reduce((c,w)=> c + (lower.includes(w)?1:0), 0);
    }

    function analyseContent(text){
      const lower = text.toLowerCase();
      const abuseCount = countAny(lower, abuseWords);
      const posSeedCount =
        countAny(lower, loveSeedWords) +
        countAny(lower, shukrWords) +
        countAny(lower, tawakkulWords) +
        countAny(lower, empathyWords);
      const total = abuseCount + posSeedCount;
      const sentiment = total ? (posSeedCount - abuseCount) / total : 0;

      const endSlice = lower.slice(Math.max(0, lower.length - 300));
      const endAbuse = countAny(endSlice, abuseWords);
      const endPos =
        countAny(endSlice, loveSeedWords) +
        countAny(endSlice, shukrWords) +
        countAny(endSlice, tawakkulWords) +
        countAny(endSlice, empathyWords);
      const endTotal = endAbuse + endPos;
      const endingSentiment = endTotal ? (endPos - endAbuse) / endTotal : sentiment;

      const hasDua = containsAny(lower, duaWords);
      const hasShukr = containsAny(lower, shukrWords);
      const hasLove = containsAny(lower, loveSeedWords);
      const hasEmpathy = containsAny(lower, empathyWords);
      const hasTawakkul = containsAny(lower, tawakkulWords);
      const isAbuse = abuseCount > 0;

      return {
        isAbuse,
        hasDua,
        hasShukr,
        hasLove,
        hasEmpathy,
        hasTawakkul,
        hasFaithSeed: hasDua || hasTawakkul,
        positiveSeed: posSeedCount > 0,
        abuseCount,
        posSeedCount,
        sentiment,
        endingSentiment
      };
    }

    let TM=0.35, BMvalue=0.55, D=0.0, Csum=0.05;
    let lambdaFaith=0.0;
    const lambdaSys=0.02;
    let E0=0.0;

    const chatLogEl=document.getElementById("chatLog");
    const statusLineEl=document.getElementById("statusLine");
    const eqMainEl=document.getElementById("eqMain");
    const eqValuesEl=document.getElementById("eqValues");
    const userInputEl=document.getElementById("userInput");
    const modePill=document.getElementById("modePill");
    const reactionBannerEl=document.getElementById("reactionBanner");
    const voiceToggleEl=document.getElementById("voiceToggle");
    const engineModeToggle=document.getElementById("engineModeToggle");
    const engineModeLabel=document.getElementById("engineModeLabel");
    const engineFooterLabel=document.getElementById("engineFooterLabel");
    let autoVoice = true;

    function updateEquationDisplay(){
      eqMainEl.textContent="E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)";
      eqValuesEl.textContent=
        `E‚ÇÄ = ${E0.toFixed(2)} ¬∑ TM = ${TM.toFixed(2)} ¬∑ BM = ${BMvalue.toFixed(2)} ¬∑ ` +
        `D = ${D.toFixed(2)} ¬∑ Œ£C‚Çú = ${Csum.toFixed(2)} ¬∑ Œª_faith = ${lambdaFaith.toFixed(2)} ¬∑ Œª_sys = ${lambdaSys.toFixed(2)}`;
      statusLineEl.textContent=
        `E‚ÇÄ=${E0.toFixed(2)} ¬∑ TM=${TM.toFixed(2)} ¬∑ D=${D.toFixed(2)} ¬∑ tag=${
          E0>0.1?"positive":E0<-0.1?"negative":"neutral"
        }`;
    }

    function buildReactionTone(){
      const intensity=Math.abs(E0);
      let polarity = "Neutral";
      let cls = "reaction-neutral";
      if (E0>0.1){ polarity="Positive"; cls="reaction-positive"; }
      else if (E0<-0.1){ polarity="Negative"; cls="reaction-negative"; }

      let tone="";
      if (polarity==="Positive"){
        if (intensity>0.7) tone="Warm, expansive, high-energy encouragement.";
        else if (intensity>0.35) tone="Soft, stabilizing, hopeful resonance.";
        else tone="Light, gentle, low-amplitude positive drift.";
      } else if (polarity==="Negative"){
        if (intensity>0.7) tone="Deep, heavy, thunder-style emotional load (fear/anger).";
        else if (intensity>0.35) tone="Firm, serious, caution-oriented resonance.";
        else tone="Mild negative charge, like a faint worry or discomfort.";
      } else {
        if (intensity>0.5) tone="Mixed signal: strong but conflicted emotional pattern.";
        else tone="Calm, observant, analytically neutral reading.";
      }
      return {polarity, cls, intensity, tone};
    }

    function updateReactionBanner(sourceText){
      const text = (sourceText||"").trim();
      if (!text){
        reactionBannerEl.style.display="none";
        return;
      }
      const {polarity, cls, intensity, tone} = buildReactionTone();
      reactionBannerEl.className = "reaction-banner " + cls;
      reactionBannerEl.innerHTML =
        `<strong>${polarity.toUpperCase()} ¬∑ Intensity: ${(intensity*100).toFixed(0)}%</strong><br>`+
        `Tone: ${tone}`;
      reactionBannerEl.style.display="block";
    }

    function appendMessage(text, who){
      const div=document.createElement("div");
      div.className="msg "+(who==="user"?"msg-user":"msg-bot");
      div.textContent=text;
      chatLogEl.appendChild(div);
      chatLogEl.scrollTop=chatLogEl.scrollHeight;
    }

    function pickVoiceForPolarity(polarity) {
      const synth = window.speechSynthesis;
      if (!synth) return {voice:null, pitch:1.0, rate:1.0};
      let voices = synth.getVoices();
      if (!voices || !voices.length) {
        return {voice:null, pitch: polarity==="Negative" ? 1.2 : 0.9, rate:1.0};
      }
      let target = null;
      if (polarity === "Positive") {
        target = voices.find(v => /male/i.test(v.name)) || voices[0];
        return {voice:target, pitch:0.9, rate:1.0};
      } else if (polarity === "Negative") {
        target = voices.find(v => /female/i.test(v.name)) || voices[0];
        return {voice:target, pitch:1.2, rate:1.0};
      } else {
        target = voices[0];
        return {voice:target, pitch:1.0, rate:1.0};
      }
    }

    function speakReply(text){
      if (!autoVoice) return;
      if (!("speechSynthesis" in window)) return;
      if (!text || !text.trim()) return;
      const synth = window.speechSynthesis;
      const {polarity} = buildReactionTone();
      const {voice, pitch, rate} = pickVoiceForPolarity(polarity);
      const utt = new SpeechSynthesisUtterance(text);
      if (voice) utt.voice = voice;
      utt.pitch = pitch;
      utt.rate = rate;
      synth.cancel();
      synth.speak(utt);
    }

    function computeEmotion(strength, analysis){
      const baseFromLength=Math.min(1,0.2+strength/400);
      const sentiment = analysis ? analysis.sentiment || 0 : 0;
      const endingSentiment = analysis ? analysis.endingSentiment || sentiment : sentiment;
      const END_WEIGHT = 0.08;

      TM = Math.min(1, Math.max(0, baseFromLength + 0.22*sentiment + END_WEIGHT*endingSentiment));

      let newBM = BMvalue + 0.10*sentiment;
      BMvalue = Math.min(1, Math.max(0, newBM));

      let decay = 0.0;
      if (Math.abs(sentiment) < 0.05 && Math.abs(endingSentiment) < 0.05){
        decay = 0.02;
      }
      D = Math.min(1, Math.max(0, D*0.9 + decay));

      const input = TM*BMvalue - D + lambdaFaith + lambdaSys + Csum;
      E0 = tanh(input);
    }

    function buildSeedReply(text, analysis){
      const {polarity, intensity} = buildReactionTone();
      const langIsUrdu = /[ÿ°ÿ¢ÿ£ÿ•ÿ§ÿ¶ÿßÿ®ÿ©ÿ™ÿ´ÿ¨ÿ≠ÿÆÿØÿ∞ÿ±ÿ≤ÿ≥ÿ¥ÿµÿ∂ÿ∑ÿ∏ÿπÿ∫ŸÅŸÇŸÉŸÑŸÖŸÜŸáŸàŸâŸä⁄ë⁄∫Ÿπ€ÄŸ∞]/.test(text);
      let base = "";
      if (langIsUrdu){
        if (polarity==="Positive"){
          base = "ÿ™ŸÖ€Åÿßÿ±€å ÿßÿ≥ €åÿßÿØ ŸÖ€å⁄∫ ŸÖÿ´ÿ®ÿ™ ÿ®€Åÿßÿ§ ŸÖÿ≠ÿ≥Ÿàÿ≥ €ÅŸà ÿ±€Åÿß €Å€í€î ÿßÿ≥ ⁄©€åŸÅ€åÿ™ ⁄©Ÿà ÿ¥⁄©ÿ±ÿå ŸÜÿ±ŸÖ€å ÿßŸàÿ± ÿÆ€åÿ± ⁄©€í ⁄©ÿßŸÖŸà⁄∫ ÿ≥€í ŸÖÿ≠ŸÅŸàÿ∏ ÿ±⁄©⁄æŸÜ€í ⁄©€å ⁄©Ÿàÿ¥ÿ¥ ⁄©ÿ±Ÿà€î";
        } else if (polarity==="Negative"){
          base = "ÿßÿ≥ ÿ¨ŸÖŸÑ€í ŸÖ€å⁄∫ ÿØŸÑ Ÿæÿ± ÿ®Ÿàÿ¨⁄æ ÿßŸàÿ± ŸÖŸÜŸÅ€å ⁄©€åŸÅ€åÿ™ ŸÜÿ∏ÿ± ÿ¢ ÿ±€Å€å €Å€í€î ÿ∞ÿ±ÿß ÿ¢€Åÿ≥ÿ™€Å €ÅŸà ÿ¨ÿßÿ§ÿå ⁄Ø€Åÿ±ÿß ÿ≥ÿßŸÜÿ≥ ŸÑŸà ÿßŸàÿ± ÿßÿ®⁄æ€å ÿ®⁄ë€í ŸÅ€åÿµŸÑŸà⁄∫ ÿ≥€í ÿ®⁄ÜŸà€î";
        } else {
          base = "€å€Å €åÿßÿØ ŸÖŸÑ€å ÿ¨ŸÑ€å ÿßŸàÿ± ŸÜÿ≥ÿ®ÿ™ÿßŸã ŸÖÿ™Ÿàÿßÿ≤ŸÜ lag ÿ±€Å€å €Å€í€î ÿ®ÿ≥ observe ⁄©ÿ±Ÿàÿå ÿÆŸàÿØ Ÿæÿ± ÿ≥ÿÆÿ™€å ŸÜ€Å ⁄©ÿ±Ÿà ÿßŸàÿ± ÿØ€å⁄©⁄æŸà ÿØŸÑ ÿ™ŸÖ ÿ≥€í ⁄©€åÿß ⁄©€Å€Å ÿ±€Åÿß €Å€í€î";
        }
        if (analysis?.hasDua || analysis?.hasTawakkul){
          base += " ÿ™ŸÖ€Åÿßÿ±€å ÿ®ÿßÿ™ ŸÖ€å⁄∫ ÿØÿπÿß ÿßŸàÿ± ÿ™Ÿà⁄©ŸÑ ⁄©€å ŸÑ€Åÿ± ÿ®⁄æ€å €Å€íÿå ÿ¨Ÿà ÿØŸÑ ⁄©Ÿà ÿ¢€Åÿ≥ÿ™€Å ÿ¢€Åÿ≥ÿ™€Å ŸÖÿ´ÿ®ÿ™ ÿ∑ÿ±ŸÅ ⁄©⁄æ€åŸÜ⁄Üÿ™€å €Å€í€î";
        } else if (analysis?.hasShukr){
          base += " ÿ¥⁄©ÿ± ⁄©ÿß ÿ≤ÿßŸà€å€Å ÿßÿ≥ ⁄©€åŸÅ€åÿ™ ⁄©Ÿà ÿ¢€Åÿ≥ÿ™€Å ÿ¢€Åÿ≥ÿ™€Å €ÅŸÑ⁄©ÿß ÿßŸàÿ± ÿ±Ÿàÿ¥ŸÜ ÿ®ŸÜÿß ÿ≥⁄©ÿ™ÿß €Å€í€î";
        }
      } else {
        if (polarity==="Positive"){
          base = "There is a gentle positive drift in this memory. Protect it with gratitude, soft choices and kind actions.";
        } else if (polarity==="Negative"){
          base = "This TM carries a heavy or negative load. Slow down, breathe, and avoid big decisions while the heart feels like this.";
        } else {
          base = "This feels like a mixed or neutral signal. Let yourself observe without rushing into action or judgment.";
        }
        if (analysis?.hasDua || analysis?.hasTawakkul){
          base += " I can also feel a trace of prayer / trust here, which usually pulls E‚ÇÄ slowly to the positive side.";
        } else if (analysis?.hasShukr){
          base += " Gratitude inside this type of TM often stabilises the heart over time.";
        }
      }
      return base;
    }

    async function callBackendLLM(text, analysis){
      const polarityHint = analysis
        ? analysis.sentiment > 0.05
          ? "positive"
          : analysis.sentiment < -0.05
          ? "negative"
          : "neutral"
        : "neutral";
      try {
        const res = await fetch(`${BACKEND_URL}/react`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: text,
            e0: E0,
            tm: TM,
            bm: BMvalue,
            polarityHint
          })
        });
        if (!res.ok) throw new Error("HTTP "+res.status);
        const data = await res.json();
        if (data && data.reply) return data.reply;
        return "[Live engine: fallback to seed] " + buildSeedReply(text, analysis);
      } catch (err){
        console.error("Backend error:", err);
        return "[Live engine error, using local seed] " + buildSeedReply(text, analysis);
      }
    }

    function maybeStoreBMNode(text, analysis){
      if (!text || text.trim().length<20) return;
      const strength = text.length;
      const intensity = Math.abs(E0);
      if (intensity < 0.2 && strength < 120) return; // limit auto nodes

      const dayKey = todayKey();
      const store = loadBM();
      if (!store[dayKey]) store[dayKey]=[];

      const polarityPos = E0 >= 0;
      const posPercent = Math.round((polarityPos ? Math.abs(E0) : (1-Math.abs(E0)))*100);
      const negPercent = 100 - posPercent;

      const node = {
        ts: new Date().toISOString(),
        title: text.slice(0,60),
        text: summarizeTo200Sentences(text),
        E0: E0,
        TM: TM,
        D: D,
        polarity: polarityPos ? "positive" : "negative",
        posPercent,
        negPercent,
        layers: {
          L1: Math.round(50 + 35*TM),
          L2: Math.round(40 + 30*Math.abs(analysis?.sentiment||0)),
          L3: Math.round(30 + 30*Math.abs(E0)),
          L4: Math.round(40 + 30*Math.abs(analysis?.endingSentiment||0)),
          L5: Math.round(50 + 40*Math.max(0, analysis?.posSeedCount||0)/5),
          L6: Math.round(45 + 30*Math.abs(lambdaFaith)),
          L7: 50
        }
      };
      store[dayKey].push(node);
      saveBM(store);
    }

    function renderBMModal(){
      const body = document.getElementById("bmModalBody");
      const store = loadBM();
      body.innerHTML = "";
      const days = Object.keys(store).sort().reverse();
      if (!days.length){
        body.textContent="No BM stored yet.";
        return;
      }
      for (const day of days){
        const wrapper=document.createElement("div");
        wrapper.className="bm-day";
        const title=document.createElement("div");
        title.className="bm-day-title";
        title.textContent=`${day} (${store[day].length} nodes)`;
        wrapper.appendChild(title);

        for (const node of store[day]){
          const n=document.createElement("div");
          n.className="bm-node";
          const tt=document.createElement("div");
          tt.className="bm-node-title";
          tt.textContent=node.title;
          const meta=document.createElement("div");
          meta.className="bm-node-meta";
          meta.textContent=`E‚ÇÄ‚âà${node.E0.toFixed(2)} ¬∑ TM=${node.TM.toFixed(2)} ¬∑ D=${node.D.toFixed(2)} ¬∑ ${node.ts.slice(11,19)}`;

          const pol=document.createElement("div");
          pol.className="polarity-line";
          pol.innerHTML=`<span class="label">Polarity:</span> <span class="pos">${node.posPercent}</span> : <span class="neg">${node.negPercent}</span>`;

          const chips=document.createElement("div");
          chips.className="layer-chips";
          for (let i=1;i<=7;i++){
            const k="L"+i;
            const chip=document.createElement("div");
            chip.className="layer-chip "+k;
            chip.textContent=`${k}:${node.layers[k]}`;
            chips.appendChild(chip);
          }

          const text=document.createElement("div");
          text.textContent=node.text;

          n.appendChild(tt);
          n.appendChild(meta);
          n.appendChild(pol);
          n.appendChild(chips);
          n.appendChild(text);
          wrapper.appendChild(n);
        }

        const btn=document.createElement("button");
        btn.className="delete-day-btn";
        btn.textContent="Delete Day";
        btn.addEventListener("click", ()=>{
          const s=loadBM();
          delete s[day];
          saveBM(s);
          renderBMModal();
        });
        wrapper.appendChild(btn);
        body.appendChild(wrapper);
      }
    }

    function renderRecallModal(){
      const store = loadBM();
      const all=[];
      Object.keys(store).forEach(day=>{
        store[day].forEach(node=>{
          all.push({...node, day});
        });
      });
      const listEl=document.getElementById("recallList");
      const searchEl=document.getElementById("recallSearchInput");

      function applyFilter(){
        const q=(searchEl.value||"").toLowerCase();
        listEl.innerHTML="";
        const filtered = q
          ? all.filter(n=> (n.text||"").toLowerCase().includes(q) || (n.title||"").toLowerCase().includes(q))
          : all;
        if (!filtered.length){
          listEl.textContent="No matching BM nodes.";
          return;
        }
        filtered
          .sort((a,b)=> b.ts.localeCompare(a.ts))
          .forEach(node=>{
            const div=document.createElement("div");
            div.className="recall-node";
            const meta=document.createElement("div");
            meta.innerHTML=`<strong>${node.title}</strong><br>${node.day} ¬∑ E‚ÇÄ‚âà${node.E0.toFixed(2)} ¬∑ Polarity: ${node.posPercent}:${node.negPercent}`;
            const txt=document.createElement("div");
            txt.textContent=node.text;
            const btn=document.createElement("button");
            btn.className="copy-btn";
            btn.textContent="Copy prompt to clipboard";
            btn.addEventListener("click", ()=>{
              const payload=`BM RECALL ¬∑ Day=${node.day} ¬∑ E0‚âà${node.E0.toFixed(2)} ¬∑ L1‚ÄìL7=${JSON.stringify(node.layers)}\n\n${node.text}`;
              navigator.clipboard.writeText(payload);
              btn.textContent="Copied!";
              setTimeout(()=>btn.textContent="Copy prompt to clipboard",1200);
            });
            div.appendChild(meta);
            div.appendChild(txt);
            div.appendChild(btn);
            listEl.appendChild(div);
          });
      }

      searchEl.oninput=applyFilter;
      applyFilter();
    }

    function showModal(id){
      document.getElementById(id).style.display="flex";
    }
    function hideModal(id){
      document.getElementById(id).style.display="none";
    }

    document.getElementById("bmViewerBtn").onclick=()=>{
      renderBMModal();
      showModal("bmModalBackdrop");
    };
    document.getElementById("recallBtn").onclick=()=>{
      renderRecallModal();
      showModal("recallModalBackdrop");
    };
    document.getElementById("cleanupBtn").onclick=()=>{
      const store=loadBM();
      const today=todayKey();
      Object.keys(store).forEach(day=>{
        if (day===today) return;
        delete store[day];
      });
      saveBM(store);
      alert("Only today's BM kept; older days cleared.");
    };
    document.getElementById("optionsBtn").onclick=()=>{
      showModal("optionsModalBackdrop");
    };
    document.querySelectorAll(".modal-close").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        const id = btn.dataset.close;
        if (id) hideModal(id);
      });
    });

    voiceToggleEl.onclick=()=>{
      autoVoice = !autoVoice;
      voiceToggleEl.classList.toggle("active", autoVoice);
      voiceToggleEl.textContent = autoVoice ? "üîä Voice: On" : "üîá Voice: Off";
    };

    engineModeToggle.addEventListener("change", ()=>{
      const live = engineModeToggle.checked;
      localStorage.setItem(engineKey, live ? "live" : "seed");
      if (live){
        engineModeLabel.textContent="Live emotional reactor via backend.";
        engineFooterLabel.textContent="Engine: Live LLM (backend)";
        modePill.querySelector(".mode-label").textContent="MODE: LIVE LLM";
        modePill.querySelector(".mode-sub").textContent="Universal Ethics ¬∑ BM + Live LLM";
        modePill.querySelector(".engine").textContent="Engine: Emotional Reactor (UI + backend)";
      } else {
        engineModeLabel.textContent="Seed-only. Everything runs locally.";
        engineFooterLabel.textContent="Engine: Seed (local)";
        modePill.querySelector(".mode-label").textContent="MODE: OFFLINE PROTOTYPE";
        modePill.querySelector(".mode-sub").textContent="Universal Ethics ¬∑ Local BM";
        modePill.querySelector(".engine").textContent="Engine: Seed (local)";
      }
    });

    (function initEngineMode(){
      const stored = localStorage.getItem(engineKey);
      if (stored==="live") engineModeToggle.checked=true;
      engineModeToggle.dispatchEvent(new Event("change"));
    })();

    async function handleSend(){
      const text = (userInputEl.value||"").trim();
      if (!text) return;
      userInputEl.value="";
      appendMessage(text,"user");

      const strength = text.length;
      const analysis = analyseContent(text);

      computeEmotion(strength, analysis);
      updateEquationDisplay();
      updateReactionBanner(text);
      maybeStoreBMNode(text, analysis);

      const useLive = engineModeToggle.checked;
      let reply;
      if (useLive){
        reply = await callBackendLLM(text, analysis);
      } else {
        reply = buildSeedReply(text, analysis);
      }

      appendMessage(reply,"bot");
      speakReply(reply);
    }

    document.getElementById("sendBtn").onclick=handleSend;
    userInputEl.addEventListener("keydown", (e)=>{
      if (e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        handleSend();
      }
    });

    updateEquationDisplay();
  </script>
</body>
</html>
