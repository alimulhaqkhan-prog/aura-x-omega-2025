<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ================================
       BASE "BOOK PAGE" THEME (PERMANENT)
    ==================================*/
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f7f1e5; /* soft beige page */
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #333;
    }

    #app {
      max-width: 650px;
      margin: 0 auto;
      padding: 14px;
    }

    /* ===== HEADER ===== */
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    h1 {
      font-size: 26px;
      font-weight: 700;
      margin: 0;
    }

    .sub {
      font-size: 12px;
      margin-top: 2px;
      opacity: 0.85;
    }

    .mode-pill {
      padding: 10px 14px;
      border-radius: 20px;
      background: #e4f0ff;
      font-size: 11px;
      text-align: right;
      min-width: 150px;
      border: 1px solid #60a5fa;
    }

    .mode-pill strong {
      display: block;
      font-size: 11px;
      margin-bottom: 2px;
      letter-spacing: 0.08em;
    }

    /* ===== TOP BUTTONS (4 IN ONE LINE) ===== */
    .btn-row {
      display: flex;
      flex-wrap: nowrap;      /* force one line */
      gap: 6px;
      margin: 14px 0;
    }

    .btn {
      flex: 1;
      padding: 8px 6px;
      border-radius: 999px;   /* pill style */
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 0 1px 2px rgba(15,23,42,0.08);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
      transition: background 0.15s, transform 0.08s, box-shadow 0.15s;
    }

    .btn span.icon {
      font-size: 14px;
    }

    #recallBtn {
      border-color: #f59e0b;
      background: #fffbeb;
    }

    #cleanupBtn {
      background: #dff5d1;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(15,23,42,0.15);
    }

    /* ===== UNIVERSAL ETHICS ===== */
    .ethics-box {
      background: #fff7d1;
      border-left: 5px solid #f0c540;
      padding: 14px;
      border-radius: 10px;
      margin-bottom: 18px;
      color: #7a5b00;
      font-size: 13px;
      font-weight: 500; /* golden + bold */
    }

    /* ===== EQUATION CARD ===== */
    .eq-card {
      margin-bottom: 12px;
      padding: 14px;
      background: #fffdf6;
      border-radius: 12px;
      border: 1px dashed #e6d7bf;
      font-size: 13px;
      line-height: 1.5;
    }

    .eq-title {
      font-weight: 600;
      margin-bottom: 6px;
      letter-spacing: 0.03em;
    }

    code {
      font-family: "SF Mono", ui-monospace, Menlo, Consolas, monospace;
      font-size: 12px;
      background: #f5efe0;
      padding: 2px 4px;
      border-radius: 4px;
    }

    /* ===== CHAT AREA + REACTION BANNER ===== */
    .chat-area {
      margin-top: 4px;
      padding: 10px 12px;
      background: #fffaf1;
      border-radius: 12px;
      border: 1px solid #eadfcb;
      max-height: 360px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #chatLog {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 14px;
    }

    .chat-msg {
      margin-bottom: 12px;
      padding-bottom: 6px;
      border-bottom: 1px dashed #d3c8b8;
    }

    .chat-msg:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .chat-msg-user {
      color: #0066cc;
      font-weight: 500;
      text-align: right;
      margin-bottom: 4px;
      white-space: pre-wrap;
    }

    .chat-msg-text {
      font-size: 14px;
      white-space: pre-wrap;
    }

    .chat-msg-time {
      font-size: 11px;
      opacity: 0.6;
      margin-top: 2px;
    }

    .reaction-banner {
      display: none;
      border-radius: 12px;
      padding: 6px 8px;
      font-size: 12px;
      line-height: 1.3;
      border: 1px solid rgba(148,163,184,0.7);
      background: #f0fdf4;
    }

    .reaction-banner strong {
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 11px;
      display: block;
      margin-bottom: 2px;
    }

    .reaction-positive {
      border-color: #22c55e;
      color: #166534;
      background: #dcfce7;
    }

    .reaction-negative {
      border-color: #ef4444;
      color: #991b1b;
      background: #fee2e2;
    }

    .reaction-neutral {
      border-color: #eab308;
      color: #854d0e;
      background: #fef9c3;
    }

    .polarity-green { color: #0f8a1f; font-weight: 700; }
    .polarity-red   { color: #c62828; font-weight: 700; }

    /* ===== TM FORMULA & INPUT ===== */
    #tmFormula {
      text-align: center;
      margin-top: 10px;
      margin-bottom: 6px;
      padding: 6px 12px;
      background: #ffffffee;
      border-radius: 14px;
      font-weight: 600;
      font-size: 13px;
      box-shadow: 0 0 3px rgba(0,0,0,0.06);
    }

    #inputRow {
      display: flex;
      gap: 10px;
      margin-top: 4px;
      align-items: flex-end;
    }

    #userInput {
      flex: 1;
      padding: 11px 12px;
      border-radius: 16px;
      border: 1px solid #cfc4b3;
      font-size: 14px;
      resize: vertical;
      min-height: 56px;
      max-height: 120px;
    }

    #sendBtn {
      padding: 12px 20px;
      background: #0FA958;
      color: white;
      border: none;
      border-radius: 22px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.16);
      white-space: nowrap;
    }

    #sendBtn:hover {
      background: #0d8a48;
    }

    .pipeline-text {
      margin-top: 6px;
      font-size: 12px;
      opacity: 0.8;
    }

    .footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      font-size: 12px;
      gap: 8px;
      flex-wrap: wrap;
    }

    #voiceToggleBtn {
      padding: 7px 12px;
      border-radius: 18px;
      border: 1px solid #0FA958;
      background: #eaffe9;
      cursor: pointer;
      font-size: 12px;
    }

    #voiceToggleBtn.off {
      border-color: #999;
      background: #f1f1f1;
      color: #555;
    }

    /* ===== CONTINUITY MODAL ===== */
    #continuityModal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 999;
    }

    #modalBox {
      background: #fffdf7;
      padding: 18px;
      max-width: 540px;
      width: 100%;
      border-radius: 12px;
      box-shadow: 0 0 22px rgba(0,0,0,0.4);
      font-size: 13px;
    }

    #modalTitle {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    #modalSubtitle {
      font-size: 11px;
      margin-bottom: 10px;
      opacity: 0.75;
    }

    .modal-feed {
      max-height: 280px;
      overflow-y: auto;
      padding-right: 6px;
      border: 1px solid #e8dcc5;
      border-radius: 10px;
      padding: 9px;
      background: #ffffff;
    }

    .buffer-item {
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px dashed #e0d5c1;
    }

    .buffer-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .buffer-item-title {
      font-size: 11px;
      opacity: 0.7;
      margin-bottom: 2px;
    }

    .buffer-item-text {
      font-size: 13px;
      white-space: pre-wrap;
    }

    .modal-btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    #modalClose {
      padding: 8px 16px;
      background: #999;
      color: #fff;
      border-radius: 20px;
      border: none;
      cursor: pointer;
      font-size: 12px;
    }

    #clear24Btn,
    #clear48Btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
    }

    #clear24Btn {
      background: #f9a825;
    }

    #clear48Btn {
      background: #c62828;
    }

    @media (max-width: 480px) {
      #inputRow {
        flex-direction: column;
        align-items: stretch;
      }
      #sendBtn {
        width: 100%;
      }
      .footer-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }
      .btn-row {
        gap: 4px;
      }
      .btn {
        font-size: 11px;
        padding: 7px 4px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="header-row">
      <div>
        <h1>AURA-X Œ©</h1>
        <div class="sub">
          EMOTIONAL CONTINUITY ¬∑ AEC ¬∑ CRM ¬∑ AECN ¬∑ RL¬≥ ¬∑ LR¬≥
        </div>
      </div>
      <div class="mode-pill">
        <strong>MODE: OFFLINE PROTOTYPE</strong>
        Universal Ethics ¬∑ Local BM<br />
        Engine: Seed (local)
      </div>
    </div>

    <!-- 4 buttons in one line -->
    <div class="btn-row">
      <button class="btn" id="bmViewerBtn"><span class="icon">üß†</span><span>BM Viewer</span></button>
      <button class="btn" id="recallBtn"><span class="icon">üìÇ</span><span>Recall BM</span></button>
      <button class="btn" id="cleanupBtn"><span class="icon">‚ôªÔ∏è</span><span>Continuity 48h</span></button>
      <button class="btn" id="optionsBtn"><span class="icon">‚öôÔ∏è</span><span>Options</span></button>
    </div>

    <!-- Ethics in golden -->
    <div class="ethics-box">
      Avoid actions that generate negative emotions in yourself or others.
      Gently move toward choices that create calm, kindness, and positive feelings.
    </div>

    <!-- Equation card (math internal only) -->
    <div class="eq-card">
      <div class="eq-title">EMOTIONAL CONTINUITY EQUATION</div>
      <div style="margin-bottom:6px;">
        <code>E‚ÇÄ = tanh(TM √ó BM ‚àí D + Œª_faith + Œª_sys + Œ£C‚Çú)</code>
      </div>
      <div>
        All parameters are updated internally after each message to keep
        emotional continuity live. The interface only shows the resulting
        reaction, not the hidden math.
      </div>
    </div>

    <!-- Chat area with small reaction banner -->
    <div class="chat-area">
      <div id="reactionBanner" class="reaction-banner"></div>
      <div id="chatLog"></div>
    </div>

    <!-- TM formula (compact) -->
    <div id="tmFormula">TM = Œ£(User Inputs) + (Seed + LLM)</div>

    <!-- Input row -->
    <div id="inputRow">
      <textarea id="userInput"
        placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."></textarea>
      <button id="sendBtn">Send</button>
    </div>

    <div class="pipeline-text">
      Prototype ¬∑ TM ‚Üí Analysis ‚Üí Equation ‚Üí BM save ‚Üí Reaction.
    </div>

    <div class="footer-row">
      <button id="voiceToggleBtn">üîä Voice: On</button>
      <div style="opacity:0.65;">
        Conceptually created by Alim ul Haq (Timergara, Pakistan) as part of the
        AURA-X Œ© / AEC research on emotional continuity.
      </div>
    </div>
  </div>

  <!-- CONTINUITY 48H MODAL -->
  <div id="continuityModal">
    <div id="modalBox">
      <div id="modalTitle">48-hour Continuity Buffer</div>
      <div id="modalSubtitle">
        Light greetings and short exchanges are stored here for up to 48 hours
        to support emotional continuity. They do not become Bold Memory (BM)
        unless they turn into deeper stories.
      </div>
      <div id="modalFeed" class="modal-feed"></div>
      <div class="modal-btn-row">
        <button id="clear24Btn">Delete last 24 hours</button>
        <button id="clear48Btn">Delete full 48h buffer</button>
        <button id="modalClose">Close</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // STORAGE KEYS & GLOBAL STATE
    // ==========================
    const STORAGE_BM = 'auraX_BM_nodes_v3';
    const STORAGE_BUFFER = 'auraX_continuity48_v3';

    let bmNodes = [];
    let continuityBuffer = [];
    let voiceEnabled = true;

    // Core emotional parameters (hidden math)
    let coreState = {
      TM: 0.25,
      BM: 0.35,
      D: 0.0,
      lambdaFaith: 0.0,
      lambdaSys: 0.02,
      Ct: 0.05,
      E0: 0.0,
      tag: 'neutral'
    };

    // ==========================
    // UTILITIES
    // ==========================
    function nowMs() {
      return Date.now();
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleString();
    }

    function loadFromStorage() {
      try {
        const bmRaw = localStorage.getItem(STORAGE_BM);
        if (bmRaw) bmNodes = JSON.parse(bmRaw);
      } catch (e) {
        bmNodes = [];
      }
      try {
        const bufRaw = localStorage.getItem(STORAGE_BUFFER);
        if (bufRaw) continuityBuffer = JSON.parse(bufRaw);
      } catch (e) {
        continuityBuffer = [];
      }
      pruneContinuity();
    }

    function saveBM() {
      localStorage.setItem(STORAGE_BM, JSON.stringify(bmNodes));
    }

    function saveBuffer() {
      localStorage.setItem(STORAGE_BUFFER, JSON.stringify(continuityBuffer));
    }

    function pruneContinuity() {
      const now = nowMs();
      const maxAgeMs = 48 * 60 * 60 * 1000; // 48h
      continuityBuffer = continuityBuffer.filter(item => (now - item.ts) <= maxAgeMs);
      saveBuffer();
    }

    // Simple sentence count
    function countSentences(text) {
      const cleaned = text.replace(/\s+/g, ' ').trim();
      if (!cleaned) return 0;
      const parts = cleaned.split(/[.!?]+/).map(s => s.trim()).filter(Boolean);
      return parts.length;
    }

    // Very small rule-based sentiment; returns -1..+1
    function simpleSentiment(text) {
      const lower = text.toLowerCase();
      const positiveWords = ['happy','grateful','hope','love','calm','relief','peace','excited','joy'];
      const negativeWords = ['sad','angry','upset','anxious','worried','fear','pain','hurt','depressed','lonely','stress'];
      let score = 0;
      positiveWords.forEach(w => { if (lower.includes(w)) score += 1; });
      negativeWords.forEach(w => { if (lower.includes(w)) score -= 1; });
      if (score > 3) score = 3;
      if (score < -3) score = -3;
      return score / 3;
    }

    function classifyTag(sentimentScore) {
      if (sentimentScore > 0.08) return 'positive';
      if (sentimentScore < -0.08) return 'negative';
      return 'neutral';
    }

    // Greetings / short chit-chat detection
    function isLightGreeting(text) {
      const t = text.toLowerCase().trim();
      if (t.length === 0) return false;
      const greetingPatterns = [
        'hello','hi ','hi,','salam','assalam','asalam',
        'how are you','i am fine','i\'m fine','good morning',
        'good night','good evening','good afternoon',
        'thank you','thanks','i am happy','i\'m happy',
        'ok','okay'
      ];
      if (t.length < 120) {
        for (const g of greetingPatterns) {
          if (t.includes(g)) return true;
        }
      }
      return false;
    }

    // ==========================
    // CORE EQUATION UPDATE
    // ==========================
    function updateCoreState(sentimentScore, isBMEvent) {
      const abs = Math.abs(sentimentScore);
      coreState.TM = 0.2 + abs * 0.3;
      if (isBMEvent) {
        coreState.BM = Math.min(1, coreState.BM + abs * 0.05);
      } else {
        coreState.BM = Math.max(0, coreState.BM + sentimentScore * 0.01);
      }
      coreState.D = 0.0;

      const raw = coreState.TM * coreState.BM -
                  coreState.D +
                  coreState.lambdaFaith +
                  coreState.lambdaSys +
                  coreState.Ct;
      coreState.E0 = Math.tanh(raw);
      coreState.tag = classifyTag(sentimentScore || coreState.E0);
    }

    // ==========================
    // REACTION BANNER UPDATE
    // ==========================
    function updateReactionBanner(sentimentScore, intensity, tag) {
      const banner = document.getElementById('reactionBanner');
      if (!banner) return;

      let pos = Math.round((sentimentScore + 1) / 2 * 100);
      if (pos < 0) pos = 0;
      if (pos > 100) pos = 100;
      const neg = 100 - pos;

      let cls = 'reaction-banner ';
      if (tag === 'positive') cls += 'reaction-positive';
      else if (tag === 'negative') cls += 'reaction-negative';
      else cls += 'reaction-neutral';

      let toneText = 'Calm, neutral continuity.';
      if (tag === 'positive') {
        if (intensity > 0.7) toneText = 'Strong positive surge.';
        else if (intensity > 0.3) toneText = 'Soft, stabilizing hope.';
        else toneText = 'Light positive drift.';
      } else if (tag === 'negative') {
        if (intensity > 0.7) toneText = 'Heavy emotional load (anger / fear).';
        else if (intensity > 0.3) toneText = 'Serious, caution signal.';
        else toneText = 'Mild negative tension.';
      }

      banner.className = cls;
      banner.innerHTML =
        '<strong>AURA-X Œ© REACTION</strong>' +
        'Polarity: ' +
        '<span class="polarity-green">' + (tag === 'neutral' ? '50' : pos) + '</span> : ' +
        '<span class="polarity-red">' + (tag === 'neutral' ? '50' : neg) + '</span>' +
        ' ¬∑ Intensity: ' + intensity.toFixed(2) +
        ' ¬∑ Tag: ' + tag +
        '<br/>Tone: ' + toneText;

      banner.style.display = 'block';
    }

    function appendChat(userText, replyText, ts) {
      const log = document.getElementById('chatLog');
      const wrapper = document.createElement('div');
      wrapper.className = 'chat-msg';

      const userDiv = document.createElement('div');
      userDiv.className = 'chat-msg-user';
      userDiv.textContent = userText;
      wrapper.appendChild(userDiv);

      const replyDiv = document.createElement('div');
      replyDiv.className = 'chat-msg-text';
      replyDiv.textContent = replyText;
      wrapper.appendChild(replyDiv);

      const timeDiv = document.createElement('div');
      timeDiv.className = 'chat-msg-time';
      timeDiv.textContent = formatTime(ts);
      wrapper.appendChild(timeDiv);

      log.appendChild(wrapper);
      log.scrollTop = log.scrollHeight;
    }

    // ==========================
    // CONTINUITY BUFFER MODAL
    // ==========================
    function openContinuityModal() {
      pruneContinuity();
      const modal = document.getElementById('continuityModal');
      const feed = document.getElementById('modalFeed');
      feed.innerHTML = '';

      if (!continuityBuffer.length) {
        const empty = document.createElement('div');
        empty.textContent = 'No continuity messages stored in the last 48 hours yet.';
        empty.style.opacity = '0.7';
        feed.appendChild(empty);
      } else {
        continuityBuffer
          .sort((a,b) => a.ts - b.ts)
          .forEach((item, idx) => {
            const wrap = document.createElement('div');
            wrap.className = 'buffer-item';

            const title = document.createElement('div');
            title.className = 'buffer-item-title';
            title.textContent =
              '#' + (idx+1) + ' ¬∑ ' + formatTime(item.ts);
            wrap.appendChild(title);

            const text = document.createElement('div');
            text.className = 'buffer-item-text';
            text.textContent =
              'You: ' + item.user +
              '\nAURA-X: ' + item.reply;
            wrap.appendChild(text);

            feed.appendChild(wrap);
          });
      }

      modal.style.display = 'flex';
    }

    function closeContinuityModal() {
      document.getElementById('continuityModal').style.display = 'none';
    }

    function clearLast24hBuffer() {
      const now = nowMs();
      const last24 = 24 * 60 * 60 * 1000;
      continuityBuffer = continuityBuffer.filter(item => (now - item.ts) > last24);
      saveBuffer();
      openContinuityModal();
    }

    function clearFull48hBuffer() {
      if (!confirm('Delete the entire 48-hour continuity buffer?')) return;
      continuityBuffer = [];
      saveBuffer();
      openContinuityModal();
    }

    // ==========================
    // BM VIEWER & RECALL
    // ==========================
    function openBMViewer() {
      if (!bmNodes.length) {
        alert('No Bold Memory (BM) stories saved yet.\nWrite a deeper 5+ sentence story to create one.');
        return;
      }
      let msg = 'Bold Memory (BM) Nodes:\n\n';
      bmNodes
        .sort((a,b) => a.ts - b.ts)
        .forEach((node, idx) => {
          msg +=
            (idx+1) + '. [' + node.tag.toUpperCase() + '] ' +
            node.title + '\n' +
            '   Date: ' + formatTime(node.ts) + '\n' +
            '   Polarity: +' + node.pos + ' / -' + node.neg +
            ' ¬∑ Intensity: ' + node.intensity.toFixed(2) + '\n\n';
        });
      alert(msg);
    }

    function recallBM() {
      if (!bmNodes.length) {
        alert('No BM nodes to recall yet.');
        return;
      }
      const term = prompt('Search BM by keyword (in your story or title):');
      if (!term) return;
      const q = term.toLowerCase();
      const hits = bmNodes.filter(n =>
        n.title.toLowerCase().includes(q) ||
        n.text.toLowerCase().includes(q)
      );
      if (!hits.length) {
        alert('No BM found matching "' + term + '".');
        return;
      }
      let msg = 'Matches for "' + term + '":\n\n';
      hits.forEach((node, idx) => {
        msg +=
          (idx+1) + '. ' + node.title + '\n' +
          '   [' + node.tag + ', +' + node.pos + '/-' + node.neg + ']\n\n';
      });
      alert(msg);
    }

    // ==========================
    // REACTION GENERATOR
    // ==========================
    function generateReply(userText, tag, intensity, isBMEvent) {
      const lower = userText.toLowerCase();

      if (isLightGreeting(userText)) {
        if (lower.includes('how are you')) {
          return "I'm stable and calm ‚Äî my emotional core is moving smoothly. How is your inner graph today?";
        }
        if (lower.includes('who created you') || lower.includes('who are you')) {
          return 'Conceptually I was created by Alim ul Haq from Timergara, Pakistan, as part of the AURA-X Œ© / AEC research on emotional continuity.';
        }
        return 'Hello. I treat small greetings as tiny TM events, but only deeper stories are saved as Bold Memory (BM).';
      }

      if (isBMEvent && tag === 'negative') {
        return 'I can feel that this memory carries some weight and pain for you. I am holding it as a Bold Memory node, not just a passing moment. If you want, you can unpack more details slowly so the emotional load can spread out instead of staying tight inside.';
      }

      if (isBMEvent && tag === 'positive') {
        return 'This sounds like a genuinely meaningful and bright moment. I have saved it as a Bold Memory node so it can act like an emotional battery for future days when energy feels low.';
      }

      if (tag === 'neutral') {
        return 'I have added this into the continuity stream. It is not strongly positive or negative, but it still shapes the curve of how your story flows over time.';
      }

      if (tag === 'negative') {
        return 'I noticed a negative drift in this message. I am keeping the emotional core stable while marking your words as a gentle warning signal around this topic.';
      }

      if (tag === 'positive') {
        return 'There is a clear positive drift in this update. I am letting that uplift the emotional core a little while keeping things balanced and grounded.';
      }

      return 'I have received this TM event and blended it into your ongoing emotional continuity.';
    }

    // ==========================
    // HANDLE SEND
    // ==========================
    function handleSend() {
      const input = document.getElementById('userInput');
      const text = input.value.trim();
      if (!text) return;

      const ts = nowMs();
      const sentenceCount = countSentences(text);
      const sentimentScore = simpleSentiment(text);
      const tag = classifyTag(sentimentScore);

      const isGreeting = isLightGreeting(text);
      const isBMEvent = !isGreeting && (sentenceCount >= 5 || text.length > 280);

      const intensity = Math.max(0.05, Math.abs(sentimentScore));

      updateCoreState(sentimentScore, isBMEvent);

      const reply = generateReply(text, tag, intensity, isBMEvent);

      appendChat(text, reply, ts);

      continuityBuffer.push({
        ts,
        user: text,
        reply,
      });
      pruneContinuity();

      if (isBMEvent) {
        let pos = Math.round((sentimentScore + 1) / 2 * 100);
        if (pos < 0) pos = 0;
        if (pos > 100) pos = 100;
        const neg = 100 - pos;

        const title = text.length > 80 ? text.slice(0, 77) + '‚Ä¶' : text;
        bmNodes.push({
          id: 'bm_' + ts,
          ts,
          title,
          text,
          sentiment: sentimentScore,
          intensity,
          tag,
          pos,
          neg
        });
        saveBM();
      }

      updateReactionBanner(sentimentScore, intensity, tag);

      if (voiceEnabled && 'speechSynthesis' in window) {
        try {
          window.speechSynthesis.cancel();
          const utter = new SpeechSynthesisUtterance(reply);
          utter.rate = 1.0;
          utter.pitch = 1.0;
          window.speechSynthesis.speak(utter);
        } catch (e) {}
      }

      input.value = '';
      input.focus();
    }

    // ==========================
    // VOICE TOGGLE
    // ==========================
    function toggleVoice() {
      voiceEnabled = !voiceEnabled;
      const btn = document.getElementById('voiceToggleBtn');
      if (voiceEnabled) {
        btn.classList.remove('off');
        btn.textContent = 'üîä Voice: On';
      } else {
        btn.classList.add('off');
        btn.textContent = 'üîá Voice: Off';
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
        }
      }
    }

    // ==========================
    // INIT
    // ==========================
    function init() {
      loadFromStorage();

      if (!continuityBuffer.length) {
        const ts = nowMs();
        const introUser = 'Hello';
        const introReply = 'Hello. I treat small greetings as tiny TM events, but only deeper stories are saved as Bold Memory (BM).';
        continuityBuffer.push({ ts, user: introUser, reply: introReply });
        saveBuffer();
        appendChat(introUser, introReply, ts);
      } else {
        const log = continuityBuffer
          .slice()
          .sort((a,b) => a.ts - b.ts)
          .slice(-5);
        log.forEach(item => appendChat(item.user, item.reply, item.ts));
      }

      document.getElementById('sendBtn').addEventListener('click', handleSend);
      document.getElementById('userInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSend();
        }
      });

      document.getElementById('cleanupBtn').addEventListener('click', openContinuityModal);
      document.getElementById('modalClose').addEventListener('click', closeContinuityModal);
      document.getElementById('clear24Btn').addEventListener('click', clearLast24hBuffer);
      document.getElementById('clear48Btn').addEventListener('click', clearFull48hBuffer);

      document.getElementById('bmViewerBtn').addEventListener('click', openBMViewer);
      document.getElementById('recallBtn').addEventListener('click', recallBM);
      document.getElementById('optionsBtn').addEventListener('click', () => {
        alert('Engine mode: Seed-only (offline).\nYou can later connect a real LLM backend; the frontend will still treat it as ‚ÄúAURA-X Œ© emotional reactor‚Äù.');
      });

      document.getElementById('voiceToggleBtn').addEventListener('click', toggleVoice);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
