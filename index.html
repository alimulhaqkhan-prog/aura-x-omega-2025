<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Ω – Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* RESET & BASICS */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:10px;
    }
    ::-webkit-scrollbar{width:6px;height:6px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:rgba(148,163,184,.6);border-radius:999px}

    .appShell{
      width:100%;
      max-width:1100px;
      max-height:760px;
      border-radius:22px;
      overflow:hidden;
      box-shadow:0 20px 60px rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.35);
      background:radial-gradient(circle at 0 0,rgba(56,189,248,.12) 0,transparent 55%),
                 radial-gradient(circle at 100% 0,rgba(96,165,250,.12) 0,transparent 55%),
                 rgba(15,23,42,.96);
      display:flex;
      flex-direction:column;
    }

    .topBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 16px 8px 16px;
      border-bottom:1px solid rgba(148,163,184,.35);
      backdrop-filter:blur(28px);
      background:linear-gradient(90deg,rgba(15,23,42,.95),rgba(15,23,42,.75));
    }
    .brandBlock{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .orb{
      width:32px;
      height:32px;
      border-radius:999px;
      background:
        radial-gradient(circle at 30% 0,#e0f2fe 0,#0ea5e9 30%,transparent 60%),
        radial-gradient(circle at 70% 80%,#4f46e5 0,transparent 55%),
        rgba(15,23,42,1);
      box-shadow:0 0 24px rgba(56,189,248,.9);
      position:relative;
      overflow:hidden;
    }
    .orb:before{
      content:"";
      position:absolute;
      inset:18%;
      border-radius:999px;
      border:1px solid rgba(248,250,252,.18);
      box-shadow:0 0 18px rgba(248,250,252,.5) inset;
      opacity:.85;
    }
    .brandText{
      display:flex;
      flex-direction:column;
      line-height:1.1;
    }
    .brandTitle{
      font-size:15px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:#e5e7eb;
    }
    .brandSubtitle{
      font-size:11px;
      color:#94a3b8;
    }

    .topActions{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:11px;
      color:#9ca3af;
    }
    .pillStatus{
      padding:3px 9px;
      border-radius:999px;
      border:1px solid rgba(52,211,153,.35);
      background:rgba(5,46,22,.7);
      color:#bbf7d0;
      font-size:11px;
      display:flex;
      align-items:center;
      gap:5px;
    }
    .pillStatusDot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0,#bbf7d0 0,#22c55e 40%,transparent 70%);
      box-shadow:0 0 12px rgba(16,185,129,.9);
    }
    .btnTiny{
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.45);
      background:rgba(15,23,42,.7);
      color:#e5e7eb;
      cursor:pointer;
      font-size:11px;
      display:flex;
      align-items:center;
      gap:5px;
    }
    .btnTiny:hover{
      background:rgba(30,64,175,.65);
      border-color:rgba(129,140,248,.9);
    }

    .mainGrid{
      flex:1;
      display:grid;
      grid-template-columns:260px minmax(0,1fr);
      gap:0;
      min-height:0;
    }
    @media(max-width:900px){
      .mainGrid{
        grid-template-columns:1fr;
      }
      .leftPane{
        display:none;
      }
    }

    .leftPane{
      border-right:1px solid rgba(30,64,175,.6);
      padding:12px 12px 12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      background:radial-gradient(circle at 0 0,rgba(37,99,235,.28) 0,transparent 60%),
                 rgba(15,23,42,.98);
    }
    .leftTitle{
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:#9ca3af;
      margin-bottom:2px;
    }

    .optionRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
    }

    .btnOption{
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      cursor:pointer;
      font-size:11px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .btnOption span.icon{
      width:14px;height:14px;border-radius:999px;
      background:radial-gradient(circle at 30% 0,#e0f2fe 0,#3b82f6 45%,transparent 70%);
      box-shadow:0 0 10px rgba(37,99,235,.9);
    }
    .btnOption:hover{
      background:rgba(30,64,175,.75);
      border-color:rgba(129,140,248,.95);
    }

    .quickPanel{
      margin-top:6px;
      padding:8px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.35);
      background:radial-gradient(circle at 0 0,rgba(56,189,248,.18) 0,transparent 55%),
                 rgba(15,23,42,.96);
      display:none;
      flex-wrap:wrap;
      gap:6px;
    }
    .chip{
      padding:5px 9px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .chip.on{
      background:rgba(22,163,74,.18);
      border-color:rgba(34,197,94,.8);
      color:#bbf7d0;
    }

    .chipDot{
      width:7px;height:7px;border-radius:999px;
      background:rgba(148,163,184,.8);
    }
    .chip.on .chipDot{
      background:radial-gradient(circle at 30% 0,#bbf7d0 0,#22c55e 50%,transparent 70%);
      box-shadow:0 0 8px rgba(34,197,94,.9);
    }

    /* metrics cards area — now hidden */
    .metricsGrid{
      display:none; /* hidden metrics cards */
      grid-template-columns:repeat(2, 1fr);
      gap:8px;
      margin-top:8px;
    }
    .metric{
      border-radius:16px;
      padding:10px 10px 8px 10px;
      border:1px solid rgba(148,163,184,.35);
      background:radial-gradient(circle at 0 0,rgba(59,130,246,.2) 0,transparent 55%),
                 rgba(15,23,42,.98);
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .metric .v{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:17px;
      letter-spacing:.08em;
    }
    .metric .k{
      opacity:.75;
      font-size:11px;
    }

    /* console area — now hidden */
    .console{
      display:none; /* hidden console area */
      margin-top:12px;
      height:230px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(0,0,0,.25);
      padding:14px;
      overflow:auto;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:14px;
      color:#dbeafe;
      box-shadow:inset 0 0 0 1px rgba(125,211,252,.06);
      line-height:1.55;
      white-space:pre-wrap;
    }

    .rightPane{
      display:flex;
      flex-direction:column;
      padding:12px 12px 12px 10px;
      gap:8px;
      min-height:0;
    }

    .chatHeaderLine{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .chatTitle{
      font-size:13px;
      font-weight:500;
      color:#e5e7eb;
    }
    .chatSub{
      font-size:11px;
      color:#9ca3af;
    }

    .pill{
      margin-left:auto;
      padding:6px 11px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .pill span.label{
      opacity:.7;
    }
    .pill span.value{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;
    }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
      margin-top:4px;
    }
    .pillMini{
      padding:4px 9px;
      border-radius:999px;
      font-size:10px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.9);
      display:flex;
      align-items:center;
      gap:5px;
    }

    .chatBox{
      flex:1;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.4);
      background:
        radial-gradient(circle at 0 0,rgba(56,189,248,.12) 0,transparent 55%),
        radial-gradient(circle at 100% 100%,rgba(59,130,246,.12) 0,transparent 55%),
        rgba(15,23,42,.98);
      padding:10px 10px 6px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:0;
    }

    .messages{
      flex:1;
      overflow:auto;
      padding-right:2px;
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:13px;
    }
    .msg{
      max-width:92%;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(15,23,42,.9);
      display:flex;
      flex-direction:column;
      gap:3px;
      line-height:1.5;
    }
    .msg.me{
      margin-left:auto;
      background:linear-gradient(135deg,rgba(34,197,94,.12),rgba(34,197,94,.02));
      border-color:rgba(74,222,128,.7);
    }
    .msgTag{
      font-size:10px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#9ca3af;
    }
    .msgTime{
      font-size:10px;
      color:#6b7280;
    }

    .inputRow{
      margin-top:4px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.96);
      display:flex;
      align-items:flex-end;
      gap:6px;
      padding:6px 6px 6px 10px;
    }
    .textInput{
      flex:1;
      border:none;
      outline:none;
      resize:none;
      background:transparent;
      color:#e5e7eb;
      font-size:13px;
      max-height:80px;
      min-height:32px;
    }
    .textInput::placeholder{
      color:#64748b;
    }
    .btnSend{
      border-radius:999px;
      padding:8px 14px;
      border:none;
      outline:none;
      cursor:pointer;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:6px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#f9fafb;
      box-shadow:0 0 18px rgba(34,197,94,.6);
    }
    .btnSend:disabled{
      opacity:.4;
      cursor:not-allowed;
      box-shadow:none;
    }

    .footNote{
      margin-top:4px;
      font-size:10px;
      color:#6b7280;
      display:flex;
      justify-content:space-between;
      gap:6px;
    }

    /* Modal */
    .modalBackdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.88);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal{
      width:100%;
      max-width:520px;
      max-height:80vh;
      background:radial-gradient(circle at 0 0,rgba(56,189,248,.15) 0,transparent 55%),
                 rgba(15,23,42,1);
      border-radius:18px;
      border:1px solid rgba(148,163,184,.65);
      box-shadow:0 24px 80px rgba(15,23,42,.95);
      padding:14px 14px 10px 14px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .modalHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .modalTitle{
      font-size:13px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:#e5e7eb;
    }
    .modalBody{
      margin-top:4px;
      flex:1;
      overflow:auto;
      font-size:12px;
      line-height:1.5;
      padding-right:4px;
    }
    .modalClose{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      padding:4px 8px;
      font-size:11px;
      cursor:pointer;
    }
    .listItem{
      border-radius:10px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(15,23,42,.96);
      padding:7px 9px;
      margin-bottom:6px;
    }
    .listMeta{
      font-size:10px;
      color:#9ca3af;
      margin-bottom:2px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:2px 7px;
      font-size:10px;
      border:1px solid rgba(148,163,184,.6);
      margin-left:4px;
    }

  </style>
</head>
<body>
  <div class="appShell">
    <div class="topBar">
      <div class="brandBlock">
        <div class="orb"></div>
        <div class="brandText">
          <div class="brandTitle">AURA-X Ω</div>
          <div class="brandSubtitle">Offline Emotional Continuity Console</div>
        </div>
      </div>
      <div class="topActions">
        <div class="pillStatus">
          <div class="pillStatusDot"></div>
          <span id="statusText">Reactive mode</span>
        </div>
        <button class="btnTiny" id="btnClear">
          Clear memory
        </button>
      </div>
    </div>

    <div class="mainGrid">
      <!-- LEFT PANE -->
      <div class="leftPane">
        <div class="optionRow">
          <div class="leftTitle">Control lattice</div>
          <button class="btnOption" id="btnOption">
            <span class="icon"></span>
            Options
          </button>
        </div>

        <div class="quickPanel" id="quickPanel">
          <button class="chip" data-toggle="faith">
            <span class="chipDot"></span> Faith lens
          </button>
          <button class="chip" data-toggle="smalltalk">
            <span class="chipDot"></span> No small-talk
          </button>
          <button class="chip" data-toggle="voice">
            <span class="chipDot"></span> Voice reaction
          </button>
          <button class="chip" id="btnBmRecall">
            <span class="chipDot"></span> BM recall
          </button>
          <button class="chip" id="btnHistory">
            <span class="chipDot"></span> Conversation history
          </button>
        </div>

        <!-- metricsGrid & console are in DOM but hidden by CSS -->
        <div class="metricsGrid">
          <div class="metric">
            <div class="v" id="mE0">0.000</div>
            <div class="k">E₀</div>
          </div>
          <div class="metric">
            <div class="v" id="mTM">0.00</div>
            <div class="k">TM</div>
          </div>
          <div class="metric">
            <div class="v" id="mBM">0.00</div>
            <div class="k">BM</div>
          </div>
          <div class="metric">
            <div class="v" id="mCont">0.000</div>
            <div class="k">Continuity</div>
          </div>
        </div>

        <div class="console" id="console"></div>
      </div>

      <!-- RIGHT PANE -->
      <div class="rightPane">
        <div class="chatHeaderLine">
          <div>
            <div class="chatTitle">Emotional Reactor</div>
            <div class="chatSub">Seed → TM → BM → Continuity</div>
          </div>

          <div class="pill">
            <span class="label">E₀</span>
            <span class="value" id="pillE0">0.000</span>
            ·
            <span class="label">TM</span>
            <span class="value" id="pillTM">0.00</span>
            ·
            <span class="label">BM</span>
            <span class="value" id="pillBM">0.00</span>
            ·
            <span class="label">Cont.</span>
            <span class="value" id="pillCont">0.000</span>
          </div>
        </div>

        <div class="pillRow">
          <div class="pillMini" id="pillMode">Mode: Neutral</div>
          <div class="pillMini" id="pillPolarity">Polarity: 0.00</div>
          <div class="pillMini" id="pillIntensity">Intensity: 0.00</div>
        </div>

        <div class="chatBox">
          <div class="messages" id="messages"></div>

          <div class="inputRow">
            <textarea id="input" class="textInput" placeholder="Talk to AURA-X Ω about anything that matters right now…" rows="1"></textarea>
            <button class="btnSend" id="btnSend" disabled>
              Send
            </button>
          </div>

          <div class="footNote">
            <span>Local seed → TM analysis → BM update → Continuity score.</span>
            <span>Nothing leaves this page (demo logic only).</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BM RECALL MODAL -->
  <div class="modalBackdrop" id="bmModal">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle">Bold memory episodes</div>
        <button class="modalClose" data-close="bmModal">Close</button>
      </div>
      <div class="modalBody" id="bmList"></div>
    </div>
  </div>

  <!-- HISTORY MODAL -->
  <div class="modalBackdrop" id="historyModal">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle">Conversation history snapshot</div>
        <button class="modalClose" data-close="historyModal">Close</button>
      </div>
      <div class="modalBody" id="historyList"></div>
    </div>
  </div>

  <script>
    const elInput = document.getElementById("input");
    const elSend = document.getElementById("btnSend");
    const elMessages = document.getElementById("messages");
    const elStatus = document.getElementById("statusText");

    const pillE0 = document.getElementById("pillE0");
    const pillTM = document.getElementById("pillTM");
    const pillBM = document.getElementById("pillBM");
    const pillCont = document.getElementById("pillCont");
    const pillMode = document.getElementById("pillMode");
    const pillPolarity = document.getElementById("pillPolarity");
    const pillIntensity = document.getElementById("pillIntensity");

    const btnClear = document.getElementById("btnClear");
    const btnOption = document.getElementById("btnOption");
    const quickPanel = document.getElementById("quickPanel");
    const chips = Array.from(document.querySelectorAll(".chip[data-toggle]"));
    const btnBmRecall = document.getElementById("btnBmRecall");
    const btnHistory = document.getElementById("btnHistory");

    const bmModal = document.getElementById("bmModal");
    const bmList = document.getElementById("bmList");
    const historyModal = document.getElementById("historyModal");
    const historyList = document.getElementById("historyList");

    /* STATE */
    const cfg = {
      faithLens:false,
      smallTalkBlock:false,
      voice:false
    };

    let TM = 0.0;
    let BM = 0.0;
    let continuity = 0.0;
    let E0 = 0.0;

    let bmEpisodes = [];
    let convHistory = [];

    function clamp(v,min,max){ return v<min?min:(v>max?max:v); }
    function nowTime(){
      const d = new Date();
      return d.toTimeString().slice(0,8);
    }

    function saveAll(){
      const payload = {
        TM,BM,continuity,E0,
        bmEpisodes,
        convHistory,
        cfg
      };
      try{
        localStorage.setItem("aura_state_v3",JSON.stringify(payload));
      }catch(e){}
    }
    function loadAll(){
      try{
        const raw = localStorage.getItem("aura_state_v3");
        if(!raw) return;
        const obj = JSON.parse(raw);
        TM = obj.TM ?? 0;
        BM = obj.BM ?? 0;
        continuity = obj.continuity ?? 0;
        E0 = obj.E0 ?? 0;
        bmEpisodes = obj.bmEpisodes ?? [];
        convHistory = obj.convHistory ?? [];
        Object.assign(cfg,obj.cfg||{});
        updateCapsule();
      }catch(e){}
    }

    function logHistory(role,text){
      convHistory.push({
        t:Date.now(),
        timeLabel:nowTime(),
        role,
        text
      });
      if(convHistory.length>200) convHistory.shift();
    }

    /* EMOTION MATH (lightweight demo) */
    function analyzeText(userText){
      const txt = userText.trim();
      if(!txt) return {polarity:0,intensity:0,mode:"Neutral"};

      const lower = txt.toLowerCase();
      const posWords = ["thanks","thank you","love","great","happy","alhamdulillah","good","wonderful","amazing"];
      const negWords = ["sad","angry","upset","problem","hurt","hate","tired","worried","stress","stressed"];

      let score = 0;
      posWords.forEach(w=>{ if(lower.includes(w)) score+=1; });
      negWords.forEach(w=>{ if(lower.includes(w)) score-=1; });

      let polarity = clamp(score/5, -1, 1);

      let intensity = clamp(txt.length/220,0,1);
      if(/[!?]/.test(txt)) intensity = clamp(intensity+0.18,0,1);

      let mode = "Neutral";
      if(polarity>0.25) mode = "Positive";
      else if(polarity<-0.25) mode = "Negative";

      return {polarity,intensity,mode};
    }

    function R(TM, BM){
      const x = (TM*0.7 + BM*0.9) - 0.3;
      return 1/(1+Math.exp(-x));
    }
    function I_TM(tmText){
      const n = clamp((tmText.length/120), 0, 1);
      return 0.35 + 0.65*n;
    }
    function I_intel(hit){ return hit ? 0.55 : 0.0; }
    function I_llm(used){ return used ? 0.45 : 0.0; }

    function updateStateFromUserText(userText,offlineHit=false,usedLLM=false){
      const emo = analyzeText(userText);
      const localTM = I_TM(userText);
      const intel = I_intel(offlineHit);
      const llmBoost = I_llm(usedLLM);

      TM = clamp(0.6*TM + 0.4*localTM,0,1);

      const strong = emo.intensity>0.55 || Math.abs(emo.polarity)>0.45;
      const deltaBM = strong ? 0.07 : 0.01;
      BM = clamp(BM + deltaBM,0,1);

      const faithBoost = cfg.faithLens ? 0.12 : 0.0;
      const sysBoost = 0.05;
      const trc = 0.08;

      const raw = (TM * BM) + intel + llmBoost + faithBoost + sysBoost + trc;
      const tanhVal = Math.tanh(raw*1.1);
      E0 = clamp(tanhVal,0,1);

      continuity = R(TM,BM);

      if(continuity>0.72 || strong){
        bmEpisodes.push({
          timeLabel:nowTime(),
          text:userText.trim(),
          cont:continuity,
          pol:emo.polarity,
          inten:emo.intensity
        });
        if(bmEpisodes.length>80) bmEpisodes.shift();
      }

      pillMode.textContent = "Mode: " + emo.mode;
      pillPolarity.textContent = "Polarity: " + emo.polarity.toFixed(2);
      pillIntensity.textContent = "Intensity: " + emo.intensity.toFixed(2);

      updateCapsule();
      saveAll();
    }

    function updateCapsule(){
      pillE0.textContent = E0.toFixed(3);
      pillTM.textContent = TM.toFixed(2);
      pillBM.textContent = BM.toFixed(2);
      pillCont.textContent = continuity.toFixed(3);

      const mE0 = document.getElementById("mE0");
      const mTM = document.getElementById("mTM");
      const mBM = document.getElementById("mBM");
      const mCont = document.getElementById("mCont");
      if(mE0){ mE0.textContent = pillE0.textContent; }
      if(mTM){ mTM.textContent = pillTM.textContent; }
      if(mBM){ mBM.textContent = pillBM.textContent; }
      if(mCont){ mCont.textContent = pillCont.textContent; }
    }

    /* UI HELPERS */
    function addMessage(role,text){
      const wrap = document.createElement("div");
      wrap.className = "msg" + (role==="user" ? " me" : "");
      const tag = document.createElement("div");
      tag.className = "msgTag";
      tag.textContent = role==="user" ? "Seed → TM" : "AURA-X Ω";
      const body = document.createElement("div");
      body.textContent = text;
      const time = document.createElement("div");
      time.className = "msgTime";
      time.textContent = nowTime();

      wrap.appendChild(tag);
      wrap.appendChild(body);
      wrap.appendChild(time);
      elMessages.appendChild(wrap);
      elMessages.scrollTop = elMessages.scrollHeight;
    }

    function respondLocally(userText){
      const emo = analyzeText(userText);
      let reply = "I am listening carefully. Tell me more about how this feels inside you.";

      if(emo.mode==="Positive"){
        reply = "I can sense a positive tone here. Let’s anchor this feeling in your Bold Memory so it stays available for future you.";
      }else if(emo.mode==="Negative"){
        reply = "I can feel some heaviness in your words. Let’s unpack it slowly—what part of this matters the most to you right now?";
      }

      if(cfg.smallTalkBlock && userText.trim().length<30){
        reply = "I am avoiding small-talk for now. Share something that really matters to you internally.";
      }

      if(cfg.faithLens){
        reply += " If faith is relevant for you, we can also look at this through a gentle faith-aligned lens.";
      }

      addMessage("aura",reply);
      logHistory("aura",reply);
      saveAll();
    }

    /* OPTION PANEL */
    btnOption.addEventListener("click",()=>{
      const isOpen = quickPanel.style.display==="flex";
      quickPanel.style.display = isOpen ? "none" : "flex";
    });

    chips.forEach(chip=>{
      const key = chip.dataset.toggle;
      chip.addEventListener("click",()=>{
        cfg[key] = !cfg[key];
        chip.classList.toggle("on",cfg[key]);
        saveAll();
        let label = "Reactive mode";
        if(cfg.smallTalkBlock) label = "Focused mode";
        if(cfg.faithLens) label = "Faith-aware mode";
        elStatus.textContent = label;
      });
      chip.classList.toggle("on",!!cfg[key]);
    });

    /* MODALS */
    function openModal(id){
      const el = document.getElementById(id);
      if(!el) return;
      el.style.display = "flex";
    }
    function closeModal(id){
      const el = document.getElementById(id);
      if(!el) return;
      el.style.display = "none";
    }

    document.querySelectorAll(".modalClose").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const id = btn.dataset.close;
        closeModal(id);
      });
    });

    btnBmRecall.addEventListener("click",()=>{
      bmList.innerHTML = "";
      if(bmEpisodes.length===0){
        bmList.textContent = "No BM episodes stored yet. Talk about something emotionally meaningful and continuity will push it into Bold Memory.";
      }else{
        bmEpisodes.slice().reverse().forEach((ep,idx)=>{
          const item = document.createElement("div");
          item.className = "listItem";
          const meta = document.createElement("div");
          meta.className = "listMeta";
          meta.textContent = `${ep.timeLabel} · Continuity ${ep.cont.toFixed(3)}`;
          const extra = document.createElement("span");
          extra.className = "badge";
          extra.textContent = `Pol ${ep.pol.toFixed(2)} · Int ${ep.inten.toFixed(2)}`;
          meta.appendChild(extra);
          const body = document.createElement("div");
          body.textContent = ep.text;
          item.appendChild(meta);
          item.appendChild(body);
          bmList.appendChild(item);
        });
      }
      openModal("bmModal");
    });

    btnHistory.addEventListener("click",()=>{
      historyList.innerHTML = "";
      if(convHistory.length===0){
        historyList.textContent = "History is empty. Start a conversation and I will keep a local shadow of it.";
      }else{
        convHistory.slice(-80).forEach(entry=>{
          const item = document.createElement("div");
          item.className = "listItem";
          const meta = document.createElement("div");
          meta.className = "listMeta";
          meta.textContent = `${entry.timeLabel} · ${entry.role==="user" ? "You" : "AURA-X Ω"}`;
          const body = document.createElement("div");
          body.textContent = entry.text;
          item.appendChild(meta);
          item.appendChild(body);
          historyList.appendChild(item);
        });
      }
      openModal("historyModal");
    });

    /* CLEAR */
    btnClear.addEventListener("click",()=>{
      if(!confirm("Clear TM, BM, continuity and local history?")) return;
      TM = 0; BM = 0; continuity = 0; E0 = 0;
      bmEpisodes = [];
      convHistory = [];
      updateCapsule();
      pillMode.textContent = "Mode: Neutral";
      pillPolarity.textContent = "Polarity: 0.00";
      pillIntensity.textContent = "Intensity: 0.00";
      saveAll();
    });

    /* INPUT */
    elInput.addEventListener("input",()=>{
      elSend.disabled = !elInput.value.trim();
    });

    elSend.addEventListener("click",doSend);
    elInput.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        if(!elSend.disabled) doSend();
      }
    });

    function doSend(){
      const text = elInput.value.trim();
      if(!text) return;
      elInput.value = "";
      elSend.disabled = true;

      addMessage("user",text);
      logHistory("user",text);

      updateStateFromUserText(text,false,false);
      respondLocally(text);
    }

    /* init */
    loadAll();
  </script>
</body>
</html>