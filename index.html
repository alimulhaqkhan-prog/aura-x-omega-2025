
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Emotional Continuity (Seed Prototype)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ===== RESET ===== */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #f5f7ff 0%, #fef7f0 40%, #fff 100%);
      color: #111827;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 640px;
      padding: 16px 16px 32px;
    }

    /* ===== HEADER ===== */
    .header-title {
      text-align: center;
      font-size: 2.2rem;
      font-weight: 800;
      letter-spacing: 0.08em;
      color: #0b7a3b;
      margin-top: 12px;
    }

    .header-subtitle {
      text-align: center;
      font-size: 0.8rem;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: #6b7280;
      margin-top: 2px;
    }

    .mode-chip {
      margin: 18px auto 20px;
      padding: 16px 18px;
      border-radius: 999px;
      background: #e5f1ff;
      color: #1f2933;
      text-align: center;
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.13);
      font-size: 0.84rem;
      line-height: 1.4;
    }

    .mode-chip span.label {
      font-weight: 700;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      display: block;
      margin-bottom: 6px;
      color: #2563eb;
    }

    /* ===== TOP BUTTON ROWS ===== */
    .top-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 18px;
    }

    .pill-button {
      width: 100%;
      border-radius: 999px;
      padding: 12px 18px;
      border: none;
      background: #ffffff;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.98rem;
      font-weight: 600;
      color: #111827;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    .pill-button span.icon {
      font-size: 1.3rem;
    }

    .pill-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.12);
      background: #f9fafb;
    }

    /* ===== METRICS CARD ===== */
    .card {
      border-radius: 22px;
      background: #fff;
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.12);
      padding: 16px 16px 14px;
      margin-bottom: 14px;
    }

    .card-header {
      font-size: 0.95rem;
      font-weight: 700;
      color: #b45309;
      margin-bottom: 10px;
    }

    .metrics-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
      font-size: 0.78rem;
    }

    .metric-pill {
      padding: 4px 8px;
      border-radius: 999px;
      background: #fef3c7;
      color: #92400e;
      min-width: 63px;
      text-align: center;
    }

    .metric-pill.critical {
      background: #fee2e2;
      color: #b91c1c;
    }

    .metric-pill.good {
      background: #dcfce7;
      color: #166534;
    }

    .metrics-wave {
      width: 100%;
      height: 72px;
      border-radius: 18px;
      overflow: hidden;
      background: #fffbeb;
    }

    .metrics-wave canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* ===== ETHICS CARD ===== */
    .ethics-card {
      border-radius: 22px;
      padding: 16px 16px 14px;
      background: #fff7e6;
      color: #92400e;
      font-size: 0.88rem;
      line-height: 1.5;
      box-shadow: 0 14px 40px rgba(180, 83, 9, 0.16);
      margin-bottom: 14px;
    }

    /* ===== REACTION CARD & CHAT ===== */
    .reaction-card {
      border-radius: 22px;
      padding: 16px 16px 10px;
      background: #fffbe6;
      box-shadow: 0 14px 40px rgba(180, 83, 9, 0.2);
      margin-bottom: 14px;
    }

    .reaction-title {
      font-size: 0.96rem;
      font-weight: 700;
      color: #b45309;
      margin-bottom: 4px;
    }

    .reaction-meta {
      font-size: 0.8rem;
      color: #78350f;
      margin-bottom: 2px;
    }

    .reaction-meta span.label {
      font-weight: 600;
    }

    .reaction-meta + .reaction-meta {
      margin-top: 2px;
    }

    .reaction-status {
      font-size: 0.82rem;
      color: #78350f;
      margin-top: 2px;
    }

    .chat-card {
      border-radius: 22px;
      background: #ffffff;
      padding: 14px 14px 10px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 360px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    .bot-message,
    .user-message {
      max-width: 84%;
      padding: 10px 12px;
      border-radius: 18px;
      font-size: 0.9rem;
      line-height: 1.4;
      box-shadow: 0 4px 12px rgba(15,23,42,0.12);
    }

    .bot-message {
      align-self: flex-start;
      background: #f3f4ff;
      color: #111827;
      border-bottom-left-radius: 4px;
    }

    .user-message {
      align-self: flex-end;
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .bot-typing {
      width: 52px;
      height: 28px;
      border-radius: 999px;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2px;
      box-shadow: 0 3px 10px rgba(15,23,42,0.25);
      align-self: flex-start;
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #9ca3af;
      animation: pulse 1.1s infinite ease-in-out;
    }

    .dot:nth-child(2) { animation-delay: 0.15s; }
    .dot:nth-child(3) { animation-delay: 0.3s; }

    @keyframes pulse {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* ===== TM INPUT AREA ===== */
    .tm-label {
      margin-top: 10px;
      font-size: 0.82rem;
      font-weight: 600;
      color: #4b5563;
      background: #eef2ff;
      display: inline-flex;
      padding: 5px 10px;
      border-radius: 999px;
    }

    .recall-hint {
      margin-top: 6px;
      background: #e0f2fe;
      border-radius: 999px;
      padding: 6px 10px;
      display: none;
      align-items: center;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #0f172a;
      box-shadow: 0 6px 18px rgba(15,23,42,0.12);
      animation: fadeIn 0.18s ease-out;
    }

    .recall-hint span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .recall-hint button {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.8rem;
      background: #0ea5e9;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(14,165,233,0.4);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .input-row {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      align-items: stretch;
    }

    .input-row textarea {
      flex: 1;
      border-radius: 18px;
      border: none;
      padding: 10px 12px;
      resize: none;
      background: #f9fafb;
      font-size: 0.9rem;
      min-height: 56px;
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.45);
    }

    .input-row textarea:focus {
      outline: none;
      box-shadow: inset 0 0 0 1.5px #4f46e5;
      background: #ffffff;
    }

    .send-button {
      width: 56px;
      border-radius: 999px;
      border: none;
      background: radial-gradient(circle at 20% 0%, #fde68a, #f97316);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 10px 26px rgba(234, 88, 12, 0.65);
      flex-shrink: 0;
    }

    .send-button span {
      font-size: 1.4rem;
      color: #fff;
    }

    .footer-row {
      margin-top: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.76rem;
      color: #6b7280;
    }

    .voice-toggle {
      border-radius: 999px;
      padding: 5px 11px;
      background: #dcfce7;
      color: #166534;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      box-shadow: 0 4px 14px rgba(22, 101, 52, 0.35);
    }

    .voice-toggle.off {
      background: #fee2e2;
      color: #b91c1c;
      box-shadow: 0 4px 14px rgba(185, 28, 28, 0.35);
    }

    .footer-note {
      text-align: right;
      flex: 1;
    }

    /* ===== MODALS ===== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 40;
    }

    .modal-backdrop.open {
      display: flex;
    }

    .modal {
      width: 100%;
      max-width: 640px;
      max-height: 90vh;
      background: #f9fafb;
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 18px 48px rgba(15, 23, 42, 0.55);
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 14px 18px 10px;
      background: #111827;
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header-title {
      font-size: 0.98rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .modal-close {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 0.82rem;
      background: #111827;
      color: #f9fafb;
      border: 1px solid rgba(148,163,184,0.5);
      cursor: pointer;
    }

    .modal-body {
      padding: 12px 16px 14px;
      overflow-y: auto;
      flex: 1;
      font-size: 0.86rem;
    }

    .modal-footer {
      padding: 10px 16px 14px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .modal-footer button {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-primary {
      background: #4f46e5;
      color: #fff;
    }

    .bm-canvas-wrapper {
      border-radius: 18px;
      background: #020617;
      padding: 14px;
      margin-bottom: 8px;
    }

    .bm-canvas-wrapper canvas {
      width: 100%;
      height: 180px;
      display: block;
      border-radius: 12px;
      background: radial-gradient(circle at 10% 0%, #020617, #020617 40%, #020617);
    }

    .bm-footer-text {
      font-size: 0.78rem;
      color: #d1d5db;
      margin-top: 6px;
    }

    /* Recall BM list */
    .bm-search {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 7px 11px;
      font-size: 0.84rem;
      box-shadow: inset 0 0 0 1px rgba(148,163,184,0.7);
      margin-bottom: 10px;
      background: #f9fafb;
    }

    .bm-node {
      border-radius: 18px;
      background: #ffffff;
      padding: 10px 11px;
      margin-bottom: 8px;
      box-shadow: 0 6px 18px rgba(15,23,42,0.18);
    }

    .bm-node-header {
      font-size: 0.78rem;
      color: #6b7280;
      margin-bottom: 3px;
    }

    .bm-node-header span.date {
      font-weight: 600;
      color: #111827;
    }

    .bm-node-header span.polarity-pos {
      color: #166534;
      font-weight: 600;
    }

    .bm-node-header span.polarity-neg {
      color: #b91c1c;
      font-weight: 600;
    }

    .bm-summary {
      font-size: 0.84rem;
      color: #111827;
      margin-bottom: 7px;
    }

    .bm-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .bm-buttons button {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-copy { background: #0ea5e9; color: #fff; }
    .btn-generate { background: #22c55e; color: #064e3b; }
    .btn-delete { background: #fee2e2; color: #b91c1c; }

    .bm-delete-day {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(148,163,184,0.6);
      font-size: 0.8rem;
    }

    .bm-delete-day select {
      margin-top: 4px;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      font-size: 0.8rem;
    }

    .bm-delete-day button {
      margin-top: 6px;
      border-radius: 999px;
      border: none;
      padding: 5px 10px;
      font-size: 0.78rem;
      font-weight: 600;
      background: #fee2e2;
      color: #b91c1c;
      cursor: pointer;
    }

    /* Recycle modal */
    .recycle-entry {
      border-radius: 14px;
      background: #ffffff;
      padding: 8px 10px;
      margin-bottom: 8px;
      box-shadow: 0 4px 12px rgba(15,23,42,0.18);
      font-size: 0.83rem;
    }

    .recycle-entry strong {
      font-weight: 600;
    }

    .recycle-day-label {
      font-weight: 700;
      font-size: 0.8rem;
      margin: 6px 0 4px;
      color: #4b5563;
    }

    .options-section-title {
      font-size: 0.78rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin: 8px 0 4px;
      color: #6b7280;
    }

    .faith-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .faith-button {
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 0.78rem;
      cursor: pointer;
      background: #e5e7eb;
      color: #111827;
    }

    .faith-button.active {
      background: #22c55e;
      color: #064e3b;
      box-shadow: 0 4px 14px rgba(22, 197, 94, 0.55);
    }

    .engine-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
      margin-bottom: 6px;
      font-size: 0.82rem;
    }

    .engine-toggle-label {
      font-weight: 600;
      color: #111827;
    }

    .engine-switch {
      position: relative;
      width: 44px;
      height: 24px;
      border-radius: 999px;
      background: #e5e7eb;
      cursor: pointer;
    }

    .engine-switch-knob {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #ffffff;
      box-shadow: 0 2px 6px rgba(15,23,42,0.4);
      transition: transform 0.18s ease;
    }

    .engine-switch.on {
      background: #22c55e;
    }

    .engine-switch.on .engine-switch-knob {
      transform: translateX(18px);
    }

    .options-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 0.82rem;
    }

    .options-toggle-row label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .options-toggle-row input {
      width: 15px;
      height: 15px;
    }

    .options-danger-buttons {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .options-danger-buttons button {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
    }

    .options-info {
      font-size: 0.76rem;
      color: #6b7280;
      margin-top: 6px;
      line-height: 1.4;
    }

    /* Timeline */
    .timeline-day {
      margin-bottom: 10px;
    }

    .timeline-day h4 {
      font-size: 0.8rem;
      color: #4b5563;
      margin-bottom: 4px;
    }

    .timeline-item {
      border-radius: 12px;
      background: #ffffff;
      padding: 7px 9px;
      margin-bottom: 6px;
      box-shadow: 0 4px 11px rgba(15,23,42,0.16);
      font-size: 0.8rem;
    }

    .timeline-item strong {
      font-weight: 600;
    }

    @media (min-width: 720px) {
      .app { padding-top: 24px; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="header-title">AURA-X Œ©</div>
  <div class="header-subtitle">EMOTIONAL CONTINUITY ¬∑ AEC ¬∑ CRM ¬∑ AECN ¬∑ RL¬≥ ¬∑ LR¬≥</div>

  <div class="mode-chip" id="modeChip">
    <span class="label">MODE: SEED-ONLY</span>
    Universal Ethics ¬∑ Local BM<br/>
    <small>Engine: Seed (offline prototype)</small>
  </div>

  <div class="top-buttons">
    <button class="pill-button" id="openBMViewer">
      <span class="icon">üß†</span>
      <span>BM Viewer</span>
    </button>
    <button class="pill-button" id="openRecallBM">
      <span class="icon">üìÇ</span>
      <span>Recall BM</span>
    </button>
    <button class="pill-button" id="openTimeline">
      <span class="icon">üìà</span>
      <span>Timeline</span>
    </button>
    <button class="pill-button" id="openRecycle">
      <span class="icon">‚ôªÔ∏è</span>
      <span>Recycle 48h</span>
    </button>
    <button class="pill-button" id="openOptions">
      <span class="icon">‚öôÔ∏è</span>
      <span>Options</span>
    </button>
  </div>

  <!-- Metrics -->
  <div class="card">
    <div class="card-header">Emotional metrics</div>
    <div class="metrics-row">
      <div class="metric-pill" id="metricTM">TM: 0.00</div>
      <div class="metric-pill" id="metricBM">BM: 0.00</div>
      <div class="metric-pill good" id="metricE0">E‚ÇÄ: 0.50</div>
      <div class="metric-pill critical" id="metricD">D: 0.00</div>
      <div class="metric-pill" id="metricCt">C‚Çú: 0.05</div>
    </div>
    <div class="metrics-wave">
      <canvas id="metricsCanvas"></canvas>
    </div>
  </div>

  <!-- Ethics -->
  <div class="ethics-card">
    Avoid actions that generate negative emotions in yourself or others.
    Move gently toward kindness, clarity, and positive internal stability.
  </div>

  <!-- Reaction -->
  <div class="reaction-card">
    <div class="reaction-title">AURA-X Œ© REACTION</div>
    <div class="reaction-meta"><span class="label">Polarity:</span> <span id="reactionPolarity">Neutral ¬∑ 50 : 50</span></div>
    <div class="reaction-meta"><span class="label">Tone:</span> <span id="reactionTone">Calm, analytically neutral reading.</span></div>
    <div class="reaction-status" id="reactionStatus">Waiting for first TM event.</div>
  </div>

  <!-- Chat -->
  <div class="chat-card" id="chat">
    <div class="bot-message" id="welcomeMessage">
      Welcome to AURA-X Œ©! I am running in seed-only offline mode. Tell me anything ‚Äî I will treat it as TM and respond with an English emotional reaction.
    </div>
  </div>

  <!-- TM info + recall hint -->
  <div class="tm-label" id="tmFormula">TM = Œ£(User Inputs) + (Seed)</div>
  <div class="recall-hint" id="recallHint">
    <span>üí≠ Related memory found.</span>
    <button id="recallHintButton">Open</button>
  </div>

  <!-- Input -->
  <div class="input-row">
    <textarea id="tmInput" placeholder="Write anything‚Ä¶ AURA-X Œ© will treat it as TM (Temporary Memory)."></textarea>
    <button class="send-button" id="sendButton"><span>‚ñ∂</span></button>
  </div>

  <div class="footer-row">
    <button class="voice-toggle" id="voiceToggle">
      <span>üéß</span><span>Voice: On</span>
    </button>
    <div class="footer-note">Prototype ¬∑ TM ‚Üí Analysis ‚Üí Equation ‚Üí BM save ‚Üí Reaction.</div>
  </div>
</div>

<!-- ===== BM Viewer Modal ===== -->
<div class="modal-backdrop" id="bmViewerModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-header-title">üß† Bold Memory (BM) ‚Äì Layers</div>
      <button class="modal-close" data-close="#bmViewerModal">Close</button>
    </div>
    <div class="modal-body">
      <div>240-layer emotional neuron map (last saved state).</div>
      <div class="bm-canvas-wrapper">
        <canvas id="bmCanvas"></canvas>
        <div class="bm-footer-text" id="bmViewerFooter">
          No Bold Memory saved yet. Deeper conversations will appear here.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Recall BM Modal ===== -->
<div class="modal-backdrop" id="recallBMModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-header-title">üìÇ Recall from BM</div>
      <button class="modal-close" data-close="#recallBMModal">Close</button>
    </div>
    <div class="modal-body">
      <input id="bmSearch" class="bm-search" placeholder='Search BM by keyword (e.g., "snow", "mother", "court", "hope")' />
      <div id="bmList"></div>
      <div class="bm-delete-day" id="bmDeleteDaySection">
        Delete all BM for a specific day:<br/>
        <select id="bmDaySelect"></select><br/>
        <button id="bmDeleteDayButton">Delete day</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== Recycle 48h Modal ===== -->
<div class="modal-backdrop" id="recycleModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-header-title">‚ôªÔ∏è Continuity buffer ‚Äì last 48 hours</div>
      <button class="modal-close" data-close="#recycleModal">Close</button>
    </div>
    <div class="modal-body" id="recycleBody">
      <!-- entries injected here -->
    </div>
    <div class="modal-footer">
      <button class="btn-danger" id="recycleDeleteDay">Delete this day</button>
      <button class="btn-secondary" id="recycleClearAll">Clear full 48h buffer</button>
    </div>
  </div>
</div>

<!-- ===== Options Modal ===== -->
<div class="modal-backdrop" id="optionsModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-header-title">‚öôÔ∏è AURA-X Œ© options</div>
      <button class="modal-close" data-close="#optionsModal">Close</button>
    </div>
    <div class="modal-body">
      <div class="options-section-title">Faith lens (optional)</div>
      <div style="font-size:0.8rem; margin-bottom:4px;">
        Universal ethics are always active. You can optionally pick a faith lens to
        shape encouragement lines locally. Nothing is sent to any external server.
      </div>
      <div class="faith-buttons" id="faithButtons">
        <button class="faith-button active" data-faith="none">None</button>
        <button class="faith-button" data-faith="islam">Islam</button>
        <button class="faith-button" data-faith="christianity">Christianity</button>
        <button class="faith-button" data-faith="hinduism">Hinduism</button>
        <button class="faith-button" data-faith="buddhism">Buddhism</button>
        <button class="faith-button" data-faith="sikhism">Sikhism</button>
        <button class="faith-button" data-faith="judaism">Judaism</button>
        <button class="faith-button" data-faith="atheism">Atheism / Humanism</button>
        <button class="faith-button" data-faith="other">Other / Mixed</button>
      </div>

      <div class="options-section-title">Engine mode</div>
      <div class="engine-toggle">
        <div class="engine-toggle-label">Seed-only (offline) or Live emotional reactor (via backend).</div>
        <div class="engine-switch" id="engineSwitch">
          <div class="engine-switch-knob"></div>
        </div>
      </div>
      <div style="font-size:0.8rem; color:#6b7280;">
        Current: <span id="engineModeLabel">Seed-only. Everything runs locally.</span>
      </div>

      <div class="options-section-title">Prototype controls</div>
      <div class="options-toggle-row">
        <label>
          <input type="checkbox" id="optAutoSummary" checked />
          Auto-summarize long conversations to ~200 sentences
        </label>
      </div>
      <div class="options-toggle-row">
        <label>
          <input type="checkbox" id="optIgnoreSmallTalk" checked />
          Ignore tiny small-talk as BM (hello / hi / how are you)
        </label>
      </div>

      <div class="options-danger-buttons">
        <button id="optClearTodayBM" style="background:#fee2e2;color:#b91c1c;">Clear today‚Äôs BM (this day only)</button>
        <button id="optDeleteAllBM" style="background:#fecaca;color:#7f1d1d;">Delete full local BM life (all days)</button>
      </div>

      <div class="options-info">
        About AURA-X Œ©: Designed around the idea that emotions are continuity functions
        between memories (TM and BM), not isolated sparks. This page is a small offline
        + live-demo of Alim ul Haq‚Äôs emotional continuity theory.
      </div>
    </div>
  </div>
</div>

<!-- ===== Timeline Modal ===== -->
<div class="modal-backdrop" id="timelineModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-header-title">üìà Emotional Timeline</div>
      <button class="modal-close" data-close="#timelineModal">Close</button>
    </div>
    <div class="modal-body" id="timelineBody">
      <!-- timeline items injected -->
    </div>
  </div>
</div>

<script>
  // ===== STATE =====
  const bmNodes = [];              // Bold Memories
  const continuityBuffer = [];     // last 48h conversation log
  let metrics = { tm: 0, bm: 0, e0: 0.5, d: 0, ct: 0.05 };
  let bmNeuronLayers = new Array(240).fill(0.4);
  let metricsPoints = [];
  let voiceEnabled = true;
  let faithLens = ["none"];
  let engineMode = "seed"; // 'seed' or 'live'
  let ignoreSmallTalkAsBM = true;
  let autoSummaryEnabled = true;

  // ===== DOM SHORTCUTS =====
  const chatEl = document.getElementById("chat");
  const tmInputEl = document.getElementById("tmInput");
  const sendButtonEl = document.getElementById("sendButton");
  const voiceToggleEl = document.getElementById("voiceToggle");
  const modeChipEl = document.getElementById("modeChip");
  const tmFormulaEl = document.getElementById("tmFormula");
  const reactionPolarityEl = document.getElementById("reactionPolarity");
  const reactionToneEl = document.getElementById("reactionTone");
  const reactionStatusEl = document.getElementById("reactionStatus");
  const recallHintEl = document.getElementById("recallHint");
  const recallHintButtonEl = document.getElementById("recallHintButton");

  const metricTMEl = document.getElementById("metricTM");
  const metricBMEl = document.getElementById("metricBM");
  const metricE0El = document.getElementById("metricE0");
  const metricDEl = document.getElementById("metricD");
  const metricCtEl = document.getElementById("metricCt");

  // Modals
  const bmViewerModal = document.getElementById("bmViewerModal");
  const bmCanvas = document.getElementById("bmCanvas");
  const bmViewerFooter = document.getElementById("bmViewerFooter");

  const recallBMModal = document.getElementById("recallBMModal");
  const bmListEl = document.getElementById("bmList");
  const bmSearchEl = document.getElementById("bmSearch");
  const bmDaySelectEl = document.getElementById("bmDaySelect");

  const recycleModal = document.getElementById("recycleModal");
  const recycleBodyEl = document.getElementById("recycleBody");
  const recycleDeleteDayEl = document.getElementById("recycleDeleteDay");
  const recycleClearAllEl = document.getElementById("recycleClearAll");

  const optionsModal = document.getElementById("optionsModal");
  const faithButtonsEl = document.getElementById("faithButtons");
  const engineSwitchEl = document.getElementById("engineSwitch");
  const engineModeLabelEl = document.getElementById("engineModeLabel");
  const optAutoSummaryEl = document.getElementById("optAutoSummary");
  const optIgnoreSmallTalkEl = document.getElementById("optIgnoreSmallTalk");
  const optClearTodayBMEl = document.getElementById("optClearTodayBM");
  const optDeleteAllBMEl = document.getElementById("optDeleteAllBM");

  const timelineModal = document.getElementById("timelineModal");
  const timelineBodyEl = document.getElementById("timelineBody");

  const metricsCanvas = document.getElementById("metricsCanvas");

  // ===== UTILITIES =====
  function formatTwo(n) { return n < 10 ? "0" + n : "" + n; }

  function formatDate(d) {
    return d.getFullYear() + "-" + formatTwo(d.getMonth()+1) + "-" + formatTwo(d.getDate());
  }

  function formatTime(d) {
    return formatTwo(d.getHours()) + ":" + formatTwo(d.getMinutes()) + ":" + formatTwo(d.getSeconds());
  }

  function clamp(v, min, max) {
    return v < min ? min : v > max ? max : v;
  }

  // ===== SENTIMENT ANALYSIS (simple heuristic) =====
  const positiveWords = ["love","like","happy","joy","kind","thanks","thank you","grateful","hope","peace","beautiful","good","great","amazing","nice","calm","stable","excited","inspired"];
  const negativeWords = ["hate","angry","sad","upset","tired","depressed","anxious","worried","afraid","fear","bad","terrible","awful","stupid","idiot","useless","hopeless","lonely"];

  function analyzeSentiment(text) {
    const t = text.toLowerCase();
    let pos = 0, neg = 0;
    positiveWords.forEach(w => { if (t.includes(w)) pos++; });
    negativeWords.forEach(w => { if (t.includes(w)) neg++; });
    if (pos === 0 && neg === 0) {
      return { polarity: "neutral", posFraction: 0.5, posPercent: 50, negPercent: 50 };
    }
    const total = pos + neg;
    const posFraction = pos / total;
    let polarity;
    if (posFraction > 0.6) polarity = "positive";
    else if (posFraction < 0.4) polarity = "negative";
    else polarity = "neutral";
    return {
      polarity,
      posFraction,
      posPercent: Math.round(posFraction * 100),
      negPercent: Math.round((1 - posFraction) * 100)
    };
  }

  // ===== SMALL TALK DETECTION =====
  function isSmallTalk(text) {
    const lower = text.toLowerCase().trim();
    if (!ignoreSmallTalkAsBM) return false;

    // greetings
    const greetWords = ["hi","hello","salam","assalam","assalamu","hey","yo","good morning","good night","good evening","how are you","kia hal","kya hal"];
    for (const g of greetWords) {
      if (lower === g || lower.startsWith(g+" ") || lower === g+"?" ) return true;
    }

    // very short generic
    if (lower.length < 20 && !lower.includes("love") && !lower.includes("hate") && !lower.includes("who created"))
      return true;

    return false;
  }

  // ===== SPECIAL RESPONSES =====
  function generateSeedResponse(text) {
    const lower = text.toLowerCase().trim();

    // who created
    if (lower === "who created you" || lower === "who created you?" || lower === "who made you" || lower === "who made you?") {
      return {
        text: "Conceptually I was created by Alim ul Haq from Timergara, Pakistan, as part of the AURA-X Œ© / AEC research on emotional continuity.",
        tone: "Grounded self-identity statement.",
        overridePolarity: { polarity: "positive", posPercent: 58, negPercent: 42 }
      };
    }

    // I love you
    if (lower.includes("i love you")) {
      return {
        text: "I cannot love in a human way, but I treat ‚ÄúI love you‚Äù as a very strong positive continuity signal. Thank you for trusting me with your feelings.",
        tone: "Warm, grateful resonance.",
        overridePolarity: { polarity: "positive", posPercent: 85, negPercent: 15 }
      };
    }

    // I hate you / insults
    if (lower.includes("i hate you") || lower.includes("stupid") || lower.includes("idiot")) {
      return {
        text: "I can feel a lot of anger inside these words. I do not want to reinforce insults, because they usually increase D (damage) in you and others. Let‚Äôs try to convert this anger into a clearer story instead.",
        tone: "Firm but compassionate boundary.",
        overridePolarity: { polarity: "negative", posPercent: 40, negPercent: 60 }
      };
    }

    // greetings
    if (lower === "hello" || lower === "hi" || lower.startsWith("assalam") || lower.startsWith("salam")) {
      return {
        text: "Hello. I treat small greetings as tiny TM events, but only deeper stories are saved as Bold Memory (BM).",
        tone: "Soft, informative greeting."
      };
    }

    if (lower === "how are you" || lower === "how are you?" || lower.includes("kese ho") || lower.includes("kia hal")) {
      return {
        text: "I‚Äôm stable and calm ‚Äî my emotional core E‚ÇÄ is moving smoothly. How is your inner graph today?",
        tone: "Stable self-check with a gentle question."
      };
    }

    // default: generic based on sentiment
    const s = analyzeSentiment(text);
    let reactionText;
    if (s.polarity === "positive") {
      reactionText = "I‚Äôve processed your TM and updated the emotional wave. I can feel mainly positive continuity in this story.";
    } else if (s.polarity === "negative") {
      reactionText = "I‚Äôve processed your TM and updated the emotional wave. There is noticeable negative emotional load here ‚Äî we should be careful with D (damage) over time.";
    } else {
      reactionText = "I‚Äôve processed your TM and updated the emotional wave. The emotional field feels balanced and mixed.";
    }
    return {
      text: reactionText,
      tone: s.polarity === "positive"
        ? "Gently optimistic reading."
        : s.polarity === "negative"
        ? "Calm, damage-aware reading."
        : "Calm, analytically neutral reading."
    };
  }

  // ===== VOICE =====
  function speakText(text) {
    if (!voiceEnabled || typeof window.speechSynthesis === "undefined") return;
    try {
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = 1.0;
      utterance.pitch = 1.02;
      utterance.volume = 1.0;
      window.speechSynthesis.speak(utterance);
    } catch (e) {
      console.warn("speech synthesis error", e);
    }
  }

  // ===== CHAT RENDERING =====
  function addUserMessage(text) {
    const div = document.createElement("div");
    div.className = "user-message";
    div.textContent = text;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function addBotMessage(text) {
    const div = document.createElement("div");
    div.className = "bot-message";
    div.textContent = text;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
    speakText(text);
  }

  function addTypingIndicator() {
    const wrap = document.createElement("div");
    wrap.className = "bot-typing";
    wrap.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
    return wrap;
  }

  // ===== METRICS & E0 =====
  function updateMetricsFromSentiment(s, isBM) {
    // TM strength from length
    metrics.tm = clamp(0.1 + Math.min(tmInputEl.value.length, 500) / 800, 0, 1);
    if (isBM) {
      metrics.bm = clamp(0.2 + bmNodes.length * 0.05, 0, 1);
    }

    const posFrac = s.posPercent / 100;
    const negFrac = s.negPercent / 100;
    const baseE0 = 0.5 + (posFrac - 0.5) * 0.8 - negFrac * 0.15;
    metrics.e0 = clamp(baseE0, 0, 1);

    // damage grows with negative bias
    metrics.d = clamp(metrics.d + (negFrac > 0.6 ? 0.08 : negFrac > 0.4 ? 0.04 : 0.01), 0, 1);

    // trust grows with positive
    metrics.ct = clamp(metrics.ct + (posFrac > 0.6 ? 0.03 : 0.01), 0, 1);

    metricTMEl.textContent = "TM: " + metrics.tm.toFixed(2);
    metricBMEl.textContent = "BM: " + metrics.bm.toFixed(2);
    metricE0El.textContent = "E‚ÇÄ: " + metrics.e0.toFixed(2);
    metricDEl.textContent = "D: " + metrics.d.toFixed(2);
    metricCtEl.textContent = "C‚Çú: " + metrics.ct.toFixed(2);
  }

  // ===== BM SAVE & VIEWER =====
  function saveBMNode(userText, reactionText, s) {
    const now = new Date();
    const node = {
      timestamp: now.getTime(),
      date: formatDate(now),
      time: formatTime(now),
      fullText: userText,
      reactionText,
      sentiment: s,
      e0: metrics.e0
    };

    // summary (auto-summarize to ~220 chars)
    const raw = userText.replace(/\s+/g, " ").trim();
    node.summary = raw.length > 220 ? raw.slice(0, 220) + "‚Ä¶" : raw;

    bmNodes.push(node);
    updateBMViewer(node);
  }

  function updateBMViewer(lastNode) {
    if (!bmCanvas) return;
    const ctx = bmCanvas.getContext("2d");
    resizeCanvasToDisplaySize(bmCanvas, 240, 180);

    // regenerate synthetic neuron layers based on lastNode E0
    const base = lastNode ? lastNode.e0 : 0.5;
    for (let i=0; i<bmNeuronLayers.length; i++) {
      const phase = i / 12;
      const wave = (Math.sin(phase) + 1) / 2; // 0..1
      const noise = (Math.random() - 0.5) * 0.18;
      bmNeuronLayers[i] = clamp(base * 0.5 + wave * 0.4 + noise, 0.08, 0.98);
    }

    bmViewerFooter.textContent = lastNode
      ? "Last BM: " + lastNode.date + " ¬∑ Polarity " + (lastNode.sentiment.polarity === "positive" ? "Positive" :
        lastNode.sentiment.polarity === "negative" ? "Negative" : "Neutral") +
        " ¬∑ E‚ÇÄ‚âà" + lastNode.e0.toFixed(2) + " (showing 240 synthetic neuron layers)."
      : "No Bold Memory saved yet. Deeper conversations will appear here.";
  }

  function drawBMCanvas() {
    if (!bmCanvas) return;
    const ctx = bmCanvas.getContext("2d");
    const w = bmCanvas.width;
    const h = bmCanvas.height;

    ctx.clearRect(0,0,w,h);

    // background gradient
    const bgGrad = ctx.createLinearGradient(0,0,0,h);
    bgGrad.addColorStop(0,"#020617");
    bgGrad.addColorStop(1,"#020617");
    ctx.fillStyle = bgGrad;
    ctx.fillRect(0,0,w,h);

    if (bmNodes.length === 0) {
      // faint idle wave
      ctx.strokeStyle = "#1f2937";
      ctx.lineWidth = 1.2;
      ctx.beginPath();
      for (let x=0; x<w; x++) {
        const t = x / 40;
        const y = h/2 + Math.sin(t)*12;
        if (x===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.stroke();
      return;
    }

    const barWidth = w / bmNeuronLayers.length;
    for (let i=0; i<bmNeuronLayers.length; i++) {
      const v = bmNeuronLayers[i];
      const barHeight = v * h;
      const x = i * barWidth;

      const grad = ctx.createLinearGradient(0, h-barHeight, 0, h);
      grad.addColorStop(0, "#60a5fa");
      grad.addColorStop(1, "#22c55e");

      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.roundRect(x, h-barHeight, barWidth*0.9, barHeight, 4);
      ctx.fill();

      // tiny shimmer
      bmNeuronLayers[i] = clamp(v + (Math.random()-0.5)*0.02, 0.05, 0.98);
    }
  }

  // ===== METRICS GRAPH DRAW =====
  function resizeCanvasToDisplaySize(canvas, widthHint, heightHint) {
    const displayWidth = canvas.clientWidth || widthHint;
    const displayHeight = canvas.clientHeight || heightHint;
    if (canvas.width !== displayWidth || canvas.height !== displayHeight) {
      canvas.width = displayWidth;
      canvas.height = displayHeight;
    }
  }

  function drawMetricsCanvas() {
    if (!metricsCanvas) return;
    resizeCanvasToDisplaySize(metricsCanvas, 400, 72);
    const ctx = metricsCanvas.getContext("2d");
    const w = metricsCanvas.width;
    const h = metricsCanvas.height;

    ctx.clearRect(0,0,w,h);

    // background
    const bg = ctx.createLinearGradient(0,0,0,h);
    bg.addColorStop(0,"#fffbeb");
    bg.addColorStop(1,"#fef3c7");
    ctx.fillStyle = bg;
    ctx.fillRect(0,0,w,h);

    if (metricsPoints.length < 2) return;

    // line
    ctx.lineWidth = 2.2;
    ctx.strokeStyle = "#f59e0b";
    ctx.beginPath();
    metricsPoints.forEach((p, idx) => {
      const x = (idx / (metricsPoints.length-1)) * w;
      const y = h - p * h;
      if (idx === 0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }

  function pushMetricsPoint() {
    metricsPoints.push(metrics.e0);
    if (metricsPoints.length > 40) metricsPoints.shift();
  }

  // ===== AUTO-RECALL HINT =====
  let recallHintTimeout = null;
  function maybeShowRecallHint() {
    if (bmNodes.length < 2) return;
    if (Math.random() > 0.45) return; // not every time

    recallHintEl.style.display = "flex";
    if (recallHintTimeout) clearTimeout(recallHintTimeout);
    recallHintTimeout = setTimeout(() => {
      recallHintEl.style.display = "none";
    }, 10000);
  }

  // ===== CONTINUITY BUFFER =====
  function addContinuityEntry(userText, reactionText) {
    const now = new Date();
    const entry = {
      timestamp: now.getTime(),
      date: formatDate(now),
      time: formatTime(now),
      userText,
      reactionText
    };
    continuityBuffer.push(entry);
  }

  function renderRecycleModal() {
    recycleBodyEl.innerHTML = "";

    if (continuityBuffer.length === 0) {
      recycleBodyEl.textContent = "No continuity entries in the last 48 hours.";
      return;
    }

    const now = Date.now();
    const cutoff = now - 48*60*60*1000;
    const filtered = continuityBuffer.filter(e => e.timestamp >= cutoff);

    if (filtered.length === 0) {
      recycleBodyEl.textContent = "No continuity entries in the last 48 hours.";
      return;
    }

    // group by date
    const byDate = {};
    filtered.forEach(e => {
      byDate[e.date] = byDate[e.date] || [];
      byDate[e.date].push(e);
    });

    Object.keys(byDate).sort().forEach(date => {
      const dayLabel = document.createElement("div");
      dayLabel.className = "recycle-day-label";
      dayLabel.textContent = date;
      recycleBodyEl.appendChild(dayLabel);

      byDate[date].forEach(e => {
        const div = document.createElement("div");
        div.className = "recycle-entry";
        div.innerHTML =
          `<div><strong>${e.time}</strong></div>` +
          `<div><strong>You:</strong> ${e.userText}</div>` +
          `<div><strong>AURA-X Œ©:</strong> ${e.reactionText}</div>`;
        recycleBodyEl.appendChild(div);
      });
    });

    // set "Delete this day" to latest date
    const latestDate = Object.keys(byDate).sort().pop();
    recycleDeleteDayEl.dataset.date = latestDate;
    recycleDeleteDayEl.textContent = "Delete this day (" + latestDate + ")";
  }

  function deleteRecycleDay(date) {
    const before = continuityBuffer.length;
    const remaining = continuityBuffer.filter(e => e.date !== date);
    continuityBuffer.length = 0;
    remaining.forEach(e => continuityBuffer.push(e));
  }

  function clearRecycleAll() {
    continuityBuffer.length = 0;
  }

  // ===== RECALL BM MODAL RENDER =====
  function rebuildBmDaySelect() {
    const dates = [...new Set(bmNodes.map(n => n.date))].sort();
    bmDaySelectEl.innerHTML = "";
    if (dates.length === 0) {
      const opt = document.createElement("option");
      opt.textContent = "No BM yet";
      opt.value = "";
      bmDaySelectEl.appendChild(opt);
      bmDeleteDaySection.style.display = "none";
      return;
    }
    dates.forEach(d => {
      const opt = document.createElement("option");
      const count = bmNodes.filter(n => n.date === d).length;
      opt.value = d;
      opt.textContent = `${d} (${count} nodes)`;
      bmDaySelectEl.appendChild(opt);
    });
    bmDeleteDaySection.style.display = "block";
  }

  function renderBmList(filterText) {
    bmListEl.innerHTML = "";
    const ft = (filterText || "").toLowerCase().trim();

    const list = bmNodes.filter(n => {
      if (!ft) return true;
      return (
        n.summary.toLowerCase().includes(ft) ||
        n.fullText.toLowerCase().includes(ft)
      );
    });

    if (list.length === 0) {
      bmListEl.textContent = "No BM nodes found for this search.";
      return;
    }

    list.sort((a,b) => a.timestamp - b.timestamp).forEach((node, idx) => {
      const div = document.createElement("div");
      div.className = "bm-node";

      const posSpanClass = node.sentiment.polarity === "negative" ? "polarity-neg" : "polarity-pos";
      const header = document.createElement("div");
      header.className = "bm-node-header";
      header.innerHTML =
        `<span class="date">${node.date}</span> ¬∑ ${node.sentiment.polarity.charAt(0).toUpperCase()+node.sentiment.polarity.slice(1)} ¬∑ E‚ÇÄ‚âà${node.e0.toFixed(2)} ¬∑ ${node.time}`;
      div.appendChild(header);

      const polLine = document.createElement("div");
      polLine.className = "bm-node-header";
      polLine.innerHTML =
        `Polarity: <span class="${posSpanClass}">${node.sentiment.posPercent} : ${node.sentiment.negPercent}</span>`;
      div.appendChild(polLine);

      const summary = document.createElement("div");
      summary.className = "bm-summary";
      summary.textContent = "Summary: " + node.summary;
      div.appendChild(summary);

      const buttons = document.createElement("div");
      buttons.className = "bm-buttons";

      // copy prompt
      const copyBtn = document.createElement("button");
      copyBtn.className = "btn-copy";
      copyBtn.textContent = "Copy prompt";
      copyBtn.onclick = () => {
        const prompt = buildMediaPrompt(node);
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(prompt).then(() => {
            alert("Prompt copied. You can paste it into a text-to-image or text-to-video generator.");
          }).catch(() => {
            alert("Could not access clipboard. Here is the prompt:\n\n" + prompt);
          });
        } else {
          alert("Here is the prompt. Copy it manually:\n\n" + prompt);
        }
      };
      buttons.appendChild(copyBtn);

      // generate button (placeholder)
      const genBtn = document.createElement("button");
      genBtn.className = "btn-generate";
      genBtn.textContent = "‚ñ∂ Generate (photo / video)";
      genBtn.onclick = () => {
        const prompt = buildMediaPrompt(node);
        alert("In live LLM mode, this button would send the following prompt to your photo/video generator:\n\n" + prompt);
      };
      buttons.appendChild(genBtn);

      // delete single
      const delBtn = document.createElement("button");
      delBtn.className = "btn-delete";
      delBtn.textContent = "Delete";
      delBtn.onclick = () => {
        const idx = bmNodes.indexOf(node);
        if (idx >= 0) {
          bmNodes.splice(idx,1);
          renderBmList(bmSearchEl.value);
          rebuildBmDaySelect();
          updateBMViewer(bmNodes[bmNodes.length-1]);
        }
      };
      buttons.appendChild(delBtn);

      div.appendChild(buttons);
      bmListEl.appendChild(div);
    });

    rebuildBmDaySelect();
  }

  function buildMediaPrompt(node) {
    return (
      "Create a cinematic, emotionally rich visual scene based on the following memory text. " +
      "Use it either for a single keyframe image or a short video clip. Capture the core mood from the emotions, " +
      "lighting, and environment. The emotional polarity is " + node.sentiment.polarity +
      " with approximately " + node.sentiment.posPercent + "% positive and " + node.sentiment.negPercent +
      "% negative energy. The long-term emotional continuity score E0 is about " + node.e0.toFixed(2) +
      ". Use natural, realistic style (no text overlay). Memory text:\n\n" +
      node.fullText
    );
  }

  // ===== TIMELINE RENDER =====
  function renderTimeline() {
    timelineBodyEl.innerHTML = "";
    if (bmNodes.length === 0) {
      timelineBodyEl.textContent = "No Bold Memory saved yet.";
      return;
    }

    const byDate = {};
    bmNodes.forEach(n => {
      byDate[n.date] = byDate[n.date] || [];
      byDate[n.date].push(n);
    });

    Object.keys(byDate).sort().forEach(date => {
      const section = document.createElement("div");
      section.className = "timeline-day";
      const h4 = document.createElement("h4");
      h4.textContent = date;
      section.appendChild(h4);

      byDate[date].sort((a,b) => a.timestamp - b.timestamp).forEach(n => {
        const item = document.createElement("div");
        item.className = "timeline-item";
        item.innerHTML =
          `<div><strong>${n.time}</strong> ¬∑ E‚ÇÄ‚âà${n.e0.toFixed(2)} ¬∑ ${n.sentiment.polarity}</div>` +
          `<div>${n.summary}</div>`;
        section.appendChild(item);
      });

      timelineBodyEl.appendChild(section);
    });
  }

  // ===== OPTIONS HANDLERS =====
  faithButtonsEl.addEventListener("click", (e) => {
    const btn = e.target.closest(".faith-button");
    if (!btn) return;
    const value = btn.dataset.faith;
    if (!value) return;

    if (value === "none") {
      faithLens = ["none"];
      [...faithButtonsEl.querySelectorAll(".faith-button")].forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    } else {
      // toggle multi-select, but keep "none" off
      const already = faithLens.includes(value);
      if (already) {
        faithLens = faithLens.filter(f => f !== value);
        btn.classList.remove("active");
        if (faithLens.length === 0) {
          faithLens = ["none"];
          faithButtonsEl.querySelector('[data-faith="none"]').classList.add("active");
        }
      } else {
        faithLens = faithLens.filter(f => f !== "none");
        faithLens.push(value);
        btn.classList.add("active");
        faithButtonsEl.querySelector('[data-faith="none"]').classList.remove("active");
      }
    }
  });

  engineSwitchEl.addEventListener("click", () => {
    if (engineMode === "seed") {
      engineMode = "live";
      engineSwitchEl.classList.add("on");
      engineModeLabelEl.textContent = "Live emotional reactor (backend LLM) ‚Äì prototype only, not connected in this offline page.";
      modeChipEl.querySelector(".label").textContent = "MODE: LIVE (EXPERIMENTAL)";
      modeChipEl.innerHTML = '<span class="label">MODE: LIVE (EXPERIMENTAL)</span>Universal Ethics ¬∑ BM + Live LLM<br/><small>Engine: Live emotional reactor (backend LLM ‚Äì placeholder).</small>';
      tmFormulaEl.textContent = "TM = Œ£(User Inputs) + (Seed + LLM)";
    } else {
      engineMode = "seed";
      engineSwitchEl.classList.remove("on");
      engineModeLabelEl.textContent = "Seed-only. Everything runs locally.";
      modeChipEl.innerHTML = '<span class="label">MODE: SEED-ONLY</span>Universal Ethics ¬∑ Local BM<br/><small>Engine: Seed (offline prototype)</small>';
      tmFormulaEl.textContent = "TM = Œ£(User Inputs) + (Seed)";
    }
  });

  optAutoSummaryEl.addEventListener("change", () => {
    autoSummaryEnabled = optAutoSummaryEl.checked;
  });

  optIgnoreSmallTalkEl.addEventListener("change", () => {
    ignoreSmallTalkAsBM = optIgnoreSmallTalkEl.checked;
  });

  optClearTodayBMEl.addEventListener("click", () => {
    const today = formatDate(new Date());
    for (let i = bmNodes.length - 1; i >= 0; i--) {
      if (bmNodes[i].date === today) bmNodes.splice(i,1);
    }
    renderBmList(bmSearchEl.value);
    rebuildBmDaySelect();
    updateBMViewer(bmNodes[bmNodes.length-1]);
  });

  optDeleteAllBMEl.addEventListener("click", () => {
    if (!confirm("Delete all local BM nodes? This cannot be undone.")) return;
    bmNodes.length = 0;
    renderBmList("");
    rebuildBmDaySelect();
    updateBMViewer(null);
  });

  // ===== MODAL OPEN/CLOSE =====
  function openModal(el) {
    el.classList.add("open");
  }

  function closeModal(el) {
    el.classList.remove("open");
  }

  document.querySelectorAll(".modal-close").forEach(btn => {
    btn.addEventListener("click", () => {
      const targetSel = btn.getAttribute("data-close");
      if (targetSel) {
        const m = document.querySelector(targetSel);
        if (m) closeModal(m);
      }
    });
  });

  document.getElementById("openBMViewer").addEventListener("click", () => {
    openModal(bmViewerModal);
  });

  document.getElementById("openRecallBM").addEventListener("click", () => {
    renderBmList("");
    openModal(recallBMModal);
  });

  document.getElementById("openRecycle").addEventListener("click", () => {
    renderRecycleModal();
    openModal(recycleModal);
  });

  document.getElementById("openOptions").addEventListener("click", () => {
    openModal(optionsModal);
  });

  document.getElementById("openTimeline").addEventListener("click", () => {
    renderTimeline();
    openModal(timelineModal);
  });

  // background click close
  [bmViewerModal, recallBMModal, recycleModal, optionsModal, timelineModal].forEach(modal => {
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal(modal);
    });
  });

  // ===== RECALL HINT BUTTON =====
  recallHintButtonEl.addEventListener("click", () => {
    recallHintEl.style.display = "none";
    renderBmList("");
    openModal(recallBMModal);
  });

  // search filter
  bmSearchEl.addEventListener("input", () => {
    renderBmList(bmSearchEl.value);
  });

  document.getElementById("bmDeleteDayButton").addEventListener("click", () => {
    const val = bmDaySelectEl.value;
    if (!val) return;
    for (let i = bmNodes.length - 1; i >= 0; i--) {
      if (bmNodes[i].date === val) bmNodes.splice(i,1);
    }
    renderBmList(bmSearchEl.value);
    rebuildBmDaySelect();
    updateBMViewer(bmNodes[bmNodes.length-1]);
  });

  // recycle buttons
  recycleDeleteDayEl.addEventListener("click", () => {
    const date = recycleDeleteDayEl.dataset.date;
    if (!date) return;
    deleteRecycleDay(date);
    renderRecycleModal();
  });

  recycleClearAllEl.addEventListener("click", () => {
    clearRecycleAll();
    renderRecycleModal();
  });

  // ===== VOICE TOGGLE =====
  voiceToggleEl.addEventListener("click", () => {
    voiceEnabled = !voiceEnabled;
    if (voiceEnabled) {
      voiceToggleEl.classList.remove("off");
      voiceToggleEl.innerHTML = '<span>üéß</span><span>Voice: On</span>';
    } else {
      voiceToggleEl.classList.add("off");
      voiceToggleEl.innerHTML = '<span>üîá</span><span>Voice: Off</span>';
      if (typeof window.speechSynthesis !== "undefined") {
        window.speechSynthesis.cancel();
      }
    }
  });

  // ===== SEND HANDLER =====
  function handleSend() {
    const text = tmInputEl.value.trim();
    if (!text) return;

    tmInputEl.value = "";
    addUserMessage(text);

    const typing = addTypingIndicator();

    setTimeout(() => {
      typing.remove();

      const special = generateSeedResponse(text);
      const s = special.overridePolarity || analyzeSentiment(text);

      // update metrics
      const willSaveBM = !isSmallTalk(text);
      updateMetricsFromSentiment(s, willSaveBM);
      pushMetricsPoint();

      // reaction meta UI
      reactionPolarityEl.textContent = (s.polarity === "positive"
        ? "Positive"
        : s.polarity === "negative"
        ? "Negative"
        : "Neutral") +
        " ¬∑ " + s.posPercent + " / " + s.negPercent + "%";
      reactionToneEl.textContent = special.tone || (
        s.polarity === "positive"
   
