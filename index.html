<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Offline LLM package (WebLLM, for in-browser models ‚Äì future ready) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root { --accent-color:#0ea5e9; }
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(14,165,233,.15), transparent 60%),
                  radial-gradient(900px 700px at 80% 20%, rgba(251,191,36,.12), transparent 55%),
                  #f6f7fb;
      color:#0f172a;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:12px;
    }
    .app{
      width:min(980px,98vw);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .top{
      background:rgba(255,255,255,.72);
      border:1px solid rgba(15,23,42,.10);
      border-radius:18px;
      padding:12px 14px;
      box-shadow:0 20px 60px rgba(2,6,23,.08);
      position:relative;
      overflow:hidden;
    }
    .brand{
      font-weight:1000;
      letter-spacing:.5px;
      font-size:18px;
    }
    .sub{
      opacity:.75;
      margin-top:2px;
      font-size:12px;
      line-height:1.25;
    }
    .ethic{
      margin-top:10px;
      background:rgba(255,255,255,.82);
      border:1px solid rgba(15,23,42,.12);
      border-radius:16px;
      padding:10px 44px 10px 12px;
      position:relative;
    }
    .ethicMain{
      font-weight:900;
      font-size:12px;
      line-height:1.35;
    }
    .ethicMeta{
      margin-top:6px;
      font-size:12px;
      opacity:.78;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .faithCfgBtn{
      position:absolute;
      right:10px; top:10px;
      width:30px;height:30px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.14);
      background:rgba(255,255,255,.9);
      cursor:pointer;
      font-weight:900;
    }
    .consoleWrap{
      background:rgba(255,255,255,.70);
      border:1px solid rgba(15,23,42,.10);
      border-radius:18px;
      box-shadow:0 20px 60px rgba(2,6,23,.08);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:58vh;
    }
    .toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid rgba(15,23,42,.10);
      background:rgba(255,255,255,.75);
      position:relative;
    }
    .toolbarLeft{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.9);
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .chip small{opacity:.7;font-weight:800}
    .chip.active{
      background:#0f172a;
      color:#fff;
      border-color:rgba(15,23,42,.2);
      box-shadow:0 12px 30px rgba(2,6,23,.12);
    }
    .btn{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:12px;
      font-weight:900;
      -webkit-tap-highlight-color:transparent;
      font-size:12px;
      background:rgba(15,23,42,.06);
      color:#0f172a;
    }
    .btnBlue{
      background:linear-gradient(135deg, var(--accent-color), #2563eb);
      color:#fff;
      box-shadow:0 12px 30px rgba(37,99,235,.18);
    }
    .btnRed{
      background:linear-gradient(135deg, #ef4444, #b91c1c);
      color:#fff;
      box-shadow:0 12px 30px rgba(239,68,68,.18);
    }
    .iconBtn{
      width:34px;height:34px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.14);
      background:rgba(255,255,255,.92);
      cursor:pointer;
      font-weight:900;
    }
    .optionsWrap{
      position:relative;
    }
    .optionsBtn{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.9);
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .optionsMenu{
      position:absolute;
      right:0;
      top:44px;
      width:240px;
      max-height:60vh;
      overflow:auto;
      background:rgba(255,255,255,.96);
      border:1px solid rgba(15,23,42,.12);
      border-radius:16px;
      box-shadow:0 25px 70px rgba(2,6,23,.18);
      display:none;
      z-index:50;
      padding:8px;
    }
    .optionsMenu.show{display:block;}
    .menuItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 10px;
      border-radius:14px;
      cursor:pointer;
      user-select:none;
    }
    .menuItem:hover{background:rgba(15,23,42,.06)}
    .menuLeft{display:flex;gap:10px;align-items:center;font-weight:900;font-size:13px}
    .menuIcon{width:22px;text-align:center}
    .menuRight{display:flex;gap:8px;align-items:center}
    .pillOn,.pillOff,.pillMid{
      font-size:11px;
      font-weight:1000;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.14);
      background:rgba(15,23,42,.05);
      opacity:.9;
    }
    .pillOn{background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.28)}
    .pillOff{background:rgba(148,163,184,.12); border-color:rgba(148,163,184,.28)}
    .pillMid{background:rgba(59,130,246,.12); border-color:rgba(59,130,246,.28)}
    .liveCapsule{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      font-size:12px;
      opacity:.8;
      font-weight:800;
    }
    .faithBubble{
      position:absolute;
      left:10px; bottom:-90px;
      width:min(520px,94%);
      background:rgba(255,255,255,.96);
      border:1px solid rgba(15,23,42,.12);
      border-radius:18px;
      box-shadow:0 20px 70px rgba(2,6,23,.18);
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      z-index:20;
      opacity:0;
      transform:translateY(0);
      transition:all .28s ease;
      pointer-events:none;
    }
    .faithBubble.show{
      bottom:10px;
      opacity:1;
      pointer-events:auto;
    }
    .fbIcon{font-size:20px;line-height:1}
    .fbTitle{font-weight:1000;font-size:12px}
    .fbMeta{opacity:.75;font-size:12px;line-height:1.35;margin-top:2px;white-space:pre-wrap}
    .fbClose{
      margin-left:auto;
      width:28px;height:28px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(15,23,42,.04);
      cursor:pointer;
      font-weight:1000;
    }

    .console{
      padding:12px 12px;
      overflow:auto;
      flex:1;
      background:linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.90));
    }
    .msg{
      max-width:90%;
      padding:10px 12px;
      border-radius:16px;
      margin:8px 0;
      line-height:1.42;
      font-size:14px;
      white-space:pre-wrap;
      border:1px solid rgba(15,23,42,.10);
      box-shadow:0 10px 25px rgba(2,6,23,.06);
    }
    .msg.user{
      margin-left:auto;
      background:rgba(14,165,233,.10);
      border-color:rgba(14,165,233,.22);
    }
    .msg.aura{
      margin-right:auto;
      background:rgba(15,23,42,.05);
    }
    .msgMeta{
      font-size:11px;
      opacity:.65;
      margin-top:6px;
      font-weight:800;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .inputBar{
      border-top:1px solid rgba(15,23,42,.10);
      background:rgba(255,255,255,.88);
      padding:10px;
      display:flex;
      gap:8px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    .inputBar textarea{
      flex:1;
      min-width:220px;
      min-height:46px;
      max-height:180px;
      resize:vertical;
      border-radius:16px;
      border:1px solid rgba(15,23,42,.12);
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .visionWrap{
      display:flex;
      flex-direction:column;
      gap:6px;
      width:100%;
    }
    .visionRow{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    }
    .visionInput{
      display:none;
    }
    .imgPrev{
      width:100%;
      max-height:220px;
      border-radius:16px;
      border:1px solid rgba(15,23,42,.10);
      object-fit:cover;
      display:none;
    }
    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:200;
    }
    .modalOverlay.show{display:flex;}
    .modal{
      width:min(900px,96vw);
      max-height:92vh;
      overflow:auto;
      background:rgba(255,255,255,.96);
      border:1px solid rgba(255,255,255,.25);
      border-radius:20px;
      box-shadow:0 30px 120px rgba(0,0,0,.35);
    }
    .modalHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding:14px 14px;
      border-bottom:1px solid rgba(15,23,42,.10);
      font-weight:1000;
    }
    .modalHeader small{display:block;font-weight:800;opacity:.7;margin-top:2px}
    .modalBody{padding:14px 14px}
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .card{
      border-radius:16px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.95);
      padding:12px 12px;
      box-shadow:0 14px 40px rgba(2,6,23,.08);
    }
    .cardTop{
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap;
    }
    .title{font-weight:1000}
    .subt{opacity:.75;font-size:12px;margin-top:3px;line-height:1.3}
    .cardBtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .divider{height:1px;background:rgba(15,23,42,.10);margin:10px 0}
    .logicArea{
      width:100%;
      min-height:140px;
      resize:vertical;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.12);
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .intelEditArea{
      min-height:90px;
      resize:vertical;
      line-height:1.4;
      margin-top:6px;
    }
    .intelCard{
      border-radius:12px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.95);
      padding:10px 10px;
    }
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:16px;
      background:rgba(15,23,42,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:12px;
      box-shadow:0 20px 70px rgba(0,0,0,.25);
      display:none;
      z-index:999;
      max-width:min(520px,92vw);
    }
    .toast.show{display:block;}
    @media (max-width:560px){
      .brand{font-size:16px}
      .msg{max-width:96%}
      .toolbar{gap:8px}
      .optionsMenu{width:92vw}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="brand">AURA-X Œ©</div>
      <div class="sub">
        Offline emotional continuity engine (prototype)<br>
        TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory.
      </div>

      <div class="ethic" id="ethicBox">
        <div class="ethicMain" id="ethicMain">
          Universal ethic: avoid actions that grow negative emotions in you or others.
          Move gently toward choices that increase shared positive feeling for everyone.
        </div>
        <div class="ethicMeta" id="ethicMeta"></div><!-- ‚úÖ empty by default -->
        <button id="faithCfgBtn" class="faithCfgBtn" title="Faith live bar settings">üîò</button>
      </div>
    </div>

    <div class="consoleWrap">
      <div class="toolbar">
        <div class="toolbarLeft">
          <div class="chip" id="chipContinuity">Continuity <small id="contVal">0.85</small></div>
          <div class="chip" id="chipEmotion">Emotion <small id="emoVal">0.00</small></div>
          <div class="chip" id="chipTruth">TRC <small id="trcVal">0.75</small></div>

          <div class="optionsWrap">
            <button class="optionsBtn" id="btnOptions">‚öôÔ∏è <span>Options</span></button>
            <div class="optionsMenu" id="optionsMenu">
              <div class="menuItem" id="miVoice">
                <div class="menuLeft"><span class="menuIcon">üé§</span><span>Voice</span></div>
                <div class="menuRight"><span class="pillOff" id="voicePill">off</span></div>
              </div>

              <!-- ‚úÖ Injected (4.9 UI unchanged) -->
              <div class="menuItem" id="miCamera">
                <div class="menuLeft"><span class="menuIcon">üì∑</span><span>Camera</span></div>
                <div class="menuRight"><span class="pillOff" id="camPill">off</span></div>
              </div>
              <div class="menuItem" id="miMicSense">
                <div class="menuLeft"><span class="menuIcon">üéß</span><span>Mic (sense)</span></div>
                <div class="menuRight"><span class="pillOff" id="micPill">off</span></div>
              </div>
              <div class="menuItem" id="miSense">
                <div class="menuLeft"><span class="menuIcon">üëÅÔ∏è</span><span>Sense</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <!-- ‚úÖ end injected -->

              <div class="menuItem" id="miIntel">
                <div class="menuLeft"><span class="menuIcon">üß†</span><span>Intelligence</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miLearn">
                <div class="menuLeft"><span class="menuIcon">üìö</span><span>Learning</span></div>
                <div class="menuRight"><span class="pillOn" id="learnPill">on</span></div>
              </div>
              <div class="menuItem" id="miSeed">
                <div class="menuLeft"><span class="menuIcon">üå±</span><span>Feed</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miFaith">
                <div class="menuLeft"><span class="menuIcon">üïä</span><span>Faith</span></div>
                <div class="menuRight"><span class="pillOff" id="faithLabel">none</span></div>
              </div>
              <div class="menuItem" id="miIdentity">
                <div class="menuLeft"><span class="menuIcon">ü™™</span><span>Identity</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miLLM">
                <div class="menuLeft"><span class="menuIcon">ü§ñ</span><span>LLM</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miBMRecall">
                <div class="menuLeft"><span class="menuIcon">üìò</span><span>BM</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
            </div>
          </div>
        </div>

        <div class="liveCapsule">
          <span><b>E0</b>: <span id="cE0">0.000</span></span><span>¬∑</span>
          <span><b>TM</b>: <span id="cTM">0.00</span></span><span>¬∑</span>
          <span><b>BM</b>: <span id="cBM">0.00</span></span><span>¬∑</span>
          <span><b>C</b>: <span id="cCont">0.850</span></span>
        </div>

        <div class="faithBubble" id="faithBubble">
          <div class="fbIcon">üí≠</div>
          <div class="fbText">
            <div class="fbTitle" id="faithBubbleTitle">Faith reflection bubble</div>
            <div class="fbMeta" id="faithBubbleMeta">Tap to see a short suggestion.</div>
          </div>
          <button class="fbClose" id="faithBubbleClose">√ó</button>
        </div>
      </div>

      <div class="console" id="console"></div>

      <div class="inputBar">
        <textarea id="userInput" placeholder="Type here..."></textarea>
        <button class="btn btnBlue" id="sendBtn">Send</button>

        <div class="visionWrap">
          <div class="visionRow">
            <button class="btn" id="btnVisionPick">üñº Add image</button>
            <input type="file" id="visionInput" class="visionInput" accept="image/*" />
            <button class="btn" id="btnClearVision">Clear image</button>
          </div>
          <div id="imagePreviewArea">
            <img id="imgPrev" class="imgPrev" alt="preview" />
          </div>
        </div>
      </div>
    </div>

    <!-- Faith Live Bar Settings -->
    <div class="modalOverlay" id="modalFaithCfg">
      <div class="modal">
        <div class="modalHeader">
          <div>üîò Faith live bar settings<br><small>Enable/disable faith lenses (and choose language for each).</small></div>
          <button class="iconBtn" data-close="modalFaithCfg">‚úï</button>
        </div>
        <div class="modalBody">
          <div id="faithCfgList" class="list"></div>
        </div>
      </div>
    </div>

    <!-- Intelligence -->
    <div class="modalOverlay" id="modalIntel">
      <div class="modal">
        <div class="modalHeader">
          <div>üß† Intelligence<br><small>Learned Q/A pairs (editable). Locked entries require unlock first.</small></div>
          <button class="iconBtn" data-close="modalIntel">‚úï</button>
        </div>
        <div class="modalBody">
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <input id="intelSearch" style="flex:1;min-width:220px;border-radius:14px;border:1px solid rgba(15,23,42,.12);padding:10px 12px;font-size:14px;outline:none;background:#fff"
              placeholder="Search..." />
            <button class="btn btnBlue" id="btnExportIntel">Export</button>
            <button class="btn btnRed" id="btnClearIntel">Clear (unlocked)</button>
          </div>
          <div class="divider"></div>
          <div id="intelList" class="list"></div>
        </div>
      </div>
    </div>

    <!-- Feed the Seed -->
    <div class="modalOverlay" id="modalSeed">
      <div class="modal">
        <div class="modalHeader">
          <div>üå± Feed the Seed<br><small>Inject basic Q/A or knowledge blocks (auto-lock on save).</small></div>
          <button class="iconBtn" data-close="modalSeed">‚úï</button>
        </div>
        <div class="modalBody">
          <textarea id="seedArea" class="logicArea" placeholder="Paste Q/A pairs or knowledge blocks..."></textarea>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px;flex-wrap:wrap;">
            <button class="btn btnBlue" id="btnSeedSave">Save to Intelligence</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Faith -->
    <div class="modalOverlay" id="modalFaith">
      <div class="modal">
        <div class="modalHeader">
          <div>üïä Faith lens<br><small>Select one or more lenses (Top 10).</small></div>
          <button class="iconBtn" data-close="modalFaith">‚úï</button>
        </div>
        <div class="modalBody">
          <div id="faithList" class="list"></div>
        </div>
      </div>
    </div>

    <!-- Identity -->
    <div class="modalOverlay" id="modalIdentity">
      <div class="modal">
        <div class="modalHeader">
          <div>ü™™ Identity (Deep Profiling)<br><small>Store user identity blocks (auto-lock). You can delete only after unlock + double confirm.</small></div>
          <button class="iconBtn" data-close="modalIdentity">‚úï</button>
        </div>
        <div class="modalBody">
          <textarea id="identityArea" class="logicArea" placeholder="Write identity blocks here..."></textarea>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px;flex-wrap:wrap;">
            <button class="btn btnBlue" id="btnSaveIdentity">Save</button>
            <button class="btn btnRed" id="btnDeleteIdentity">Delete (unlock + confirm)</button>
          </div>
          <div style="margin-top:8px;font-size:12px;opacity:.7;" id="identityStatus">No identity saved.</div>
        </div>
      </div>
    </div>

    <!-- LLM -->
    <div class="modalOverlay" id="modalLLM">
      <div class="modal">
        <div class="modalHeader">
          <div>ü§ñ LLM settings<br><small>Offline WebLLM (future) and optional online API fallback.</small></div>
          <button class="iconBtn" data-close="modalLLM">‚úï</button>
        </div>
        <div class="modalBody">
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start;">
            <div style="flex:1;min-width:260px;">
              <div class="card">
                <div class="title">Offline (WebLLM)</div>
                <div class="subt">Reserved for future ‚Äì model loading can be heavy on mobile.</div>
                <div class="divider"></div>
                <button class="btn btnBlue" id="btnInitOffline">Init Offline LLM</button>
                <div style="margin-top:8px;font-size:12px;opacity:.7;" id="offlineStatus">Not initialized.</div>
              </div>
            </div>
            <div style="flex:1;min-width:260px;">
              <div class="card">
                <div class="title">Online API (optional)</div>
                <div class="subt">Only used if enabled and key is provided.</div>
                <div class="divider"></div>
                <div style="margin-top:10px;">
                  <label style="font-size:12px;opacity:.75;display:block;margin-bottom:4px;">Endpoint (OpenAI compatible)</label>
                  <input id="apiEndpoint"
                    style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);padding:8px 10px;font-size:14px;outline:none;background:rgba(255,255,255,.88)"
                    value="https://api.openai.com/v1/chat/completions" />
                </div>
                <div style="margin-top:10px;">
                  <label style="font-size:12px;opacity:.75;display:block;margin-bottom:4px;">Model</label>
                  <input id="apiModel"
                    style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);padding:8px 10px;font-size:14px;outline:none;background:rgba(255,255,255,.88)"
                    value="gpt-4o-mini" />
                </div>
                <div style="margin-top:10px;">
                  <label style="font-size:12px;opacity:.75;display:block;margin-bottom:4px;">API key (session only)</label>
                  <input id="apiKey"
                    style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);padding:8px 10px;font-size:14px;outline:none;background:rgba(255,255,255,.88)"
                    placeholder="sk-..." />
                </div>
                <div style="margin-top:10px;display:flex;justify-content:flex-end;">
                  <button class="btn btnBlue" id="btnSaveLLM">Save</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ Injected Sense modal (UI preserved; just added new modal) -->
    <div class="modalOverlay" id="modalSense">
      <div class="modal">
        <div class="modalHeader">
          <div>üëÅÔ∏è Sense<br><small>Camera/Mic perception ‚Üí build a BM prompt (no media is stored unless you save).</small></div>
          <button class="iconBtn" data-close="modalSense">‚úï</button>
        </div>
        <div class="modalBody">
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;">
            <div style="flex:1;min-width:240px;">
              <div style="font-size:12px;opacity:.75;margin-bottom:6px;">Camera preview</div>
              <video id="senseVideo" autoplay playsinline muted style="width:100%;border-radius:14px;border:1px solid rgba(15,23,42,.12);background:#0b1220;min-height:160px;"></video>
              <canvas id="senseCanvas" style="display:none;"></canvas>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
                <button class="btn btnBlue" id="btnCamStart">Start camera</button>
                <button class="btn btnRed" id="btnCamStop">Stop</button>
                <button class="btn" id="btnSnap">Snapshot</button>
              </div>
              <div style="margin-top:10px;font-size:12px;opacity:.75;">Mic capture (5‚Äì10s)</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
                <button class="btn btnBlue" id="btnMicStart">Start mic</button>
                <button class="btn btnRed" id="btnMicStop">Stop</button>
                <button class="btn" id="btnMicTest">Test beep</button>
              </div>
              <div id="micInfo" style="margin-top:8px;font-size:12px;opacity:.75;">Mic: idle</div>
            </div>

            <div style="flex:1;min-width:240px;">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
                <div style="font-weight:900;">Scene ‚Üí BM prompt</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
                  <button class="btn btnBlue" id="btnSenseAnalyze">Analyze</button>
                  <button class="btn btnBlue" id="btnSenseSaveBM">Save to BM</button>
                </div>
              </div>
              <div style="margin-top:8px;font-size:12px;opacity:.72;">
                Tip: If you have an API endpoint set in <b>LLM</b>, AURA will send a lightweight summary request (image+audio optional).
                Otherwise it will create a local, heuristic scene summary.
              </div>
              <textarea id="senseSummary" class="logicArea" placeholder="Scene summary will appear here..."></textarea>
              <div style="margin-top:8px;font-size:12px;opacity:.7;">
                Last snapshot: <span id="senseSnapInfo">none</span> ¬∑ Last mic: <span id="senseMicInfo">none</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- BM Recall -->
    <div class="modalOverlay" id="modalBM">
      <div class="modal">
        <div class="modalHeader">
          <div>üìò Recall from BM<br><small>Only long stories and scenes (photo/video-ready).</small></div>
          <button class="iconBtn" data-close="modalBM">‚úï</button>
        </div>
        <div class="modalBody">
          <div class="card">
            <div class="bmTop">
              <div>
                <div class="title">üåô Dream Mode / screensaver</div>
                <div class="bmSub">
                  Choose after how much idle time AURA-X Œ© should enter Dream Mode with your BM snapshots.
                </div>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
                <button class="btn btnBlue" id="btnTestDream">Test now</button>
              </div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <div style="flex:1;min-width:140px;">
                <label style="font-size:12px;opacity:.75;display:block;margin-bottom:4px;">Start after</label>
                <select id="dreamDelay"
                  style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);padding:8px 10px;font-size:14px;outline:none;background:rgba(255,255,255,.88)">
                  <option value="30000">30 seconds</option>
                  <option value="60000">1 minute</option>
                  <option value="120000">2 minutes</option>
                  <option value="300000">5 minutes</option>
                  <option value="600000">10 minutes</option>
                  <option value="1800000">30 minutes</option>
                  <option value="3600000">1 hour</option>
                  <option value="7200000">2 hours</option>
                  <option value="14400000">4 hours</option>
                  <option value="28800000">8 hours</option>
                </select>
              </div>
              <div style="display:flex;align-items:flex-end;gap:8px;flex-wrap:wrap;">
                <button class="btn btnBlue" id="btnSaveDream">Save</button>
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <input id="bmSearch"
              style="flex:1;min-width:240px;border-radius:14px;border:1px solid rgba(15,23,42,.12);padding:10px 12px;font-size:14px;outline:none;background:#fff"
              placeholder="Search BM prompts..." />
            <button class="btn btnBlue" id="btnBMExport">Export</button>
            <button class="btn btnRed" id="btnBMClear">Clear (unlocked)</button>
          </div>
          <div class="divider"></div>
          <div id="bmList" class="list"></div>

          <div class="divider"></div>
          <div class="card">
            <div class="title">üß© Logic Pack</div>
            <div class="subt">Save a behavior logic block. (Input clears after save.)</div>
            <div class="divider"></div>
            <textarea id="logicArea" class="logicArea" placeholder=""></textarea>
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-top:8px;">
              <div style="font-size:12px;opacity:.7" id="logicHint">No logic pack loaded.</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn btnBlue" id="btnValidateLogic">Validate</button>
                <button class="btn btnBlue" id="btnSaveLogic">Save</button>
                <button class="btn btnBlue" id="btnCopyLogic">Copy</button>
                <button class="btn btnRed" id="btnDeleteLogic">Delete</button>
              </div>
            </div>
            <div style="margin-top:6px;font-size:11px;opacity:.6;">
              Current serial: <span id="logicSerial">none</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <script>
    // ====== AURA-X Œ© 4.9 baseline (UI kept) + injected Sense module ======

    const STORAGE_KEY = "aurax_omega_49_state";
    const CFG_KEY = "aurax_omega_49_cfg";
    const DREAM_KEY = "aurax_omega_49_dream";

    const FAITH_TOP10 = [
      "Islam","Christianity","Hinduism","Buddhism","Sikhism","Judaism","Taoism","Confucianism","Shinto","Atheism"
    ];

    const faithLiveDefaults = {};
    FAITH_TOP10.forEach(f=> faithLiveDefaults[f.toLowerCase()] = { enabled:false, lang:"english" });

    const FAITH_ARTIFACTS = {
      islam: {
        label:"Islam",
        samples: [
          { ar: "Ÿ±ŸÑŸíŸÖŸèÿ≥ŸíŸÑŸêŸÖŸè ŸÖŸéŸÜŸí ÿ≥ŸéŸÑŸêŸÖŸé Ÿ±ŸÑŸíŸÖŸèÿ≥ŸíŸÑŸêŸÖŸèŸàŸÜŸé ŸÖŸêŸÜŸí ŸÑŸêÿ≥ŸéÿßŸÜŸêŸáŸê ŸàŸéŸäŸéÿØŸêŸáŸê", en:"The Muslim is the one from whose tongue and hand other Muslims are safe.", ur:"ŸÖÿ≥ŸÑŸÖÿßŸÜ Ÿà€Å €Å€í ÿ¨ÿ≥ ⁄©€å ÿ≤ÿ®ÿßŸÜ ÿßŸàÿ± €Åÿßÿ™⁄æ ÿ≥€í ÿØŸàÿ≥ÿ±€í ŸÖÿ≥ŸÑŸÖÿßŸÜ ŸÖÿ≠ŸÅŸàÿ∏ ÿ±€Å€å⁄∫€î" },
          { ar: "ÿ•ŸêŸÜŸëŸé Ÿ±ŸÑŸÑŸëŸéŸáŸé ŸäŸéÿ£ŸíŸÖŸèÿ±Ÿè ÿ®ŸêŸ±ŸÑŸíÿπŸéÿØŸíŸÑŸê ŸàŸéŸ±ŸÑŸíÿ•Ÿêÿ≠Ÿíÿ≥ŸéŸ∞ŸÜŸê", en:"Indeed Allah commands justice and excellence.", ur:"ÿ®€í ÿ¥⁄© ÿßŸÑŸÑ€Å ÿπÿØŸÑ ÿßŸàÿ± ÿßÿ≠ÿ≥ÿßŸÜ ⁄©ÿß ÿ≠⁄©ŸÖ ÿØ€åÿ™ÿß €Å€í€î" }
        ],
        translations: {
          english: "From an Islamic lens: speak with adab, avoid ÿ∏ŸÑŸÖ, increase ÿπÿØŸÑ Ÿà ÿßÿ≠ÿ≥ÿßŸÜ. Choose a response that reduces harm and preserves dignity.",
          urdu: "ÿßÿ≥ŸÑÿßŸÖ€å ÿ≤ÿßŸà€å€í ÿ≥€í: ÿßÿØÿ® ⁄©€í ÿ≥ÿßÿ™⁄æ ÿ®ÿßÿ™ÿå ÿ∏ŸÑŸÖ ÿ≥€í ÿßÿ¨ÿ™ŸÜÿßÿ®ÿå ÿπÿØŸÑ Ÿà ÿßÿ≠ÿ≥ÿßŸÜ ŸÖ€å⁄∫ ÿßÿ∂ÿßŸÅ€Å€î ÿß€åÿ≥ÿß ÿ¨Ÿàÿßÿ® ÿØ€å⁄∫ ÿ¨Ÿà ŸÜŸÇÿµÿßŸÜ ⁄©ŸÖ ⁄©ÿ±€í ÿßŸàÿ± ÿπÿ≤ÿ™ ŸÖÿ≠ŸÅŸàÿ∏ ÿ±⁄©⁄æ€í€î"
        }
      },
      christianity: {
        label:"Christianity",
        samples: [
          { ar:"", en:"Love your neighbor as yourself.", ur:"ÿßŸæŸÜ€í Ÿæ⁄ëŸàÿ≥€å ÿ≥€í ÿßŸæŸÜ€í ÿ¨€åÿ≥ÿß ŸÖÿ≠ÿ®ÿ™ ⁄©ÿ±Ÿà€î" }
        ],
        translations:{
          english:"From a Christian lens: respond with compassion, forgiveness, and truth in love.",
          urdu:"ŸÖÿ≥€åÿ≠€å ÿ≤ÿßŸà€å€í ÿ≥€í: ÿ±ÿ≠ŸÖÿå ŸÖÿπÿßŸÅ€åÿå ÿßŸàÿ± ŸÖÿ≠ÿ®ÿ™ ŸÖ€å⁄∫ ÿ≥⁄Üÿßÿ¶€å ⁄©€í ÿ≥ÿßÿ™⁄æ ÿ¨Ÿàÿßÿ® ÿØ€å⁄∫€î"
        }
      },
      hinduism: {
        label:"Hinduism",
        samples: [
          { ar:"", en:"Ahimsa (non-violence) and dharma guide the right action.", ur:"ÿß€ÅŸÜÿ≥ÿß (ÿπÿØŸÖ ÿ™ÿ¥ÿØÿØ) ÿßŸàÿ± ÿØ⁄æÿ±ŸÖ ÿØÿ±ÿ≥ÿ™ ÿπŸÖŸÑ ⁄©€å ÿ±€ÅŸÜŸÖÿßÿ¶€å ⁄©ÿ±ÿ™€í €Å€å⁄∫€î" }
        ],
        translations:{
          english:"From a Hindu lens: act with dharma, ahimsa, and balance; reduce harm and cultivate good karma.",
          urdu:"€ÅŸÜÿØŸà ÿ≤ÿßŸà€å€í ÿ≥€í: ÿØ⁄æÿ±ŸÖÿå ÿß€ÅŸÜÿ≥ÿß ÿßŸàÿ± ÿ™Ÿàÿßÿ≤ŸÜ ⁄©€í ÿ≥ÿßÿ™⁄æ ÿπŸÖŸÑÿõ ŸÜŸÇÿµÿßŸÜ ⁄©ŸÖ ⁄©ÿ±€å⁄∫ ÿßŸàÿ± ÿß⁄Ü⁄æÿß ⁄©ÿ±ŸÖ ÿ®⁄ë⁄æÿßÿ¶€å⁄∫€î"
        }
      },
      buddhism: {
        label:"Buddhism",
        samples: [
          { ar:"", en:"Right speech: truthful, kind, and beneficial.", ur:"ÿµÿ≠€åÿ≠ ⁄©ŸÑÿßŸÖ: ÿ≥⁄Üÿå ŸÖ€Åÿ±ÿ®ÿßŸÜ ÿßŸàÿ± ŸÖŸÅ€åÿØ€î" }
        ],
        translations:{
          english:"From a Buddhist lens: right speech, compassion, and mindful awareness; reduce suffering.",
          urdu:"ÿ®ÿØ⁄æ ŸÖÿ™ ⁄©€í ÿ≤ÿßŸà€å€í ÿ≥€í: ÿµÿ≠€åÿ≠ ⁄©ŸÑÿßŸÖÿå ⁄©ÿ±ŸèŸàŸÜÿß ÿßŸàÿ± ÿ¥ÿπŸàÿ±€å ÿ¢⁄Øÿß€Å€åÿõ ÿØ⁄©⁄æ ⁄©ŸÖ ⁄©ÿ±€å⁄∫€î"
        }
      },
      sikhism: {
        label:"Sikhism",
        samples: [
          { ar:"", en:"Truth, compassion, and service (seva).", ur:"ÿ≥⁄Üÿßÿ¶€åÿå ÿ±ÿ≠ŸÖÿ™ ÿßŸàÿ± ÿÆÿØŸÖÿ™ (ÿ≥€åŸàÿß)€î" }
        ],
        translations:{
          english:"From a Sikh lens: truth, humility, and seva; act for collective well-being.",
          urdu:"ÿ≥⁄©⁄æ ÿ≤ÿßŸà€å€í ÿ≥€í: ÿ≥⁄Üÿå ÿπÿßÿ¨ÿ≤€å ÿßŸàÿ± ÿ≥€åŸàÿßÿõ ÿßÿ¨ÿ™ŸÖÿßÿπ€å ÿ®⁄æŸÑÿßÿ¶€å ⁄©€í ŸÑ€å€í ÿπŸÖŸÑ ⁄©ÿ±€å⁄∫€î"
        }
      },
      judaism: {
        label:"Judaism",
        samples: [
          { ar:"", en:"Pursue justice and kindness.", ur:"ÿßŸÜÿµÿßŸÅ ÿßŸàÿ± ŸÖ€Åÿ±ÿ®ÿßŸÜ€å ⁄©Ÿà ÿßÿÆÿ™€åÿßÿ± ⁄©ÿ±Ÿà€î" }
        ],
        translations:{
          english:"From a Jewish lens: pursue justice, kindness, and responsible speech.",
          urdu:"€å€ÅŸàÿØ€å ÿ≤ÿßŸà€å€í ÿ≥€í: ÿßŸÜÿµÿßŸÅÿå ŸÖ€Åÿ±ÿ®ÿßŸÜ€åÿå ÿßŸàÿ± ÿ∞ŸÖ€Å ÿØÿßÿ± ⁄ØŸÅÿ™⁄ØŸà€î"
        }
      },
      taoism: {
        label:"Taoism",
        samples: [
          { ar:"", en:"Act with wu-wei: natural, non-forcing harmony.", ur:"ŸàŸà Ÿà€í ⁄©€í ÿ≥ÿßÿ™⁄æ ÿπŸÖŸÑ: ŸÅÿ∑ÿ±€å €ÅŸÖ ÿ¢€ÅŸÜ⁄Ø€åÿå ÿ≤ÿ®ÿ±ÿØÿ≥ÿ™€å ŸÜ€Å€å⁄∫€î" }
        ],
        translations:{
          english:"From a Taoist lens: seek harmony, avoid forcing; respond softly and wisely.",
          urdu:"ÿ™ÿßÿ§ ÿßÿ≤ŸÖ ⁄©€í ÿ≤ÿßŸà€å€í ÿ≥€í: €ÅŸÖ ÿ¢€ÅŸÜ⁄Ø€åÿå ÿ¨ÿ®ÿ± ÿ≥€í Ÿæÿ±€Å€åÿ≤ÿõ ŸÜÿ±ŸÖ ÿßŸàÿ± ÿ≠⁄©€åŸÖÿßŸÜ€Å ÿ¨Ÿàÿßÿ®€î"
        }
      },
      confucianism: {
        label:"Confucianism",
        samples: [
          { ar:"", en:"Cultivate virtue and respectful conduct.", ur:"ŸÅÿ∂€åŸÑÿ™ ÿßŸàÿ± ÿ®ÿßÿßÿØÿ® ÿ∑ÿ±ÿ≤ŸêÿπŸÖŸÑ ÿßŸæŸÜÿßÿ¶€å⁄∫€î" }
        ],
        translations:{
          english:"From a Confucian lens: respectful conduct, virtue, and social harmony.",
          urdu:"⁄©ŸÜŸÅ€åŸàÿ¥ÿ≥ ÿ≤ÿßŸà€å€í ÿ≥€í: ÿ®ÿßÿßÿØÿ® ÿ∑ÿ±ÿ≤ŸêÿπŸÖŸÑÿå ŸÅÿ∂€åŸÑÿ™ÿå ÿßŸàÿ± ÿ≥ŸÖÿßÿ¨€å €ÅŸÖ ÿ¢€ÅŸÜ⁄Ø€å€î"
        }
      },
      shinto: {
        label:"Shinto",
        samples: [
          { ar:"", en:"Purity, gratitude, and respect for nature.", ur:"Ÿæÿß⁄©€åÿ≤⁄Ø€åÿå ÿ¥⁄©ÿ±⁄Øÿ≤ÿßÿ±€å ÿßŸàÿ± ŸÅÿ∑ÿ±ÿ™ ⁄©ÿß ÿßÿ≠ÿ™ÿ±ÿßŸÖ€î" }
        ],
        translations:{
          english:"From a Shinto lens: purity of intention, gratitude, and respect for life and nature.",
          urdu:"ÿ¥ŸÜŸπŸà ÿ≤ÿßŸà€å€í ÿ≥€í: ŸÜ€åÿ™ ⁄©€å Ÿæÿß⁄©€åÿ≤⁄Ø€åÿå ÿ¥⁄©ÿ±⁄Øÿ≤ÿßÿ±€å ÿßŸàÿ± ÿ≤ŸÜÿØ⁄Ø€å/ŸÅÿ∑ÿ±ÿ™ ⁄©ÿß ÿßÿ≠ÿ™ÿ±ÿßŸÖ€î"
        }
      },
      atheism: {
        label:"Atheism",
        samples: [
          { ar:"", en:"Ground choices in evidence, empathy, and human well-being.", ur:"ŸÅ€åÿµŸÑ€í ÿ´ÿ®Ÿàÿ™ÿå €ÅŸÖÿØÿ±ÿØ€å ÿßŸàÿ± ÿßŸÜÿ≥ÿßŸÜ€å ÿ®⁄æŸÑÿßÿ¶€å Ÿæÿ± ÿ±⁄©⁄æ€å⁄∫€î" }
        ],
        translations:{
          english:"From a secular lens: evidence, empathy, and wellbeing; minimize harm.",
          urdu:"ÿ≥€å⁄©ŸàŸÑÿ± ÿ≤ÿßŸà€å€í ÿ≥€í: ÿ´ÿ®Ÿàÿ™ÿå €ÅŸÖÿØÿ±ÿØ€å ÿßŸàÿ± ÿ®⁄æŸÑÿßÿ¶€åÿõ ŸÜŸÇÿµÿßŸÜ ⁄©ŸÖ ⁄©ÿ±€å⁄∫€î"
        }
      }
    };

    const defaultDeviceLang = (navigator.language || "").toLowerCase().startsWith("ur") ? "urdu" : "english";

    let state = {
      voiceOn: false,
      learningOn: true,
      faithSelection: [],
      faithLiveOptions: {},   // { islam: {enabled:true, lang:"urdu"} , ... }
      intelligence: [],
      seedPairs: [],
      bmPrompts: [],
      history: [],
      userIdentity: null,
      apiConfig: { endpoint: "", model: "", key: "" },

      // ‚úÖ Injected sense state (backwards-compatible)
      sense: { camOn:false, micOn:false, lastSnapAt:null, lastMicAt:null, lastImageData:null, lastAudioBlob:null, lastSummary:"" },

      metrics: {
        E0: 0.000,
        TM: 0.00,
        BM: 0.00,
        C: 0.85,
        TRC: 0.75
      },
      lastAnswerSource: null,
      lastUserQ: null,
      dreamEnabled: true,
      dreamDelayMs: 30000,
      dreamTimer: null
    };

    const ETHIC_BASE =
      "Universal ethic: avoid actions that grow negative emotions in you or others. " +
      "Move gently toward choices that increase shared positive feeling for everyone.";

    const els = {
      console: document.getElementById("console"),
      btnOptions: document.getElementById("btnOptions"),
      optionsMenu: document.getElementById("optionsMenu"),

      miVoice: document.getElementById("miVoice"),
      miCamera: document.getElementById("miCamera"),
      miMicSense: document.getElementById("miMicSense"),
      miSense: document.getElementById("miSense"),

      miIntel: document.getElementById("miIntel"),
      miLearn: document.getElementById("miLearn"),
      miSeed: document.getElementById("miSeed"),
      miFaith: document.getElementById("miFaith"),
      miIdentity: document.getElementById("miIdentity"),
      miLLM: document.getElementById("miLLM"),
      miBMRecall: document.getElementById("miBMRecall"),

      voicePill: document.getElementById("voicePill"),
      camPill: document.getElementById("camPill"),
      micPill: document.getElementById("micPill"),

      learnPill: document.getElementById("learnPill"),
      faithLabel: document.getElementById("faithLabel"),

      chipContinuity: document.getElementById("chipContinuity"),
      chipEmotion: document.getElementById("chipEmotion"),
      chipTruth: document.getElementById("chipTruth"),

      contVal: document.getElementById("contVal"),
      emoVal: document.getElementById("emoVal"),
      trcVal: document.getElementById("trcVal"),

      cE0: document.getElementById("cE0"),
      cTM: document.getElementById("cTM"),
      cBM: document.getElementById("cBM"),
      cCont: document.getElementById("cCont"),

      userInput: document.getElementById("userInput"),
      sendBtn: document.getElementById("sendBtn"),
      btnVisionPick: document.getElementById("btnVisionPick"),
      visionInput: document.getElementById("visionInput"),
      btnClearVision: document.getElementById("btnClearVision"),
      imgPrev: document.getElementById("imgPrev"),
      imagePreviewArea: document.getElementById("imagePreviewArea"),

      ethicMain: document.getElementById("ethicMain"),
      ethicMeta: document.getElementById("ethicMeta"),

      faithCfgBtn: document.getElementById("faithCfgBtn"),
      modalFaithCfg: document.getElementById("modalFaithCfg"),
      faithCfgList: document.getElementById("faithCfgList"),

      faithBubble: document.getElementById("faithBubble"),
      faithBubbleTitle: document.getElementById("faithBubbleTitle"),
      faithBubbleMeta: document.getElementById("faithBubbleMeta"),
      faithBubbleClose: document.getElementById("faithBubbleClose"),

      modalIntel: document.getElementById("modalIntel"),
      intelList: document.getElementById("intelList"),
      intelSearch: document.getElementById("intelSearch"),
      btnExportIntel: document.getElementById("btnExportIntel"),
      btnClearIntel: document.getElementById("btnClearIntel"),

      modalSeed: document.getElementById("modalSeed"),
      seedArea: document.getElementById("seedArea"),
      btnSeedSave: document.getElementById("btnSeedSave"),

      modalFaith: document.getElementById("modalFaith"),
      faithList: document.getElementById("faithList"),

      modalIdentity: document.getElementById("modalIdentity"),
      identityArea: document.getElementById("identityArea"),
      btnSaveIdentity: document.getElementById("btnSaveIdentity"),
      btnDeleteIdentity: document.getElementById("btnDeleteIdentity"),
      identityStatus: document.getElementById("identityStatus"),

      modalLLM: document.getElementById("modalLLM"),
      btnInitOffline: document.getElementById("btnInitOffline"),
      offlineStatus: document.getElementById("offlineStatus"),
      apiEndpoint: document.getElementById("apiEndpoint"),
      apiModel: document.getElementById("apiModel"),
      apiKey: document.getElementById("apiKey"),
      btnSaveLLM: document.getElementById("btnSaveLLM"),

      modalBM: document.getElementById("modalBM"),
      bmSearch: document.getElementById("bmSearch"),
      bmList: document.getElementById("bmList"),
      btnBMExport: document.getElementById("btnBMExport"),
      btnBMClear: document.getElementById("btnBMClear"),

      logicArea: document.getElementById("logicArea"),
      btnValidateLogic: document.getElementById("btnValidateLogic"),
      btnSaveLogic: document.getElementById("btnSaveLogic"),
      btnCopyLogic: document.getElementById("btnCopyLogic"),
      btnDeleteLogic: document.getElementById("btnDeleteLogic"),
      logicHint: document.getElementById("logicHint"),
      logicSerial: document.getElementById("logicSerial"),

      dreamDelay: document.getElementById("dreamDelay"),
      btnSaveDream: document.getElementById("btnSaveDream"),
      btnTestDream: document.getElementById("btnTestDream"),

      toast: document.getElementById("toast"),
    };

    let visionImageData = null; // base64 dataURL

    function toast(msg){
      els.toast.textContent = msg;
      els.toast.classList.add("show");
      setTimeout(()=>els.toast.classList.remove("show"), 1600);
    }

    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

    function saveAll(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state, (k,v)=>{
        // avoid storing audio blob in localStorage (too large). We store only flags and image data.
        if(k==="lastAudioBlob") return null;
        return v;
      }));
      saveCfg();
    }

    function saveCfg(){
      const cfg = {
        voiceOn: state.voiceOn,
        learningOn: state.learningOn,
        faithSelection: state.faithSelection,
        faithLiveOptions: state.faithLiveOptions,
        apiConfig: state.apiConfig,
        sense: { camOn: !!state.sense?.camOn, micOn: !!state.sense?.micOn }, // only flags
        dream: { enabled: !!state.dreamEnabled, delayMs: state.dreamDelayMs }
      };
      localStorage.setItem(CFG_KEY, JSON.stringify(cfg));
    }

    function loadCfg(){
      try{
        const raw = localStorage.getItem(CFG_KEY);
        if(!raw) return;
        const cfg = JSON.parse(raw);
        if(cfg){
          state.voiceOn = !!cfg.voiceOn;
          state.learningOn = cfg.learningOn !== false;
          state.faithSelection = Array.isArray(cfg.faithSelection) ? cfg.faithSelection : [];
          state.faithLiveOptions = cfg.faithLiveOptions || {};
          if(cfg.apiConfig) state.apiConfig = cfg.apiConfig;
          if(cfg.sense){
            state.sense = state.sense || {};
            state.sense.camOn = !!cfg.sense.camOn;
            state.sense.micOn = !!cfg.sense.micOn;
          }
          if(cfg.dream){
            state.dreamEnabled = !!cfg.dream.enabled;
            state.dreamDelayMs = cfg.dream.delayMs || state.dreamDelayMs;
          }
        }
        els.voicePill.textContent = state.voiceOn ? "on" : "off";
        els.voicePill.className = state.voiceOn ? "pillOn" : "pillOff";
        if(els.camPill){ els.camPill.textContent = state.sense?.camOn ? "on":"off"; els.camPill.className = state.sense?.camOn ? "pillOn":"pillOff"; }
        if(els.micPill){ els.micPill.textContent = state.sense?.micOn ? "on":"off"; els.micPill.className = state.sense?.micOn ? "pillOn":"pillOff"; }
        els.learnPill.textContent = state.learningOn ? "on" : "off";
        els.learnPill.className = state.learningOn ? "pillOn" : "pillOff";
      }catch(_){}
    }

    function loadAll(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const obj = JSON.parse(raw);
        if(obj){
          state = { ...state, ...obj };
          // ensure injected state exists
          if(!state.sense) state.sense = { camOn:false, micOn:false, lastSnapAt:null, lastMicAt:null, lastImageData:null, lastAudioBlob:null, lastSummary:"" };
          if(!state.apiConfig) state.apiConfig = { endpoint:"", model:"", key:"" };
          if(!state.metrics) state.metrics = {E0:0,TM:0,BM:0,C:0.85,TRC:0.75};
        }
      }catch(_){}
    }

    function openModal(el){ el.classList.add("show"); }
    function closeModalById(id){
      const el = document.getElementById(id);
      if(el) el.classList.remove("show");
    }

    document.body.addEventListener("click",(e)=>{
      const target = e.target;
      if(target.dataset && target.dataset.close){
        closeModalById(target.dataset.close);
        if(target.dataset.close==="modalSense"){ try{ stopCamera(); }catch(_){} try{ stopMic(); }catch(_){} }
      }
      if(target.classList && target.classList.contains("modalOverlay") && !target.classList.contains("modal")){
        // clicking overlay background closes
        if(target.id) closeModalById(target.id);
        if(target.id==="modalSense"){ try{ stopCamera(); }catch(_){} try{ stopMic(); }catch(_){} }
      }
    });

    // ====== Metrics / theme ======
    function updateMetricsFromState(){
      // simple placeholders (keep existing style)
      const tm = clamp((state.history?.length || 0)/20, 0, 1);
      const bm = clamp((state.bmPrompts?.length || 0)/30, 0, 1);
      state.metrics.TM = Number(tm.toFixed(2));
      state.metrics.BM = Number(bm.toFixed(2));
      // E0 based on last emotion slope (placeholder)
      state.metrics.E0 = Number((Math.tanh((tm*bm) - 0.3)).toFixed(3));
      state.metrics.C = Number((0.65 + 0.35*bm).toFixed(3));
    }
    function applyEmotionalTheme(){
      const e0 = state.metrics.E0;
      const root = document.documentElement;
      let baseColor = "#0ea5e9";
      if(e0 > 0.3) baseColor = "#fbbf24";
      else if(e0 < -0.3) baseColor = "#64748b";
      root.style.setProperty("--accent-color", baseColor);
    }
    function renderCapsule(){
      els.cE0.textContent = state.metrics.E0.toFixed(3);
      els.cTM.textContent = state.metrics.TM.toFixed(2);
      els.cBM.textContent = state.metrics.BM.toFixed(2);
      els.cCont.textContent = state.metrics.C.toFixed(3);
      els.contVal.textContent = state.metrics.C.toFixed(2);
      els.emoVal.textContent = state.metrics.E0.toFixed(2);
      els.trcVal.textContent = state.metrics.TRC.toFixed(2);
    }

    // ====== Chat render ======
    function renderChat(){
      els.console.innerHTML = "";
      (state.history||[]).forEach(m=>{
        const div = document.createElement("div");
        div.className = "msg " + (m.role==="user" ? "user":"aura");
        div.textContent = m.text;
        const meta = document.createElement("div");
        meta.className = "msgMeta";
        if(m.source) meta.innerHTML = `<span>source: ${m.source}</span>`;
        if(m.emo) meta.innerHTML += `<span>emo: ${m.emo}</span>`;
        div.appendChild(meta);
        els.console.appendChild(div);
      });
      els.console.scrollTop = els.console.scrollHeight;
    }

    function pickFaithBubble(){
      const sel = (state.faithSelection||[])[0];
      if(!sel){
        els.faithBubbleTitle.textContent = "Faith reflection";
        els.faithBubbleMeta.textContent = "Select a faith lens to see a short reflection.";
        return;
      }
      const key = sel.toLowerCase();
      const art = FAITH_ARTIFACTS[key];
      if(!art){
        els.faithBubbleTitle.textContent = "Faith reflection";
        els.faithBubbleMeta.textContent = "No artifact found.";
        return;
      }
      const pref = state.faithLiveOptions?.[key]?.lang || defaultDeviceLang;
      const sample = art.samples[Math.floor(Math.random()*art.samples.length)] || {};
      const head = (key==="islam" && sample.ar) ? sample.ar : (sample.en || "");
      const body = (pref==="urdu" ? (sample.ur || art.translations.urdu || "") : (sample.en || art.translations.english || ""));
      els.faithBubbleTitle.textContent = "Faith reflection";
      els.faithBubbleMeta.textContent = (head? head + "\n":"") + body;
    }

    function updateEthicBox(){
      // base ethic + selected faith statement (without showing lens labels)
      const key = (state.faithSelection||[])[0]?.toLowerCase();
      let extra = "";
      if(key && FAITH_ARTIFACTS[key]){
        const art = FAITH_ARTIFACTS[key];
        const pref = state.faithLiveOptions?.[key]?.lang || defaultDeviceLang;
        const sample = art.samples[Math.floor(Math.random()*art.samples.length)] || {};
        const head = (key==="islam" && sample.ar) ? sample.ar : "";
        const body = (pref==="urdu" ? (sample.ur || art.translations.urdu || "") : (sample.en || art.translations.english || ""));
        extra = (head? head + "\n":"") + body;
      }
      els.ethicMain.textContent = ETHIC_BASE;
      els.ethicMeta.textContent = extra;
      els.faithLabel.textContent = key ? key : "none";
      els.faithLabel.className = key ? "pillOn" : "pillOff";
    }

    // ====== BM ======
    function renderBM(){
      const q = (els.bmSearch.value||"").toLowerCase().trim();
      const list = (state.bmPrompts||[]).filter(p=>{
        if(!q) return true;
        return (p.title||"").toLowerCase().includes(q) || (p.prompt||"").toLowerCase().includes(q);
      });
      els.bmList.innerHTML = "";
      list.forEach(p=>{
        const card = document.createElement("div");
        card.className="card";
        const top = document.createElement("div");
        top.className="cardTop";
        const left = document.createElement("div");
        left.innerHTML = `<div class="title">${p.title || "BM Prompt"}</div>
          <div class="subt">${new Date(p.createdAt || Date.now()).toLocaleString()} ¬∑ ${p.type||"prompt"} ¬∑ ${p.locked?"locked":"unlocked"}</div>`;
        const btns = document.createElement("div");
        btns.className="cardBtns";
        const bCopy = document.createElement("button");
        bCopy.className="btn";
        bCopy.textContent="Copy";
        bCopy.onclick=()=>{ navigator.clipboard.writeText(p.prompt||""); toast("Copied"); };
        const bToggle = document.createElement("button");
        bToggle.className="btn";
        bToggle.textContent = p.locked ? "Unlock" : "Lock";
        bToggle.onclick=()=>{
          if(p.locked){
            const ok = confirm("Unlock this BM prompt?");
            if(!ok) return;
            p.locked=false;
          }else{
            p.locked=true;
          }
          saveAll(); renderBM();
        };
        const bDel = document.createElement("button");
        bDel.className="btn btnRed";
        bDel.textContent="Delete";
        bDel.onclick=()=>{
          if(p.locked){ toast("Unlock first."); return; }
          const ok = confirm("Delete this BM prompt?");
          if(!ok) return;
          const ok2 = confirm("Are you sure? This cannot be undone.");
          if(!ok2) return;
          state.bmPrompts = state.bmPrompts.filter(x=>x.id!==p.id);
          saveAll(); renderBM();
        };
        btns.appendChild(bCopy);
        btns.appendChild(bToggle);
        btns.appendChild(bDel);
        top.appendChild(left);
        top.appendChild(btns);

        const div = document.createElement("div");
        div.style.marginTop="10px";
        div.style.whiteSpace="pre-wrap";
        div.style.fontSize="14px";
        div.textContent = p.prompt || "";
        card.appendChild(top);
        card.appendChild(div);
        els.bmList.appendChild(card);
      });
    }

    // ====== Intelligence (simple) ======
    function renderIntel(){
      const q = (els.intelSearch.value||"").toLowerCase().trim();
      const list = (state.intelligence||[]).filter(it=>{
        if(!q) return true;
        return (it.q||"").toLowerCase().includes(q) || (it.a||"").toLowerCase().includes(q);
      });
      els.intelList.innerHTML="";
      list.forEach((it, idx)=>{
        const c = document.createElement("div");
        c.className="card";
        const top = document.createElement("div");
        top.className="cardTop";
        const left = document.createElement("div");
        left.innerHTML = `<div class="title">${(it.q||"").slice(0,80) || "Q/A"}</div>
          <div class="subt">${it.locked?"locked":"unlocked"} ¬∑ ${it.createdAt ? new Date(it.createdAt).toLocaleString():""}</div>`;
        const btns = document.createElement("div");
        btns.className="cardBtns";

        const bUnlock = document.createElement("button");
        bUnlock.className="btn";
        bUnlock.textContent = it.locked ? "Unlock" : "Lock";
        bUnlock.onclick=()=>{
          if(it.locked){
            if(!confirm("Unlock this learned item?")) return;
            it.locked=false;
          }else{
            it.locked=true;
          }
          saveAll(); renderIntel();
        };

        const bDel = document.createElement("button");
        bDel.className="btn btnRed";
        bDel.textContent="Delete";
        bDel.onclick=()=>{
          if(it.locked){ toast("Unlock first."); return; }
          if(!confirm("Delete this item?")) return;
          if(!confirm("Are you sure?")) return;
          state.intelligence.splice(idx,1);
          saveAll(); renderIntel();
        };

        btns.appendChild(bUnlock);
        btns.appendChild(bDel);
        top.appendChild(left); top.appendChild(btns);

        const qa = document.createElement("div");
        qa.style.marginTop="10px";
        qa.innerHTML = `<div style="font-weight:900">Q:</div><div style="white-space:pre-wrap">${escapeHtml(it.q||"")}</div>
          <div style="font-weight:900;margin-top:8px">A:</div><div style="white-space:pre-wrap">${escapeHtml(it.a||"")}</div>`;

        // inline edit area (kept simple)
        const edit = document.createElement("textarea");
        edit.className="logicArea intelEditArea";
        edit.value = `Q: ${it.q||""}\nA: ${it.a||""}`;
        const bSave = document.createElement("button");
        bSave.className="btn btnBlue";
        bSave.textContent="Save edit";
        bSave.onclick=()=>{
          if(it.locked){ toast("Unlock first."); return; }
          const txt = edit.value;
          const mq = txt.match(/Q:\s*([\s\S]*?)\nA:/);
          const ma = txt.match(/\nA:\s*([\s\S]*)$/);
          if(mq) it.q = mq[1].trim();
          if(ma) it.a = ma[1].trim();
          saveAll(); renderIntel(); toast("Saved");
        };

        c.appendChild(top);
        c.appendChild(qa);
        c.appendChild(document.createElement("div")).className="divider";
        c.appendChild(edit);
        c.appendChild(document.createElement("div")).style.marginTop="8px";
        c.lastChild.appendChild(bSave);

        els.intelList.appendChild(c);
      });
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }

    // ====== Faith config list ======
    function renderFaithCfg(){
      els.faithCfgList.innerHTML="";
      FAITH_TOP10.forEach(name=>{
        const k = name.toLowerCase();
        const row = document.createElement("div");
        row.className="card";
        const enabled = !!state.faithLiveOptions?.[k]?.enabled;
        const lang = state.faithLiveOptions?.[k]?.lang || defaultDeviceLang;
        row.innerHTML = `
          <div class="cardTop">
            <div>
              <div class="title">${name}</div>
              <div class="subt">Live bar display + language</div>
            </div>
            <div class="cardBtns">
              <button class="btn ${enabled?'btnBlue':''}" data-faith-toggle="${k}">${enabled?'Enabled':'Enable'}</button>
              <button class="btn" data-faith-lang="${k}">${lang}</button>
            </div>
          </div>`;
        els.faithCfgList.appendChild(row);
      });
      els.faithCfgList.querySelectorAll("[data-faith-toggle]").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const k = btn.dataset.faithToggle;
          state.faithLiveOptions = state.faithLiveOptions || {};
          state.faithLiveOptions[k] = state.faithLiveOptions[k] || { enabled:false, lang:defaultDeviceLang };
          state.faithLiveOptions[k].enabled = !state.faithLiveOptions[k].enabled;
          saveCfg(); renderFaithCfg(); toast("Updated");
        });
      });
      els.faithCfgList.querySelectorAll("[data-faith-lang]").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const k = btn.dataset.faithLang;
          state.faithLiveOptions = state.faithLiveOptions || {};
          state.faithLiveOptions[k] = state.faithLiveOptions[k] || { enabled:false, lang:defaultDeviceLang };
          state.faithLiveOptions[k].lang = (state.faithLiveOptions[k].lang==="urdu") ? "english" : "urdu";
          saveCfg(); renderFaithCfg(); toast("Language toggled");
        });
      });
    }

    function renderFaithList(){
      els.faithList.innerHTML="";
      FAITH_TOP10.forEach(name=>{
        const k = name.toLowerCase();
        const item = document.createElement("div");
        item.className="card";
        const active = (state.faithSelection||[]).includes(name);
        item.innerHTML = `
          <div class="cardTop">
            <div>
              <div class="title">${name}</div>
              <div class="subt">Tap to ${active?'remove':'select'}</div>
            </div>
            <div class="cardBtns">
              <button class="btn ${active?'btnBlue':''}" data-faith="${name}">${active?'Selected':'Select'}</button>
            </div>
          </div>`;
        els.faithList.appendChild(item);
      });
      els.faithList.querySelectorAll("[data-faith]").forEach(b=>{
        b.addEventListener("click",()=>{
          const name = b.dataset.faith;
          state.faithSelection = state.faithSelection || [];
          if(state.faithSelection.includes(name)){
            state.faithSelection = state.faithSelection.filter(x=>x!==name);
          }else{
            state.faithSelection = [name]; // single select for simplicity
          }
          saveCfg();
          updateEthicBox();
          pickFaithBubble();
          renderFaithList();
        });
      });
    }

    // ====== Dream mode ======
    function armDream(){
      clearTimeout(state.dreamTimer);
      if(!state.dreamEnabled) return;
      state.dreamTimer = setTimeout(()=>{
        // simple dream: show bubble and toast
        pickFaithBubble();
        els.faithBubble.classList.add("show");
      }, state.dreamDelayMs);
    }

    function resetActivity(){
      armDream();
    }

    // ====== LLM fallback ======
    async function callOnlineLLM(userText){
      const endpoint = (state.apiConfig.endpoint||"").trim();
      const model = (state.apiConfig.model||"").trim();
      const key = (state.apiConfig.key||"").trim();
      if(!endpoint || !model || !key) return null;
      try{
        const res = await fetch(endpoint, {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":`Bearer ${key}`
          },
          body: JSON.stringify({
            model,
            messages:[
              {role:"system", content:"You are AURA-X Œ©. Be concise, safe, and helpful."},
              {role:"user", content:userText}
            ],
            temperature:0.6
          })
        });
        const j = await res.json();
        return j?.choices?.[0]?.message?.content || null;
      }catch(_){
        return null;
      }
    }

    function findLearnedAnswer(q){
      const list = state.intelligence||[];
      const qq = (q||"").toLowerCase();
      const hit = list.find(it=> (it.q||"").toLowerCase()===qq);
      return hit ? hit.a : null;
    }

    async function respond(userText){
      state.lastUserQ = userText;

      // 1) learned
      const learned = findLearnedAnswer(userText);
      if(learned){
        state.lastAnswerSource="learned";
        return learned;
      }

      // 2) online if configured
      const online = await callOnlineLLM(userText);
      if(online){
        state.lastAnswerSource="api";
        return online;
      }

      // 3) fallback offline simple
      state.lastAnswerSource="local";
      return "I understood. (Offline mode) Tell me more, and I will keep continuity in BM/TM.";
    }

    // ====== Vision image pick ======
    els.btnVisionPick.addEventListener("click", ()=> els.visionInput.click());
    els.visionInput.addEventListener("change", ()=>{
      const f = els.visionInput.files?.[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        visionImageData = reader.result;
        els.imgPrev.src = visionImageData;
        els.imgPrev.style.display="block";
        toast("Image attached");
      };
      reader.readAsDataURL(f);
    });
    els.btnClearVision.addEventListener("click", ()=>{
      visionImageData = null;
      els.visionInput.value = "";
      els.imgPrev.src = "";
      els.imgPrev.style.display="none";
      toast("Image cleared");
    });

    // ====== Options menu ======
    els.btnOptions.addEventListener("click",()=>{ els.optionsMenu.classList.toggle("show"); });

    els.miVoice.addEventListener("click",()=>{
      state.voiceOn = !state.voiceOn;
      els.voicePill.textContent = state.voiceOn ? "on" : "off";
      els.voicePill.className = state.voiceOn ? "pillOn" : "pillOff";
      saveCfg();
    });

    // ====== ‚úÖ Injected Camera/Mic sensing ======
    let camStream = null;
    let micStream = null;
    let mediaRecorder = null;
    let audioChunks = [];

    const senseEls = {
      modal: document.getElementById("modalSense"),
      video: document.getElementById("senseVideo"),
      canvas: document.getElementById("senseCanvas"),
      summary: document.getElementById("senseSummary"),
      snapInfo: document.getElementById("senseSnapInfo"),
      micInfo: document.getElementById("senseMicInfo"),
      micStatus: document.getElementById("micInfo"),
      btnCamStart: document.getElementById("btnCamStart"),
      btnCamStop: document.getElementById("btnCamStop"),
      btnSnap: document.getElementById("btnSnap"),
      btnMicStart: document.getElementById("btnMicStart"),
      btnMicStop: document.getElementById("btnMicStop"),
      btnMicTest: document.getElementById("btnMicTest"),
      btnAnalyze: document.getElementById("btnSenseAnalyze"),
      btnSaveBM: document.getElementById("btnSenseSaveBM"),
    };

    function setPill(pillEl, on){
      if(!pillEl) return;
      pillEl.textContent = on ? "on" : "off";
      pillEl.className = on ? "pillOn" : "pillOff";
    }

    async function startCamera(){
      if(camStream) return;
      camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
      senseEls.video.srcObject = camStream;
      state.sense.camOn = true;
      setPill(els.camPill, true);
      saveCfg();
    }
    function stopCamera(){
      if(!camStream) return;
      camStream.getTracks().forEach(t=>t.stop());
      camStream = null;
      senseEls.video.srcObject = null;
      state.sense.camOn = false;
      setPill(els.camPill, false);
      saveCfg();
    }
    async function startMic(){
      if(micStream) return;
      micStream = await navigator.mediaDevices.getUserMedia({ video:false, audio:true });
      state.sense.micOn = true;
      setPill(els.micPill, true);
      senseEls.micStatus.textContent = "Mic: ready";
      saveCfg();
    }
    function stopMic(){
      try{
        if(mediaRecorder && mediaRecorder.state!=="inactive") mediaRecorder.stop();
      }catch(_){}
      if(!micStream) return;
      micStream.getTracks().forEach(t=>t.stop());
      micStream = null;
      state.sense.micOn = false;
      setPill(els.micPill, false);
      senseEls.micStatus.textContent = "Mic: idle";
      saveCfg();
    }

    function takeSnapshot(){
      if(!camStream) return null;
      const v = senseEls.video;
      const c = senseEls.canvas;
      const w = Math.min(960, v.videoWidth || 640);
      const h = Math.round(w * ((v.videoHeight || 480) / (v.videoWidth || 640)));
      c.width = w; c.height = h;
      const ctx = c.getContext("2d");
      ctx.drawImage(v, 0, 0, w, h);
      const dataUrl = c.toDataURL("image/jpeg", 0.78);
      state.sense.lastImageData = dataUrl;
      state.sense.lastSnapAt = new Date().toISOString();
      senseEls.snapInfo.textContent = new Date().toLocaleTimeString();
      saveCfg();
      return dataUrl;
    }

    async function recordMicChunk(ms=7000){
      if(!micStream) await startMic();
      if(!micStream) return null;
      audioChunks = [];
      mediaRecorder = new MediaRecorder(micStream);
      mediaRecorder.ondataavailable = (e)=>{ if(e.data && e.data.size) audioChunks.push(e.data); };
      const done = new Promise((resolve)=>{
        mediaRecorder.onstop = ()=> resolve(new Blob(audioChunks, { type: mediaRecorder.mimeType || "audio/webm" }));
      });
      mediaRecorder.start();
      senseEls.micStatus.textContent = "Mic: recording‚Ä¶";
      await new Promise(r=>setTimeout(r, ms));
      try{ mediaRecorder.stop(); }catch(_){}
      const blob = await done;
      state.sense.lastAudioBlob = blob;
      state.sense.lastMicAt = new Date().toISOString();
      senseEls.micInfo.textContent = new Date().toLocaleTimeString();
      senseEls.micStatus.textContent = "Mic: captured";
      saveCfg();
      return blob;
    }

    function heuristicSceneSummary(){
      const parts = [];
      if(state.sense.lastImageData) parts.push("Visual: snapshot captured (details pending).");
      if(state.sense.lastAudioBlob) parts.push("Audio: short ambience captured (details pending).");
      const base = parts.length ? parts.join(" ") : "No camera/mic capture yet.";
      return base + "\n\nBM Prompt template:\nDescribe what happened, who/what is present, actions, environment, and emotional tone. Include a short timeline (00:00‚Äì00:10).";
    }

    async function analyzeScene(){
      const endpoint = (state.apiConfig.endpoint || "").trim();
      const key = (state.apiConfig.key || "").trim();
      const model = (state.apiConfig.model || "").trim();
      if(!endpoint || !key || !model){
        const txt = heuristicSceneSummary();
        senseEls.summary.value = txt;
        state.sense.lastSummary = txt;
        saveCfg();
        return;
      }

      const messages = [{
        role:"user",
        content:[
          { type:"text", text:
            "Analyze this scene and return a compact JSON with: {scene, entities, actions, sounds, emotional_tone, safety_flags, bm_prompt}. Keep it faithful (no hallucinated specifics). If unsure, mark unknown."
          }
        ]
      }];

      if(state.sense.lastImageData){
        messages[0].content.push({ type:"image_url", image_url:{ url: state.sense.lastImageData } });
      }
      if(state.sense.lastAudioBlob){
        messages[0].content.push({ type:"text", text:"Audio captured: yes (ambience/voice). If your API supports audio, extend this client accordingly." });
      }

      try{
        const res = await fetch(endpoint, {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":`Bearer ${key}`
          },
          body: JSON.stringify({
            model,
            messages,
            temperature: 0.2
          })
        });
        const j = await res.json();
        const out = j?.choices?.[0]?.message?.content || JSON.stringify(j);
        senseEls.summary.value = out;
        state.sense.lastSummary = out;
        saveCfg();
      }catch(err){
        const txt = "API analyze failed. Fallback summary:\n" + heuristicSceneSummary();
        senseEls.summary.value = txt;
        state.sense.lastSummary = txt;
        saveCfg();
      }
    }

    function saveSenseToBM(){
      const content = (senseEls.summary.value || "").trim() || heuristicSceneSummary();
      const promptObj = {
        id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())),
        createdAt: new Date().toISOString(),
        type: "scene_prompt",
        title: "Scene ‚Üí BM prompt",
        prompt: content,
        locked: false
      };
      state.bmPrompts.unshift(promptObj);
      saveAll();
      renderBM();
      toast("Saved to BM.");
    }

    // options menu bindings
    els.miCamera.addEventListener("click", async()=>{
      try{
        if(state.sense.camOn) stopCamera();
        else await startCamera();
      }catch(_){
        toast("Camera permission denied or unavailable.");
        stopCamera();
      }
    });
    els.miMicSense.addEventListener("click", async()=>{
      try{
        if(state.sense.micOn) stopMic();
        else await startMic();
      }catch(_){
        toast("Mic permission denied or unavailable.");
        stopMic();
      }
    });
    els.miSense.addEventListener("click", ()=>{
      openModal(senseEls.modal);
      els.optionsMenu.classList.remove("show");
    });

    // sense modal buttons
    if(senseEls.btnCamStart) senseEls.btnCamStart.addEventListener("click", async()=>{ try{ await startCamera(); }catch(_){ toast("Camera permission denied."); } });
    if(senseEls.btnCamStop)  senseEls.btnCamStop.addEventListener("click", ()=> stopCamera());
    if(senseEls.btnSnap)     senseEls.btnSnap.addEventListener("click", ()=>{ const ok = takeSnapshot(); if(ok) toast("Snapshot captured."); else toast("Start camera first."); });
    if(senseEls.btnMicStart) senseEls.btnMicStart.addEventListener("click", async()=>{ try{ await recordMicChunk(8000); }catch(_){ toast("Mic permission denied."); } });
    if(senseEls.btnMicStop)  senseEls.btnMicStop.addEventListener("click", ()=> stopMic());
    if(senseEls.btnMicTest)  senseEls.btnMicTest.addEventListener("click", ()=>{ try{ const a = new (window.AudioContext||window.webkitAudioContext)(); const o=a.createOscillator(); const g=a.createGain(); g.gain.value=0.02; o.connect(g); g.connect(a.destination); o.frequency.value=880; o.start(); setTimeout(()=>{o.stop(); a.close();}, 120); }catch(_){ } });
    if(senseEls.btnAnalyze)  senseEls.btnAnalyze.addEventListener("click", ()=> analyzeScene());
    if(senseEls.btnSaveBM)   senseEls.btnSaveBM.addEventListener("click", ()=> saveSenseToBM());

    // ====== rest options ======
    els.miLearn.addEventListener("click",()=>{
      state.learningOn = !state.learningOn;
      els.learnPill.textContent = state.learningOn ? "on" : "off";
      els.learnPill.className = state.learningOn ? "pillOn" : "pillOff";
      saveCfg();
      toast("Learning " + (state.learningOn?"on":"off"));
    });

    els.miIntel.addEventListener("click",()=>{
      openModal(els.modalIntel);
      els.optionsMenu.classList.remove("show");
      renderIntel();
    });

    els.miSeed.addEventListener("click",()=>{
      openModal(els.modalSeed);
      els.optionsMenu.classList.remove("show");
    });

    els.miFaith.addEventListener("click",()=>{
      openModal(els.modalFaith);
      els.optionsMenu.classList.remove("show");
      renderFaithList();
    });

    els.miIdentity.addEventListener("click",()=>{
      openModal(els.modalIdentity);
      els.optionsMenu.classList.remove("show");
    });

    els.miLLM.addEventListener("click",()=>{
      openModal(els.modalLLM);
      els.optionsMenu.classList.remove("show");
      els.apiEndpoint.value = state.apiConfig.endpoint || "https://api.openai.com/v1/chat/completions";
      els.apiModel.value = state.apiConfig.model || "gpt-4o-mini";
      els.apiKey.value = state.apiConfig.key || "";
    });

    els.miBMRecall.addEventListener("click",()=>{
      openModal(els.modalBM);
      els.optionsMenu.classList.remove("show");
      renderBM();
    });

    // ====== Faith bubble controls ======
    els.faithBubbleClose.addEventListener("click",()=> els.faithBubble.classList.remove("show"));
    els.faithBubble.addEventListener("click",()=>{
      if(!els.faithBubble.classList.contains("show")) return;
      pickFaithBubble();
    });

    // Faith live bar settings
    els.faithCfgBtn.addEventListener("click",()=>{
      openModal(els.modalFaithCfg);
      renderFaithCfg();
    });

    // Seed save
    els.btnSeedSave.addEventListener("click",()=>{
      const txt = (els.seedArea.value||"").trim();
      if(!txt){ toast("Empty"); return; }
      // very simple parser: lines "Q:" "A:"
      const chunks = txt.split(/\n{2,}/);
      chunks.forEach(ch=>{
        const mq = ch.match(/Q:\s*([\s\S]*?)\nA:/);
        const ma = ch.match(/\nA:\s*([\s\S]*)$/);
        if(mq && ma){
          state.intelligence.unshift({
            q: mq[1].trim(),
            a: ma[1].trim(),
            locked:true,
            createdAt: new Date().toISOString()
          });
        }
      });
      els.seedArea.value="";
      saveAll();
      toast("Saved (locked)");
    });

    // Identity save/delete
    els.btnSaveIdentity.addEventListener("click",()=>{
      const txt = (els.identityArea.value||"").trim();
      if(!txt){ toast("Empty"); return; }
      state.userIdentity = { text: txt, locked:true, createdAt:new Date().toISOString() };
      saveAll();
      els.identityStatus.textContent = "Identity saved (locked).";
      toast("Saved");
    });
    els.btnDeleteIdentity.addEventListener("click",()=>{
      if(!state.userIdentity){ toast("No identity"); return; }
      if(state.userIdentity.locked){
        if(!confirm("Unlock identity first?")) return;
        state.userIdentity.locked=false;
        saveAll();
        els.identityStatus.textContent = "Identity unlocked.";
        toast("Unlocked");
        return;
      }
      if(!confirm("Delete identity?")) return;
      if(!confirm("Are you sure?")) return;
      state.userIdentity=null;
      saveAll();
      els.identityArea.value="";
      els.identityStatus.textContent="No identity saved.";
      toast("Deleted");
    });

    // LLM save
    els.btnSaveLLM.addEventListener("click",()=>{
      state.apiConfig.endpoint = (els.apiEndpoint.value||"").trim();
      state.apiConfig.model = (els.apiModel.value||"").trim();
      state.apiConfig.key = (els.apiKey.value||"").trim();
      saveCfg();
      toast("Saved");
    });

    // Intel export/clear/search
    els.intelSearch.addEventListener("input", renderIntel);
    els.btnClearIntel.addEventListener("click",()=>{
      const before = state.intelligence.length;
      state.intelligence = (state.intelligence||[]).filter(it=>it.locked);
      saveAll(); renderIntel();
      toast(`Cleared ${before - state.intelligence.length}`);
    });
    els.btnExportIntel.addEventListener("click",()=>{
      const blob = new Blob([JSON.stringify(state.intelligence||[], null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "aurax_intelligence.json";
      a.click();
      toast("Exported");
    });

    // BM export/clear/search
    els.bmSearch.addEventListener("input", renderBM);
    els.btnBMClear.addEventListener("click",()=>{
      const before = state.bmPrompts.length;
      state.bmPrompts = (state.bmPrompts||[]).filter(p=>p.locked);
      saveAll(); renderBM();
      toast(`Cleared ${before - state.bmPrompts.length}`);
    });
    els.btnBMExport.addEventListener("click",()=>{
      const blob = new Blob([JSON.stringify(state.bmPrompts||[], null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "aurax_bm_prompts.json";
      a.click();
      toast("Exported");
    });

    // Logic pack simple behavior
    function loadLogic(){
      try{
        const raw = localStorage.getItem("aurax_logic_pack");
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(_){ return null; }
    }
    function saveLogicPack(obj){
      localStorage.setItem("aurax_logic_pack", JSON.stringify(obj));
    }
    let currentLogic = loadLogic();
    function renderLogic(){
      if(currentLogic){
        els.logicArea.value = currentLogic.text || "";
        els.logicHint.textContent = "Logic pack loaded.";
        els.logicSerial.textContent = currentLogic.serial || "unknown";
      }else{
        els.logicArea.value = "";
        els.logicHint.textContent = "No logic pack loaded.";
        els.logicSerial.textContent = "none";
      }
    }
    els.btnValidateLogic.addEventListener("click",()=>{
      const txt = (els.logicArea.value||"").trim();
      if(!txt){ toast("Empty"); return; }
      toast("Looks OK");
    });
    els.btnSaveLogic.addEventListener("click",()=>{
      const txt = (els.logicArea.value||"").trim();
      if(!txt){ toast("Empty"); return; }
      currentLogic = { serial: "LP-"+Date.now(), text: txt };
      saveLogicPack(currentLogic);
      els.logicArea.value = ""; // ‚úÖ auto clear
      toast("Saved");
      renderLogic();
    });
    els.btnCopyLogic.addEventListener("click",()=>{
      navigator.clipboard.writeText((els.logicArea.value||"").trim() || (currentLogic?.text||""));
      toast("Copied");
    });
    els.btnDeleteLogic.addEventListener("click",()=>{
      if(!currentLogic){ toast("None"); return; }
      if(!confirm("Delete logic pack?")) return;
      localStorage.removeItem("aurax_logic_pack");
      currentLogic=null;
      renderLogic();
      toast("Deleted");
    });

    // Dream settings
    els.btnSaveDream.addEventListener("click",()=>{
      state.dreamDelayMs = Number(els.dreamDelay.value||30000);
      saveCfg();
      toast("Dream saved");
      armDream();
    });
    els.btnTestDream.addEventListener("click",()=>{
      pickFaithBubble();
      els.faithBubble.classList.add("show");
      toast("Dream test");
    });

    // Send
    async function onSend(){
      const text = (els.userInput.value||"").trim();
      if(!text && !visionImageData) return;
      els.userInput.value="";
      resetActivity();

      if(text){
        state.history.push({role:"user", text, ts:Date.now()});
      }else{
        state.history.push({role:"user", text:"[image]", ts:Date.now()});
      }

      const answer = await respond(text || "Describe this image.");
      state.history.push({role:"aura", text: answer, ts:Date.now(), source: state.lastAnswerSource || "local"});
      // Keep history lightweight (48h idea can be added later; for now keep as-is)
      saveAll();
      updateMetricsFromState();
      applyEmotionalTheme();
      renderCapsule();
      updateEthicBox();
      renderChat();
    }
    els.sendBtn.addEventListener("click", onSend);
    els.userInput.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        onSend();
      }
    });

    // Global activity reset
    ["click","keydown","touchstart","mousemove"].forEach(ev=>{
      document.addEventListener(ev, resetActivity, {passive:true});
    });

    // Init
    loadCfg();
    loadAll();
    updateMetricsFromState();
    applyEmotionalTheme();
    renderCapsule();
    updateEthicBox();
    renderLogic();
    renderChat();
    renderBM();
    renderIntel();
    renderFaithList();
    renderFaithCfg();

    // If cfg had cam/mic ON, do NOT auto-start streams (privacy). Pills show state, but actual start requires user click.
    state.sense.camOn = false;
    state.sense.micOn = false;
    if(els.camPill) { els.camPill.textContent="off"; els.camPill.className="pillOff"; }
    if(els.micPill) { els.micPill.textContent="off"; els.micPill.className="pillOff"; }
    saveCfg();

    armDream();
  </script>
</body>
</html>