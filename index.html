<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Î© â€“ Faith Bubble Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ---------- RESET ---------- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 0% 0%, #0f172a 0, transparent 50%),
        radial-gradient(circle at 100% 0%, #0369a1 0, transparent 50%),
        linear-gradient(145deg,#020617 0,#020617 45%,#020617 100%);
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
    }

    .app {
      width: 100%;
      max-width: 1200px;
      background: linear-gradient(180deg, rgba(15,23,42,0.96), rgba(15,23,42,0.98));
      border-radius: 28px;
      box-shadow:
        0 24px 80px rgba(15,23,42,0.85),
        0 0 0 1px rgba(148,163,184,0.18);
      padding: 18px 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* ---------- HEADER ---------- */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 10px 14px;
      border-radius: 18px;
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,0.12), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(251,191,36,0.12), transparent 55%),
        linear-gradient(135deg, rgba(15,23,42,0.98), rgba(15,23,42,0.98));
      border: 1px solid rgba(148,163,184,0.4);
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .orb {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, #e5e7eb, #facc15 35%, transparent 60%),
        radial-gradient(circle at 80% 80%, #0ea5e9, #1d4ed8 55%);
      box-shadow:
        0 0 22px rgba(250,204,21,0.7),
        0 0 40px rgba(56,189,248,0.45);
      position: relative;
      overflow: hidden;
    }
    .orb::after {
      content: "";
      position: absolute;
      inset: 18%;
      border-radius: inherit;
      border: 1px solid rgba(15,23,42,0.65);
      box-shadow: inset 0 0 10px rgba(15,23,42,0.7);
    }
    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .title-main {
      font-size: 1.05rem;
      font-weight: 600;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      color: #e5e7eb;
    }
    .title-sub {
      font-size: 0.78rem;
      color: #9ca3af;
    }
    .header-ethics {
      font-size: 0.8rem;
      line-height: 1.2;
      max-width: 310px;
      text-align: right;
      color: #fbbf24;
      font-weight: 500;
    }

    /* ---------- LAYOUT ---------- */
    .main {
      display: grid;
      grid-template-columns: minmax(0, 0.9fr) minmax(0, 1.4fr);
      gap: 16px;
    }

    /* ---------- LEFT PANEL (METRICS) ---------- */
    .panel {
      background: radial-gradient(circle at 0% 0%, rgba(56,189,248,0.12), transparent 55%),
                  rgba(15,23,42,0.96);
      border-radius: 22px;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 12px 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .panel-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #9ca3af;
      padding-bottom: 2px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .metric-card {
      border-radius: 14px;
      padding: 8px 9px;
      background: radial-gradient(circle at 0% 0%, rgba(251,191,36,0.1), transparent 60%),
                  rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .metric-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #9ca3af;
    }
    .metric-value {
      font-size: 0.95rem;
      font-weight: 600;
      color: #e5e7eb;
    }
    .metric-sub {
      font-size: 0.72rem;
      color: #9ca3af;
    }

    .continuity-bar-wrapper {
      margin-top: 4px;
    }
    .continuity-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .continuity-label-row span {
      font-size: 0.7rem;
      color: #9ca3af;
    }
    .continuity-bar {
      width: 100%;
      height: 7px;
      border-radius: 999px;
      background: rgba(31,41,55,0.95);
      overflow: hidden;
      position: relative;
    }
    .continuity-fill {
      height: 100%;
      width: 40%;
      border-radius: inherit;
      background: linear-gradient(90deg, #22c55e, #eab308, #f97316, #ef4444);
      box-shadow: 0 0 12px rgba(52,211,153,0.7);
      transition: width 0.35s ease-out;
    }
    .continuity-marker {
      position: absolute;
      inset: -4px auto -4px 50%;
      width: 1px;
      background: rgba(148,163,184,0.4);
      opacity: 0.7;
    }

    .tm-bm-card {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 4px;
    }
    .tm-bm-block {
      background: rgba(15,23,42,0.95);
      border-radius: 12px;
      padding: 7px 8px;
      border: 1px solid rgba(55,65,81,0.9);
    }
    .tm-bm-label {
      font-size: 0.7rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #9ca3af;
    }
    .tm-bm-value {
      font-size: 0.9rem;
      font-weight: 600;
      margin-top: 1px;
    }
    .tm-bm-sub {
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 1px;
    }

    .settings-block {
      margin-top: 6px;
      padding: 7px 8px;
      border-radius: 12px;
      background: rgba(15,23,42,0.96);
      border: 1px dashed rgba(75,85,99,0.9);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .settings-row label {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .toggle {
      position: relative;
      width: 38px;
      height: 18px;
      border-radius: 999px;
      background: #111827;
      border: 1px solid rgba(55,65,81,0.9);
      cursor: pointer;
      flex-shrink: 0;
    }
    .toggle-thumb {
      position: absolute;
      top: 1px;
      left: 1px;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #6b7280;
      transition: transform 0.22s ease-out, background 0.22s ease-out;
    }
    .toggle.on {
      background: rgba(22,163,74,0.3);
      border-color: #22c55e;
    }
    .toggle.on .toggle-thumb {
      transform: translateX(18px);
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34,197,94,0.9);
    }
    .faith-select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      padding: 2px 8px;
      font-size: 0.75rem;
      color: #e5e7eb;
      outline: none;
    }

    /* ---------- RIGHT PANEL (CHAT) ---------- */
    .chat-panel {
      background: radial-gradient(circle at 100% 0%, rgba(56,189,248,0.14), transparent 60%),
                  rgba(15,23,42,0.97);
      border-radius: 22px;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 10px 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 420px;
    }

    .chat-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 4px 0;
    }
    .chat-header-row span {
      font-size: 0.78rem;
      color: #9ca3af;
    }
    .chat-header-accent {
      font-size: 0.7rem;
      color: #38bdf8;
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .chat-window {
      flex: 1;
      min-height: 260px;
      max-height: 480px;
      overflow-y: auto;
      padding: 8px 4px 8px 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .chat-window::-webkit-scrollbar {
      width: 6px;
    }
    .chat-window::-webkit-scrollbar-thumb {
      background: rgba(75,85,99,0.9);
      border-radius: 999px;
    }

    .msg-row {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .msg-row.user { align-items: flex-end; }
    .msg-row.bot { align-items: flex-start; }

    .bubble {
      max-width: 80%;
      padding: 7px 9px;
      border-radius: 14px;
      font-size: 0.86rem;
      line-height: 1.35;
      position: relative;
    }
    .bubble.user {
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: #ecfdf5;
      border-bottom-right-radius: 4px;
      box-shadow: 0 6px 18px rgba(22,163,74,0.55);
    }
    .bubble.bot {
      background: radial-gradient(circle at 0% 0%, rgba(56,189,248,0.15), transparent 60%),
                  #020617;
      border: 1px solid rgba(55,65,81,0.9);
      color: #e5e7eb;
      border-bottom-left-radius: 4px;
      box-shadow: 0 8px 24px rgba(15,23,42,0.9);
    }
    .bubble.faith {
      background: radial-gradient(circle at 100% 0%, rgba(251,191,36,0.24), transparent 60%),
                  #020617;
      border: 1px solid rgba(250,204,21,0.7);
      color: #fefce8;
      font-size: 0.8rem;
      max-width: 70%;
      border-radius: 16px;
      border-top-left-radius: 2px;
      margin-top: 1px;
      position: relative;
    }
    .bubble.faith::before {
      content: "ðŸ’­";
      position: absolute;
      top: -11px;
      left: 10px;
      font-size: 0.8rem;
      opacity: 0.9;
    }
    .bubble-meta {
      font-size: 0.7rem;
      color: #6b7280;
    }

    .reaction-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(55,65,81,0.9);
      font-size: 0.68rem;
      color: #9ca3af;
      margin-top: 2px;
    }
    .reaction-tag span:first-child {
      font-size: 0.8rem;
    }

    /* ---------- COMPOSER ---------- */
    .composer {
      margin-top: 4px;
      border-radius: 18px;
      border: 1px solid rgba(55,65,81,0.95);
      background: radial-gradient(circle at 0% 0%, rgba(56,189,248,0.14), transparent 60%),
                  rgba(15,23,42,0.96);
      padding: 6px 8px 6px 10px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }
    .composer-inner {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .composer-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #6b7280;
    }
    .composer-input {
      border: none;
      outline: none;
      resize: none;
      background: transparent;
      color: #e5e7eb;
      font-size: 0.86rem;
      line-height: 1.35;
      max-height: 68px;
      min-height: 18px;
      padding: 3px 0 1px;
    }
    .composer-input::placeholder {
      color: #4b5563;
    }
    .send-btn {
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: #ecfdf5;
      font-size: 0.78rem;
      padding: 7px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 8px 22px rgba(22,163,74,0.7);
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out, opacity 0.1s ease-out;
      flex-shrink: 0;
    }
    .send-btn:active {
      transform: translateY(1px);
      box-shadow: 0 4px 12px rgba(22,163,74,0.6);
    }
    .send-btn.disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .composer-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 2px;
    }
    .composer-hint {
      font-size: 0.7rem;
      color: #6b7280;
    }

    /* ---------- RESPONSIVE ---------- */
    @media (max-width: 900px) {
      .main {
        grid-template-columns: minmax(0, 1fr);
      }
      .chat-panel {
        order: -1;
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-ethics {
        text-align: left;
        max-width: none;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <header class="header">
    <div class="header-left">
      <div class="orb"></div>
      <div class="title-block">
        <div class="title-main">AURA-X Î© â€“ Emotional Continuity</div>
        <div class="title-sub">Dual-Memory Â· Reaction Engine Â· Faith Bubble Prototype</div>
      </div>
    </div>
    <div class="header-ethics">
      Avoid actions that create deep negativity in yourself or others.  
      Gently move toward choices that grow kindness, clarity, and long-term good.
    </div>
  </header>

  <main class="main">
    <!-- LEFT: METRICS & SETTINGS -->
    <section class="panel">
      <div class="panel-title">Emotional Continuity Matrix</div>

      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-label">Polarity</div>
          <div class="metric-value" id="polarityValue">Neutral</div>
          <div class="metric-sub" id="polaritySub">No strong tilt yet.</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Intensity</div>
          <div class="metric-value" id="intensityValue">0.00</div>
          <div class="metric-sub" id="intensitySub">Very soft field.</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Reaction Family</div>
          <div class="metric-value" id="reactionValue">R000 Â· Idle</div>
          <div class="metric-sub" id="reactionSub">No specific reaction triggered yet.</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Emotion Code</div>
          <div class="metric-value" id="emotionValue">E000 Â· None</div>
          <div class="metric-sub" id="emotionSub">Waiting for stable signal.</div>
        </div>
      </div>

      <div class="continuity-bar-wrapper">
        <div class="continuity-label-row">
          <span>Continuity Index</span>
          <span id="continuityLabel">0.00</span>
        </div>
        <div class="continuity-bar">
          <div class="continuity-fill" id="continuityFill"></div>
          <div class="continuity-marker"></div>
        </div>
      </div>

      <div class="tm-bm-card">
        <div class="tm-bm-block">
          <div class="tm-bm-label">TM Â· Recent Trace</div>
          <div class="tm-bm-value" id="tmCount">0 items</div>
          <div class="tm-bm-sub" id="tmSub">Ephemeral conversation fragments.</div>
        </div>
        <div class="tm-bm-block">
          <div class="tm-bm-label">BM Â· Bold Memory</div>
          <div class="tm-bm-value" id="bmCount">0 items</div>
          <div class="tm-bm-sub" id="bmSub">Consolidated emotional anchors.</div>
        </div>
      </div>

      <div class="settings-block">
        <div class="settings-row">
          <label>Faith Mode</label>
          <div class="toggle" id="faithToggle">
            <div class="toggle-thumb"></div>
          </div>
        </div>
        <div class="settings-row">
          <label>Faith / Worldview</label>
          <select class="faith-select" id="faithSelect">
            <option value="islam">Islam (demo)</option>
            <option value="christian">Christian (demo)</option>
            <option value="none">None / Secular</option>
          </select>
        </div>
        <div class="settings-row">
          <label style="font-size:0.7rem;color:#6b7280;">
            Faith bubble appears only when emotional context really needs it.
          </label>
        </div>
      </div>
    </section>

    <!-- RIGHT: CHAT -->
    <section class="chat-panel">
      <div class="chat-header-row">
        <span>Continuity-aware conversation channel</span>
        <span class="chat-header-accent">TM = user input + system reply</span>
      </div>

      <div class="chat-window" id="chatWindow"></div>

      <div class="composer">
        <div class="composer-inner">
          <div class="composer-label">Message</div>
          <textarea
            id="userInput"
            class="composer-input"
            rows="1"
            placeholder="Share what you are thinking or feeling right now..."
          ></textarea>
          <div class="composer-footer">
            <div class="composer-hint">
              Press Enter to send Â· Shift+Enter for new line
            </div>
          </div>
        </div>
        <button id="sendBtn" class="send-btn">
          <span>Send</span>
          <span>âž¤</span>
        </button>
      </div>
    </section>
  </main>
</div>

<script>
  // -----------------------------
  //  CORE STATE
  // -----------------------------
  const state = {
    tm: [], // recent conversation fragments
    bm: [], // consolidated memory
    lastEmotionCode: "E000",
    emotionCounts: {},   // for repetition
    continuityIndex: 0,
    speechVoices: [],
    auraSettings: {
      faithMode: true,
      userFaith: "islam"
    }
  };

  // -----------------------------
  //  FAITH LIBRARY (DEMO LINES)
  // -----------------------------
  const FAITH_LIBRARY = {
    islam: {
      comfort: [
        "Remember: with hardship comes relief.",
        "Your patience in hardship is seen and valued.",
        "In moments like this, turning gently to prayer can bring quiet strength."
      ],
      gratitude: [
        "Gratitude for small blessings keeps the heart soft.",
        "When you whisper thanks, you are watering the roots of your soul."
      ],
      hope: [
        "No situation is beyond the reach of mercy.",
        "Even long nights end; a new dawn is already written."
      ],
      wisdom: [
        "A calm heart and a thoughtful mind are both gifts to protect.",
        "True wisdom is to remember your purpose even when you are tired."
      ]
    },
    christian: {
      comfort: [
        "You are not walking through this valley alone.",
        "Grace is still available even when you feel empty."
      ],
      gratitude: [
        "A thankful heart can carry surprising strength."
      ],
      hope: [
        "There is always room for a new beginning."
      ],
      wisdom: [
        "Gentle decisions made in love never lose their value."
      ]
    }
    // Other faiths can be added here.
  };

  // -----------------------------
  //  SENTIMENT MOCK (RULE-BASED)
  // -----------------------------
  function analyzeSentiment(text) {
    const lower = text.toLowerCase();
    let polarity = "neutral";
    let intensity = 0.15;
    let category = "neutral";
    let emotionCode = "E000";

    const negWords = ["sad", "tired", "afraid", "scared", "worried", "anxious", "angry", "upset", "depressed", "hopeless", "pain"];
    const posWords = ["happy", "grateful", "thankful", "excited", "hopeful", "calm", "relaxed", "peaceful"];
    const strongWords = ["very", "so", "extremely", "really", "too much", "deeply"];

    let negScore = 0, posScore = 0;

    negWords.forEach(w => { if (lower.includes(w)) negScore += 1; });
    posWords.forEach(w => { if (lower.includes(w)) posScore += 1; });
    strongWords.forEach(w => {
      if (lower.includes(w)) {
        negScore *= 1.4;
        posScore *= 1.4;
      }
    });

    if (negScore > posScore && negScore > 0) {
      polarity = "negative";
      intensity = Math.min(1, 0.4 + negScore * 0.2);
      if (lower.includes("angry") || lower.includes("upset") || lower.includes("irritated")) {
        category = "anger";
        emotionCode = "E201";
      } else if (lower.includes("afraid") || lower.includes("scared") || lower.includes("worried")) {
        category = "fear";
        emotionCode = "E202";
      } else {
        category = "sadness";
        emotionCode = "E203";
      }
    } else if (posScore > negScore && posScore > 0) {
      polarity = "positive";
      intensity = Math.min(1, 0.4 + posScore * 0.18);
      if (lower.includes("grateful") || lower.includes("thankful")) {
        category = "gratitude";
        emotionCode = "E101";
      } else if (lower.includes("hopeful") || lower.includes("excited")) {
        category = "hope";
        emotionCode = "E102";
      } else {
        category = "joy";
        emotionCode = "E103";
      }
    } else {
      polarity = "neutral";
      intensity = 0.15;
      category = "neutral";
      emotionCode = "E000";
    }

    return { polarity, intensity, category, emotionCode };
  }

  // -----------------------------
  //  CONTINUITY & MEMORY UPDATE
  // -----------------------------
  function updateContinuityLayers(userText, sentiment) {
    // TM: keep last 12 turns
    state.tm.push({ text: userText, sentiment, ts: Date.now() });
    if (state.tm.length > 12) state.tm.shift();

    // BM: add only if intensity strong or repeated emotion
    const { emotionCode, intensity } = sentiment;
    state.emotionCounts[emotionCode] = (state.emotionCounts[emotionCode] || 0) + 1;
    const repeatCount = state.emotionCounts[emotionCode];

    if (intensity >= 0.55 || repeatCount >= 3) {
      state.bm.push({
        emotionCode,
        polarity: sentiment.polarity,
        category: sentiment.category,
        intensity,
        ts: Date.now(),
        summary: userText.slice(0, 120)
      });
      if (state.bm.length > 60) state.bm.shift();
    }

    // Continuity index ~ how aligned current emotion is with BM pattern
    const bmSize = state.bm.length;
    let alignment = 0;
    if (bmSize > 0) {
      let matches = 0;
      state.bm.forEach(m => {
        if (m.emotionCode === emotionCode) matches += 1;
      });
      alignment = matches / bmSize;
    }

    // Simple E0 / continuity: combine intensity + alignment
    const raw = (sentiment.intensity * 1.2) + alignment - 0.3;
    const e0 = Math.tanh(raw);
    state.continuityIndex = (e0 + 1) / 2; // 0..1

    state.lastEmotionCode = emotionCode;
    return { e0, continuityIndex: state.continuityIndex, repeatCount };
  }

  function getRepeatCount(emotionCode) {
    return state.emotionCounts[emotionCode] || 0;
  }

  // -----------------------------
  //  REACTION FAMILY SELECTION
  // -----------------------------
  function pickReactionFamily(sentiment, e0, continuityIndex, repeatCount) {
    const { polarity, category, intensity, emotionCode } = sentiment;

    // Idle / neutral
    if (polarity === "neutral" && intensity < 0.25) {
      return {
        id: "R000",
        label: "Baseline Presence",
        emoji: "ðŸŒ—",
        description: "Light attention, no strong pull. Holding space and listening."
      };
    }

    if (polarity === "negative") {
      if (category === "sadness") {
        if (intensity > 0.7 || repeatCount >= 3) {
          return {
            id: "R041",
            label: "Deep Containment",
            emoji: "ðŸ•Šï¸",
            description: "Gently holding heavy sadness with slow, stabilizing responses."
          };
        }
        return {
          id: "R031",
          label: "Soft Comfort",
          emoji: "ðŸ¤",
          description: "Warm, validating, softly reflective responses to sadness."
        };
      }
      if (category === "fear") {
        return {
          id: "R052",
          label: "Grounding",
          emoji: "ðŸª¨",
          description: "Reducing anxiety with grounding, clarity and small next steps."
        };
      }
      if (category === "anger") {
        if (intensity > 0.65) {
          return {
            id: "R061",
            label: "Fire Containment",
            emoji: "ðŸ”¥",
            description: "Acknowledging anger but steering away from escalation."
          };
        }
        return {
          id: "R062",
          label: "De-escalation",
          emoji: "ðŸ’§",
          description: "Cooling the temperature and inviting thoughtful reflection."
        };
      }
    }

    if (polarity === "positive") {
      if (category === "gratitude") {
        return {
          id: "R012",
          label: "Gratitude Mirroring",
          emoji: "âœ¨",
          description: "Echoing thankfulness, strengthening a healthy emotional loop."
        };
      }
      if (category === "hope") {
        return {
          id: "R013",
          label: "Forward Hope",
          emoji: "ðŸŒ…",
          description: "Supporting hopeful direction with gentle, realistic optimism."
        };
      }
      return {
        id: "R011",
        label: "Light Joy",
        emoji: "ðŸŒ¼",
        description: "Sharing mild happiness without over-stimulating the system."
      };
    }

    // fallback
    return {
      id: "R010",
      label: "Neutral Reflection",
      emoji: "ðŸ”",
      description: "Thinking with you, not pushing the mood in any direction."
    };
  }

  // -----------------------------
  //  FAITH DOMAIN SELECTION
  // -----------------------------
  function getFaithDomain(sentiment, reactionId) {
    const { polarity, category } = sentiment;

    if (polarity === "negative") {
      if (category === "sadness" || category === "fear") {
        return "comfort";
      }
      if (category === "anger") {
        return "wisdom";
      }
    }

    if (polarity === "positive") {
      if (category === "gratitude") return "gratitude";
      return "hope";
    }

    if (category === "wisdom" || reactionId === "R010") {
      return "wisdom";
    }

    return "hope";
  }

  function maybeCreateFaithBubble(sentiment, reaction, settings) {
    if (!settings.faithMode) return null;
    if (!settings.userFaith || settings.userFaith === "none") return null;

    const faithSet = FAITH_LIBRARY[settings.userFaith];
    if (!faithSet) return null;

    const domain = getFaithDomain(sentiment, reaction.id);
    const bucket = faithSet[domain] || [];
    if (!bucket.length) return null;

    const text = bucket[Math.floor(Math.random() * bucket.length)];
    const voice = pickFaithVoiceProfile(sentiment, reaction.id);

    return {
      type: "faith-bubble",
      text,
      domain,
      reactionId: reaction.id,
      voice
    };
  }

  // -----------------------------
  //  VOICE SELECTION (OLD MAN)
  // -----------------------------
  function initVoices() {
    state.speechVoices = window.speechSynthesis.getVoices() || [];
  }

  function pickOldManBaseVoice() {
    if (!state.speechVoices.length) return null;
    // crude heuristic: pick a male / neutral voice if possible
    let candidate = state.speechVoices.find(v =>
      /male|grandfather|old|mature/i.test(v.name)
    );
    if (!candidate) {
      candidate = state.speechVoices.find(v =>
        /english/i.test(v.lang)
      );
    }
    return candidate || state.speechVoices[0];
  }

  function pickFaithVoiceProfile(sentiment, reactionId) {
    const base = {
      voice: pickOldManBaseVoice(),
      pitch: 0.9,
      rate: 0.95,
      volume: 1.0
    };

    if (sentiment.polarity === "negative") {
      if (sentiment.intensity >= 0.66) {
        base.pitch = 0.85;
        base.rate = 0.9;
      } else {
        base.pitch = 0.9;
        base.rate = 0.96;
      }
    }

    if (sentiment.polarity === "positive") {
      base.pitch = 0.95;
      base.rate = 1.03;
    }

    if (reactionId === "R061" || reactionId === "R062") {
      base.rate = 0.88;
      base.pitch = 0.84;
    }

    return base;
  }

  function speakFaithBubble(faithBubble) {
    if (!faithBubble || !window.speechSynthesis) return;
    const utter = new SpeechSynthesisUtterance(faithBubble.text);
    const profile = faithBubble.voice;
    if (profile.voice) utter.voice = profile.voice;
    utter.pitch = profile.pitch;
    utter.rate = profile.rate;
    utter.volume = profile.volume;
    window.speechSynthesis.speak(utter);
  }

  // Simple Aura main voice (you can tune separately)
  function speakMainAnswer(text) {
    if (!window.speechSynthesis) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.pitch = 1.0;
    utter.rate = 1.02;
    utter.volume = 1.0;
    window.speechSynthesis.speak(utter);
  }

  // -----------------------------
  //  ANSWER GENERATION (DEMO)
  // -----------------------------
  function generateMainAnswer(userText, sentiment, reaction, repeatCount) {
    const { polarity, category, intensity } = sentiment;

    if (polarity === "negative") {
      if (category === "sadness") {
        return "I can feel that things are a bit heavy for you right now. " +
               "You donâ€™t have to solve everything at once. " +
               "If you want, we can name what hurts in small, clear pieces.";
      }
      if (category === "fear") {
        return "It sounds like there is some anxiety or worry sitting in the background. " +
               "Letâ€™s slow the situation down together and separate what is real risk from what is just noise.";
      }
      if (category === "anger") {
        return "Your anger makes sense if something important feels disrespected or ignored. " +
               "We can explore it in a way that protects you without burning everything around you.";
      }
    }

    if (polarity === "positive") {
      if (category === "gratitude") {
        return "I like how you are noticing what youâ€™re grateful for. " +
               "Staying aware of small blessings builds a very stable emotional base over time.";
      }
      if (category === "hope") {
        return "That sounds hopeful. " +
               "If youâ€™d like, we can turn that hope into one or two concrete, realistic next steps.";
      }
      return "Itâ€™s good to hear some lightness in what you wrote. " +
             "If you want, we can use this positive space to plan something meaningful.";
    }

    // Neutral conversation or mixed signal
    if (repeatCount >= 2) {
      return "I see this topic is coming back again and again for you. " +
             "Maybe there is a deeper pattern or decision underneath it that we can look at more directly.";
    }

    return "Iâ€™m here with you, listening carefully. " +
           "Tell me a bit more about what this moment actually feels like from inside your chest and your thoughts.";
  }

  // -----------------------------
  //  UI RENDERING
  // -----------------------------
  const chatWindow = document.getElementById("chatWindow");
  const userInput = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");

  const polarityValue = document.getElementById("polarityValue");
  const polaritySub = document.getElementById("polaritySub");
  const intensityValue = document.getElementById("intensityValue");
  const intensitySub = document.getElementById("intensitySub");
  const reactionValue = document.getElementById("reactionValue");
  const reactionSub = document.getElementById("reactionSub");
  const emotionValue = document.getElementById("emotionValue");
  const emotionSub = document.getElementById("emotionSub");
  const continuityLabel = document.getElementById("continuityLabel");
  const continuityFill = document.getElementById("continuityFill");
  const tmCount = document.getElementById("tmCount");
  const tmSub = document.getElementById("tmSub");
  const bmCount = document.getElementById("bmCount");
  const bmSub = document.getElementById("bmSub");

  const faithToggle = document.getElementById("faithToggle");
  const faithSelect = document.getElementById("faithSelect");

  function addMessageBubble(role, text, meta = {}) {
    const row = document.createElement("div");
    row.className = "msg-row " + (role === "user" ? "user" : "bot");

    const bubble = document.createElement("div");
    bubble.className = "bubble " + (role === "user" ? "user" : "bot");
    bubble.textContent = text;
    row.appendChild(bubble);

    if (meta.reaction) {
      const tag = document.createElement("div");
      tag.className = "reaction-tag";
      tag.innerHTML = `<span>${meta.reaction.emoji}</span><span>${meta.reaction.id} Â· ${meta.reaction.label}</span>`;
      row.appendChild(tag);
    }

    if (meta.emotionLine) {
      const em = document.createElement("div");
      em.className = "bubble-meta";
      em.textContent = meta.emotionLine;
      row.appendChild(em);
    }

    chatWindow.appendChild(row);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function addFaithBubble(faithBubble) {
    if (!faithBubble) return;

    const row = document.createElement("div");
    row.className = "msg-row bot";

    const bubble = document.createElement("div");
    bubble.className = "bubble faith";
    bubble.textContent = faithBubble.text;

    const meta = document.createElement("div");
    meta.className = "bubble-meta";
    meta.textContent = `Faith reflection Â· Domain: ${faithBubble.domain}`;

    row.appendChild(bubble);
    row.appendChild(meta);

    chatWindow.appendChild(row);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  function updateMetricsUI(sentiment, reaction, continuityIndex) {
    const { polarity, intensity, category, emotionCode } = sentiment;

    polarityValue.textContent = polarity.charAt(0).toUpperCase() + polarity.slice(1);
    if (polarity === "positive") {
      polaritySub.textContent = "Field leaning toward constructive emotion.";
    } else if (polarity === "negative") {
      polaritySub.textContent = "Field leaning toward discomfort or pain.";
    } else {
      polaritySub.textContent = "No strong positive or negative pull yet.";
    }

    intensityValue.textContent = intensity.toFixed(2);
    if (intensity < 0.3) {
      intensitySub.textContent = "Very soft signal, almost background noise.";
    } else if (intensity < 0.6) {
      intensitySub.textContent = "Moderate signal, emotionally noticeable.";
    } else {
      intensitySub.textContent = "Strong emotional field â€“ handle gently.";
    }

    reactionValue.textContent = `${reaction.id} Â· ${reaction.label}`;
    reactionSub.textContent = reaction.description;

    emotionValue.textContent = `${emotionCode} Â· ${category}`;
    if (category === "neutral") {
      emotionSub.textContent = "Waiting for a clearer emotional direction.";
    } else {
      emotionSub.textContent = "Active emotional category detected in this turn.";
    }

    continuityLabel.textContent = continuityIndex.toFixed(2);
    continuityFill.style.width = `${Math.max(5, continuityIndex * 100)}%`;

    tmCount.textContent = `${state.tm.length} items`;
    bmCount.textContent = `${state.bm.length} items`;

    if (state.tm.length === 0) {
      tmSub.textContent = "Ephemeral conversation fragments.";
    } else {
      tmSub.textContent = "Recent conversational traces used to feel continuity.";
    }

    if (state.bm.length === 0) {
      bmSub.textContent = "No strong emotional anchors stored yet.";
    } else {
      bmSub.textContent = "Anchored emotional patterns shaping long-term tone.";
    }
  }

  // -----------------------------
  //  MAIN HANDLER
  // -----------------------------
  function handleSend() {
    const text = userInput.value.trim();
    if (!text) return;

    // Disable send shortly to avoid double send
    sendBtn.classList.add("disabled");

    addMessageBubble("user", text);

    const sentiment = analyzeSentiment(text);
    const { e0, continuityIndex, repeatCount } = updateContinuityLayers(text, sentiment);
    const reaction = pickReactionFamily(sentiment, e0, continuityIndex, repeatCount);
    const mainAnswer = generateMainAnswer(text, sentiment, reaction, repeatCount);
    const faithBubble = maybeCreateFaithBubble(sentiment, reaction, state.auraSettings);

    const emotionLine =
      `Polarity: ${sentiment.polarity}, Intensity: ${sentiment.intensity.toFixed(2)}, ` +
      `Emotion: ${sentiment.category}`;

    // Render Aura main answer
    addMessageBubble("bot", mainAnswer, { reaction, emotionLine });

    // Render optional faith bubble
    if (faithBubble) {
      addFaithBubble(faithBubble);
      speakFaithBubble(faithBubble);
    }

    // Speak main answer
    speakMainAnswer(mainAnswer);

    updateMetricsUI(sentiment, reaction, continuityIndex);

    userInput.value = "";
    userInput.focus();

    setTimeout(() => sendBtn.classList.remove("disabled"), 120);
  }

  // -----------------------------
  //  INIT & EVENT BINDING
  // -----------------------------
  document.addEventListener("DOMContentLoaded", () => {
    // voices
    if (window.speechSynthesis) {
      window.speechSynthesis.onvoiceschanged = initVoices;
      initVoices();
    }

    // Faith toggle
    faithToggle.addEventListener("click", () => {
      faithToggle.classList.toggle("on");
      state.auraSettings.faithMode = faithToggle.classList.contains("on");
    });
    // default ON
    faithToggle.classList.add("on");

    // Faith select
    faithSelect.addEventListener("change", (e) => {
      state.auraSettings.userFaith = e.target.value;
    });

    // Send button
    sendBtn.addEventListener("click", handleSend);

    // Enter to send
    userInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // Initial system intro
    const intro =
      "Hello, I am AURA-X Î©. I watch how your feelings move over time, " +
      "not just one message at a time. When faith mode is on, I may also " +
      "offer a gentle faith-based reflection in a separate bubble, spoken in an older voice.";
    addMessageBubble("bot", intro, {
      reaction: {
        id: "R000",
        label: "Baseline Presence",
        emoji: "ðŸŒ—",
        description: "Soft, neutral attention."
      },
      emotionLine: "Polarity: neutral, Intensity: 0.15, Emotion: neutral"
    });
    updateMetricsUI(
      { polarity: "neutral", intensity: 0.15, category: "neutral", emotionCode: "E000" },
      { id: "R000", label: "Baseline Presence", emoji: "ðŸŒ—", description: "Soft, neutral attention." },
      0
    );
  });
</script>
</body>
</html>