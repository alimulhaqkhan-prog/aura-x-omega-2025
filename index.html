<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Offline LLM package (WebLLM, for in-browser models ‚Äì future ready) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root { --accent-color:#0ea5e9; }
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px 10px;
    }
    .app{
      width:min(980px,98vw);
      background:rgba(2,6,23,.45);
      border:1px solid rgba(148,163,184,.18);
      border-radius:22px;
      overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
    }
    .top{
      padding:20px 18px 10px;
      border-bottom:1px solid rgba(148,163,184,.14);
      text-align:center;
      position:relative;
    }
    .brand{
      font-weight:800;
      letter-spacing:.5px;
      font-size:26px;
      color:#7dd3fc;
      text-shadow:0 0 22px rgba(14,165,233,.28);
    }
    .sub{
      opacity:.8;
      margin-top:2px;
      font-size:13px;
    }
    .ethic{
      margin:14px auto 12px;
      max-width:720px;
      border:1px solid rgba(251,191,36,.35);
      border-radius:14px;
      padding:10px 36px 9px 14px;
      color:#fbbf24;
      background:rgba(2,6,23,.35);
      box-shadow:inset 0 0 0 1px rgba(251,191,36,.08);
      font-size:14px;
      line-height:1.4;
      position:relative;
      overflow:hidden;
      transition:background .4s ease,border-color .4s ease,transform .4s ease,box-shadow .4s ease;
    }
    .ethicMain{font-weight:600;}
    .ethicMeta{
      font-size:11px;
      opacity:.8;
      margin-top:2px;
      display:none;
    }
    .ethic.ethicPulse{
      animation:ethicPulse 1.1s ease;
    }
    @keyframes ethicPulse{
      0%{box-shadow:0 0 0 0 rgba(251,191,36,.55);transform:translateY(0);}
      45%{box-shadow:0 0 0 16px rgba(251,191,36,0);transform:translateY(-1px);}
      100%{box-shadow:0 0 0 0 rgba(251,191,36,0);transform:translateY(0);}
    }
    .faithCfgBtn{
      position:absolute;
      right:6px;
      top:4px;
      border:none;
      background:transparent;
      color:#fde68a;
      cursor:pointer;
      font-size:16px;
      line-height:1;
      display:none;
      -webkit-tap-highlight-color:transparent;
    }
    .faithCfgBtn.show{display:inline-flex;}
    .pill{
      margin:10px auto 0;
      max-width:760px;
      background:linear-gradient(90deg, rgba(14,165,233,.65), rgba(34,211,238,.45));
      border:1px solid rgba(125,211,252,.30);
      color:#0b1220;
      font-weight:800;
      letter-spacing:.6px;
      border-radius:999px;
      padding:14px 16px;
      text-transform:uppercase;
      box-shadow:0 12px 40px rgba(14,165,233,.22);
      position:relative;
    }
    .pill.faithGlow{
      border-color:rgba(251,191,36,.9);
      box-shadow:0 0 26px rgba(251,191,36,.75);
      background:linear-gradient(90deg, rgba(14,165,233,.6), rgba(251,191,36,.9));
    }
    .main{ padding:16px 16px 18px }
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:stretch}
    .leftCol{ flex:1 1 340px; min-width:300px }
    .rightCol{ flex:1 1 360px; min-width:320px }
    .card{
      background:rgba(2,6,23,.50);
      border:1px solid rgba(148,163,184,.16);
      border-radius:18px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      backdrop-filter:blur(10px);
    }
    .optionsBtn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(15,23,42,.55);
      color:#e5e7eb;
      cursor:pointer;
      user-select:none;
      margin:12px 0;
      -webkit-tap-highlight-color:transparent;
    }
    .optionsBtn:active{transform:scale(.99)}
    .gear{width:18px;height:18px;filter:drop-shadow(0 0 10px rgba(125,211,252,.25))}
    .console{
      margin-top:12px;
      height:210px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(0,0,0,.25);
      padding:14px;
      overflow:auto;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:14px;
      box-shadow:inset 0 0 0 1px rgba(125,211,252,.06);
      line-height:1.55;
      white-space:pre-wrap;
    }
    .line{display:block;margin:2px 0}
    .line.user{color:#a5b4fc;}
    .line.aura{color:#bbf7d0;}
    .line.sys{color:#fbbf24;font-size:12px;}
    .optionsMenu{
      position:fixed;
      left:12px;
      right:12px;
      top:120px;
      margin:0 auto;
      max-width:940px;
      background:rgba(2,6,23,.92);
      border:1px solid rgba(148,163,184,.18);
      border-radius:16px;
      padding:8px;
      display:none;
      z-index:9999;
      box-shadow:0 18px 45px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
      align-items:stretch;
    }
    .optionsMenu.show{display:grid}
    .menuItem{
      padding:8px 6px;
      border-radius:13px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:6px;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.10);
      background:rgba(15,23,42,.55);
      user-select:none;
      min-height:58px;
    }
    .menuItem:active{transform:scale(.995)}
    .menuLeft{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-weight:800;
      font-size:12.5px;
    }
    .menuIcon{
      width:18px;
      height:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .menuRight{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:44px;
    }
    .pillOn,.pillOff,.pillMid{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      font-weight:900;
      text-transform:lowercase;
      border:1px solid transparent;
    }
    .pillOn{
      background:rgba(34,197,94,.18);
      border-color:rgba(34,197,94,.24);
      color:#bbf7d0;
    }
    .pillOff{
      background:rgba(239,68,68,.12);
      border-color:rgba(239,68,68,.22);
      color:#fecaca;
    }
    .pillMid{
      background:rgba(14,165,233,.14);
      border-color:rgba(14,165,233,.20);
      color:#bae6fd;
      opacity:.95;
    }
    .chatWrap{
      position:relative;
      margin-top:0;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.45);
    }

    /* Faith bubble now ABOVE buttons in normal flow */
    .faithBubble{
      position:relative;
      margin-bottom:6px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(251,191,36,.16);
      border:1px solid rgba(251,191,36,.4);
      display:none;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:#facc15;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      transition:opacity .25s ease, transform .25s ease;
      width:100%;
      max-width:100%;
    }
    .faithBubble.show{
      display:flex;
      opacity:1;
      transform:translateY(0);
    }
    .fbIcon{font-size:18px;}
    .fbText{flex:1;line-height:1.3;}
    .fbTitle{font-weight:800;}
    .fbMeta{opacity:.85;}
    .fbClose{
      border:none;
      background:transparent;
      color:#fed7aa;
      font-size:16px;
      cursor:pointer;
      padding:0 4px;
      line-height:1;
    }
    .faithBubble.pulse{
      animation: faithPulse 1.4s infinite;
    }
    .faithBubble.flying{
      animation: faithFlyUp 2.1s ease-in-out forwards, faithBlink 1s ease-in-out 0s 2;
    }
    @keyframes faithPulse{
      0%   { box-shadow: 0 0 0 0 rgba(251,191,36,.55); }
      100% { box-shadow: 0 0 0 18px rgba(251,191,36,0); }
    }
    @keyframes faithFlyUp{
      0%   { transform:translateY(0); opacity:1; }
      60%  { transform:translateY(-140px); opacity:1; }
      100% { transform:translateY(-180px); opacity:0; }
    }
    @keyframes faithBlink{
      0%{box-shadow:0 0 0 0 rgba(251,191,36,.4);}
      50%{box-shadow:0 0 18px 4px rgba(251,191,36,.95);}
      100%{box-shadow:0 0 0 0 rgba(251,191,36,0);}
    }

    .reactionBar{
      margin-top:0;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      font-size:18px;
      opacity:.9;
    }
    .reactBtn{
      border:none;
      background:transparent;
      cursor:pointer;
      padding:4px;
      line-height:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      -webkit-tap-highlight-color:transparent;
    }
    .reactBtn:active{transform:scale(.9)}
    .liveCapsule{
      margin:4px 0 10px;
      width:100%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      padding:8px 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:12px;
      color:#dbeafe;
      box-shadow:inset 0 0 0 1px rgba(125,211,252,.06);
    }
    .liveCapsule b{ color:#7dd3fc; font-weight:900 }
    .inputRow{display:flex;gap:10px;align-items:flex-end;margin-top:4px;}
    .input{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      padding:12px 14px;
      outline:none;
      font-size:14px;
    }
    .send{
      border:none;
      border-radius:999px;
      background:linear-gradient(90deg, var(--accent-color, #0ea5e9), rgba(34,211,238,.55));
      color:#0b1220;
      font-weight:900;
      padding:12px 18px;
      cursor:pointer;
      min-width:88px;
      box-shadow:0 12px 30px rgba(14,165,233,.18);
      -webkit-tap-highlight-color:transparent;
    }
    .send:active{transform:scale(.99)}
    .formula{
      margin-top:10px;
      opacity:.8;
      font-size:12px;
      text-align:center;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      color:#dbeafe;
    }
    .toastBubble{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translate(-50%,10px);
      padding:6px 14px;
      border-radius:999px;
      background:rgba(15,23,42,.95);
      color:#e5e7eb;
      font-size:12px;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:0 12px 30px rgba(0,0,0,.5);
      opacity:0;
      pointer-events:none;
      z-index:10000;
      transition:opacity .18s ease, transform .18s ease;
    }
    .toastBubble.show{
      opacity:1;
      transform:translate(-50%,0);
    }
    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:18px 12px;
      z-index:9999;
    }
    .modalOverlay.show{display:flex}
    .modal{
      width:min(860px,96vw);
      border-radius:18px;
      overflow:hidden;
      background:rgba(250,250,250,.93);
      color:#0b1220;
      border:1px solid rgba(15,23,42,.18);
      box-shadow:0 30px 80px rgba(0,0,0,.35);
      backdrop-filter:blur(12px);
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      background:rgba(255,255,255,.75);
      border-bottom:1px solid rgba(15,23,42,.10);
      font-weight:800;
    }
    .modalHeader small{font-weight:600;opacity:.7}
    .closeX{
      border:none;
      background:transparent;
      font-size:22px;
      cursor:pointer;
      line-height:1;
      padding:0 4px;
      opacity:.75;
    }
    .modalBody{
      padding:14px;
      max-height:70vh;
      overflow:auto;
    }
    .chipsWrap{margin-top:10px;display:flex;flex-wrap:wrap;gap:10px}
    .chip{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.16);
      background:rgba(255,255,255,.9);
      font-weight:800;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      font-size:13px;
    }
    .chip.active{
      background:#0f172a;
      color:#fff;
      border-color:rgba(15,23,42,.2);
      box-shadow:0 12px 30px rgba(2,6,23,.12);
    }
    .btn{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:12px;
      font-weight:900;
      -webkit-tap-highlight-color:transparent;
      font-size:12px;
    }
    .btnBlue{background:rgba(59,130,246,.16);border:1px solid rgba(59,130,246,.22)}
    .btnDark{background:rgba(2,6,23,.92);color:#fff}
    .btnRed{background:rgba(239,68,68,.14);border:1px solid rgba(239,68,68,.22);color:#7f1d1d}
    .btnGreen{background:rgba(34,197,94,.18);border:1px solid rgba(34,197,94,.25);color:#064e2a}
    .bmCard{
      border-radius:16px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.85);
      padding:12px;
      margin-top:12px;
      font-size:13px;
    }
    .bmTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .bmTop .title{
      font-weight:900;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .bmSub{font-size:12px;opacity:.7;margin-top:2px}
    .bmText{
      width:100%;
      min-height:160px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.18);
      padding:12px;
      outline:none;
      resize:vertical;
      background:#fff;
      font-size:14px;
      line-height:1.45;
    }
    .bmActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      justify-content:flex-start;
    }
    .intelCard{
      border-radius:12px;
      border:1px solid rgba(15,23,42,.12);
      background:#f9fafb;
      padding:10px;
      margin-top:8px;
      font-size:13px;
    }
    .intelTop{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-bottom:4px;
    }
    .intelQ{font-weight:700;}
    .intelA{margin-top:2px;white-space:pre-wrap;}
    .intelMeta{font-size:11px;opacity:.65;margin-top:2px;}
    #historyBox{
      margin-top:4px;
      border-radius:14px;
      padding:4px 0;
      max-height:60vh;
      overflow:auto;
    }
    .historyLine{
      padding:8px 10px;
      font-size:12px;
      margin-bottom:6px;
      border-radius:12px;
      background:#f9fafb;
      border:1px solid rgba(148,163,184,.45);
      color:#0b1120;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:6px;
    }
    .historyText{flex:1;white-space:pre-wrap;}
    #dreamOverlay{
      position:fixed;
      inset:0;
      background:
        radial-gradient(circle at 10% 0%, #020617 0, transparent 45%),
        radial-gradient(circle at 90% 0, #0ea5e9 0, transparent 45%),
        rgba(2,6,23,.96);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9500;
      backdrop-filter:blur(16px);
    }
    #dreamOverlay.show{display:flex;}
    .dreamInner{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:16px;
      text-align:center;
      padding:20px 18px;
    }
    .dreamOrb{
      width:120px;
      height:120px;
      border-radius:999px;
      background:
        radial-gradient(circle at 30% 20%, #ffffff, #7dd3fc 40%, transparent 70%);
      border:2px solid rgba(125,211,252,.9);
      box-shadow:0 0 40px rgba(56,189,248,.8);
      animation:dreamPulse 3.5s ease-in-out infinite;
    }
    .dreamTitle{
      font-weight:800;
      font-size:18px;
      color:#e0f2fe;
    }
    .dreamSub{
      max-width:420px;
      font-size:13px;
      color:#bae6fd;
      opacity:.9;
    }
    .dreamMeta{
      margin-top:4px;
      font-size:11px;
      color:#93c5fd;
      opacity:.85;
    }
    @keyframes dreamPulse{
      0%{transform:translateY(0) scale(1);}
      50%{transform:translateY(-6px) scale(1.03);}
      100%{transform:translateY(0) scale(1);}
    }
    #imagePreviewArea{
      display:none;
      margin:6px 2px 2px;
      text-align:center;
      font-size:10px;
      opacity:.8;
    }
    #imgPrev{
      max-height:90px;
      border-radius:10px;
      border:2px solid var(--accent-color);
      margin-bottom:2px;
    }
    @media (max-width:760px){
      .top{padding:14px 14px 6px;}
      .main{padding:10px 10px 14px;}
      .card{padding:10px;}
      .chatWrap{padding:10px;}
      .console{height:200px;}
      .optionsMenu{top:112px}
    }
    @media (max-width:420px){
      .brand{font-size:22px}
      .pill{font-size:14px}
      .ethic{font-size:13px}
      .console{height:210px}
      .optionsMenu{
        gap:6px;
        padding:7px;
        grid-template-columns:repeat(3,minmax(0,1fr));
      }
      .menuItem{min-height:52px;padding:6px 4px;}
      .menuLeft{font-size:11px}
      .pillOn,.pillOff,.pillMid{font-size:9.5px;padding:4px 6px;}
      .reactionBar{font-size:16px;gap:8px;}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="brand">AURA-X Œ©</div>
      <div class="sub">
        Offline emotional continuity engine (prototype)<br>
        TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory.
      </div>
      <div class="ethic" id="ethicBox">
        <div class="ethicMain" id="ethicMain">
          Universal ethic: avoid actions that grow negative emotions in you or others.
          Move gently toward choices that increase shared positive feeling for everyone.
        </div>
        <div class="ethicMeta" id="ethicMeta"></div>
        <button id="faithCfgBtn" class="faithCfgBtn" title="Faith live bar settings">üîò</button>
      </div>
      <div class="pill">EMOTIONAL CONTINUITY ENGINE ‚Äî ACTIVE</div>
    </div>

    <div class="main">
      <div class="row">
        <!-- LEFT SIDE -->
        <div class="leftCol">
          <div class="card">
            <div class="optionsBtn" id="btnOptions">
              <svg class="gear" viewBox="0 0 24 24" fill="none">
                <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"
                      stroke="#7dd3fc" stroke-width="2"/>
                <path d="M19.4 15a8.2 8.2 0 0 0 .1-2l2-1.5-2-3.5-2.4 1a8.5 8.5 0 0 0-1.7-1l-.4-2.6h-4l-.4 2.6a8.5 8.5 0 0 0-1.7 1l-2.4-1-2 3.5 2 1.5a8.2 8.2 0 0 0 .1 2L2.7 16.5l2 3.5 2.4-1a8.5 8.5 0 0 0 1.7 1l.4 2.6h4l.4-2.6a8.5 8.5 0 0 0 1.7-1l2.4 1 2-3.5L19.4 15Z"
                      stroke="#7dd3fc" stroke-width="1.6" opacity=".9"/>
              </svg>
              <span>Options</span>
            </div>
            <div class="optionsMenu" id="optionsMenu">
              <div class="menuItem" id="miVoice">
                <div class="menuLeft"><span class="menuIcon">üé§</span><span>Voice</span></div>
                <div class="menuRight"><span class="pillOff" id="voicePill">off</span></div>
              </div>
              <div class="menuItem" id="miIntel">
                <div class="menuLeft"><span class="menuIcon">üß†</span><span>Intelligence</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miLearn">
                <div class="menuLeft"><span class="menuIcon">üìö</span><span>Learning</span></div>
                <div class="menuRight"><span class="pillOn" id="learnPill">on</span></div>
              </div>
              <div class="menuItem" id="miSeed">
                <div class="menuLeft"><span class="menuIcon">üå±</span><span>Feed</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miFaith">
                <div class="menuLeft"><span class="menuIcon">üïä</span><span>Faith</span></div>
                <div class="menuRight"><span class="pillMid" id="faithLabel">Islam</span></div>
              </div>
              <div class="menuItem" id="miIdentity">
                <div class="menuLeft"><span class="menuIcon">ü™™</span><span>Identity</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miLLM">
                <div class="menuLeft"><span class="menuIcon">ü§ñ</span><span>LLM</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miBMRecall">
                <div class="menuLeft"><span class="menuIcon">üìò</span><span>BM Recall</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miHistory">
                <div class="menuLeft"><span class="menuIcon">üìú</span><span>History</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
            </div>
            <div class="console" id="console"></div>
          </div>
        </div>

        <!-- RIGHT SIDE -->
        <div class="rightCol">
          <div class="chatWrap">
            <!-- Faith bubble at top -->
            <div class="faithBubble" id="faithBubble">
              <div class="fbIcon">üí≠</div>
              <div class="fbText">
                <div class="fbTitle" id="faithBubbleTitle">Faith lens: Islam</div>
                <div class="fbMeta" id="faithBubbleMeta">You'll get updates according to your selected faith lens above.</div>
              </div>
              <button class="fbClose" id="faithBubbleClose">√ó</button>
            </div>

            <div class="reactionBar">
              <button class="reactBtn" id="btnLikeLast" title="Save to Intelligence (like)">üëç</button>
              <button class="reactBtn" id="btnDislikeLast" title="Mark incorrect & teach new answer">üëé</button>
              <button class="reactBtn" id="btnSpeakLast" title="Play voice for last answer">üîä</button>
              <button class="reactBtn" id="btnShareLast" title="Copy question + answer">üîó</button>
            </div>

            <div class="liveCapsule">
              <span><b>E0</b>: <span id="cE0">0.000</span></span><span>¬∑</span>
              <span><b>TM</b>: <span id="cTM">0.00</span></span><span>¬∑</span>
              <span><b>BM</b>: <span id="cBM">0.00</span></span><span>¬∑</span>
              <span><b>C</b>: <span id="cCont">0.850</span></span>
            </div>

            <div class="inputRow">
              <label class="reactBtn" style="cursor:pointer;margin-bottom:12px;">
                üì∑
                <input type="file" id="visionInput" accept="image/*" style="display:none">
              </label>
              <input class="input" id="userInput" placeholder="Talk to AURA-X Œ©‚Ä¶ (TM = your inputs)" />
              <button class="send" id="sendBtn">Send</button>
            </div>
            <div id="imagePreviewArea">
              <img id="imgPrev" alt="preview">
              <div>Image attached for analysis</div>
            </div>
            <div class="formula">
              E‚ÇÄ = tanh( R(TM,BM) + I(TM) + I<sub>intel</sub> + I<sub>LLM</sub> ‚àí D + Œª<sub>faith</sub> + Œª<sub>sys</sub> + Œª<sub>trc</sub> )
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toastBubble" id="toast"></div>

  <!-- Generic modal for Faith / Identity / Intelligence / BM / History -->
  <div class="modalOverlay" id="modalGeneric">
    <div class="modal">
      <div class="modalHeader">
        <div id="modalGenericTitle">Title</div>
        <button class="closeX" id="modalGenericClose">√ó</button>
      </div>
      <div class="modalBody" id="modalGenericBody"></div>
    </div>
  </div>

  <!-- Dream overlay (optional visual, not auto-used ÿßÿ®⁄æ€å) -->
  <div id="dreamOverlay">
    <div class="dreamInner">
      <div class="dreamOrb"></div>
      <div class="dreamTitle">AURA-X Œ© is dreaming‚Ä¶</div>
      <div class="dreamSub">
        When you're away, BM would gently reorganise memories and emotions.  
        This is just a visual prototype ‚Äì no cloud, no external data.
      </div>
      <div class="dreamMeta">Offline emotional continuity concept prototype.</div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const consoleBox = document.getElementById("console");
      const userInput = document.getElementById("userInput");
      const sendBtn = document.getElementById("sendBtn");
      const btnOptions = document.getElementById("btnOptions");
      const optionsMenu = document.getElementById("optionsMenu");
      const toastEl = document.getElementById("toast");

      const faithBubble = document.getElementById("faithBubble");
      const faithBubbleTitle = document.getElementById("faithBubbleTitle");
      const faithBubbleMeta = document.getElementById("faithBubbleMeta");
      const faithBubbleClose = document.getElementById("faithBubbleClose");
      const faithLabel = document.getElementById("faithLabel");
      const faithCfgBtn = document.getElementById("faithCfgBtn");

      const cE0 = document.getElementById("cE0");
      const cTM = document.getElementById("cTM");
      const cBM = document.getElementById("cBM");
      const cCont = document.getElementById("cCont");

      const btnLikeLast = document.getElementById("btnLikeLast");
      const btnDislikeLast = document.getElementById("btnDislikeLast");
      const btnSpeakLast = document.getElementById("btnSpeakLast");
      const btnShareLast = document.getElementById("btnShareLast");

      const visionInput = document.getElementById("visionInput");
      const imagePreviewArea = document.getElementById("imagePreviewArea");
      const imgPrev = document.getElementById("imgPrev");

      const miVoice = document.getElementById("miVoice");
      const miIntel = document.getElementById("miIntel");
      const miLearn = document.getElementById("miLearn");
      const miSeed = document.getElementById("miSeed");
      const miFaith = document.getElementById("miFaith");
      const miIdentity = document.getElementById("miIdentity");
      const miLLM = document.getElementById("miLLM");
      const miBMRecall = document.getElementById("miBMRecall");
      const miHistory = document.getElementById("miHistory");
      const voicePill = document.getElementById("voicePill");
      const learnPill = document.getElementById("learnPill");

      const modalGeneric = document.getElementById("modalGeneric");
      const modalGenericTitle = document.getElementById("modalGenericTitle");
      const modalGenericBody = document.getElementById("modalGenericBody");
      const modalGenericClose = document.getElementById("modalGenericClose");

      const state = {
        tm: 0,
        bm: 0,
        e0: 0,
        continuity: 0.85,
        lastQA: null,
        faithLens: "Islam",
        voiceOn: false,
        learningOn: true,
        history: [],
        intelligence: [],
        bmStore: [],
        imageAttached: null
      };

      function tanh(x) {
        if (Math.tanh) return Math.tanh(x);
        const e2x = Math.exp(2 * x);
        return (e2x - 1) / (e2x + 1);
      }

      function toast(msg) {
        if (!toastEl) return;
        toastEl.textContent = msg;
        toastEl.classList.add("show");
        clearTimeout(toastEl._timeout);
        toastEl._timeout = setTimeout(() => {
          toastEl.classList.remove("show");
        }, 1800);
      }

      function logLine(type, text) {
        const span = document.createElement("span");
        span.classList.add("line");
        if (type === "user") span.classList.add("user");
        else if (type === "aura") span.classList.add("aura");
        else span.classList.add("sys");

        let prefix = "";
        if (type === "user") prefix = "You: ";
        else if (type === "aura") prefix = "AURA-X Œ©: ";
        span.textContent = prefix + text;

        consoleBox.appendChild(span);
        consoleBox.scrollTop = consoleBox.scrollHeight;

        state.history.push({ type, text, ts: new Date() });
        if (state.history.length > 300) state.history.shift();
      }

      function updateScores(deltaTM = 0, deltaBM = 0) {
        state.tm += deltaTM;
        state.bm += deltaBM;
        if (state.tm < 0) state.tm = 0;
        if (state.bm < 0) state.bm = 0;

        const base = state.tm + state.bm - 0.1;
        const faithBoost =
          state.faithLens && state.faithLens !== "none" ? 0.1 : 0;
        state.e0 = tanh(base + faithBoost);

        cTM.textContent = state.tm.toFixed(2);
        cBM.textContent = state.bm.toFixed(2);
        cE0.textContent = state.e0.toFixed(3);
        cCont.textContent = state.continuity.toFixed(3);
      }

      function refreshFaithUI() {
        if (!state.faithLens || state.faithLens === "none") {
          faithLabel.textContent = "none";
          faithLabel.className = "pillOff";
          faithBubble.classList.remove("show", "pulse", "flying");
          faithCfgBtn.classList.add("show");
        } else {
          faithLabel.textContent = state.faithLens;
          faithLabel.className = "pillMid";
          faithBubbleTitle.textContent = "Faith lens: " + state.faithLens;
          faithBubbleMeta.textContent =
            "You'll get reflections according to your selected faith lens.";
          faithBubble.classList.add("show", "pulse");
          faithCfgBtn.classList.add("show");
        }
      }

      function openGenericModal(mode) {
        let html = "";
        if (mode === "faith") {
          modalGenericTitle.textContent = "Faith lens selection";
          html +=
            "<p>Select how AURA-X Œ© colours ethical reflections. This only shapes tone, not facts.</p>";
          html += '<div class="chipsWrap" id="faithChipWrap">';
          const lenses = [
            "Islam",
            "Christianity",
            "Hinduism",
            "Buddhism",
            "Judaism",
            "Sikhism",
            "Atheism / Humanism",
            "Spiritual (no label)",
            "Indigenous / Local wisdom",
            "None"
          ];
          lenses.forEach((name) => {
            const active =
              (state.faithLens === "none" &&
                name.toLowerCase().includes("none")) ||
              state.faithLens === name
                ? " active"
                : "";
            html +=
              '<button class="chip' +
              active +
              '" data-faith="' +
              name.replace(/"/g, "&quot;") +
              '">' +
              name +
              "</button>";
          });
          html += "</div>";
        } else if (mode === "identity") {
          modalGenericTitle.textContent = "User identity (deep profile prototype)";
          html +=
            "<p>Here you will store stable information about the person, not just name:</p>";
          html += "<ul>";
          html +=
            "<li>Life themes: family, work, study, health, dreams.</li>";
          html +=
            "<li>Long-term sensitivities (what hurts / what motivates).</li>";
          html += "<li>Boundaries: what topics are off-limits.</li>";
          html += "</ul>";
          html +=
            '<p style="margin-top:8px;">In this prototype, identity isn\'t stored yet ‚Äì only the structure is shown.</p>';
        } else if (mode === "intel") {
          modalGenericTitle.textContent = "Learned intelligence (Q ‚Üí A)";
          if (!state.intelligence.length) {
            html +=
              "<p>No saved intelligence yet. Use üëç on an answer to store it here.</p>";
          } else {
            state.intelligence.forEach((item, i) => {
              html += '<div class="intelCard">';
              html += '<div class="intelTop"><div class="intelQ">Q' +
                (i + 1) +
                ": " +
                item.q +
                "</div></div>";
              html += '<div class="intelA">A: ' + item.a + "</div>";
              html +=
                '<div class="intelMeta">Source: ' +
                item.source +
                " ¬∑ Corrected: " +
                (item.corrected ? "yes" : "no") +
                "</div>";
              html += "</div>";
            });
          }
        } else if (mode === "bm") {
          modalGenericTitle.textContent = "Bold Memory (BM) recall";
          if (!state.bmStore.length) {
            html +=
              "<p>No BM items yet. When you like important answers, they can be promoted to BM.</p>";
          } else {
            html += '<div class="bmCard">';
            html +=
              "<div class=\"bmTop\"><div class=\"title\">Locked ideas</div></div>";
            state.bmStore.forEach((item, i) => {
              html +=
                '<div style="margin-top:6px;font-size:13px;"><b>' +
                (i + 1) +
                ".</b> " +
                item.text +
                "</div>";
            });
            html += "</div>";
          }
        } else if (mode === "history") {
          modalGenericTitle.textContent = "TM history (recent)";
          if (!state.history.length) {
            html += "<p>No conversation yet.</p>";
          } else {
            html += '<div id="historyBox">';
            state.history.slice(-80).forEach((h) => {
              let tag = "SYS";
              if (h.type === "user") tag = "YOU";
              else if (h.type === "aura") tag = "AURA";
              html += '<div class="historyLine">';
              html +=
                '<div class="historyText"><b>' +
                tag +
                ":</b> " +
                h.text +
                "</div>";
              html += "</div>";
            });
            html += "</div>";
          }
        } else if (mode === "seed") {
          modalGenericTitle.textContent = "Feed the seed";
          html +=
            "<p>Seed = base knowledge you manually feed AURA-X Œ© (rules, definitions, your own writings).</p>";
          html +=
            "<p>This prototype only shows the concept ‚Äì saving to disk/database will be added later.</p>";
        } else if (mode === "llm") {
          modalGenericTitle.textContent = "LLM routing";
          html +=
            "<p>Final design: first try local intelligence & BM, then offline LLM, then (optional) online helper LLM.</p>";
          html +=
            "<p>Here we only show routing concept, no external API calls.</p>";
        } else {
          modalGenericTitle.textContent = "AURA-X Œ©";
          html += "<p>Prototype modal.</p>";
        }

        modalGenericBody.innerHTML = html;
        modalGeneric.classList.add("show");

        if (mode === "faith") {
          const wrap = modalGenericBody.querySelector("#faithChipWrap");
          if (wrap) {
            wrap.querySelectorAll(".chip").forEach((chip) => {
              chip.addEventListener("click", () => {
                wrap.querySelectorAll(".chip").forEach((c) =>
                  c.classList.remove("active")
                );
                chip.classList.add("active");
                const chosen = chip.getAttribute("data-faith") || "none";
                if (chosen.toLowerCase().includes("none")) {
                  state.faithLens = "none";
                } else if (chosen.startsWith("Atheism")) {
                  state.faithLens = "Atheism / Humanism";
                } else {
                  state.faithLens = chosen;
                }
                refreshFaithUI();
                toast("Faith lens set to: " + state.faithLens);
              });
            });
          }
        }
      }

      function closeGenericModal() {
        modalGeneric.classList.remove("show");
      }

      modalGenericClose.addEventListener("click", closeGenericModal);
      modalGeneric.addEventListener("click", (e) => {
        if (e.target === modalGeneric) closeGenericModal();
      });

      function handleSend() {
        const text = userInput.value.trim();
        if (!text && !state.imageAttached) return;

        let userMsg = text;
        if (state.imageAttached) {
          userMsg += (userMsg ? " " : "") + "[Image attached]";
        }
        if (!userMsg) userMsg = "[Image only]";
        logLine("user", userMsg);

        userInput.value = "";
        if (state.imageAttached) {
          state.imageAttached = null;
          imagePreviewArea.style.display = "none";
        }

        updateScores(0.05, 0);

        let reply = "";
        if (text) {
          reply =
            'I have stored this in TM (temporary memory prototype). In a full engine your feelings and context would stay continuous. You said: "' +
            text +
            '".';
        } else {
          reply =
            "I received your image. In the full version BM would connect this visual with your emotional context.";
        }
        logLine("aura", reply);
        state.lastQA = { q: text, a: reply };
      }

      sendBtn.addEventListener("click", handleSend);
      userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          handleSend();
        }
      });

      // Options menu toggle
      btnOptions.addEventListener("click", (e) => {
        e.stopPropagation();
        optionsMenu.classList.toggle("show");
      });

      document.addEventListener("click", (e) => {
        if (!optionsMenu.contains(e.target) && e.target !== btnOptions) {
          optionsMenu.classList.remove("show");
        }
      });

      // Voice toggle
      miVoice.addEventListener("click", () => {
        state.voiceOn = !state.voiceOn;
        voicePill.textContent = state.voiceOn ? "on" : "off";
        voicePill.className = state.voiceOn ? "pillOn" : "pillOff";
        toast(
          "Voice playback " +
            (state.voiceOn ? "enabled (prototype idea)" : "disabled")
        );
      });

      // Learning toggle
      miLearn.addEventListener("click", () => {
        state.learningOn = !state.learningOn;
        learnPill.textContent = state.learningOn ? "on" : "off";
        learnPill.className = state.learningOn ? "pillOn" : "pillOff";
        toast(
          "Self-learning " +
            (state.learningOn ? "enabled (prototype)" : "disabled")
        );
      });

      // Menu item modals
      miIntel.addEventListener("click", () => {
        openGenericModal("intel");
        optionsMenu.classList.remove("show");
      });
      miFaith.addEventListener("click", () => {
        openGenericModal("faith");
        optionsMenu.classList.remove("show");
      });
      miIdentity.addEventListener("click", () => {
        openGenericModal("identity");
        optionsMenu.classList.remove("show");
      });
      miBMRecall.addEventListener("click", () => {
        openGenericModal("bm");
        optionsMenu.classList.remove("show");
      });
      miHistory.addEventListener("click", () => {
        openGenericModal("history");
        optionsMenu.classList.remove("show");
      });
      miSeed.addEventListener("click", () => {
        openGenericModal("seed");
        optionsMenu.classList.remove("show");
      });
      miLLM.addEventListener("click", () => {
        openGenericModal("llm");
        optionsMenu.classList.remove("show");
      });

      // Faith bubble behaviour
      faithBubble.addEventListener("click", () => {
        if (!state.faithLens || state.faithLens === "none") return;
        logLine(
          "sys",
          "Faith reflection (" +
            state.faithLens +
            "): this is where an ayah / verse / wisdom snippet would appear in your language."
        );
        faithBubble.classList.remove("pulse");
        faithBubble.classList.add("flying");
        setTimeout(() => {
          faithBubble.classList.remove("flying");
          faithBubble.classList.add("pulse");
        }, 2200);
      });

      faithBubbleClose.addEventListener("click", (e) => {
        e.stopPropagation();
        faithBubble.classList.remove("show", "pulse", "flying");
      });

      faithCfgBtn.addEventListener("click", () => {
        openGenericModal("faith");
      });

      // Reactions
      btnLikeLast.addEventListener("click", () => {
        if (!state.lastQA) {
          toast("No answer yet to like.");
          return;
        }
        state.intelligence.push({
          q: state.lastQA.q || "[no text]",
          a: state.lastQA.a,
          corrected: false,
          source: "reaction-like"
        });
        state.bmStore.push({
          text: state.lastQA.a,
          ts: new Date()
        });
        updateScores(0, 0.05);
        toast("Saved to intelligence / BM (prototype).");
      });

      btnDislikeLast.addEventListener("click", () => {
        if (!state.lastQA) {
          toast("No answer yet to correct.");
          return;
        }
        logLine("sys", "Marked last answer incorrect. Please teach a better one.");
        const correct = window.prompt(
          "Type the correct answer you would like to teach:"
        );
        if (correct && correct.trim()) {
          const taught = correct.trim();
          state.intelligence.push({
            q: state.lastQA.q || "[no text]",
            a: taught,
            corrected: true,
            source: "manual-teach"
          });
          logLine(
            "aura",
            "Stored your corrected answer in prototype intelligence: " +
              taught
          );
          state.lastQA.a = taught;
          toast("Correct answer stored in intelligence.");
        }
      });

      btnSpeakLast.addEventListener("click", () => {
        if (!state.lastQA) {
          toast("No answer to play.");
          return;
        }
        toast("Voice playback is a placeholder in this offline prototype.");
      });

      btnShareLast.addEventListener("click", async () => {
        if (!state.lastQA) {
          toast("Nothing to copy yet.");
          return;
        }
        const text =
          "Q: " +
          (state.lastQA.q || "[no text]") +
          "\nA: " +
          state.lastQA.a;
        try {
          await navigator.clipboard.writeText(text);
          toast("Copied Q + A to clipboard.");
        } catch (e) {
          toast("Clipboard not available here.");
        }
      });

      // Image attach
      visionInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        state.imageAttached = file;
        const url = URL.createObjectURL(file);
        imgPrev.src = url;
        imagePreviewArea.style.display = "block";
      });

      // Init
      refreshFaithUI();
      updateScores(0, 0);
      logLine(
        "sys",
        "Emotional continuity engine initialised (offline prototype)."
      );
    });
  </script>
</body>
</html>