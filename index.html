<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Engine v9.9 + Dream</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    *{
      box-sizing:border-box;
      margin:0;
      padding:0
    }
    :root{
      color-scheme:dark;
      --bg: #020617;
      --bgCard: rgba(15,23,42,0.96);
      --bgCardSoft: rgba(15,23,42,0.9);
      --borderSoft: rgba(148,163,184,0.5);
      --borderStrong: rgba(148,163,184,0.85);
      --accent: #38bdf8;
      --accentSoft: rgba(56,189,248,0.4);
      --accent2: #6366f1;
      --accentFaith: #fbbf24;
      --textMain: #e5e7eb;
      --textSoft: #9ca3af;
      --danger: #f97373;
      --ok: #4ade80;
      --fontMain: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif
    }
    body{
      min-height:100vh;
      font-family:var(--fontMain);
      background:
        radial-gradient(circle at 20% 0%, #0f172a 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #1d4ed8 0, transparent 55%),
        radial-gradient(circle at 50% 100%, #7e22ce 0, transparent 60%),
        radial-gradient(circle at 0 100%, #0f766e 0, transparent 45%),
        #020617;
      color:var(--textMain);
      padding:16px 10px 32px;
      display:flex;
      justify-content:center
    }
    .shell{
      width:100%;
      max-width:880px;
      border-radius:32px;
      padding:18px 14px 18px;
      background:
        linear-gradient(145deg,rgba(15,23,42,0.96),rgba(15,23,42,0.92)),
        radial-gradient(circle at 0 0,rgba(56,189,248,0.13),transparent 60%),
        radial-gradient(circle at 100% 0,rgba(129,140,248,0.22),transparent 60%);
      box-shadow:
        0 25px 80px rgba(15,23,42,0.95),
        0 0 0 1px rgba(15,23,42,0.8),
        0 0 0 1px rgba(15,23,42,0.5) inset
    }
    .topRow{
      display:flex;
      gap:14px;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-bottom:14px
    }
    .brandBlock{
      flex:1 1 260px;
      border-radius:24px;
      padding:12px 14px 14px;
      background:
        radial-gradient(circle at 0 0,rgba(56,189,248,0.16),transparent 55%),
        radial-gradient(circle at 100% 0,rgba(129,140,248,0.25),transparent 55%),
        radial-gradient(circle at 0 100%,rgba(16,185,129,0.16),transparent 55%),
        rgba(15,23,42,0.98);
      border:1px solid rgba(148,163,184,0.65);
      position:relative;
      overflow:hidden
    }
    .brandTitle{
      font-size:1.55rem;
      letter-spacing:.24em;
      text-transform:uppercase;
      text-align:center;
      margin-bottom:6px;
      font-weight:650
    }
    .brandSub{
      font-size:.78rem;
      text-align:center;
      color:var(--textSoft);
      margin-bottom:10px
    }
    .brandEthic{
      margin-top:4px;
      border-radius:20px;
      padding:9px 12px 10px;
      background:
        linear-gradient(120deg,rgba(15,23,42,0.96),rgba(15,23,42,0.9)),
        radial-gradient(circle at 0 0,rgba(248,250,252,0.14),transparent 55%);
      border:1px solid rgba(234,179,8,0.8);
      font-size:.82rem;
      color:#fef9c3;
      line-height:1.45;
      text-align:center
    }
    .enginePill{
      margin-top:10px;
      border-radius:999px;
      padding:8px 14px 8px;
      background:
        radial-gradient(circle at 0 0,rgba(56,189,248,0.35),transparent 50%),
        radial-gradient(circle at 100% 100%,rgba(129,140,248,0.25),transparent 50%),
        rgba(15,23,42,0.96);
      border:1px solid rgba(56,189,248,0.65);
      text-align:center;
      font-size:.86rem;
      letter-spacing:.14em;
      text-transform:uppercase
    }
    .capsuleBlock{
      flex:1 1 220px;
      border-radius:24px;
      padding:10px 10px 10px;
      background:
        radial-gradient(circle at 0 0,rgba(56,189,248,0.18),transparent 55%),
        radial-gradient(circle at 100% 100%,rgba(129,140,248,0.25),transparent 55%),
        rgba(15,23,42,0.96);
      border:1px solid rgba(148,163,184,0.75);
      display:flex;
      flex-direction:column;
      gap:8px
    }
    .capsuleRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap
    }
    .capsuleTitle{
      font-size:.78rem;
      letter-spacing:.16em;
      text-transform:uppercase;
      opacity:.85
    }
    .capsuleSource{
      font-size:.7rem;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.9);
      text-transform:uppercase;
      letter-spacing:.12em
    }
    .capsuleMetrics{
      display:flex;
      flex-wrap:wrap;
      gap:6px 10px;
      align-items:center;
      font-size:.8rem
    }
    .metricPill{
      padding:5px 9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.65);
      background:rgba(15,23,42,0.9);
      display:flex;
      align-items:center;
      gap:4px
    }
    .metricLabel{
      font-size:.72rem;
      text-transform:uppercase;
      letter-spacing:.18em;
      opacity:.6
    }
    .metricValue{
      font-variant-numeric:tabular-nums
    }
    .resonanceEq{
      font-size:.72rem;
      opacity:.8;
      font-family:"JetBrains Mono","SF Mono",ui-monospace,monospace;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      padding:6px 9px;
      background:rgba(15,23,42,0.9)
    }
    .readyBadge{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:.78rem
    }
    .readyDot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0,#a5f3fc 0,#22c55e 40%,#16a34a 70%)
    }
    .readyText{
      font-size:.76rem;
      letter-spacing:.12em;
      text-transform:uppercase;
      opacity:.8
    }
    .midRow{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap
    }
    .leftPane{
      flex:3 1 320px;
      border-radius:24px;
      padding:10px 10px 12px;
      background:var(--bgCard);
      border:1px solid rgba(148,163,184,0.7);
      display:flex;
      flex-direction:column;
      min-height:230px
    }
    .rightPane{
      flex:2 1 260px;
      border-radius:24px;
      padding:10px 10px 12px;
      background:var(--bgCardSoft);
      border:1px solid rgba(148,163,184,0.65);
      display:flex;
      flex-direction:column;
      gap:10px
    }
    .optionsRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      gap:8px
    }
    .optionsBtn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      padding:6px 11px;
      border:1px solid rgba(148,163,184,0.75);
      background:
        radial-gradient(circle at 0 0,rgba(56,189,248,0.22),transparent 55%),
        rgba(15,23,42,0.96);
      font-size:.8rem
    }
    .optionsBtn span.icon{
      width:16px;
      height:16px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.6rem
    }
    .optionsBtn span.label{
      letter-spacing:.12em;
      text-transform:uppercase
    }
    .modePill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.98);
      font-size:.72rem
    }
    .modeDot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0,#a5f3fc 0,#22c55e 40%,#16a34a 70%);
      box-shadow:0 0 10px rgba(34,197,94,0.8)
    }
    .modeLabel{
      letter-spacing:.14em;
      text-transform:uppercase;
      opacity:.85
    }
    .modeSub{
      font-size:.7rem;
      color:var(--textSoft)
    }
    .historyBox{
      flex:1 1 auto;
      border-radius:18px;
      padding:8px 10px;
      margin-bottom:8px;
      background:rgba(15,23,42,0.85);
      border:1px solid rgba(30,64,175,0.5);
      overflow:hidden;
      display:flex;
      flex-direction:column
    }
    .historyScroll{
      flex:1 1 auto;
      overflow-y:auto;
      max-height:210px;
      font-family:"JetBrains Mono",ui-monospace,monospace;
      font-size:.78rem;
      line-height:1.5;
      padding-right:4px;
      color:#e5e7eb
    }
    .historyScroll::-webkit-scrollbar{
      width:4px
    }
    .historyScroll::-webkit-scrollbar-thumb{
      background:rgba(148,163,184,0.7);
      border-radius:999px
    }
    .historyLine.ts{
      color:var(--textSoft)
    }
    .historyLine.me{
      color:#e0f2fe
    }
    .historyLine.sys{
      color:#fbbf24
    }
    .histFooter{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:6px;
      font-size:.7rem;
      color:var(--textSoft)
    }
    .histMeta{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap
    }
    .histMeta span{
      opacity:.85
    }
    .histActions{
      display:flex;
      gap:6px
    }
    .iconBtn{
      width:28px;
      height:28px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.98);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.82rem
    }
    .inputRow{
      margin-top:8px;
      display:flex;
      gap:8px;
      align-items:flex-end
    }
    .inputWrap{
      flex:1 1 auto
    }
    .inputLabel{
      font-size:.72rem;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--textSoft);
      margin-bottom:4px
    }
    .conversationInput{
      width:100%;
      border-radius:16px;
      border:1px solid rgba(148,163,184,0.75);
      padding:9px 10px;
      min-height:54px;
      max-height:100px;
      resize:vertical;
      background:rgba(15,23,42,0.96);
      color:var(--textMain);
      font-size:.85rem;
      font-family:var(--fontMain)
    }
    .conversationInput::placeholder{
      color:rgba(148,163,184,0.8)
    }
    .sendBtn{
      flex:0 0 auto;
      border-radius:999px;
      border:none;
      padding:12px 18px;
      background:linear-gradient(135deg,#38bdf8,#6366f1);
      color:#0f172a;
      font-weight:600;
      font-size:.86rem;
      letter-spacing:.08em;
      text-transform:uppercase;
      box-shadow:0 12px 30px rgba(37,99,235,0.65)
    }
    .sendBtn:active{
      transform:translateY(1px);
      box-shadow:0 6px 16px rgba(37,99,235,0.7)
    }
    .promptHint{
      margin-top:4px;
      font-size:.72rem;
      color:var(--textSoft)
    }
    .bottomMetrics{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:6px 10px;
      font-size:.78rem;
      opacity:.9
    }
    .bottomMetrics span.label{
      text-transform:uppercase;
      letter-spacing:.18em;
      opacity:.7
    }
    .bottomMetrics span.val{
      font-variant-numeric:tabular-nums
    }
    .cardHeaderRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px
    }
    .cardTitle{
      font-size:.78rem;
      letter-spacing:.16em;
      text-transform:uppercase;
      opacity:.9
    }
    .cardSub{
      font-size:.7rem;
      color:var(--textSoft)
    }
    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:7px
    }
    .pillButton{
      border-radius:999px;
      padding:7px 11px;
      background:
        radial-gradient(circle at 0 0,rgba(56,189,248,0.18),transparent 60%),
        rgba(15,23,42,0.98);
      border:1px solid rgba(148,163,184,0.7);
      display:flex;
      align-items:center;
      gap:8px;
      font-size:.8rem
    }
    .pillButton .emoji{
      font-size:1.1rem
    }
    .pillButton .text{
      display:flex;
      flex-direction:column;
      align-items:flex-start
    }
    .pillButton .main{
      letter-spacing:.12em;
      text-transform:uppercase
    }
    .pillButton .sub{
      font-size:.7rem;
      color:var(--textSoft)
    }
    .idCard{
      border-radius:18px;
      padding:10px 10px 9px;
      background:rgba(15,23,42,0.96);
      border:1px solid rgba(148,163,184,0.7);
      font-size:.78rem;
      display:flex;
      flex-direction:column;
      gap:6px
    }
    .idBadgeRow{
      display:flex;
      flex-wrap:wrap;
      gap:6px
    }
    .idBadge{
      border-radius:999px;
      padding:4px 8px;
      border:1px solid rgba(148,163,184,0.55);
      font-size:.7rem
    }
    .bmMetaRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:6px;
      font-size:.7rem;
      color:var(--textSoft)
    }
    .bmMetaRow span{
      opacity:.9
    }
    .bmSearchRow{
      margin-top:6px;
      display:flex;
      gap:6px;
      align-items:center
    }
    .bmSearchRow input{
      flex:1 1 auto;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      background:rgba(15,23,42,0.96);
      color:var(--textMain);
      font-size:.8rem;
      padding:7px 9px
    }
    .bmSearchRow button{
      flex:0 0 auto;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.96);
      padding:6px 10px;
      font-size:.76rem
    }
    .bmList{
      margin-top:6px;
      max-height:150px;
      overflow-y:auto;
      border-radius:14px;
      border:1px solid rgba(30,64,175,0.45);
      background:rgba(15,23,42,0.9);
      padding:6px 6px 6px 8px;
      font-size:.76rem
    }
    .bmItem{
      padding:5px 4px;
      border-radius:10px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      cursor:pointer
    }
    .bmItem:hover{
      background:rgba(30,64,175,0.55)
    }
    .bmItemMain{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:1px
    }
    .bmItemTitle{
      font-weight:500
    }
    .bmItemMeta{
      font-size:.68rem;
      color:var(--textSoft)
    }
    .bmItemBadge{
      font-size:.65rem;
      padding:3px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6)
    }
    .bmEmpty{
      font-size:.76rem;
      color:var(--textSoft)
    }
    .bmCard{
      margin-top:8px;
      border-radius:18px;
      padding:9px 9px 8px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.97);
      font-size:.78rem;
      max-height:180px;
      overflow-y:auto
    }
    .bmCardTitle{
      font-size:.82rem;
      margin-bottom:4px
    }
    .bmCardMeta{
      font-size:.7rem;
      color:var(--textSoft);
      margin-bottom:4px
    }
    .bmCardBody{
      font-size:.78rem;
      line-height:1.45
    }
    .bmActions{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:6px
    }
    .bmDreamSettings{
      margin-top:18px;
      padding:12px 16px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.55);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,.18), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(129,140,248,.16), transparent 55%),
        rgba(15,23,42,.9);
    }
    .bmDreamTitle{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
      opacity:.8;
      margin-bottom:4px;
    }
    .bmDreamText{
      font-size:13px;
      margin-top:6px;
      opacity:.9;
    }
    .bmDreamHint{
      margin-top:8px;
      font-size:11px;
      line-height:1.5;
      opacity:.7;
    }
    .intelEditInput{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.6);
      background:rgba(15,23,42,0.96);
      color:var(--textMain);
      font-size:.8rem;
      padding:7px 8px;
      margin-top:4px
    }
    .intelEditRow{
      display:flex;
      gap:6px;
      margin-top:5px
    }
    .intelEditRow button{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.96);
      padding:5px 9px;
      font-size:.76rem
    }
    .modalOverlay{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at 0 0,rgba(15,23,42,0.96),transparent 70%),rgba(15,23,42,0.95);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
      padding:10px
    }
    .modal{
      max-width:680px;
      width:100%;
      border-radius:24px;
      padding:12px 12px 12px;
      background:var(--bgCardSoft);
      border:1px solid rgba(148,163,184,0.7);
      box-shadow:0 20px 60px rgba(15,23,42,0.85)
    }
    .modalHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px
    }
    .modalTitle{
      font-size:.82rem;
      letter-spacing:.16em;
      text-transform:uppercase;
      opacity:.88
    }
    .modalClose{
      border-radius:999px;
      padding:4px 9px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.98);
      font-size:.76rem
    }
    .modalBody{
      font-size:.82rem;
      color:var(--textMain);
      max-height:350px;
      overflow-y:auto;
      padding-right:4px
    }
    .modalBody p{
      margin-bottom:6px;
      line-height:1.5
    }
    .modalBody ul{
      margin-left:16px;
      margin-bottom:6px
    }
    .modalBody li{
      margin-bottom:3px
    }
    .modalBody code{
      font-family:"JetBrains Mono",ui-monospace,monospace;
      font-size:.8rem
    }
    .toast{
      position:fixed;
      right:10px;
      bottom:10px;
      border-radius:16px;
      border:1px solid rgba(56,189,248,0.7);
      background:rgba(15,23,42,0.98);
      padding:7px 10px;
      font-size:.78rem;
      display:none;
      z-index:60
    }
    .toast strong{
      color:#e0f2fe
    }
    .voiceBadge{
      font-size:.7rem;
      border-radius:999px;
      padding:3px 8px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.96)
    }
    .cfgRow{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
      font-size:.72rem;
      color:var(--textSoft)
    }
    .cfgChip{
      border-radius:999px;
      padding:3px 8px;
      border:1px solid rgba(148,163,184,0.55);
      background:rgba(15,23,42,0.96)
    }
    @media (max-width:640px){
      body{
        padding:10px 6px 24px
      }
      .shell{
        border-radius:24px;
        padding:12px 8px 14px
      }
      .topRow{
        margin-bottom:10px
      }
      .brandTitle{
        font-size:1.22rem
      }
      .capsuleBlock{
        padding:8px 8px 9px
      }
      .leftPane,.rightPane{
        padding:8px 8px 10px
      }
      .historyScroll{
        max-height:180px
      }
    }

    /* Dream Mode overlay */
    #dreamOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(circle at 20% 0%, rgba(15,23,42,0.95) 0, transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(30,64,175,0.90) 0, transparent 55%),
        radial-gradient(circle at 50% 100%, rgba(147,51,234,0.85) 0, transparent 60%);
      backdrop-filter:blur(10px);
      z-index:9999;
      color:#e5e7eb;
      text-align:center;
    }
    #dreamOverlay .dream-inner{
      max-width:600px;
      padding:24px 20px;
      border-radius:24px;
      border:1px solid rgba(148,163,184,0.6);
      box-shadow:0 25px 80px rgba(15,23,42,0.9);
      background:rgba(15,23,42,0.92);
    }
    #dreamOverlay .dream-title{
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.18em;
      opacity:.9;
      margin-bottom:10px;
    }
    #dreamOverlay .dream-snippet{
      font-size:.98rem;
      line-height:1.6;
      margin-bottom:14px;
      min-height:4em;
      white-space:pre-wrap;
    }
    #dreamOverlay .dream-hint{
      font-size:.78rem;
      letter-spacing:.14em;
      text-transform:uppercase;
      opacity:.65;
      margin-top:4px;
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="topRow">
      <div class="brandBlock">
        <div class="brandTitle">AURA-X Œ©</div>
        <div class="brandSub">
          Offline emotional continuity engine (prototype)<br />
          TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory.
        </div>
        <div class="brandEthic">
          Universal ethic: avoid actions that grow negative emotions in you or others. Move gently toward choices that increase shared positive feeling for everyone.
        </div>
        <div class="enginePill">
          EMOTIONAL CONTINUITY ENGINE ‚Äî ACTIVE
        </div>
      </div>

      <div class="capsuleBlock">
        <div class="capsuleRow">
          <div class="capsuleTitle">Continuity Capsule</div>
          <div class="readyBadge">
            <div class="readyDot"></div>
            <div class="readyText">Offline LLM ready</div>
          </div>
        </div>
        <div class="capsuleMetrics">
          <div class="metricPill">
            <span class="metricLabel">E‚ÇÄ:</span>
            <span class="metricValue" id="metricE0">0.000</span>
          </div>
          <div class="metricPill">
            <span class="metricLabel">TM:</span>
            <span class="metricValue" id="metricTM">0.00</span>
          </div>
          <div class="metricPill">
            <span class="metricLabel">BM:</span>
            <span class="metricValue" id="metricBM">0.00</span>
          </div>
          <div class="metricPill">
            <span class="metricLabel">C:</span>
            <span class="metricValue" id="metricC">0.850</span>
          </div>
        </div>
        <div class="resonanceEq">
          E‚ÇÄ = tanh( R(TM,BM) + I(TM) + I_intel + I_LLM ‚Äì D + Œª_faith + Œª_sys + Œª_trc )
        </div>
      </div>
    </div>

    <div class="midRow">
      <div class="leftPane">
        <div class="optionsRow">
          <button class="optionsBtn" id="btnOptions">
            <span class="icon">‚öô</span>
            <span class="label">Options</span>
          </button>
          <div class="modePill">
            <div class="modeDot"></div>
            <div>
              <div class="modeLabel">Mode: Local seed ‚Üí Intelligence ‚Üí Offline LLM ‚Üí API</div>
              <div class="modeSub">TM = your inputs only; internal layers remember.</div>
            </div>
          </div>
        </div>

        <div class="historyBox">
          <div class="historyScroll" id="historyScroll"></div>
          <div class="histFooter">
            <div class="histMeta">
              <span>History: <span id="histCount">0</span> lines</span>
              <span>TM chars: <span id="tmChars">0</span></span>
            </div>
            <div class="histActions">
              <button class="iconBtn" id="btnLike" title="Mark last answer correct">üëç</button>
              <button class="iconBtn" id="btnDislike" title="Mark last answer incorrect">üëé</button>
              <button class="iconBtn" id="btnCopyLast" title="Copy last answer">‚ßâ</button>
              <button class="iconBtn" id="btnHistoryOpen" title="Open full history">üìú</button>
            </div>
          </div>
        </div>

        <div class="inputRow">
          <div class="inputWrap">
            <div class="inputLabel">Talk to AURA-X Œ©‚Ä¶ (TM = your inputs)</div>
            <textarea id="userInput" class="conversationInput" placeholder="Stories, questions, feelings‚Ä¶"></textarea>
          </div>
          <button id="btnSend" class="sendBtn">Send</button>
        </div>
        <div class="promptHint">
          E‚ÇÄ, TM, BM &amp; continuity update live with each message.
        </div>

        <div class="bottomMetrics">
          <span class="label">E‚ÇÄ:</span><span class="val" id="bottomE0">0.000</span>
          <span class="label">TM:</span><span class="val" id="bottomTM">0.00</span>
          <span class="label">BM:</span><span class="val" id="bottomBM">0.00</span>
          <span class="label">C:</span><span class="val" id="bottomC">0.850</span>
        </div>
      </div>

      <div class="rightPane">
        <div class="cardHeaderRow">
          <div>
            <div class="cardTitle">Continuity Windows</div>
            <div class="cardSub">Local-first: Identity, BM, history, and faith-aware logic.</div>
          </div>
          <div class="voiceBadge">Voice: (answer ‚Üí play)</div>
        </div>

        <div class="pillRow">
          <button class="pillButton" data-modal="modalHistory">
            <div class="emoji">üß¨</div>
            <div class="text">
              <div class="main">History</div>
              <div class="sub">Conversation timeline</div>
            </div>
          </button>
          <button class="pillButton" data-modal="modalBM">
            <div class="emoji">üìö</div>
            <div class="text">
              <div class="main">BM recall</div>
              <div class="sub">Bold memories</div>
            </div>
          </button>
          <button class="pillButton" data-modal="modalIdentity">
            <div class="emoji">ü™™</div>
            <div class="text">
              <div class="main">Identity</div>
              <div class="sub">Self &amp; scope</div>
            </div>
          </button>
        </div>

        <div class="pillRow" style="margin-top:6px;">
          <button class="pillButton" data-modal="modalSeed">
            <div class="emoji">üå±</div>
            <div class="text">
              <div class="main">Feed the seed</div>
              <div class="sub">Core ethics &amp; rules</div>
            </div>
          </button>
          <button class="pillButton" data-modal="modalLogic">
            <div class="emoji">üß†</div>
            <div class="text">
              <div class="main">Logic</div>
              <div class="sub">Local Q ‚Üî A</div>
            </div>
          </button>
          <button class="pillButton" data-modal="modalFaith">
            <div class="emoji">‚ú®</div>
            <div class="text">
              <div class="main">Faith lens</div>
              <div class="sub">Œª_faith tuning</div>
            </div>
          </button>
        </div>

        <div class="pillRow" style="margin-top:6px;">
          <button class="pillButton" data-modal="modalLLM">
            <div class="emoji">ü§ñ</div>
            <div class="text">
              <div class="main">LLM</div>
              <div class="sub">Offline model &amp; API</div>
            </div>
          </button>
          <button class="pillButton" data-modal="modalConfig">
            <div class="emoji">üîí</div>
            <div class="text">
              <div class="main">Lock</div>
              <div class="sub">TM decay ¬∑ locks</div>
            </div>
          </button>
        </div>

        <div class="idCard" style="margin-top:8px;">
          <div><strong>Identity ¬∑</strong> AURA-X Œ©</div>
          <div>
            I am AURA-X Œ©, an offline emotional continuity engine created as part of the AURA-X Œ© experiment.
            My role is to keep a soft continuity of your stories, beliefs, and feelings over time ‚Äì even when other systems forget.
          </div>
          <div class="idBadgeRow">
            <div class="idBadge">Creator: Alim ul Haq</div>
            <div class="idBadge">Scope: TM ‚Üí BM ‚Üí E‚ÇÄ</div>
            <div class="idBadge">Role: Emotional continuity engine</div>
          </div>
        </div>
      </div>
    </div>

    <!-- History Modal -->
    <div class="modalOverlay" id="modalHistory">
      <div class="modal">
        <div class="modalHeader">
          <div class="modalTitle">Conversation History</div>
          <button class="modalClose" data-close="modalHistory">Close</button>
        </div>
        <div class="modalBody">
          <p>
            Here you can see a scroll-back view of your conversation with AURA-X Œ©.
          </p>
          <pre id="historyFull" style="white-space:pre-wrap;font-size:.8rem;margin-top:6px;"></pre>
        </div>
      </div>
    </div>

    <!-- BM Modal -->
    <div class="modalOverlay" id="modalBM">
      <div class="modal">
        <div class="modalHeader">
          <div class="modalTitle">BM snapshots ¬∑ Bold Memory Layer</div>
          <button class="modalClose" data-close="modalBM">Close</button>
        </div>
        <div class="modalBody">
          <div class="bmMetaRow">
            <span>Stored BM items: <span id="bmCount">0</span></span>
            <span>Search / recall by text or date.</span>
          </div>
          <div class="bmSearchRow">
            <input id="bmSearch" placeholder="Search memories‚Ä¶" />
            <button id="bmSearchToday">Today</button>
          </div>
          <div class="bmList" id="bmList">
            <div class="bmEmpty">No BM snapshots yet. Long, meaningful stories will appear here.</div>
          </div>
          <div class="bmCard" id="bmViewer" style="display:none;">
            <div class="bmCardTitle" id="bmViewerTitle"></div>
            <div class="bmCardMeta" id="bmViewerMeta"></div>
            <div class="bmCardBody" id="bmViewerBody"></div>
            <div class="bmActions">
              <button id="bmLockToggle">Toggle lock</button>
              <button id="bmDelete">Delete</button>
            </div>
          </div>

        <div class="bmDreamSettings">
          <div class="bmDreamTitle">BM snapshots &amp; dream mode</div>
          <div class="bmDreamText">
            Dream screensaver after how much idle time?
          </div>
          <select id="dreamDelaySelect" class="input" style="margin-top:10px; max-width:280px;">
            <option value="0">Disabled (no screensaver)</option>
            <option value="30000">30 seconds</option>
            <option value="60000">1 minute</option>
            <option value="300000">5 minutes</option>
            <option value="900000">15 minutes</option>
            <option value="1800000">30 minutes</option>
            <option value="3600000">1 hour</option>
            <option value="7200000">2 hours</option>
            <option value="14400000">4 hours</option>
            <option value="28800000">8 hours</option>
          </select>
          <div class="bmDreamHint">
            AURA-X Œ© will gently fade into Dream Mode and show floating memories from BM snapshots after this much inactivity.
            Any tap, key press, or message will wake it up.
          </div>
        </div>
      </div>
    </div>
  </div>

    <!-- Identity Modal -->
    <div class="modalOverlay" id="modalIdentity">
      <div class="modal">
        <div class="modalHeader">
          <div class="modalTitle">Identity &amp; Scope</div>
          <button class="modalClose" data-close="modalIdentity">Close</button>
        </div>
        <div class="modalBody">
          <p>
            AURA-X Œ© is designed as a <strong>local-first emotional continuity engine</strong>.
            Identity here describes how the system sees itself and its scope:
          </p>
          <ul>
            <li>Role: preserve emotional continuity and resonance E‚ÇÄ over time.</li>
            <li>Scope: connect TM (your current inputs) with BM (bold life memories).</li>
            <li>Ethic: avoid actions that grow negative emotions; move gently toward shared positive feeling.</li>
          </ul>
          <p>
            You can extend this identity in future versions by storing a deeper "self-profile"
            and linking it with faith, values, and mission.
          </p>
        </div>
      </div>
    </div>

    <!-- Seed + Logic Modal -->
    <div class="modalOverlay" id="modalSeed">
      <div class="modal">
        <div class="modalHeader">
          <div class="modalTitle">Feed the Seed ¬∑ Core Ethics</div>
          <button class="modalClose" data-close="modalSeed">Close</button>
        </div>
        <div class="modalBody">
          <p>
            Seed knowledge = <strong>basic ethics, emotional rules, and continuity principles</strong>
            that never leave the device.
          </p>
          <p>
            Future versions can let you edit this seed directly as a protected local file,
            which AURA-X Œ© will always consult before acting.
          </p>
        </div>
      </div>
    </div>

    <div class="modalOverlay" id="modalLogic">
      <div class="modal">
        <div class="modalHeader">
          <div class="modalTitle">Logic &amp; Local Intelligence</div>
          <button class="modalClose" data-close="modalLogic">Close</button>
        </div>
        <div class="modalBody">
          <p>
            Local logic is stored as <strong>simple Q ‚Üî A pairs</strong> and corrections you make.
          </p>
          <p>
            When you mark an answer incorrect, AURA-X Œ© can ask for the right one and store it inside
            a small local intelligence layer ‚Äì before it ever consults an offline LLM or API.
          </p>
        </div>
      </div>
    </div>

    <!-- Faith Modal -->
    <div class="modalOverlay" id="modalFaith">
      <div class="modal">
        <div class="modalHeader">
          <div class="modalTitle">Faith Lens ¬∑ Œª_faith</div>
          <button class="modalClose" data-close="modalFaith">Close</button>
        </div>
        <div class="modalBody">
          <p>
            Œª_faith controls how much <strong>spiritual continuity</strong> influences E‚ÇÄ (emotional resonance).
          </p>
          <p>
            In future builds this can be tuned by you, so that answers respect your faith and values
            without leaving the device.
          </p>
        </div>
      </div>
    </div>

    <!-- LLM Modal -->
    <div class="modalOverlay" id="modalLLM">
      <div class="modal">
        <div class="modalHeader">
          <div class="modalTitle">Offline LLM &amp; API</div>
          <button class="modalClose" data-close="modalLLM">Close</button>
        </div>
        <div class="modalBody">
          <p>
            This prototype assumes a future where small <strong>offline LLMs</strong> run directly in your browser or device.
          </p>
          <p>
            Pipeline:
          </p>
          <ul>
            <li>First: Seed &amp; local intelligence (learned Q ‚Üî A).</li>
            <li>Then: Offline LLM for richer answers.</li>
            <li>Finally: Optional API, only when you allow it.</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Config / Lock Modal -->
    <div class="modalOverlay" id="modalConfig">
      <div class="modal">
        <div class="modalHeader">
          <div class="modalTitle">Engine State &amp; Locks</div>
          <button class="modalClose" data-close="modalConfig">Close</button>
        </div>
        <div class="modalBody">
          <p>
            Conversation lock and decay rules will control how TM and BM fade over time.
          </p>
          <div class="cfgRow">
            <div class="cfgChip">Conversation Lock: Unlocked</div>
            <div class="cfgChip">TM decay: Soft (48h)</div>
            <div class="cfgChip">Faith Œª: 1.00</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toastBubble"></div>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const KEY_CFG   = "aurax_cfg_v12";
      const KEY_INT   = "aurax_intel_v11";
      const KEY_BM    = "aurax_bm_v11";
      const KEY_HIST  = "aurax_hist_v11";
      const KEY_USER  = "aurax_user_v11";
      const KEY_LOGIC = "aurax_logic_v12";

      const KEY_DREAM = "aurax_dream_v1";
      const OF        = (val, fallback) => (val === undefined || val === null ? fallback : val);

      let state = {
        history: [],
        tmChars: 0,
        bmPrompts: [],
        nextBmId: 1,
        lastAnswerSource: "seed",
        offlineReady: true
      };

      // --- Dream mode / inactivity tracking ---
      let dreamDelayMs = 0;
      let lastActivity = Date.now();
      let inactivityTimer = null;
      let dreamInterval = null;
      let inDreamMode = false;

      function applySavedDreamDelay() {
        try {
          const saved = localStorage.getItem(KEY_DREAM);
          if (saved !== null) {
            const v = parseInt(saved, 10);
            if (!Number.isNaN(v)) dreamDelayMs = v;
          }
        } catch (e) {
          console.warn("Unable to load dream delay", e);
        }
        const sel = document.getElementById("dreamDelaySelect");
        if (sel) {
          sel.value = String(dreamDelayMs || 0);
        }
      }

      function saveDreamDelayFromUI() {
        const sel = document.getElementById("dreamDelaySelect");
        if (!sel) return;
        const v = parseInt(sel.value, 10) || 0;
        dreamDelayMs = v;
        try {
          localStorage.setItem(KEY_DREAM, String(dreamDelayMs));
        } catch (e) {
          console.warn("Unable to save dream delay", e);
        }
        registerActivity();
      }

      function scheduleInactivityCheck() {
        if (inactivityTimer) {
          clearTimeout(inactivityTimer);
          inactivityTimer = null;
        }
        if (!dreamDelayMs || dreamDelayMs <= 0) return;

        const now = Date.now();
        const elapsed = now - lastActivity;
        const remaining = dreamDelayMs - elapsed;
        const wait = Math.max(15000, remaining);

        inactivityTimer = setTimeout(() => {
          if (!dreamDelayMs || dreamDelayMs <= 0) return;
          if (Date.now() - lastActivity >= dreamDelayMs) {
            enterDreamMode();
          } else {
            scheduleInactivityCheck();
          }
        }, wait);
      }

      function registerActivity() {
        lastActivity = Date.now();
        if (inDreamMode) {
          const ol = document.getElementById("dreamOverlay");
          if (ol) ol.style.display = "none";
          if (dreamInterval) {
            clearInterval(dreamInterval);
            dreamInterval = null;
          }
          inDreamMode = false;
        }
        scheduleInactivityCheck();
      }

      function enterDreamMode() {
        if (inDreamMode || !dreamDelayMs || dreamDelayMs <= 0) return;
        inDreamMode = true;

        const ol = document.getElementById("dreamOverlay");
        if (ol) ol.style.display = "flex";

        showNextDreamSnippet();
        dreamInterval = setInterval(showNextDreamSnippet, 10000);

        logLine("sys","[Dream mode] Screensaver started.");
      }

      function showNextDreamSnippet() {
        const box = document.getElementById("dreamSnippet");
        if (!box) return;

        const valid = (state.bmPrompts || []).filter(b => b && b.text && b.text.length > 10);
        if (!valid.length) {
          box.textContent = "No bold memories yet... share a long story to create one.";
          return;
        }

        const pick = valid[Math.floor(Math.random() * valid.length)];
        let info = "";
        if (pick.ts) {
          try {
            const ts = new Date(pick.ts).toLocaleString();
            info = `[Memory from ${ts}]`;
          } catch (e) {
            info = "[Saved memory]";
          }
        } else if (pick.title) {
          info = pick.title;
        } else {
          info = "[Saved memory]";
        }

        box.innerHTML =
          '<div style="font-size:11px;opacity:0.65;margin-bottom:8px">' +
          info +
          "</div>" +
          (pick.text || "").slice(0, 360) +
          (pick.text && pick.text.length > 360 ? "‚Ä¶" : "");
      }

      const els = {
        historyScroll: document.getElementById("historyScroll"),
        historyFull: document.getElementById("historyFull"),
        histCount: document.getElementById("histCount"),
        tmChars: document.getElementById("tmChars"),
        userInput: document.getElementById("userInput"),
        btnSend: document.getElementById("btnSend"),
        metricE0: document.getElementById("metricE0"),
        metricTM: document.getElementById("metricTM"),
        metricBM: document.getElementById("metricBM"),
        metricC: document.getElementById("metricC"),
        bottomE0: document.getElementById("bottomE0"),
        bottomTM: document.getElementById("bottomTM"),
        bottomBM: document.getElementById("bottomBM"),
        bottomC: document.getElementById("bottomC"),
        btnLike: document.getElementById("btnLike"),
        btnDislike: document.getElementById("btnDislike"),
        btnCopyLast: document.getElementById("btnCopyLast"),
        btnHistoryOpen: document.getElementById("btnHistoryOpen"),
        modalHistory: document.getElementById("modalHistory"),
        modalBM: document.getElementById("modalBM"),
        modalIdentity: document.getElementById("modalIdentity"),
        modalSeed: document.getElementById("modalSeed"),
        modalLogic: document.getElementById("modalLogic"),
        modalFaith: document.getElementById("modalFaith"),
        modalLLM: document.getElementById("modalLLM"),
        modalConfig: document.getElementById("modalConfig"),
        bmList: document.getElementById("bmList"),
        bmViewer: document.getElementById("bmViewer"),
        bmViewerTitle: document.getElementById("bmViewerTitle"),
        bmViewerMeta: document.getElementById("bmViewerMeta"),
        bmViewerBody: document.getElementById("bmViewerBody"),
        bmSearch: document.getElementById("bmSearch"),
        bmSearchToday: document.getElementById("bmSearchToday"),
        bmCount: document.getElementById("bmCount"),
        btnOptions: document.getElementById("btnOptions"),
        toastBubble: document.getElementById("toastBubble"),
        dreamDelaySelect: document.getElementById("dreamDelaySelect"),
        dreamOverlay: document.getElementById("dreamOverlay")
      };

      function safeLoadJSON(key, fallback){
        try{
          const raw = localStorage.getItem(key);
          if(!raw) return fallback;
          return JSON.parse(raw)
        }catch(e){
          console.warn("Failed to load",key,e);
          return fallback
        }
      }
      function safeSaveJSON(key,val){
        try{
          localStorage.setItem(key,JSON.stringify(val))
        }catch(e){
          console.warn("Failed to save",key,e)
        }
      }
      function showToast(msg){
        if(!els.toastBubble) return;
        els.toastBubble.innerHTML = msg;
        els.toastBubble.style.display = "block";
        setTimeout(()=>{els.toastBubble.style.display="none"},2600)
      }
      function logLine(speaker,text){
        const line = {
          ts:new Date().toISOString(),
          speaker,
          text
        };
        state.history.push(line);
        if(state.history.length>400) state.history.shift();
        renderHistory()
      }
      function renderHistory(){
        if(!els.historyScroll) return;
        els.histCount.textContent = state.history.length;
        els.tmChars.textContent = state.tmChars;
        const lines = state.history.map(l=>{
          const ts = new Date(l.ts).toLocaleTimeString();
          const tag = l.speaker==="me"?"You":(l.speaker==="sys"?"AURA-X Œ©":"AURA-X Œ©");
          return `${ts} ‚Äî ${tag}: ${l.text}`
        });
        els.historyScroll.textContent = lines.join("\n");
        els.historyScroll.scrollTop = els.historyScroll.scrollHeight;

        els.historyFull.textContent = lines.join("\n");
      }
      function updateCapsule(){
        const tm = state.tmChars/100;
        const bm = state.bmPrompts.length;
        const c  = 0.85;
        const base = (tm*0.2)+(bm*0.4);
        const faith = 1.0;
        const sys   = 0.3;
        const trc   = 0.5;
        const D     = 0.0;
        const raw = base + faith + sys + trc - D;
        const e0 = Math.tanh(raw);
        const e0Display = e0.toFixed(3);
        els.metricE0.textContent = e0Display;
        els.bottomE0.textContent = e0Display;

        const tmDisplay = tm.toFixed(2);
        els.metricTM.textContent = tmDisplay;
        els.bottomTM.textContent = tmDisplay;

        const bmDisplay = bm.toFixed(2);
        els.metricBM.textContent = bmDisplay;
        els.bottomBM.textContent = bmDisplay;

        els.metricC.textContent = c.toFixed(3);
        els.bottomC.textContent = c.toFixed(3);
      }

      function createBmFromStory(text,source){
        const now = new Date();
        const id  = state.nextBmId++;
        const title = text.length>80?text.slice(0,77)+"‚Ä¶":text;
        const obj = {
          id,
          source,
          title,
          text,
          ts:now.toISOString(),
          locked:false
        };
        state.bmPrompts.push(obj);
        safeSaveJSON(KEY_BM,{nextId:state.nextBmId,items:state.bmPrompts});
        renderBMList();
      }
      function renderBMList(filterText){
        const listEl = els.bmList;
        if(!listEl) return;
        const items = state.bmPrompts.slice().sort((a,b)=>a.ts<b.ts?1:-1);
        const q = (filterText||"").toLowerCase();
        const filtered = items.filter(item=>{
          if(!q) return true;
          return (item.title||"").toLowerCase().includes(q) ||
                 (item.text||"").toLowerCase().includes(q);
        });
        els.bmCount.textContent = filtered.length;
        if(!filtered.length){
          listEl.innerHTML = '<div class="bmEmpty">No BM snapshots yet. Long, meaningful stories will appear here.</div>';
          els.bmViewer.style.display="none";
          return;
        }
        listEl.innerHTML = "";
        filtered.forEach(item=>{
          const row = document.createElement("div");
          row.className = "bmItem";
          row.dataset.id = item.id;

          const main = document.createElement("div");
          main.className = "bmItemMain";

          const t = document.createElement("div");
          t.className = "bmItemTitle";
          t.textContent = item.title||"(untitled memory)";
          main.appendChild(t);

          const meta = document.createElement("div");
          meta.className = "bmItemMeta";
          const d = new Date(item.ts).toLocaleString();
          meta.textContent = `${d} ¬∑ Source: ${item.source||"story"}`;
          main.appendChild(meta);

          const badge = document.createElement("div");
          badge.className = "bmItemBadge";
          badge.textContent = item.locked?"Locked":"Ephemeral";

          row.appendChild(main);
          row.appendChild(badge);

          row.addEventListener("click",()=>openBMViewer(item.id));
          listEl.appendChild(row);
        });
      }
      function openBMViewer(id){
        const item = state.bmPrompts.find(x=>x.id===id);
        if(!item) return;
        els.bmViewerTitle.textContent = item.title||"(untitled memory)";
        const d = new Date(item.ts).toLocaleString();
        els.bmViewerMeta.textContent = `${d} ¬∑ Source: ${item.source||"story"} ¬∑ ${item.locked?"Locked":"Ephemeral"}`;
        els.bmViewerBody.textContent = item.text||"";
        els.bmViewer.dataset.id = id;
        els.bmViewer.style.display = "block";
      }
      function toggleBMLock(){
        const id = parseInt(els.bmViewer.dataset.id,10);
        if(!id) return;
        const item = state.bmPrompts.find(x=>x.id===id);
        if(!item) return;
        item.locked = !item.locked;
        safeSaveJSON(KEY_BM,{nextId:state.nextBmId,items:state.bmPrompts});
        renderBMList(els.bmSearch.value);
        openBMViewer(id);
        showToast(item.locked?"BM item locked":"BM item unlocked");
      }
      function deleteBM(){
        const id = parseInt(els.bmViewer.dataset.id,10);
        if(!id) return;
        const item = state.bmPrompts.find(x=>x.id===id);
        if(!item) return;
        if(!confirm("Delete this BM snapshot? This cannot be undone.")) return;
        state.bmPrompts = state.bmPrompts.filter(x=>x.id!==id);
        safeSaveJSON(KEY_BM,{nextId:state.nextBmId,items:state.bmPrompts});
        els.bmViewer.style.display="none";
        renderBMList(els.bmSearch.value);
        showToast("BM snapshot deleted");
      }
      if(els.bmLockToggle) els.bmLockToggle = document.getElementById("bmLockToggle");
      if(els.bmDelete) els.bmDelete = document.getElementById("bmDelete");

      if(els.bmLockToggle){
        els.bmLockToggle.addEventListener("click",toggleBMLock);
      }
      if(els.bmDelete){
        els.bmDelete.addEventListener("click",deleteBM);
      }
      if(els.bmSearch){
        els.bmSearch.addEventListener("input",()=>{
          renderBMList(els.bmSearch.value);
        });
      }
      if(els.bmSearchToday){
        els.bmSearchToday.addEventListener("click",()=>{
          const today = new Date().toISOString().slice(0,10);
          els.bmSearch.value = today;
          renderBMList(today);
        });
      }

      function sendUserMessage(){
        const text = (els.userInput.value||"").trim();
        if(!text) return;
        els.userInput.value = "";
        state.tmChars += text.length;
        logLine("me",text);

        createBmFromStory(text,"story");
        logLine("sys","[Local seed] (placeholder) AURA-X Œ© processed your input while staying offline.");
        state.lastAnswerSource = "seed";
        updateCapsule();
      }

      if(els.btnSend){
        els.btnSend.addEventListener("click",sendUserMessage);
      }
      if(els.userInput){
        els.userInput.addEventListener("keydown",e=>{
          if(e.key==="Enter" && !e.shiftKey){
            e.preventDefault();
            sendUserMessage();
          }
        });
      }

      if(els.btnLike){
        els.btnLike.addEventListener("click",()=>{
          showToast("<strong>Marked</strong> last answer correct (will reinforce local intelligence later).");
        });
      }
      if(els.btnDislike){
        els.btnDislike.addEventListener("click",()=>{
          showToast("<strong>Marked</strong> last answer incorrect (future builds will ask for the right one).");
        });
      }
      if(els.btnCopyLast){
        els.btnCopyLast.addEventListener("click",()=>{
          const last = state.history.slice().reverse().find(l=>l.speaker!=="me");
          if(!last){
            showToast("No answer to copy yet.");
            return;
          }
          navigator.clipboard.writeText(last.text||"").then(()=>{
            showToast("Answer copied to clipboard.");
          }).catch(()=>{
            showToast("Could not copy. Clipboard blocked by browser.");
          });
        });
      }
      if(els.btnHistoryOpen){
        els.btnHistoryOpen.addEventListener("click",()=>{
          if(!els.modalHistory) return;
          els.modalHistory.style.display="flex";
        });
      }

      document.querySelectorAll(".pillButton[data-modal]").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const id = btn.getAttribute("data-modal");
          const modal = document.getElementById(id);
          if(modal) modal.style.display = "flex";
        });
      });

      document.querySelectorAll(".modalClose").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const id = btn.getAttribute("data-close");
          const modal = document.getElementById(id);
          if(modal) modal.style.display="none";
        });
      });

      document.querySelectorAll(".modalOverlay").forEach(overlay=>{
        overlay.addEventListener("click",e=>{
          if(e.target===overlay){
            overlay.style.display="none";
          }
        });
      });

      if(els.btnOptions){
        els.btnOptions.addEventListener("click",()=>{
          if(!els.modalConfig) return;
          els.modalConfig.style.display = "flex";
        });
      }

      function initFromStorage(){
        const bmData = safeLoadJSON(KEY_BM,null);
        if(bmData && Array.isArray(bmData.items)){
          state.bmPrompts = bmData.items;
          state.nextBmId  = bmData.nextId|| (bmData.items.length+1);
        }
        const histData = safeLoadJSON(KEY_HIST,null);
        if(histData && Array.isArray(histData.lines)){
          state.history = histData.lines;
        }
        const cfg = safeLoadJSON(KEY_CFG,null);
        if(cfg && typeof cfg.tmChars==="number"){
          state.tmChars = cfg.tmChars;
        }
        renderHistory();
        renderBMList();
        updateCapsule();
      }

      initFromStorage();

      applySavedDreamDelay();
      if (els.dreamDelaySelect) {
        els.dreamDelaySelect.addEventListener("change", saveDreamDelayFromUI);
      }

      document.addEventListener("click", registerActivity, { passive: true });
      document.addEventListener("keydown", registerActivity);
      document.addEventListener("touchstart", registerActivity, { passive: true });

      if (els.dreamOverlay) {
        els.dreamOverlay.addEventListener("click", registerActivity);
      }

      registerActivity();

      logLine("sys","AURA-X Œ© ready. TM = your inputs only; everything else stays on this device.");
    });
  </script>

  <!-- Dream Mode visual overlay -->
  <div id="dreamOverlay">
    <div class="dream-inner">
      <div class="dream-title">AURA-X Œ© ‚Äì Dream Mode</div>
      <div class="dream-snippet" id="dreamSnippet">
        (sleeping‚Ä¶ processing memories‚Ä¶)
      </div>
      <div class="dream-hint">Tap or click to wake up</div>
    </div>
  </div>

</body>
</html>