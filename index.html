<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AURA-X Î© â€“ Offline Emotional Continuity Engine</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ===== UI / STYLE : UNCHANGED FROM CODE 9.9 ===== -->
<style>
/* ğŸ”’ EXACT Code 9.9 CSS â€“ UNTOUCHED */
/* (Ø¢Ù¾ Ú©ÛŒ original CSS ÛŒÛØ§Úº as-is Ø±ÛÛ’ Ú¯ÛŒ) */
</style>
</head>

<body>

<!-- ===== EXACT Code 9.9 HTML STRUCTURE â€“ UNCHANGED ===== -->
<!-- (header, capsules, options, windows, buttons Ø³Ø¨ ÙˆÛÛŒ ÛÛŒÚº) -->

<script>
/* ===============================
   AURA-X Î© CORE (Code 9.9)
   PATCH LEVEL: 10.0
   UI: LOCKED
================================ */

const KEY_CFG   = "aura_cfg";
const KEY_INT   = "aura_intelligence";
const KEY_BM    = "aura_bm";
const KEY_HIST  = "aura_history";
const KEY_USER  = "aura_user";

/* ---------- STATE ---------- */
let state = {
  booted: false,            // âœ… NEW: prevent duplicate system msg
  lastActivity: Date.now(),
  dreamTimeout: null,
  dreamIntervalMs: null,
  dreamMode: false,
  history: [],
  bmPrompts: [],
  intelligence: [],
  metrics: { TM:0, BM:0, C:0.85, E0:0 }
};

/* ---------- SAFE LOAD ---------- */
function safeLoadJSON(k, f){
  try{ return JSON.parse(localStorage.getItem(k)) ?? f; }
  catch{ return f; }
}

/* ---------- LOG LINE (PATCHED) ---------- */
function logLine(role, text){
  if(!text) return;

  // âŒ remove leading dot / junk
  text = text.replace(/^\.\s*/, "");

  // âŒ prevent duplicate boot message
  if(role === "sys" && state.booted) return;

  if(role === "sys") state.booted = true;

  const box = document.getElementById("conversationBox");
  if(!box) return;

  const div = document.createElement("div");
  div.className = role === "user" ? "line user" : "line aura";
  div.textContent = text;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

/* ---------- BOOT ---------- */
function initFromStorage(){
  state.history     = safeLoadJSON(KEY_HIST, []);
  state.bmPrompts   = safeLoadJSON(KEY_BM, []);
  state.intelligence= safeLoadJSON(KEY_INT, []);

  logLine("sys",
    "AURA-X Î© ready. TM = your inputs only; everything else stays on this device."
  );
}

/* ---------- ACTIVITY TRACKING ---------- */
function registerActivity(){
  state.lastActivity = Date.now();
  if(state.dreamMode) exitDreamMode();
}

/* ---------- DREAM MODE ---------- */
function enterDreamMode(){
  if(state.dreamMode) return;
  state.dreamMode = true;

  const overlay = document.getElementById("dreamOverlay");
  if(overlay) overlay.style.display = "flex";
}

function exitDreamMode(){
  state.dreamMode = false;
  const overlay = document.getElementById("dreamOverlay");
  if(overlay) overlay.style.display = "none";
}

/* ---------- MANUAL SCREENSAVER SETTING ---------- */
function applyDreamSetting(ms){
  clearTimeout(state.dreamTimeout);
  state.dreamIntervalMs = ms;

  if(!ms) return;

  state.dreamTimeout = setTimeout(()=>{
    enterDreamMode();
  }, ms);
}

/* ---------- OPTIONS BIND (SAFE) ---------- */
function bindOnce(id, fn){
  const el = document.getElementById(id);
  if(!el || el.dataset.bound) return;
  el.dataset.bound = "1";
  el.addEventListener("click", fn);
}

/* ---------- OPEN BUTTON FIX ---------- */
bindOnce("btnOptions", ()=>{
  document.getElementById("optionsPanel")?.classList.toggle("open");
});

/* ---------- GLOBAL ACTIVITY ---------- */
["click","scroll","keydown","touchstart"].forEach(ev=>{
  document.addEventListener(ev, registerActivity, {passive:true});
});

/* ---------- INIT ---------- */
document.addEventListener("DOMContentLoaded", initFromStorage);
</script>

</body>
</html>