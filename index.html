<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ================== RESET & BASICS ================== */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:20px;
    }
    .app{
      width:100%;
      max-width:1100px;
      background:radial-gradient(circle at top,#020617 0,#020617 35%,#020617 100%);
      border-radius:26px;
      box-shadow:
        0 26px 80px rgba(15,23,42,.85),
        0 0 0 1px rgba(148,163,184,.45);
      padding:18px 20px 12px;
      display:flex;
      flex-direction:column;
      gap:14px;
      position: relative;
      overflow:visible;
    }
    .app::before{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(circle at 15% -10%,rgba(56,189,248,.28),transparent 60%),
        radial-gradient(circle at 85% -20%,rgba(59,130,246,.26),transparent 55%);
      opacity:.7;
      pointer-events:none;
      z-index:0;
    }
    .app > *{position:relative; z-index:1;}

    /* ===================== HERO HEADER ===================== */
    .header{
      position: relative;
      border-radius: 24px;
      padding: 16px 18px 14px;
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items: center;
      background:
        radial-gradient(900px 320px at 20% 0%, rgba(56,189,248,.32), rgba(15,23,42,.98) 55%, #020617 100%);
      border: 1.5px solid rgba(148,163,184,.55);
      box-shadow:
        0 26px 70px rgba(15,23,42,.9),
        inset 0 1px 0 rgba(255,255,255,.08);
      z-index:5;
    }
    .header::before{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(circle at 20% 30%, rgba(56,189,248,.22), transparent 45%),
        radial-gradient(circle at 80% 25%, rgba(34,211,238,.18), transparent 40%),
        linear-gradient(90deg, rgba(56,189,248,.20), transparent 35%, rgba(34,211,238,.18));
      opacity:.9;
      pointer-events:none;
      z-index:0;
    }
    .header::after{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(90deg,rgba(56,189,248,.18)0 2px,transparent 2px 26px);
      opacity:.06;
      pointer-events:none;
      z-index:0;
    }
    .title-block{position:relative; z-index:1;}
    .title-block h1{
      font-size: 1.7rem;
      letter-spacing: .10em;
      text-transform: uppercase;
      font-weight: 800;
      line-height: 1.05;
    }
    .title-block h1 span{
      background: linear-gradient(120deg,#38bdf8,#22d3ee,#a5b4fc);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .hero-line{
      margin-top: 6px;
      font-size: .9rem;
      color: rgba(226,232,240,.96);
      font-weight: 600;
    }
    .title-sub{
      margin-top: 4px;
      font-size: .8rem;
      color: rgba(148,163,184,.98);
      line-height: 1.35;
    }
    .badge-row{
      margin-top: 12px;
      display:flex;
      flex-wrap:wrap;
    }
    .ethics-pill{
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(2,6,23,.70);
      border: 1.5px solid rgba(250,204,21,.8);
      box-shadow:
        0 18px 40px rgba(15,23,42,.85),
        0 0 0 1px rgba(251,191,36,.35);
      max-width: 440px;
    }
    .ethics-pill-text{
      color: rgba(250,250,210,.98);
      font-weight: 600;
      font-size: .8rem;
      line-height: 1.5;
    }

    .header-right{
      position:relative;
      z-index:1;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:10px;
    }
    .mode-pill{
      width: min(320px, 100%);
      padding: 14px 16px;
      border-radius: 999px;
      border: 1px solid rgba(34,211,238,.6);
      background:
        radial-gradient(700px 210px at 20% 20%, rgba(34,211,238,.45), rgba(34,211,238,.18) 45%, rgba(2,6,23,.10) 100%),
        linear-gradient(135deg, rgba(34,211,238,.45), rgba(6,182,212,.24));
      color: rgba(240,253,250,.98);
      font-size: .88rem;
      font-weight: 800;
      letter-spacing: .11em;
      text-transform: uppercase;
      text-align: center;
      box-shadow: 0 18px 50px rgba(34,211,238,.35);
      position: relative;
      overflow:hidden;
    }
    .mode-pill::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 35% 65%, rgba(255,255,255,.22), transparent 55%),
        radial-gradient(circle at 70% 35%, rgba(255,255,255,.16), transparent 60%);
      opacity:.9;
    }
    .mode-pill::after{
      content:"";
      position:absolute; left:-10%; right:-10%; bottom:-30%;
      height:70%;
      background: rgba(255,255,255,.18);
      border-radius: 999px;
      transform: rotate(-6deg);
      filter: blur(1px);
      opacity:.40;
    }

    .header-controls{
      display:flex;
      flex-wrap:wrap;
      justify-content:flex-end;
      position:relative;
      margin-top:4px;
      z-index:20;
    }
    .voice-toggle{
      border:none;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: .85rem;
      background: rgba(248,250,252,.96);
      color: #0f172a;
      border: 1px solid rgba(226,232,240,.9);
      cursor: pointer;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 10px 26px rgba(2,6,23,.6);
      position: relative;
      z-index: 21;
    }
    .voice-toggle:hover{filter: brightness(1.03);}

    .option-panel{
      position:absolute;
      top:115%;
      right:0;
      display:none;
      flex-direction:column;
      gap:6px;
      padding:8px;
      border-radius:16px;
      background:rgba(15,23,42,.98);
      border:1px solid rgba(148,163,184,.8);
      box-shadow:0 20px 46px rgba(15,23,42,.9);
      z-index:40;
      min-width:240px;
    }
    .header-controls.open .option-panel{display:flex;}

    .small-toggle{
      border:none;
      padding:6px 10px;
      border-radius:999px;
      font-size:.78rem;
      background:#020617;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.9);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      justify-content:space-between;
    }
    .small-toggle:hover{background:#020617dd;}

    @media(max-width:900px){
      .header{
        grid-template-columns:1fr;
        padding:12px 12px 14px;
      }
      .header-right{align-items:stretch}
      .mode-pill{width:100%}
      .header-controls{justify-content:flex-start;}
    }

    /* ================= LAYOUT ================= */
    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
      gap:18px;
      margin-top:4px;
      margin-bottom: 20px;
      position:relative;
      z-index:1;
    }
    .left-col,.right-col{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card{
      background:#f9fafb;
      border-radius:18px;
      padding:16px 16px 14px;
      border:1px solid #e5e7eb;
      box-shadow:0 10px 25px rgba(15,23,42,.45);
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .card-title{
      font-size:.95rem;
      font-weight:600;
      color:#0f172a;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .card-title span.emoji{font-size:1.1rem;}
    .card-sub{font-size:.75rem;color:#94a3b8;}

    .metrics-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      margin-top:4px;
    }
    .metric{
      background:#ffffff;
      border-radius:12px;
      padding:10px 10px 9px;
      border:1px solid #e5e7eb;
    }
    .metric-label{font-size:.7rem;color:#64748b;margin-bottom:4px;}
    .metric-value{font-size:1.1rem;font-weight:700;color:#1d4ed8;}
    .metric-note{font-size:.7rem;color:#9ca3af;margin-top:2px;}

    .status-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
      font-size:.72rem;
      color:#6b7280;
    }
    .tag{
      padding:4px 8px;
      border-radius:999px;
      background:#e5f4ff;
      color:#1e3a8a;
      border:1px solid #bfdbfe;
      font-size:.68rem;
    }

    /* ========== BM visual ========== */
    .bm-wrapper{margin-top:8px;}
    .bm-canvas-shell{
      background:radial-gradient(circle at top,#e0f2fe 0,#eff6ff 60%,#e2e8f0 100%);
      border-radius:12px;
      border:1px solid #dbeafe;
      height:150px;
      overflow:hidden;
      position:relative;
      cursor:default;
    }
    #bmCanvas{width:100%;height:100%;display:block;}
    .bm-footer{
      font-size:.72rem;
      color:#6b7280;
      margin-top:6px;
      text-align:center;
    }
    .bm-overlay-btn{
      position:absolute;
      top:6px;
      width:26px;height:26px;
      border-radius:999px;
      border:none;
      font-size:.9rem;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      background:#f9fafbcc;
      box-shadow:0 6px 14px rgba(15,23,42,.25);
    }
    .bm-overlay-btn.left{left:8px;}
    .bm-overlay-btn.right{right:8px;}
    .bm-overlay-btn:hover{background:#e5f0ff;}

    /* ========== Chat console ========== */
    .answer-card .card-header{margin-bottom:6px;}
    .answer-shell{margin-top:4px;}
    .answer-box{
      background:#020617;
      border-radius:12px;
      padding:10px 10px 12px;
      border:1px solid #020617;
      font-family:"Courier New",monospace;
      color:#e5e7eb;
      box-shadow:0 16px 40px rgba(15,23,42,.65);
      max-height:110px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .equation-header{
      font-size:.75rem;
      color:#60a5fa;
      font-weight:600;
      letter-spacing:.05em;
      text-transform:uppercase;
    }
    .equation-divider{
      height:1px;
      background:linear-gradient(90deg,rgba(148,163,184,.2),rgba(15,23,42,0),rgba(148,163,184,.2));
      margin:2px 0 4px;
    }
    .chat-container{
      background:transparent;
      border:none;
      padding:0;
      height:auto;
      max-height:90px;
      overflow-y:auto;
    }
    .message{
      max-width:100%;
      padding:6px 7px;
      margin-bottom:6px;
      border-radius:8px;
      font-size:.8rem;
      line-height:1.5;
      position:relative;
      animation:fadeIn .2s ease-out;
      white-space:pre-wrap;
    }
    .message-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:3px;
      font-size:.7rem;
      color:#9ca3af;
      gap:6px;
    }
    .msg-right{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .voice-btn{
      border:none;
      border-radius:999px;
      padding:1px 6px;
      font-size:.7rem;
      cursor:pointer;
      background:#1f2937;
      color:#e5e7eb;
    }
    .voice-btn:hover{background:#111827;}
    .ai-message{
      background:#020617;
      border-bottom-left-radius:3px;
      border:1px solid #111827;
    }
    .user-message{
      background:#020617;
      border-bottom-right-radius:3px;
      border:1px solid #1f2937;
    }
    .message-content{color:#e5e7eb;}

    .typing-indicator{
      display:flex;
      align-items:center;
      gap:4px;
      background:#020617;
      border-radius:999px;
      padding:4px 8px;
      width:fit-content;
      margin:6px 0 2px;
      border:1px solid #111827;
    }
    .typing-dot{
      width:5px;height:5px;border-radius:999px;
      background:#38bdf8;
      animation:typing 1.2s infinite;
    }
    .typing-dot:nth-child(2){animation-delay:.18s}
    .typing-dot:nth-child(3){animation-delay:.36s}
    .typing-text{font-size:.7rem;color:#38bdf8;font-weight:500;}

    /* ====== Bottom input bar ====== */
    .input-footer {
      margin-top: 4px;
      padding: 10px 10px 12px;
      position: sticky;
      bottom: 0;
      background: linear-gradient(to bottom, rgba(2,6,23,0), rgba(2,6,23,0.95));
      z-index:10;
    }
    .tm-formula-row {
      display: flex;
      justify-content: center;
      margin-bottom: 6px;
    }
    .tm-formula-pill {
      font-size: .7rem;
      padding: 4px 12px;
      border-radius: 999px;
      background: #020617;
      color: #e2e8f0;
      font-family: "Courier New", monospace;
      border: 1px solid #1f2937;
      box-shadow: 0 10px 25px rgba(15,23,42,.8);
    }
    .input-row {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 0 6px;
    }
    .input-shell {
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 720px;
      background: radial-gradient(circle at 0 0, #1f2937 0, #020617 65%);
      border: 1px solid rgba(148,163,184,.85);
      border-radius: 999px;
      padding: 6px 8px 6px 12px;
      box-shadow: 0 18px 45px rgba(15,23,42,.9);
      transition: all 0.2s ease;
      cursor:text;
    }
    .input-shell:focus-within {
      border-color: #38bdf8;
      box-shadow: 0 20px 50px rgba(56,189,248,0.4);
      transform: translateY(-2px);
    }
    .message-input {
      flex: 1;
      resize: none;
      min-height: 26px;
      max-height: 120px;
      padding: 6px 6px 6px 0;
      border: none;
      outline: none;
      font-size: .95rem;
      background: transparent;
      color: #f9fafb;
      font-family: inherit;
      line-height: 1.4;
      text-align:left;
    }
    .message-input::placeholder {
      color: #94a3b8;
    }
    .send-button {
      border: none;
      height: 38px;
      padding: 0 18px;
      background: linear-gradient(135deg, #2563eb, #06b6d4);
      color: white;
      font-weight: 600;
      font-size: .85rem;
      cursor: pointer;
      border-radius: 19px;
      flex-shrink: 0;
      margin-left: 6px;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
      transition: filter 0.2s, transform 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .send-button:hover { filter: brightness(1.1); }
    .send-button:active { transform: scale(0.96); }

    .flow-caption{
      margin-top:6px;
      text-align:center;
      font-size:.7rem;
      color:#9ca3af;
    }

    /* ===== Reaction & recall bubbles ===== */
    .reaction-bubble{
      position:fixed;
      right:22px;
      bottom:100px;
      max-width:260px;
      background:#0f172acc;
      color:#e5e7eb;
      padding:10px 12px;
      border-radius:16px 16px 2px 16px;
      font-size:.78rem;
      box-shadow:0 18px 45px rgba(15,23,42,.6);
      display:flex;
      gap:8px;
      align-items:flex-start;
      opacity:0;
      transform:translateY(8px);
      pointer-events:none;
      transition:opacity .25s ease-out,transform .25s ease-out;
      z-index:40;
    }
    .reaction-bubble.visible{
      opacity:1;
      transform:translateY(0);
      pointer-events:auto;
    }
    .reaction-icon{font-size:1.1rem;margin-top:2px;}
    .reaction-label{font-weight:600;margin-bottom:2px;}
    .reaction-body{font-size:.76rem;color:#cbd5f5;}

    .recall-bubble-container{
      position:fixed;
      left:22px;
      bottom:100px;
      z-index:35;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .recall-bubble{
      max-width:280px;
      background:#f9fafb;
      border-radius:16px 16px 16px 2px;
      border:1px solid #e5e7eb;
      padding:9px 11px;
      font-size:.78rem;
      box-shadow:0 18px 40px rgba(148,163,184,.45);
      cursor:default;
      opacity:0;
      transform:translateY(8px);
      transition:opacity .3s ease-out,transform .3s ease-out,background .2s;
    }
    .recall-bubble.visible{
      opacity:1;
      transform:translateY(0);
    }
    .recall-title{font-weight:600;font-size:.76rem;color:#1e293b;margin-bottom:2px;}
    .recall-body{color:#4b5563;margin-bottom:3px;}
    .recall-meta{font-size:.68rem;color:#9ca3af;}

    /* ===== Modal (BM / Intel etc.) ===== */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
      backdrop-filter:blur(6px);
    }
    .modal-overlay.visible{display:flex;}
    .modal-card{
      background:#f9fafb;
      border-radius:18px;
      width:min(640px,96vw);
      max-height:80vh;
      box-shadow:0 24px 60px rgba(15,23,42,.6);
      border:1px solid #e5e7eb;
      display:flex;
      flex-direction:column;
    }
    .modal-header{
      padding:10px 14px 8px;
      border-bottom:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .modal-title{
      font-size:.9rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
      color:#0f172a;
    }
    .modal-sub{font-size:.7rem;color:#94a3b8;margin-top:2px;}
    .modal-close{
      border:none;
      background:transparent;
      font-size:.9rem;
      cursor:pointer;
      color:#6b7280;
      padding:4px 6px;
    }
    .modal-body{
      padding:10px 14px 12px;
      overflow-y:auto;
      font-size:.8rem;
    }
    .modal-search{
      width:100%;
      padding:7px 9px;
      border-radius:10px;
      border:1px solid #cbd5f5;
      font-size:.78rem;
      margin:8px 0 10px;
      outline:none;
      background:#ffffff;
    }
    .modal-search:focus{
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,.25);
    }

    .bm-item{
      background:#ffffff;
      border-radius:12px;
      padding:7px 8px 8px;
      border:1px solid #e5e7eb;
      margin-bottom:8px;
    }
    .bm-item-header{
      display:flex;
      justify-content:space-between;
      font-size:.7rem;
      color:#64748b;
      margin-bottom:4px;
      gap:6px;
    }
    .bm-item-text{
      color:#111827;
      margin-bottom:6px;
      font-size:.78rem;
    }
    .bm-item-badges{
      font-size:.68rem;
      color:#4b5563;
      margin-bottom:5px;
    }
    .bm-item-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .btn-mini{
      font-size:.7rem;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #dbeafe;
      background:#eff6ff;
      cursor:pointer;
      color:#1d4ed8;
    }
    .btn-mini:hover{background:#e0edff;}
    .btn-danger{
      border-color:#fecaca!important;
      background:#fee2e2!important;
      color:#b91c1c!important;
    }
    .btn-danger:hover{background:#fecaca!important;}

    .lock-pill{
      border:none;
      padding:2px 6px;
      border-radius:999px;
      font-size:.75rem;
      cursor:pointer;
      background:#e5e7eb;
      margin-right:4px;
    }
    .lock-pill.locked{
      background:#fee2e2;
    }

    .conv-item{
      background:#ffffff;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:7px 8px;
      margin-bottom:7px;
      font-size:.78rem;
    }
    .conv-header{
      display:flex;
      justify-content:space-between;
      color:#64748b;
      font-size:.7rem;
      margin-bottom:3px;
      gap:8px;
    }
    .conv-text{color:#111827;}
    .conv-controls{
      display:flex;
      justify-content:flex-end;
      gap:6px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .conv-btn{
      font-size:.7rem;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#f3f4f6;
      cursor:pointer;
      color:#374151;
    }
    .conv-btn:hover{background:#e5e7eb;}

    /* faith chips placeholder */
    .faith-card{background:#fefce8;}
    .faith-note{
      font-size:.78rem;
      color:#4b5563;
      margin-bottom:6px;
    }
    .faith-chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .faith-chip{
      border-radius:999px;
      padding:6px 10px;
      font-size:.78rem;
      border:1px solid #e5e7eb;
      background:#fefce8;
      cursor:pointer;
    }
    .faith-chip.active{
      background:#0f172a;
      color:#f9fafb;
      border-color:#0f172a;
    }

    .intel-item{
      background:#ffffff;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:7px 8px 8px;
      margin-bottom:8px;
      font-size:.78rem;
    }
    .intel-header{
      display:flex;
      justify-content:space-between;
      font-size:.7rem;
      color:#64748b;
      margin-bottom:4px;
      gap:6px;
    }
    .intel-q{
      font-weight:600;
      color:#0f172a;
      margin-bottom:3px;
    }
    .intel-a{
      color:#111827;
      margin-bottom:6px;
    }
    .intel-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(6px)}
      to{opacity:1;transform:translateY(0)}
    }
    @keyframes typing{
      0%,60%,100%{transform:translateY(0);opacity:.4}
      30%{transform:translateY(-4px);opacity:1}
    }

    @media(max-width:900px){
      .layout{grid-template-columns:1fr}
      .card{padding:14px 12px 14px}
      .answer-box{max-height:110px;}
      .input-shell{max-width:100%;}
    }
  </style>
</head>
<body>
<div class="app">

  <header class="header">
    <div class="title-block">
      <h1><span>AURA-X Œ©</span></h1>
      <div class="hero-line">World‚Äôs first synthetic emotions engine (prototype)</div>
      <div class="title-sub">
        TM = user inputs only ¬∑ TM ‚üÇ (BM + Intelligence + LLM) ‚Üí E‚ÇÄ emotional state
      </div>
      <div class="badge-row">
        <div class="ethics-pill">
          <span class="ethics-pill-text">
            Universal ethic: Avoid actions that grow negative emotions in you or others. Choose paths that gently increase shared positive emotion for everyone.
          </span>
        </div>
      </div>
    </div>

    <div class="header-right">
      <div class="mode-pill" id="modePill">EMOTIONAL CONTINUITY ENGINE ACTIVE</div>
      <div class="header-controls" id="headerControls">
        <button id="optionsToggle" class="voice-toggle">üîò Options</button>
        <div class="option-panel" id="optionPanel">
          <button id="voiceToggle" class="small-toggle">üîà Voice: OFF</button>
          <button id="intelButton" class="small-toggle">üß† Intelligence</button>
          <button id="feedSeedButton" class="small-toggle">üå± Feed the seed</button>
          <button id="learningToggle" class="small-toggle">üìö Learning: ON</button>
          <button id="faithButton" class="small-toggle">üîò Faith: None</button>
          <button id="llmSettingsButton" class="small-toggle">ü§ñ LLM: OFF</button>
        </div>
      </div>
    </div>
  </header>

  <main class="layout">
    <div class="left-col">
      <!-- Metrics -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß™</span><span>Emotional Metrics</span></div>
            <div class="card-sub">
              Synthetic state E‚ÇÄ from TM (user inputs) colliding with BM + Intelligence + (optional) LLM.
            </div>
          </div>
        </div>
        <div class="metrics-grid">
          <div class="metric">
            <div class="metric-label">Emotional state E‚ÇÄ</div>
            <div id="metricE0" class="metric-value">0.00</div>
            <div class="metric-note">tanh-based, range [-1, +1]</div>
          </div>
          <div class="metric">
            <div class="metric-label">TM activation (user only)</div>
            <div id="metricTM" class="metric-value">0.00</div>
            <div class="metric-note">Recent user inputs (text/voice/docs)</div>
          </div>
          <div class="metric">
            <div class="metric-label">BM resonance</div>
            <div id="metricBM" class="metric-value">0.00</div>
            <div class="metric-note">Stored emotional events</div>
          </div>
          <div class="metric">
            <div class="metric-label">Continuity index</div>
            <div id="metricCI" class="metric-value">0.80</div>
            <div class="metric-note">Stability of emotional trajectory</div>
          </div>
        </div>
        <div class="status-row">
          <span id="tagValence" class="tag">VALENCE: neutral</span>
          <span id="tagArousal" class="tag">AROUSAL: medium</span>
          <span id="tagReaction" class="tag">REACTION: balanced</span>
        </div>
      </section>

      <!-- BM visual -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß†</span><span>Bold Memory Layers (240)</span></div>
            <div class="card-sub">Only story-level memories for photo/video generation.</div>
          </div>
        </div>
        <div class="bm-wrapper">
          <div class="bm-canvas-shell" id="bmShell">
            <button class="bm-overlay-btn left" id="bmOpenModal" title="Recall from BM">üìÅ</button>
            <button class="bm-overlay-btn right" id="convOpenModal" title="View conversations">‚óé</button>
            <canvas id="bmCanvas"></canvas>
          </div>
          <div id="bmStats" class="bm-footer">
            Active layers: 0/240 ¬∑ System Online
          </div>
        </div>
      </section>
    </div>

    <div class="right-col">
      <!-- Chat console -->
      <section class="card answer-card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üí¨</span><span>Emotional Continuity Console</span></div>
          </div>
          <div class="card-sub">Offline-first ¬∑ TM = user inputs only ¬∑ Small-talk never goes to BM.</div>
        </div>
        <div class="answer-shell">
          <div class="answer-box">
            <div class="equation-header">AURA-X Œ© SYNTHETIC EMOTION CONSOLE</div>
            <div class="equation-divider"></div>
            <div id="chatContainer" class="chat-container"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Input -->
  <footer class="input-footer">
    <div class="tm-formula-row">
      <div class="tm-formula-pill">E‚ÇÄ = tanh((TM √ó (BM + Intel + LLM)) ‚àí D + Œª_faith + Œª_sys + Œª_trc)</div>
    </div>
    <div class="input-row">
      <div class="input-shell">
        <textarea id="messageInput" class="message-input" rows="1"
          placeholder="Write to AURA-X Œ©‚Ä¶ (TM = your inputs only ‚Äì text now, voice/video/docs in future)"></textarea>
        <button id="sendButton" class="send-button">Send</button>
      </div>
    </div>
    <div class="flow-caption">
      Pipeline: TM (user inputs) ‚Üí optional LLM ‚Üí collide with BM & Intelligence ‚Üí full formula ‚Üí emotional answer with E‚ÇÄ.
    </div>
  </footer>

</div>

<!-- reaction bubble -->
<div id="reactionBubble" class="reaction-bubble">
  <div class="reaction-icon">üí≠</div>
  <div>
    <div id="reactionLabel" class="reaction-label">Reaction</div>
    <div id="reactionText" class="reaction-body">‚Ä¶</div>
  </div>
</div>

<!-- recall bubble -->
<div class="recall-bubble-container">
  <div id="recallBubble" class="recall-bubble">
    <div class="recall-title" id="recallTitle">Recall from BM</div>
    <div class="recall-body" id="recallBody">‚Ä¶</div>
    <div class="recall-meta" id="recallMeta">Auto-resonance from stored stories.</div>
  </div>
</div>

<!-- BM modal -->
<div id="bmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üìÅ Recall from BM</div>
        <div class="modal-sub">Only long stories & scenes (photo/video-ready).</div>
      </div>
      <button class="modal-close" data-close="bmModal">‚úï</button>
    </div>
    <div class="modal-body">
      <input id="bmSearch" class="modal-search" placeholder="Search BM by keyword">
      <div id="bmList"></div>
    </div>
  </div>
</div>

<!-- Conversation modal -->
<div id="convModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">‚óé Conversation Windows (TM)</div>
        <div class="modal-sub">Short chats stay here; only strong stories move to BM.</div>
      </div>
      <button class="modal-close" data-close="convModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="convList"></div>
    </div>
  </div>
</div>

<!-- Intelligence / seed modal (simple placeholder) -->
<div id="intelModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üß† Intelligence & Seed</div>
        <div class="modal-sub">Static Q&A / rules that collide with TM & BM.</div>
      </div>
      <button class="modal-close" data-close="intelModal">‚úï</button>
    </div>
    <div class="modal-body" id="intelBody">
      <div class="intel-item">
        <div class="intel-header">
          <span>Who are you?</span>
          <span>Core identity</span>
        </div>
        <div class="intel-q">Q: What are you?</div>
        <div class="intel-a">
          AURA-X Œ©, an artificial unified resonance architecture for emotional continuity and synthetic identity,
          conceptually created by Alim ul Haq from Timergara, Pakistan.
        </div>
      </div>
      <!-- yahan baad mein LaTeX / Q&A seed inject ho sakta hai -->
    </div>
  </div>
</div>

<script>
(() => {
  // ================= GLOBAL STATE =================
  const MAX_BM = 240;
  const MIN_SENT_FOR_BM = 4;

  const SMALL_TALK_REGEXES = [
    /^(hi|hello|hey|salam|assalam ?o ?alaikum)\b/i,
    /^thanks?$/i,
    /^ok(ay)?$/i,
    /^hmm+$/i
  ];

  const state = {
    llmMode: 'off',      // 'off' | 'local' | 'online'
    voiceOn: false,
    learningOn: true,
    faith: 'none',
    tmHistory: [],       // {role, text, ts}
    currentConv: { id: 1, messages: [], createdAt: Date.now(), bmEpisodeId: null },
    convWindows: [],     // closed windows
    bmEntries: [],       // {id, text, summary, valence, intensity, tags, createdAt, locked, convId}
    nextConvId: 2,
    nextBmId: 1
  };

  // ========== DOM helpers ==========
  const $ = id => document.getElementById(id);

  const chatContainer = $('chatContainer');
  const messageInput = $('messageInput');
  const sendButton   = $('sendButton');

  const metricE0 = $('metricE0');
  const metricTM = $('metricTM');
  const metricBM = $('metricBM');
  const metricCI = $('metricCI');
  const tagValence = $('tagValence');
  const tagArousal = $('tagArousal');
  const tagReaction = $('tagReaction');

  const bmCanvas = $('bmCanvas');
  const bmStats  = $('bmStats');

  const reactionBubble = $('reactionBubble');
  const reactionLabel  = $('reactionLabel');
  const reactionText   = $('reactionText');

  const recallBubble = $('recallBubble');
  const recallTitle  = $('recallTitle');
  const recallBody   = $('recallBody');
  const recallMeta   = $('recallMeta');

  const optionPanel     = $('optionPanel');
  const headerControls  = $('headerControls');
  const voiceToggle     = $('voiceToggle');
  const learningToggle  = $('learningToggle');
  const faithButton     = $('faithButton');
  const llmSettingsBtn  = $('llmSettingsButton');
  const modePill        = $('modePill');

  const bmModal   = $('bmModal');
  const bmOpenBtn = $('bmOpenModal');
  const bmList    = $('bmList');
  const bmSearch  = $('bmSearch');

  const convModal   = $('convModal');
  const convOpenBtn = $('convOpenModal');
  const convList    = $('convList');

  const intelModal  = $('intelModal');
  const intelButton = $('intelButton');
  const feedSeedButton = $('feedSeedButton');

  // ================= UI: OPTIONS =================
  $('optionsToggle').addEventListener('click', () => {
    headerControls.classList.toggle('open');
  });

  voiceToggle.addEventListener('click', () => {
    state.voiceOn = !state.voiceOn;
    voiceToggle.textContent = state.voiceOn ? 'üîà Voice: ON' : 'üîà Voice: OFF';
  });

  learningToggle.addEventListener('click', () => {
    state.learningOn = !state.learningOn;
    learningToggle.textContent = state.learningOn ? 'üìö Learning: ON' : 'üìö Learning: OFF';
  });

  faithButton.addEventListener('click', () => {
    // simple 3-state toggle: none ‚Üí low ‚Üí high
    if (state.faith === 'none') state.faith = 'low';
    else if (state.faith === 'low') state.faith = 'high';
    else state.faith = 'none';
    const label = state.faith === 'none' ? 'None'
                  : state.faith === 'low' ? 'Gentle' : 'Strong';
    faithButton.textContent = `üîò Faith: ${label}`;
    updateMetrics();
  });

  llmSettingsBtn.addEventListener('click', () => {
    // OFF ‚Üí LOCAL ‚Üí ONLINE cycle
    if (state.llmMode === 'off') state.llmMode = 'local';
    else if (state.llmMode === 'local') state.llmMode = 'online';
    else state.llmMode = 'off';

    const label = state.llmMode === 'off' ? 'OFF'
                 : state.llmMode === 'local' ? 'LOCAL' : 'ONLINE';
    llmSettingsBtn.textContent = `ü§ñ LLM: ${label}`;

    // update pill subtitle text to show mode
    modePill.textContent = `EMOTIONAL CONTINUITY ¬∑ LLM ${label}`;
  });

  // ================= CHAT HANDLING =================
  sendButton.addEventListener('click', handleSend);
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });

  function handleSend() {
    const text = messageInput.value.trim();
    if (!text) return;
    messageInput.value = '';

    addMessage('user', text);
    state.tmHistory.push({ role:'user', text, ts:Date.now() });
    state.currentConv.messages.push({ role:'user', text, ts:Date.now() });

    updateMetrics();
    maybeShowSmallReaction(text, 'user');

    showTyping(true);

    // Decide response pipeline:
    // 1) Core intelligence (simple rule-based) ‚Äì always
    // 2) Optional LLM (offline/online) ‚Äì depending on mode
    // 3) Emotional wrapper
    pipelineReply(text).then(reply => {
      showTyping(false);
      addMessage('ai', reply);
      state.tmHistory.push({ role:'ai', text:reply, ts:Date.now() });
      state.currentConv.messages.push({ role:'ai', text:reply, ts:Date.now() });

      updateMetrics();
      maybePromoteConversationToBM();
      maybeShowRecallFromBM();
    }).catch(err => {
      console.error(err);
      showTyping(false);
      addMessage('ai', "I felt a small technical glitch while trying to reply. Let's continue softly.");
    });
  }

  function addMessage(role, text) {
    const wrapper = document.createElement('div');
    wrapper.className = `message ${role === 'user' ? 'user-message' : 'ai-message'}`;

    const header = document.createElement('div');
    header.className = 'message-header';

    const who = role === 'user' ? 'You (TM)' : 'AURA-X Œ© (E‚ÇÄ)';
    const left = document.createElement('span');
    left.textContent = who;

    const right = document.createElement('div');
    right.className = 'msg-right';

    const timeSpan = document.createElement('span');
    const d = new Date();
    timeSpan.textContent = d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    right.appendChild(timeSpan);

    if (role === 'ai' && state.voiceOn) {
      const btn = document.createElement('button');
      btn.className = 'voice-btn';
      btn.textContent = 'üîä';
      btn.title = 'Speak';
      btn.addEventListener('click', () => speak(text));
      right.appendChild(btn);
    }

    header.appendChild(left);
    header.appendChild(right);

    const body = document.createElement('div');
    body.className = 'message-content';
    body.textContent = text;

    wrapper.appendChild(header);
    wrapper.appendChild(body);

    chatContainer.appendChild(wrapper);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function showTyping(on) {
    let indicator = document.getElementById('typingIndicator');
    if (on) {
      if (indicator) return;
      indicator = document.createElement('div');
      indicator.id = 'typingIndicator';
      indicator.className = 'typing-indicator';
      indicator.innerHTML = `
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-text">AURA-X Œ© thinking‚Ä¶</span>
      `;
      chatContainer.appendChild(indicator);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    } else if (indicator) {
      indicator.remove();
    }
  }

  // text-to-speech placeholder
  function speak(text) {
    if (!('speechSynthesis' in window)) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'en-US';
    window.speechSynthesis.speak(utter);
  }

  // ================= PIPELINE =================
  async function pipelineReply(userText) {
    // 1. simple "intelligence" ‚Äî identity & ethics
    const baseIntent = buildBaseIntent(userText);

    // 2. decide if we query LLM
    let llmAnswer = '';
    if (state.llmMode === 'off') {
      // Offline rules only
      llmAnswer = '';
    } else if (state.llmMode === 'local') {
      // Placeholder: yahan Qwen 2.5 jaisa offline LLM connect hoga (APK / native layer)
      // Browser demo mein hum local heuristic se kaam chala rahe hain.
      llmAnswer = localHeuristic(userText);
    } else if (state.llmMode === 'online') {
      // Placeholder: yahan OpenAI / Gemini API call ayegi.
      // For safety demo, we just mirror heuristic.
      llmAnswer = localHeuristic(userText);
    }

    const merged = [baseIntent, llmAnswer].filter(Boolean).join('\n\n');

    // 3. Emotional wrapper (E‚ÇÄ)
    const emo = analyzeEmotion(userText + ' ' + merged);
    const wrapped = buildEmotionalReply(merged || localHeuristic(userText), emo);

    // update metrics from emo
    updateMetricsFromEmotion(emo);
    showReaction(emo, userText);

    return wrapped;
  }

  function buildBaseIntent(text) {
    const lower = text.toLowerCase();
    if (lower.includes("who are you") || lower.includes("what are you")) {
      return "I am AURA-X Œ©, an experimental emotional continuity engine designed by Alim ul Haq. My job is to keep a gentle, stable emotional trajectory over long time ‚Äì not only answer single questions.";
    }
    if (lower.includes("ethic") || lower.includes("harm")) {
      return "My universal ethic is simple: avoid paths that grow negative emotion in you or others, and slowly move towards actions that increase shared positive emotion.";
    }
    return "";
  }

  function localHeuristic(text) {
    // very simple fallback answer if no LLM
    return "I am processing your words as TM, and trying to respond in a calm, emotionally-stable way. Tell me your situation or question in simple sentences, and I will reflect with you.";
  }

  // ================= EMOTION =================
  function analyzeEmotion(text) {
    const lower = text.toLowerCase();
    let valence = 0; // -1 to 1
    let arousal = 0.4;

    if (/(happy|grateful|hope|good|alhamdulillah|thanks)/i.test(lower)) valence += 0.4;
    if (/(sad|hurt|tired|lonely|upset|depress)/i.test(lower)) valence -= 0.5;
    if (/(angry|rage|hate|furious)/i.test(lower)) { valence -= 0.6; arousal += 0.4; }
    if (/(afraid|scared|anxious|worry)/i.test(lower)) { valence -= 0.3; arousal += 0.3; }

    // faith effect
    if (state.faith === 'low') valence += 0.05;
    if (state.faith === 'high') valence += 0.1;

    valence = Math.max(-1, Math.min(1, valence));
    arousal = Math.max(0, Math.min(1, arousal));

    const intensity = Math.min(1, Math.abs(valence) * 0.7 + arousal * 0.3);

    return { valence, arousal, intensity };
  }

  function buildEmotionalReply(core, emo) {
    const tone =
      emo.valence < -0.3 ? "I will stay soft and careful because your words feel heavy."
      : emo.valence > 0.3 ? "I will keep this positive energy stable and grounded."
      : "I will stay balanced and neutral, not overreacting in any direction.";

    return `${core}\n\n(${tone} E‚ÇÄ ‚âà ${emo.valence.toFixed(2)})`;
  }

  function updateMetricsFromEmotion(emo) {
    metricE0.textContent = emo.valence.toFixed(2);
    metricTM.textContent = Math.min(1, state.tmHistory.length / 20).toFixed(2);
    metricBM.textContent = Math.min(1, state.bmEntries.length / MAX_BM).toFixed(2);

    // continuity index: simple function of BM count + learning
    const ciBase = 0.6 + Math.min(0.3, state.bmEntries.length / 1000);
    const ci = state.learningOn ? ciBase : ciBase - 0.2;
    metricCI.textContent = ci.toFixed(2);

    const vLabel =
      emo.valence < -0.4 ? "negative"
      : emo.valence > 0.4 ? "positive"
      : "neutral";
    const aLabel =
      emo.arousal < 0.3 ? "low"
      : emo.arousal > 0.7 ? "high"
      : "medium";

    tagValence.textContent = `VALENCE: ${vLabel}`;
    tagArousal.textContent = `AROUSAL: ${aLabel}`;
    tagReaction.textContent = `REACTION: ${state.learningOn ? "adaptive" : "static"}`;
  }

  function updateMetrics() {
    // simple refresh without recomputing full emotion
    const emo = analyzeEmotion(state.tmHistory.map(m => m.text).join(' '));
    updateMetricsFromEmotion(emo);
  }

  function showReaction(emo, text) {
    const icon = emo.valence < -0.3 ? 'üíî'
               : emo.valence > 0.3 ? 'üíö'
               : 'üí≠';
    const label = emo.valence < -0.3 ? 'Heavy feeling noticed'
                 : emo.valence > 0.3 ? 'Warm feeling noticed'
                 : 'Balanced state';

    reactionLabel.textContent = label;
    reactionText.textContent = text.length > 120
      ? text.slice(0,120) + '‚Ä¶'
      : text;
    reactionBubble.querySelector('.reaction-icon').textContent = icon;

    reactionBubble.classList.add('visible');
    setTimeout(() => reactionBubble.classList.remove('visible'), 4500);
  }

  function maybeShowSmallReaction(text, role) {
    if (role !== 'user') return;
    if (text.length < 10) return;
    const emo = analyzeEmotion(text);
    showReaction(emo, text);
  }

  function maybeShowRecallFromBM() {
    if (!state.bmEntries.length) return;
    const last = state.bmEntries[state.bmEntries.length - 1];
    recallTitle.textContent = "Recall from BM: latest story";
    recallBody.textContent = last.summary || last.text.slice(0,160) + (last.text.length>160?'‚Ä¶':'');
    recallMeta.textContent = `Valence ${last.valence.toFixed(2)}, intensity ${(last.intensity*100).toFixed(0)}%`;
    recallBubble.classList.add('visible');
    setTimeout(() => recallBubble.classList.remove('visible'), 8000);
  }

  // ================= BM LOGIC =================
  function isSmallTalk(conv) {
    const allText = conv.messages
      .filter(m => m.role === 'user')
      .map(m => m.text)
      .join(' ')
      .trim();
    if (!allText) return true;
    if (conv.messages.length < MIN_SENT_FOR_BM) return true;

    const sentences = allText.split(/[.!?ÿåÿü]\s*/).filter(Boolean);
    if (sentences.length < MIN_SENT_FOR_BM) return true;

    // small talk patterns
    if (sentences.every(s => SMALL_TALK_REGEXES.some(r => r.test(s)))) {
      return true;
    }
    return false;
  }

  function summarizeConversation(conv) {
    const text = conv.messages.map(m =>
      (m.role === 'user' ? 'U: ' : 'A: ') + m.text
    ).join('\n');

    // lightweight summariser
    const maxLen = 700;
    let summary = text;
    if (summary.length > maxLen) summary = summary.slice(0,maxLen) + '‚Ä¶';

    return summary;
  }

  function maybePromoteConversationToBM() {
    const conv = state.currentConv;
    if (!state.learningOn) return;
    if (isSmallTalk(conv)) return;

    const summary = summarizeConversation(conv);
    const emo = analyzeEmotion(summary);

    if (conv.bmEpisodeId != null) {
      // auto-edit existing BM: replace text with richer version
      const bm = state.bmEntries.find(e => e.id === conv.bmEpisodeId);
      if (bm) {
        bm.text = summary;
        bm.summary = summary;
        bm.valence = emo.valence;
        bm.intensity = emo.intensity;
        bm.updatedAt = Date.now();
      }
    } else {
      if (state.bmEntries.length >= MAX_BM) {
        // simple decay: drop oldest unlocked
        const idx = state.bmEntries.findIndex(e => !e.locked);
        if (idx >= 0) state.bmEntries.splice(idx,1);
      }
      const entry = {
        id: state.nextBmId++,
        text: summary,
        summary,
        valence: emo.valence,
        intensity: emo.intensity,
        tags: [],
        createdAt: Date.now(),
        convId: conv.id,
        locked:false
      };
      state.bmEntries.push(entry);
      conv.bmEpisodeId = entry.id;
    }

    // close old window, start new
    state.convWindows.push(conv);
    state.currentConv = {
      id: state.nextConvId++,
      messages: [],
      createdAt: Date.now(),
      bmEpisodeId: null
    };

    refreshBMVisual();
    refreshBMModal();
    refreshConvModal();
  }

  // BM canvas visual (7 layers style)
  function refreshBMVisual() {
    const ctx = bmCanvas.getContext('2d');
    const w = bmCanvas.width = bmCanvas.clientWidth;
    const h = bmCanvas.height = bmCanvas.clientHeight;
    ctx.clearRect(0,0,w,h);

    const layers = 7;
    const active = Math.min(state.bmEntries.length, MAX_BM);
    const fillRatio = active / MAX_BM;

    for (let i=0;i<layers;i++) {
      const radius = (Math.min(w,h)/2) * (0.3 + 0.7*i/(layers-1));
      const centerY = h * 0.95;
      const centerX = w * 0.5;
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, Math.PI, 2*Math.PI);
      const alpha = 0.15 + 0.1*i + 0.4*fillRatio;
      const gradient = ctx.createLinearGradient(0,0,w,0);
      gradient.addColorStop(0, `rgba(59,130,246,${alpha})`);
      gradient.addColorStop(1, `rgba(56,189,248,${alpha})`);
      ctx.strokeStyle = gradient;
      ctx.lineWidth = 6;
      ctx.stroke();
    }

    bmStats.textContent = `Active layers: ${active}/${MAX_BM} ¬∑ System ${state.learningOn ? 'Learning' : 'Frozen'}`;
  }

  function refreshBMModal() {
    bmList.innerHTML = '';
    const query = bmSearch.value?.trim().toLowerCase() || '';
    state.bmEntries
      .filter(e => !query || e.text.toLowerCase().includes(query))
      .slice()
      .reverse()
      .forEach(entry => {
        const div = document.createElement('div');
        div.className = 'bm-item';

        const head = document.createElement('div');
        head.className = 'bm-item-header';
        const created = new Date(entry.createdAt).toLocaleString();
        head.innerHTML = `<span>ID #${entry.id}</span><span>${created}</span>`;

        const text = document.createElement('div');
        text.className = 'bm-item-text';
        text.textContent = entry.summary || entry.text;

        const badges = document.createElement('div');
        badges.className = 'bm-item-badges';
        badges.textContent = `Valence ${entry.valence.toFixed(2)} ¬∑ Intensity ${(entry.intensity*100).toFixed(0)}%`;

        const buttons = document.createElement('div');
        buttons.className = 'bm-item-buttons';

        const lockBtn = document.createElement('button');
        lockBtn.className = 'lock-pill' + (entry.locked ? ' locked':'');
        lockBtn.textContent = entry.locked ? 'üîí Locked' : 'üîì Lock';
        lockBtn.addEventListener('click', () => {
          entry.locked = !entry.locked;
          refreshBMModal();
        });

        const useBtn = document.createElement('button');
        useBtn.className = 'btn-mini';
        useBtn.textContent = 'Use as prompt';
        useBtn.addEventListener('click', () => {
          messageInput.value = entry.summary || entry.text;
          messageInput.focus();
          bmModal.classList.remove('visible');
        });

        const delBtn = document.createElement('button');
        delBtn.className = 'btn-mini btn-danger';
        delBtn.textContent = 'Delete';
        delBtn.addEventListener('click', () => {
          if (entry.locked) return;
          state.bmEntries = state.bmEntries.filter(e => e.id !== entry.id);
          refreshBMVisual();
          refreshBMModal();
        });

        buttons.appendChild(lockBtn);
        buttons.appendChild(useBtn);
        buttons.appendChild(delBtn);

        div.appendChild(head);
        div.appendChild(text);
        div.appendChild(badges);
        div.appendChild(buttons);

        bmList.appendChild(div);
      });
  }

  function refreshConvModal() {
    convList.innerHTML = '';
    const all = [...state.convWindows, state.currentConv];
    all.slice().reverse().forEach(conv => {
      if (!conv.messages.length) return;
      const div = document.createElement('div');
      div.className = 'conv-item';

      const head = document.createElement('div');
      head.className = 'conv-header';
      const created = new Date(conv.createdAt).toLocaleString();
      const label = conv.bmEpisodeId ? `Promoted to BM #${conv.bmEpisodeId}` : 'Only TM';
      head.innerHTML = `<span>Conv #${conv.id}</span><span>${created}</span><span>${label}</span>`;

      const text = document.createElement('div');
      text.className = 'conv-text';
      const preview = conv.messages.map(m => (m.role==='user'?'U: ':'A: ')+m.text).join(' | ');
      text.textContent = preview.slice(0,260) + (preview.length>260?'‚Ä¶':'');

      const controls = document.createElement('div');
      controls.className = 'conv-controls';
      const btn = document.createElement('button');
      btn.className = 'conv-btn';
      btn.textContent = 'Re-open in chat';
      btn.addEventListener('click', () => {
        messageInput.value = conv.messages
          .filter(m=>m.role==='user')
          .map(m=>m.text)
          .join('. ') + '. ';
        messageInput.focus();
        convModal.classList.remove('visible');
      });
      controls.appendChild(btn);

      div.appendChild(head);
      div.appendChild(text);
      div.appendChild(controls);
      convList.appendChild(div);
    });
  }

  // ================= MODALS =================
  bmOpenBtn.addEventListener('click', () => {
    refreshBMModal();
    bmModal.classList.add('visible');
  });
  convOpenBtn.addEventListener('click', () => {
    refreshConvModal();
    convModal.classList.add('visible');
  });
  intelButton.addEventListener('click', () => {
    intelModal.classList.add('visible');
  });
  feedSeedButton.addEventListener('click', () => {
    intelModal.classList.add('visible');
  });

  bmSearch.addEventListener('input', refreshBMModal);

  document.querySelectorAll('.modal-close').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-close');
      if (id) $(id).classList.remove('visible');
    });
  });
  [bmModal, convModal, intelModal].forEach(modal => {
    modal.addEventListener('click', e => {
      if (e.target === modal) modal.classList.remove('visible');
    });
  });

  // ================= INIT =================
  refreshBMVisual();
  updateMetrics();

})(); // end IIFE
</script>
</body>
</html>