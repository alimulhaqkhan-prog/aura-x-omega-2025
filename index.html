<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Offline LLM package (WebLLM, for in-browser models ‚Äì future ready) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root { --accent-color:#0ea5e9; }

    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px 10px;
    }

    .app{
      width:min(980px,98vw);
      background:rgba(2,6,23,.45);
      border:1px solid rgba(148,163,184,.18);
      border-radius:22px;
      overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
    }

    .top{
      padding:20px 18px 10px;
      border-bottom:1px solid rgba(148,163,184,.14);
      text-align:center;
      position:relative;
    }

    .brand{
      font-weight:800;
      letter-spacing:.5px;
      font-size:26px;
      color:#7dd3fc;
      text-shadow:0 0 22px rgba(14,165,233,.28);
    }

    .sub{
      opacity:.8;
      margin-top:2px;
      font-size:13px;
    }

    .ethic{
      margin:14px auto 12px;
      max-width:720px;
      border:1px solid rgba(251,191,36,.35);
      border-radius:14px;
      padding:10px 36px 9px 14px;
      color:#fbbf24;
      background:rgba(2,6,23,.35);
      box-shadow:inset 0 0 0 1px rgba(251,191,36,.08);
      font-size:14px;
      line-height:1.4;
      position:relative;
      overflow:hidden;
      transition:background .4s ease,border-color .4s ease,transform .4s ease,box-shadow .4s ease;
    }
    .ethicMain{font-weight:600;}
    .ethicMeta{
      font-size:11px;
      opacity:.8;
      margin-top:2px;
      display:none;
    }
    .ethic.ethicPulse{ animation:ethicPulse 1.1s ease; }
    @keyframes ethicPulse{
      0%{box-shadow:0 0 0 0 rgba(251,191,36,.55);transform:translateY(0);}
      45%{box-shadow:0 0 0 16px rgba(251,191,36,0);transform:translateY(-1px);}
      100%{box-shadow:0 0 0 0 rgba(251,191,36,0);transform:translateY(0);}
    }

    .faithCfgBtn{
      position:absolute;
      right:6px;
      top:4px;
      border:none;
      background:transparent;
      color:#fde68a;
      cursor:pointer;
      font-size:16px;
      line-height:1;
      display:none;
      -webkit-tap-highlight-color:transparent;
    }
    .faithCfgBtn.show{display:inline-flex;}

    .pill{
      margin:10px auto 0;
      max-width:760px;
      background:linear-gradient(90deg, rgba(14,165,233,.65), rgba(34,211,238,.45));
      border:1px solid rgba(125,211,252,.30);
      color:#0b1220;
      font-weight:800;
      letter-spacing:.6px;
      border-radius:999px;
      padding:14px 16px;
      text-transform:uppercase;
      box-shadow:0 12px 40px rgba(14,165,233,.22);
      position:relative;
    }
    .pill.faithGlow{
      border-color:rgba(251,191,36,.9);
      box-shadow:0 0 26px rgba(251,191,36,.75);
      background:linear-gradient(90deg, rgba(14,165,233,.6), rgba(251,191,36,.9));
    }

    .main{ padding:16px 16px 18px }
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:stretch}
    .leftCol{ flex:1 1 340px; min-width:300px }
    .rightCol{ flex:1 1 360px; min-width:320px }

    .card{
      background:rgba(2,6,23,.50);
      border:1px solid rgba(148,163,184,.16);
      border-radius:18px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      backdrop-filter:blur(10px);
    }

    .optionsBtn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(15,23,42,.55);
      color:#e5e7eb;
      cursor:pointer;
      user-select:none;
      margin:12px 0;
      -webkit-tap-highlight-color:transparent;
    }
    .optionsBtn:active{transform:scale(.99)}
    .gear{width:18px;height:18px;filter:drop-shadow(0 0 10px rgba(125,211,252,.25))}

    .console{
      margin-top:12px;
      height:230px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(0,0,0,.25);
      padding:14px;
      overflow:auto;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:14px;
      box-shadow:inset 0 0 0 1px rgba(125,211,252,.06);
      line-height:1.55;
      white-space:pre-wrap;
    }
    .line{display:block;margin:2px 0}
    .line.user{color:#a5b4fc;}
    .line.aura{color:#bbf7d0;}
    .line.sys{color:#fbbf24;font-size:12px;}

    .optionsMenu{
      position:fixed;
      left:12px;
      right:12px;
      top:120px;
      margin:0 auto;
      max-width:940px;
      background:rgba(2,6,23,.92);
      border:1px solid rgba(148,163,184,.18);
      border-radius:16px;
      padding:8px;
      display:none;
      z-index:9999;
      box-shadow:0 18px 45px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
      align-items:stretch;
    }
    .optionsMenu.show{display:grid}

    .menuItem{
      padding:8px 6px;
      border-radius:13px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:6px;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.10);
      background:rgba(15,23,42,.55);
      user-select:none;
      min-height:58px;
    }
    .menuItem:active{transform:scale(.995)}

    /* Injected (v4.9): keep Sense tile below BM Recall so it doesn't cover other buttons */
    #optionsMenu #miSense{
      grid-column: 2;
      grid-row: 4;
    }

    .menuLeft{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-weight:800;
      font-size:12.5px;
    }
    .menuIcon{
      width:18px;
      height:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .menuRight{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:44px;
    }
    .pillOn,.pillOff,.pillMid{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      font-weight:900;
      text-transform:lowercase;
      border:1px solid transparent;
    }
    .pillOn{
      background:rgba(34,197,94,.18);
      border-color:rgba(34,197,94,.24);
      color:#bbf7d0;
    }
    .pillOff{
      background:rgba(239,68,68,.12);
      border-color:rgba(239,68,68,.22);
      color:#fecaca;
    }
    .pillMid{
      background:rgba(14,165,233,.14);
      border-color:rgba(14,165,233,.20);
      color:#bae6fd;
      opacity:.95;
    }

    .chatWrap{
      margin-top:0;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.45);
    }

    .reactionBar{
      margin-top:0;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      font-size:18px;
      opacity:.9;
    }
    .reactBtn{
      border:none;
      background:transparent;
      cursor:pointer;
      padding:4px;
      line-height:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      -webkit-tap-highlight-color:transparent;
    }
    .reactBtn:active{transform:scale(.9)}

    .liveCapsule{
      margin:4px 0 10px;
      width:100%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      padding:8px 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:12px;
      color:#dbeafe;
      box-shadow:inset 0 0 0 1px rgba(125,211,252,.06);
    }
    .liveCapsule b{ color:#7dd3fc; font-weight:900 }

    .faithBubble{
      margin:4px 0 10px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(251,191,36,.16);
      border:1px solid rgba(251,191,36,.4);
      display:none;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:#facc15;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      transition:opacity .25s ease, transform .25s ease;
      width:100%;
    }
    .faithBubble.show{
      display:flex;
      opacity:1;
      transform:translateY(0);
    }
    .fbIcon{font-size:18px;}
    .fbText{flex:1;line-height:1.3;}
    .fbTitle{font-weight:800;}
    .fbMeta{opacity:.85;}
    .fbClose{
      border:none;
      background:transparent;
      color:#fed7aa;
      font-size:16px;
      cursor:pointer;
      padding:0 4px;
      line-height:1;
    }

    .inputRow{display:flex;gap:10px;align-items:flex-end}
    .input{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      padding:12px 14px;
      outline:none;
      font-size:14px;
    }
    .send{
      border:none;
      border-radius:999px;
      background:linear-gradient(90deg, var(--accent-color, #0ea5e9), rgba(34,211,238,.55));
      color:#0b1220;
      font-weight:900;
      padding:12px 18px;
      cursor:pointer;
      min-width:88px;
      box-shadow:0 12px 30px rgba(14,165,233,.18);
      -webkit-tap-highlight-color:transparent;
    }
    .send:active{transform:scale(.99)}

    .formula{
      margin-top:10px;
      opacity:.8;
      font-size:12px;
      text-align:center;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      color:#dbeafe;
    }

    .toastBubble{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translate(-50%,10px);
      padding:6px 14px;
      border-radius:999px;
      background:rgba(15,23,42,.95);
      color:#e5e7eb;
      font-size:12px;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:0 12px 30px rgba(0,0,0,.5);
      opacity:0;
      pointer-events:none;
      z-index:10000;
      transition:opacity .18s ease, transform .18s ease;
    }
    .toastBubble.show{
      opacity:1;
      transform:translate(-50%,0);
    }

    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:18px 12px;
      z-index:9999;
    }
    .modalOverlay.show{display:flex}

    .modal{
      width:min(860px,96vw);
      border-radius:18px;
      overflow:hidden;
      background:rgba(250,250,250,.93);
      color:#0b1220;
      border:1px solid rgba(15,23,42,.18);
      box-shadow:0 30px 80px rgba(0,0,0,.35);
      backdrop-filter:blur(12px);
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      background:rgba(255,255,255,.75);
      border-bottom:1px solid rgba(15,23,42,.10);
      font-weight:800;
    }
    .modalHeader small{font-weight:600;opacity:.7}

    .closeX{
      border:none;
      background:transparent;
      font-size:22px;
      cursor:pointer;
      line-height:1;
      padding:0 4px;
      opacity:.75;
    }

    .modalBody{
      padding:14px;
      max-height:70vh;
      overflow:auto;
    }

    /* ... (continues in Part 2/4) ... */
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="brand">AURA-X Œ©</div>
      <div class="sub">
        Offline emotional continuity engine (prototype)<br>
        TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory.
      </div>

      <div class="ethic" id="ethicBox">
        <div class="ethicMain" id="ethicMain">
          Universal ethic: avoid actions that grow negative emotions in you or others.
          Move gently toward choices that increase shared positive feeling for everyone.
        </div>
        <div class="ethicMeta" id="ethicMeta"></div>
        <button id="faithCfgBtn" class="faithCfgBtn" title="Faith live bar settings">üîò</button>
      </div>

      <div class="pill">EMOTIONAL CONTINUITY ENGINE ‚Äî ACTIVE</div>
    </div>

    <div class="main">
      <div class="row">
        <!-- LEFT -->
        <div class="leftCol">
          <div class="card">
            <div class="optionsBtn" id="btnOptions">
              <svg class="gear" viewBox="0 0 24 24" fill="none">
                <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"
                      stroke="#7dd3fc" stroke-width="2"/>
                <path d="M19.4 15a8.2 8.2 0 0 0 .1-2l2-1.5-2-3.5-2.4 1a8.5 8.5 0 0 0-1.7-1l-.4-2.6h-4l-.4 2.6a8.5 8.5 0 0 0-1.7 1l-2.4-1-2 3.5 2 1.5a8.2 8.2 0 0 0 .1 2L2.7 16.5l2 3.5 2.4-1a8.5 8.5 0 0 0 1.7 1l.4 2.6h4l.4-2.6a8.5 8.5 0 0 0 1.7-1l2.4 1 2-3.5L19.4 15Z"
                      stroke="#7dd3fc" stroke-width="1.6" opacity=".9"/>
              </svg>
              <span>Options</span>
            </div>

            <div class="optionsMenu" id="optionsMenu">
              <div class="menuItem" id="miVoice">
                <div class="menuLeft"><span class="menuIcon">üé§</span><span>Voice</span></div>
                <div class="menuRight"><span class="pillOff" id="voicePill">off</span></div>
              </div>
              <div class="menuItem" id="miIntel">
                <div class="menuLeft"><span class="menuIcon">üß†</span><span>Intelligence</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miLearn">
                <div class="menuLeft"><span class="menuIcon">üìö</span><span>Learning</span></div>
                <div class="menuRight"><span class="pillOn" id="learnPill">on</span></div>
              </div>
              <div class="menuItem" id="miSeed">
                <div class="menuLeft"><span class="menuIcon">üå±</span><span>Feed</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miFaith">
                <div class="menuLeft"><span class="menuIcon">üïä</span><span>Faith</span></div>
                <div class="menuRight"><span class="pillOff" id="faithLabel">none</span></div>
              </div>
              <div class="menuItem" id="miIdentity">
                <div class="menuLeft"><span class="menuIcon">ü™™</span><span>Identity</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miLLM">
                <div class="menuLeft"><span class="menuIcon">ü§ñ</span><span>LLM</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miBMRecall">
                <div class="menuLeft"><span class="menuIcon">üìò</span><span>BM Recall</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miHistory">
                <div class="menuLeft"><span class="menuIcon">üìú</span><span>History</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miSense">
                <div class="menuLeft"><span class="menuIcon">üëÅÔ∏è</span><span>Sense</span></div>
                <div class="menuRight"><span class="pillMid" id="sensePill">idle</span></div>
              </div>
            </div>

            <div class="console" id="console"></div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="rightCol">
          <div class="chatWrap">
            <div class="reactionBar" id="reactionBar">
              <button class="reactBtn" id="btnLikeLast" title="Save to Intelligence (like)">üëç</button>
              <button class="reactBtn" id="btnDislikeLast" title="Mark incorrect & teach new answer">üëé</button>
              <button class="reactBtn" id="btnSpeakLast" title="Play voice for last answer">üîä</button>
              <button class="reactBtn" id="btnShareLast" title="Copy question + answer">üîó</button>
            </div>

            <div class="liveCapsule">
              <span><b>E0</b>: <span id="cE0">0.000</span></span><span>¬∑</span>
              <span><b>TM</b>: <span id="cTM">0.00</span></span><span>¬∑</span>
              <span><b>BM</b>: <span id="cBM">0.00</span></span><span>¬∑</span>
              <span><b>C</b>: <span id="cCont">0.850</span></span>
            </div>

            <div class="faithBubble" id="faithBubble">
              <div class="fbIcon">üí≠</div>
              <div class="fbText">
                <div class="fbTitle" id="faithBubbleTitle">Faith reflection bubble</div>
                <div class="fbMeta" id="faithBubbleMeta">Tap to see a short suggestion.</div>
              </div>
              <button class="fbClose" id="faithBubbleClose">√ó</button>
            </div>

            <div class="inputRow">
              <label class="reactBtn" style="cursor:pointer;margin-bottom:12px;">
                üì∑
                <input type="file" id="visionInput" accept="image/*" style="display:none">
              </label>
              <input class="input" id="userInput" placeholder="Talk to AURA-X Œ©‚Ä¶ (TM = your inputs)" />
              <button class="send" id="sendBtn">Send</button>
            </div>

            <div id="imagePreviewArea" style="display:none;margin:6px 2px 2px;text-align:center;font-size:10px;opacity:.8;">
              <img id="imgPrev" alt="preview" style="max-height:90px;border-radius:10px;border:2px solid var(--accent-color);margin-bottom:2px;">
              <div>Image attached for analysis</div>
            </div>

            <div class="formula">
              E‚ÇÄ = tanh( R(TM,BM) + I(TM) + I<sub>intel</sub> + I<sub>LLM</sub> ‚àí D + Œª<sub>faith</sub> + Œª<sub>sys</sub> + Œª<sub>trc</sub> )
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dream overlay + other modals continue in Part 2/4 -->
<!-- Dream overlay -->
  <div id="dreamOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9500;backdrop-filter:blur(16px);">
    <canvas id="dreamCanvas" style="position:absolute;inset:0;width:100%;height:100%;"></canvas>

    <!-- Dream intro UI (auto-hides) -->
    <div id="dreamIntro" style="position:relative;z-index:2;text-align:center;padding:18px 16px;max-width:620px;">
      <div style="width:120px;height:120px;border-radius:999px;margin:0 auto 14px;
        background:radial-gradient(circle at 30% 20%, #ffffff, #7dd3fc 40%, transparent 70%);
        border:2px solid rgba(125,211,252,.9);
        box-shadow:0 0 40px rgba(56,189,248,.8);
        animation:dreamPulse 3.5s ease-in-out infinite;"></div>
      <div style="font-weight:900;font-size:18px;color:#e0f2fe;">AURA-X Œ© ¬∑ Dreaming‚Ä¶</div>
      <div style="margin-top:6px;font-size:13px;color:#bae6fd;opacity:.95;">
        Fantasy clouds + aurora ribbons. Tap anywhere to wake.
      </div>
      <div id="dreamMetaText" style="margin-top:6px;font-size:11px;color:#93c5fd;opacity:.9;"></div>
    </div>

    <!-- Minimal BM label (no story text here to avoid overlap) -->
    <div id="bmGlimpseLabel" style="position:absolute;left:50%;bottom:12%;
      transform:translateX(-50%);z-index:2;
      padding:6px 12px;border-radius:999px;
      background:rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.22);
      color:#e5e7eb;font-size:12px;display:none;">
      BM glimpse (0%)
    </div>
  </div>

  <!-- Toast bubble -->
  <div class="toastBubble" id="toastBubble"></div>

  <!-- Sense (Camera + Mic) -->
  <div class="modalOverlay" id="modalSense">
    <div class="modal">
      <div class="modalHeader">
        <div>üëÅÔ∏è Sense (Camera + Mic)<br><small>Capture a moment ‚Üí create a BM prompt stub (local only).</small></div>
        <button class="closeX" data-close="modalSense">√ó</button>
      </div>
      <div class="modalBody" style="background:#fefce8;">
        <div style="opacity:.85;font-size:13px;line-height:1.35;margin-bottom:10px">
          Uses your device camera/microphone only with permission. Nothing is uploaded in this prototype.
          A developer can later plug a Vision / Speech-to-text API to analyse the real content.
        </div>

        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px">
          <button class="btn btnBlue" id="btnSenseCamera">Camera snapshot</button>
          <button class="btn btnBlue" id="btnSenseMic">Record 10s audio</button>
          <span style="font-size:12px;opacity:.75;align-self:center" id="senseStatus">Idle.</span>
        </div>

        <video id="senseVideo" autoplay playsinline muted
               style="width:100%;max-height:190px;border-radius:14px;border:1px solid rgba(15,23,42,.18);display:none;margin-bottom:8px;background:#000"></video>
        <canvas id="senseCanvas" style="display:none"></canvas>

        <textarea id="senseBMBox"
          style="width:100%;min-height:160px;border-radius:14px;border:1px solid rgba(15,23,42,.18);padding:10px;font-size:13px;line-height:1.4;background:#fff;"
          placeholder="Sense ‚Üí BM prompt stub will appear here‚Ä¶ You can edit before saving."></textarea>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn btnGreen" id="btnSaveSenseBM">Save stub to BM</button>
        </div>

        <div style="margin-top:10px;font-size:11px;opacity:.72;">
          ‚ö†Ô∏è Please respect privacy and local law. Do not record people without consent.
          This demo does not send media to any server unless you connect your own endpoint in LLM settings.
        </div>
      </div>
    </div>
  </div>

  <!-- (All other modals / UI continue; scripts start in Part 3/4) -->

  <style>
    @keyframes dreamPulse{
      0%{transform:translateY(0) scale(1);}
      50%{transform:translateY(-6px) scale(1.03);}
      100%{transform:translateY(0) scale(1);}
    }
  </style>
<script>
/* ==========================================================
   AURA-X Œ© v4.9 (base) + Injected: Dream Screensaver + Intuition
   Fixes applied:
   1) renderBmFilm definition fixed
   2) resize listener fixed
   3) intuitionCaptureOnce canvas ref fixed (use 'c')
   ========================================================== */

const KEY_INT = "aurax_intelligence_v1";
const KEY_BM = "aurax_bm_v1";
const KEY_CFG = "aurax_cfg_v14";
const KEY_HISTORY = "aurax_history_v1";
const KEY_SEED = "aurax_seed_v1";
const KEY_IDENTITY = "aurax_identity_v1";
const KEY_FAITH = "aurax_faith_text_v1";
const KEY_INTUITION = "aurax_intuition_v1";

const INTUITION_INTERVAL_MS = 7*24*60*60*1000;

function safeLoadJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return fallback;
    return JSON.parse(raw);
  }catch(e){
    console.warn("JSON load failed", key, e);
    return fallback;
  }
}

function nowTs(){ return Date.now(); }

function showToast(msg){
  const el = document.getElementById("toastBubble");
  if(!el) return;
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), 2200);
}

function logLine(role, text){
  const consoleEl = document.getElementById("console");
  if(!consoleEl) return;
  const span = document.createElement("span");
  span.className = "line " + role;
  span.textContent = "["+role.toUpperCase()+"] " + text;
  consoleEl.appendChild(span);
  consoleEl.appendChild(document.createElement("br"));
  consoleEl.scrollTop = consoleEl.scrollHeight;
}

const state = {
  metrics: { TM:0, BM:0, C:0.85, E0:0 },
  intelligence: [],
  bmPrompts: [],
  history: [],
  parsedSeed: [],
  editingIntelId: null,
  selectedBMId: null,
  lastAnswerText: "",
  voiceOn: false,
  learningOn: true,
  apiConfig: { endpoint:"", model:"", key:"" },
  dreamEnabled: true,
  dreamDelayMs: 60000,
  lastActivityTs: nowTs(),
  dreamTimerId: null,

  // Dream FX state
  dreamFX: {
    running:false,
    canvas:null,
    ctx:null,
    w:0,
    h:0,
    t0:0,
    particles:[],
    ribbons:[],
    sparkles:[],
    bmQueue:[],
    bmIndex:0,
    lastGlimpseTs:0,
    introHideTs:0,
    intensityThreshold: 0.72,
    glimpseEveryMs: 14000,
    filmAlpha: 0,
    filmText: "",
    filmPct: 0
  },

  // Intuition (OFF by default)
  intuition: {
    enabled:false,
    lastRun: 0,
    samples:[]
  },

  sense: { stream:null, mediaRecorder:null, chunks:[], busy:false }
};

const els = {
  userInput: document.getElementById("userInput"),
  sendBtn: document.getElementById("sendBtn"),
  optionsMenu: document.getElementById("optionsMenu"),
  btnOptions: document.getElementById("btnOptions"),

  miVoice: document.getElementById("miVoice"),
  miIntel: document.getElementById("miIntel"),
  miLearn: document.getElementById("miLearn"),
  miSeed: document.getElementById("miSeed"),
  miFaith: document.getElementById("miFaith"),
  miIdentity: document.getElementById("miIdentity"),
  miLLM: document.getElementById("miLLM"),
  miBMRecall: document.getElementById("miBMRecall"),
  miHistory: document.getElementById("miHistory"),
  miSense: document.getElementById("miSense"),

  voicePill: document.getElementById("voicePill"),
  learnPill: document.getElementById("learnPill"),

  cE0: document.getElementById("cE0"),
  cTM: document.getElementById("cTM"),
  cBM: document.getElementById("cBM"),
  cCont: document.getElementById("cCont"),

  // Dream
  dreamOverlay: document.getElementById("dreamOverlay"),
  dreamCanvas: document.getElementById("dreamCanvas"),
  dreamIntro: document.getElementById("dreamIntro"),
  dreamMetaText: document.getElementById("dreamMetaText"),
  bmGlimpseLabel: document.getElementById("bmGlimpseLabel"),

  // Sense
  modalSense: document.getElementById("modalSense"),
  btnSenseCamera: document.getElementById("btnSenseCamera"),
  btnSenseMic: document.getElementById("btnSenseMic"),
  senseVideo: document.getElementById("senseVideo"),
  senseCanvas: document.getElementById("senseCanvas"),
  senseStatus: document.getElementById("senseStatus"),
  senseBMBox: document.getElementById("senseBMBox"),
  btnSaveSenseBM: document.getElementById("btnSaveSenseBM"),
};

function saveCfg(){
  const cfg = safeLoadJSON(KEY_CFG, {});
  cfg.voiceOn = state.voiceOn;
  cfg.learningOn = state.learningOn;
  cfg.apiConfig = state.apiConfig;
  cfg.dream = { enabled: state.dreamEnabled, delayMs: state.dreamDelayMs };
  localStorage.setItem(KEY_CFG, JSON.stringify(cfg));
}

function loadCfg(){
  const cfg = safeLoadJSON(KEY_CFG, null);
  if(!cfg) return;
  state.voiceOn = !!cfg.voiceOn;
  state.learningOn = !!cfg.learningOn;
  state.apiConfig = cfg.apiConfig || state.apiConfig;
  if(cfg.dream){
    state.dreamEnabled = !!cfg.dream.enabled;
    state.dreamDelayMs = cfg.dream.delayMs || state.dreamDelayMs;
  }
  // intuition
  const intu = safeLoadJSON(KEY_INTUITION, null);
  if(intu){
    state.intuition.lastRun = intu.lastRun || 0;
    state.intuition.samples = Array.isArray(intu.samples) ? intu.samples : [];
  }
}

function updateCapsule(){
  if(els.cTM) els.cTM.textContent = state.metrics.TM.toFixed(2);
  if(els.cBM) els.cBM.textContent = state.metrics.BM.toFixed(2);
  if(els.cCont) els.cCont.textContent = state.metrics.C.toFixed(3);
  if(els.cE0) els.cE0.textContent = state.metrics.E0.toFixed(3);
}

function recomputeTMMetric(){
  const h = state.history;
  if(!h.length){ state.metrics.TM = 0; return; }
  const lastUser = [...h].reverse().find(x=>x.role==="user");
  const len = lastUser ? (lastUser.text||"").length : 0;
  state.metrics.TM = Math.min(len/400, 1.5);
}

function recomputeBMMetric(){
  const locked = state.bmPrompts.filter(b=>b.locked);
  state.metrics.BM = Math.min(locked.length / 12, 1.6);
}

function recomputeE0(){
  const m = state.metrics;
  const R = m.TM*0.9 + m.BM*1.1;
  const I_TM = m.TM*0.5;
  const D = state.history.length > 40 ? 0.5 : 0.0;
  const lambda_sys = 0.1;
  const lambda_trc = 0.15;
  const raw = R + I_TM - D + lambda_sys + lambda_trc;
  state.metrics.E0 = Math.tanh(raw);
  updateCapsule();
}

function saveHistory(){
  localStorage.setItem(KEY_HISTORY, JSON.stringify(state.history));
}

function addHistory(role, text){
  state.history.push({ role, text, ts: nowTs() });
  if(state.history.length > 200) state.history.shift();
  saveHistory();
  recomputeTMMetric();
  recomputeE0();
}

function loadHistory(){
  const data = safeLoadJSON(KEY_HISTORY, []);
  state.history = Array.isArray(data) ? data : [];
  recomputeTMMetric();
  recomputeE0();
}

function saveBM(){
  localStorage.setItem(KEY_BM, JSON.stringify(state.bmPrompts));
  recomputeBMMetric();
  recomputeE0();
}

function loadBM(){
  const data = safeLoadJSON(KEY_BM, []);
  state.bmPrompts = Array.isArray(data) ? data : [];
  recomputeBMMetric();
}

function scheduleDreamTimer(){
  state.lastActivityTs = nowTs();
  if(state.dreamTimerId){ clearTimeout(state.dreamTimerId); state.dreamTimerId = null; }
  if(!state.dreamEnabled) return;
  state.dreamTimerId = setTimeout(()=>{ startDream(); }, state.dreamDelayMs);
  maybeRunWeeklyIntuition();
}

function registerActivity(){
  // if dream overlay visible, ignore
  if(els.dreamOverlay && els.dreamOverlay.style.display === "flex") return;
  scheduleDreamTimer();
}

/* ===================== Dream FX ===================== */

function initDreamCanvasSize(){
  const c = els.dreamCanvas;
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  state.dreamFX.w = Math.floor(window.innerWidth * dpr);
  state.dreamFX.h = Math.floor(window.innerHeight * dpr);
  c.width = state.dreamFX.w;
  c.height = state.dreamFX.h;
  c.style.width = "100%";
  c.style.height = "100%";
}

function rnd(a,b){ return a + Math.random()*(b-a); }

function initDreamParticles(){
  const fx = state.dreamFX;
  fx.particles = [];
  fx.ribbons = [];
  fx.sparkles = [];

  const nCloud = Math.floor((fx.w*fx.h)/(900*900) * 22) + 18;
  for(let i=0;i<nCloud;i++){
    fx.particles.push({
      x:rnd(-fx.w*0.2, fx.w*1.2),
      y:rnd(-fx.h*0.2, fx.h*1.2),
      r:rnd(fx.w*0.08, fx.w*0.22),
      vx:rnd(-0.08, 0.18),
      vy:rnd(-0.03, 0.06),
      a:rnd(0.05, 0.18),
      hue:rnd(180, 330),
      sat:rnd(35, 85),
      lum:rnd(35, 80)
    });
  }

  const nRibbon = 6;
  for(let i=0;i<nRibbon;i++){
    fx.ribbons.push({
      phase:rnd(0,Math.PI*2),
      speed:rnd(0.0006,0.0012),
      y0:rnd(0.18,0.82),
      amp:rnd(0.06,0.14),
      width:rnd(0.05,0.12),
      hue:rnd(160, 320),
      alpha:rnd(0.06, 0.16)
    });
  }

  const nSpark = 120;
  for(let i=0;i<nSpark;i++){
    fx.sparkles.push({
      x:rnd(0,fx.w),
      y:rnd(0,fx.h),
      s:rnd(0.5,2.2),
      vx:rnd(-0.08,0.08),
      vy:rnd(-0.10,0.10),
      a:rnd(0.06,0.22),
      tw:rnd(0.003,0.010),
      hue:rnd(180, 340)
    });
  }
}

function buildBmQueue(){
  const locked = state.bmPrompts.filter(b=>b.locked && (b.text||"").trim().length>0);
  const seq = locked.map(b=>{
    const t = (b.text||"").trim();
    const forced = /intensity\s*:\s*(0?\.\d+|1(\.0+)?)\b/i.exec(t);
    let intensity = forced ? Math.min(1, Math.max(0, parseFloat(forced[1]))) : Math.min(1, t.length/260);
    return { text:t, intensity:intensity };
  }).filter(x=>x.intensity >= state.dreamFX.intensityThreshold);

  state.dreamFX.bmQueue = seq.length ? seq : [];
  state.dreamFX.bmIndex = 0;
}

function drawBackground(ctx, w, h, t){
  // deep gradient
  const g = ctx.createLinearGradient(0,0,w,h);
  g.addColorStop(0, "rgba(2,6,23,0.98)");
  g.addColorStop(0.35, "rgba(2,24,60,0.98)");
  g.addColorStop(0.7, "rgba(3,42,70,0.98)");
  g.addColorStop(1, "rgba(2,6,23,0.98)");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,w,h);

  // faint orb glow
  const cx = w*0.52, cy = h*0.34;
  const r = Math.min(w,h)*0.42;
  const og = ctx.createRadialGradient(cx,cy,0,cx,cy,r);
  og.addColorStop(0, "rgba(125,211,252,0.10)");
  og.addColorStop(0.4, "rgba(34,211,238,0.07)");
  og.addColorStop(1, "rgba(2,6,23,0)");
  ctx.fillStyle = og;
  ctx.fillRect(0,0,w,h);
}

function drawClouds(ctx, w, h, t){
  const fx = state.dreamFX;
  for(const p of fx.particles){
    p.x += p.vx;
    p.y += p.vy;
    if(p.x > w*1.25) p.x = -w*0.25;
    if(p.x < -w*0.3) p.x = w*1.2;
    if(p.y > h*1.25) p.y = -h*0.25;
    if(p.y < -h*0.3) p.y = h*1.2;

    const rr = p.r * (0.92 + 0.08*Math.sin(t*0.0007 + p.x*0.00002));
    const cg = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,rr);
    cg.addColorStop(0, `hsla(${p.hue},${p.sat}%,${p.lum}%,${p.a})`);
    cg.addColorStop(0.55, `hsla(${p.hue+20},${p.sat}%,${Math.max(10,p.lum-20)}%,${p.a*0.6})`);
    cg.addColorStop(1, "rgba(2,6,23,0)");
    ctx.fillStyle = cg;
    ctx.beginPath();
    ctx.arc(p.x,p.y,rr,0,Math.PI*2);
    ctx.fill();
  }
}

function drawAurora(ctx, w, h, t){
  const fx = state.dreamFX;
  for(const r of fx.ribbons){
    const tt = t*r.speed + r.phase;
    const yBase = h * r.y0 + Math.sin(tt)*h*r.amp;
    const amp = h*r.amp;
    const thickness = h*r.width;

    ctx.beginPath();
    const x0 = -w*0.05;
    ctx.moveTo(x0, yBase);
    for(let x=0; x<=w*1.05; x += w/16){
      const yy = yBase + Math.sin(tt + x*0.0009)*amp + Math.sin(tt*1.7 + x*0.0014)*amp*0.35;
      ctx.lineTo(x, yy);
    }
    ctx.lineTo(w*1.05, yBase+thickness);
    ctx.lineTo(x0, yBase+thickness);
    ctx.closePath();

    const ag = ctx.createLinearGradient(0, yBase-thickness, 0, yBase+thickness*2);
    ag.addColorStop(0, `hsla(${r.hue}, 95%, 70%, 0)`);
    ag.addColorStop(0.35, `hsla(${r.hue}, 95%, 70%, ${r.alpha})`);
    ag.addColorStop(0.75, `hsla(${r.hue+30}, 95%, 60%, ${r.alpha*0.8})`);
    ag.addColorStop(1, `hsla(${r.hue+40}, 95%, 60%, 0)`);
    ctx.fillStyle = ag;
    ctx.fill();
  }
}

function drawSparkles(ctx, w, h, t){
  const fx = state.dreamFX;
  for(const s of fx.sparkles){
    s.x += s.vx;
    s.y += s.vy;
    if(s.x<0) s.x += w;
    if(s.x>w) s.x -= w;
    if(s.y<0) s.y += h;
    if(s.y>h) s.y -= h;

    const tw = 0.5 + 0.5*Math.sin(t*s.tw + s.x*0.01);
    ctx.fillStyle = `hsla(${s.hue},90%,80%,${s.a*tw})`;
    ctx.beginPath();
    ctx.arc(s.x,s.y,s.s*tw,0,Math.PI*2);
    ctx.fill();
  }
}

/* FIX #1: renderBmFilm definition corrected */
function renderBmFilm(text, now){
  const fx = state.dreamFX;
  const ctx = fx.ctx;
  const w = fx.w, h = fx.h;
  if(!text) return;

  // film card in center with feather edges (no hard rectangle)
  const boxW = Math.min(w*0.78, 920*(window.devicePixelRatio||1));
  const boxH = Math.min(h*0.24, 260*(window.devicePixelRatio||1));
  const x = (w-boxW)/2;
  const y = h*0.52 - boxH/2;

  // feather mask
  ctx.save();
  ctx.globalAlpha = fx.filmAlpha;
  ctx.beginPath();
  const r = 34*(window.devicePixelRatio||1);
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+boxW,y,x+boxW,y+boxH,r);
  ctx.arcTo(x+boxW,y+boxH,x,y+boxH,r);
  ctx.arcTo(x,y+boxH,x,y,r);
  ctx.arcTo(x,y,x+boxW,y,r);
  ctx.closePath();
  ctx.clip();

  // background blur-ish glow
  const bg = ctx.createRadialGradient(x+boxW*0.3,y+boxH*0.3, 0, x+boxW*0.5,y+boxH*0.5, boxW*0.8);
  bg.addColorStop(0, "rgba(255,255,255,0.18)");
  bg.addColorStop(0.5, "rgba(125,211,252,0.10)");
  bg.addColorStop(1, "rgba(2,6,23,0)");
  ctx.fillStyle = bg;
  ctx.fillRect(x,y,boxW,boxH);

  // add soft fog overlay
  const fog = ctx.createLinearGradient(x,y,x+boxW,y+boxH);
  fog.addColorStop(0, "rgba(15,23,42,0.28)");
  fog.addColorStop(0.5, "rgba(15,23,42,0.18)");
  fog.addColorStop(1, "rgba(15,23,42,0.30)");
  ctx.fillStyle = fog;
  ctx.fillRect(x,y,boxW,boxH);

  // feather edges by drawing large transparent gradients
  const feather = 56*(window.devicePixelRatio||1);
  function featherEdge(px,py,pw,ph,dir){
    let g;
    if(dir==="top"){
      g = ctx.createLinearGradient(px,py,px,py+feather);
    }else if(dir==="bottom"){
      g = ctx.createLinearGradient(px,py+ph-feather,px,py+ph);
    }else if(dir==="left"){
      g = ctx.createLinearGradient(px,py,px+feather,py);
    }else{
      g = ctx.createLinearGradient(px+pw-feather,py,px+pw,py);
    }
    g.addColorStop(0, "rgba(2,6,23,0.85)");
    g.addColorStop(1, "rgba(2,6,23,0)");
    ctx.fillStyle = g;
    if(dir==="top") ctx.fillRect(px,py,pw,feather);
    if(dir==="bottom") ctx.fillRect(px,py+ph-feather,pw,feather);
    if(dir==="left") ctx.fillRect(px,py,feather,ph);
    if(dir==="right") ctx.fillRect(px+pw-feather,py,feather,ph);
  }
  featherEdge(x,y,boxW,boxH,"top");
  featherEdge(x,y,boxW,boxH,"bottom");
  featherEdge(x,y,boxW,boxH,"left");
  featherEdge(x,y,boxW,boxH,"right");

  // text
  ctx.fillStyle = "rgba(255,255,255,0.92)";
  ctx.font = `${Math.round(18*(window.devicePixelRatio||1))}px ui-sans-serif, system-ui`;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";

  const lines = wrapTextLines(ctx, text, boxW*0.86);
  const maxLines = 5;
  const clipped = lines.slice(0,maxLines);
  const lineH = 24*(window.devicePixelRatio||1);
  const startY = y + boxH/2 - (clipped.length-1)*lineH/2;

  clipped.forEach((ln,i)=>{
    ctx.fillText(ln, x+boxW/2, startY + i*lineH);
  });

  ctx.restore();
}

function wrapTextLines(ctx, text, maxWidth){
  const words = (text||"").replace(/\s+/g," ").trim().split(" ");
  const lines = [];
  let line = "";
  for(const w of words){
    const test = line ? (line + " " + w) : w;
    if(ctx.measureText(test).width <= maxWidth){
      line = test;
    }else{
      if(line) lines.push(line);
      line = w;
    }
  }
  if(line) lines.push(line);
  return lines;
}

function tickDream(now){
  const fx = state.dreamFX;
  if(!fx.running) return;
  const ctx = fx.ctx;
  const w = fx.w, h = fx.h;

  drawBackground(ctx, w, h, now);
  drawAurora(ctx, w, h, now);
  drawClouds(ctx, w, h, now);
  drawSparkles(ctx, w, h, now);

  // intro hide after ~950ms
  if(els.dreamIntro){
    if(now - fx.introHideTs > 950){
      els.dreamIntro.style.display = "none";
    }else{
      els.dreamIntro.style.display = "block";
    }
  }

  // BM glimpses (after intro)
  const afterIntro = (now - fx.introHideTs) > 950;
  if(afterIntro && fx.bmQueue.length){
    if(now - fx.lastGlimpseTs > fx.glimpseEveryMs){
      const item = fx.bmQueue[fx.bmIndex % fx.bmQueue.length];
      fx.bmIndex++;
      fx.filmText = item.text.replace(/intensity\s*:\s*(0?\.\d+|1(\.0+)?)\b/i,"").trim();
      fx.filmPct = Math.round(item.intensity*100);
      fx.filmAlpha = 0.0;
      fx.lastGlimpseTs = now;

      if(els.bmGlimpseLabel){
        els.bmGlimpseLabel.style.display = "block";
        els.bmGlimpseLabel.textContent = `BM glimpse (${fx.filmPct}%)`;
      }
    }

    // film alpha pulse
    const dt = now - fx.lastGlimpseTs;
    if(dt < 700){
      fx.filmAlpha = Math.min(1, dt/700) * 0.95;
    }else if(dt < 5200){
      fx.filmAlpha = 0.95;
    }else if(dt < 6500){
      fx.filmAlpha = Math.max(0, 1 - (dt-5200)/1300) * 0.95;
    }else{
      fx.filmAlpha = 0;
      if(els.bmGlimpseLabel) els.bmGlimpseLabel.style.display = "none";
    }

    if(fx.filmAlpha > 0.01){
      renderBmFilm(fx.filmText, now);
    }
  }

  requestAnimationFrame(tickDream);
}

function startDream(){
  if(!els.dreamOverlay) return;
  if(state.dreamFX.running) return;

  state.dreamFX.running = true;
  state.dreamFX.canvas = els.dreamCanvas;
  state.dreamFX.ctx = els.dreamCanvas.getContext("2d", { alpha:false });
  state.dreamFX.t0 = nowTs();
  state.dreamFX.introHideTs = nowTs();
  state.dreamFX.lastGlimpseTs = nowTs() - 999999;

  initDreamCanvasSize();
  initDreamParticles();
  buildBmQueue();

  els.dreamOverlay.style.display = "flex";
  if(els.dreamMetaText){
    const n = state.bmPrompts.filter(b=>b.locked).length;
    els.dreamMetaText.textContent = n ? `Dreaming across ${n} locked BM snapshot(s)‚Ä¶` : "No locked BM snapshots yet ‚Äî clouds only.";
  }
  if(els.dreamIntro) els.dreamIntro.style.display = "block";
  if(els.bmGlimpseLabel) els.bmGlimpseLabel.style.display = "none";

  requestAnimationFrame(tickDream);
}

function stopDream(){
  state.dreamFX.running = false;
  if(els.dreamOverlay) els.dreamOverlay.style.display = "none";
  if(els.dreamIntro) els.dreamIntro.style.display = "block";
  if(els.bmGlimpseLabel) els.bmGlimpseLabel.style.display = "none";
  scheduleDreamTimer();
}

/* FIX #2: resize listener corrected */
window.addEventListener("resize", () => {
  if(state.dreamFX.running){
    initDreamCanvasSize();
    initDreamParticles();
  }
});

/* ===================== Intuition (weekly) ===================== */

function saveIntuition(){
  localStorage.setItem(KEY_INTUITION, JSON.stringify({
    lastRun: state.intuition.lastRun || 0,
    samples: (state.intuition.samples||[]).slice(-12)
  }));
}

function buildIntuitionSummary(){
  const now = nowTs();
  const recentHist = (state.history||[]).filter(h=> now - h.ts <= INTUITION_INTERVAL_MS);
  const lockedBM  = (state.bmPrompts||[]).filter(b=>b.locked);

  const total = recentHist.length;
  const userMsgs = recentHist.filter(h=>h.role==="user").length;
  const auraMsgs = recentHist.filter(h=>h.role==="aura").length;
  const locked = lockedBM.length;
  const latestLocked = lockedBM[locked-1];
  const latestHint = latestLocked && (latestLocked.text||"").replace(/\s+/g," ").slice(0,120);

  let s = `Weekly intuition: you had ${total} meaningful entries (You:${userMsgs}, AURA:${auraMsgs}). `;
  if(locked && latestHint){
    s += `You locked ${locked} BM snapshot(s) ‚Äî recent focus: "${latestHint}‚Ä¶". `;
  }
  s += "Suggestion: choose 1‚Äì2 small practical actions that reduce friction and increase calm, instead of a big jump.";
  return s;
}

function maybeRunWeeklyIntuition(){
  if(!state.intuition.enabled) return;
  const now = nowTs();
  const last = state.intuition.lastRun || 0;
  if(now - last < INTUITION_INTERVAL_MS) return;

  const summary = buildIntuitionSummary();
  state.intuition.lastRun = now;
  state.intuition.samples.push({ ts: now, summary });
  saveIntuition();

  logLine("aura", "[Intuition] " + summary);
  addHistory("aura", "[Intuition] " + summary);
  showToast("Intuition generated");
}

/* Capture once (lightweight pocket detection) */
async function intuitionCaptureOnce(){
  if(!state.intuition.enabled) return;
  // no-op stub; can be wired later
  try{
    const c = document.createElement("canvas");
    c.width = 160; c.height = 120;
    const tctx = c.getContext("2d");

    // FIX #3: use 'c' not 'canvas'
    tctx.drawImage(c, 0,0, c.width, c.height);

    // pocket detection heuristic could be added by developer later
  }catch(e){
    console.warn("intuitionCaptureOnce failed:", e);
  }
}

/* ===================== Sense ===================== */

async function startSenseCamera(){
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    showToast("Camera not available");
    return;
  }
  try{
    state.sense.stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
    els.senseVideo.srcObject = state.sense.stream;
    els.senseVideo.style.display = "block";
    els.senseStatus.textContent = "Camera active (local only).";
    showToast("Camera on (local only)");
  }catch(e){
    console.warn(e);
    showToast("Camera permission denied");
  }
}

function stopSenseCamera(){
  if(state.sense.stream){
    state.sense.stream.getTracks().forEach(t=>t.stop());
    state.sense.stream = null;
  }
  if(els.senseVideo) els.senseVideo.style.display = "none";
  if(els.senseStatus) els.senseStatus.textContent = "Idle.";
}

function saveSenseAsBM(){
  const txt = (els.senseBMBox.value || "").trim();
  if(!txt){ showToast("No text to save"); return; }
  state.bmPrompts.push({
    id: "bm_sense_"+nowTs(),
    title: "Sense snapshot",
    text: txt,
    ts: nowTs(),
    locked: true
  });
  els.senseBMBox.value = "";
  saveBM();
  showToast("Saved to BM");
}

function openModal(id){
  const el = document.getElementById(id);
  if(el) el.classList.add("show");
}
function closeModal(id){
  const el = document.getElementById(id);
  if(el) el.classList.remove("show");
  if(id==="modalSense") stopSenseCamera();
}

/* ===================== Main Chat (simple local reply) ===================== */

function generateAuraReply(prompt){
  const mood = state.metrics.E0 > 0.4 ? "positive" : (state.metrics.E0 < -0.2 ? "heavy" : "neutral");
  return `I hear you. Current E‚ÇÄ ‚âà ${state.metrics.E0.toFixed(3)} (${mood}). You said: ‚Äú${prompt}‚Äù.`;
}

function handleSend(){
  const text = (els.userInput.value || "").trim();
  if(!text) return;
  els.userInput.value = "";

  registerActivity();
  logLine("user", text);
  addHistory("user", text);

  const reply = generateAuraReply(text);
  state.lastAnswerText = reply;
  logLine("aura", reply);
  addHistory("aura", reply);
}

/* ===================== Wiring ===================== */

function wireEvents(){
  // basic activity tracking
  document.addEventListener("click", ()=>registerActivity(), {capture:true});
  document.addEventListener("keydown", ()=>registerActivity(), {capture:true});
  document.addEventListener("mousemove", ()=>registerActivity());
  document.addEventListener("touchstart", ()=>registerActivity());

  els.sendBtn.addEventListener("click", handleSend);
  els.userInput.addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      handleSend();
    }
  });

  els.btnOptions.addEventListener("click", ()=>{
    els.optionsMenu.classList.toggle("show");
  });

  // voice toggle
  if(els.miVoice){
    els.miVoice.addEventListener("click", ()=>{
      state.voiceOn = !state.voiceOn;
      els.voicePill.textContent = state.voiceOn ? "on" : "off";
      els.voicePill.className = state.voiceOn ? "pillOn" : "pillOff";
      saveCfg();
    });
  }

  // learning toggle
  if(els.miLearn){
    els.miLearn.addEventListener("click", ()=>{
      state.learningOn = !state.learningOn;
      els.learnPill.textContent = state.learningOn ? "on" : "off";
      els.learnPill.className = state.learningOn ? "pillOn" : "pillOff";
      saveCfg();
    });
  }

  // Sense modal open
  if(els.miSense){
    els.miSense.addEventListener("click", ()=>openModal("modalSense"));
  }

  // close buttons
  document.querySelectorAll(".closeX").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-close");
      if(id) closeModal(id);
    });
  });

  // Sense buttons
  if(els.btnSenseCamera) els.btnSenseCamera.addEventListener("click", startSenseCamera);
  if(els.btnSenseMic) els.btnSenseMic.addEventListener("click", ()=>showToast("Mic stub (to be wired)"));
  if(els.btnSaveSenseBM) els.btnSaveSenseBM.addEventListener("click", saveSenseAsBM);

  // Dream overlay: make sure tap/pointer/touch wakes up (mobile)
  if(els.dreamOverlay){
    const wake = (e)=>{ e.preventDefault(); stopDream(); };
    els.dreamOverlay.addEventListener("pointerdown", wake, {passive:false});
    els.dreamOverlay.addEventListener("touchstart", wake, {passive:false});
    els.dreamOverlay.addEventListener("click", wake);
  }

  // Hidden: triple-tap Sense status to toggle intuition (no UI change)
  let tapCount=0, tapTimer=null;
  if(els.senseStatus){
    els.senseStatus.addEventListener("click", ()=>{
      tapCount++;
      if(tapTimer) clearTimeout(tapTimer);
      tapTimer = setTimeout(()=>{ tapCount=0; }, 650);
      if(tapCount>=3){
        tapCount=0;
        state.intuition.enabled = !state.intuition.enabled;
        showToast("Intuition: " + (state.intuition.enabled ? "on" : "off"));
        saveIntuition();
      }
    });
  }
}

function init(){
  loadCfg();
  loadHistory();
  loadBM();

  // pills initial
  if(els.voicePill){
    els.voicePill.textContent = state.voiceOn ? "on" : "off";
    els.voicePill.className = state.voiceOn ? "pillOn" : "pillOff";
  }
  if(els.learnPill){
    els.learnPill.textContent = state.learningOn ? "on" : "off";
    els.learnPill.className = state.learningOn ? "pillOn" : "pillOff";
  }

  wireEvents();
  scheduleDreamTimer();

  logLine("sys","AURA-X Œ© ready (v4.9 + Dream + Intuition, v5 fixed).");
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
