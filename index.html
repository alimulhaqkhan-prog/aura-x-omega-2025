<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype 9.9 + Dream</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Offline LLM package placeholder (WebLLM ready for future use) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --c-bg:#020617;
      --c-bg-soft:#020617;
      --c-card:#020617;
      --c-border:rgba(148,163,184,0.35);
      --c-soft-border:rgba(148,163,184,0.25);
      --c-text:#e5e7eb;
      --c-text-soft:#9ca3af;
      --c-accent:#38bdf8;
      --c-accent-soft:#0ea5e9;
      --c-badge:#1d283a;
      --c-danger:#f97373;
      --c-success:#4ade80;
      --c-gold:#facc15;
      --shadow-soft:0 18px 60px rgba(15,23,42,0.88);
      --radius-xl:1.5rem;
      --radius-lg:1rem;
      --radius-md:0.75rem;
    }
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 10% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 90% 0%, #0f172a 0, transparent 50%),
        radial-gradient(circle at 0 100%, rgba(15,118,110,0.25) 0, transparent 45%),
        radial-gradient(circle at 100% 100%, rgba(56,189,248,0.25) 0, transparent 48%),
        radial-gradient(circle at 50% 50%, #020617 0, #000 55%);
      color:var(--c-text);
      min-height:100vh;
      padding:10px;
      display:flex;
      align-items:stretch;
      justify-content:center;
    }
    .appShell{
      width:100%;
      max-width:1100px;
      margin:auto;
      border-radius:var(--radius-xl);
      border:1px solid rgba(148,163,184,0.45);
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,0.16) 0, transparent 45%),
        radial-gradient(circle at 100% 0%, rgba(129,140,248,0.18) 0, transparent 50%),
        radial-gradient(circle at 0% 100%, rgba(45,212,191,0.12) 0, transparent 45%),
        radial-gradient(circle at 100% 100%, rgba(15,23,42,0.98) 0, rgba(15,23,42,0.98) 55%, #020617 100%);
      box-shadow:var(--shadow-soft);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      position:relative;
    }
    .appHeader{
      padding:0.85rem 1rem 0.6rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:0.75rem;
      border-bottom:1px solid rgba(148,163,184,0.32);
      background:
        linear-gradient(to right, rgba(15,23,42,0.9), rgba(15,23,42,0.94));
    }
    .headerLeft{
      display:flex;
      align-items:center;
      gap:0.75rem;
      min-width:0;
    }
    .orbWrap{
      width:40px;
      height:40px;
      border-radius:999px;
      background:
        conic-gradient(from 210deg, rgba(56,189,248,0.1), rgba(56,189,248,0.9), rgba(129,140,248,0.8), rgba(45,212,191,0.85), rgba(56,189,248,0.1));
      padding:1px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 0 1px rgba(148,163,184,0.35);
    }
    .orb{
      width:100%;
      height:100%;
      border-radius:inherit;
      background:
        radial-gradient(circle at 30% 20%, #e0f2fe 0, transparent 45%),
        radial-gradient(circle at 80% 20%, rgba(129,140,248,0.4) 0, transparent 55%),
        radial-gradient(circle at 50% 90%, rgba(45,212,191,0.4) 0, transparent 55%),
        radial-gradient(circle at 50% 50%, #020617 0, #020617 55%, #020617 100%);
      position:relative;
    }
    .orb::after{
      content:"Œ©";
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.2rem;
      color:rgba(226,232,240,0.92);
      text-shadow:0 0 14px rgba(56,189,248,0.8);
    }
    .titleBlock{
      min-width:0;
    }
    .titleBlock h1{
      font-size:0.96rem;
      font-weight:600;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:rgba(226,232,240,0.96);
      display:flex;
      align-items:center;
      gap:0.45rem;
    }
    .titleTag{
      font-size:0.65rem;
      padding:0.08rem 0.4rem;
      border-radius:999px;
      border:1px solid rgba(52,211,153,0.35);
      background:rgba(5,46,22,0.5);
      color:rgba(167,243,208,0.95);
      text-transform:uppercase;
      letter-spacing:0.08em;
    }
    .titleBlock p{
      font-size:0.78rem;
      color:rgba(148,163,184,0.96);
      margin-top:0.15rem;
    }
    .headerRight{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:0.3rem;
    }
    .pillRow{
      display:flex;
      align-items:center;
      gap:0.4rem;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      padding:0.28rem 0.55rem;
      border-radius:999px;
      font-size:0.7rem;
      border:1px solid rgba(148,163,184,0.4);
      color:rgba(209,213,219,0.96);
      display:inline-flex;
      align-items:center;
      gap:0.35rem;
      background:rgba(15,23,42,0.9);
    }
    .pill span.key{
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:rgba(148,163,184,0.9);
    }
    .pill span.val{
      font-variant-numeric:tabular-nums;
    }
    .faithToggle{
      display:inline-flex;
      align-items:center;
      gap:0.25rem;
      padding:0.24rem 0.5rem;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(148,163,184,0.5);
      font-size:0.7rem;
      cursor:pointer;
    }
    .faithToggle span.status{
      font-weight:500;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:rgba(248,250,252,0.95);
    }
    .faithBadge{
      width:9px;height:9px;border-radius:999px;
      background:radial-gradient(circle at 30% 20%, #facc15 0, #f97316 35%, #b45309 100%);
      box-shadow:0 0 8px rgba(245,158,11,0.9);
    }
    .headerButtons{
      display:flex;
      align-items:center;
      gap:0.3rem;
    }
    .iconBtn{
      width:28px;
      height:28px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.95);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.85rem;
      color:rgba(226,232,240,0.95);
      cursor:pointer;
      transition:background 0.15s,border-color 0.15s,transform 0.1s;
    }
    .iconBtn:active{
      transform:scale(0.96);
      background:rgba(15,23,42,1);
    }

    .bodyShell{
      flex:1;
      display:flex;
      flex-direction:column;
      padding:0.7rem;
      gap:0.6rem;
    }
    .topRow{
      display:grid;
      grid-template-columns:2.1fr 1.1fr;
      gap:0.6rem;
      min-height:0;
    }
    .chatCard{
      border-radius:var(--radius-lg);
      border:1px solid rgba(148,163,184,0.45);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.12) 0, transparent 40%),
        radial-gradient(circle at 100% 0, rgba(129,140,248,0.16) 0, transparent 45%),
        linear-gradient(to bottom right, rgba(15,23,42,0.98), rgba(15,23,42,0.96));
      padding:0.7rem;
      display:flex;
      flex-direction:column;
      gap:0.5rem;
      min-height:0;
      position:relative;
      overflow:hidden;
    }
    .chatHeaderRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:0.2rem;
    }
    .chatTitle{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:rgba(148,163,184,0.96);
      display:flex;
      align-items:center;
      gap:0.35rem;
    }
    .chatTitle span.dot{
      width:6px;height:6px;border-radius:999px;
      background:radial-gradient(circle at 30% 20%, #38bdf8 0, transparent 60%);
      box-shadow:0 0 10px rgba(56,189,248,0.8);
    }
    .metricsMini{
      display:flex;
      gap:0.28rem;
      font-size:0.7rem;
      color:rgba(148,163,184,0.95);
    }
    .metricsMini span strong{
      color:rgba(226,232,240,0.96);
      font-variant-numeric:tabular-nums;
    }
    .capsuleRow{
      display:flex;
      align-items:center;
      gap:0.45rem;
      font-size:0.7rem;
      color:rgba(148,163,184,0.96);
    }
    .capsuleLabel{
      font-weight:500;
      letter-spacing:0.08em;
      text-transform:uppercase;
    }
    .capsuleBar{
      flex:1;
      height:6px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      overflow:hidden;
      position:relative;
    }
    .capsuleFill{
      position:absolute;
      inset:0;
      width:0%;
      background:
        linear-gradient(90deg,#22c55e,#facc15,#f97316,#ef4444);
      box-shadow:0 0 12px rgba(248,250,252,0.55);
      transition:width 0.25s ease-out;
    }
    .capsuleVal{
      font-variant-numeric:tabular-nums;
    }
    .chatLog{
      flex:1;
      min-height:0;
      border-radius:var(--radius-md);
      border:1px solid rgba(148,163,184,0.5);
      background:rgba(15,23,42,0.96);
      padding:0.55rem 0.55rem 0.25rem;
      overflow-y:auto;
      font-size:0.8rem;
      scroll-behavior:smooth;
    }
    .logLine{
      margin-bottom:0.32rem;
      display:flex;
      gap:0.35rem;
    }
    .logTime{
      font-variant-numeric:tabular-nums;
      font-size:0.68rem;
      color:rgba(148,163,184,0.85);
      min-width:42px;
    }
    .logWho{
      font-weight:600;
      font-size:0.72rem;
      letter-spacing:0.05em;
      text-transform:uppercase;
      color:rgba(226,232,240,0.9);
    }
    .logMsg{
      color:rgba(226,232,240,0.96);
    }
    .logMsg.system{
      color:rgba(129,140,248,0.96);
    }
    .logMsg.meta{
      color:rgba(148,163,184,0.96);
    }
    .logMsg.err{
      color:var(--c-danger);
    }

    .sideCard{
      border-radius:var(--radius-lg);
      border:1px solid rgba(148,163,184,0.45);
      background:
        radial-gradient(circle at 0 0, rgba(45,212,191,0.12) 0, transparent 40%),
        radial-gradient(circle at 100% 0, rgba(37,99,235,0.16) 0, transparent 45%),
        linear-gradient(to bottom right, rgba(15,23,42,0.98), rgba(15,23,42,0.96));
      padding:0.7rem;
      display:flex;
      flex-direction:column;
      gap:0.6rem;
      min-height:0;
    }
    .sideTitle{
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:rgba(148,163,184,0.96);
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .sideTitle span.badge{
      font-size:0.7rem;
      padding:0.12rem 0.45rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.96);
      color:rgba(209,213,219,0.96);
    }
    .quickBtns{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:0.4rem;
    }
    .quickBtn{
      border-radius:0.75rem;
      border:1px solid rgba(148,163,184,0.45);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.12) 0, transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(45,212,191,0.14) 0, transparent 55%),
        linear-gradient(to bottom right, rgba(15,23,42,0.98), rgba(15,23,42,0.96));
      padding:0.38rem 0.3rem;
      font-size:0.72rem;
      color:rgba(226,232,240,0.96);
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:0.1rem;
      cursor:pointer;
      min-height:52px;
      text-align:left;
    }
    .quickBtn span.icon{
      font-size:0.9rem;
    }
    .quickBtn span.label{
      font-size:0.7rem;
    }
    .quickBtn span.sub{
      font-size:0.63rem;
      color:rgba(148,163,184,0.95);
    }

    .reactionBar{
      display:flex;
      flex-wrap:wrap;
      gap:0.3rem;
      font-size:0.68rem;
      color:rgba(148,163,184,0.95);
    }
    .reactionChip{
      padding:0.15rem 0.4rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.96);
      display:inline-flex;
      align-items:center;
      gap:0.3rem;
    }
    .reactionChip strong{
      font-variant-numeric:tabular-nums;
      color:rgba(226,232,240,0.96);
    }

    .promptRow{
      display:flex;
      flex-direction:column;
      gap:0.4rem;
    }
    .promptTop{
      display:flex;
      align-items:center;
      gap:0.4rem;
      justify-content:space-between;
    }
    .promptStats{
      font-size:0.7rem;
      color:rgba(148,163,184,0.95);
      display:flex;
      gap:0.35rem;
    }
    .promptStats span strong{
      color:rgba(226,232,240,0.96);
      font-variant-numeric:tabular-nums;
    }

    .inputShell{
      border-radius:var(--radius-lg);
      border:1px solid rgba(148,163,184,0.5);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.08) 0, transparent 40%),
        radial-gradient(circle at 100% 100%, rgba(45,212,191,0.1) 0, transparent 40%),
        linear-gradient(to bottom right, rgba(15,23,42,0.98), rgba(15,23,42,0.98));
      padding:0.45rem 0.55rem 0.45rem 0.55rem;
      display:flex;
      align-items:flex-end;
      gap:0.4rem;
    }
    .inputBox{
      flex:1;
      min-width:0;
      border-radius:0.8rem;
      background:rgba(15,23,42,0.96);
      border:1px solid rgba(148,163,184,0.55);
      padding:0.35rem 0.6rem;
      display:flex;
      flex-direction:column;
      gap:0.25rem;
    }
    .inputRow{
      display:flex;
      align-items:flex-end;
      gap:0.35rem;
    }
    .promptPrefix{
      font-size:0.7rem;
      color:rgba(148,163,184,0.95);
      padding-bottom:0.1rem;
    }
    #userInput{
      flex:1;
      resize:none;
      border:none;
      outline:none;
      background:transparent;
      color:var(--c-text);
      font-size:0.8rem;
      max-height:100px;
      min-height:20px;
    }
    #userInput::placeholder{
      color:rgba(100,116,139,0.9);
    }
    .inputMeta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:0.68rem;
      color:rgba(148,163,184,0.96);
    }
    .inputMeta span{
      display:flex;
      align-items:center;
      gap:0.3rem;
    }
    .sendBtn{
      width:34px;
      height:34px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1rem;
      background:radial-gradient(circle at 30% 10%, #e0f2fe 0, transparent 45%),
        radial-gradient(circle at 70% 90%, rgba(45,212,191,0.4) 0, transparent 55%),
        linear-gradient(135deg,#22c55e,#16a34a);
      color:#0b1120;
      box-shadow:0 12px 30px rgba(16,185,129,0.65);
      transition:transform 0.08s ease-out,box-shadow 0.08s ease-out,filter 0.12s;
    }
    .sendBtn:active{
      transform:translateY(1px) scale(0.97);
      box-shadow:0 6px 16px rgba(16,185,129,0.7);
      filter:brightness(0.98);
    }

    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.55);
      background:rgba(15,23,42,0.95);
      padding:0.22rem 0.6rem;
      font-size:0.7rem;
      color:rgba(226,232,240,0.96);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:0.35rem;
    }
    .btnSmall{
      font-size:0.66rem;
      padding:0.16rem 0.6rem;
    }
    .btnBlue{
      border-color:rgba(56,189,248,0.6);
      background:rgba(15,23,42,0.96);
    }
    .btnRed{
      border-color:rgba(248,113,113,0.7);
      color:#fecaca;
    }
    .btnGold{
      border-color:rgba(250,204,21,0.9);
      color:#facc15;
    }

    .optionsMenu{
      position:absolute;
      top:0.65rem;
      left:0.65rem;
      display:flex;
      align-items:center;
      gap:0.3rem;
      z-index:5;
    }
    .optionsMenu .btn{
      background:rgba(15,23,42,0.9);
    }
    .optionsPanel{
      position:absolute;
      top:2.2rem;
      left:0.65rem;
      border-radius:var(--radius-md);
      border:1px solid rgba(148,163,184,0.55);
      background:rgba(15,23,42,0.98);
      padding:0.4rem 0.45rem;
      min-width:170px;
      font-size:0.7rem;
      box-shadow:0 18px 40px rgba(15,23,42,0.9);
      display:none;
      z-index:8;
    }
    .optionsPanel.open{
      display:block;
    }
    .optionsPanel h4{
      font-size:0.7rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:rgba(148,163,184,0.96);
      margin-bottom:0.26rem;
    }
    .optionsPanel ul{
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:0.1rem;
    }
    .optionsPanel li button{
      width:100%;
      border-radius:0.5rem;
      border:none;
      background:transparent;
      text-align:left;
      padding:0.22rem 0.3rem;
      color:rgba(226,232,240,0.96);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:0.3rem;
    }
    .optionsPanel li button span.label{
      font-size:0.7rem;
    }
    .optionsPanel li button span.key{
      font-size:0.65rem;
      color:rgba(148,163,184,0.9);
    }
    .optionsPanel li button:hover{
      background:rgba(15,23,42,0.9);
    }

    .modalOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at 20% 0, rgba(15,23,42,0.85) 0, rgba(15,23,42,0.97) 45%, #020617 100%);
      backdrop-filter:blur(14px);
      z-index:50;
    }
    .modalOverlay.open{
      display:flex;
    }
    .modal{
      width:100%;
      max-width:720px;
      max-height:90vh;
      border-radius:var(--radius-xl);
      border:1px solid rgba(148,163,184,0.55);
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.2) 0, transparent 40%),
        radial-gradient(circle at 100% 0, rgba(129,140,248,0.2) 0, transparent 45%),
        radial-gradient(circle at 0 100%, rgba(45,212,191,0.14) 0, transparent 45%),
        linear-gradient(to bottom right, rgba(15,23,42,0.98), rgba(15,23,42,0.99));
      box-shadow:var(--shadow-soft);
      padding:0.8rem 0.9rem;
      display:flex;
      flex-direction:column;
      gap:0.5rem;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:0.5rem;
    }
    .modalHeaderLeft{
      display:flex;
      flex-direction:column;
      gap:0.1rem;
    }
    .modalTitle{
      font-size:0.85rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:rgba(226,232,240,0.96);
      display:flex;
      align-items:center;
      gap:0.4rem;
    }
    .modalSubtitle{
      font-size:0.72rem;
      color:rgba(148,163,184,0.96);
    }
    .modalHeaderRight{
      display:flex;
      align-items:center;
      gap:0.3rem;
      font-size:0.7rem;
      color:rgba(148,163,184,0.96);
    }
    .modalBody{
      flex:1;
      min-height:0;
      border-radius:var(--radius-md);
      border:1px solid rgba(148,163,184,0.5);
      background:rgba(15,23,42,0.98);
      padding:0.6rem;
      overflow:auto;
      font-size:0.78rem;
    }
    .modalFooter{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:0.4rem;
      font-size:0.7rem;
      color:rgba(148,163,184,0.96);
    }

    .identityGrid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:0.6rem;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:0.15rem;
    }
    .field label{
      font-size:0.72rem;
      color:rgba(148,163,184,0.96);
    }
    .field input,
    .field textarea,
    .field select{
      border-radius:0.6rem;
      border:1px solid rgba(148,163,184,0.55);
      background:rgba(15,23,42,0.98);
      color:rgba(226,232,240,0.96);
      font-size:0.78rem;
      padding:0.32rem 0.45rem;
    }
    .field textarea{
      resize:vertical;
      min-height:60px;
    }

    .seedLayout{
      display:grid;
      grid-template-columns:1.1fr 1.4fr;
      gap:0.6rem;
    }
    .seedColumn{
      border-radius:0.75rem;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.98);
      padding:0.45rem;
      display:flex;
      flex-direction:column;
      gap:0.35rem;
    }
    .seedColumn h4{
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:rgba(148,163,184,0.96);
    }
    .seedRow{
      display:flex;
      align-items:flex-start;
      gap:0.3rem;
    }
    .seedRow label{
      font-size:0.7rem;
      color:rgba(148,163,184,0.96);
      min-width:52px;
    }
    .seedRow textarea{
      flex:1;
      border-radius:0.55rem;
      border:1px solid rgba(148,163,184,0.55);
      background:rgba(15,23,42,0.98);
      color:rgba(226,232,240,0.96);
      font-size:0.78rem;
      padding:0.32rem 0.45rem;
      resize:vertical;
      min-height:54px;
    }

    .bmLayout{
      display:grid;
      grid-template-columns:1.3fr 1.6fr;
      gap:0.6rem;
      height:100%;
    }
    .bmSidebar{
      border-radius:0.75rem;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.98);
      padding:0.4rem;
      display:flex;
      flex-direction:column;
      gap:0.35rem;
    }
    .bmSidebar h4{
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:rgba(148,163,184,0.96);
    }
    .bmBadgeRow{
      display:flex;
      flex-wrap:wrap;
      gap:0.25rem;
      font-size:0.68rem;
    }
    .bmBadge{
      padding:0.12rem 0.4rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      color:rgba(209,213,219,0.96);
    }
    #bmList{
      flex:1;
      min-height:0;
      overflow-y:auto;
      font-size:0.76rem;
    }
    .bmItem{
      padding:0.28rem 0.32rem;
      border-radius:0.55rem;
      border:1px solid transparent;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:0.12rem;
    }
    .bmItem:hover{
      border-color:rgba(148,163,184,0.6);
      background:rgba(15,23,42,0.98);
    }
    .bmItem.active{
      border-color:rgba(56,189,248,0.9);
      background:rgba(15,23,42,1);
    }
    .bmItemTitle{
      font-size:0.75rem;
      color:rgba(226,232,240,0.96);
    }
    .bmItemMeta{
      font-size:0.65rem;
      color:rgba(148,163,184,0.96);
      display:flex;
      justify-content:space-between;
    }

    .bmViewer{
      border-radius:0.75rem;
      border:1px solid rgba(148,163,184,0.5);
      background:rgba(15,23,42,0.98);
      padding:0.45rem;
      display:flex;
      flex-direction:column;
      gap:0.4rem;
      min-height:0;
    }
    .bmViewerHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:0.35rem;
      font-size:0.72rem;
      color:rgba(148,163,184,0.96);
    }
    .bmViewerTitle{
      font-size:0.8rem;
      color:rgba(226,232,240,0.96);
      font-weight:500;
    }
    .bmViewerBody{
      flex:1;
      min-height:0;
      overflow-y:auto;
      font-size:0.78rem;
      color:rgba(226,232,240,0.96);
      border-radius:0.55rem;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.98);
      padding:0.4rem;
      white-space:pre-wrap;
    }
    .bmActions{
      display:flex;
      flex-wrap:wrap;
      gap:0.3rem;
      font-size:0.7rem;
    }

    #historyBox{
      border-radius:0.7rem;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.98);
      padding:0.4rem;
      font-size:0.76rem;
      max-height:400px;
      overflow-y:auto;
    }
    .historyRow{
      display:flex;
      gap:0.35rem;
      margin-bottom:0.3rem;
    }
    .historyMeta{
      min-width:54px;
      font-size:0.66rem;
      color:rgba(148,163,184,0.9);
      font-variant-numeric:tabular-nums;
    }
    .historyText{
      color:rgba(226,232,240,0.96);
    }

    #llmConfig{
      display:flex;
      flex-direction:column;
      gap:0.5rem;
      font-size:0.76rem;
    }
    #llmConfig .row{
      display:flex;
      gap:0.4rem;
      flex-wrap:wrap;
      align-items:center;
    }
    #llmConfig input,
    #llmConfig select{
      border-radius:0.6rem;
      border:1px solid rgba(148,163,184,0.55);
      background:rgba(15,23,42,0.98);
      color:rgba(226,232,240,0.96);
      font-size:0.78rem;
      padding:0.22rem 0.4rem;
    }
    #llmConfig .note{
      font-size:0.7rem;
      color:rgba(148,163,184,0.96);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:1.2rem;
      transform:translateX(-50%);
      padding:0.35rem 0.7rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      background:rgba(15,23,42,0.98);
      color:rgba(226,232,240,0.98);
      font-size:0.72rem;
      display:none;
      z-index:60;
      box-shadow:0 14px 32px rgba(15,23,42,0.9);
    }
    .toast.show{
      display:block;
    }

    .hidden{display:none !important;}

    /* Dream / screensaver overlay */
    #dreamOverlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background:
        radial-gradient(circle at 10% 0%, rgba(56, 189, 248, 0.18) 0, transparent 45%),
        radial-gradient(circle at 90% 0%, rgba(129, 140, 248, 0.16) 0, transparent 50%),
        radial-gradient(circle at 0% 100%, rgba(45, 212, 191, 0.16) 0, transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(15, 23, 42, 0.96) 0, rgba(2, 6, 23, 0.98) 55%, #020617 100%);
      backdrop-filter: blur(18px);
      z-index: 99;
    }
    #dreamOverlay.active {
      display: flex;
    }
    #dreamOverlay .dream-inner {
      max-width: 640px;
      width: 90%;
      border-radius: 1.5rem;
      padding: 1.5rem 1.75rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background:
        radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.12) 0, transparent 45%),
        radial-gradient(circle at 100% 0%, rgba(129, 140, 248, 0.14) 0, transparent 50%),
        linear-gradient(to bottom right, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      box-shadow:
        0 24px 80px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(15, 23, 42, 0.9);
    }
    #dreamOverlay .dream-title {
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.9);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    #dreamOverlay .dream-title::before {
      content: "‚óé";
      font-size: 0.9rem;
      color: rgba(94, 234, 212, 0.9);
    }
    #dreamOverlay .dream-snippet {
      max-height: 220px;
      overflow-y: auto;
      font-size: 0.92rem;
      line-height: 1.5;
      color: rgba(226, 232, 240, 0.96);
      padding-right: 0.25rem;
      margin-bottom: 0.85rem;
    }
    #dreamOverlay .dream-hint {
      font-size: 0.8rem;
      color: rgba(148, 163, 184, 0.9);
    }

    /* Dream config inside BM */
    .dream-config {
      margin-top: 1.25rem;
      padding: 0.875rem 0.9rem;
      border-radius: 0.9rem;
      background:
        linear-gradient(to right, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.96));
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    .dream-config-title {
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.95);
      margin-bottom: 0.5rem;
    }
    .dream-config-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }
    .dream-config-row label {
      font-size: 0.82rem;
      color: rgba(203, 213, 225, 0.95);
    }
    .dream-config-row select {
      min-width: 180px;
      padding: 0.3rem 0.4rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: rgba(226, 232, 240, 0.96);
      font-size: 0.82rem;
    }
    .dream-config-note {
      font-size: 0.8rem;
      color: rgba(148, 163, 184, 0.92);
    }

    @media(max-width:880px){
      .appShell{
        border-radius:1.1rem;
      }
      .topRow{
        grid-template-columns:1fr;
      }
      .seedLayout,
      .bmLayout{
        grid-template-columns:1fr;
      }
      .optionsMenu{
        top:0.45rem;
        left:0.45rem;
      }
      .appHeader{
        padding:0.75rem 0.75rem 0.55rem;
      }
      .bodyShell{
        padding:0.55rem;
      }
      .chatCard,
      .sideCard{
        padding:0.55rem;
      }
    }
  </style>
</head>
<body>
  <div class="appShell">
    <div class="optionsMenu">
      <button class="iconBtn" id="btnOptions" title="Options">
        ‚ò∞
      </button>
      <div class="optionsPanel" id="optionsPanel">
        <h4>Quick routes</h4>
        <ul>
          <li><button data-open="modalIdentity"><span class="label">ü™™ Identity &amp; deep profile</span><span class="key">ID</span></button></li>
          <li><button data-open="modalSeed"><span class="label">üå± Seed knowledge &amp; rules</span><span class="key">SEED</span></button></li>
          <li><button data-open="modalBM"><span class="label">üß† BM long-form memories</span><span class="key">BM</span></button></li>
          <li><button data-open="modalHistory"><span class="label">üï∞ Conversation history</span><span class="key">HIST</span></button></li>
          <li><button data-open="modalLLM"><span class="label">‚öô Offline &amp; API LLM</span><span class="key">LLM</span></button></li>
        </ul>
      </div>
    </div>

    <header class="appHeader">
      <div class="headerLeft">
        <div class="orbWrap">
          <div class="orb"></div>
        </div>
        <div class="titleBlock">
          <h1>
            AURA-X Œ©
            <span class="titleTag">AEC ‚Äì Artificial Emotional Continuity</span>
          </h1>
          <p>
            Offline emotional reactor prototype ‚Äì TM √ó BM ‚Üí Continuity R with Faith, Logic &amp; Truth resonance.
          </p>
        </div>
      </div>
      <div class="headerRight">
        <div class="pillRow">
          <div class="pill">
            <span class="key">Profile</span>
            <span class="val" id="profileStatus">Empty</span>
          </div>
          <div class="pill">
            <span class="key">Seed</span>
            <span class="val" id="seedStatus">0 Q&amp;A</span>
          </div>
          <div class="pill">
            <span class="key">BM</span>
            <span class="val" id="bmStatus">0 stories</span>
          </div>
          <button class="faithToggle" id="faithToggle">
            <span class="faithBadge"></span>
            <span class="status" id="faithStatus">Faith ON</span>
          </button>
        </div>
        <div class="headerButtons">
          <button class="iconBtn" id="btnIdentity" title="Identity">
            ü™™
          </button>
          <button class="iconBtn" id="btnSeed" title="Seed knowledge">
            üå±
          </button>
          <button class="iconBtn" id="btnBM" title="BM memories">
            üß†
          </button>
          <button class="iconBtn" id="btnHistory" title="History">
            üï∞
          </button>
          <button class="iconBtn" id="btnLLM" title="LLM settings">
            ‚öô
          </button>
        </div>
      </div>
    </header>

    <main class="bodyShell">
      <div class="topRow">
        <section class="chatCard">
          <div class="chatHeaderRow">
            <div class="chatTitle">
              <span class="dot"></span>
              <span>Conversation ‚Äì User ‚Üî AURA-X Œ©</span>
            </div>
            <div class="metricsMini">
              <span>TM: <strong id="tmVal">0.00</strong></span>
              <span>BM: <strong id="bmVal">0.00</strong></span>
              <span>D: <strong id="dVal">0.00</strong></span>
              <span>R: <strong id="rVal">0.00</strong></span>
            </div>
          </div>
          <div class="capsuleRow">
            <span class="capsuleLabel">Continuity R</span>
            <div class="capsuleBar">
              <div class="capsuleFill" id="capsuleFill"></div>
            </div>
            <span class="capsuleVal" id="rValCapsule">0.00</span>
          </div>
          <div class="chatLog" id="chatLog"></div>
        </section>

        <aside class="sideCard">
          <div class="sideTitle">
            <span>Quick modes &amp; emotional reactor</span>
            <span class="badge">Local only</span>
          </div>
          <div class="quickBtns">
            <button class="quickBtn" id="btnQuickHi">
              <span class="icon">üëã</span>
              <span class="label">Greet AURA</span>
              <span class="sub">Hi / Salaam / how are you?</span>
            </button>
            <button class="quickBtn" id="btnQuickWho">
              <span class="icon">ü§ñ</span>
              <span class="label">Who are you?</span>
              <span class="sub">Identity of AURA-X Œ©</span>
            </button>
            <button class="quickBtn" id="btnQuickCreator">
              <span class="icon">üßë‚Äçüî¨</span>
              <span class="label">Who created you?</span>
              <span class="sub">Alim ul Haq ‚Äì Timergara</span>
            </button>
            <button class="quickBtn" id="btnQuickFaith">
              <span class="icon">üïä</span>
              <span class="label">Faith lens</span>
              <span class="sub">Explain with faith ON</span>
            </button>
            <button class="quickBtn" id="btnQuickLogic">
              <span class="icon">üß†</span>
              <span class="label">Pure logic</span>
              <span class="sub">Explain with faith OFF</span>
            </button>
            <button class="quickBtn" id="btnQuickBM">
              <span class="icon">üìú</span>
              <span class="label">BM recall</span>
              <span class="sub">Use long-form story</span>
            </button>
          </div>
          <div class="reactionBar">
            <div class="reactionChip">
              TM<span><strong id="tmCounter">0</strong></span>
            </div>
            <div class="reactionChip">
              BM<span><strong id="bmCounter">0</strong></span>
            </div>
            <div class="reactionChip">
              Decay<span><strong id="dCounter">0</strong></span>
            </div>
            <div class="reactionChip">
              R events<span><strong id="rCounter">0</strong></span>
            </div>
          </div>
        </aside>
      </div>

      <div class="promptRow">
        <div class="promptTop">
          <div class="promptStats">
            <span>Last answer source: <strong id="answerSource">seed/local</strong></span>
            <span>History: <strong id="historyCount">0</strong> lines</span>
          </div>
        </div>
        <div class="inputShell">
          <div class="inputBox">
            <div class="inputRow">
              <div class="promptPrefix">User</div>
              <textarea id="userInput" placeholder="Ask something, or talk to AURA-X Œ© about life, feelings, plans‚Ä¶"></textarea>
            </div>
            <div class="inputMeta">
              <span>
                <span id="charCount">0</span> chars
              </span>
              <span>
                Seed ‚Üí Intelligence ‚Üí Offline LLM ‚Üí (optional API)
              </span>
            </div>
          </div>
          <button class="sendBtn" id="sendBtn" title="Send">
            ‚û§
          </button>
        </div>
      </div>
    </main>

    <!-- Identity Modal -->
    <div class="modalOverlay" id="modalIdentity">
      <div class="modal">
        <div class="modalHeader">
          <div class="modalHeaderLeft">
            <div class="modalTitle">
              ü™™ User identity &amp; deep profile
            </div>
            <div class="modalSubtitle">
              Stored locally as Bold Memory about you. This never leaves your device.
            </div>
          </div>
          <div class="modalHeaderRight">
            <button class="btn btnSmall btnBlue" id="btnSaveIdentity">Save</button>
            <button class="btn btnSmall" data-close="modalIdentity">Close</button>
          </div>
        </div>
        <div class="modalBody">
          <div class="identityGrid">
            <div class="field">
              <label for="idName">Name</label>
              <input id="idName" placeholder="Your full name" />
            </div>
            <div class="field">
              <label for="idTagline">Tagline / short bio</label>
              <input id="idTagline" placeholder="e.g. AI researcher, real-estate developer, teacher‚Ä¶" />
            </div>
            <div class="field">
              <label for="idLocation">Location</label>
              <input id="idLocation" placeholder="City, Country" />
            </div>
            <div class="field">
              <label for="idLanguage">Preferred language(s)</label>
              <input id="idLanguage" placeholder="e.g. Urdu, English ‚Äì Urdu for answers" />
            </div>
            <div class="field">
              <label for="idValues">Core values / faith</label>
              <textarea id="idValues" placeholder="Faith, ethics, red-lines, what matters most to you."></textarea>
            </div>
            <div class="field">
              <label for="idGoals">Life goals &amp; projects</label>
              <textarea id="idGoals" placeholder="Projects, dreams, responsibilities you want AURA to remember."></textarea>
            </div>
          </div>
        </div>
        <div class="modalFooter">
          <span id="identityMeta"></span>
        </div>
      </div>
    </div>

    <!-- Seed Modal -->
    <div class="modalOverlay" id="modalSeed">
      <div class="modal">
        <div class="modalHeader">
          <div class="modalHeaderLeft">
            <div class="modalTitle">üå± Seed knowledge &amp; self-learning rules</div>
            <div class="modalSubtitle">
              Basic Q&amp;A and correction rules live here. This is the first layer AURA will consult.
            </div>
          </div>
          <div class="modalHeaderRight">
            <button class="btn btnSmall btnBlue" id="btnSaveSeed">Save seed</button>
            <button class="btn btnSmall" data-close="modalSeed">Close</button>
          </div>
        </div>
        <div class="modalBody">
          <div class="seedLayout">
            <div class="seedColumn">
              <h4>Basic Q&amp;A seed</h4>
              <div class="seedRow">
                <label for="seedHi">Hi / Hello</label>
                <textarea id="seedHi" placeholder="How AURA should answer to Hi / Hello / Salaam."></textarea>
              </div>
              <div class="seedRow">
                <label for="seedWho">Who are you?</label>
                <textarea id="seedWho" placeholder="AURA-X Œ© identity answer."></textarea>
              </div>
              <div class="seedRow">
                <label for="seedCreator">Creator</label>
                <textarea id="seedCreator" placeholder="Who created AURA-X Œ©? (Alim ul Haq, Timergara)."></textarea>
              </div>
              <div class="seedRow">
                <label for="seedFaith">Faith ON</label>
                <textarea id="seedFaith" placeholder="How to apply faith lens when Faith is ON."></textarea>
              </div>
              <div class="seedRow">
                <label for="seedLogic">Logic</label>
                <textarea id="seedLogic" placeholder="Pure logical explanation style when Faith is OFF."></textarea>
              </div>
            </div>
            <div class="seedColumn">
              <h4>Self-learning rules</h4>
              <div class="seedRow">
                <label for="seedIncorrect">Incorrect</label>
                <textarea id="seedIncorrect" placeholder="When user says *incorrect, how to ask for correct answer and confirm Yes/No."></textarea>
              </div>
              <div class="seedRow">
                <label for="seedLock">Locking</label>
                <textarea id="seedLock" placeholder="Rules for locking learned answers into Intelligence BM (double confirmation, etc.)."></textarea>
              </div>
              <div class="seedRow">
                <label for="seedDecay">Decay</label>
                <textarea id="seedDecay" placeholder="How to decay wrong / noisy answers over time while keeping meaning."></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="modalFooter">
          <span id="seedMeta"></span>
        </div>
      </div>
    </div>

    <!-- BM Modal -->
    <div class="modalOverlay" id="modalBM">
      <div class="modal">
        <div class="modalHeader">
          <div class="modalHeaderLeft">
            <div class="modalTitle">üß† Bold Memory ‚Äì long-form stories</div>
            <div class="modalSubtitle">
              Only long, photo/video-ready stories live here. BM influences continuity R and Dream Mode.
            </div>
          </div>
          <div class="modalHeaderRight">
            <button class="btn btnSmall btnBlue" id="btnNewBM">New BM</button>
            <button class="btn btnSmall" data-close="modalBM">Close</button>
          </div>
        </div>
        <div class="modalBody">
          <div class="bmLayout">
            <div class="bmSidebar">
              <h4>BM entries</h4>
              <div class="bmBadgeRow">
                <span class="bmBadge" id="bmCountBadge">0 total</span>
                <span class="bmBadge" id="bmLockedBadge">0 locked</span>
                <span class="bmBadge" id="bmLiveBadge">0 live</span>
              </div>
              <div id="bmList"></div>
            </div>
            <div class="bmViewer">
              <div class="bmViewerHeader">
                <div>
                  <div class="bmViewerTitle" id="bmViewerTitle">No BM selected</div>
                  <div id="bmViewerMeta"></div>
                </div>
                <div class="bmActions">
                  <button class="btn btnSmall btnBlue" id="btnBMUse">Use in next answer</button>
                  <button class="btn btnSmall" id="btnBMEdit">Edit</button>
                  <button class="btn btnSmall btnGold" id="btnBMLock">Lock</button>
                  <button class="btn btnSmall btnRed" id="btnBMDelete">Delete</button>
                </div>
              </div>
              <div class="bmViewerBody" id="bmViewerBody">
                Long-form BM story text will appear here.
              </div>

              <div class="dream-config">
                <div class="dream-config-title">üåÄ Dream / screensaver timeout (BM-based)</div>
                <div class="dream-config-row">
                  <label for="dreamTimeout">Start Dream Mode after inactivity:</label>
                  <select id="dreamTimeout">
                    <option value="0">Off (no Dream Mode)</option>
                    <option value="30000">30 seconds</option>
                    <option value="60000">1 minute</option>
                    <option value="300000">5 minutes</option>
                    <option value="900000">15 minutes</option>
                    <option value="1800000">30 minutes</option>
                    <option value="3600000">1 hour</option>
                    <option value="10800000">3 hours</option>
                    <option value="28800000">8 hours</option>
                  </select>
                </div>
                <div class="dream-config-note">
                  When enabled, AURA-X Œ© will enter a soft Dream Mode while idle, using BM &amp; history to dream and gently decay noisy data while keeping the meaning.
                </div>
              </div>

            </div>
          </div>
        </div>
        <div class="modalFooter">
          <span id="bmMeta"></span>
        </div>
      </div>
    </div>

    <!-- History Modal -->
    <div class="modalOverlay" id="modalHistory">
      <div class="modal">
        <div class="modalHeader">
          <div class="modalHeaderLeft">
            <div class="modalTitle">üï∞ Conversation history window</div>
            <div class="modalSubtitle">
              Last 48h are ‚Äúsoft‚Äù and can decay; locked BM and identity are permanent until you manually clear them.
            </div>
          </div>
          <div class="modalHeaderRight">
            <button class="btn btnSmall" data-close="modalHistory">Close</button>
          </div>
        </div>
        <div class="modalBody">
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
            <button class="btn btnBlue" id="btnDeleteRecent">Delete history last 48h</button>
            <button class="btn btnRed" id="btnDeleteAllHist">Delete all history</button>
            <button class="btn btnBlue" id="btnCopyHistory">Copy</button>
            <button class="btn btnBlue" id="btnExportMemory">Export memory (JSON)</button>
            <button class="btn btnBlue" id="btnImportMemory">Import memory (JSON)</button>
          </div>
          <input type="file" id="memoryFileInput" accept="application/json" style="display:none;" />
          <div id="historyBox"></div>
        </div>
        <div class="modalFooter">
          <span id="historyMeta"></span>
        </div>
      </div>
    </div>

    <!-- LLM Modal -->
    <div class="modalOverlay" id="modalLLM">
      <div class="modal">
        <div class="modalHeader">
          <div class="modalHeaderLeft">
            <div class="modalTitle">‚öô Offline &amp; API LLM configuration</div>
            <div class="modalSubtitle">
              Seed &amp; Intelligence are always first. LLM is only a fallback when local layers have no answer.
            </div>
          </div>
          <div class="modalHeaderRight">
            <button class="btn btnSmall" data-close="modalLLM">Close</button>
          </div>
        </div>
        <div class="modalBody">
          <div id="llmConfig">
            <div class="row">
              <span>Offline model (future WebLLM):</span>
              <select id="offlineModel">
                <option value="off">Disabled (demo)</option>
                <option value="llama3-8b">LLaMA 3 8B (local)</option>
                <option value="phi-3">Phi-3 (local)</option>
              </select>
            </div>
            <div class="row">
              <span>Online API endpoint (optional):</span>
              <input id="apiEndpoint" placeholder="https://api.example.com/chat" />
            </div>
            <div class="row">
              <span>API key (stored only in this browser):</span>
              <input id="apiKey" type="password" placeholder="sk-..." />
            </div>
            <div class="row">
              <span>Max tokens offline:</span>
              <input id="offlineMaxTokens" type="number" min="128" max="4096" value="512" />
            </div>
            <div class="note">
              Order of answer: <strong>Seed</strong> ‚Üí <strong>Learned Intelligence</strong> ‚Üí <strong>Offline LLM</strong> ‚Üí <strong>API LLM</strong>.<br/>
              If Faith is ON, all answers must respect your red-lines and values.
            </div>
          </div>
        </div>
        <div class="modalFooter">
          <span id="llmMeta"></span>
        </div>
      </div>
    </div>

    <!-- Dream / screensaver overlay -->
    <div id="dreamOverlay" class="dream-overlay">
      <div class="dream-inner">
        <div class="dream-title">Dream Mode</div>
        <div class="dream-snippet">
          When you pause, AURA-X Œ© dreams with your BM &amp; history‚Ä¶
        </div>
        <div class="dream-hint">Tap anywhere to wake and continue.</div>
      </div>
    </div>

    <div class="toast" id="toastBubble"></div>
  </div>

  <script>
    const KEY_USER = "ax_user";
    const KEY_SEED = "ax_seed";
    const KEY_INT = "ax_intel";
    const KEY_BM = "ax_bm";
    const KEY_HIST = "ax_hist";
    const KEY_CFG = "ax_cfg";
    const KEY_LOGIC = "ax_logic";

    const els = {
      chatLog: document.getElementById("chatLog"),
      tmVal: document.getElementById("tmVal"),
      bmVal: document.getElementById("bmVal"),
      dVal: document.getElementById("dVal"),
      rVal: document.getElementById("rVal"),
      rValCapsule: document.getElementById("rValCapsule"),
      capsuleFill: document.getElementById("capsuleFill"),
      tmCounter: document.getElementById("tmCounter"),
      bmCounter: document.getElementById("bmCounter"),
      dCounter: document.getElementById("dCounter"),
      rCounter: document.getElementById("rCounter"),
      answerSource: document.getElementById("answerSource"),
      historyCount: document.getElementById("historyCount"),
      profileStatus: document.getElementById("profileStatus"),
      seedStatus: document.getElementById("seedStatus"),
      bmStatus: document.getElementById("bmStatus"),
      historyBox: document.getElementById("historyBox"),
      historyMeta: document.getElementById("historyMeta"),
      userInput: document.getElementById("userInput"),
      sendBtn: document.getElementById("sendBtn"),
      charCount: document.getElementById("charCount"),
      faithToggle: document.getElementById("faithToggle"),
      faithStatus: document.getElementById("faithStatus"),
      optionsPanel: document.getElementById("optionsPanel"),
      btnOptions: document.getElementById("btnOptions"),
      btnIdentity: document.getElementById("btnIdentity"),
      btnSeed: document.getElementById("btnSeed"),
      btnBM: document.getElementById("btnBM"),
      btnHistory: document.getElementById("btnHistory"),
      btnLLM: document.getElementById("btnLLM"),
      modalIdentity: document.getElementById("modalIdentity"),
      modalSeed: document.getElementById("modalSeed"),
      modalBM: document.getElementById("modalBM"),
      modalHistory: document.getElementById("modalHistory"),
      modalLLM: document.getElementById("modalLLM"),
      idName: document.getElementById("idName"),
      idTagline: document.getElementById("idTagline"),
      idLocation: document.getElementById("idLocation"),
      idLanguage: document.getElementById("idLanguage"),
      idValues: document.getElementById("idValues"),
      idGoals: document.getElementById("idGoals"),
      identityMeta: document.getElementById("identityMeta"),
      seedHi: document.getElementById("seedHi"),
      seedWho: document.getElementById("seedWho"),
      seedCreator: document.getElementById("seedCreator"),
      seedFaith: document.getElementById("seedFaith"),
      seedLogic: document.getElementById("seedLogic"),
      seedIncorrect: document.getElementById("seedIncorrect"),
      seedLock: document.getElementById("seedLock"),
      seedDecay: document.getElementById("seedDecay"),
      seedMeta: document.getElementById("seedMeta"),
      bmList: document.getElementById("bmList"),
      bmViewerTitle: document.getElementById("bmViewerTitle"),
      bmViewerMeta: document.getElementById("bmViewerMeta"),
      bmViewerBody: document.getElementById("bmViewerBody"),
      bmMeta: document.getElementById("bmMeta"),
      bmCountBadge: document.getElementById("bmCountBadge"),
      bmLockedBadge: document.getElementById("bmLockedBadge"),
      bmLiveBadge: document.getElementById("bmLiveBadge"),
      btnSaveIdentity: document.getElementById("btnSaveIdentity"),
      btnSaveSeed: document.getElementById("btnSaveSeed"),
      btnNewBM: document.getElementById("btnNewBM"),
      btnBMUse: document.getElementById("btnBMUse"),
      btnBMEdit: document.getElementById("btnBMEdit"),
      btnBMLock: document.getElementById("btnBMLock"),
      btnBMDelete: document.getElementById("btnBMDelete"),
      btnDeleteRecent: document.getElementById("btnDeleteRecent"),
      btnDeleteAllHist: document.getElementById("btnDeleteAllHist"),
      btnCopyHistory: document.getElementById("btnCopyHistory"),
      btnQuickHi: document.getElementById("btnQuickHi"),
      btnQuickWho: document.getElementById("btnQuickWho"),
      btnQuickCreator: document.getElementById("btnQuickCreator"),
      btnQuickFaith: document.getElementById("btnQuickFaith"),
      btnQuickLogic: document.getElementById("btnQuickLogic"),
      btnQuickBM: document.getElementById("btnQuickBM"),
      llmMeta: document.getElementById("llmMeta"),
      offlineModel: document.getElementById("offlineModel"),
      apiEndpoint: document.getElementById("apiEndpoint"),
      apiKey: document.getElementById("apiKey"),
      offlineMaxTokens: document.getElementById("offlineMaxTokens"),
      btnShareLast: document.getElementById("btnShareLast"),
      toastBubble: document.getElementById("toastBubble"),
      dreamOverlay: document.getElementById("dreamOverlay"),
      dreamTimeout: document.getElementById("dreamTimeout"),
      memoryFileInput: document.getElementById("memoryFileInput"),
      btnExportMemory: document.getElementById("btnExportMemory"),
      btnImportMemory: document.getElementById("btnImportMemory")
    };

    let state = {
      faithOn: true,
      metrics: {
        tm: 0,
        bm: 0,
        d: 0,
        r: 0,
        tmCount: 0,
        bmCount: 0,
        dCount: 0,
        rCount: 0
      },
      history: [],
      bmPrompts: [],
      userProfile: null,
      seed: null,
      logicRules: null,
      llmCfg: {
        offlineModel: "off",
        apiEndpoint: "",
        offlineMaxTokens: 512
      },
      lastAnswerSource: "seed/local",
      selectedBMId: null,
      dreamTimeoutMs: 0,
      dreamTimer: null,
      dreamInterval: null,
      bmSnapshots: [],
      lastActivityAt: Date.now()
    };

      function safeLoadJSON(key, fallback){
        try{
          const raw = localStorage.getItem(key);
          if(!raw) return fallback;
          return JSON.parse(raw);
        }catch{
          return fallback;
        }
      }

      function exportMemoryJson(){
        const payload = {
          version: "AURAX-1.0",
          exportedAt: new Date().toISOString(),
          user: safeLoadJSON(KEY_USER,null),
          intelligence: safeLoadJSON(KEY_INT,[]),
          bm: safeLoadJSON(KEY_BM,[]),
          cfg: safeLoadJSON(KEY_CFG,null),
          history: safeLoadJSON(KEY_HIST,[]),
          logic: safeLoadJSON(KEY_LOGIC,null)
        };
        const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "auraX_memory_" + new Date().toISOString().slice(0,10) + ".json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast("Memory exported as JSON file.");
      }

      function handleMemoryFileSelected(ev){
        const file = ev.target.files && ev.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e)=>{
          try{
            const data = JSON.parse(e.target.result);
            importMemoryJson(data);
            showToast("Memory imported. Reloading from local backup.");
            initFromStorage();
          }catch(err){
            console.error("Import failed", err);
            showToast("Import failed ‚Äì invalid JSON.");
          } finally {
            ev.target.value = "";
          }
        };
        reader.readAsText(file);
      }

      function importMemoryJson(data){
        if (!data || typeof data !== "object") return;
        if (data.user !== undefined) localStorage.setItem(KEY_USER, JSON.stringify(data.user));
        if (data.intelligence !== undefined) localStorage.setItem(KEY_INT, JSON.stringify(data.intelligence));
        if (data.bm !== undefined) localStorage.setItem(KEY_BM, JSON.stringify(data.bm));
        if (data.cfg !== undefined) localStorage.setItem(KEY_CFG, JSON.stringify(data.cfg));
        if (data.history !== undefined) localStorage.setItem(KEY_HIST, JSON.stringify(data.history));
        if (data.logic !== undefined) localStorage.setItem(KEY_LOGIC, JSON.stringify(data.logic));
      }

      function addBMSnapshot(longText){
        const text = (longText || "").trim();
        if (!text) return;
        state.bmSnapshots.push({
          id: "snap_" + Date.now(),
          text,
          createdAt: Date.now()
        });
        if (state.bmSnapshots.length > 64) {
          state.bmSnapshots = state.bmSnapshots.slice(-64);
        }
      }

      function performSystemDecay(){
        const m = state.metrics;
        const targetD = 0.35;
        m.d += (targetD - m.d) * 0.01;
        m.r = 1 - Math.min(1, (Math.abs(m.tm - m.bm) * 0.5 + m.d * 0.2));
        updateCapsule();
      }

      function showNextDreamSnippet(){
        const el = els.dreamOverlay;
        if (!el) return;
        const titleEl = el.querySelector(".dream-title");
        const snippetEl = el.querySelector(".dream-snippet");
        const hintEl = el.querySelector(".dream-hint");

        const pools = [];

        if (state.bmSnapshots && state.bmSnapshots.length){
          pools.push({type: "bm", list: state.bmSnapshots});
        }
        if (state.history && state.history.length){
          pools.push({type: "history", list: state.history});
        }

        if (!pools.length){
          titleEl.textContent = "Dreaming quietly‚Ä¶";
          snippetEl.textContent = "No BM or history yet. Share some stories with AURA-X Œ© so it has something meaningful to dream with.";
          hintEl.textContent = "Tip: long reflective messages automatically become BM snapshots for Dream Mode.";
          return;
        }

        const pool = pools[Math.floor(Math.random() * pools.length)];
        const list = pool.list;
        const rawItem = list[Math.floor(Math.random() * list.length)];

        let text = "";
        let heading = "";

        if (pool.type === "bm"){
          text = (rawItem.text || rawItem.prompt || rawItem.title || "").trim();
          heading = "Dreaming BM snapshot";
        } else {
          const who = rawItem.sender === "user" ? "You" : "AURA-X Œ©";
          text = (rawItem.text || rawItem.raw || "").trim();
          heading = "Dreaming conversation (" + who + ")";
        }

        if (!text){
          text = "[empty memory]";
        } else if (text.length > 520){
          text = text.slice(0, 500) + "‚Ä¶";
        }

        titleEl.textContent = heading;
        snippetEl.textContent = text;
        hintEl.textContent = "Soft decay running: noisy bits fade, core meaning stays available for future BM.";

        performSystemDecay();
      }

      function enterDreamMode(){
        if (!els.dreamOverlay || !state.dreamTimeoutMs) return;
        els.dreamOverlay.classList.add("active");
        state.dreamInterval = setInterval(showNextDreamSnippet, 9000);
        showNextDreamSnippet();
      }

      function leaveDreamMode(){
        if (!els.dreamOverlay) return;
        els.dreamOverlay.classList.remove("active");
        if (state.dreamInterval){
          clearInterval(state.dreamInterval);
          state.dreamInterval = null;
        }
      }

      function registerActivity(){
        state.lastActivityAt = Date.now();
        if (state.dreamTimer){
          clearTimeout(state.dreamTimer);
          state.dreamTimer = null;
        }
        if (state.dreamInterval){
          clearInterval(state.dreamInterval);
          state.dreamInterval = null;
        }
        if (els.dreamOverlay){
          els.dreamOverlay.classList.remove("active");
        }
        if (state.dreamTimeoutMs){
          state.dreamTimer = setTimeout(enterDreamMode, state.dreamTimeoutMs);
        }
      }

      function initDreamConfig(){
        const cfg = safeLoadJSON(KEY_CFG, null) || {};
        if (typeof cfg.dreamTimeoutMs === "number"){
          state.dreamTimeoutMs = cfg.dreamTimeoutMs;
        }
        if (els.dreamTimeout){
          if (!state.dreamTimeoutMs){
            els.dreamTimeout.value = "0";
          } else {
            const val = String(state.dreamTimeoutMs);
            const exists = Array.from(els.dreamTimeout.options).some(o => o.value === val);
            els.dreamTimeout.value = exists ? val : "300000";
            if (!exists){
              state.dreamTimeoutMs = 300000;
            }
          }
          els.dreamTimeout.addEventListener("change", () => {
            const raw = els.dreamTimeout.value;
            const next = parseInt(raw || "0", 10) || 0;
            state.dreamTimeoutMs = next;
            const cfgNow = safeLoadJSON(KEY_CFG, null) || {};
            cfgNow.dreamTimeoutMs = next;
            localStorage.setItem(KEY_CFG, JSON.stringify(cfgNow));
            registerActivity();
            showToast(next ? "Dream / screensaver timeout updated." : "Dream Mode turned off.");
          });
        }

        if (els.dreamOverlay){
          els.dreamOverlay.addEventListener("click", () => {
            leaveDreamMode();
            registerActivity();
          });
        }

        document.addEventListener("click", registerActivity, true);
        document.addEventListener("keydown", registerActivity, true);
        if (els.userInput){
          els.userInput.addEventListener("keydown", registerActivity);
        }
        if (els.sendBtn){
          els.sendBtn.addEventListener("click", registerActivity);
        }

        if (state.dreamTimeoutMs){
          state.dreamTimer = setTimeout(enterDreamMode, state.dreamTimeoutMs);
        }
      }

      function logLine(kind, msg, meta){
        const row = {
          ts: new Date().toISOString(),
          kind,
          text: msg,
          meta: meta || {}
        };
        state.history.push(row);
        if(state.history.length > 500){
          state.history = state.history.slice(-500);
        }
        renderLogLine(row);
        updateHistoryMeta();
      }

      function renderLogLine(row){
        const el = document.createElement("div");
        el.className = "logLine";
        const t = document.createElement("div");
        t.className = "logTime";
        t.textContent = row.ts.slice(11,19);
        const w = document.createElement("div");
        w.className = "logWho";
        w.textContent = row.kind.toUpperCase();
        const m = document.createElement("div");
        m.className = "logMsg";
        if(row.kind === "sys") m.classList.add("system");
        else if(row.kind === "meta") m.classList.add("meta");
        else if(row.kind === "err") m.classList.add("err");
        m.textContent = row.text;
        el.appendChild(t);
        el.appendChild(w);
        el.appendChild(m);
        els.chatLog.appendChild(el);
        els.chatLog.scrollTop = els.chatLog.scrollHeight + 100;
      }

      function updateCapsule(){
        const m = state.metrics;
        els.tmVal.textContent = m.tm.toFixed(2);
        els.bmVal.textContent = m.bm.toFixed(2);
        els.dVal.textContent = m.d.toFixed(2);
        els.rVal.textContent = m.r.toFixed(2);
        els.rValCapsule.textContent = m.r.toFixed(2);
        const w = Math.max(0, Math.min(100, m.r * 100));
        els.capsuleFill.style.width = w.toFixed(1) + "%";
        els.tmCounter.textContent = m.tmCount;
        els.bmCounter.textContent = m.bmCount;
        els.dCounter.textContent = m.dCount;
        els.rCounter.textContent = m.rCount;
      }

      function showToast(msg){
        const t = els.toastBubble;
        t.textContent = msg;
        t.classList.add("show");
        setTimeout(()=> t.classList.remove("show"), 2000);
      }

      function recomputeR(){
        const m = state.metrics;
        const delta = Math.abs(m.tm - m.bm);
        const base = 1 - (delta * 0.5 + m.d * 0.25);
        m.r = Math.max(0, Math.min(1, base));
        m.rCount++;
        updateCapsule();
      }

      function pushHistory(kind, text, source){
        const row = {
          ts: new Date().toISOString(),
          sender: kind,
          text,
          source: source || ""
        };
        state.history.push(row);
        if(state.history.length > 500){
          state.history = state.history.slice(-500);
        }
        updateHistoryMeta();
      }

      function updateHistoryMeta(){
        els.historyCount.textContent = state.history.length;
        els.historyMeta.textContent = state.history.length + " lines in local history.";
      }

      function renderHistoryBox(){
        const box = els.historyBox;
        box.innerHTML = "";
        state.history.forEach(row=>{
          const el = document.createElement("div");
          el.className = "historyRow";
          const meta = document.createElement("div");
          meta.className = "historyMeta";
          meta.textContent = row.ts.slice(0,10) + " " + row.ts.slice(11,19);
          const text = document.createElement("div");
          text.className = "historyText";
          text.textContent = "[" + row.sender + "] " + row.text;
          el.appendChild(meta);
          el.appendChild(text);
          box.appendChild(el);
        });
      }

      function handleSend(){
        const raw = els.userInput.value;
        const text = raw.trim();
        if(!text) return;

        registerActivity();
        if(text.length > 400){
          addBMSnapshot(text);
        }

        els.userInput.value = "";
        els.charCount.textContent = "0";

        state.metrics.tmCount++;
        state.metrics.tm = Math.min(1, state.metrics.tm + Math.min(0.08, text.length / 1200));
        state.metrics.d = Math.max(0, state.metrics.d - 0.01);
        recomputeR();

        renderUserMessage(text);
        routeAnswer(text);
      }

      function renderUserMessage(text){
        const row = {
          ts: new Date().toISOString(),
          sender: "user",
          text
        };
        state.history.push(row);
        renderLogLine({ts: row.ts, kind:"user", text, meta:{}});
        updateHistoryMeta();
      }

      function routeAnswer(text){
        const seed = state.seed || {};
        const tLower = text.toLowerCase();
        let answer = "";
        let source = "seed/local";

        if(seed.hi && /hi|hello|salam|salaam|assalam/.test(tLower)){
          answer = seed.hi;
        }else if(seed.who && tLower.includes("who are you")){
          answer = seed.who;
        }else if(seed.creator && (tLower.includes("who created you") || tLower.includes("creator"))){
          answer = seed.creator;
        }

        if(!answer && seed.logic){
          answer = seed.logic;
          source = "logic rule (fallback)";
        }

        if(!answer){
          answer = "Local seed & intelligence have no perfect answer yet. In future, offline LLM / API will answer here.";
          source = "offline-llm-demo";
        }

        state.lastAnswerSource = source;
        els.answerSource.textContent = source;
        renderAuraAnswer(answer, source);
      }

      function renderAuraAnswer(text, source){
        const row = {
          ts: new Date().toISOString(),
          sender: "aura",
          text,
          source
        };
        state.history.push(row);
        renderLogLine({ts: row.ts, kind:"aura", text: text + " (source: " + source + ")", meta:{}});
        updateHistoryMeta();

        state.metrics.bm = Math.min(1, state.metrics.bm + 0.02);
        state.metrics.d = Math.min(1, state.metrics.d + 0.01);
        recomputeR();
      }

      function openModal(id){
        const el = els[id];
        if(!el) return;
        el.classList.add("open");
      }

      function closeModal(id){
        const el = els[id];
        if(!el) return;
        el.classList.remove("open");
      }

      function loadUser(){
        const obj = safeLoadJSON(KEY_USER, null);
        state.userProfile = obj;
        if(obj){
          els.idName.value = obj.name || "";
          els.idTagline.value = obj.tagline || "";
          els.idLocation.value = obj.location || "";
          els.idLanguage.value = obj.language || "";
          els.idValues.value = obj.values || "";
          els.idGoals.value = obj.goals || "";
          els.profileStatus.textContent = obj.name || "Saved";
          els.identityMeta.textContent = "Saved at " + (obj.savedAt || "");
        }else{
          els.profileStatus.textContent = "Empty";
          els.identityMeta.textContent = "No identity saved yet.";
        }
      }

      function saveUser(){
        const obj = {
          name: els.idName.value.trim(),
          tagline: els.idTagline.value.trim(),
          location: els.idLocation.value.trim(),
          language: els.idLanguage.value.trim(),
          values: els.idValues.value.trim(),
          goals: els.idGoals.value.trim(),
          savedAt: new Date().toISOString()
        };
        state.userProfile = obj;
        localStorage.setItem(KEY_USER, JSON.stringify(obj));
        els.profileStatus.textContent = obj.name || "Saved";
        els.identityMeta.textContent = "Saved at " + obj.savedAt;
        showToast("Identity saved locally.");
      }

      function loadSeed(){
        const obj = safeLoadJSON(KEY_SEED, null);
        state.seed = obj;
        if(obj){
          els.seedHi.value = obj.hi || "";
          els.seedWho.value = obj.who || "";
          els.seedCreator.value = obj.creator || "";
          els.seedFaith.value = obj.faith || "";
          els.seedLogic.value = obj.logic || "";
          els.seedIncorrect.value = obj.incorrect || "";
          els.seedLock.value = obj.lock || "";
          els.seedDecay.value = obj.decay || "";
          const count = ["hi","who","creator","faith","logic","incorrect","lock","decay"]
            .filter(k=> (obj[k]||"").trim().length>0).length;
          els.seedStatus.textContent = count + " items";
          els.seedMeta.textContent = "Seed last saved at " + (obj.savedAt || "");
        }else{
          els.seedStatus.textContent = "0 Q&A";
          els.seedMeta.textContent = "No seed saved yet.";
        }
      }

      function saveSeed(){
        const obj = {
          hi: els.seedHi.value.trim(),
          who: els.seedWho.value.trim(),
          creator: els.seedCreator.value.trim(),
          faith: els.seedFaith.value.trim(),
          logic: els.seedLogic.value.trim(),
          incorrect: els.seedIncorrect.value.trim(),
          lock: els.seedLock.value.trim(),
          decay: els.seedDecay.value.trim(),
          savedAt: new Date().toISOString()
        };
        state.seed = obj;
        localStorage.setItem(KEY_SEED, JSON.stringify(obj));
        const count = ["hi","who","creator","faith","logic","incorrect","lock","decay"]
          .filter(k=> (obj[k]||"").length>0).length;
        els.seedStatus.textContent = count + " items";
        els.seedMeta.textContent = "Seed updated at " + obj.savedAt;
        showToast("Seed rules saved.");
      }

      function loadBM(){
        const arr = safeLoadJSON(KEY_BM, []);
        state.bmPrompts = Array.isArray(arr) ? arr : [];
        renderBMList();
      }

      function renderBMList(){
        const list = els.bmList;
        list.innerHTML = "";
        const arr = state.bmPrompts;
        els.bmStatus.textContent = arr.length + " stories";
        els.bmCountBadge.textContent = arr.length + " total";
        const locked = arr.filter(x=>x.locked).length;
        els.bmLockedBadge.textContent = locked + " locked";
        const live = arr.filter(x=> !x.locked).length;
        els.bmLiveBadge.textContent = live + " live";

        arr.forEach(item=>{
          const el = document.createElement("div");
          el.className = "bmItem" + (state.selectedBMId === item.id ? " active" : "");
          el.dataset.id = item.id;
          const t = document.createElement("div");
          t.className = "bmItemTitle";
          t.textContent = item.title || "(untitled)";
          const meta = document.createElement("div");
          meta.className = "bmItemMeta";
          meta.innerHTML = "<span>" + (item.locked ? "üîí Locked" : "Live") + "</span><span>" + (item.savedAt||"") + "</span>";
          el.appendChild(t);
          el.appendChild(meta);
          el.addEventListener("click", ()=>{
            state.selectedBMId = item.id;
            renderBMList();
            showBMDetail(item.id);
          });
          list.appendChild(el);
        });

        if(arr.length === 0){
          els.bmViewerTitle.textContent = "No BM selected";
          els.bmViewerBody.textContent = "Add a long-form BM story. This should be rich enough to recreate scene or mood (photo / video ready).";
          els.bmViewerMeta.textContent = "";
        }
      }

      function showBMDetail(id){
        const item = state.bmPrompts.find(x=>x.id === id);
        if(!item){
          els.bmViewerTitle.textContent = "No BM selected";
          els.bmViewerBody.textContent = "";
          els.bmViewerMeta.textContent = "";
          return;
        }
        els.bmViewerTitle.textContent = item.title || "(untitled)";
        els.bmViewerBody.textContent = item.text || "";
        els.bmViewerMeta.textContent = (item.locked ? "üîí Locked. " : "Live. ") + (item.savedAt ? "Saved at "+item.savedAt : "");
        els.bmMeta.textContent = "BM id: " + item.id;
      }

      function saveBM(item){
        const arr = state.bmPrompts.slice();
        const idx = arr.findIndex(x=>x.id === item.id);
        if(idx>=0) arr[idx] = item;
        else arr.push(item);
        state.bmPrompts = arr;
        localStorage.setItem(KEY_BM, JSON.stringify(arr));
        renderBMList();
        showBMDetail(item.id);
        state.metrics.bmCount++;
        state.metrics.bm = Math.min(1, state.metrics.bm + 0.05);
        recomputeR();
      }

      function newBM(){
        const title = prompt("BM title (long-form story):","");
        if(!title) return;
        const text = prompt("Paste or write your long story (photo/video-ready detail):","");
        if(!text) return;
        const item = {
          id: "bm_" + Date.now(),
          title,
          text,
          locked:false,
          savedAt:new Date().toISOString()
        };
        saveBM(item);
      }

      function toggleBMLock(){
        const id = state.selectedBMId;
        if(!id) return;
        const item = state.bmPrompts.find(x=>x.id===id);
        if(!item) return;
        item.locked = !item.locked;
        item.savedAt = new Date().toISOString();
        saveBM(item);
      }

      function deleteBM(){
        const id = state.selectedBMId;
        if(!id) return;
        if(!confirm("Delete this BM story?")) return;
        const arr = state.bmPrompts.filter(x=>x.id!==id);
        state.bmPrompts = arr;
        localStorage.setItem(KEY_BM, JSON.stringify(arr));
        state.selectedBMId = null;
        renderBMList();
        els.bmViewerTitle.textContent = "No BM selected";
        els.bmViewerBody.textContent = "";
        els.bmViewerMeta.textContent = "";
      }

      function useBMInNextAnswer(){
        const id = state.selectedBMId;
        if(!id) return;
        const item = state.bmPrompts.find(x=>x.id===id);
        if(!item) return;
        const prefix = "[BM context] " + (item.title || "") + " ‚Üí ";
        els.userInput.value = prefix + els.userInput.value;
        els.userInput.focus();
        els.userInput.setSelectionRange(els.userInput.value.length, els.userInput.value.length);
        els.charCount.textContent = String(els.userInput.value.length);
        showToast("BM context injected into next user message.");
      }

      function toggleFaith(){
        state.faithOn = !state.faithOn;
        els.faithStatus.textContent = state.faithOn ? "Faith ON" : "Faith OFF";
        const badge = els.faithToggle.querySelector(".faithBadge");
        if(state.faithOn){
          badge.style.opacity = "1";
        }else{
          badge.style.opacity = "0.4";
        }
        const cfg = safeLoadJSON(KEY_CFG,null) || {};
        cfg.faithOn = state.faithOn;
        localStorage.setItem(KEY_CFG, JSON.stringify(cfg));
      }

      function loadCfg(){
        const cfg = safeLoadJSON(KEY_CFG,null) || {};
        if(typeof cfg.faithOn === "boolean"){
          state.faithOn = cfg.faithOn;
        }
        els.faithStatus.textContent = state.faithOn ? "Faith ON" : "Faith OFF";
        const badge = els.faithToggle.querySelector(".faithBadge");
        badge.style.opacity = state.faithOn ? "1" : "0.4";

        const llm = cfg.llmCfg || {};
        state.llmCfg.offlineModel = llm.offlineModel || "off";
        state.llmCfg.apiEndpoint = llm.apiEndpoint || "";
        state.llmCfg.offlineMaxTokens = llm.offlineMaxTokens || 512;
        els.offlineModel.value = state.llmCfg.offlineModel;
        els.apiEndpoint.value = state.llmCfg.apiEndpoint;
        els.offlineMaxTokens.value = state.llmCfg.offlineMaxTokens;
        els.llmMeta.textContent = "LLM may be used only as final fallback. Current: " + (state.llmCfg.offlineModel || "off");
      }

      function saveLLMCfg(){
        state.llmCfg.offlineModel = els.offlineModel.value;
        state.llmCfg.apiEndpoint = els.apiEndpoint.value.trim();
        state.llmCfg.offlineMaxTokens = parseInt(els.offlineMaxTokens.value||"512",10);
        const cfg = safeLoadJSON(KEY_CFG,null) || {};
        cfg.llmCfg = state.llmCfg;
        localStorage.setItem(KEY_CFG, JSON.stringify(cfg));
        els.llmMeta.textContent = "LLM config updated.";
        showToast("LLM config saved.");
      }

      function loadHistory(){
        const arr = safeLoadJSON(KEY_HIST, []);
        if(Array.isArray(arr)) state.history = arr;
        else state.history = [];
        updateHistoryMeta();
      }

      function saveHistory(){
        localStorage.setItem(KEY_HIST, JSON.stringify(state.history));
      }

      function deleteRecentHistory(){
        const cutoff = Date.now() - 48*60*60*1000;
        state.history = state.history.filter(row=>{
          const t = Date.parse(row.ts || "");
          if(isNaN(t)) return true;
          return t < cutoff;
        });
        updateHistoryMeta();
        renderHistoryBox();
        saveHistory();
        showToast("Recent 48h history deleted.");
      }

      function deleteAllHistory(){
        if(!confirm("Delete all conversation history?")) return;
        state.history = [];
        updateHistoryMeta();
        renderHistoryBox();
        saveHistory();
        showToast("All history cleared.");
      }

      function copyHistory(){
        const text = state.history.map(row=> (row.ts||"") + " [" + (row.sender||"") + "] " + (row.text||"")).join("\n");
        navigator.clipboard.writeText(text).then(()=>{
          showToast("History copied");
        }).catch(()=>{
          showToast("Copy failed");
        });
      }

      function initFromStorage(){
        loadUser();
        loadSeed();
        loadBM();
        loadCfg();
        loadHistory();
        renderHistoryBox();
        updateCapsule();

        els.chatLog.innerHTML = "";
        logLine("sys","AURA-X Œ© ready. TM = your inputs only; everything else stays on this device.",{});
      }

      els.sendBtn.addEventListener("click", handleSend);
      els.userInput.addEventListener("keydown",(e)=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          handleSend();
        }
      });
      els.userInput.addEventListener("input",()=>{
        els.charCount.textContent = String(els.userInput.value.length);
      });

      els.btnOptions.addEventListener("click",()=>{
        els.optionsPanel.classList.toggle("open");
      });
      document.addEventListener("click",(e)=>{
        if(!els.optionsPanel.contains(e.target) && e.target !== els.btnOptions){
          els.optionsPanel.classList.remove("open");
        }
      });

      document.querySelectorAll(".optionsPanel [data-open]").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const id = btn.getAttribute("data-open");
          if(id) openModal(id);
        });
      });
      document.querySelectorAll("[data-close]").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const id = btn.getAttribute("data-close");
          if(id) closeModal(id);
        });
      });

      els.btnIdentity.addEventListener("click",()=> openModal("modalIdentity"));
      els.btnSeed.addEventListener("click",()=> openModal("modalSeed"));
      els.btnBM.addEventListener("click",()=> openModal("modalBM"));
      els.btnHistory.addEventListener("click",()=> openModal("modalHistory"));
      els.btnLLM.addEventListener("click",()=> openModal("modalLLM"));

      els.btnSaveIdentity.addEventListener("click", saveUser);
      els.btnSaveSeed.addEventListener("click", saveSeed);
      els.btnNewBM.addEventListener("click", newBM);
      els.btnBMLock.addEventListener("click", toggleBMLock);
      els.btnBMDelete.addEventListener("click", deleteBM);
      els.btnBMUse.addEventListener("click", useBMInNextAnswer);

      els.btnDeleteRecent.addEventListener("click", deleteRecentHistory);
      els.btnDeleteAllHist.addEventListener("click", deleteAllHistory);
      els.btnCopyHistory.addEventListener("click", copyHistory);
      els.btnExportMemory.addEventListener("click", exportMemoryJson);
      els.btnImportMemory.addEventListener("click", ()=> {
        els.memoryFileInput.click();
      });
      els.memoryFileInput.addEventListener("change", handleMemoryFileSelected);

      els.faithToggle.addEventListener("click", toggleFaith);

      els.btnQuickHi.addEventListener("click",()=>{
        els.userInput.value = "Hi AURA, how are you feeling today about us?";
        els.userInput.focus();
        els.charCount.textContent = String(els.userInput.value.length);
      });
      els.btnQuickWho.addEventListener("click",()=>{
        els.userInput.value = "Who are you?";
        els.userInput.focus();
        els.charCount.textContent = String(els.userInput.value.length);
      });
      els.btnQuickCreator.addEventListener("click",()=>{
        els.userInput.value = "Who created you?";
        els.userInput.focus();
        els.charCount.textContent = String(els.userInput.value.length);
      });
      els.btnQuickFaith.addEventListener("click",()=>{
        if(!state.faithOn) toggleFaith();
        els.userInput.value = "Explain this with faith lens ON: " + els.userInput.value;
        els.userInput.focus();
        els.charCount.textContent = String(els.userInput.value.length);
      });
      els.btnQuickLogic.addEventListener("click",()=>{
        if(state.faithOn) toggleFaith();
        els.userInput.value = "Explain this with pure logic only: " + els.userInput.value;
        els.userInput.focus();
        els.charCount.textContent = String(els.userInput.value.length);
      });
      els.btnQuickBM.addEventListener("click",()=>{
        openModal("modalBM");
      });

      els.offlineModel.addEventListener("change", saveLLMCfg);
      els.apiEndpoint.addEventListener("change", saveLLMCfg);
      els.offlineMaxTokens.addEventListener("change", saveLLMCfg);

      window.addEventListener("beforeunload", saveHistory);

      initFromStorage();
      initDreamConfig();

      logLine("sys","AURA-X Œ© ready. TM = your inputs only; everything else stays on this device.",{});
  </script>
</body>
</html>