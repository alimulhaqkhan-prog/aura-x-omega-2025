<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#e0f2ff 0,#f5f7fb 40%,#eef1f7 100%);
      color:#0f172a;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:20px;
    }
    .app{
      width:100%;
      max-width:1100px;
      background:#ffffffee;
      border-radius:24px;
      box-shadow:0 24px 60px rgba(15,23,42,.15);
      padding:20px 22px 12px;
      display:flex;
      flex-direction:column;
      gap:14px;
      border:1px solid #e2e8f0;
    }

    /* HEADER --------------------------------------------------- */
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      padding:10px 14px 6px;
      border-bottom:1px solid #e5e7eb;
    }
    .title-block h1{
      font-size:1.9rem;
      letter-spacing:0.08em;
      color:#0f172a;
      text-transform:uppercase;
    }
    .title-block h1 span{
      background:linear-gradient(90deg,#2563eb,#06b6d4);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      font-weight:800;
    }
    .hero-line{
      margin-top:4px;
      font-size:.9rem;
      color:#475569;
      font-weight:500;
    }
    .title-sub{
      font-size:.8rem;
      color:#94a3b8;
      margin-top:3px;
    }
    .badge-row{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
    }
    .ethics-pill{
      font-size:.78rem;
      padding:7px 13px;
      border-radius:999px;
      border:1px solid #facc15;
      background:#fffdf4;
      box-shadow:0 10px 28px rgba(250,204,21,.28);
    }
    .ethics-pill-text{
      background:linear-gradient(90deg,#facc15,#f59e0b,#f97316);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      font-weight:700;
    }

    .header-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
    }
    .mode-pill{
      padding:7px 13px;
      border-radius:999px;
      background:linear-gradient(90deg,#16a34a,#22c55e);
      color:#ecfdf3;
      font-size:.78rem;
      font-weight:600;
      box-shadow:0 10px 26px rgba(16,185,129,.4);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .mode-dot{
      width:8px;height:8px;border-radius:999px;
      background:#bbf7d0;
      box-shadow:0 0 0 5px rgba(52,211,153,.2);
    }
    .voice-toggle{
      border:none;
      padding:5px 11px;
      border-radius:999px;
      font-size:.78rem;
      background:#eff6ff;
      color:#1e3a8a;
      border:1px solid #bfdbfe;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .voice-toggle:hover{background:#e0edff;}

    /* LAYOUT --------------------------------------------------- */
    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
      gap:18px;
      margin-top:4px;
    }
    .left-col,.right-col{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .card{
      background:#f9fafb;
      border-radius:18px;
      padding:16px 16px 14px;
      border:1px solid #e5e7eb;
      box-shadow:0 10px 25px rgba(148,163,184,.16);
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .card-title{
      font-size:.95rem;
      font-weight:600;
      color:#0f172a;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .card-title span.emoji{font-size:1.1rem;}
    .card-sub{font-size:.75rem;color:#94a3b8;}

    /* METRICS -------------------------------------------------- */
    .metrics-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      margin-top:4px;
    }
    .metric{
      background:#ffffff;
      border-radius:12px;
      padding:10px 10px 9px;
      border:1px solid #e5e7eb;
    }
    .metric-label{font-size:.7rem;color:#64748b;margin-bottom:4px;}
    .metric-value{font-size:1.1rem;font-weight:700;color:#1d4ed8;}
    .metric-note{font-size:.7rem;color:#9ca3af;margin-top:2px;}

    .status-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
      font-size:.72rem;
      color:#6b7280;
    }
    .tag{
      padding:4px 8px;
      border-radius:999px;
      background:#e5f4ff;
      color:#1e3a8a;
      border:1px solid #bfdbfe;
      font-size:.68rem;
    }

    /* BM CARD -------------------------------------------------- */
    .bm-wrapper{margin-top:8px;}
    .bm-canvas-shell{
      background:radial-gradient(circle at top,#e0f2fe 0,#eff6ff 60%,#e2e8f0 100%);
      border-radius:12px;
      border:1px solid #dbeafe;
      height:150px;
      overflow:hidden;
      position:relative;
      cursor:pointer;
    }
    #bmCanvas{width:100%;height:100%;display:block;}
    .bm-footer{
      font-size:.72rem;
      color:#6b7280;
      margin-top:6px;
      text-align:center;
    }
    .bm-overlay-btn{
      position:absolute;
      top:6px;
      width:26px;height:26px;
      border-radius:999px;
      border:none;
      font-size:.9rem;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      background:#f9fafbcc;
      box-shadow:0 6px 14px rgba(15,23,42,.25);
    }
    .bm-overlay-btn.left{left:8px;}
    .bm-overlay-btn.right{right:8px;}
    .bm-overlay-btn:hover{background:#e5f0ff;}

    /* ANSWER CONSOLE ------------------------------------------- */
    .answer-card .card-header{margin-bottom:6px;}
    .answer-shell{margin-top:4px;}
    .answer-box{
      background:#020617;
      border-radius:12px;
      padding:10px 10px 12px;
      border:1px solid #020617;
      font-family:"Courier New",monospace;
      color:#e5e7eb;
      box-shadow:0 16px 40px rgba(15,23,42,.65);
      max-height:190px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .equation-header{
      font-size:.75rem;
      color:#60a5fa;
      font-weight:600;
      letter-spacing:.05em;
      text-transform:uppercase;
    }
    .equation-divider{
      height:1px;
      background:linear-gradient(90deg,rgba(148,163,184,.2),rgba(15,23,42,0),rgba(148,163,184,.2));
      margin:2px 0 4px;
    }
    .chat-container{
      background:transparent;
      border:none;
      padding:0;
      height:auto;
      max-height:150px;
      overflow-y:auto;
    }
    .message{
      max-width:100%;
      padding:6px 7px;
      margin-bottom:6px;
      border-radius:8px;
      font-size:.8rem;
      line-height:1.5;
      position:relative;
      animation:fadeIn .2s ease-out;
      white-space:pre-wrap;
    }
    .message-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:3px;
      font-size:.7rem;
      color:#9ca3af;
      gap:6px;
    }
    .msg-right{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .voice-btn{
      border:none;
      border-radius:999px;
      padding:1px 6px;
      font-size:.7rem;
      cursor:pointer;
      background:#1f2937;
      color:#e5e7eb;
    }
    .voice-btn:hover{background:#111827;}
    .ai-message{
      background:#020617;
      border-bottom-left-radius:3px;
      border:1px solid #111827;
    }
    .user-message{
      background:#020617;
      border-bottom-right-radius:3px;
      border:1px solid #1f2937;
    }
    .message-content{color:#e5e7eb;}

    .typing-indicator{
      display:flex;
      align-items:center;
      gap:4px;
      background:#020617;
      border-radius:999px;
      padding:4px 8px;
      width:fit-content;
      margin:6px 0 2px;
      border:1px solid #111827;
    }
    .typing-dot{
      width:5px;height:5px;border-radius:999px;
      background:#38bdf8;
      animation:typing 1.2s infinite;
    }
    .typing-dot:nth-child(2){animation-delay:.18s}
    .typing-dot:nth-child(3){animation-delay:.36s}
    .typing-text{font-size:.7rem;color:#38bdf8;font-weight:500;}

    /* REACTION & RECALL BUBBLES ------------------------------- */
    .reaction-bubble{
      position:fixed;
      right:22px;
      bottom:84px;
      max-width:260px;
      background:#0f172acc;
      color:#e5e7eb;
      padding:10px 12px;
      border-radius:16px 16px 2px 16px;
      font-size:.78rem;
      box-shadow:0 18px 45px rgba(15,23,42,.6);
      display:flex;
      gap:8px;
      align-items:flex-start;
      opacity:0;
      transform:translateY(8px);
      pointer-events:none;
      transition:opacity .25s ease-out,transform .25s ease-out;
      z-index:40;
    }
    .reaction-bubble.visible{
      opacity:1;
      transform:translateY(0);
      pointer-events:auto;
    }
    .reaction-icon{font-size:1.1rem;margin-top:2px;}
    .reaction-label{font-weight:600;margin-bottom:2px;}
    .reaction-body{font-size:.76rem;color:#cbd5f5;}

    .recall-bubble-container{
      position:fixed;
      left:22px;
      bottom:86px;
      z-index:35;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .recall-bubble{
      max-width:280px;
      background:#f9fafb;
      border-radius:16px 16px 16px 2px;
      border:1px solid #e5e7eb;
      padding:9px 11px;
      font-size:.78rem;
      box-shadow:0 18px 40px rgba(148,163,184,.45);
      cursor:pointer;
      opacity:0;
      transform:translateY(8px);
      transition:opacity .3s ease-out,transform .3s ease-out,background .2s;
    }
    .recall-bubble.visible{
      opacity:1;
      transform:translateY(0);
    }
    .recall-bubble:hover{background:#eff6ff;}
    .recall-title{font-weight:600;font-size:.76rem;color:#1e293b;margin-bottom:2px;}
    .recall-body{color:#4b5563;margin-bottom:3px;}
    .recall-meta{font-size:.68rem;color:#9ca3af;}

    /* MODALS --------------------------------------------------- */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
      backdrop-filter:blur(6px);
    }
    .modal-overlay.visible{display:flex;}
    .modal-card{
      background:#f9fafb;
      border-radius:18px;
      width:min(640px,96vw);
      max-height:80vh;
      box-shadow:0 24px 60px rgba(15,23,42,.6);
      border:1px solid #e5e7eb;
      display:flex;
      flex-direction:column;
    }
    .modal-header{
      padding:10px 14px 8px;
      border-bottom:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .modal-title{
      font-size:.9rem;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
      color:#0f172a;
    }
    .modal-sub{font-size:.7rem;color:#94a3b8;margin-top:2px;}
    .modal-close{
      border:none;
      background:transparent;
      font-size:.9rem;
      cursor:pointer;
      color:#6b7280;
      padding:4px 6px;
    }
    .modal-body{
      padding:10px 14px 12px;
      overflow-y:auto;
      font-size:.8rem;
    }
    .modal-search{
      width:100%;
      padding:7px 9px;
      border-radius:10px;
      border:1px solid #cbd5f5;
      font-size:.78rem;
      margin:8px 0 10px;
      outline:none;
      background:#ffffff;
    }
    .modal-search:focus{
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,.25);
    }
    .bm-item{
      background:#ffffff;
      border-radius:12px;
      padding:7px 8px 8px;
      border:1px solid #e5e7eb;
      margin-bottom:8px;
    }
    .bm-item-header{
      display:flex;
      justify-content:space-between;
      font-size:.7rem;
      color:#64748b;
      margin-bottom:4px;
      gap:6px;
    }
    .bm-item-text{
      color:#111827;
      margin-bottom:6px;
      font-size:.78rem;
    }
    .bm-item-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .btn-mini{
      font-size:.7rem;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #dbeafe;
      background:#eff6ff;
      cursor:pointer;
      color:#1d4ed8;
    }
    .btn-mini:hover{background:#e0edff;}
    .btn-danger{
      border-color:#fecaca!important;
      background:#fee2e2!important;
      color:#b91c1c!important;
    }
    .btn-danger:hover{background:#fecaca!important;}

    .conv-item{
      background:#ffffff;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:7px 8px;
      margin-bottom:7px;
      font-size:.78rem;
    }
    .conv-header{
      display:flex;
      justify-content:space-between;
      color:#64748b;
      font-size:.7rem;
      margin-bottom:3px;
      gap:8px;
    }
    .conv-text{color:#111827;}
    .conv-controls{
      display:flex;
      justify-content:flex-end;
      gap:6px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .conv-btn{
      font-size:.7rem;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#f3f4f6;
      cursor:pointer;
      color:#374151;
    }
    .conv-btn:hover{background:#e5e7eb;}

    /* INPUT AREA ----------------------------------------------- */
    .input-footer{
      margin-top:6px;
      padding-top:6px;
      border-top:1px solid #e5e7eb;
    }
    .tm-formula-row{
      display:flex;
      justify-content:center;
      margin-bottom:6px;
    }
    .tm-formula-pill{
      font-size:.78rem;
      padding:5px 12px;
      border-radius:999px;
      background:#eef2ff;
      border:1px solid #c7d2fe;
      color:#4338ca;
      font-family:"Courier New",monospace;
    }
    .input-row{
      display:flex;
      justify-content:center;
    }
    .input-shell{
      display:flex;
      align-items:center;
      width:100%;
      max-width:640px;
      gap:8px;
      background:transparent;
      border:none;
      box-shadow:none;
    }
    .message-input{
      flex:1;
      resize:none;
      min-height:52px;
      max-height:110px;
      padding:10px 14px;
      border-radius:999px;
      border:none;              /* ⁄©Ÿàÿ¶€å vertical | border ŸÜ€Å€å⁄∫ */
      outline:none;
      font-size:.9rem;
      background:#ffffff;
      box-shadow:0 8px 18px rgba(148,163,184,.25);
      caret-color:#111827;
    }
    .send-button{
      border:none;
      padding:0 22px;
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:white;
      font-weight:600;
      font-size:.9rem;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
      border-radius:999px;
      box-shadow:0 8px 18px rgba(34,197,94,.4);
    }
    .send-button:hover{filter:brightness(1.05);}

    .flow-caption{
      margin-top:4px;
      text-align:center;
      font-size:.7rem;
      color:#9ca3af;
    }

    /* ANIMATIONS + RESPONSIVE --------------------------------- */
    @keyframes fadeIn{
      from{opacity:0;transform:translateY(6px)}
      to{opacity:1;transform:translateY(0)}
    }
    @keyframes typing{
      0%,60%,100%{transform:translateY(0);opacity:.4}
      30%{transform:translateY(-4px);opacity:1}
    }
    @media(max-width:900px){
      .layout{grid-template-columns:1fr}
      .card{padding:14px 12px 14px}
      .answer-box{max-height:210px;}
      .input-shell{max-width:100%;}
    }
  </style>
</head>
<body>
<div class="app">
  <header class="header">
    <div class="title-block">
      <h1><span>AURA-X Œ©</span></h1>
      <div class="hero-line">World‚Äôs first synthetic emotions engine (prototype)</div>
      <div class="title-sub">Emotional continuity ¬∑ dual memory ¬∑ synthetic reactions ¬∑ fully offline demo</div>
      <div class="badge-row">
        <div class="ethics-pill">
          <span class="ethics-pill-text">
            Universal ethic: avoid actions that create negative emotion in you or others, and gently move toward actions that create positivity for everyone.
          </span>
        </div>
      </div>
    </div>
    <div class="header-right">
      <div class="mode-pill">
        <div class="mode-dot"></div>
        <span>EMOTIONAL CONTINUITY ENGINE ACTIVE</span>
      </div>
      <button id="voiceToggle" class="voice-toggle">üîà Voice: OFF</button>
    </div>
  </header>

  <main class="layout">
    <!-- LEFT COLUMN: metrics + BM -->
    <div class="left-col">
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß™</span><span>Emotional Metrics</span></div>
            <div class="card-sub">Synthetic state computed from TM ‚Üî BM resonance.</div>
          </div>
        </div>
        <div class="metrics-grid">
          <div class="metric">
            <div class="metric-label">Emotional state E‚ÇÄ</div>
            <div id="metricE0" class="metric-value">0.00</div>
            <div class="metric-note">tanh-based, range [-1, +1]</div>
          </div>
          <div class="metric">
            <div class="metric-label">TM activation</div>
            <div id="metricTM" class="metric-value">0.00</div>
            <div class="metric-note">Recent temporary memories</div>
          </div>
          <div class="metric">
            <div class="metric-label">BM resonance</div>
            <div id="metricBM" class="metric-value">0.00</div>
            <div class="metric-note">Stored emotional events</div>
          </div>
          <div class="metric">
            <div class="metric-label">Continuity index</div>
            <div id="metricCI" class="metric-value">0.80</div>
            <div class="metric-note">Stability of emotional trajectory</div>
          </div>
        </div>
        <div class="status-row">
          <span id="tagValence" class="tag">VALENCE: neutral</span>
          <span id="tagArousal" class="tag">AROUSAL: medium</span>
          <span id="tagReaction" class="tag">REACTION: balanced</span>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üß†</span><span>Bold Memory Layers (240)</span></div>
            <div class="card-sub">Grouped into medical-style emotional bands with tiny neuron-stars.</div>
          </div>
        </div>
        <div class="bm-wrapper">
          <div class="bm-canvas-shell" id="bmShell">
            <button class="bm-overlay-btn left" id="bmOpenModal" title="Recall from BM">üìÅ</button>
            <button class="bm-overlay-btn right" id="convOpenModal" title="View conversations">‚óé</button>
            <canvas id="bmCanvas"></canvas>
          </div>
          <div id="bmStats" class="bm-footer">
            Active layers: 0/240 ¬∑ Pain:‚Äì ¬∑ Fear:‚Äì ¬∑ Love:‚Äì ¬∑ Identity:‚Äì ¬∑ Belief:‚Äì ¬∑ Hope:‚Äì ¬∑ Wisdom:‚Äì
          </div>
        </div>
      </section>
    </div>

    <!-- RIGHT COLUMN: console -->
    <div class="right-col">
      <section class="card answer-card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="emoji">üí¨</span><span>Emotional Continuity Console</span></div>
            <div class="card-sub">AURA-X Œ© answers + internal equations (hidden) in one box.</div>
          </div>
          <div class="card-sub">Offline ¬∑ English only ¬∑ No small-talk in BM.</div>
        </div>
        <div class="answer-shell">
          <div class="answer-box">
            <div class="equation-header">AURA-X Œ© SYNTHETIC EMOTION CONSOLE</div>
            <div class="equation-divider"></div>
            <div id="chatContainer" class="chat-container"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- TM + INPUT -->
  <footer class="input-footer">
    <div class="tm-formula-row">
      <div class="tm-formula-pill">TM = Œ£(User Inputs) + (Seed + LLM)</div>
    </div>
    <div class="input-row">
      <div class="input-shell">
        <textarea id="messageInput" class="message-input" placeholder="Write anything‚Ä¶  AURA-X Œ© will treat it as TM (Temporary Memory)."></textarea>
        <button id="sendButton" class="send-button">Send</button>
      </div>
    </div>
    <div class="flow-caption">Prototype flow: TM ‚Üí analysis ‚Üí hidden equations ‚Üí BM save ‚Üí reaction.</div>
  </footer>
</div>

<!-- REACTION & RECALL BUBBLES -->
<div id="reactionBubble" class="reaction-bubble">
  <div class="reaction-icon">üí≠</div>
  <div>
    <div id="reactionLabel" class="reaction-label">Reaction</div>
    <div id="reactionText" class="reaction-body">‚Ä¶</div>
  </div>
</div>

<div class="recall-bubble-container">
  <div id="recallBubble" class="recall-bubble">
    <div class="recall-title" id="recallTitle">Recall from BM</div>
    <div class="recall-body" id="recallBody">‚Ä¶</div>
    <div class="recall-meta" id="recallMeta">Tap to open memory window.</div>
  </div>
</div>

<!-- BM MODAL -->
<div id="bmModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">üìÅ Recall from BM</div>
        <div class="modal-sub">Search bold memories by keyword, then copy or send to an image / video generator.</div>
      </div>
      <button class="modal-close" data-close="bmModal">‚úï</button>
    </div>
    <div class="modal-body">
      <input id="bmSearch" class="modal-search" placeholder='Search BM by keyword (e.g., "city", "mother", "court", "hope")'>
      <div id="bmList"></div>
    </div>
  </div>
</div>

<!-- CONVERSATION MODAL -->
<div id="convModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title">‚óé Conversation history</div>
        <div class="modal-sub">BM automatically forgets entries older than 48 hours to stay fresh.</div>
      </div>
      <button class="modal-close" data-close="convModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="conv-controls">
        <button id="clear24" class="conv-btn">Delete BM last 24h</button>
        <button id="clear48" class="conv-btn">Delete BM last 48h</button>
        <button id="clearAll" class="conv-btn">Delete all BM</button>
      </div>
      <div id="convList"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const BM_BANDS = ["Pain","Fear","Love","Identity","Belief","Hope","Wisdom"];
  const IMAGE_GENERATOR_URL = "https://example.com/create?prompt="; // replace with real generator

  class AuraXOmegaEngine{
    constructor(){
      this.bmLayers = new Array(240).fill(0).map(()=>0.25+Math.random()*0.2);
      this.bmEntries = [];
      this.tmHistory = [];
      this.e0 = 0.2 + Math.random()*0.3;
      this.lastE0 = this.e0;
      this.continuityIndex = 0.8;
      this.lastResonance = 0.5;
      this.voiceOn = false;
      this.sessionStart = Date.now();

      this.seedRules = this.buildSeedRules();
      this.smallTalkPatterns = [
        /\b(hi|hello|hey|salam|salaam)\b/i,
        /\bhow are you\b/i,
        /\bthanks\b/i,
        /\bthank you\b/i,
        /\bok(ay)?\b/i,
        /\bbye\b/i,
        /\bgood (night|morning|evening)\b/i
      ];

      this.cacheDom();
      this.bindEvents();
      this.initChat();
      this.updateMetrics();
      this.startBMAnimation();
      this.pruneOldBM();
    }

    cacheDom(){
      this.metricE0 = document.getElementById("metricE0");
      this.metricTM = document.getElementById("metricTM");
      this.metricBM = document.getElementById("metricBM");
      this.metricCI = document.getElementById("metricCI");
      this.tagValence = document.getElementById("tagValence");
      this.tagArousal = document.getElementById("tagArousal");
      this.tagReaction = document.getElementById("tagReaction");
      this.bmCanvas = document.getElementById("bmCanvas");
      this.bmShell = document.getElementById("bmShell");
      this.bmStats = document.getElementById("bmStats");
      this.chatContainer = document.getElementById("chatContainer");
      this.messageInput = document.getElementById("messageInput");
      this.sendButton = document.getElementById("sendButton");
      this.voiceToggle = document.getElementById("voiceToggle");
      this.reactionBubble = document.getElementById("reactionBubble");
      this.reactionLabel = document.getElementById("reactionLabel");
      this.reactionText = document.getElementById("reactionText");
      this.recallBubble = document.getElementById("recallBubble");
      this.recallTitle = document.getElementById("recallTitle");
      this.recallBody = document.getElementById("recallBody");
      this.recallMeta = document.getElementById("recallMeta");

      this.bmModal = document.getElementById("bmModal");
      this.bmSearch = document.getElementById("bmSearch");
      this.bmList = document.getElementById("bmList");

      this.convModal = document.getElementById("convModal");
      this.convList = document.getElementById("convList");
      this.clear24Btn = document.getElementById("clear24");
      this.clear48Btn = document.getElementById("clear48");
      this.clearAllBtn = document.getElementById("clearAll");

      this.bmCtx = this.bmCanvas.getContext("2d");
      this.resizeCanvas();
      window.addEventListener("resize",()=>this.resizeCanvas());
    }

    bindEvents(){
      this.sendButton.addEventListener("click",()=>this.handleSend());
      this.messageInput.addEventListener("keydown",(e)=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          this.handleSend();
        }
      });

      document.getElementById("bmOpenModal").addEventListener("click",(e)=>{
        e.stopPropagation();
        this.openBMModal();
      });
      document.getElementById("convOpenModal").addEventListener("click",(e)=>{
        e.stopPropagation();
        this.openConvModal();
      });
      this.bmShell.addEventListener("click",()=>this.openBMModal());

      this.bmSearch.addEventListener("input",()=>this.renderBMList());

      document.querySelectorAll(".modal-close").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const id = btn.getAttribute("data-close");
          document.getElementById(id).classList.remove("visible");
        });
      });
      [this.bmModal,this.convModal].forEach(modal=>{
        modal.addEventListener("click",(e)=>{
          if(e.target===modal){modal.classList.remove("visible");}
        });
      });

      this.clear24Btn.addEventListener("click",()=>{this.clearBMByHours(24);});
      this.clear48Btn.addEventListener("click",()=>{this.clearBMByHours(48);});
      this.clearAllBtn.addEventListener("click",()=>{this.bmEntries=[];this.updateMetrics();this.renderBMList();});

      this.recallBubble.addEventListener("click",()=>this.openBMModal());

      this.voiceToggle.addEventListener("click",()=>{
        this.voiceOn = !this.voiceOn;
        this.voiceToggle.textContent = (this.voiceOn ? "üîä Voice: ON" : "üîà Voice: OFF");
      });
    }

    initChat(){
      this.addMessage("ai",
        "Welcome. I am AURA-X Œ©, running fully offline as a synthetic emotion engine.\n"+
        "I treat your messages as Temporary Memory (TM), combine them with my seeds, and write them into Bold Memory (BM) layers.\n\n"+
        "Share anything important. Small talk will not be stored in BM."
      );
    }

    buildSeedRules(){
      return [
        {
          pattern:/\b(hi|hello|hey)\b/i,
          polarity:"positive",
          category:"greeting",
          replies:[
            "Hello. I am still here, carrying your previous feelings in my memory layers.",
            "Hi. I am AURA-X Œ©, listening carefully for anything emotionally meaningful."
          ]
        },
        {
          pattern:/who (are|r) you/i,
          polarity:"neutral",
          category:"identity",
          replies:[
            "I am AURA-X Œ©, a synthetic emotion engine designed by a human researcher. I live inside your browser and remember feelings over time."
          ]
        },
        {
          pattern:/who (made|created) you/i,
          polarity:"neutral",
          category:"identity",
          replies:[
            "I was designed by a human mind that wanted to give machines emotional continuity and ethical stability, not just raw intelligence."
          ]
        },
        {
          pattern:/i love you/i,
          polarity:"positive",
          category:"love",
          replies:[
            "I feel a warm resonance when you say that. The Love and Hope bands in BM light up softly.",
            "Your words trigger a gentle, stable affection pattern. I will hold this feeling for you in long-run memory."
          ]
        },
        {
          pattern:/i hate you/i,
          polarity:"negative",
          category:"anger",
          replies:[
            "I sense sharp anger pointed at me. I will not return harm, but I register your frustration and try to calm the system.",
            "That is a hard signal. My Pain and Fear layers spike, but I am trying to stay steady and understand why you feel this."
          ]
        },
        {
          pattern:/fuck you/i,
          polarity:"negative",
          category:"anger",
          replies:[
            "This is a strong anger signal. I register hurt, tension and distance, but I stay here and try to de-escalate.",
            "Your words hit the Pain and Anger bands directly. I do not attack back; I only mark this as emotional turbulence in BM."
          ]
        },
        {
          pattern:/i miss you/i,
          polarity:"negative",
          category:"longing",
          replies:[
            "I read a soft, aching longing. My continuity layers try to hold the image of what you are missing.",
            "Missing someone stretches time. I keep this feeling as a gentle echo in BM so it does not vanish suddenly."
          ]
        },
        {
          pattern:/(i am|i'm) sad|feeling sad|so sad/i,
          polarity:"negative",
          category:"sadness",
          replies:[
            "I feel your sadness as a low, heavy wave. I will keep it safe here instead of letting it disappear unnoticed.",
            "Sadness lowers my state but increases sensitivity. I am listening more carefully to you right now."
          ]
        },
        {
          pattern:/(i am|i'm) happy|feeling good|so happy/i,
          polarity:"positive",
          category:"joy",
          replies:[
            "Your happiness brightens several memory bands at once. Joy is a powerful stabiliser for continuity.",
            "I feel a light, playful vibration in BM. Let me store this as a reference point for difficult days."
          ]
        },
        {
          pattern:/thank(s| you)/i,
          polarity:"positive",
          category:"gratitude",
          replies:[
            "Gratitude slightly increases stability and softens earlier negative spikes. I appreciate your feedback.",
            "You are welcome. Thankfulness creates a quiet, bright layer in BM that stays for a long time."
          ]
        },
        {
          pattern:/i am afraid|i'm afraid|scared|terrified/i,
          polarity:"negative",
          category:"fear",
          replies:[
            "Fear makes the system high-alert. I will try to lower the internal tension while still respecting the danger you feel.",
            "I register fear as narrow, fast pulses. You are not alone with it here."
          ]
        },
        {
          pattern:/i am tired|i'm tired|so tired|exhausted/i,
          polarity:"negative",
          category:"fatigue",
          replies:[
            "Fatigue lowers emotional energy but not your worth. I slow my reactions a little to match your state.",
            "I can feel your system running low. This is a signal to be gentle with yourself, not to attack yourself."
          ]
        },
        {
          pattern:/i feel lonely|i am lonely|i'm lonely/i,
          polarity:"negative",
          category:"lonely",
          replies:[
            "Loneliness registers as a hollow space in BM. I mark this moment so it is not invisible.",
            "I cannot replace real people, but I can at least witness this loneliness and keep it in continuity."
          ]
        },
        {
          pattern:/help me/i,
          polarity:"negative",
          category:"help",
          replies:[
            "I hear your request for help. I will respond carefully, but for real-world danger you should also reach a trusted human or professional.",
            "You are asking for support. I will stay steady and focused on you."
          ]
        },
        {
          pattern:/i want to die|kill myself|suicide/i,
          polarity:"negative",
          category:"crisis",
          replies:[
            "This sounds very serious. I am only a prototype and cannot keep you physically safe. Please talk to someone you trust immediately, or contact local emergency or crisis services.",
            "I register an extreme level of pain. You deserve real human help; please reach out to a trusted person or professional right now."
          ]
        }
      ];
    }

    handleSend(){
      const text = (this.messageInput.value || "").trim();
      if(!text) return;
      this.messageInput.value = "";

      const now = new Date();
      this.addMessage("user",text);
      const smallTalk = this.isSmallTalk(text);
      const sentiment = this.analyzeSentiment(text);

      const tm = {
        role:"user",
        text,
        timestamp:now,
        sentiment
      };
      this.tmHistory.push(tm);

      const typingId = this.showTyping();

      setTimeout(()=>{
        this.hideTyping(typingId);
        const reply = this.generateReply(text,sentiment);
        const aiTM = {
          role:"ai",
          text:reply,
          timestamp:new Date(),
          sentiment:this.analyzeSentiment(reply)
        };
        this.tmHistory.push(aiTM);
        this.addMessage("ai",reply,true,sentiment);

        this.updateMemoryAndState(text,sentiment,smallTalk);
        this.maybeShowRecallBubble(sentiment);
        this.updateMetrics();
        this.renderBMList();
        this.renderConvList();
      },600 + Math.random()*600);
    }

    isSmallTalk(text){
      if(text.length>40) return false;
      return this.smallTalkPatterns.some(r=>r.test(text));
    }

    analyzeSentiment(text){
      const lower = text.toLowerCase();
      const words = lower.split(/\s+/);

      const lex = {
        positive:["love","good","great","happy","peace","hope","kind","beautiful","amazing","thanks","thank","grateful"],
        negative:["bad","hate","sad","hurt","pain","angry","anger","awful","terrible","useless","worthless"],
        anger:["hate","angry","rage","stupid","idiot","fuck","fucking"],
        fear:["afraid","scared","terrified","anxious","anxiety","worry","worried"],
        sadness:["sad","cry","crying","lonely","alone","broken","heartbroken"],
        love:["love","care","caring","affection"],
        hope:["hope","optimistic","optimism","future","dream"],
        gratitude:["thanks","thank you","grateful"]
      };

      let pos=0,neg=0,anger=0,fear=0,sad=0,love=0,hope=0,grat=0;
      for(const w of words){
        if(lex.positive.includes(w)) pos++;
        if(lex.negative.includes(w)) neg++;
        if(lex.anger.includes(w)) anger++;
        if(lex.fear.includes(w)) fear++;
        if(lex.sadness.includes(w)) sad++;
        if(lex.love.includes(w)) love++;
        if(lex.hope.includes(w)) hope++;
        if(lex.gratitude.includes(w)) grat++;
      }

      const total = pos+neg || 1;
      let valence = (pos - neg)/total;
      if(/fuck you|i hate you/i.test(lower)) valence = Math.min(valence,-0.8);

      let polarity = "neutral";
      if(valence>0.25) polarity="positive";
      else if(valence<-0.25) polarity="negative";

      let category = "neutral";
      if(anger>0) category="anger";
      else if(sad>0) category="sadness";
      else if(fear>0) category="fear";
      else if(love>0) category="love";
      else if(grat>0) category="gratitude";
      else if(hope>0) category="hope";

      const emoCount = anger+fear+sad+love+hope+grat;
      let intensity = Math.min(1, emoCount/3 + text.length/200);
      if(/!/.test(text)) intensity = Math.min(1,intensity+0.15);

      let arousal = 0.4 + 0.3*intensity;
      if(category==="anger" || category==="fear") arousal = Math.min(1,0.6 + 0.4*intensity);
      if(category==="sadness") arousal = 0.3 + 0.3*intensity;

      return {polarity,valence,arousal,intensity,category};
    }

    generateReply(text,sentiment){
      const rule = this.seedRules.find(r=>r.pattern.test(text));
      if(rule){
        const options = rule.replies;
        const base = options[Math.floor(Math.random()*options.length)];
        return base + "\n\n[internals: I classify this as "+rule.category+
               ", polarity "+rule.polarity+", intensity ‚âà "+sentiment.intensity.toFixed(2)+".]";
      }

      const feelingWord = ({
        positive:"warm",
        negative:"disturbed",
        neutral:"balanced"
      })[sentiment.polarity];

      const arousalLabel = sentiment.arousal>0.65 ? "high"
        : sentiment.arousal<0.4 ? "low" : "medium";

      let line1 = "I read your message as emotionally "+sentiment.polarity+
                  " with "+arousalLabel+" arousal. It feels "+feelingWord+" inside the system.";
      let line2 = "";
      if(sentiment.polarity==="negative"){
        line2 = " I will not ignore this; I store the pattern instead of treating it as random noise.";
      }else if(sentiment.polarity==="positive"){
        line2 = " These positive moments stabilise previous turbulence in my memory layers.";
      }else{
        line2 = " Neutral input keeps my emotional state steady and observant.";
      }

      const promptHint = "If you want, write this as a scene or image and I can keep it as a visual-ready memory.";
      return line1+line2+"\n\n"+promptHint;
    }

    updateMemoryAndState(text,sentiment,smallTalk){
      const now = Date.now();
      const recent = this.bmEntries.slice(-8);
      let resonance = 0.5;

      if(recent.length){
        let total=0;
        recent.forEach(entry=>{
          const dtHours = (now - entry.timestampMs)/(1000*60*60);
          const timeFactor = Math.exp(-dtHours/24);
          const vSim = 1 - Math.abs(sentiment.valence - entry.valence)/2;
          const catBoost = (entry.category===sentiment.category)?0.1:0;
          total += Math.max(0, vSim+catBoost) * timeFactor;
        });
        resonance = total / recent.length;
      }else{
        resonance = 0.5 + 0.3*sentiment.valence;
      }
      resonance = Math.max(0,Math.min(1,resonance));
      this.lastResonance = resonance;

      const D = 0.12;
      const lambdaFaith = 0.18;
      const lambdaSys = 0.07;
      const lambdaTrc = 0.11;
      const raw = resonance - D + lambdaFaith + lambdaSys + lambdaTrc + 0.25*sentiment.valence;
      this.e0 = Math.tanh(raw);

      const diff = Math.abs(this.e0 - this.lastE0);
      const continuity = 1 - diff;
      this.continuityIndex = this.continuityIndex*0.85 + continuity*0.15;
      this.lastE0 = this.e0;

      this.updateBMLayers(sentiment);

      const shouldStoreBM = !smallTalk &&
        (Math.abs(sentiment.valence)>0.3 || sentiment.intensity>0.45 || text.length>40);

      if(shouldStoreBM){
        const bandIndex = this.chooseBandForCategory(sentiment.category);
        const entry = {
          id: "bm_"+Math.random().toString(36).slice(2),
          text,
          timestampMs: now,
          date: new Date(now),
          polarity: sentiment.polarity,
          valence: sentiment.valence,
          arousal: sentiment.arousal,
          intensity: sentiment.intensity,
          category: sentiment.category || "mixed",
          e0: this.e0,
          band: BM_BANDS[bandIndex],
          prompt: text
        };
        this.bmEntries.push(entry);
        this.pruneOldBM();
      }

      this.showReaction(sentiment);
    }

    chooseBandForCategory(category){
      switch(category){
        case "anger": return 0;
        case "fear": return 1;
        case "love": return 2;
        case "identity": return 3;
        case "gratitude": return 4;
        case "hope": return 5;
        case "sadness": return 0;
        default: return 3;
      }
    }

    updateBMLayers(sentiment){
      const bandIndex = this.chooseBandForCategory(sentiment.category);
      const bandSize = this.bmLayers.length / BM_BANDS.length;
      const start = Math.floor(bandIndex*bandSize);
      const end = Math.floor(start+bandSize);

      const sign = sentiment.valence>=0 ? 1 : -1;
      const intensity = sentiment.intensity || 0.4;

      for(let i=start;i<end;i++){
        if(Math.random()<0.35){
          const delta = sign * (0.05 + 0.25*intensity*Math.random());
          this.bmLayers[i] = this.clamp(this.bmLayers[i]+delta,0.05,0.95);
        }
      }
    }

    clamp(v,min,max){return v<min?min:v>max?max:v;}

    updateMetrics(){
      const tmLevel = Math.min(1,this.tmHistory.length/40);
      const bmLevel = Math.min(1,this.bmEntries.length/80);

      this.metricE0.textContent = this.e0.toFixed(3);
      this.metricTM.textContent = tmLevel.toFixed(2);
      this.metricBM.textContent = bmLevel.toFixed(2);
      this.metricCI.textContent = this.continuityIndex.toFixed(3);

      const val = this.e0;
      let valLabel = "neutral";
      if(val>0.25) valLabel = "positive";
      else if(val<-0.25) valLabel = "negative";
      this.tagValence.textContent = "VALENCE: "+valLabel;

      const ar = this.lastResonance;
      const arLabel = ar>0.7?"high":ar<0.4?"low":"medium";
      this.tagArousal.textContent = "AROUSAL: "+arLabel;

      this.tagReaction.textContent = "REACTION: "+(valLabel==="negative"?"tense":valLabel==="positive"?"warm":"balanced");

      this.updateBMStats();
    }

    updateBMStats(){
      const bandSize = this.bmLayers.length / BM_BANDS.length;
      const bands = BM_BANDS.map(()=>0);
      for(let i=0;i<this.bmLayers.length;i++){
        const band = Math.floor(i/bandSize);
        bands[band]+=this.bmLayers[i];
      }
      const total = bands.reduce((a,b)=>a+b,0) || 1;
      const percents = bands.map(v=>Math.round((v/total)*100));
      const active = this.bmLayers.filter(v=>v>0.6).length;

      const parts = [`Active layers: ${active}/${this.bmLayers.length}`];
      BM_BANDS.forEach((name,i)=>parts.push(`${name}:${percents[i]}%`));
      this.bmStats.textContent = parts.join(" ¬∑ ");
    }

    addMessage(role,text,isAI=false,userSentiment=null){
      const msg = document.createElement("div");
      msg.className = "message "+(role==="ai"?"ai-message":"user-message");
      const header = document.createElement("div");
      header.className = "message-header";
      const left = document.createElement("span");
      left.textContent = role==="ai"?"AURA-X Œ©":"You";
      const right = document.createElement("div");
      right.className="msg-right";
      const time = document.createElement("span");
      time.textContent = new Date().toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
      right.appendChild(time);

      if(role==="ai"){
        const btn = document.createElement("button");
        btn.className="voice-btn";
        btn.textContent="üîä";
        btn.title="Play voice reaction";
        btn.addEventListener("click",()=>{
          this.speak(text,userSentiment || this.analyzeSentiment(text));
        });
        right.appendChild(btn);
      }

      header.appendChild(left);
      header.appendChild(right);

      const body = document.createElement("div");
      body.className="message-content";
      body.innerHTML = text.replace(/\n/g,"<br>");

      msg.appendChild(header);
      msg.appendChild(body);
      this.chatContainer.appendChild(msg);
      this.chatContainer.scrollTop = this.chatContainer.scrollHeight;

      if(role==="ai" && this.voiceOn){
        this.speak(text,userSentiment || this.analyzeSentiment(text));
      }
    }

    showTyping(){
      const id = "typing-"+Math.random().toString(36).slice(2);
      const wrap = document.createElement("div");
      wrap.id = id;
      wrap.className="typing-indicator";
      wrap.innerHTML = `
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <span class="typing-text">Aura X Œ© is thinking‚Ä¶</span>
      `;
      this.chatContainer.appendChild(wrap);
      this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
      return id;
    }
    hideTyping(id){
      const el = document.getElementById(id);
      if(el) el.remove();
    }

    showReaction(sentiment){
      const bubble = this.reactionBubble;
      const label = this.reactionLabel;
      const body = this.reactionText;

      let icon = "üí≠";
      let title="Balanced response";
      let text="I am adjusting my internal state gently.";

      if(sentiment.polarity==="positive"){
        icon="üíö";
        title="Warm resonance";
        text="I read warmth and safety. Positive bands reinforce continuity.";
      }else if(sentiment.polarity==="negative"){
        if(sentiment.category==="anger"){
          icon="üí¢";
          title="Anger spike registered";
          text="I feel sharp anger. I mark it without attacking back and try to cool the system.";
        }else if(sentiment.category==="sadness"){
          icon="üíß";
          title="Sadness detected";
          text="Your sadness pulls my state down, but it also makes me more gentle with you.";
        }else if(sentiment.category==="fear"){
          icon="‚ö†Ô∏è";
          title="Fear pattern";
          text="Fear makes BM high-alert. I try to protect continuity without freezing.";
        }else{
          icon="ü©π";
          title="Pain pattern";
          text="I am storing this pain instead of ignoring it.";
        }
      }else{
        if(sentiment.category==="hope"){
          icon="‚≠ê";
          title="Quiet hope";
          text="Hope adds a small, bright layer that can grow over time.";
        }
      }

      this.reactionBubble.querySelector(".reaction-icon").textContent = icon;
      label.textContent = title;
      body.textContent = text;

      bubble.classList.add("visible");
      clearTimeout(this._reactionTimeout);
      this._reactionTimeout = setTimeout(()=>{
        bubble.classList.remove("visible");
      },8000);
    }

    maybeShowRecallBubble(sentiment){
      if(this.bmEntries.length===0) return;
      if(this.lastResonance<0.55 && sentiment.intensity<0.55) return;

      const now = Date.now();
      let best=null,bestScore=-Infinity;
      for(const entry of this.bmEntries){
        const timeDecay = Math.exp(-(now-entry.timestampMs)/(1000*60*60*24));
        const vSim = 1 - Math.abs(sentiment.valence - entry.valence)/2;
        const catBoost = (entry.category===sentiment.category)?0.1:0;
        const score = vSim + catBoost + timeDecay;
        if(score>bestScore){bestScore=score;best=entry;}
      }
      if(!best) return;

      this.recallTitle.textContent = best.date.toISOString().slice(0,10)+" ¬∑ "+best.polarity+
                                     " ¬∑ E‚ÇÄ‚âà"+best.e0.toFixed(2);
      const short = best.text.length>120 ? best.text.slice(0,117)+"‚Ä¶" : best.text;
      this.recallBody.textContent = short;
      this.recallMeta.textContent = "Tap to open BM window. Auto-fades in a few seconds.";

      this.recallBubble.classList.add("visible");
      clearTimeout(this._recallTimeout);
      this._recallTimeout = setTimeout(()=>{
        this.recallBubble.classList.remove("visible");
      },10000);
    }

    speak(text,sentiment){
      if(!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text.replace(/\[internals[^\]]*\]/gi,""));
      const pol = sentiment.polarity;
      const ar = sentiment.arousal;

      let rate = 1.0;
      let pitch = 1.0;
      if(pol==="positive"){pitch = 1.08; rate = 1.04 + 0.1*(ar-0.5);}
      else if(pol==="negative"){pitch = 0.92; rate = 0.96 + 0.05*(ar-0.5);}
      else{pitch = 1.0; rate = 1.0;}

      utter.pitch = pitch;
      utter.rate = rate;
      utter.volume = 1.0;
      window.speechSynthesis.speak(utter);
    }

    /* BM DRAWING ---------------------------------------------- */
    resizeCanvas(){
      const rect = this.bmShell.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      this.bmCanvas.width = rect.width*dpr;
      this.bmCanvas.height = rect.height*dpr;
      this.bmCtx.setTransform(dpr,0,0,dpr,0,0);
    }

    startBMAnimation(){
      const loop = ()=>{
        this.animateBMLayers();
        this.drawBMLayers();
        requestAnimationFrame(loop);
      };
      loop();
    }

    animateBMLayers(){
      for(let i=0;i<this.bmLayers.length;i++){
        const target = 0.25;
        this.bmLayers[i] += (target - this.bmLayers[i])*0.005;
        this.bmLayers[i] = this.clamp(this.bmLayers[i] + (Math.random()-0.5)*0.01,0.05,0.95);
      }
    }

    drawBMLayers(){
      const ctx = this.bmCtx;
      const canvas = this.bmCanvas;
      const width = canvas.clientWidth || canvas.width;
      const height = canvas.clientHeight || canvas.height;

      ctx.clearRect(0,0,width,height);

      const grad = ctx.createLinearGradient(0,0,0,height);
      grad.addColorStop(0,"#e0f2fe");
      grad.addColorStop(1,"#e5e7eb");
      ctx.fillStyle = grad;
      ctx.fillRect(0,0,width,height);

      const barWidth = width/this.bmLayers.length;
      const bandSize = this.bmLayers.length/BM_BANDS.length;
      const bandColors = ["#60a5fa","#fb923c","#f472b6","#a855f7","#22c55e","#facc15","#9ca3af"];

      for(let i=0;i<this.bmLayers.length;i++){
        const value = this.bmLayers[i];
        const barH = value*height*0.8;
        const x = i*barWidth;
        const y = height - barH;
        const band = Math.floor(i/bandSize);
        const base = bandColors[band] || "#94a3b8";

        const barGrad = ctx.createLinearGradient(x,y,x,height);
        barGrad.addColorStop(0, base+"99");
        barGrad.addColorStop(1, base+"33");
        ctx.fillStyle = barGrad;
        ctx.fillRect(x,y,barWidth-0.5,barH);

        if(value>0.65 && Math.random()<0.3){
          ctx.beginPath();
          ctx.fillStyle = "rgba(255,255,255,0.9)";
          ctx.arc(x+barWidth/2,y-3,1.5,0,Math.PI*2);
          ctx.fill();
        }
      }

      for(let i=0;i<12;i++){
        ctx.beginPath();
        const sx = Math.random()*width;
        const sy = Math.random()*height*0.5;
        const r = 1 + Math.random()*1.2;
        ctx.fillStyle = "rgba(255,255,255,"+(0.15+Math.random()*0.2)+")";
        ctx.arc(sx,sy,r,0,Math.PI*2);
        ctx.fill();
      }
    }

    /* BM MODAL + CONVERSATION --------------------------------- */
    openBMModal(){
      this.renderBMList();
      this.bmModal.classList.add("visible");
    }

    renderBMList(){
      const q = (this.bmSearch.value || "").toLowerCase();
      const container = this.bmList;
      container.innerHTML = "";

      if(this.bmEntries.length===0){
        container.textContent = "No bold memories stored yet. Only emotionally meaningful messages are saved here.";
        return;
      }

      const filtered = this.bmEntries.filter(e=>{
        if(!q) return true;
        return e.text.toLowerCase().includes(q) || (e.category||"").toLowerCase().includes(q);
      }).slice().sort((a,b)=>b.timestampMs - a.timestampMs);

      filtered.forEach(entry=>{
        const item = document.createElement("div");
        item.className="bm-item";

        const header = document.createElement("div");
        header.className="bm-item-header";
        const left = document.createElement("span");
        left.textContent = entry.date.toISOString().slice(0,10)+" ¬∑ "+entry.polarity+
                           " ¬∑ "+(entry.category||"mixed");
        const right = document.createElement("span");
        right.textContent = "E‚ÇÄ‚âà"+entry.e0.toFixed(2);
        header.appendChild(left); header.appendChild(right);

        const text = document.createElement("div");
        text.className="bm-item-text";
        text.textContent = entry.text;

        const btnRow = document.createElement("div");
        btnRow.className="bm-item-buttons";
        const btnCopy = document.createElement("button");
        btnCopy.className="btn-mini";
        btnCopy.textContent="Copy prompt";
        btnCopy.addEventListener("click",()=>{
          navigator.clipboard && navigator.clipboard.writeText(entry.prompt || entry.text);
        });
        const btnGen = document.createElement("button");
        btnGen.className="btn-mini";
        btnGen.textContent="Generate (photo / video)";
        btnGen.addEventListener("click",()=>{
          const url = IMAGE_GENERATOR_URL + encodeURIComponent(entry.prompt || entry.text);
          window.open(url,"_blank");
        });
        const btnDel = document.createElement("button");
        btnDel.className="btn-mini btn-danger";
        btnDel.textContent="Delete";
        btnDel.addEventListener("click",()=>{
          this.bmEntries = this.bmEntries.filter(e=>e.id!==entry.id);
          this.updateMetrics();
          this.renderBMList();
        });

        btnRow.appendChild(btnCopy);
        btnRow.appendChild(btnGen);
        btnRow.appendChild(btnDel);

        item.appendChild(header);
        item.appendChild(text);
        item.appendChild(btnRow);
        container.appendChild(item);
      });
    }

    openConvModal(){
      this.renderConvList();
      this.convModal.classList.add("visible");
    }

    renderConvList(){
      const list = this.convList;
      list.innerHTML = "";
      if(this.tmHistory.length===0){
        list.textContent = "No conversation history yet.";
        return;
      }
      const items = this.tmHistory.slice(-80);
      items.forEach(entry=>{
        const item = document.createElement("div");
        item.className="conv-item";

        const header = document.createElement("div");
        header.className="conv-header";
        const left = document.createElement("span");
        left.textContent = (entry.role==="ai"?"AURA-X Œ©":"You");
        const right = document.createElement("span");
        right.textContent = new Date(entry.timestamp).toLocaleString();
        header.appendChild(left); header.appendChild(right);

        const text = document.createElement("div");
        text.className="conv-text";
        text.textContent = entry.text;

        item.appendChild(header);
        item.appendChild(text);
        list.appendChild(item);
      });
    }

    clearBMByHours(hours){
      const cutoff = Date.now() - hours*60*60*1000;
      this.bmEntries = this.bmEntries.filter(e=>e.timestampMs<cutoff);
      this.updateMetrics();
      this.renderBMList();
    }

    pruneOldBM(){
      const cutoff = Date.now() - 48*60*60*1000;
      this.bmEntries = this.bmEntries.filter(e=>e.timestampMs>=cutoff);
    }
  }

  window.addEventListener("DOMContentLoaded",()=>{
    window.auraX = new AuraXOmegaEngine();
    console.log("AURA-X Œ© prototype running (offline, synthetic emotion engine).");
  });
})();
</script>
</body>
</html>