<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Offline LLM package (WebLLM, for in-browser models ‚Äì future ready) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}

    :root {
      --accent-color: #0ea5e9; /* default accent */
    }

    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px 10px;
    }

    .app{
      width:min(980px,98vw);
      background:rgba(2,6,23,.45);
      border:1px solid rgba(148,163,184,.18);
      border-radius:22px;
      overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
    }

    .top{
      padding:20px 18px 10px;
      border-bottom:1px solid rgba(148,163,184,.14);
      text-align:center;
    }

    .brand{
      font-weight:800;
      letter-spacing:.5px;
      font-size:26px;
      color:#7dd3fc;
      text-shadow:0 0 22px rgba(14,165,233,.28);
    }

    .sub{
      opacity:.8;
      margin-top:2px;
      font-size:13px;
    }

    .ethic{
      margin:14px auto 12px;
      max-width:720px;
      border:1px solid rgba(251,191,36,.35);
      border-radius:14px;
      padding:12px 14px;
      color:#fbbf24;
      background:rgba(2,6,23,.35);
      box-shadow:inset 0 0 0 1px rgba(251,191,36,.08);
      font-size:14px;
      line-height:1.45;
    }

    .pill{
      margin:10px auto 0;
      max-width:760px;
      background:linear-gradient(90deg, rgba(14,165,233,.65), rgba(34,211,238,.45));
      border:1px solid rgba(125,211,252,.30);
      color:#0b1220;
      font-weight:800;
      letter-spacing:.6px;
      border-radius:999px;
      padding:14px 16px;
      text-transform:uppercase;
      box-shadow:0 12px 40px rgba(14,165,233,.22);
    }

    .main{ padding:16px 16px 18px }
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:stretch}
    .leftCol{ flex:1 1 340px; min-width:300px }
    .rightCol{ flex:1 1 360px; min-width:320px }

    .card{
      background:rgba(2,6,23,.50);
      border:1px solid rgba(148,163,184,.16);
      border-radius:18px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      backdrop-filter:blur(10px);
    }

    .optionsBtn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(15,23,42,.55);
      color:#e5e7eb;
      cursor:pointer;
      user-select:none;
      margin:12px 0;
      -webkit-tap-highlight-color:transparent;
    }
    .optionsBtn:active{transform:scale(.99)}
    .gear{width:18px;height:18px;filter:drop-shadow(0 0 10px rgba(125,211,252,.25))}

    .console{
      margin-top:12px;
      height:230px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(0,0,0,.25);
      padding:14px;
      overflow:auto;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:14px;
      box-shadow:inset 0 0 0 1px rgba(125,211,252,.06);
      line-height:1.55;
      white-space:pre-wrap;
    }
    .line{display:block;margin:2px 0}
    .line.user{color:#a5b4fc;}
    .line.aura{color:#bbf7d0;}
    .line.sys{color:#fbbf24;font-size:12px;}

    .optionsMenu{
      position:fixed;
      left:12px;
      right:12px;
      top:120px;
      margin:0 auto;
      max-width:940px;
      background:rgba(2,6,23,.92);
      border:1px solid rgba(148,163,184,.18);
      border-radius:16px;
      padding:8px;
      display:none;
      z-index:9999;
      box-shadow:0 18px 45px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
      align-items:stretch;
    }
    .optionsMenu.show{display:grid}

    .menuItem{
      padding:8px 6px;
      border-radius:13px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:6px;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.10);
      background:rgba(15,23,42,.55);
      user-select:none;
      min-height:58px;
    }
    .menuItem:active{transform:scale(.995)}
    .menuLeft{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-weight:800;
      font-size:12.5px;
    }
    .menuIcon{
      width:18px;
      height:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .menuRight{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:44px;
    }

    .pillOn,.pillOff,.pillMid{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      font-weight:900;
      text-transform:lowercase;
      border:1px solid transparent;
    }
    .pillOn{
      background:rgba(34,197,94,.18);
      border-color:rgba(34,197,94,.24);
      color:#bbf7d0;
    }
    .pillOff{
      background:rgba(239,68,68,.12);
      border-color:rgba(239,68,68,.22);
      color:#fecaca;
    }
    .pillMid{
      background:rgba(14,165,233,.14);
      border-color:rgba(14,165,233,.20);
      color:#bae6fd;
      opacity:.95;
    }

    .chatWrap{
      margin-top:0;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.45);
    }

    /* reaction bar above metrics, left-aligned */
    .reactionBar{
      margin-top:0;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      font-size:18px;
      opacity:.9;
    }
    .reactBtn{
      border:none;
      background:transparent;
      cursor:pointer;
      padding:4px;
      line-height:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      -webkit-tap-highlight-color:transparent;
    }
    .reactBtn:active{transform:scale(.9)}

    .liveCapsule{
      margin:4px 0 10px;
      width:100%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      padding:10px 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:12px;
      color:#dbeafe;
      box-shadow:inset 0 0 0 1px rgba(125,211,252,.06);
    }
    .liveCapsule b{ color:#7dd3fc; font-weight:900 }

    .faithBubble{
      margin:4px 0 10px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(251,191,36,.16);
      border:1px solid rgba(251,191,36,.4);
      display:none;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:#facc15;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      transition:opacity .25s ease, transform .25s ease;
    }
    .faithBubble.show{
      display:flex;
      opacity:1;
      transform:translateY(0);
    }
    .fbIcon{font-size:18px;}
    .fbText{flex:1;line-height:1.3;}
    .fbTitle{font-weight:800;}
    .fbMeta{opacity:.85;}
    .fbClose{
      border:none;
      background:transparent;
      color:#fed7aa;
      font-size:16px;
      cursor:pointer;
      padding:0 4px;
      line-height:1;
    }

    .faithBubble.pulse{ animation: faithPulse 1.4s infinite; }
    @keyframes faithPulse{
      0%   { box-shadow: 0 0 0 0 rgba(251,191,36,.55); }
      100% { box-shadow: 0 0 0 18px rgba(251,191,36,0); }
    }

    .inputRow{display:flex;gap:10px;align-items:flex-end}
    .input{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      padding:12px 14px;
      outline:none;
      font-size:14px;
    }
    .send{
      border:none;
      border-radius:999px;
      background:linear-gradient(90deg, var(--accent-color, #0ea5e9), rgba(34,211,238,.55));
      color:#0b1220;
      font-weight:900;
      padding:12px 18px;
      cursor:pointer;
      min-width:88px;
      box-shadow:0 12px 30px rgba(14,165,233,.18);
      -webkit-tap-highlight-color:transparent;
    }
    .send:active{transform:scale(.99)}

    .formula{
      margin-top:10px;
      opacity:.8;
      font-size:12px;
      text-align:center;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      color:#dbeafe;
    }

    /* Toast bubble */
    .toastBubble{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translate(-50%,10px);
      padding:6px 14px;
      border-radius:999px;
      background:rgba(15,23,42,.95);
      color:#e5e7eb;
      font-size:12px;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:0 12px 30px rgba(0,0,0,.5);
      opacity:0;
      pointer-events:none;
      z-index:10000;
      transition:opacity .18s ease, transform .18s ease;
    }
    .toastBubble.show{
      opacity:1;
      transform:translate(-50%,0);
    }

    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:18px 12px;
      z-index:9999;
    }
    .modalOverlay.show{display:flex}

    .modal{
      width:min(860px,96vw);
      border-radius:18px;
      overflow:hidden;
      background:rgba(250,250,250,.93);
      color:#0b1220;
      border:1px solid rgba(15,23,42,.18);
      box-shadow:0 30px 80px rgba(0,0,0,.35);
      backdrop-filter:blur(12px);
    }

    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      background:rgba(255,255,255,.75);
      border-bottom:1px solid rgba(15,23,42,.10);
      font-weight:800;
    }
    .modalHeader small{font-weight:600;opacity:.7}
    .closeX{
      border:none;
      background:transparent;
      font-size:22px;
      cursor:pointer;
      line-height:1;
      padding:0 4px;
      opacity:.75;
    }

    .modalBody{
      padding:14px;
      max-height:70vh;
      overflow:auto;
    }

    .chipsWrap{margin-top:10px;display:flex;flex-wrap:wrap;gap:10px}
    .chip{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.16);
      background:rgba(255,255,255,.9);
      font-weight:800;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }
    .chip.active{
      background:#0f172a;
      color:#fff;
      border-color:rgba(15,23,42,.2);
      box-shadow:0 12px 30px rgba(2,6,23,.12);
    }

    .btn{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:12px;
      font-weight:900;
      -webkit-tap-highlight-color:transparent;
      font-size:12px;
    }
    .btnBlue{background:rgba(59,130,246,.16);border:1px solid rgba(59,130,246,.22)}
    .btnDark{background:rgba(2,6,23,.92);color:#fff}
    .btnRed{background:rgba(239,68,68,.14);border:1px solid rgba(239,68,68,.22);color:#7f1d1d}
    .btnGreen{background:rgba(34,197,94,.18);border:1px solid rgba(34,197,94,.25);color:#064e2a}

    .bmCard{
      border-radius:16px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.85);
      padding:12px;
      margin-top:12px;
    }
    .bmTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .bmTop .title{
      font-weight:900;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .bmSub{font-size:12px;opacity:.7;margin-top:2px}
    .bmText{
      width:100%;
      min-height:140px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.18);
      padding:12px;
      outline:none;
      resize:vertical;
      background:#fff;
      font-size:14px;
      line-height:1.45;
    }
    .bmActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      justify-content:flex-start;
    }

    .intelEditInput, .intelEditArea{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.18);
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .intelEditArea{
      min-height:90px;
      resize:vertical;
      line-height:1.4;
      margin-top:6px;
    }

    /* Intelligence cards */
    .intelCard{
      border-radius:12px;
      border:1px solid rgba(15,23,42,.12);
      background:#f9fafb;
      padding:10px;
      margin-top:8px;
      font-size:13px;
    }
    .intelTop{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-bottom:4px;
    }
    .intelQ{font-weight:700;}
    .intelA{margin-top:2px;white-space:pre-wrap;}
    .intelMeta{font-size:11px;opacity:.65;margin-top:2px;}
    .intelButtons{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;margin-top:6px;}

    .intelEditBlock{
      margin-top:8px;
      border-radius:10px;
      border:1px dashed rgba(15,23,42,.18);
      padding:8px;
      background:#fff;
    }

    /* Conversation history */
    #modalHistory .modalBody{ background:#f8fafc; }
    #historyBox{
      margin-top:4px;
      border-radius:14px;
      padding:4px 0;
      max-height:60vh;
      overflow:auto;
    }
    .historyLine{
      padding:8px 10px;
      font-size:12px;
      margin-bottom:6px;
      border-radius:12px;
      background:#f9fafb;
      border:1px solid rgba(148,163,184,.45);
      color:#0b1120;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:6px;
    }
    .historyText{
      flex:1;
      white-space:pre-wrap;
    }
    .historyLock{
      border:none;
      background:transparent;
      cursor:pointer;
      font-size:15px;
      line-height:1;
      padding:0 2px;
    }

    /* BM list items */
    .bmItem{
      margin-top:6px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.5);
      background:#f9fafb;
      cursor:pointer;
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:6px;
    }
    .bmItemTitle{font-weight:700;}
    .bmItemMeta{opacity:.65;font-size:11px;}

    /* Dream screensaver overlay */
    #dreamOverlay{
      position:fixed;
      inset:0;
      background:
        radial-gradient(circle at 20% 0%, rgba(56,189,248,.28), transparent 55%),
        radial-gradient(circle at 80% 100%, rgba(129,140,248,.35), transparent 55%),
        rgba(15,23,42,.96);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9998;
    }
    #dreamOverlay.show{display:flex;}

    .dreamScreen{
      width:min(780px,94vw);
      border-radius:24px;
      padding:24px 20px 18px;
      border:1px solid rgba(148,163,184,.55);
      background:linear-gradient(135deg, rgba(15,23,42,.98), rgba(15,23,42,.9));
      box-shadow:0 30px 80px rgba(0,0,0,.8);
      color:#e5e7eb;
      text-align:center;
    }
    .dreamTitle{
      font-size:16px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#bae6fd;
      margin-bottom:8px;
    }
    .dreamBody{
      font-size:14px;
      line-height:1.6;
      opacity:.9;
      max-height:260px;
      overflow:auto;
      padding:10px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,.9);
      text-align:left;
      white-space:pre-wrap;
    }
    .dreamHint{
      font-size:11px;
      opacity:.7;
      margin-top:8px;
    }

    @media (max-width:760px){
      .console{height:240px}
      .optionsMenu{top:112px}
    }

    @media (max-width:420px){
      .brand{font-size:22px}
      .pill{font-size:14px}
      .ethic{font-size:13px}
      .console{height:260px}
      .optionsMenu{
        gap:6px;
        padding:7px;
        grid-template-columns:repeat(3,minmax(0,1fr));
      }
      .menuItem{
        min-height:52px;
        padding:6px 4px;
      }
      .menuLeft{font-size:11px}
      .pillOn,.pillOff,.pillMid{
        font-size:9.5px;
        padding:4px 6px;
      }
      .reactionBar{
        font-size:16px;
        gap:8px;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="top">
      <div class="brand">AURA-X Œ©</div>
      <div class="sub">
        Offline emotional continuity engine (prototype)<br>
        TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory.
      </div>
      <div class="ethic">
        Universal ethic: avoid actions that grow negative emotions in you or others.
        Move gently toward choices that increase shared positive feeling for everyone.
      </div>
      <div class="pill">EMOTIONAL CONTINUITY ENGINE ‚Äî ACTIVE</div>
    </div>

    <div class="main">
      <div class="row">
        <!-- LEFT -->
        <div class="leftCol">
          <div class="card">
            <div class="optionsBtn" id="btnOptions">
              <svg class="gear" viewBox="0 0 24 24" fill="none">
                <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"
                      stroke="#7dd3fc" stroke-width="2"/>
                <path d="M19.4 15a8.2 8.2 0 0 0 .1-2l2-1.5-2-3.5-2.4 1a8.5 8.5 0 0 0-1.7-1l-.4-2.6h-4l-.4 2.6a8.5 8.5 0 0 0-1.7 1l-2.4-1-2 3.5 2 1.5a8.2 8.2 0 0 0 .1 2L2.7 16.5l2 3.5 2.4-1a8.5 8.5 0 0 0 1.7 1l.4 2.6h4l.4-2.6a8.5 8.5 0 0 0 1.7-1l2.4 1 2-3.5L19.4 15Z"
                      stroke="#7dd3fc" stroke-width="1.6" opacity=".9"/>
              </svg>
              <span>Options</span>
            </div>

            <div class="optionsMenu" id="optionsMenu">
              <div class="menuItem" id="miVoice">
                <div class="menuLeft"><span class="menuIcon">üé§</span><span>Voice</span></div>
                <div class="menuRight"><span class="pillOff" id="voicePill">off</span></div>
              </div>

              <div class="menuItem" id="miIntel">
                <div class="menuLeft"><span class="menuIcon">üß†</span><span>Intelligence</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>

              <div class="menuItem" id="miLearn">
                <div class="menuLeft"><span class="menuIcon">üìö</span><span>Learning</span></div>
                <div class="menuRight"><span class="pillOn" id="learnPill">on</span></div>
              </div>

              <div class="menuItem" id="miSeed">
                <div class="menuLeft"><span class="menuIcon">üå±</span><span>Feed</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>

              <div class="menuItem" id="miFaith">
                <div class="menuLeft"><span class="menuIcon">üïä</span><span>Faith</span></div>
                <div class="menuRight"><span class="pillOff" id="faithLabel">none</span></div>
              </div>

              <div class="menuItem" id="miIdentity">
                <div class="menuLeft"><span class="menuIcon">ü™™</span><span>Identity</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>

              <div class="menuItem" id="miLLM">
                <div class="menuLeft"><span class="menuIcon">ü§ñ</span><span>LLM</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>

              <div class="menuItem" id="miBMRecall">
                <div class="menuLeft"><span class="menuIcon">üìò</span><span>BM Recall</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>

              <div class="menuItem" id="miHistory">
                <div class="menuLeft"><span class="menuIcon">üìú</span><span>History</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
            </div>

            <div class="console" id="console"></div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="rightCol">
          <div class="chatWrap">
            <!-- reaction buttons above metrics, left-aligned -->
            <div class="reactionBar" id="reactionBar">
              <button class="reactBtn" id="btnLikeLast" title="Save to Intelligence (like)">üëç</button>
              <button class="reactBtn" id="btnDislikeLast" title="Mark incorrect & teach new answer">üëé</button>
              <button class="reactBtn" id="btnSpeakLast" title="Play voice for last answer">üîä</button>
              <button class="reactBtn" id="btnShareLast" title="Copy question + answer">üîó</button>
            </div>

            <div class="liveCapsule">
              <span><b>E0</b>: <span id="cE0">0.000</span></span><span>¬∑</span>
              <span><b>TM</b>: <span id="cTM">0.00</span></span><span>¬∑</span>
              <span><b>BM</b>: <span id="cBM">0.00</span></span><span>¬∑</span>
              <span><b>C</b>: <span id="cCont">0.850</span></span>
            </div>

            <div class="faithBubble" id="faithBubble">
              <div class="fbIcon">üí≠</div>
              <div class="fbText">
                <div class="fbTitle" id="faithBubbleTitle">Faith reflection bubble</div>
                <div class="fbMeta" id="faithBubbleMeta">Tap to see a short suggestion.</div>
              </div>
              <button class="fbClose" id="faithBubbleClose">√ó</button>
            </div>

            <div class="inputRow">
              <input class="input" id="userInput" placeholder="Talk to AURA-X Œ©‚Ä¶ (TM = your inputs)" />
              <button class="send" id="sendBtn">Send</button>
            </div>

            <div class="formula">
              E‚ÇÄ = tanh( R(TM,BM) + I(TM) + I<sub>intel</sub> + I<sub>LLM</sub> ‚àí D + Œª<sub>faith</sub> + Œª<sub>sys</sub> + Œª<sub>trc</sub> )
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast bubble -->
  <div class="toastBubble" id="toastBubble"></div>

  <!-- Faith selection -->
  <div class="modalOverlay" id="modalFaith">
    <div class="modal">
      <div class="modalHeader">
        <div>‚öôÔ∏è AURA-X Œ© options<br><small>Optional faith lens for encouragement lines.</small></div>
        <button class="closeX" data-close="modalFaith">√ó</button>
      </div>
      <div class="modalBody" style="background:#fdf7e5;">
        <div style="opacity:.8;font-size:13px;line-height:1.35;margin-bottom:8px">
          Universal ethics are always active. You can optionally pick one or more faith lenses.
          Nothing is sent to any server.
        </div>
        <div class="chipsWrap" id="faithChips"></div>
      </div>
    </div>
  </div>

  <!-- Faith article (simple stub) -->
  <div class="modalOverlay" id="modalFaithArticle">
    <div class="modal">
      <div class="modalHeader">
        <div>üí≠ Faith reflection<br><small>Story-related suggestion from your selected literature.</small></div>
        <button class="closeX" data-close="modalFaithArticle">√ó</button>
      </div>
      <div class="modalBody" style="background:#fefce8;">
        <div id="faithArticleMeta" style="font-size:12px;opacity:.75;margin-bottom:6px;"></div>
        <div id="faithArticleTitle" style="font-weight:800;margin-bottom:6px;"></div>
        <textarea id="faithArticleText"
          style="width:100%;min-height:160px;border-radius:14px;border:1px solid rgba(15,23,42,.18);padding:10px;font-size:13px;line-height:1.4;background:#fff;"></textarea>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn btnBlue" id="btnCopyFaithArticle">Copy</button>
          <button class="btn btnRed" data-close="modalFaithArticle">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Intelligence -->
  <div class="modalOverlay" id="modalIntel">
    <div class="modal">
      <div class="modalHeader">
        <div>üß† Intelligence<br><small>Stored Q ‚Üí A pairs.</small></div>
        <button class="closeX" data-close="modalIntel">√ó</button>
      </div>
      <div class="modalBody">
        <input id="intelSearch"
          style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);padding:10px 12px;font-size:14px;outline:none"
          placeholder="Search intelligence..." />
        <div id="intelList" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <!-- Seed + Logic -->
  <div class="modalOverlay" id="modalSeed">
    <div class="modal">
      <div class="modalHeader">
        <div>üå± Feed the seed<br><small>Add LaTeX Q ‚Üí A blocks and optional Logic Pack.</small></div>
        <button class="closeX" data-close="modalSeed">√ó</button>
      </div>
      <div class="modalBody">
        <div style="opacity:.75;font-size:13px;line-height:1.35;margin-bottom:10px">
          Paste a LaTeX block with \item questions and \textbf{A:} answers. You can optionally start each
          answer with [polarity=positive; code=E031; intensity=0.8].
        </div>
        <textarea id="seedBox"
          style="width:100%;min-height:150px;resize:vertical;border-radius:14px;border:2px solid rgba(59,130,246,.25);padding:12px;font-size:14px;outline:none;background:#fff"
          placeholder="Paste LaTeX conversation / logic block here..."></textarea>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-top:10px">
          <div style="font-size:12px;opacity:.7" id="seedHint">Waiting for block‚Ä¶</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btnBlue" id="btnParseSeed">Parse block</button>
            <button class="btn btnBlue" id="btnSaveSeed">Save to seed</button>
            <button class="btn btnRed" id="btnDiscardSeed">Discard</button>
          </div>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px dashed rgba(15,23,42,.18);" />

        <div style="font-weight:800;font-size:13px;margin-bottom:6px;">üß© Logic Pack (JSON rules ‚Äì advanced)</div>
        <div style="font-size:12px;opacity:.75;line-height:1.4;margin-bottom:6px;">
          Each time you press <b>Save</b>, a new logic pack is stored with its own number.
          Saved logic packs never auto-delete; they can only be removed manually with double confirmation.
        </div>
        <textarea id="logicBox"
          style="width:100%;min-height:130px;resize:vertical;border-radius:14px;border:2px solid rgba(15,23,42,.18);padding:10px;font-size:13px;outline:none;background:#fff;font-family:ui-monospace,Menlo,Consolas,monospace;"
          placeholder='{
  "cooldown": { "hits": 3, "seconds": 10 },
  "abuseWords": ["stfu","idiot"],
  "faithSoftener": true,
  "ui": { "theme": "golden", "accentColor": "#f97316" }
}'>
        </textarea>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-top:8px;">
          <div style="font-size:12px;opacity:.7" id="logicHint">No logic pack loaded.</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn btnBlue" id="btnValidateLogic">Validate</button>
            <button class="btn btnBlue" id="btnSaveLogic">Save</button>
            <button class="btn btnBlue" id="btnCopyLogic">Copy</button>
            <button class="btn btnRed" id="btnDeleteLogic">Delete</button>
          </div>
        </div>
        <div style="margin-top:6px;font-size:11px;opacity:.6;">
          Current serial: <span id="logicSerial">none</span>
        </div>
      </div>
    </div>
  </div>

  <!-- LLM -->
  <div class="modalOverlay" id="modalLLM">
    <div class="modal">
      <div class="modalHeader">
        <div>ü§ñ Offline LLM<br><small>Local seed ‚Üí Intelligence ‚Üí Offline LLM ‚Üí (future API).</small></div>
        <button class="closeX" data-close="modalLLM">√ó</button>
      </div>
      <div class="modalBody">
        <p style="font-size:13px;line-height:1.5;opacity:.85;">
          This prototype is wired for <b>WebLLM</b>. Once you load a supported model in the browser,
          AURA-X Œ© can route unanswered questions to it after checking local Seed and Intelligence.
        </p>
        <p style="font-size:12px;opacity:.7;margin-top:8px;">
          For now, if no local answer is found, AURA-X Œ© will respond with a simple offline rule-based answer.
        </p>
      </div>
    </div>
  </div>

  <!-- BM snapshots + Dream Mode -->
  <div class="modalOverlay" id="modalBM">
    <div class="modal">
      <div class="modalHeader">
        <div>üìò BM snapshots & Dream Mode<br><small>Save bold memories and set the dream screensaver.</small></div>
        <button class="closeX" data-close="modalBM">√ó</button>
      </div>
      <div class="modalBody">
        <div class="bmCard">
          <div class="bmTop">
            <div class="title">‚úçÔ∏è New BM snapshot</div>
          </div>
          <div class="bmSub">Write a long, meaningful story, event, or memory. It will be saved locally as a Bold Memory (BM).</div>
          <textarea id="bmText" class="bmText" placeholder="Example: The day my life changed when‚Ä¶"></textarea>
          <div class="bmActions">
            <button class="btn btnGreen" id="btnSaveBM">Save snapshot</button>
            <button class="btn btnBlue" id="btnClearBM">Clear</button>
          </div>
        </div>

        <div class="bmCard">
          <div class="bmTop">
            <div class="title">üåô Dream screensaver</div>
          </div>
          <div class="bmSub" style="margin-bottom:6px;">Dream screensaver after how much idle time?</div>
          <select id="dreamDelaySelect"
            style="width:100%;border-radius:14px;border:1px solid rgba(15,23,42,.18);padding:10px 12px;font-size:14px;outline:none;background:#fff;">
            <option value="0">Disabled (no screensaver)</option>
            <option value="30000">30 seconds</option>
            <option value="60000">1 minute</option>
            <option value="180000">3 minutes</option>
            <option value="300000">5 minutes</option>
            <option value="600000">10 minutes</option>
            <option value="1800000">30 minutes</option>
            <option value="3600000">1 hour</option>
            <option value="7200000">2 hours</option>
            <option value="14400000">4 hours</option>
            <option value="28800000">8 hours</option>
          </select>
          <div class="bmSub" style="margin-top:8px;">
            AURA-X Œ© will gently fade into Dream Mode and show floating BM snapshots after this much inactivity.
            Any tap or key press will wake it up immediately.
          </div>
        </div>

        <div class="bmCard">
          <div class="bmTop">
            <div class="title">üìö Saved BM snapshots</div>
          </div>
          <div id="bmList" style="margin-top:4px;font-size:12px;min-height:20px;opacity:.8;">
            No BM snapshots yet.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- History -->
  <div class="modalOverlay" id="modalHistory">
    <div class="modal">
      <div class="modalHeader">
        <div>üìú Conversation history<br><small>Last turns with lock for important lines.</small></div>
        <button class="closeX" data-close="modalHistory">√ó</button>
      </div>
      <div class="modalBody">
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:6px;">
          <button class="btn btnRed" id="btnClearUnlocked">Clear unlocked only</button>
        </div>
        <div id="historyBox"></div>
      </div>
    </div>
  </div>

  <!-- Identity -->
  <div class="modalOverlay" id="modalIdentity">
    <div class="modal">
      <div class="modalHeader">
        <div>ü™™ Deep identity snapshot<br><small>Who are you, in your own words?</small></div>
        <button class="closeX" data-close="modalIdentity">√ó</button>
      </div>
      <div class="modalBody">
        <div class="bmCard">
          <div class="bmTop">
            <div class="title">Self identity</div>
          </div>
          <textarea id="identityText" class="bmText"
            placeholder="I am Alim ul Haq‚Ä¶ My story begins in‚Ä¶ My current work and roles are‚Ä¶"></textarea>
          <div class="bmActions">
            <button class="btn btnGreen" id="btnSaveIdentity">Save identity</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dream screensaver overlay -->
  <div id="dreamOverlay">
    <div class="dreamScreen">
      <div class="dreamTitle">Dream Mode ¬∑ BM snapshots</div>
      <div class="dreamBody" id="dreamBody">
        No BM snapshots yet. Long, meaningful stories will appear here once you save them.
      </div>
      <div class="dreamHint">
        Any tap or key press will wake AURA-X Œ© and return to normal mode.
      </div>
      <div style="margin-top:12px;">
        <button class="btn btnDark" id="btnWake">Wake up</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    "use strict";

    // ---------- Shortcuts ----------
    const $ = id => document.getElementById(id);

    const consoleBox   = $("console");
    const input        = $("userInput");
    const sendBtn      = $("sendBtn");
    const toastBubble  = $("toastBubble");
    const optionsBtn   = $("btnOptions");
    const optionsMenu  = $("optionsMenu");
    const faithBubble  = $("faithBubble");

    const cE0 = $("cE0"), cTM = $("cTM"), cBM = $("cBM"), cCont = $("cCont");

    // Dream mode elements
    const dreamOverlay = $("dreamOverlay");
    const dreamBody    = $("dreamBody");
    const btnWake      = $("btnWake");
    const dreamDelaySelect = $("dreamDelaySelect");

    // ---------- State ----------
    const STORAGE_KEY = "aura_x_state_v9_9";

    const defaultState = {
      tmChars: 0,
      bmScore: 0,
      e0: 0,
      continuity: 0.85,
      history: [],          // {role:'user'|'aura'|'sys', text, ts, locked}
      bmSnapshots: [],      // {id, title, text, ts}
      identity: "",
      seedPairs: [],        // [{q,a}]
      intelPairs: [],       // learned
      logicPacks: [],       // [{id,json}]
      logicSerial: null,
      learningEnabled: true,
      voiceEnabled: false,
      faithTags: [],        // ['Quran','Seerah',...]
      faithCounter: 0,
      dreamDelayMs: 0,      // 0 = disabled
      lastActivity: Date.now(),
      lastQA: null          // {q,a}
    };

    let state = loadState();
    let dreamTimer = null;

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return {...defaultState};
        const obj = JSON.parse(raw);
        return Object.assign({}, defaultState, obj);
      }catch(e){
        console.warn("State load error", e);
        return {...defaultState};
      }
    }
    function saveState(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
      catch(e){ console.warn("State save error", e); }
    }

    // ---------- Toast ----------
    let toastTimeout;
    function showToast(msg, ms=1800){
      toastBubble.textContent = msg;
      toastBubble.classList.add("show");
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(()=>toastBubble.classList.remove("show"), ms);
    }

    // ---------- Console output ----------
    function addLine(text, role="sys"){
      const span = document.createElement("span");
      span.className = "line " + role;
      span.textContent = (role==="user" ? "You: " : role==="aura" ? "AURA-X Œ©: " : "¬∑ ") + text;
      consoleBox.appendChild(span);
      consoleBox.scrollTop = consoleBox.scrollHeight;

      state.history.push({
        role,
        text,
        ts: Date.now(),
        locked: false
      });
      // soft cap
      if(state.history.length > 400){
        state.history = state.history.slice(state.history.length - 400);
      }
      saveState();
      updateMetrics();
    }

    // ---------- Metrics (very simple approximation) ----------
    function updateMetrics(){
      // TM ~ recent user chars
      const userLines = state.history.filter(h=>h.role==="user").slice(-30);
      state.tmChars = userLines.reduce((s,h)=>s + h.text.length,0);
      const tm = Math.min(1.2, state.tmChars/800);  // 0‚Äì1.2
      // BM score from snapshots count + avg length
      const bm = Math.min(1.2, state.bmSnapshots.length * 0.15);
      state.bmScore = bm;
      const R = Math.tanh(0.8*tm + 0.9*bm);
      const iIntel = Math.min(0.4, state.intelPairs.length * 0.02);
      const iLLM   = 0.0; // stub
      const D = 0.05;     // soft decay
      const lambdaFaith = state.faithTags.length ? 0.05 : 0;
      const lambdaSys   = 0.10;
      const lambdaTrc   = 0.05;
      state.e0 = Math.tanh(R + tm*0.4 + iIntel + iLLM - D + lambdaFaith + lambdaSys + lambdaTrc);
      state.continuity = 0.85 + bm*0.05;

      cE0.textContent   = state.e0.toFixed(3);
      cTM.textContent   = tm.toFixed(2);
      cBM.textContent   = bm.toFixed(2);
      cCont.textContent = state.continuity.toFixed(3);
      saveState();
    }

    // ---------- Dream Mode ----------
    function applyDreamDelayToUI(){
      dreamDelaySelect.value = String(state.dreamDelayMs || 0);
    }

    function scheduleDream(){
      clearTimeout(dreamTimer);
      if(!state.dreamDelayMs) return;
      const delay = state.dreamDelayMs;
      dreamTimer = setTimeout(()=>enterDreamMode(), delay);
    }

    function registerActivity(){
      state.lastActivity = Date.now();
      if(dreamOverlay.classList.contains("show")){
        exitDreamMode();
      }
      saveState();
      if(state.dreamDelayMs){
        scheduleDream();
      }
    }

    function enterDreamMode(){
      if(!state.dreamDelayMs) return;
      // choose BM text
      let txt = "No BM snapshots yet. Long, meaningful stories will appear here once you save them.";
      if(state.bmSnapshots.length){
        const snap = state.bmSnapshots[Math.floor(Math.random()*state.bmSnapshots.length)];
        txt = (snap.title ? snap.title+" ‚Äî " : "") + snap.text;
      }
      dreamBody.textContent = txt;
      dreamOverlay.classList.add("show");
    }

    function exitDreamMode(){
      dreamOverlay.classList.remove("show");
      if(state.dreamDelayMs){
        scheduleDream();
      }
    }

    dreamDelaySelect.addEventListener("change", () => {
      const v = parseInt(dreamDelaySelect.value,10) || 0;
      state.dreamDelayMs = v;
      saveState();
      if(v){
        showToast("Dream screensaver set.");
        scheduleDream();
      }else{
        clearTimeout(dreamTimer);
        showToast("Dream screensaver disabled.");
      }
    });

    btnWake.addEventListener("click", () => {
      exitDreamMode();
      registerActivity();
    });

    // any tap / key wakes and counts as activity
    window.addEventListener("pointerdown", registerActivity, {passive:true});
    window.addEventListener("keydown", registerActivity, {passive:true});

    // ---------- BM snapshots ----------
    const bmText  = $("bmText");
    const bmList  = $("bmList");
    $("btnSaveBM").addEventListener("click", () => {
      const text = bmText.value.trim();
      if(!text){
        showToast("Write a story first.");
        return;
      }
      const title = text.split("\n")[0].slice(0,80);
      state.bmSnapshots.push({
        id: "bm_"+Date.now(),
        title,
        text,
        ts: Date.now()
      });
      bmText.value = "";
      saveState();
      renderBMList();
      updateMetrics();
      showToast("BM snapshot saved.");
    });
    $("btnClearBM").addEventListener("click", ()=> bmText.value="");

    function renderBMList(){
      if(!state.bmSnapshots.length){
        bmList.textContent = "No BM snapshots yet.";
        return;
      }
      bmList.innerHTML = "";
      state.bmSnapshots.slice().reverse().forEach(snap=>{
        const div = document.createElement("div");
        div.className = "bmItem";
        const left = document.createElement("div");
        left.innerHTML = `<div class="bmItemTitle">${escapeHtml(snap.title || "Snapshot")}</div>
                          <div class="bmItemMeta">${new Date(snap.ts).toLocaleString()}</div>`;
        const right = document.createElement("div");
        right.className = "bmItemMeta";
        right.textContent = "view";
        div.appendChild(left);
        div.appendChild(right);
        div.addEventListener("click", ()=>{
          // load into textarea
          bmText.value = snap.text;
          showToast("Loaded snapshot into editor.");
        });
        bmList.appendChild(div);
      });
    }

    // ---------- Identity ----------
    const identityBox = $("identityText");
    $("btnSaveIdentity").addEventListener("click", ()=>{
      state.identity = identityBox.value || "";
      saveState();
      showToast("Identity saved locally.");
    });

    // ---------- History ----------
    const historyBox = $("historyBox");
    $("btnClearUnlocked").addEventListener("click", ()=>{
      state.history = state.history.filter(h=>h.locked);
      saveState();
      renderHistory();
      showToast("Cleared unlocked conversation lines.");
    });

    function renderHistory(){
      historyBox.innerHTML = "";
      if(!state.history.length){
        historyBox.textContent = "No history yet.";
        return;
      }
      state.history.slice().forEach((h,idx)=>{
        const row = document.createElement("div");
        row.className = "historyLine";
        const text = document.createElement("div");
        text.className = "historyText";
        const prefix = h.role==="user" ? "You: " : h.role==="aura" ? "AURA-X Œ©: " : "¬∑ ";
        text.textContent = prefix + h.text;
        const lock = document.createElement("button");
        lock.className = "historyLock";
        lock.textContent = h.locked ? "üîí" : "üîì";
        lock.addEventListener("click", ()=>{
          h.locked = !h.locked;
          lock.textContent = h.locked ? "üîí" : "üîì";
          saveState();
        });
        row.appendChild(text);
        row.appendChild(lock);
        historyBox.appendChild(row);
      });
    }

    // ---------- Intelligence & Seed ----------
    function allPairs(){
      return [...state.seedPairs, ...state.intelPairs];
    }

    function renderIntelList(filter=""){
      const list = $("intelList");
      list.innerHTML = "";
      const q = filter.toLowerCase();
      const pairs = allPairs().filter(p =>
        !q || p.q.toLowerCase().includes(q) || p.a.toLowerCase().includes(q)
      );
      if(!pairs.length){
        list.textContent = "No pairs yet.";
        return;
      }
      pairs.forEach((p,idx)=>{
        const card = document.createElement("div");
        card.className = "intelCard";
        const top = document.createElement("div");
        top.className = "intelTop";
        top.innerHTML = `<div class="intelQ">Q: ${escapeHtml(p.q)}</div>
                         <div class="intelMeta">${p.source || "local"}</div>`;
        const ans = document.createElement("div");
        ans.className = "intelA";
        ans.textContent = "A: " + p.a;
        const meta = document.createElement("div");
        meta.className = "intelMeta";
        meta.textContent = "Saved: " + (p.ts ? new Date(p.ts).toLocaleString() : "unknown");
        card.appendChild(top);
        card.appendChild(ans);
        card.appendChild(meta);
        list.appendChild(card);
      });
    }

    $("intelSearch").addEventListener("input", e=>{
      renderIntelList(e.target.value || "");
    });

    function parseSeedBlock(text){
      const items = text.split(/\\item/g).map(s=>s.trim()).filter(Boolean);
      const pairs = [];
      for(const raw of items){
        const qMatch = raw.match(/Q:\s*(.*?)(?=A:|$)/i);
        const aMatch = raw.match(/A:\s*(.*)$/i);
        if(!aMatch) continue;
        const q = qMatch ? cleanupSeed(qMatch[1]) : "(unnamed question)";
        const a = cleanupSeed(aMatch[1]);
        pairs.push({q,a,source:"seed",ts:Date.now()});
      }
      return pairs;
    }
    function cleanupSeed(s){
      return s.replace(/\\\\/g," ").replace(/\s+/g," ").replace(/\\textbf\{.*?\}/g,"").trim();
    }

    $("btnParseSeed").addEventListener("click", ()=>{
      const txt = $("seedBox").value.trim();
      if(!txt){
        showToast("Paste LaTeX block first.");
        return;
      }
      const pairs = parseSeedBlock(txt);
      $("seedHint").textContent = "Parsed " + pairs.length + " Q‚ÜíA pairs. Press Save to store.";
    });

    $("btnSaveSeed").addEventListener("click", ()=>{
      const txt = $("seedBox").value.trim();
      if(!txt){
        showToast("Paste LaTeX block first.");
        return;
      }
      const pairs = parseSeedBlock(txt);
      state.seedPairs.push(...pairs);
      $("seedBox").value = "";
      $("seedHint").textContent = "Saved to seed ("+state.seedPairs.length+" total).";
      saveState();
      showToast("Seed updated.");
    });

    $("btnDiscardSeed").addEventListener("click", ()=>{
      $("seedBox").value = "";
      $("seedHint").textContent = "Waiting for block‚Ä¶";
    });

    // Logic pack (stored but not heavily used in this minimal version)
    $("btnValidateLogic").addEventListener("click", ()=>{
      try{
        JSON.parse($("logicBox").value);
        $("logicHint").textContent = "Valid JSON.";
        showToast("Logic JSON looks valid.");
      }catch(e){
        $("logicHint").textContent = "Invalid JSON: "+e.message;
        showToast("JSON error.");
      }
    });
    $("btnSaveLogic").addEventListener("click", ()=>{
      try{
        const obj = JSON.parse($("logicBox").value);
        const id = "L"+(Date.now());
        state.logicPacks.push({id,obj});
        state.logicSerial = id;
        $("logicSerial").textContent = id;
        $("logicHint").textContent = "Saved logic pack.";
        saveState();
        showToast("Logic pack saved.");
      }catch(e){
        showToast("Fix JSON before saving.");
      }
    });
    $("btnCopyLogic").addEventListener("click", ()=>{
      navigator.clipboard?.writeText($("logicBox").value||"");
      showToast("Logic JSON copied.");
    });
    $("btnDeleteLogic").addEventListener("click", ()=>{
      if(!state.logicPacks.length){ showToast("No logic packs yet."); return; }
      if(!confirm("Delete ALL saved logic packs?")) return;
      state.logicPacks = [];
      state.logicSerial = null;
      $("logicSerial").textContent = "none";
      $("logicHint").textContent = "No logic pack loaded.";
      saveState();
      showToast("Logic packs cleared.");
    });

    // ---------- Faith lens ----------
    const FAITH_OPTIONS = [
      "Quran & Hadith",
      "Seerah & Wisdom",
      "General spirituality"
    ];

    function renderFaithChips(){
      const wrap = $("faithChips");
      wrap.innerHTML = "";
      FAITH_OPTIONS.forEach(label=>{
        const chip = document.createElement("div");
        chip.className = "chip" + (state.faithTags.includes(label) ? " active" : "");
        chip.textContent = label;
        chip.addEventListener("click", ()=>{
          if(state.faithTags.includes(label)){
            state.faithTags = state.faithTags.filter(x=>x!==label);
          }else{
            state.faithTags.push(label);
          }
          saveState();
          renderFaithChips();
          updateFaithLabel();
        });
        wrap.appendChild(chip);
      });
    }

    function updateFaithLabel(){
      const lbl = $("faithLabel");
      if(!state.faithTags.length){
        lbl.className = "pillOff";
        lbl.textContent = "none";
      }else{
        lbl.className = "pillOn";
        lbl.textContent = "on";
      }
    }

    $("faithBubble").addEventListener("click", ()=>{
      openModal("modalFaithArticle");
    });
    $("faithBubbleClose").addEventListener("click", e=>{
      e.stopPropagation();
      faithBubble.style.display = "none";
    });
    $("btnCopyFaithArticle").addEventListener("click", ()=>{
      navigator.clipboard?.writeText($("faithArticleText").value || "");
      showToast("Faith reflection copied.");
    });

    function maybeShowFaithBubble(){
      if(!state.faithTags.length) return;
      state.faithCounter = (state.faithCounter || 0) + 1;
      if(state.faithCounter % 3 !== 0) return; // every 3rd reply
      $("faithArticleMeta").textContent =
        "Lens: " + state.faithTags.join(", ") + " ¬∑ This is a gentle, non-binding reflection.";
      $("faithArticleTitle").textContent = "Faith coefficient Œª_faith ‚Äì soft encouragement";
      $("faithArticleText").value =
        "Think about whether this story is moving you closer to gratitude, patience, or justice. " +
        "Small shifts in intention can increase long-term emotional continuity (E‚ÇÄ).";
      $("faithBubbleTitle").textContent = "Faith reflection available";
      $("faithBubbleMeta").textContent = "Tap to open a short suggestion tied to Œª_faith.";
      faithBubble.style.display = "flex";
      faithBubble.classList.add("pulse");
    }

    // ---------- Voice ----------
    function speak(text){
      if(!state.voiceEnabled){
        showToast("Voice is off.");
        return;
      }
      if(!("speechSynthesis" in window)){
        showToast("Voice not supported in this browser.");
        return;
      }
      const u = new SpeechSynthesisUtterance(text);
      window.speechSynthesis.speak(u);
    }

    $("btnSpeakLast").addEventListener("click", ()=>{
      if(!state.lastQA){ showToast("No answer yet."); return; }
      speak(state.lastQA.a);
    });

    // ---------- Answering ----------
    function handleSend(){
      const q = input.value.trim();
      if(!q){ return; }
      input.value = "";
      addLine(q, "user");
      registerActivity();
      const answer = answerQuestion(q);
      state.lastQA = {q, a:answer};
      addLine(answer, "aura");
      maybeShowFaithBubble();
    }

    function answerQuestion(q){
      // 1) check intelligence / seed
      const pair = findBestPair(q);
      if(pair){
        return pair.a;
      }
      // 2) offline rule-based fallback
      return "I‚Äôm holding this as a new moment in your timeline. Tell me more detail so I can turn it into a BM snapshot or a learned Q‚ÜíA pair.";
    }

    function findBestPair(question){
      const q = question.toLowerCase();
      let best = null;
      let bestScore = 0.0;
      for(const p of allPairs()){
        const words = p.q.toLowerCase().split(/\s+/).filter(w=>w.length>3);
        if(!words.length) continue;
        let matches = 0;
        words.forEach(w=>{ if(q.includes(w)) matches++; });
        const score = matches / words.length;
        if(score > bestScore && score >= 0.4){
          bestScore = score;
          best = p;
        }
      }
      return best;
    }

    sendBtn.addEventListener("click", handleSend);
    input.addEventListener("keydown", e=>{
      if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        handleSend();
      }
    });

    // ---------- Like / Dislike / Copy ----------
    $("btnLikeLast").addEventListener("click", ()=>{
      if(!state.lastQA){ showToast("No answer yet."); return; }
      state.intelPairs.push({
        q: state.lastQA.q,
        a: state.lastQA.a,
        source: "learned",
        ts: Date.now()
      });
      saveState();
      showToast("Saved to Intelligence.");
    });

    $("btnDislikeLast").addEventListener("click", ()=>{
      if(!state.lastQA){ showToast("No answer yet."); return; }
      if(!state.learningEnabled){
        showToast("Learning is off.");
        return;
      }
      const correct = prompt("Answer marked incorrect. Please type the correct answer:");
      if(!correct) return;
      const confirmSave = confirm("Save this corrected answer to Intelligence?");
      if(!confirmSave) return;
      state.intelPairs.push({
        q: state.lastQA.q,
        a: correct,
        source: "corrected",
        ts: Date.now()
      });
      saveState();
      showToast("Correct answer learned.");
    });

    $("btnShareLast").addEventListener("click", ()=>{
      if(!state.lastQA){ showToast("No answer yet."); return; }
      const text = "Q: " + state.lastQA.q + "\nAURA-X Œ©: " + state.lastQA.a;
      navigator.clipboard?.writeText(text);
      showToast("Copied Q + A.");
    });

    // ---------- Options menu ----------
    optionsBtn.addEventListener("click", ()=>{
      optionsMenu.classList.toggle("show");
    });
    document.addEventListener("click", (e)=>{
      if(!optionsMenu.contains(e.target) && e.target!==optionsBtn){
        optionsMenu.classList.remove("show");
      }
    });

    $("miVoice").addEventListener("click", ()=>{
      state.voiceEnabled = !state.voiceEnabled;
      $("voicePill").className = state.voiceEnabled ? "pillOn" : "pillOff";
      $("voicePill").textContent = state.voiceEnabled ? "on" : "off";
      saveState();
      showToast("Voice " + (state.voiceEnabled ? "enabled" : "disabled") + ".");
    });

    $("miLearn").addEventListener("click", ()=>{
      state.learningEnabled = !state.learningEnabled;
      $("learnPill").className = state.learningEnabled ? "pillOn" : "pillOff";
      $("learnPill").textContent = state.learningEnabled ? "on" : "off";
      saveState();
      showToast("Learning " + (state.learningEnabled ? "enabled" : "disabled") + ".");
    });

    $("miIntel").addEventListener("click", ()=>{
      renderIntelList();
      openModal("modalIntel");
    });
    $("miSeed").addEventListener("click", ()=> openModal("modalSeed"));
    $("miFaith").addEventListener("click", ()=>{
      renderFaithChips();
      openModal("modalFaith");
    });
    $("miIdentity").addEventListener("click", ()=>{
      identityBox.value = state.identity || "";
      openModal("modalIdentity");
    });
    $("miLLM").addEventListener("click", ()=> openModal("modalLLM"));
    $("miBMRecall").addEventListener("click", ()=>{
      renderBMList();
      applyDreamDelayToUI();
      openModal("modalBM");
    });
    $("miHistory").addEventListener("click", ()=>{
      renderHistory();
      openModal("modalHistory");
    });

    // ---------- Modal helpers ----------
    function openModal(id){
      $(id).classList.add("show");
    }
    function closeModal(id){
      $(id).classList.remove("show");
    }
    document.querySelectorAll(".closeX").forEach(btn=>{
      const id = btn.getAttribute("data-close");
      if(id){
        btn.addEventListener("click", ()=>closeModal(id));
      }
    });
    document.querySelectorAll(".modalOverlay").forEach(ov=>{
      ov.addEventListener("click", e=>{
        if(e.target===ov){
          ov.classList.remove("show");
        }
      });
    });
    document.querySelectorAll("[data-close]").forEach(btn=>{
      const id = btn.getAttribute("data-close");
      btn.addEventListener("click", ()=> closeModal(id));
    });

    // ---------- Utilities ----------
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[s]));
    }

    // ---------- Init ----------
    function initFromState(){
      // history ‚Üí console
      consoleBox.innerHTML = "";
      state.history.forEach(h=>{
        const role = h.role || "sys";
        const prefix = role==="user"?"You: ":role==="aura"?"AURA-X Œ©: ":"¬∑ ";
        const span = document.createElement("span");
        span.className = "line "+role;
        span.textContent = prefix + h.text;
        consoleBox.appendChild(span);
      });
      consoleBox.scrollTop = consoleBox.scrollHeight;

      // learning + voice pills
      $("learnPill").className = state.learningEnabled ? "pillOn" : "pillOff";
      $("learnPill").textContent = state.learningEnabled ? "on" : "off";
      $("voicePill").className = state.voiceEnabled ? "pillOn" : "pillOff";
      $("voicePill").textContent = state.voiceEnabled ? "on" : "off";

      updateFaithLabel();
      applyDreamDelayToUI();
      renderBMList();
      updateMetrics();

      if(state.dreamDelayMs){
        scheduleDream();
      }
    }

    initFromState();
    addLine("AURA-X Œ© ready. TM = your inputs only; everything else stays on this device.", "sys");
  })();
  </script>
</body>
</html>