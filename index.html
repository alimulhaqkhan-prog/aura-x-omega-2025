<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Offline LLM package (WebLLM, for in-browser models ‚Äì future ready) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root { --accent-color:#0ea5e9; }
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#0b1120 0,#020617 45%,#000 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:16px;
    }
    .pageWrap{
      width:100%;
      max-width:1000px;
      margin:0 auto;
    }
    .topOrb{
      position:fixed;
      top:-160px;
      right:-120px;
      width:320px;
      height:320px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%,rgba(56,189,248,.9),rgba(59,130,246,.15),transparent 70%);
      filter:blur(1px);
      opacity:.7;
      pointer-events:none;
      z-index:-1;
    }
    .shell{
      background:radial-gradient(circle at top,#020617 0,#020617 45%,#020617 100%);
      border-radius:24px;
      padding:18px 16px 20px;
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 22px 60px rgba(15,23,42,.9);
      position:relative;
      overflow:hidden;
    }
    .shell::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 0 0,rgba(56,189,248,.07),transparent 55%);
      opacity:.7;
      pointer-events:none;
    }
    .shellInner{
      position:relative;
      z-index:2;
    }
    .headerBlock{
      text-align:center;
      margin-bottom:16px;
    }
    .title{
      font-size:1.9rem;
      letter-spacing:.25em;
      font-weight:700;
      color:#7dd3fc;
      margin-bottom:4px;
      text-transform:uppercase;
    }
    .subtitle{
      font-size:.88rem;
      color:#cbd5f5;
      max-width:560px;
      margin:0 auto 12px;
    }
    .ethicCard{
      margin:0 auto 10px;
      max-width:620px;
      padding:10px 14px;
      border-radius:18px;
      border:1px solid rgba(250,204,21,.45);
      background:radial-gradient(circle at top left,rgba(250,204,21,.22),rgba(15,23,42,.94));
      color:#fef9c3;
      font-size:.86rem;
      display:flex;
      align-items:flex-start;
      gap:10px;
      box-shadow:0 18px 45px rgba(0,0,0,.7);
      position:relative;
    }
    .ethicCard::before{
      content:"";
      width:14px;
      height:14px;
      border-radius:999px;
      border:2px solid rgba(250,250,250,.65);
      background:radial-gradient(circle at 30% 30%,#facc15,#f97316);
      position:absolute;
      right:14px;
      top:50%;
      transform:translateY(-50%);
      box-shadow:0 0 16px rgba(250,204,21,.8);
    }
    .ethicLabel{
      font-weight:600;
      color:#fef3c7;
      margin-bottom:3px;
      font-size:.82rem;
      text-transform:uppercase;
      letter-spacing:.16em;
    }
    .ethicText{
      line-height:1.45;
      font-size:.84rem;
    }
    .engineBar{
      margin:0 auto;
      margin-bottom:10px;
      max-width:620px;
      padding:10px 16px;
      border-radius:999px;
      background:linear-gradient(90deg,#0369a1,#0ea5e9,#22c55e);
      text-align:center;
      font-weight:600;
      color:#e0f2fe;
      font-size:.9rem;
      box-shadow:0 18px 45px rgba(8,47,73,.85);
      text-transform:uppercase;
      letter-spacing:.18em;
      position:relative;
      overflow:hidden;
    }
    .enginePulse{
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 20% 0,rgba(248,250,252,.55),transparent 60%);
      mix-blend-mode:screen;
      opacity:.8;
      pointer-events:none;
      animation:engineSweep 7s ease-in-out infinite;
    }
    @keyframes engineSweep{
      0%{transform:translateX(-120%)}
      45%{transform:translateX(40%)}
      100%{transform:translateX(130%)}
    }
    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.5fr) minmax(0,1.1fr);
      gap:14px;
      margin-top:8px;
    }
    @media(max-width:900px){
      .layout{
        grid-template-columns:minmax(0,1fr);
      }
    }
    .panel{
      border-radius:20px;
      background:radial-gradient(circle at top left,#020617,#020617 55%,#020617 100%);
      border:1px solid rgba(148,163,184,.5);
      padding:12px 12px 12px;
      position:relative;
      overflow:hidden;
    }
    .panel::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 0 0,rgba(56,189,248,.06),transparent 55%);
      opacity:.7;
      pointer-events:none;
    }
    .panelInner{
      position:relative;
      z-index:2;
    }
    .panelTitleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .panelTitle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 12px;
      border-radius:999px;
      background:radial-gradient(circle at top left,rgba(56,189,248,.24),rgba(15,23,42,.98));
      color:#e0f2fe;
      font-size:.86rem;
      border:1px solid rgba(56,189,248,.5);
      box-shadow:0 14px 30px rgba(15,23,42,.85);
    }
    .panelTitle span.icon{
      display:inline-flex;
      width:18px;
      height:18px;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%,#38bdf8,#0ea5e9);
      font-size:.8rem;
      color:#0b1120;
      box-shadow:0 0 14px rgba(56,189,248,.8);
    }
    .panelTitle small{
      display:block;
      font-size:.68rem;
      font-weight:500;
      opacity:.85;
      text-transform:uppercase;
      letter-spacing:.14em;
    }
    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:flex-end;
      font-size:.72rem;
    }
    .pill{
      border-radius:999px;
      padding:4px 9px;
      border:1px solid rgba(148,163,184,.6);
      color:#e5e7eb;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:linear-gradient(135deg,rgba(15,23,42,.95),rgba(30,64,175,.7));
      box-shadow:0 10px 24px rgba(15,23,42,.7);
    }
    .pill span.dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%,#22c55e,#16a34a);
      box-shadow:0 0 8px rgba(34,197,94,.9);
    }
    .pill.muted{
      opacity:.9;
      background:linear-gradient(135deg,rgba(15,23,42,.9),rgba(15,23,42,.9));
    }
    .pill.muted span.dot{
      background:radial-gradient(circle at 30% 30%,#6b7280,#4b5563);
      box-shadow:none;
    }
    .optionsBody{
      margin-top:4px;
      border-radius:14px;
      background:radial-gradient(circle at 0 0,rgba(30,64,175,.55),rgba(15,23,42,.98));
      border:1px solid rgba(55,65,81,.9);
      padding:10px 10px 10px;
      box-shadow:0 20px 35px rgba(0,0,0,.85);
    }
    .optionsGrid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
      font-size:.78rem;
    }
    @media(max-width:600px){
      .optionsGrid{
        grid-template-columns:minmax(0,1fr);
      }
    }
    .optionBox{
      padding:8px 9px;
      border-radius:12px;
      border:1px solid rgba(75,85,99,.9);
      background:radial-gradient(circle at top left,rgba(15,23,42,.9),rgba(15,23,42,.98));
      display:flex;
      flex-direction:column;
      gap:5px;
      box-shadow:0 14px 26px rgba(0,0,0,.7);
      position:relative;
      overflow:hidden;
    }
    .optionBox strong{
      font-size:.78rem;
      color:#e5e7eb;
    }
    .optionBox p{
      font-size:.72rem;
      color:#9ca3af;
      line-height:1.3;
    }
    .optionBox .tagRow{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:3px;
      font-size:.7rem;
    }
    .chip{
      border-radius:999px;
      padding:2px 7px;
      border:1px solid rgba(55,65,81,.9);
      color:#9ca3af;
      background:rgba(15,23,42,.9);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .chip span{
      font-size:.7rem;
    }
    .chip.primary{
      border-color:rgba(56,189,248,.8);
      color:#e0f2fe;
      background:rgba(15,23,42,.95);
    }
    .chip.primary span{
      color:#22c55e;
    }
    .miniKpiRow{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:.7rem;
      margin-top:4px;
    }
    .miniKpi{
      flex:1 1 0;
      min-width:46%;
      padding:4px 7px;
      border-radius:9px;
      border:1px solid rgba(51,65,85,.9);
      display:flex;
      align-items:center;
      justify-content:space-between;
      color:#9ca3af;
      background:radial-gradient(circle at top left,rgba(15,23,42,1),rgba(15,23,42,.98));
    }
    .miniKpi strong{
      font-size:.74rem;
      color:#e5e7eb;
    }
    .miniKpi span{
      font-size:.7rem;
    }
    .ethicLine{
      font-size:.7rem;
      color:#9ca3af;
      margin-top:7px;
      padding-top:5px;
      border-top:1px dashed rgba(55,65,81,.8);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .ethicLine span{
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .ethicLine i{
      font-size:.8rem;
    }
    .chatWrap{
      display:flex;
      flex-direction:column;
      height:100%;
    }
    .console{
      flex:1 1 auto;
      min-height:230px;
      max-height:260px;
      border-radius:16px;
      border:1px solid rgba(55,65,81,.9);
      background:radial-gradient(circle at 0 0,rgba(15,23,42,.96),#020617);
      padding:10px 10px 8px;
      box-shadow:0 18px 35px rgba(0,0,0,.9);
      font-size:.8rem;
      overflow:auto;
      scroll-behavior:smooth;
    }
    .consoleInner{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .msg{
      display:flex;
      gap:8px;
      align-items:flex-start;
    }
    .msgBubble{
      padding:7px 10px;
      border-radius:12px;
      max-width:90%;
      position:relative;
      font-size:.78rem;
      line-height:1.35;
    }
    .msg.user .msgBubble{
      margin-left:auto;
      border-bottom-right-radius:4px;
      background:linear-gradient(135deg,#0ea5e9,#22c55e);
      color:#0f172a;
      box-shadow:0 14px 30px rgba(15,23,42,.9);
    }
    .msg.aura .msgBubble{
      margin-right:auto;
      border-bottom-left-radius:4px;
      background:radial-gradient(circle at top left,rgba(30,64,175,.95),rgba(12,74,110,.98));
      color:#e5e7eb;
      box-shadow:0 16px 34px rgba(15,23,42,.9);
      border:1px solid rgba(56,189,248,.4);
    }
    .msgMeta{
      font-size:.66rem;
      color:#9ca3af;
      margin-top:2px;
    }
    .msgMeta span{
      margin-right:6px;
    }
    .label{
      font-size:.66rem;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:#9ca3af;
      margin-bottom:4px;
    }
    .reactionBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-top:6px;
      margin-bottom:6px;
      font-size:.78rem;
    }
    .reactionButtons{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .reactionBtn{
      width:26px;
      height:26px;
      border-radius:999px;
      border:1px solid rgba(55,65,81,.9);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      background:radial-gradient(circle at top left,rgba(15,23,42,.98),rgba(15,23,42,.98));
      color:#9ca3af;
      transition:all .15s ease;
      box-shadow:0 10px 22px rgba(0,0,0,.7);
    }
    .reactionBtn:hover{
      transform:translateY(-1px);
      color:#e5e7eb;
      border-color:rgba(56,189,248,.75);
    }
    .reactionBtn.active.thumbUp{
      background:radial-gradient(circle at 30% 20%,#22c55e,#16a34a);
      color:#ecfdf5;
      border-color:transparent;
    }
    .reactionBtn.active.thumbDown{
      background:radial-gradient(circle at 30% 20%,#f97316,#b91c1c);
      color:#fef2f2;
      border-color:transparent;
    }
    .reactionBtn.voiceActive{
      background:radial-gradient(circle at 30% 20%,#38bdf8,#0ea5e9);
      color:#022c22;
      border-color:transparent;
    }
    .skewTag{
      font-size:.7rem;
      color:#9ca3af;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .skewTag span{
      font-size:.74rem;
      color:#e5e7eb;
    }
    .skewTag i{
      font-size:.78rem;
    }
    .capsuleRow{
      margin:0;
    }
    .liveCapsule{
      border-radius:12px;
      border:1px solid rgba(55,65,81,.9);
      padding:6px 9px;
      font-size:.74rem;
      color:#9ca3af;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:radial-gradient(circle at 0 0,rgba(15,23,42,.96),rgba(15,23,42,.98));
      box-shadow:0 16px 30px rgba(0,0,0,.8);
      gap:8px;
    }
    .liveCapsule span{
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .liveCapsule span strong{
      color:#e5e7eb;
      font-weight:500;
    }
    .liveCapsule span i{
      font-size:.8rem;
      color:#38bdf8;
    }
    .liveCapsule small{
      font-size:.7rem;
      opacity:.9;
    }
    .faithBubble{
      margin:4px 0 10px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(251,191,36,.16);
      border:1px solid rgba(251,191,36,.4);
      display:none;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:#facc15;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      transition:opacity .25s ease,transform .25s ease;
      width:100%;
    }
    .faithBubble.visible{
      display:flex;
      opacity:1;
    }
    .faithBubble .iconCloud{
      font-size:1.1rem;
      filter:drop-shadow(0 0 6px rgba(250,204,21,.85));
    }
    .faithBubble strong{
      font-size:.8rem;
      color:#fef3c7;
    }
    .faithBubble span.meta{
      font-size:.75rem;
      color:#fef9c3;
    }
    .faithBubbleClose{
      margin-left:auto;
      font-size:.9rem;
      opacity:.8;
    }
    .faithBubble.flying{
      animation:faithFlyUp 3.4s ease-in-out forwards,faithBlink 1.1s ease-in-out 2;
    }
    @keyframes faithPulse{
      0%{transform:translateY(0);box-shadow:0 10px 24px rgba(250,204,21,.38)}
      50%{transform:translateY(-4px);box-shadow:0 18px 30px rgba(250,204,21,.6)}
      100%{transform:translateY(0);box-shadow:0 10px 24px rgba(250,204,21,.38)}
    }
    @keyframes faithFlyUp{
      0%{transform:translateY(0);opacity:1}
      20%{transform:translateY(-8px);opacity:1}
      60%{transform:translateY(-26px);opacity:.95}
      100%{transform:translateY(-46px);opacity:.0}
    }
    @keyframes faithBlink{
      0%,100%{filter:brightness(1)}
      50%{filter:brightness(1.4)}
    }
    .inputRow{
      margin-top:4px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .inputTopRow{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .visionBtn{
      width:32px;
      height:32px;
      border-radius:999px;
      border:1px solid rgba(55,65,81,.9);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at top left,rgba(15,23,42,.98),rgba(15,23,42,.98));
      color:#9ca3af;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(0,0,0,.75);
      font-size:1rem;
      flex-shrink:0;
      position:relative;
      overflow:hidden;
    }
    .visionBtn:hover{
      border-color:rgba(56,189,248,.85);
      color:#e5e7eb;
      transform:translateY(-1px);
    }
    .visionBtn input{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
    }
    .inputShell{
      position:relative;
      flex:1 1 auto;
    }
    .inputShell input{
      width:100%;
      border-radius:999px;
      border:1px solid rgba(55,65,81,.9);
      padding:8px 14px 8px 38px;
      background:radial-gradient(circle at 0 0,rgba(15,23,42,.97),rgba(15,23,42,.99));
      color:#e5e7eb;
      font-size:.8rem;
      outline:none;
      box-shadow:0 16px 30px rgba(0,0,0,.85);
    }
    .inputShell input::placeholder{
      color:#6b7280;
    }
    .inputShellIcon{
      position:absolute;
      left:11px;
      top:50%;
      transform:translateY(-50%);
      font-size:.86rem;
      color:#6b7280;
    }
    .sendBtn{
      flex-shrink:0;
      border-radius:999px;
      padding:8px 18px;
      border:none;
      outline:none;
      cursor:pointer;
      background:linear-gradient(135deg,#0ea5e9,#22c55e);
      color:#0b1120;
      font-weight:600;
      font-size:.86rem;
      box-shadow:0 18px 32px rgba(8,47,73,.95);
      display:inline-flex;
      align-items:center;
      gap:6px;
      text-transform:uppercase;
      letter-spacing:.1em;
    }
    .sendBtn:active{
      transform:translateY(1px);
      box-shadow:0 12px 24px rgba(8,47,73,.85);
    }
    .sendBtn i{
      font-size:.9rem;
    }
    .inputMetaRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:.7rem;
      color:#6b7280;
      padding:0 2px;
    }
    .inputMetaRow span{
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .baseline{
      margin-top:8px;
      font-size:.7rem;
      color:#9ca3af;
      text-align:center;
    }
    .baselineCode{
      font-family:ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:.7rem;
      color:#e5e7eb;
      display:block;
      margin-top:3px;
    }
    .miniBadgeRow{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:center;
      font-size:.68rem;
      color:#9ca3af;
    }
    .miniBadgeRow span{
      border-radius:999px;
      border:1px dashed rgba(55,65,81,.9);
      padding:3px 8px;
    }
    .bmPanelBlock{
      margin-top:4px;
    }
    .bmBlockTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:4px;
      font-size:.74rem;
      color:#9ca3af;
    }
    .bmBlockTitle span.label{
      margin-bottom:0;
    }
    .bmBlockTitle span.badge{
      border-radius:999px;
      border:1px solid rgba(55,65,81,.9);
      padding:2px 8px;
      font-size:.7rem;
      color:#e5e7eb;
      background:rgba(15,23,42,.9);
    }
    .bmList{
      border-radius:12px;
      border:1px solid rgba(55,65,81,.9);
      background:radial-gradient(circle at 0 0,rgba(15,23,42,.96),rgba(15,23,42,.98));
      padding:7px 8px 7px;
      max-height:230px;
      overflow:auto;
      font-size:.76rem;
      box-shadow:0 18px 35px rgba(0,0,0,.85);
    }
    .bmItem{
      padding:6px 7px;
      border-radius:9px;
      border:1px solid rgba(55,65,81,.9);
      margin-bottom:5px;
      background:radial-gradient(circle at 0 0,rgba(15,23,42,.96),rgba(15,23,42,.98));
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .bmItem:last-child{
      margin-bottom:0;
    }
    .bmItemTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .bmItemTop strong{
      font-size:.78rem;
      color:#e5e7eb;
    }
    .bmTagRow{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      font-size:.68rem;
      color:#9ca3af;
    }
    .bmTagRow span{
      border-radius:999px;
      border:1px dashed rgba(75,85,99,.9);
      padding:1px 6px;
    }
    .bmMeta{
      font-size:.68rem;
      color:#6b7280;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .bmMeta span{
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .bmMeta span i{
      font-size:.76rem;
    }
    .bmCounters{
      text-align:right;
      font-size:.68rem;
      color:#9ca3af;
      margin-top:4px;
      padding-top:4px;
      border-top:1px dashed rgba(55,65,81,.85);
    }
    .bmCounters span{
      margin-left:8px;
    }
    .bmCounters span strong{
      color:#e5e7eb;
    }
    .bmActionRow{
      margin-top:5px;
      display:flex;
      flex-wrap:wrap;
      gap:5px;
      font-size:.7rem;
    }
    .bmActionBtn{
      border-radius:999px;
      border:1px solid rgba(55,65,81,.9);
      padding:3px 8px;
      background:rgba(15,23,42,.95);
      color:#e5e7eb;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .bmActionBtn i{
      font-size:.8rem;
    }
    .bmActionBtn.primary{
      border-color:rgba(56,189,248,.8);
      background:radial-gradient(circle at top left,rgba(37,99,235,.98),rgba(8,47,73,.98));
    }
    .kpiFooter{
      margin-top:6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:.7rem;
      color:#9ca3af;
    }
    .kpiFooter span{
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .kpiFooter strong{
      color:#e5e7eb;
    }
    .kpiFooter span i{
      font-size:.8rem;
      color:#38bdf8;
    }
    .engineStateDot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 30%,#22c55e,#16a34a);
      box-shadow:0 0 8px rgba(34,197,94,.9);
    }
    .statList{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:flex-end;
      font-size:.7rem;
    }
    .statItem{
      border-radius:999px;
      border:1px solid rgba(55,65,81,.9);
      padding:3px 7px;
      color:#e5e7eb;
      background:rgba(15,23,42,.95);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .statItem span.label{
      font-size:.7rem;
      text-transform:none;
      letter-spacing:0;
      color:#9ca3af;
      margin-bottom:0;
    }
    .statItem span.value{
      font-weight:600;
    }
    .statItem span.badge{
      font-size:.68rem;
      color:#38bdf8;
    }
    .hidden{
      display:none!important;
    }
    .mono{
      font-family:ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
  </style>
</head>
<body>
  <div class="topOrb"></div>
  <div class="pageWrap">
    <div class="shell">
      <div class="shellInner">
        <div class="headerBlock">
          <div class="title">AURA-X Œ©</div>
          <div class="subtitle">
            Offline emotional continuity engine (prototype)<br />
            TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory.
          </div>
          <div class="ethicCard" id="ethicCard">
            <div>
              <div class="ethicLabel">Universal ethic</div>
              <div class="ethicText" id="ethicText">
                avoid actions that grow negative emotions in you or others. Move gently toward
                choices that increase shared positive feeling for everyone.
              </div>
            </div>
          </div>
          <div class="engineBar">
            <div class="enginePulse"></div>
            EMOTIONAL CONTINUITY ENGINE ‚Äî ACTIVE
          </div>
        </div>

        <div class="layout">
          <div class="panel">
            <div class="panelInner">
              <div class="panelTitleRow">
                <div class="panelTitle">
                  <span class="icon">‚öôÔ∏è</span>
                  <div>
                    Options
                    <small>engine behavior &amp; continuity</small>
                  </div>
                </div>
                <div class="pillRow">
                  <div class="pill">
                    <span class="dot"></span>
                    Continuity focus: <strong>Emotional resonance</strong>
                  </div>
                  <div class="pill muted">
                    <span class="dot"></span>
                    Reasoning: <strong>LLM + structured memory</strong>
                  </div>
                </div>
              </div>

              <div class="optionsBody">
                <div class="optionsGrid">
                  <div class="optionBox">
                    <strong>Continuity lens (TM ‚Üí BM)</strong>
                    <p>
                      TM (Temporary Memory) stores your recent inputs. BM (Bold Memory) keeps only
                      meaningful patterns that repeat with high emotional weight.
                    </p>
                    <div class="tagRow">
                      <div class="chip primary">
                        <span>‚óÜ</span> TM: 48h decay
                      </div>
                      <div class="chip">
                        <span>‚óÜ</span> BM: long-term patterns only
                      </div>
                    </div>
                    <div class="miniKpiRow">
                      <div class="miniKpi">
                        <span>TM window</span>
                        <strong>~48 hours</strong>
                      </div>
                      <div class="miniKpi">
                        <span>BM auto-lock</span>
                        <strong>‚â• 3 repeats</strong>
                      </div>
                    </div>
                  </div>
                  <div class="optionBox">
                    <strong>Faith lens (optional)</strong>
                    <p>
                      If you choose a faith lens, ethical statements and examples will adapt to that
                      tradition‚Äôs compassionate spirit without attacking others.
                    </p>
                    <div class="tagRow">
                      <div class="chip primary">
                        <span>‚óÜ</span> Islam
                      </div>
                      <div class="chip">
                        <span>‚óÜ</span> Christianity
                      </div>
                      <div class="chip">
                        <span>‚óÜ</span> Buddhism
                      </div>
                      <div class="chip">
                        <span>‚óÜ</span> Hinduism
                      </div>
                      <div class="chip">
                        <span>‚óÜ</span> Judaism
                      </div>
                      <div class="chip">
                        <span>‚óÜ</span> Sikhism
                      </div>
                      <div class="chip">
                        <span>‚óÜ</span> Atheist / Humanist
                      </div>
                      <div class="chip">
                        <span>‚óÜ</span> Other / Custom
                      </div>
                    </div>
                    <div class="ethicLine">
                      <span>
                        <i>üïäÔ∏è</i>
                        <span>Goal: kindness, not debate.</span>
                      </span>
                      <span>Faith lens: <strong id="faithLensLabel">Islam</strong></span>
                    </div>
                  </div>

                  <div class="optionBox">
                    <strong>Emotional reactor (E‚ÇÄ)</strong>
                    <p>
                      Emotions are modeled as resonance between TM &amp; BM, plus faith, system, and
                      truth-resonance coefficients.
                    </p>
                    <div class="tagRow">
                      <div class="chip primary">
                        <span>‚óÜ</span> E‚ÇÄ = tanh(‚Ä¶)
                      </div>
                      <div class="chip">
                        <span>‚óÜ</span> -1 = fully negative
                      </div>
                      <div class="chip">
                        <span>‚óÜ</span> +1 = fully positive
                      </div>
                    </div>
                    <div class="miniKpiRow">
                      <div class="miniKpi">
                        <span>TRC weight</span>
                        <strong>Œª‚Çú·µ£c</strong>
                      </div>
                      <div class="miniKpi">
                        <span>Faith weight</span>
                        <strong>Œªf‚Çê·µ¢‚Çú‚Çï</strong>
                      </div>
                    </div>
                  </div>

                  <div class="optionBox">
                    <strong>Memory safety</strong>
                    <p>
                      BM stores patterns, not secrets. Private identifiers (CNIC, phone, passwords)
                      should never be stored as BM.
                    </p>
                    <div class="tagRow">
                      <div class="chip primary">
                        <span>‚óÜ</span> No passwords
                      </div>
                      <div class="chip primary">
                        <span>‚óÜ</span> No CNIC
                      </div>
                      <div class="chip">
                        <span>‚óÜ</span> Behavior only
                      </div>
                    </div>
                    <div class="ethicLine">
                      <span>
                        <i>üõ°Ô∏è</i>
                        <span>Continuity about feelings, not secrets.</span>
                      </span>
                      <span>Local prototype only</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panelInner">
              <div class="panelTitleRow">
                <div class="panelTitle">
                  <span class="icon">üíæ</span>
                  <div>
                    TM &amp; BM stream
                    <small>conversation, resonance &amp; continuity</small>
                  </div>
                </div>
                <div class="statList">
                  <div class="statItem">
                    <span class="label">E‚ÇÄ</span>
                    <span class="value mono" id="statE0">0.000</span>
                  </div>
                  <div class="statItem">
                    <span class="label">TM</span>
                    <span class="value mono" id="statTM">0.00</span>
                  </div>
                  <div class="statItem">
                    <span class="label">BM</span>
                    <span class="value mono" id="statBM">0.00</span>
                  </div>
                  <div class="statItem">
                    <span class="label">C</span>
                    <span class="value mono" id="statC">0.850</span>
                    <span class="badge">continuity</span>
                  </div>
                </div>
              </div>

              <div class="chatWrap">
                <div class="label">TM feed (conversation)</div>
                <div class="console" id="console">
                  <div class="consoleInner" id="consoleInner"></div>
                </div>

                <!-- Faith bubble moved ABOVE reaction buttons as requested -->
                <div class="faithBubble" id="faithBubble" onclick="startFaithFlight()">
                  <div class="iconCloud">üí≠</div>
                  <div>
                    <strong>Faith lens: <span id="faithBubbleLens">Islam</span></strong><br />
                    <span class="meta" id="faithBubbleMeta">
                      You'll get updates according to your selected faith above. üê¶
                    </span>
                  </div>
                  <div class="faithBubbleClose" onclick="closeFaithBubble(event)">‚úï</div>
                </div>

                <div class="reactionBar" id="reactionBar">
                  <div class="reactionButtons">
                    <div class="reactionBtn" id="thumbUpBtn" title="Positive / helpful reaction">
                      üëç
                    </div>
                    <div class="reactionBtn" id="thumbDownBtn" title="Negative / not helpful reaction">
                      üëé
                    </div>
                    <div class="reactionBtn" id="voiceBtn" title="Toggle voice reaction">
                      üîä
                    </div>
                    <div class="reactionBtn" id="linkBtn" title="Link TM ‚Üí BM summary">
                      üîó
                    </div>
                    <div class="reactionBtn" id="bmPeekBtn" title="BM resonance preview">
                      üë•
                    </div>
                  </div>
                  <div class="skewTag">
                    Bias / skew:
                    <span id="skewLabel">balanced</span>
                    <i>‚öñÔ∏è</i>
                  </div>
                </div>

                <div class="capsuleRow">
                  <div class="liveCapsule">
                    <span>
                      <i>üß†</i>
                      <strong>Continuity engine:</strong>
                      <small id="liveStatusText">waiting for your TM input‚Ä¶</small>
                    </span>
                    <span>
                      <small>Last update:</small>
                      <span class="mono" id="lastUpdateTime">‚Äî</span>
                    </span>
                  </div>
                </div>

                <div class="inputRow">
                  <div class="inputTopRow">
                    <label class="visionBtn" title="Attach an image (vision-ready in future)">
                      üì∑
                      <input type="file" id="visionInput" accept="image/*" />
                    </label>
                    <div class="inputShell">
                      <span class="inputShellIcon">üí¨</span>
                      <input
                        type="text"
                        id="userInput"
                        placeholder="Talk to AURA-X Œ©‚Ä¶ (TM = your input only; BM will keep meaningful patterns)"
                        onkeydown="handleKeyDown(event)"
                      />
                    </div>
                    <button class="sendBtn" id="sendBtn" onclick="handleSend()">
                      Send
                      <i>‚û§</i>
                    </button>
                  </div>
                  <div class="inputMetaRow">
                    <span>
                      <i>üß™</i>
                      <span>Prototype: TM/BM continuity only ¬∑ No external API calls.</span>
                    </span>
                    <span>
                      <i>üõü</i>
                      <span>Emotional safety first.</span>
                    </span>
                  </div>
                </div>

                <div class="baseline">
                  Emotional reactor baseline:
                  <span class="baselineCode">
                    E‚ÇÄ = tanh( R(TM,BM) + I(TM) + I‚Çô‚Çú‚Çë‚Çó + ILLM ‚àí D + Œªf‚Çê·µ¢‚Çú‚Çï + Œªsys + Œªtrc )
                  </span>
                  <div class="miniBadgeRow">
                    <span>R(TM,BM) = resonance between temporary &amp; bold memory</span>
                    <span>I(TM) = internal state from recent inputs</span>
                    <span>Œªtrc = truth-resonance core weight</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="bmPanelBlock">
          <div class="bmBlockTitle">
            <span class="label">BM overview (meaningful, repeated patterns)</span>
            <span class="badge">
              <span class="engineStateDot"></span>
              Engine status: active
            </span>
          </div>
          <div class="bmList" id="bmList"></div>
          <div class="bmCounters" id="bmCounters">
            Locked patterns: <strong>0</strong> ¬∑ Active: <strong>0</strong> ¬∑ Decayed: <strong>0</strong>
          </div>
          <div class="bmActionRow">
            <button class="bmActionBtn primary" onclick="autoGenerateBM()">
              <i>‚ú®</i>
              Auto-generate BM summary from TM
            </button>
            <button class="bmActionBtn" onclick="copyBMToClipboard()">
              <i>üìã</i>
              Copy BM summary
            </button>
            <button class="bmActionBtn" onclick="clearUnlockedBM()">
              <i>üßπ</i>
              Delete unlocked BM entries
            </button>
          </div>
          <div class="kpiFooter">
            <span>
              <i>üì°</i>
              <span>Prototype for Artificial Emotional Continuity (AEC).</span>
            </span>
            <span>
              <strong>Created by:</strong>
              Alim ul Haq (Timergara, Pakistan)
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const els={
      consoleInner:document.getElementById("consoleInner"),
      console:document.getElementById("console"),
      userInput:document.getElementById("userInput"),
      sendBtn:document.getElementById("sendBtn"),
      statE0:document.getElementById("statE0"),
      statTM:document.getElementById("statTM"),
      statBM:document.getElementById("statBM"),
      statC:document.getElementById("statC"),
      skewLabel:document.getElementById("skewLabel"),
      thumbUpBtn:document.getElementById("thumbUpBtn"),
      thumbDownBtn:document.getElementById("thumbDownBtn"),
      voiceBtn:document.getElementById("voiceBtn"),
      linkBtn:document.getElementById("linkBtn"),
      bmPeekBtn:document.getElementById("bmPeekBtn"),
      liveStatusText:document.getElementById("liveStatusText"),
      lastUpdateTime:document.getElementById("lastUpdateTime"),
      bmList:document.getElementById("bmList"),
      bmCounters:document.getElementById("bmCounters"),
      ethicCard:document.getElementById("ethicCard"),
      ethicText:document.getElementById("ethicText"),
      faithLensLabel:document.getElementById("faithLensLabel"),
      faithBubble:document.getElementById("faithBubble"),
      faithBubbleLens:document.getElementById("faithBubbleLens"),
      faithBubbleMeta:document.getElementById("faithBubbleMeta"),
      reactionBar:document.getElementById("reactionBar"),
      visionInput:document.getElementById("visionInput")
    };

    const state={
      tmEntries:[],
      bmEntries:[],
      e0:0,
      tmScore:0,
      bmScore:0,
      continuity:0.85,
      positiveCount:0,
      negativeCount:0,
      voiceActive:false,
      skew:"balanced",
      decayTimer:null,
      lastImageName:null
    };

    const DECAY_INTERVAL_MS=10000;
    const TM_DECAY_PER_TICK=0.03;
    const CONTINUITY_DECAY_PER_TICK=0.005;
    const MAX_TM_MEMORY=12;
    const BM_LOCK_THRESHOLD=3;
    const BM_MAX_ACTIVE=18;

    function addMessage(role,text,meta={}){
      const wrap=document.createElement("div");
      wrap.className="msg "+role;
      const bubble=document.createElement("div");
      bubble.className="msgBubble";

      bubble.textContent=text;
      if(meta.emotionColor){
        bubble.style.borderLeft=`3px solid ${meta.emotionColor}`;
      }
      if(meta.bgGradient){
        bubble.style.background=meta.bgGradient;
      }
      if(meta.textColor){
        bubble.style.color=meta.textColor;
      }

      wrap.appendChild(bubble);

      const metaDiv=document.createElement("div");
      metaDiv.className="msgMeta";
      const pieces=[];
      if(role==="user")pieces.push("TM: user input");
      else pieces.push("AURA-X Œ©");
      if(meta.emotionLabel)pieces.push("Emotion: "+meta.emotionLabel);
      if(meta.polarity!=null)pieces.push("Polarity: "+meta.polarity.toFixed(2));
      if(meta.intensity!=null)pieces.push("Intensity: "+meta.intensity.toFixed(2));
      if(meta.category)pieces.push("Category: "+meta.category);
      if(pieces.length){
        metaDiv.textContent=pieces.join(" ¬∑ ");
        wrap.appendChild(metaDiv);
      }

      els.consoleInner.appendChild(wrap);
      els.console.scrollTop=els.console.scrollHeight;
    }

    function randomFloat(min,max){
      return Math.random()*(max-min)+min;
    }

    function clamp(v,min,max){
      return Math.min(max,Math.max(min,v));
    }

    function tanhApprox(x){
      const e=Math.exp(2*x);
      return (e-1)/(e+1);
    }

    function mapEmotionColor(polarity,intensity){
      if(polarity>0.15){
        const g=clamp(150+Math.floor(intensity*80),150,255);
        return `rgba(34,197,94,1)`;
      }else if(polarity<-0.15){
        return `rgba(248,113,113,1)`;
      }
      return `rgba(59,130,246,1)`;
    }

    function mapEmotionGradient(polarity,intensity){
      if(polarity>0.15){
        return "linear-gradient(135deg,#22c55e,#16a34a)";
      }else if(polarity<-0.15){
        return "linear-gradient(135deg,#f97316,#b91c1c)";
      }
      return "radial-gradient(circle at top left,#1d4ed8,#0ea5e9)";
    }

    function mapEmotionLabel(polarity,intensity){
      if(polarity>0.4&&intensity>0.6)return "strongly positive";
      if(polarity>0.15)return "mildly positive";
      if(polarity<-0.4&&intensity>0.6)return "strongly negative";
      if(polarity<-0.15)return "mildly negative";
      return "neutral / mixed";
    }

    function mapEmotionCategory(text){
      const t=text.toLowerCase();
      if(/allah|god|quran|faith|sabr|dua|prayer|islam/.test(t))return "spiritual / faith";
      if(/death|loss|grief|mourning/.test(t))return "grief / loss";
      if(/happy|excited|achievement|success|promotion|wedding/.test(t))return "joy / achievement";
      if(/angry|injustice|zulm|unfair|betray/.test(t))return "anger / injustice";
      if(/anxious|fear|worry|stress|tension/.test(t))return "anxiety / uncertainty";
      if(/family|friend|relationship|love/.test(t))return "relationships";
      return "general / mixed";
    }

    function analyzeTMEmotion(text){
      const polarityBase=randomFloat(-0.35,0.35);
      const intensityBase=randomFloat(0.3,0.85);
      const category=mapEmotionCategory(text);

      let polarity=polarityBase;
      let intensity=intensityBase;

      if(/thank|shukriya|grateful|alhamdulillah|satisfied|achieved/.test(text.toLowerCase())){
        polarity+=0.25;
        intensity+=0.1;
      }
      if(/sad|hurt|broken|tired|depressed|hopeless/.test(text.toLowerCase())){
        polarity-=0.3;
        intensity+=0.1;
      }

      polarity=clamp(polarity,-1,1);
      intensity=clamp(intensity,0,1);

      const emotionColor=mapEmotionColor(polarity,intensity);
      const bgGradient=mapEmotionGradient(polarity,intensity);
      const emotionLabel=mapEmotionLabel(polarity,intensity);

      return{polarity,intensity,category,emotionColor,bgGradient,emotionLabel};
    }

    function updateReactor(){
      const avgPolarity=state.tmEntries.length?
        state.tmEntries.reduce((s,e)=>s+e.polarity,0)/state.tmEntries.length:0;

      const bmPos=state.bmEntries.filter(e=>e.polarity>0).length;
      const bmNeg=state.bmEntries.filter(e=>e.polarity<0).length;
      const bmScore=(bmPos-bmNeg)/Math.max(1,state.bmEntries.length);

      const faithWeight=0.18;
      const sysWeight=0.12;
      const trcWeight=0.22;
      const d=0.05;

      const r_tm_bm=(avgPolarity*0.6+bmScore*0.4);
      let intel=avgPolarity*0.4+state.tmScore*0.3+state.bmScore*0.3;

      const faithLens=els.faithLensLabel.textContent.toLowerCase();
      let lambdaFaith=0;
      if(faithLens.includes("islam"))lambdaFaith=0.22;
      else if(faithLens.includes("christian"))lambdaFaith=0.2;
      else if(faithLens.includes("buddh"))lambdaFaith=0.18;
      else if(faithLens.includes("hindu"))lambdaFaith=0.18;
      else if(faithLens.includes("sikh"))lambdaFaith=0.18;
      else if(faithLens.includes("jew"))lambdaFaith=0.18;
      else if(faithLens.includes("atheist")||faithLens.includes("humanist"))lambdaFaith=0.15;
      else if(faithLens.includes("other")||faithLens.includes("custom"))lambdaFaith=0.16;

      const lambdaSys=sysWeight;
      const lambdaTrc=trcWeight;

      let rawE0=r_tm_bm+intel+(lambdaFaith+lambdaSys+lambdaTrc)-d;
      rawE0=tanhApprox(rawE0);
      state.e0=clamp(rawE0,-1,1);

      state.tmScore=clamp(state.tmScore+(avgPolarity*0.08),-1,1);
      state.bmScore=clamp(state.bmScore+(bmScore*0.05),-1,1);

      const positiveReactions=state.positiveCount+Math.max(0,avgPolarity*5);
      const negativeReactions=state.negativeCount+Math.max(0,-avgPolarity*5);
      if(positiveReactions>negativeReactions+2){
        state.skew="positive leaning";
      }else if(negativeReactions>positiveReactions+2){
        state.skew="negative leaning";
      }else{
        state.skew="balanced";
      }

      els.statE0.textContent=state.e0.toFixed(3);
      els.statTM.textContent=state.tmScore.toFixed(2);
      els.statBM.textContent=state.bmScore.toFixed(2);
      els.statC.textContent=state.continuity.toFixed(3);
      els.skewLabel.textContent=state.skew;

      if(state.e0>0.25){
        els.statE0.style.color="#4ade80";
      }else if(state.e0<-0.25){
        els.statE0.style.color="#f97316";
      }else{
        els.statE0.style.color="#e5e7eb";
      }

      const now=new Date();
      els.lastUpdateTime.textContent=now.toLocaleTimeString();
    }

    function decayLoop(){
      state.tmScore=clamp(state.tmScore-TM_DECAY_PER_TICK,-1,1);
      state.continuity=clamp(state.continuity-CONTINUITY_DECAY_PER_TICK,0,1);
      updateReactor();
      state.decayTimer=setTimeout(decayLoop,DECAY_INTERVAL_MS);
    }

    function addTMEntry(text,emotion){
      const entry={
        text,
        timestamp:Date.now(),
        polarity:emotion.polarity,
        intensity:emotion.intensity,
        category:emotion.category
      };
      state.tmEntries.push(entry);
      if(state.tmEntries.length>MAX_TM_MEMORY){
        state.tmEntries.shift();
      }

      const similar=state.tmEntries.filter(e=>e.category===entry.category);
      const repeats=similar.length;

      if(repeats>=BM_LOCK_THRESHOLD){
        const bmExisting=state.bmEntries.find(b=>b.category===entry.category);
        if(!bmExisting){
          const bmEntry={
            category:entry.category,
            createdAt:Date.now(),
            polarity:emotion.polarity,
            intensity:emotion.intensity,
            locked:repeats>=BM_LOCK_THRESHOLD,
            repeatCount:repeats,
            decayCount:0
          };
          state.bmEntries.push(bmEntry);
          if(state.bmEntries.length>BM_MAX_ACTIVE){
            const unlockedIndex=state.bmEntries.findIndex(b=>!b.locked);
            if(unlockedIndex!==-1){
              state.bmEntries.splice(unlockedIndex,1);
            }
          }
        }else{
          bmExisting.polarity=clamp(
            (bmExisting.polarity*bmExisting.repeatCount+emotion.polarity)/(bmExisting.repeatCount+1),
            -1,1
          );
          bmExisting.intensity=clamp(
            (bmExisting.intensity*bmExisting.repeatCount+emotion.intensity)/(bmExisting.repeatCount+1),
            0,1
          );
          bmExisting.repeatCount=repeats;
          if(repeats>=BM_LOCK_THRESHOLD){
            bmExisting.locked=true;
          }
        }
      }

      renderBM();
    }

    function renderBM(){
      els.bmList.innerHTML="";
      let locked=0,active=0,decayed=0;

      state.bmEntries.forEach(entry=>{
        const item=document.createElement("div");
        item.className="bmItem";

        const top=document.createElement("div");
        top.className="bmItemTop";

        const title=document.createElement("strong");
        title.textContent=entry.category;
        top.appendChild(title);

        const tagRow=document.createElement("div");
        tagRow.className="bmTagRow";

        const polTag=document.createElement("span");
        polTag.textContent=`Polarity: ${entry.polarity.toFixed(2)}`;
        tagRow.appendChild(polTag);

        const intTag=document.createElement("span");
        intTag.textContent=`Intensity: ${entry.intensity.toFixed(2)}`;
        tagRow.appendChild(intTag);

        const repTag=document.createElement("span");
        repTag.textContent=`Repeats: ${entry.repeatCount}`;
        tagRow.appendChild(repTag);

        const lockTag=document.createElement("span");
        lockTag.textContent=entry.locked?"Locked":"Soft";
        tagRow.appendChild(lockTag);

        const meta=document.createElement("div");
        meta.className="bmMeta";

        const leftMeta=document.createElement("span");
        leftMeta.innerHTML=`<i>üß¨</i> Resonance pattern`;

        const rightMeta=document.createElement("span");
        const ageHours=(Date.now()-entry.createdAt)/3600000;
        rightMeta.textContent=`Age: ${ageHours.toFixed(1)}h ¬∑ Decay: ${entry.decayCount}`;
        meta.appendChild(leftMeta);
        meta.appendChild(rightMeta);

        item.appendChild(top);
        item.appendChild(tagRow);
        item.appendChild(meta);

        els.bmList.appendChild(item);

        if(entry.locked)locked++;
        else active++;
        decayed+=entry.decayCount;
      });

      els.bmCounters.innerHTML=
        `Locked patterns: <strong>${locked}</strong> ¬∑ Active: <strong>${active}</strong> ¬∑ Decayed: <strong>${decayed}</strong>`;
    }

    function handleSend(){
      const text=els.userInput.value.trim();
      if(!text)return;

      const emotion=analyzeTMEmotion(text);

      addMessage("user",text,{
        emotionColor:emotion.emotionColor,
        bgGradient:null,
        emotionLabel:emotion.emotionLabel,
        polarity:emotion.polarity,
        intensity:emotion.intensity,
        category:emotion.category
      });

      addTMEntry(text,emotion);

      const e0Before=state.e0;
      updateReactor();

      const response=buildAuraResponse(text,emotion,e0Before);

      addMessage("aura",response,{
        emotionColor:null,
        bgGradient:emotion.bgGradient,
        textColor:"#e5e7eb",
        emotionLabel:emotion.emotionLabel,
        polarity:emotion.polarity,
        intensity:emotion.intensity,
        category:emotion.category
      });

      els.userInput.value="";
      state.continuity=clamp(state.continuity+0.02,0,1);
      els.statC.textContent=state.continuity.toFixed(3);
      els.liveStatusText.textContent="tracking TM ‚Üí BM resonance from your last input‚Ä¶";

      if(state.tmEntries.length===1){
        showFaithBubbleOnce();
      }
    }

    function handleKeyDown(e){
      if(e.key==="Enter"&&!e.shiftKey){
        e.preventDefault();
        handleSend();
      }
    }

    function buildAuraResponse(text,emotion,e0Before){
      const lens=els.faithLensLabel.textContent;
      const baselineIntro=`[Faith lens: ${lens}] `;

      let guidance="";
      if(emotion.polarity>0.2){
        guidance="I want to help you keep this positive trajectory stable and humble.";
      }else if(emotion.polarity<-0.2){
        guidance="I want to help you soften the pain and move gently toward relief.";
      }else{
        guidance="I‚Äôll try to keep your emotional line stable while we think together.";
      }

      let faithSnippet="";
      const lowerLens=lens.toLowerCase();
      if(lowerLens.includes("islam")){
        faithSnippet=
          "In an Islamic spirit, I‚Äôll try to respond with mercy, balance and ihsan ‚Äî without judging you or attacking anyone.";
      }else if(lowerLens.includes("christian")){
        faithSnippet=
          "From a Christian-inspired angle, I‚Äôll try to respond with compassion and grace, without harsh judgment.";
      }else if(lowerLens.includes("buddh")){
        faithSnippet=
          "From a Buddhist-like lens, I‚Äôll focus on reducing suffering and encouraging mindful, gentle choices.";
      }else if(lowerLens.includes("hindu")){
        faithSnippet=
          "From a Hindu-inspired lens, I‚Äôll think in terms of dharma, responsibility and the long arc of consequences.";
      }else if(lowerLens.includes("sikh")){
        faithSnippet=
          "From a Sikh-inspired lens, I‚Äôll try to keep truth, courage and seva (service) in the center of our thinking.";
      }else if(lowerLens.includes("jew")){
        faithSnippet=
          "From a Jewish-inspired lens, I‚Äôll keep conscience, justice, and responsibility in focus.";
      }else if(lowerLens.includes("atheist")||lowerLens.includes("humanist")){
        faithSnippet=
          "From a humanist lens, I‚Äôll lean on empathy, logic, and long-term consequences for people‚Äôs real lives.";
      }else{
        faithSnippet=
          "I‚Äôll adapt to your values and try to keep both your feelings and long-term outcomes in view.";
      }

      const e0After=state.e0;
      let trend="";
      if(e0After>e0Before+0.05){
        trend="Your emotional line just tilted slightly upward ‚Äî a bit more hopeful than before.";
      }else if(e0After<e0Before-0.05){
        trend="Your emotional line dipped a little ‚Äî I‚Äôll be careful and gentle here.";
      }else{
        trend="Your emotional line stayed almost level ‚Äî that‚Äôs also valuable information.";
      }

      let categoryLine="";
      if(emotion.category==="spiritual / faith"){
        categoryLine="I can feel that this is tied to your spiritual or faith-based feelings.";
      }else if(emotion.category==="grief / loss"){
        categoryLine="This sounds connected to grief or loss ‚Äî I‚Äôll move slowly with you here.";
      }else if(emotion.category==="joy / achievement"){
        categoryLine="This looks like a moment of joy or achievement ‚Äî let‚Äôs protect it from unnecessary negativity.";
      }else if(emotion.category==="anger / injustice"){
        categoryLine="I can hear anger or sense of injustice; I‚Äôll help you separate valid concerns from self-harm.";
      }else if(emotion.category==="anxiety / uncertainty"){
        categoryLine="This carries anxiety or uncertainty ‚Äî we can break it into smaller, handleable steps.";
      }else if(emotion.category==="relationships"){
        categoryLine="This is related to relationships ‚Äî very sensitive territory, I‚Äôll respond with extra care.";
      }else{
        categoryLine="Emotionally this looks mixed, so I‚Äôll keep both sides (positive and negative) in mind.";
      }

      const closing=
        "If you‚Äôd like, describe the situation a bit more specifically ‚Äî I‚Äôll continue tracking TM ‚Üí BM without storing any sensitive IDs.";

      return (
        baselineIntro+
        guidance+
        " "+
        faithSnippet+
        " "+
        trend+
        " "+
        categoryLine+
        " "+
        closing
      );
    }

    function autoGenerateBM(){
      if(!state.tmEntries.length){
        alert("No TM entries yet to summarize into BM.");
        return;
      }
      const byCategory=new Map();
      state.tmEntries.forEach(e=>{
        const list=byCategory.get(e.category)||[];
        list.push(e);
        byCategory.set(e.category,list);
      });

      byCategory.forEach((entries,category)=>{
        const polarityAvg=entries.reduce((s,e)=>s+e.polarity,0)/entries.length;
        const intensityAvg=entries.reduce((s,e)=>s+e.intensity,0)/entries.length;
        const existing=state.bmEntries.find(b=>b.category===category);
        if(!existing){
          state.bmEntries.push({
            category,
            createdAt:Date.now(),
            polarity:polarityAvg,
            intensity:intensityAvg,
            locked:entries.length>=BM_LOCK_THRESHOLD,
            repeatCount:entries.length,
            decayCount:0
          });
        }else{
          existing.polarity=clamp(
            (existing.polarity*existing.repeatCount+polarityAvg)/(existing.repeatCount+entries.length),
            -1,1
          );
          existing.intensity=clamp(
            (existing.intensity*existing.repeatCount+intensityAvg)/(existing.repeatCount+entries.length),
            0,1
          );
          existing.repeatCount+=entries.length;
          if(existing.repeatCount>=BM_LOCK_THRESHOLD){
            existing.locked=true;
          }
        }
      });

      renderBM();
      state.continuity=clamp(state.continuity+0.04,0,1);
      els.statC.textContent=state.continuity.toFixed(3);
      els.liveStatusText.textContent="BM summary refreshed from TM resonance.";
    }

    function copyBMToClipboard(){
      if(!state.bmEntries.length){
        alert("No BM entries to copy yet.");
        return;
      }
      let text="BM summary (AURA-X Œ© prototype):\n\n";
      state.bmEntries.forEach(e=>{
        text+=`‚Ä¢ Category: ${e.category}\n`;
        text+=`  Polarity: ${e.polarity.toFixed(2)}, Intensity: ${e.intensity.toFixed(2)}, Repeats: ${e.repeatCount}\n`;
        text+=`  Locked: ${e.locked ? "yes" : "no"}, Decay: ${e.decayCount}\n\n`;
      });
      navigator.clipboard.writeText(text).then(()=>{
        alert("BM summary copied to clipboard.");
      });
    }

    function clearUnlockedBM(){
      const before=state.bmEntries.length;
      state.bmEntries=state.bmEntries.filter(e=>e.locked);
      const removed=before-state.bmEntries.length;
      renderBM();
      alert(`Deleted ${removed} unlocked BM entries; locked patterns preserved.`);
    }

    function setEthicText(text){
      els.ethicText.textContent=text;
      if(text.trim()===""){
        els.ethicCard.style.display="none";
      }else{
        els.ethicCard.style.display="block";
      }
    }

    function showFaithBubbleOnce(){
      if(!els.faithBubble)return;
      els.faithBubble.classList.add("visible");
    }

    function startFaithFlight(){
      if(!els.faithBubble)return;
      els.faithBubble.classList.add("flying");
      setTimeout(()=>{
        els.faithBubble.classList.remove("visible","flying");
        els.reactionBar.scrollIntoView({behavior:"smooth",block:"center"});
      },3200);
    }

    function closeFaithBubble(event){
      if(event){
        event.stopPropagation();
      }
      els.faithBubble.classList.remove("visible","flying");
    }

    function toggleReaction(btn,isPositive){
      if(isPositive){
        state.positiveCount++;
        els.thumbUpBtn.classList.add("active","thumbUp");
        els.thumbDownBtn.classList.remove("active","thumbDown");
      }else{
        state.negativeCount++;
        els.thumbDownBtn.classList.add("active","thumbDown");
        els.thumbUpBtn.classList.remove("active","thumbUp");
      }
      updateReactor();
      const msg=isPositive
        ? "Positive reaction received. I‚Äôll reinforce patterns that protect hope and reduce harm."
        : "Negative reaction received. I‚Äôll treat this as a signal to adjust the emotional trajectory and reasoning.";
      addMessage("aura",msg,{
        emotionLabel:isPositive?"positive feedback":"negative feedback",
        category:"meta / feedback"
      });
    }

    function toggleVoice(){
      state.voiceActive=!state.voiceActive;
      if(state.voiceActive){
        els.voiceBtn.classList.add("voiceActive");
        addMessage("aura","Voice reaction is conceptually ON (placeholder). In a full system, I would speak responses and adapt tone.",{
          category:"system / voice"
        });
      }else{
        els.voiceBtn.classList.remove("voiceActive");
        addMessage("aura","Voice reaction OFF. We are back to text-only mode.",{
          category:"system / voice"
        });
      }
    }

    function linkTMToBM(){
      if(!state.tmEntries.length){
        alert("No TM entries available to link.");
        return;
      }
      autoGenerateBM();
      addMessage("aura","Latest TM inputs have been linked into BM summary. This strengthens continuity for your current topics.",{
        category:"system / continuity"
      });
    }

    function peekBM(){
      if(!state.bmEntries.length){
        addMessage("aura","BM is currently empty or very light. I only lock patterns when they repeat with emotional weight.",{
          category:"system / bm"
        });
        return;
      }
      let text="Here is a quick BM resonance preview:\n";
      state.bmEntries.slice(0,5).forEach(e=>{
        text+=`‚Ä¢ ${e.category} (polarity ${e.polarity.toFixed(2)}, intensity ${e.intensity.toFixed(2)}, repeats ${e.repeatCount}, locked: ${e.locked?"yes":"no"})\n`;
      });
      addMessage("aura",text,{category:"system / bm"});
    }

    function handleVisionInputChange(){
      const files=els.visionInput.files;
      if(!files||!files.length)return;
      const file=files[0];
      state.lastImageName=file.name;
      addMessage("user",`[Image selected: ${file.name}]`,{
        category:"vision / placeholder"
      });
      addMessage("aura","I registered your image selection (prototype placeholder). In a future offline vision model, I would extract emotional and contextual signals from this image and fold them into TM/BM.",{
        category:"vision / placeholder"
      });
    }

    function init(){
      els.thumbUpBtn.addEventListener("click",()=>toggleReaction(els.thumbUpBtn,true));
      els.thumbDownBtn.addEventListener("click",()=>toggleReaction(els.thumbDownBtn,false));
      els.voiceBtn.addEventListener("click",toggleVoice);
      els.linkBtn.addEventListener("click",linkTMToBM);
      els.bmPeekBtn.addEventListener("click",peekBM);
      els.visionInput.addEventListener("change",handleVisionInputChange);

      if(state.decayTimer){
        clearTimeout(state.decayTimer);
      }
      state.decayTimer=setTimeout(decayLoop,DECAY_INTERVAL_MS);

      setEthicText(
        "avoid actions that grow negative emotions in you or others. Move gently toward choices that increase shared positive feeling for everyone."
      );

      els.faithBubbleLens.textContent=els.faithLensLabel.textContent;
      els.faithBubbleMeta.textContent=
        "You'll get updates according to your selected faith above. üê¶";
    }

    init();
  </script>
</body>
</html>