<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Offline LLM package (WebLLM, for in-browser models ‚Äì future ready) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root {
      --accent-color: #0ea5e9; /* default accent */
    }
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px 10px;
    }
    .app{
      width:min(980px,98vw);
      background:rgba(2,6,23,.45);
      border:1px solid rgba(148,163,184,.18);
      border-radius:22px;
      overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
    }
    .top{
      padding:20px 18px 10px;
      border-bottom:1px solid rgba(148,163,184,.14);
      text-align:center;
    }
    .brand{
      font-weight:800;
      letter-spacing:.5px;
      font-size:26px;
      color:#7dd3fc;
      text-shadow:0 0 22px rgba(14,165,233,.28);
    }
    .sub{
      opacity:.8;
      margin-top:2px;
      font-size:13px;
    }
    .ethic{
      margin:14px auto 12px;
      max-width:720px;
      border:1px solid rgba(251,191,36,.35);
      border-radius:14px;
      padding:12px 14px;
      color:#fbbf24;
      background:rgba(2,6,23,.35);
      box-shadow:inset 0 0 0 1px rgba(251,191,36,.08);
      font-size:14px;
      line-height:1.45;
    }
    .pill{
      margin:10px auto 0;
      max-width:760px;
      background:linear-gradient(90deg, rgba(14,165,233,.65), rgba(34,211,238,.45));
      border:1px solid rgba(125,211,252,.30);
      color:#0b1220;
      font-weight:800;
      letter-spacing:.6px;
      border-radius:999px;
      padding:14px 16px;
      text-transform:uppercase;
      box-shadow:0 12px 40px rgba(14,165,233,.22);
    }
    .main{ padding:16px 16px 18px }
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:stretch}
    .leftCol{ flex:1 1 340px; min-width:300px }
    .rightCol{ flex:1 1 360px; min-width:320px }
    .card{
      background:rgba(2,6,23,.50);
      border:1px solid rgba(148,163,184,.16);
      border-radius:18px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      backdrop-filter:blur(10px);
    }
    .optionsBtn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(15,23,42,.55);
      color:#e5e7eb;
      cursor:pointer;
      user-select:none;
      margin:12px 0;
      -webkit-tap-highlight-color:transparent;
    }
    .optionsBtn:active{transform:scale(.99)}
    .gear{width:18px;height:18px;filter:drop-shadow(0 0 10px rgba(125,211,252,.25))}
    .console{
      margin-top:12px;
      height:230px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(0,0,0,.25);
      padding:14px;
      overflow:auto;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:14px;
      box-shadow:inset 0 0 0 1px rgba(125,211,252,.06);
      line-height:1.55;
      white-space:pre-wrap;
    }
    .line{display:block;margin:2px 0}
    .line.user{color:#a5b4fc;}
    .line.aura{color:#bbf7d0;}
    .line.sys{color:#fbbf24;font-size:12px;}
    .optionsMenu{
      position:fixed;
      left:12px;
      right:12px;
      top:120px;
      margin:0 auto;
      max-width:940px;
      background:rgba(2,6,23,.92);
      border:1px solid rgba(148,163,184,.18);
      border-radius:16px;
      padding:8px;
      display:none;
      z-index:9999;
      box-shadow:0 18px 45px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
      align-items:stretch;
    }
    .optionsMenu.show{display:grid}
    .menuItem{
      padding:8px 6px;
      border-radius:13px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:6px;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.10);
      background:rgba(15,23,42,.55);
      user-select:none;
      min-height:58px;
    }
    .menuItem:active{transform:scale(.995)}
    .menuLeft{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-weight:800;
      font-size:12.5px;
    }
    .menuIcon{
      width:18px;
      height:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .menuRight{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:44px;
    }
    .pillOn,.pillOff,.pillMid{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      font-weight:900;
      text-transform:lowercase;
      border:1px solid transparent;
    }
    .pillOn{
      background:rgba(34,197,94,.18);
      border-color:rgba(34,197,94,.24);
      color:#bbf7d0;
    }
    .pillOff{
      background:rgba(239,68,68,.12);
      border-color:rgba(239,68,68,.22);
      color:#fecaca;
    }
    .pillMid{
      background:rgba(14,165,233,.14);
      border-color:rgba(14,165,233,.20);
      color:#bae6fd;
      opacity:.95;
    }
    .chatWrap{
      margin-top:0;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.45);
    }
    /* reaction buttons above metrics, left-aligned */
    .reactionBar{
      margin-top:0;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      font-size:18px;
      opacity:.9;
    }
    .reactBtn{
      border:none;
      background:transparent;
      cursor:pointer;
      padding:4px;
      line-height:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      -webkit-tap-highlight-color:transparent;
    }
    .reactBtn:active{transform:scale(.9)}
    .liveCapsule{
      margin:4px 0 10px;
      width:100%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      padding:10px 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:12px;
      color:#dbeafe;
      box-shadow:inset 0 0 0 1px rgba(125,211,252,.06);
    }
    .liveCapsule b{ color:#7dd3fc; font-weight:900 }
    .faithBubble{
      margin:4px 0 10px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(251,191,36,.16);
      border:1px solid rgba(251,191,36,.4);
      display:none;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:#facc15;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      transition:opacity .25s ease, transform .25s ease;
    }
    .faithBubble.show{
      display:flex;
      opacity:1;
      transform:translateY(0);
    }
    .fbIcon{font-size:18px;}
    .fbText{flex:1;line-height:1.3;}
    .fbTitle{font-weight:800;}
    .fbMeta{opacity:.85;}
    .fbClose{
      border:none;
      background:transparent;
      color:#fed7aa;
      font-size:16px;
      cursor:pointer;
      padding:0 4px;
      line-height:1;
    }
    /* Golden theme */
    body.theme-golden .ethic{
      border-color: rgba(251,191,36,.7);
      background: rgba(251,191,36,.06);
    }
    .faithBubble.pulse{
      animation: faithPulse 1.4s infinite;
    }
    @keyframes faithPulse{
      0%   { box-shadow: 0 0 0 0 rgba(251,191,36,.55); }
      100% { box-shadow: 0 0 0 18px rgba(251,191,36,0); }
    }
    .inputRow{display:flex;gap:10px;align-items:flex-end}
    .input{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      padding:12px 14px;
      outline:none;
      font-size:14px;
    }
    .send{
      border:none;
      border-radius:999px;
      background:linear-gradient(90deg, var(--accent-color, #0ea5e9), rgba(34,211,238,.55));
      color:#0b1220;
      font-weight:900;
      padding:12px 18px;
      cursor:pointer;
      min-width:88px;
      box-shadow:0 12px 30px rgba(14,165,233,.18);
      -webkit-tap-highlight-color:transparent;
    }
    .send:active{transform:scale(.99)}
    .formula{
      margin-top:10px;
      opacity:.8;
      font-size:12px;
      text-align:center;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      color:#dbeafe;
    }
    /* Toast bubble */
    .toastBubble{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translate(-50%,10px);
      padding:6px 14px;
      border-radius:999px;
      background:rgba(15,23,42,.95);
      color:#e5e7eb;
      font-size:12px;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:0 12px 30px rgba(0,0,0,.5);
      opacity:0;
      pointer-events:none;
      z-index:10000;
      transition:opacity .18s ease, transform .18s ease;
    }
    .toastBubble.show{
      opacity:1;
      transform:translate(-50%,0);
    }
    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:18px 12px;
      z-index:9999;
    }
    .modalOverlay.show{display:flex}
    .modal{
      width:min(860px,96vw);
      border-radius:18px;
      overflow:hidden;
      background:rgba(250,250,250,.93);
      color:#0b1220;
      border:1px solid rgba(15,23,42,.18);
      box-shadow:0 30px 80px rgba(0,0,0,.35);
      backdrop-filter:blur(12px);
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      background:rgba(255,255,255,.75);
      border-bottom:1px solid rgba(15,23,42,.10);
      font-weight:800;
    }
    .modalHeader small{font-weight:600;opacity:.7}
    .closeX{
      border:none;
      background:transparent;
      font-size:22px;
      cursor:pointer;
      line-height:1;
      padding:0 4px;
      opacity:.75;
    }
    .modalBody{
      padding:14px;
      max-height:70vh;
      overflow:auto;
    }
    .chipsWrap{margin-top:10px;display:flex;flex-wrap:wrap;gap:10px}
    .chip{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.16);
      background:rgba(255,255,255,.9);
      font-weight:800;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }
    .chip.active{
      background:#0f172a;
      color:#fff;
      border-color:rgba(15,23,42,.2);
      box-shadow:0 12px 30px rgba(2,6,23,.12);
    }
    .btn{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:12px;
      font-weight:900;
      -webkit-tap-highlight-color:transparent;
      font-size:12px;
    }
    .btnBlue{background:rgba(59,130,246,.16);border:1px solid rgba(59,130,246,.22)}
    .btnDark{background:rgba(2,6,23,.92);color:#fff}
    .btnRed{background:rgba(239,68,68,.14);border:1px solid rgba(239,68,68,.22);color:#7f1d1d}
    .btnGreen{background:rgba(34,197,94,.18);border:1px solid rgba(34,197,94,.25);color:#064e2a}
    .bmCard{
      border-radius:16px;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.85);
      padding:12px;
      margin-top:12px;
    }
    .bmTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .bmTop .title{
      font-weight:900;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .bmSub{font-size:12px;opacity:.7;margin-top:2px}
    .bmText{
      width:100%;
      min-height:240px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.18);
      padding:12px;
      outline:none;
      resize:vertical;
      background:#fff;
      font-size:14px;
      line-height:1.45;
    }
    .bmActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      justify-content:flex-start;
    }
    .intelEditInput, .intelEditArea{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.18);
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .intelEditArea{
      min-height:90px;
      resize:vertical;
      line-height:1.4;
      margin-top:6px;
    }
    /* Intelligence cards */
    .intelCard{
      border-radius:12px;
      border:1px solid rgba(15,23,42,.12);
      background:#f9fafb;
      padding:10px;
      margin-top:8px;
      font-size:13px;
    }
    .intelTop{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-bottom:4px;
    }
    .intelQ{font-weight:700;}
    .intelA{margin-top:2px;white-space:pre-wrap;}
    .intelMeta{font-size:11px;opacity:.65;margin-top:2px;}
    .intelButtons{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;margin-top:6px;}
    .intelEditBlock{
      margin-top:8px;
      border-radius:10px;
      border:1px dashed rgba(15,23,42,.18);
      padding:8px;
      background:#fff;
    }
    /* Conversation history */
    #modalHistory .modalBody{
      background:#f8fafc;
    }
    #historyBox{
      margin-top:4px;
      border-radius:14px;
      padding:4px 0;
      max-height:60vh;
      overflow:auto;
    }
    .historyLine{
      padding:8px 10px;
      font-size:12px;
      margin-bottom:6px;
      border-radius:12px;
      background:#f9fafb;
      border:1px solid rgba(148,163,184,.45);
      color:#0b1120;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:6px;
    }
    .historyText{
      flex:1;
      white-space:pre-wrap;
    }
    .historyLock{
      border:none;
      background:transparent;
      cursor:pointer;
      font-size:15px;
      line-height:1;
      padding:0 2px;
    }
    /* BM list items */
    .bmItem{
      margin-top:6px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.5);
      background:#f9fafb;
      cursor:pointer;
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:6px;
    }
    .bmItemTitle{font-weight:700;}
    .bmItemMeta{opacity:.65;font-size:11px;}

    /* Dream Mode Overlay */
    #dreamOverlay {
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background:
        radial-gradient(circle at 20% 0%, rgba(15,23,42,0.95) 0, transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(30,64,175,0.90) 0, transparent 55%),
        radial-gradient(circle at 50% 100%, rgba(147,51,234,0.85) 0, transparent 60%);
      backdrop-filter: blur(10px);
      z-index: 9999;
      color: #e5e7eb;
      text-align: center;
    }
    #dreamOverlay .dream-inner {
      max-width: 600px;
      padding: 24px 20px;
      border-radius: 24px;
      border: 1px solid rgba(148,163,184,0.6);
      box-shadow: 0 25px 80px rgba(15,23,42,0.9);
    }
    #dreamOverlay .dream-title {
      font-weight: 800;
      font-size: 1.05rem;
      margin-bottom: 8px;
    }
    #dreamOverlay .dream-snippet {
      font-size: 0.98rem;
      line-height: 1.6;
      margin-bottom: 14px;
      min-height: 4em;
      white-space: pre-wrap;
    }
    #dreamOverlay .dream-hint {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .@media-fix{} /* dummy */
    @media (max-width:760px){
      .console{height:240px}
      .optionsMenu{top:112px}
    }
    @media (max-width:420px){
      .brand{font-size:22px}
      .pill{font-size:14px}
      .ethic{font-size:13px}
      .console{height:260px}
      .optionsMenu{
        gap:6px;
        padding:7px;
        grid-template-columns:repeat(3,minmax(0,1fr));
      }
      .menuItem{
        min-height:52px;
        padding:6px 4px;
      }
      .menuLeft{font-size:11px}
      .pillOn,.pillOff,.pillMid{
        font-size:9.5px;
        padding:4px 6px;
      }
      .reactionBar{
        font-size:16px;
        gap:8px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="brand">AURA-X Œ©</div>
      <div class="sub">
        Offline emotional continuity engine (prototype)<br>
        TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory.
      </div>
      <div class="ethic">
        Universal ethic: avoid actions that grow negative emotions in you or others.
        Move gently toward choices that increase shared positive feeling for everyone.
      </div>
      <div class="pill">EMOTIONAL CONTINUITY ENGINE ‚Äî ACTIVE</div>
    </div>
    <div class="main">
      <div class="row">
        <!-- LEFT -->
        <div class="leftCol">
          <div class="card">
            <div class="optionsBtn" id="btnOptions">
              <svg class="gear" viewBox="0 0 24 24" fill="none">
                <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"
                      stroke="#7dd3fc" stroke-width="2"/>
                <path d="M19.4 15a8.2 8.2 0 0 0 .1-2l2-1.5-2-3.5-2.4 1a8.5 8.5 0 0 0-1.7-1l-.4-2.6h-4l-.4 2.6a8.5 8.5 0 0 0-1.7 1l-2.4-1-2 3.5 2 1.5a8.2 8.2 0 0 0 .1 2L2.7 16.5l2 3.5 2.4-1a8.5 8.5 0 0 0 1.7 1l.4 2.6h4l.4-2.6a8.5 8.5 0 0 0 1.7-1l2.4 1 2-3.5L19.4 15Z"
                      stroke="#7dd3fc" stroke-width="1.6" opacity=".9"/>
              </svg>
              <span>Options</span>
            </div>
            <div class="optionsMenu" id="optionsMenu">
              <div class="menuItem" id="miVoice">
                <div class="menuLeft"><span class="menuIcon">üé§</span><span>Voice</span></div>
                <div class="menuRight"><span class="pillOff" id="voicePill">off</span></div>
              </div>
              <div class="menuItem" id="miIntel">
                <div class="menuLeft"><span class="menuIcon">üß†</span><span>Intelligence</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miLearn">
                <div class="menuLeft"><span class="menuIcon">üìö</span><span>Learning</span></div>
                <div class="menuRight"><span class="pillOn" id="learnPill">on</span></div>
              </div>
              <div class="menuItem" id="miSeed">
                <div class="menuLeft"><span class="menuIcon">üå±</span><span>Feed</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miFaith">
                <div class="menuLeft"><span class="menuIcon">üïä</span><span>Faith</span></div>
                <div class="menuRight"><span class="pillOff" id="faithLabel">none</span></div>
              </div>
              <div class="menuItem" id="miIdentity">
                <div class="menuLeft"><span class="menuIcon">ü™™</span><span>Identity</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miLLM">
                <div class="menuLeft"><span class="menuIcon">ü§ñ</span><span>LLM</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miBMRecall">
                <div class="menuLeft"><span class="menuIcon">üìò</span><span>BM Recall</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
              <div class="menuItem" id="miHistory">
                <div class="menuLeft"><span class="menuIcon">üìú</span><span>History</span></div>
                <div class="menuRight"><span class="pillMid">open</span></div>
              </div>
            </div>
            <div class="console" id="console"></div>
          </div>
        </div>
        <!-- RIGHT -->
        <div class="rightCol">
          <div class="chatWrap">
            <div class="reactionBar" id="reactionBar">
              <!-- left copy button already removed -->
              <button class="reactBtn" id="btnLikeLast" title="Save to Intelligence (like)">üëç</button>
              <button class="reactBtn" id="btnDislikeLast" title="Mark incorrect & teach new answer">üëé</button>
              <button class="reactBtn" id="btnSpeakLast" title="Play voice for last answer">üîä</button>
              <button class="reactBtn" id="btnShareLast" title="Copy question + answer">üîó</button>
            </div>
            <div class="liveCapsule">
              <span><b>E0</b>: <span id="cE0">0.000</span></span><span>¬∑</span>
              <span><b>TM</b>: <span id="cTM">0.00</span></span><span>¬∑</span>
              <span><b>BM</b>: <span id="cBM">0.00</span></span><span>¬∑</span>
              <span><b>C</b>: <span id="cCont">0.850</span></span>
            </div>
            <div class="faithBubble" id="faithBubble">
              <div class="fbIcon">üí≠</div>
              <div class="fbText">
                <div class="fbTitle" id="faithBubbleTitle">Faith reflection bubble</div>
                <div class="fbMeta" id="faithBubbleMeta">Tap to see a short suggestion.</div>
              </div>
              <button class="fbClose" id="faithBubbleClose">√ó</button>
            </div>
            <div class="inputRow">
              <input class="input" id="userInput" placeholder="Talk to AURA-X Œ©‚Ä¶ (TM = your inputs)" />
              <button class="send" id="sendBtn">Send</button>
            </div>
            <div class="formula">
              E‚ÇÄ = tanh( R(TM,BM) + I(TM) + I<sub>intel</sub> + I<sub>LLM</sub> ‚àí D + Œª<sub>faith</sub> + Œª<sub>sys</sub> + Œª<sub>trc</sub> )
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast bubble -->
  <div class="toastBubble" id="toastBubble"></div>

  <!-- Dream mode overlay -->
  <div id="dreamOverlay">
    <div class="dream-inner">
      <div class="dream-title">AURA-X Œ© ‚Äì Dream Mode</div>
      <div class="dream-snippet" id="dreamSnippet">
        (sleeping‚Ä¶ processing memories‚Ä¶)
      </div>
      <div class="dream-hint">Tap / Click to wake up</div>
    </div>
  </div>

  <!-- Faith selection -->
  <div class="modalOverlay" id="modalFaith">
    <div class="modal">
      <div class="modalHeader">
        <div>‚öôÔ∏è AURA-X Œ© options<br><small>Optional faith lens for encouragement lines.</small></div>
        <button class="closeX" data-close="modalFaith">√ó</button>
      </div>
      <div class="modalBody" style="background:#fdf7e5;">
        <div style="opacity:.8;font-size:13px;line-height:1.35;margin-bottom:8px">
          Universal ethics are always active. You can optionally pick one or more faith lenses.
          Nothing is sent to any server.
        </div>
        <div class="chipsWrap" id="faithChips"></div>
      </div>
    </div>
  </div>
  <!-- Faith article -->
  <div class="modalOverlay" id="modalFaithArticle">
    <div class="modal">
      <div class="modalHeader">
        <div>üí≠ Faith reflection<br><small>Story-related suggestion from your selected literature.</small></div>
        <button class="closeX" data-close="modalFaithArticle">√ó</button>
      </div>
      <div class="modalBody" style="background:#fefce8;">
        <div id="faithArticleMeta" style="font-size:12px;opacity:.75;margin-bottom:6px;"></div>
        <div id="faithArticleTitle" style="font-weight:800;margin-bottom:6px;"></div>
        <textarea id="faithArticleText"
          style="width:100%;min-height:160px;border-radius:14px;border:1px solid rgba(15,23,42,.18);padding:10px;font-size:13px;line-height:1.4;background:#fff;"></textarea>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn btnBlue" id="btnCopyFaithArticle">Copy</button>
          <button class="btn btnBlue" id="btnAddFaithToBM">Add under BM prompt</button>
          <button class="btn btnRed" id="btnSkipFaithBM">Skip</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Intelligence -->
  <div class="modalOverlay" id="modalIntel">
    <div class="modal">
      <div class="modalHeader">
        <div>üß† Intelligence<br><small>Stored Q ‚Üí A pairs.</small></div>
        <button class="closeX" data-close="modalIntel">√ó</button>
      </div>
      <div class="modalBody">
        <input id="intelSearch"
          style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);padding:10px 12px;font-size:14px;outline:none"
          placeholder="Search intelligence..." />
        <div id="intelList" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>
  <!-- Seed + Logic -->
  <div class="modalOverlay" id="modalSeed">
    <div class="modal">
      <div class="modalHeader">
        <div>üå± Feed the seed<br><small>Add LaTeX Q ‚Üí A blocks and optional Logic Pack.</small></div>
        <button class="closeX" data-close="modalSeed">√ó</button>
      </div>
      <div class="modalBody">
        <div style="opacity:.75;font-size:13px;line-height:1.35;margin-bottom:10px">
          Paste a LaTeX block with \item questions and \textbf{A:} answers. You can optionally start each
          answer with [polarity=positive; code=E031; intensity=0.8].
        </div>
        <textarea id="seedBox"
          style="width:100%;min-height:150px;resize:vertical;border-radius:14px;border:2px solid rgba(59,130,246,.25);padding:12px;font-size:14px;outline:none;background:#fff"
          placeholder="Paste LaTeX conversation / logic block here..."></textarea>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-top:10px">
          <div style="font-size:12px;opacity:.7" id="seedHint">Waiting for block‚Ä¶</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btnBlue" id="btnParseSeed">Parse block</button>
            <button class="btn btnBlue" id="btnSaveSeed">Save to seed</button>
            <button class="btn btnRed" id="btnDiscardSeed">Discard</button>
          </div>
        </div>
        <hr style="margin:14px 0;border:none;border-top:1px dashed rgba(15,23,42,.18);" />
        <div style="font-weight:800;font-size:13px;margin-bottom:6px;">üß© Logic Pack (JSON rules ‚Äì advanced)</div>
        <div style="font-size:12px;opacity:.75;line-height:1.4;margin-bottom:6px;">
          Each time you press <b>Save</b>, a new logic pack is stored with its own number.
          Saved logic packs never auto-delete; they can only be removed manually with double confirmation.
        </div>
        <textarea id="logicBox"
          style="width:100%;min-height:130px;resize:vertical;border-radius:14px;border:2px solid rgba(15,23,42,.18);padding:10px;font-size:13px;outline:none;background:#fff;font-family:ui-monospace,Menlo,Consolas,monospace;"
          placeholder='{
  "cooldown": { "hits": 3, "seconds": 10 },
  "abuseWords": ["stfu","idiot"],
  "faithSoftener": true,
  "ui": { "theme": "golden", "accentColor": "#f97316" }
}'>
        </textarea>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-top:8px;">
          <div style="font-size:12px;opacity:.7" id="logicHint">No logic pack loaded.</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn btnBlue" id="btnValidateLogic">Validate</button>
            <button class="btn btnBlue" id="btnSaveLogic">Save</button>
            <button class="btn btnBlue" id="btnCopyLogic">Copy</button>
            <button class="btn btnRed" id="btnDeleteLogic">Delete</button>
          </div>
        </div>
        <div style="margin-top:6px;font-size:11px;opacity:.6;">
          Current serial: <span id="logicSerial">none</span>
        </div>
      </div>
    </div>
  </div>
  <!-- LLM -->
  <div class="modalOverlay" id="modalLLM">
    <div class="modal">
      <div class="modalHeader">
        <div>ü§ñ LLM link<br><small>Offline LLM + optional online helper.</small></div>
        <button class="closeX" data-close="modalLLM">√ó</button>
      </div>
      <div class="modalBody">
        <div style="border-radius:14px;border:1px solid rgba(34,197,94,.25);background:rgba(34,197,94,.12);padding:12px;">
          <div style="font-weight:900;">Offline LLM (WebLLM)</div>
          <div style="font-size:13px;opacity:.8;margin-top:6px;line-height:1.35">
            Loads a small local model in your browser (WebGPU required). On many mobile browsers this may not be supported.
          </div>
          <div style="margin-top:10px;">
            <button class="btn btnGreen" id="btnLoadOffline">Load offline model</button>
          </div>
          <div style="margin-top:8px;font-size:12px;opacity:.75">Status: <span id="offlineStatus">idle</span></div>
          <div style="margin-top:8px;height:10px;border-radius:999px;background:rgba(2,6,23,.12);overflow:hidden;border:1px solid rgba(2,6,23,.08)">
            <div id="offlineBar" style="height:100%;width:0%;background:#22c55e;transition:width .2s ease;"></div>
          </div>
        </div>
        <div style="font-weight:900;margin-top:14px;">Online helper LLM (connects & works)</div>
        <div style="font-size:12px;opacity:.8;margin-top:4px;margin-bottom:4px;">
          Use any compatible API (OpenAI, DeepSeek, xAI, etc.). Nothing is stored on server by AURA-X Œ© itself.
        </div>
        <div style="margin-top:6px;">
          <label style="font-size:12px;opacity:.75;display:block;margin-bottom:4px;">API endpoint</label>
          <input id="apiEndpoint"
            style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);padding:10px 12px;font-size:14px;outline:none;background:rgba(255,255,255,.88)"
            value="https://api.openai.com/v1/chat/completions" />
        </div>
        <div style="margin-top:10px;">
          <label style="font-size:12px;opacity:.75;display:block;margin-bottom:4px;">Model</label>
          <input id="apiModel"
            style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);padding:10px 12px;font-size:14px;outline:none;background:rgba(255,255,255,.88)"
            value="gpt-4o-mini" />
        </div>
        <div style="margin-top:10px;">
          <label style="font-size:12px;opacity:.75;display:block;margin-bottom:4px;">API key (session only)</label>
          <input id="apiKey"
            style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);padding:10px 12px;font-size:14px;outline:none;background:rgba(255,255,255,.88)"
            placeholder="sk-..." />
        </div>
        <div style="margin-top:10px;display:flex;justify-content:flex-end;">
          <button class="btn btnBlue" id="btnSaveLLM">Save</button>
        </div>
      </div>
    </div>
  </div>
  <!-- BM Recall -->
  <div class="modalOverlay" id="modalBM">
    <div class="modal">
      <div class="modalHeader">
        <div>üìò Recall from BM<br><small>Only long stories and scenes (photo/video-ready).</small></div>
        <button class="closeX" data-close="modalBM">√ó</button>
      </div>
      <div class="modalBody">
        <div style="font-size:13px;opacity:.75">
          Select a BM prompt. Locked prompts must be unlocked first. Delete needs double confirmation.
        </div>
        <input id="bmSearch"
          style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);padding:8px 10px;font-size:13px;margin:8px 0 4px;outline:none;background:#fff;"
          placeholder="Search BM by text..." />
        <input id="bmDate" type="date"
          style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);padding:8px 10px;font-size:13px;margin:0 0 6px;outline:none;background:#fff;" />
        <div id="bmSelectList"></div>
        <div class="bmCard" id="bmViewer" style="display:none;">
          <div class="bmTop">
            <div>
              <div class="title"><span id="bmLockIcon">üîì</span> <span id="bmTitle">Prompt</span></div>
              <div class="bmSub" id="bmMeta"></div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
              <button class="btn btnBlue" id="btnLiveBM">Live 12h: off</button>
              <button class="btn btnBlue" id="btnUnlockBM" style="display:none;">Unlock</button>
            </div>
          </div>
          <textarea class="bmText" id="bmTextArea" readonly></textarea>
          <div class="bmActions">
            <button class="btn btnBlue" id="btnCopyPrompt">Copy prompt</button>
            <button class="btn btnBlue" id="btnAutoGen">Generate video</button>
            <button class="btn btnRed" id="btnDeletePrompt">Delete</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- History -->
  <div class="modalOverlay" id="modalHistory">
    <div class="modal">
      <div class="modalHeader">
        <div>üìú Conversation history<br><small>Recent TM log.</small></div>
        <button class="closeX" data-close="modalHistory">√ó</button>
      </div>
      <div class="modalBody">
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
          <button class="btn btnBlue" id="btnDeleteRecent">Delete history last 48h</button>
          <button class="btn btnRed" id="btnDeleteAllHist">Delete all history</button>
          <button class="btn btnBlue" id="btnCopyHistory">Copy</button>
        </div>
        <div id="historyBox"></div>
      </div>
    </div>
  </div>
  <!-- Identity -->
  <div class="modalOverlay" id="modalIdentity">
    <div class="modal">
      <div class="modalHeader">
        <div>ü™™ User identity<br><small>Deep profiling for continuity.</small></div>
        <button class="closeX" data-close="modalIdentity">√ó</button>
      </div>
      <div class="modalBody">
        <div style="opacity:.8;font-size:13px;line-height:1.35">
          Stored only on this device. Saved data auto-locks. Delete requires double confirmation.
        </div>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn btnBlue" id="btnEditIdentity">Edit</button>
          <button class="btn btnBlue" id="btnSaveUserIdentity">Save</button>
          <button class="btn btnRed" id="btnDeleteUserIdentity">Delete</button>
        </div>
        <div style="margin-top:14px;font-weight:800;font-size:13px;">Part 1 ‚Äì Basic</div>
        <div style="margin-top:8px;">
          <label style="font-size:12px;opacity:.75;display:block;margin-bottom:4px;">Full legal name</label>
          <input id="uName"
            style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);padding:10px 12px;font-size:14px;outline:none;background:rgba(255,255,255,.88)"
            placeholder="e.g., Alim ul Haq" />
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          <div style="flex:1;min-width:140px;">
            <label style="font-size:12px;opacity:.75;display:block;margin-bottom:4px;">Preferred name</label>
            <input id="uNick"
              style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);padding:10px 12px;font-size:14px;outline:none;background:rgba(255,255,255,.88)"
              placeholder="Nickname" />
          </div>
          <div style="flex:1;min-width:140px;">
            <label style="font-size:12px;opacity:.75;display:block;margin-bottom:4px;">Place of origin</label>
            <input id="uOrigin"
              style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);padding:10px 12px;font-size:14px;outline:none;background:rgba(255,255,255,.88)"
              placeholder="Village / town" />
          </div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          <div style="flex:1;min-width:140px;">
            <label style="font-size:12px;opacity:.75;display:block;margin-bottom:4px;">Current city / country</label>
            <input id="uPlace"
              style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);padding:10px 12px;font-size:14px;outline:none;background:rgba(255,255,255,.88)"
              placeholder="Timergara, Pakistan" />
          </div>
          <div style="flex:1;min-width:140px;">
            <label style="font-size:12px;opacity:.75;display:block;margin-bottom:4px;">Profession</label>
            <input id="uProfession"
              style="width:100%;border-radius:12px;border:1px solid rgba(15,23,42,.18);padding:10px 12px;font-size:14px;outline:none;background:rgba(255,255,255,.88)"
              placeholder="Entrepreneur, researcher‚Ä¶" />
          </div>
        </div>
        <div style="margin-top:14px;font-weight:800;font-size:13px;">Part 2 ‚Äì Emotional style</div>
        <textarea id="uEmotionalStyle"
          style="width:100%;margin-top:6px;border-radius:14px;border:1px solid rgba(15,23,42,.18);padding:10px;font-size:13px;line-height:1.4;min-height:90px;"
          placeholder="How you react under stress, joy, fear, success‚Ä¶"></textarea>
        <div style="margin-top:14px;font-weight:800;font-size:13px;">Part 3 ‚Äì Relationships & legacy</div>
        <textarea id="uKeyPeople"
          style="width:100%;margin-top:6px;border-radius:14px;border:1px solid rgba(15,23,42,.18);padding:10px;font-size:13px;line-height:1.4;min-height:80px;"
          placeholder="Key people and roles in your life‚Ä¶"></textarea>
        <textarea id="uLegacyRules"
          style="width:100%;margin-top:6px;border-radius:14px;border:1px solid rgba(15,23,42,.18);padding:10px;font-size:13px;line-height:1.4;min-height:80px;"
          placeholder="If one day this system speaks for you, which boundaries and rules must it follow?"></textarea>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const KEY_CFG   = "aurax_cfg_v12";
      const KEY_INT   = "aurax_intel_v11";
      const KEY_BM    = "aurax_bm_v11";
      const KEY_HIST  = "aurax_hist_v11";
      const KEY_USER  = "aurax_user_v11";
      const KEY_LOGIC = "aurax_logic_v12";
      const OFFLINE_MODEL_ID = "Llama-3-8B-Instruct-q4f32_1-MLC";

      const els = {
        console: document.getElementById("console"),
        btnOptions: document.getElementById("btnOptions"),
        optionsMenu: document.getElementById("optionsMenu"),
        miVoice: document.getElementById("miVoice"),
        miIntel: document.getElementById("miIntel"),
        miLearn: document.getElementById("miLearn"),
        miSeed: document.getElementById("miSeed"),
        miFaith: document.getElementById("miFaith"),
        miIdentity: document.getElementById("miIdentity"),
        miLLM: document.getElementById("miLLM"),
        miBMRecall: document.getElementById("miBMRecall"),
        miHistory: document.getElementById("miHistory"),
        voicePill: document.getElementById("voicePill"),
        learnPill: document.getElementById("learnPill"),
        faithLabel: document.getElementById("faithLabel"),
        cE0: document.getElementById("cE0"),
        cTM: document.getElementById("cTM"),
        cBM: document.getElementById("cBM"),
        cCont: document.getElementById("cCont"),
        userInput: document.getElementById("userInput"),
        sendBtn: document.getElementById("sendBtn"),
        faithBubble: document.getElementById("faithBubble"),
        faithBubbleTitle: document.getElementById("faithBubbleTitle"),
        faithBubbleMeta: document.getElementById("faithBubbleMeta"),
        faithBubbleClose: document.getElementById("faithBubbleClose"),
        modalFaith: document.getElementById("modalFaith"),
        faithChips: document.getElementById("faithChips"),
        modalFaithArticle: document.getElementById("modalFaithArticle"),
        faithArticleMeta: document.getElementById("faithArticleMeta"),
        faithArticleTitle: document.getElementById("faithArticleTitle"),
        faithArticleText: document.getElementById("faithArticleText"),
        btnCopyFaithArticle: document.getElementById("btnCopyFaithArticle"),
        btnAddFaithToBM: document.getElementById("btnAddFaithToBM"),
        btnSkipFaithBM: document.getElementById("btnSkipFaithBM"),
        modalIntel: document.getElementById("modalIntel"),
        intelSearch: document.getElementById("intelSearch"),
        intelList: document.getElementById("intelList"),
        modalSeed: document.getElementById("modalSeed"),
        seedBox: document.getElementById("seedBox"),
        seedHint: document.getElementById("seedHint"),
        btnParseSeed: document.getElementById("btnParseSeed"),
        btnSaveSeed: document.getElementById("btnSaveSeed"),
        btnDiscardSeed: document.getElementById("btnDiscardSeed"),
        logicBox: document.getElementById("logicBox"),
        logicHint: document.getElementById("logicHint"),
        logicSerial: document.getElementById("logicSerial"),
        btnValidateLogic: document.getElementById("btnValidateLogic"),
        btnSaveLogic: document.getElementById("btnSaveLogic"),
        btnCopyLogic: document.getElementById("btnCopyLogic"),
        btnDeleteLogic: document.getElementById("btnDeleteLogic"),
        modalLLM: document.getElementById("modalLLM"),
        btnLoadOffline: document.getElementById("btnLoadOffline"),
        offlineStatus: document.getElementById("offlineStatus"),
        offlineBar: document.getElementById("offlineBar"),
        apiEndpoint: document.getElementById("apiEndpoint"),
        apiModel: document.getElementById("apiModel"),
        apiKey: document.getElementById("apiKey"),
        btnSaveLLM: document.getElementById("btnSaveLLM"),
        modalBM: document.getElementById("modalBM"),
        bmSearch: document.getElementById("bmSearch"),
        bmDate: document.getElementById("bmDate"),
        bmSelectList: document.getElementById("bmSelectList"),
        bmViewer: document.getElementById("bmViewer"),
        bmLockIcon: document.getElementById("bmLockIcon"),
        bmTitle: document.getElementById("bmTitle"),
        bmMeta: document.getElementById("bmMeta"),
        bmTextArea: document.getElementById("bmTextArea"),
        btnLiveBM: document.getElementById("btnLiveBM"),
        btnUnlockBM: document.getElementById("btnUnlockBM"),
        btnCopyPrompt: document.getElementById("btnCopyPrompt"),
        btnAutoGen: document.getElementById("btnAutoGen"),
        btnDeletePrompt: document.getElementById("btnDeletePrompt"),
        modalHistory: document.getElementById("modalHistory"),
        btnDeleteRecent: document.getElementById("btnDeleteRecent"),
        btnDeleteAllHist: document.getElementById("btnDeleteAllHist"),
        btnCopyHistory: document.getElementById("btnCopyHistory"),
        historyBox: document.getElementById("historyBox"),
        modalIdentity: document.getElementById("modalIdentity"),
        btnEditIdentity: document.getElementById("btnEditIdentity"),
        btnSaveUserIdentity: document.getElementById("btnSaveUserIdentity"),
        btnDeleteUserIdentity: document.getElementById("btnDeleteUserIdentity"),
        uName: document.getElementById("uName"),
        uNick: document.getElementById("uNick"),
        uOrigin: document.getElementById("uOrigin"),
        uPlace: document.getElementById("uPlace"),
        uProfession: document.getElementById("uProfession"),
        uEmotionalStyle: document.getElementById("uEmotionalStyle"),
        uKeyPeople: document.getElementById("uKeyPeople"),
        uLegacyRules: document.getElementById("uLegacyRules"),
        btnLikeLast: document.getElementById("btnLikeLast"),
        btnDislikeLast: document.getElementById("btnDislikeLast"),
        btnSpeakLast: document.getElementById("btnSpeakLast"),
        btnShareLast: document.getElementById("btnShareLast"),
        toastBubble: document.getElementById("toastBubble"),
        dreamOverlay: document.getElementById("dreamOverlay"),
        dreamSnippet: document.getElementById("dreamSnippet")
      };

      const FAITH_OPTIONS = [
        { id: "none",         label: "None" },
        { id: "islam",        label: "Islam" },
        { id: "christianity", label: "Christianity" },
        { id: "hinduism",     label: "Hinduism" },
        { id: "buddhism",     label: "Buddhism" },
        { id: "sikhism",      label: "Sikhism" },
        { id: "judaism",      label: "Judaism" },
        { id: "atheism",      label: "Atheism / Humanism" },
        { id: "mixed",        label: "Other / Mixed" },
        { id: "indigenous",   label: "Indigenous / Traditional" },
        { id: "eastern",      label: "Eastern / Chinese" }
      ];

      const FAITH_LIBRARY = {
        islam: [{
          id: "islam_generic",
          title: "Meaning of hardship and patience",
          short: "Trust, sabr and good opinion of Allah during hard stories.",
          content:
            "In Islamic reflection, hardship is often seen as a temporary test that polishes the heart. " +
            "Believers are invited toward sabr (patience), shukr (gratitude where possible), and husn-uz-zann " +
            "(a good opinion of Allah). You can ask: what quality is being trained in me here, and which door " +
            "of mercy may open later from this chapter of my life?"
        }]
      };

      let state = {
        voiceOn: false,
        learningOn: true,
        faithSelection: [],
        intelligence: [],
        seedPairs: [],
        bmPrompts: [],
        history: [],
        userIdentity: null,
        apiConfig: { endpoint: "", model: "", key: "" },
        offlineEngine: null,
        offlineLoading: false,
        offlineReady: false,
        lastAnswerSource: null,
        lastUserQ: null,
        lastAuraA: null,
        correcting: false,
        metrics: { TM: 0, BM: 0, C: 0.85, E0: 0 },
        parsedSeed: [],
        editingIntelId: null,
        lastStoryInput: null,
        lastStoryBMId: null,
        faithBubbleTimer: null,
        currentFaithArticle: null,
        logicPacks: [],
        logicActiveIndex: null,
        abuseCount: 0,
        cooldownUntil: 0,
        mode: "adult",
        logicFaithSoftener: true,
        toastTimer: null,
        selectedBMId: null,
        dreamMode: false,
        lastActivity: Date.now(),
        inactivityTimer: null,
        decayTimer: null
      };

      const DREAM_IDLE_MS = 4 * 60 * 1000;
      const DREAM_TICK_MS = 5 * 60 * 1000;
      let dreamInterval = null;

      function safeLoadJSON(key, fallback){
        try{
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : fallback;
        }catch{ return fallback; }
      }

      function logLine(roleOrText, maybeText){
        let role = "";
        let text;
        if (typeof maybeText === "undefined"){
          text = roleOrText;
        } else {
          role = roleOrText || "";
          text = maybeText;
        }
        const div = document.createElement("div");
        div.className = "line" + (role ? " " + role : "");
        div.textContent = text;
        els.console.appendChild(div);
        els.console.scrollTop = els.console.scrollHeight;
        if(role === "user" || role === "aura"){
          addHistory(role, text);
        }
      }

      function scoreTM(t){
        const len = Math.min((t||"").length,600);
        return Number(Math.tanh(len/200).toFixed(2));
      }

      function recomputeBMMetric(){
        const count = state.bmPrompts.length || 0;
        state.metrics.BM = Number(Math.tanh(count/10).toFixed(2));
      }

      function recomputeE0(intelBoost, llmBoost){
        const TM = state.metrics.TM;
        const BM = state.metrics.BM;
        const R = TM * BM;
        const I_tm = 0.3 * TM;
        const D = 0.1;
        const lambdaFaith = state.faithSelection.length ? 0.15 : 0;
        const lambdaSys   = 0.05;
        const lambdaTrc   = 0.05;
        const raw = R + I_tm + intelBoost + llmBoost - D + lambdaFaith + lambdaSys + lambdaTrc;
        state.metrics.E0 = Number(Math.tanh(raw).toFixed(3));
      }

      function updateCapsule(){
        els.cTM.textContent = state.metrics.TM.toFixed(2);
        els.cBM.textContent = state.metrics.BM.toFixed(2);
        els.cCont.textContent = state.metrics.C.toFixed(3);
        els.cE0.textContent = state.metrics.E0.toFixed(3);
      }

      function showToast(msg){
        if(!els.toastBubble) return;
        els.toastBubble.textContent = msg;
        els.toastBubble.classList.add("show");
        if(state.toastTimer) clearTimeout(state.toastTimer);
        state.toastTimer = setTimeout(()=>{
          els.toastBubble.classList.remove("show");
        },1600);
      }

      function saveCfg(){
        const cfg = {
          voiceOn: state.voiceOn,
          learningOn: state.learningOn,
          faithSelection: state.faithSelection,
          apiConfig: state.apiConfig,
          offlineReady: state.offlineReady
        };
        localStorage.setItem(KEY_CFG, JSON.stringify(cfg));
      }
      function saveIntelligence(){ localStorage.setItem(KEY_INT, JSON.stringify(state.intelligence)); }
      function saveBM(){ localStorage.setItem(KEY_BM, JSON.stringify(state.bmPrompts)); }
      function saveHistory(){ localStorage.setItem(KEY_HIST, JSON.stringify(state.history)); }
      function saveUserIdentity(){ localStorage.setItem(KEY_USER, JSON.stringify(state.userIdentity)); }
      function persistLogicState(){
        const data = { list: state.logicPacks || [], activeIndex: state.logicActiveIndex };
        localStorage.setItem(KEY_LOGIC, JSON.stringify(data));
      }

      // ---------- Story / weather / dream helpers ----------
      function looksLikeStory(text) {
        if (!text) return false;
        const t = text.trim();
        if (t.length < 220) return false;
        const sentenceMarks = (t.match(/[.!?]/g) || []).length;
        if (sentenceMarks < 2) return false;
        const lower = t.toLowerCase();
        const hints = [
          " today ", " yesterday ", " years ", " months ",
          " when ", " because ", " i ", " we ", " story "
        ];
        return hints.some(h => lower.includes(h));
      }

      function getWeatherSnapshot() {
        const now = new Date();
        const h = now.getHours();
        let phase = "night sky";
        if (h >= 5 && h < 12) phase = "morning light";
        else if (h >= 12 && h < 17) phase = "afternoon heat";
        else if (h >= 17 && h < 21) phase = "evening breeze";
        const tempGuess = 22 + Math.round(6 * Math.sin((h / 24) * Math.PI * 2));
        return (
          now.toDateString() +
          " ¬∑ around " + String(h).padStart(2, "0") + ":00" +
          " ¬∑ approx " + tempGuess + "¬∞C ¬∑ " + phase +
          " (offline snapshot)"
        );
      }

      function pruneBM(maxCount = 60) {
        const now = Date.now();
        const locked = [];
        const free = [];
        for (const bm of state.bmPrompts) {
          if (bm.locked || (bm.liveUntil && bm.liveUntil > now)) {
            locked.push(bm);
          } else {
            free.push(bm);
          }
        }
        free.sort((a, b) => (b.ts || 0) - (a.ts || 0));
        const allowedFree = Math.max(0, maxCount - locked.length);
        const kept = locked.concat(free.slice(0, allowedFree));
        const removed = state.bmPrompts.length - kept.length;
        if (removed > 0) {
          state.bmPrompts = kept;
          saveBM();
          recomputeBMMetric();
          recomputeE0(0, 0);
          updateCapsule();
        }
        return removed;
      }

      function performSystemDecay() {
        const removed = pruneBM(60);
        if (removed > 0) {
          logLine("sys", `[Dream mode] Tidied ${removed} older BM stories in the background.`);
        } else {
          logLine("sys", "[Dream mode] Nothing to prune ‚Äì continuity already light.");
        }
      }

      function showNextDreamSnippet() {
        const box = els.dreamSnippet;
        if (!box || !state.bmPrompts.length) return;
        const valid = state.bmPrompts.filter(b => b.text && b.text.length > 10);
        if (!valid.length) return;
        const pick = valid[Math.floor(Math.random() * valid.length)];
        const ts = new Date(pick.ts || Date.now()).toLocaleString();
        let info = `[Memory from ${ts}]`;
        if (pick.weather) info += ` [${pick.weather}]`;
        box.innerHTML =
          `<div style="font-size:11px;opacity:0.6;margin-bottom:8px">${info}</div>` +
          pick.text.slice(0, 300) +
          "...";
      }

      function registerActivity() {
        const wasDream = state.dreamMode;
        state.lastActivity = Date.now();

        if (wasDream) {
          state.dreamMode = false;
          if (els.dreamOverlay) els.dreamOverlay.style.display = "none";
          if (dreamInterval) {
            clearInterval(dreamInterval);
            dreamInterval = null;
          }
          if (state.decayTimer) {
            clearInterval(state.decayTimer);
            state.decayTimer = null;
          }
          logLine("sys", "[Dream mode] Woke up ‚Äì user is active again.");
        }
        scheduleInactivityCheck();
      }

      function scheduleInactivityCheck() {
        if (state.inactivityTimer) clearTimeout(state.inactivityTimer);
        state.inactivityTimer = setTimeout(() => {
          const now = Date.now();
          if (now - state.lastActivity >= DREAM_IDLE_MS) {
            enterDreamMode();
          }
        }, DREAM_IDLE_MS);
      }

      function enterDreamMode() {
        if (state.dreamMode) return;
        state.dreamMode = true;

        if (els.dreamOverlay) els.dreamOverlay.style.display = "flex";
        showNextDreamSnippet();
        dreamInterval = setInterval(showNextDreamSnippet, 10000);

        logLine("sys", "[Dream mode] Started visual screensaver & cleaning.");
        performSystemDecay();

        if (state.decayTimer) {
          clearInterval(state.decayTimer);
          state.decayTimer = null;
        }
        state.decayTimer = setInterval(() => {
          if (!state.dreamMode) {
            clearInterval(state.decayTimer);
            state.decayTimer = null;
            return;
          }
          performSystemDecay();
        }, DREAM_TICK_MS);
      }

      async function maybeCreateBMStory(userText) {
        const t = (userText || "").trim();
        if (!t) return;
        if (!looksLikeStory(t)) return;
        if (state.metrics.TM < 0.6) return;
        if (state.lastStoryInput && state.lastStoryInput === t) return;

        const existing = state.bmPrompts.find(bm =>
          (bm.text || "").includes(t.slice(0, 120))
        );
        if (existing) {
          state.lastStoryInput = t;
          state.lastStoryBMId = existing.id;
          return;
        }

        const weatherLine = getWeatherSnapshot();
        let combined = t;
        if (weatherLine) {
          combined += `\n\n[Context snapshot: ${weatherLine}]`;
        }

        const now = Date.now();
        const id = "bm_story_" + now;
        const bm = {
          id,
          title: "Story " + new Date(now).toLocaleDateString(),
          text: combined,
          ts: now,
          locked: false,
          liveUntil: null,
          weather: weatherLine || null
        };

        state.bmPrompts.push(bm);
        state.lastStoryInput = t;
        state.lastStoryBMId = id;
        saveBM();
        recomputeBMMetric();
        recomputeE0(0, 0);
        updateCapsule();
        renderBMList();
        logLine("sys", "[Story] Saved this as a BM story (with offline weather snapshot).");
      }

      // ---------- history, faith, intelligence ----------
      function addHistory(role,text){
        const item = { role, text, ts: Date.now(), locked: false };
        state.history.push(item);
        const cutoff = Date.now() - 48*60*60*1000;
        state.history = state.history.filter(h => h.locked || h.ts >= cutoff);
        saveHistory();
      }

      function toggleHistoryLock(idx){
        const h = state.history[idx];
        if(!h) return;
        h.locked = !h.locked;
        saveHistory();
        renderHistory();
      }

      function renderHistory(){
        els.historyBox.innerHTML = "";
        state.history.forEach((h,idx)=>{
          const row = document.createElement("div");
          row.className = "historyLine";
          const dt = new Date(h.ts).toLocaleString([], {hour:"2-digit",minute:"2-digit", day:"2-digit", month:"short"});
          const label = h.role==="user" ? "You" : (h.role==="aura" ? "AURA" : h.role);
          const left = document.createElement("div");
          left.className = "historyText";
          left.textContent = `[${dt}] ${label}: ${h.text}`;
          const btn = document.createElement("button");
          btn.className = "historyLock";
          btn.textContent = h.locked ? "üîí" : "üîì";
          btn.addEventListener("click", ()=>toggleHistoryLock(idx));
          row.appendChild(left);
          row.appendChild(btn);
          els.historyBox.appendChild(row);
        });
      }

      function renderFaithChips(){
        els.faithChips.innerHTML = "";
        FAITH_OPTIONS.forEach(opt=>{
          const chip = document.createElement("button");
          chip.className = "chip" + (state.faithSelection.includes(opt.id) ? " active" : "");
          chip.textContent = opt.label;
          chip.addEventListener("click", ()=>{
            if(opt.id==="none"){
              state.faithSelection = [];
            } else {
              if(state.faithSelection.includes(opt.id)){
                state.faithSelection = state.faithSelection.filter(x=>x!==opt.id);
              } else {
                state.faithSelection = state.faithSelection.filter(x=>x!=="none");
                state.faithSelection.push(opt.id);
              }
            }
            els.faithLabel.textContent = state.faithSelection.length ? state.faithSelection.join(", ") : "none";
            renderFaithChips();
            saveCfg();
          });
          els.faithChips.appendChild(chip);
        });
      }

      function maybeShowFaithBubble(){
        if(!state.faithSelection.length) return;
        const pick = state.faithSelection[0];
        const list = FAITH_LIBRARY[pick];
        if(!list || !list.length) return;
        const art = list[0];
        state.currentFaithArticle = art;
        els.faithBubbleTitle.textContent = art.title;
        els.faithBubbleMeta.textContent = art.short;
        els.faithBubble.classList.add("show","pulse");
      }

      function openModal(el){
        el.classList.add("show");
      }
      function closeModalById(id){
        const el = document.getElementById(id);
        if(el) el.classList.remove("show");
      }

      document.body.addEventListener("click",(e)=>{
        const target = e.target;
        if(target.dataset && target.dataset.close){
          closeModalById(target.dataset.close);
        }
        if(target.classList.contains("modalOverlay") && !target.classList.contains("noClose")){
          target.classList.remove("show");
        }
      });

      els.faithBubble.addEventListener("click",()=>{
        if(!state.currentFaithArticle) return;
        const art = state.currentFaithArticle;
        const meta = `Lens: ${state.faithSelection.join(", ")} ¬∑ id=${art.id}`;
        els.faithArticleMeta.textContent = meta;
        els.faithArticleTitle.textContent = art.title;
        els.faithArticleText.value = art.content;
        openModal(els.modalFaithArticle);
      });
      els.faithBubbleClose.addEventListener("click",(ev)=>{
        ev.stopPropagation();
        els.faithBubble.classList.remove("show","pulse");
      });
      els.btnCopyFaithArticle.addEventListener("click",()=>{
        navigator.clipboard?.writeText(els.faithArticleText.value||"");
        showToast("Faith reflection copied");
      });
      els.btnAddFaithToBM.addEventListener("click",()=>{
        if(!els.faithArticleText.value.trim()) return;
        const now = Date.now();
        const bm = {
          id: "bm_"+now,
          title: els.faithArticleTitle.textContent || "Faith reflection",
          text: els.faithArticleText.value,
          ts: now,
          locked: true,
          liveUntil: null
        };
        state.bmPrompts.push(bm);
        saveBM();
        recomputeBMMetric();
        recomputeE0(0,0);
        updateCapsule();
        renderBMList();
        showToast("Added under BM (locked)");
      });
      els.btnSkipFaithBM.addEventListener("click",()=>{
        closeModalById("modalFaithArticle");
      });

      function renderIntelligence(filter=""){
        els.intelList.innerHTML = "";
        const q = (filter||"").toLowerCase();
        const list = state.intelligence.filter(item=>{
          if(!q) return true;
          return (item.q||"").toLowerCase().includes(q) || (item.a||"").toLowerCase().includes(q);
        });
        if(!list.length){
          const p = document.createElement("div");
          p.style.fontSize = "12px";
          p.style.opacity = "0.65";
          p.textContent = "No intelligence stored yet.";
          els.intelList.appendChild(p);
          return;
        }
        list.forEach(item=>{
          const card = document.createElement("div");
          card.className = "intelCard";
          const top = document.createElement("div");
          top.className = "intelTop";
          const qDiv = document.createElement("div");
          qDiv.className = "intelQ";
          qDiv.textContent = "Q: " + item.q;
          const meta = document.createElement("div");
          meta.className = "intelMeta";
          const dt = new Date(item.ts||Date.now()).toLocaleString();
          meta.textContent = `id=${item.id} ¬∑ ${dt}`;
          top.appendChild(qDiv);
          top.appendChild(meta);
          const aDiv = document.createElement("div");
          aDiv.className = "intelA";
          aDiv.textContent = "A: " + item.a;
          const btns = document.createElement("div");
          btns.className = "intelButtons";
          const bEdit = document.createElement("button");
          bEdit.className = "btn btnBlue";
          bEdit.textContent = "Edit";
          const bDelete = document.createElement("button");
          bDelete.className = "btn btnRed";
          bDelete.textContent = "Delete";
          const bCopy = document.createElement("button");
          bCopy.className = "btn btnBlue";
          bCopy.textContent = "Copy";
          bCopy.addEventListener("click",()=>{
            navigator.clipboard?.writeText(`Q: ${item.q}\nA: ${item.a}`);
            showToast("Pair copied");
          });
          bDelete.addEventListener("click",()=>{
            if(!confirm("Delete this Q‚ÜíA pair?")) return;
            state.intelligence = state.intelligence.filter(x=>x.id!==item.id);
            saveIntelligence();
            renderIntelligence(els.intelSearch.value);
            showToast("Deleted");
          });
          bEdit.addEventListener("click",()=>{
            state.editingIntelId = (state.editingIntelId === item.id) ? null : item.id;
            renderIntelligence(els.intelSearch.value);
          });
          btns.appendChild(bEdit);
          btns.appendChild(bCopy);
          btns.appendChild(bDelete);
          card.appendChild(top);
          card.appendChild(aDiv);
          card.appendChild(btns);
          if(state.editingIntelId === item.id){
            const editBlock = document.createElement("div");
            editBlock.className = "intelEditBlock";
            const qi = document.createElement("input");
            qi.className = "intelEditInput";
            qi.value = item.q;
            const ai = document.createElement("textarea");
            ai.className = "intelEditArea";
            ai.value = item.a;
            const row = document.createElement("div");
            row.style.display = "flex";
            row.style.gap = "8px";
            row.style.marginTop = "6px";
            row.style.flexWrap = "wrap";
            const bSave = document.createElement("button");
            bSave.className = "btn btnGreen";
            bSave.textContent = "Save";
            const bCancel = document.createElement("button");
            bCancel.className = "btn btnRed";
            bCancel.textContent = "Cancel";
            bSave.addEventListener("click",()=>{
              item.q = qi.value.trim();
              item.a = ai.value.trim();
              item.ts = item.ts || Date.now();
              saveIntelligence();
              state.editingIntelId = null;
              renderIntelligence(els.intelSearch.value);
              showToast("Updated");
            });
            bCancel.addEventListener("click",()=>{
              state.editingIntelId = null;
              renderIntelligence(els.intelSearch.value);
            });
            row.appendChild(bSave);
            row.appendChild(bCancel);
            editBlock.appendChild(qi);
            editBlock.appendChild(ai);
            editBlock.appendChild(row);
            card.appendChild(editBlock);
          }
          els.intelList.appendChild(card);
        });
      }
      els.intelSearch.addEventListener("input",()=>renderIntelligence(els.intelSearch.value));

      function parseSeedBlock(text){
        const lines = text.split(/\r?\n/);
        const joined = lines.join("\n");
        const regex = /\\item\s*(.+?)\s*\\textbf\{A:\}\s*([\s\S]*?)(?=\\item|$)/g;
        const out = [];
        let m;
        while((m = regex.exec(joined))!==null){
          const q = m[1].trim();
          const rawA = m[2].trim();
          let a = rawA;
          const bracket = rawA.match(/^\[.*?\]\s*(.*)$/s);
          if(bracket) a = bracket[1].trim();
          if(q && a){
            out.push({ id:"seed_"+(Date.now()+"_"+out.length), q, a, ts:Date.now() });
          }
        }
        return out;
      }

      els.btnParseSeed.addEventListener("click",()=>{
        const txt = els.seedBox.value.trim();
        if(!txt){ els.seedHint.textContent = "Nothing to parse."; return; }
        const parsed = parseSeedBlock(txt);
        state.parsedSeed = parsed;
        els.seedHint.textContent = `Parsed ${parsed.length} Q‚ÜíA pairs (not saved yet).`;
      });
      els.btnSaveSeed.addEventListener("click",()=>{
        if(!state.parsedSeed.length){
          els.seedHint.textContent = "Nothing parsed yet.";
          return;
        }
        state.seedPairs = state.seedPairs.concat(state.parsedSeed);
        state.parsedSeed = [];
        els.seedHint.textContent = "Saved into seed memory.";
        els.seedBox.value = "";
        showToast("Seed updated");
      });
      els.btnDiscardSeed.addEventListener("click",()=>{
        els.seedBox.value = "";
        state.parsedSeed = [];
        els.seedHint.textContent = "Discarded block.";
      });

      function applyLogicPack(idx){
        state.logicActiveIndex = idx;
        if(idx==null || !state.logicPacks[idx]) return;
        const pack = state.logicPacks[idx];
        state.logicFaithSoftener = pack.faithSoftener !== false;
        if(pack.ui){
          if(pack.ui.theme === "golden"){
            document.body.classList.add("theme-golden");
          } else {
            document.body.classList.remove("theme-golden");
          }
          if(pack.ui.accentColor){
            document.documentElement.style.setProperty("--accent-color", pack.ui.accentColor);
          }
        }
        persistLogicState();
      }
      els.btnValidateLogic.addEventListener("click",()=>{
        try{
          const obj = JSON.parse(els.logicBox.value);
          els.logicHint.textContent = "Valid JSON.";
          showToast("Logic JSON valid");
        }catch(e){
          els.logicHint.textContent = "Invalid JSON: "+e.message;
        }
      });
      els.btnSaveLogic.addEventListener("click",()=>{
        try{
          const obj = JSON.parse(els.logicBox.value);
          obj.serial = obj.serial || ("L"+(state.logicPacks.length+1));
          state.logicPacks.push(obj);
          els.logicSerial.textContent = obj.serial;
          els.logicHint.textContent = "Saved as "+obj.serial;
          applyLogicPack(state.logicPacks.length-1);
          persistLogicState();
          showToast("Logic pack saved");
        }catch(e){
          els.logicHint.textContent = "Cannot save: invalid JSON.";
        }
      });
      els.btnCopyLogic.addEventListener("click",()=>{
        navigator.clipboard?.writeText(els.logicBox.value||"");
        showToast("Logic copied");
      });
      els.btnDeleteLogic.addEventListener("click",()=>{
        if(state.logicActiveIndex==null || !state.logicPacks[state.logicActiveIndex]){
          els.logicHint.textContent = "No active logic pack.";
          return;
        }
        if(!confirm("Delete current logic pack?")) return;
        state.logicPacks.splice(state.logicActiveIndex,1);
        state.logicActiveIndex = null;
        els.logicSerial.textContent = "none";
        els.logicHint.textContent = "Deleted.";
        document.body.classList.remove("theme-golden");
        document.documentElement.style.setProperty("--accent-color", "#0ea5e9");
        persistLogicState();
      });

      function renderBMList(){
        els.bmSelectList.innerHTML = "";
        const q = (els.bmSearch.value||"").toLowerCase();
        const d = (els.bmDate.value||"");
        const list = state.bmPrompts.filter(b=>{
          let ok = true;
          if(q){
            ok = (b.title||"").toLowerCase().includes(q) || (b.text||"").toLowerCase().includes(q);
          }
          if(ok && d){
            const dStr = new Date(b.ts||Date.now()).toISOString().slice(0,10);
            ok = (dStr === d);
          }
          return ok;
        }).sort((a,b)=> (b.ts||0)-(a.ts||0));
        if(!list.length){
          const div = document.createElement("div");
          div.style.fontSize = "12px";
          div.style.opacity = "0.65";
          div.textContent = "No BM prompts yet.";
          els.bmSelectList.appendChild(div);
          return;
        }
        list.forEach(bm=>{
          const item = document.createElement("div");
          item.className = "bmItem";
          const left = document.createElement("div");
          const title = document.createElement("div");
          title.className = "bmItemTitle";
          title.textContent = bm.title||"(untitled)";
          const meta = document.createElement("div");
          meta.className = "bmItemMeta";
          const ds = new Date(bm.ts||Date.now()).toISOString().slice(0,10);
          meta.textContent = ds + (bm.locked ? " ¬∑ üîí" : "");
          left.appendChild(title);
          left.appendChild(meta);
          item.appendChild(left);
          item.addEventListener("click",()=>selectBM(bm.id));
          els.bmSelectList.appendChild(item);
        });
      }

      function selectBM(id){
        const bm = state.bmPrompts.find(x=>x.id===id);
        state.selectedBMId = id;
        if(!bm){
          els.bmViewer.style.display = "none";
          return;
        }
        els.bmViewer.style.display = "block";
        els.bmTitle.textContent = bm.title||"Prompt";
        const ds = new Date(bm.ts||Date.now()).toLocaleString();
        const live = bm.liveUntil && bm.liveUntil > Date.now();
        els.bmMeta.textContent = ds + (bm.locked ? " ¬∑ locked" : " ¬∑ editable") + (live ? " ¬∑ LIVE 12h" : "");
        els.bmTextArea.value = bm.text||"";
        els.bmTextArea.readOnly = true;
        els.bmLockIcon.textContent = bm.locked ? "üîí" : "üîì";
        els.btnUnlockBM.style.display = bm.locked ? "inline-flex" : "none";
        els.btnLiveBM.textContent = live ? "Live 12h: on" : "Live 12h: off";
      }

      els.bmSearch.addEventListener("input", renderBMList);
      els.bmDate.addEventListener("change", ()=>{
        renderBMList();
        const d = els.bmDate.value;
        if(d){
          const found = state.bmPrompts.find(b=>{
            const ds = new Date(b.ts||Date.now()).toISOString().slice(0,10);
            return ds === d;
          });
          if(found) selectBM(found.id);
        }
      });

      els.btnLiveBM.addEventListener("click",()=>{
        if(!state.selectedBMId) return;
        const bm = state.bmPrompts.find(x=>x.id===state.selectedBMId);
        if(!bm) return;
        const now = Date.now();
        if(bm.liveUntil && bm.liveUntil > now){
          bm.liveUntil = null;
        } else {
          bm.liveUntil = now + 12*60*60*1000;
        }
        saveBM();
        renderBMList();
        selectBM(bm.id);
      });

      els.btnUnlockBM.addEventListener("click",()=>{
        if(!state.selectedBMId) return;
        const bm = state.bmPrompts.find(x=>x.id===state.selectedBMId);
        if(!bm) return;
        if(!confirm("Unlock this BM prompt for editing?")) return;
        bm.locked = false;
        saveBM();
        renderBMList();
        selectBM(bm.id);
      });

      els.btnCopyPrompt.addEventListener("click",()=>{
        if(!state.selectedBMId) return;
        const bm = state.bmPrompts.find(x=>x.id===state.selectedBMId);
        if(!bm) return;
        navigator.clipboard?.writeText(bm.text||"");
        showToast("BM prompt copied");
      });
      els.btnAutoGen.addEventListener("click",()=>{
        showToast("Video generation is a placeholder in this offline prototype.");
      });
      els.btnDeletePrompt.addEventListener("click",()=>{
        if(!state.selectedBMId) return;
        const bm = state.bmPrompts.find(x=>x.id===state.selectedBMId);
        if(!bm) return;
        if(!confirm("Delete this BM prompt?")) return;
        if(!confirm("Are you sure? This cannot be undone.")) return;
        state.bmPrompts = state.bmPrompts.filter(x=>x.id!==bm.id);
        state.selectedBMId = null;
        saveBM();
        recomputeBMMetric();
        recomputeE0(0,0);
        updateCapsule();
        renderBMList();
        els.bmViewer.style.display = "none";
        showToast("BM prompt deleted");
      });

      function loadIdentityIntoForm(){
        const u = state.userIdentity || {};
        els.uName.value = u.name || "";
        els.uNick.value = u.nick || "";
        els.uOrigin.value = u.origin || "";
        els.uPlace.value = u.place || "";
        els.uProfession.value = u.profession || "";
        els.uEmotionalStyle.value = u.emotionalStyle || "";
        els.uKeyPeople.value = u.keyPeople || "";
        els.uLegacyRules.value = u.legacyRules || "";
      }

      els.btnEditIdentity.addEventListener("click",()=>{
        [els.uName,els.uNick,els.uOrigin,els.uPlace,els.uProfession,
          els.uEmotionalStyle,els.uKeyPeople,els.uLegacyRules].forEach(el=>el.removeAttribute("readonly"));
        showToast("Identity fields unlocked for edit");
      });
      els.btnSaveUserIdentity.addEventListener("click",()=>{
        state.userIdentity = {
          name: els.uName.value.trim(),
          nick: els.uNick.value.trim(),
          origin: els.uOrigin.value.trim(),
          place: els.uPlace.value.trim(),
          profession: els.uProfession.value.trim(),
          emotionalStyle: els.uEmotionalStyle.value.trim(),
          keyPeople: els.uKeyPeople.value.trim(),
          legacyRules: els.uLegacyRules.value.trim(),
          ts: Date.now()
        };
        saveUserIdentity();
        [els.uName,els.uNick,els.uOrigin,els.uPlace,els.uProfession,
          els.uEmotionalStyle,els.uKeyPeople,els.uLegacyRules].forEach(el=>el.setAttribute("readonly","readonly"));
        showToast("Identity saved locally");
      });
      els.btnDeleteUserIdentity.addEventListener("click",()=>{
        if(!confirm("Delete stored identity data?")) return;
        if(!confirm("Are you sure?")) return;
        state.userIdentity = null;
        localStorage.removeItem(KEY_USER);
        [els.uName,els.uNick,els.uOrigin,els.uPlace,els.uProfession,
          els.uEmotionalStyle,els.uKeyPeople,els.uLegacyRules].forEach(el=>el.value="");
        showToast("Identity deleted");
      });

      els.btnSaveLLM.addEventListener("click",()=>{
        state.apiConfig = {
          endpoint: els.apiEndpoint.value.trim(),
          model: els.apiModel.value.trim(),
          key: els.apiKey.value.trim()
        };
        saveCfg();
        showToast("LLM config saved");
      });

      async function loadOfflineModel(){
        if(!window.webllm){
          els.offlineStatus.textContent = "WebLLM not available.";
          return;
        }
        if(state.offlineReady || state.offlineLoading) return;
        try{
          state.offlineLoading = true;
          els.offlineStatus.textContent = "loading‚Ä¶";
          els.offlineBar.style.width = "25%";
          const engine = await window.webllm.CreateMLCEngine(OFFLINE_MODEL_ID, {
            initProgressCallback: (p)=>{
              const pct = Math.round((p.progress||0)*100);
              els.offlineBar.style.width = pct+"%";
            }
          });
          state.offlineEngine = engine;
          state.offlineReady = true;
          state.offlineLoading = false;
          els.offlineStatus.textContent = "ready";
          els.offlineBar.style.width = "100%";
          saveCfg();
          showToast("Offline model ready");
        }catch(e){
          state.offlineLoading = false;
          els.offlineStatus.textContent = "error";
          showToast("Offline model error");
        }
      }
      els.btnLoadOffline.addEventListener("click", loadOfflineModel);

      async function callOfflineLLM(prompt){
        if(!state.offlineReady || !state.offlineEngine) return null;
        try{
          const reply = await state.offlineEngine.chatCompletion({
            messages:[{role:"user",content:prompt}],
            stream:false
          });
          const text = reply?.choices?.[0]?.message?.content || "";
          return text.trim() || null;
        }catch{
          return null;
        }
      }

      async function callOnlineLLM(prompt){
        const {endpoint,model,key} = state.apiConfig;
        if(!endpoint || !model || !key) return null;
        try{
          const resp = await fetch(endpoint,{
            method:"POST",
            headers:{
              "Content-Type":"application/json",
              "Authorization":"Bearer "+key
            },
            body:JSON.stringify({
              model,
              messages:[{role:"user",content:prompt}],
              temperature:0.7
            })
          });
          if(!resp.ok) return null;
          const data = await resp.json();
          const text = data.choices?.[0]?.message?.content || "";
          return text.trim() || null;
        }catch{
          return null;
        }
      }

      els.btnOptions.addEventListener("click",()=>{
        els.optionsMenu.classList.toggle("show");
      });
      els.miVoice.addEventListener("click",()=>{
        state.voiceOn = !state.voiceOn;
        els.voicePill.textContent = state.voiceOn ? "on" : "off";
        els.voicePill.className = state.voiceOn ? "pillOn" : "pillOff";
        saveCfg();
      });
      els.miLearn.addEventListener("click",()=>{
        state.learningOn = !state.learningOn;
        els.learnPill.textContent = state.learningOn ? "on" : "off";
        els.learnPill.className = state.learningOn ? "pillOn" : "pillOff";
        saveCfg();
      });
      els.miFaith.addEventListener("click",()=>openModal(els.modalFaith));
      els.miIntel.addEventListener("click",()=>openModal(els.modalIntel));
      els.miSeed.addEventListener("click",()=>openModal(els.modalSeed));
      els.miLLM.addEventListener("click",()=>openModal(els.modalLLM));
      els.miBMRecall.addEventListener("click",()=>openModal(els.modalBM));
      els.miHistory.addEventListener("click",()=>{renderHistory();openModal(els.modalHistory);});
      els.miIdentity.addEventListener("click",()=>{loadIdentityIntoForm();openModal(els.modalIdentity);});

      els.btnDeleteRecent.addEventListener("click",()=>{
        const cutoff = Date.now() - 48*60*60*1000;
        state.history = state.history.filter(h=>h.locked || h.ts < cutoff);
        saveHistory();
        renderHistory();
      });
      els.btnDeleteAllHist.addEventListener("click",()=>{
        if(!confirm("Delete all history (except locked)?")) return;
        state.history = state.history.filter(h=>h.locked);
        saveHistory();
        renderHistory();
      });
      els.btnCopyHistory.addEventListener("click",()=>{
        const text = state.history.map(h=>{
          const dt = new Date(h.ts).toLocaleString();
          const label = h.role==="user" ? "You" : (h.role==="aura" ? "AURA" : h.role);
          return `[${dt}] ${label}: ${h.text}`;
        }).join("\n");
        navigator.clipboard?.writeText(text);
        showToast("History copied");
      });

      async function handleSend(){
        const raw = els.userInput.value;
        const text = raw.trim();
        if(!text) return;

        if (text.toLowerCase() === "incorrect" && state.lastUserQ && state.lastAuraA && !state.correcting) {
          els.userInput.value = "";
          registerActivity();
          logLine("user","You: incorrect");
          logLine("sys","[Self-learning] Please type the correct answer for the last question.");
          state.correcting = true;
          return;
        }

        els.userInput.value = "";
        els.optionsMenu.classList.remove("show");
        registerActivity();

        if(state.correcting){
          const correctA = text;
          if(state.lastUserQ && correctA){
            const id = "intel_"+Date.now();
            state.intelligence.push({
              id,
              q: state.lastUserQ,
              a: correctA,
              ts: Date.now()
            });
            saveIntelligence();
            renderIntelligence(els.intelSearch.value);
            logLine("sys","[Self-learning] Stored corrected answer into intelligence.");
            showToast("Correct answer stored");
          }
          state.correcting = false;
          return;
        }

        logLine("user","You: "+text);

        const now = Date.now();
        if(state.cooldownUntil && now < state.cooldownUntil){
          logLine("sys","[Cooldown] Please wait a moment before sending more messages.");
          return;
        }

        state.metrics.TM = scoreTM(text);
        recomputeBMMetric();

        let intelBoost = 0, llmBoost = 0;
        let answer = null;
        let source = "none";

        const tLower = text.toLowerCase();
        let bestMatch = state.intelligence.find(p=>p.q.toLowerCase()===tLower);
        if(!bestMatch){
          bestMatch = state.intelligence.find(p=>tLower.includes(p.q.toLowerCase()) || p.q.toLowerCase().includes(tLower));
        }
        if(bestMatch){
          answer = bestMatch.a;
          source = "intelligence";
          intelBoost = 0.35;
        }

        if(!answer && state.seedPairs.length){
          let sMatch = state.seedPairs.find(p=>p.q.toLowerCase()===tLower);
          if(!sMatch){
            sMatch = state.seedPairs.find(p=>tLower.includes(p.q.toLowerCase()) || p.q.toLowerCase().includes(tLower));
          }
          if(sMatch){
            answer = sMatch.a;
            source = "seed";
            intelBoost = 0.25;
          }
        }

        if(!answer && state.offlineReady){
          answer = await callOfflineLLM(text);
          if(answer){
            source = "offline";
            llmBoost = 0.25;
          }
        }

        if(!answer){
          answer = await callOnlineLLM(text);
          if(answer){
            source = "online";
            llmBoost = 0.30;
          }
        }

        if(!answer){
          answer = "I don't have a stored answer yet. You can teach me using the üëé button or by adding LaTeX blocks under Feed the seed.";
          source = "fallback";
        }

        state.lastUserQ = text;
        state.lastAuraA = answer;
        state.lastAnswerSource = source;

        recomputeE0(intelBoost, llmBoost);
        updateCapsule();

        logLine("aura","AURA: "+answer+"  (source: "+source+")");

        if(state.voiceOn){
          try{
            const u = new SpeechSynthesisUtterance(answer);
            speechSynthesis.speak(u);
          }catch{}
        }

        await maybeCreateBMStory(text);
        maybeShowFaithBubble();
      }

      els.sendBtn.addEventListener("click",handleSend);
      els.userInput.addEventListener("keydown",e=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          handleSend();
        }
      });

      els.btnLikeLast.addEventListener("click",()=>{
        if(!state.lastUserQ || !state.lastAuraA){
          showToast("No last answer to save");
          return;
        }
        const already = state.intelligence.find(p=>p.q===state.lastUserQ && p.a===state.lastAuraA);
        if(already){
          showToast("Already in intelligence");
          return;
        }
        const id = "intel_"+Date.now();
        state.intelligence.push({id,q:state.lastUserQ,a:state.lastAuraA,ts:Date.now()});
        saveIntelligence();
        renderIntelligence(els.intelSearch.value);
        showToast("Saved to intelligence");
      });
      els.btnDislikeLast.addEventListener("click",()=>{
        if(!state.lastUserQ || !state.lastAuraA){
          showToast("No last answer");
          return;
        }
        logLine("sys","[Self-learning] Type the correct answer or send 'incorrect' first.");
        state.correcting = true;
      });
      els.btnSpeakLast.addEventListener("click",()=>{
        if(!state.lastAuraA){
          showToast("No last answer");
          return;
        }
        try{
          const u = new SpeechSynthesisUtterance(state.lastAuraA);
          speechSynthesis.speak(u);
        }catch{}
      });
      els.btnShareLast.addEventListener("click",()=>{
        if(!state.lastUserQ || !state.lastAuraA){
          showToast("No last pair");
          return;
        }
        const text = `Q: ${state.lastUserQ}\nA: ${state.lastAuraA}`;
        navigator.clipboard?.writeText(text);
        showToast("Question + answer copied");
      });

      function initFromStorage(){
        const cfg = safeLoadJSON(KEY_CFG,null);
        if(cfg){
          state.voiceOn = !!cfg.voiceOn;
          state.learningOn = cfg.learningOn!==false;
          state.faithSelection = cfg.faithSelection||[];
          state.apiConfig = cfg.apiConfig||state.apiConfig;
          state.offlineReady = !!cfg.offlineReady;
        }
        els.voicePill.textContent = state.voiceOn ? "on" : "off";
        els.voicePill.className = state.voiceOn ? "pillOn" : "pillOff";
        els.learnPill.textContent = state.learningOn ? "on" : "off";
        els.learnPill.className = state.learningOn ? "pillOn" : "pillOff";
        els.faithLabel.textContent = state.faithSelection.length ? state.faithSelection.join(", ") : "none";
        state.intelligence = safeLoadJSON(KEY_INT,[]);
        state.bmPrompts = safeLoadJSON(KEY_BM,[]);
        state.history = safeLoadJSON(KEY_HIST,[]);
        state.userIdentity = safeLoadJSON(KEY_USER,null);
        const logicStored = safeLoadJSON(KEY_LOGIC,null);
        if(logicStored){
          state.logicPacks = logicStored.list||[];
          state.logicActiveIndex = logicStored.activeIndex;
          if(state.logicActiveIndex!=null) applyLogicPack(state.logicActiveIndex);
        }
        if(state.apiConfig.endpoint) els.apiEndpoint.value = state.apiConfig.endpoint;
        if(state.apiConfig.model) els.apiModel.value = state.apiConfig.model;
        if(state.apiConfig.key) els.apiKey.value = state.apiConfig.key;
        renderFaithChips();
        renderIntelligence("");
        renderBMList();
        renderHistory();
        loadIdentityIntoForm();
        recomputeBMMetric();
        recomputeE0(0,0);
        updateCapsule();
      }

      initFromStorage();

      // Dream overlay click ‚Üí wake
      if (els.dreamOverlay) {
        els.dreamOverlay.addEventListener("click", () => {
          registerActivity();
        });
      }

      // Dream-mode wiring
      state.lastActivity = Date.now();
      scheduleInactivityCheck();
      ["click","keydown","pointerdown","touchstart","mousemove"].forEach(ev => {
        document.addEventListener(ev, registerActivity, { passive: true });
      });
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) registerActivity();
      });

      logLine("sys","AURA-X Œ© ready. TM = your inputs only; everything else stays on this device.");
    });
  </script>
</body>
</html>