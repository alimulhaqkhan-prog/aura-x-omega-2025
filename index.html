<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Offline LLM package (WebLLM, for in-browser models) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    /* =======================
       CODE 2 UI (kept as base)
       ======================= */

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px 10px;
    }

    .app{
      width:min(980px, 98vw);
      background:rgba(2,6,23,.45);
      border:1px solid rgba(148,163,184,.18);
      border-radius:22px;
      overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      backdrop-filter:blur(10px);
    }

    .top{
      padding:20px 18px 10px 18px;
      border-bottom:1px solid rgba(148,163,184,.22);
      text-align:center;
    }
    .brand{
      font-weight:800;
      letter-spacing:.5px;
      font-size:26px;
      color:#7dd3fc;
      text-shadow:0 0 22px rgba(14,165,233,.28);
    }
    .sub{
      opacity:.8;
      margin-top:2px;
      font-size:13px;
    }

    .pillRow{
      margin-top:10px;
      display:flex;
      justify-content:center;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(56,189,248,.4);
      background:radial-gradient(circle at 0 0,#0ea5e9 0,transparent 55%),
                 radial-gradient(circle at 100% 100%,#22c55e 0,transparent 55%),
                 rgba(15,23,42,.95);
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.12em;
      box-shadow:0 0 25px rgba(56,189,248,.4);
    }
    .pill span:nth-child(2){
      opacity:.9;
      font-weight:500;
    }

    .main{ padding:16px 16px 18px 16px; }

    .row{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:stretch;
    }

    .leftCol{
      flex:1 1 340px;
      min-width:300px;
    }

    .rightCol{
      flex:1 1 360px;
      min-width:320px;
    }

    .card{
      background:rgba(2,6,23,.50);
      border:1px solid rgba(148,163,184,.16);
      border-radius:18px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      backdrop-filter:blur(10px);
    }

    .optionsBtn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      background:radial-gradient(circle at 0 0,rgba(56,189,248,.32) 0,transparent 60%),
                 rgba(15,23,42,.96);
      cursor:pointer;
      font-size:13px;
      font-weight:500;
      letter-spacing:.04em;
      text-transform:uppercase;
      user-select:none;
    }
    .gear{
      width:18px;
      height:18px;
    }

    .console{
      margin-top:12px;
      border-radius:14px;
      background:rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.28);
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;
      padding:10px 12px;
      height:260px;
      overflow:auto;
      color:#e5e7eb;
      box-shadow:inset 0 0 0 1px rgba(125,211,252,.06);
      line-height:1.55;
      white-space:pre-wrap;
    }

    .chatWrap{
      margin-top:14px;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.45);
      display:flex;
      flex-direction:column;
      max-height:calc(100vh - 260px);
    }

    .messages{
      flex:1;
      overflow-y:auto;
      padding-right:6px;
    }

    .msg{
      display:inline-block;
      margin:8px 0;
      padding:10px 12px;
      border-radius:14px;
      max-width:86%;
      line-height:1.4;
    }
    .user{
      background:linear-gradient(90deg, rgba(14,165,233,.80), rgba(34,211,238,.55));
      color:#0b1220;
      border-top-right-radius:4px;
      margin-left:auto;
      display:block;
    }
    .bot{
      background:rgba(15,23,42,.96);
      border:1px solid rgba(148,163,184,.40);
      border-top-left-radius:4px;
      display:block;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:10px;
      opacity:.8;
      margin-bottom:2px;
    }
    .tag span:nth-child(1){
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      font-weight:600;
    }
    .tag span:nth-child(2){
      font-weight:500;
    }

    .tmBadge{
      font-size:11px;
      opacity:.85;
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-top:4px;
    }
    .tmBadge span:first-child{
      width:6px;
      height:6px;
      border-radius:999px;
      background:#38bdf8;
      box-shadow:0 0 12px rgba(56,189,248,.8);
    }

    .bmBadge{
      font-size:11px;
      opacity:.85;
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-top:2px;
    }
    .bmBadge span:first-child{
      width:6px;
      height:6px;
      border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 12px rgba(34,197,94,.8);
    }

    .small{
      font-size:11px;
      opacity:.8;
    }

    /* NEW: live capsule line above input */
    .liveCapsule{
      margin-top:10px;
      margin-bottom:10px;
      width:100%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      padding:10px 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
    }
    .liveCapsule span b{
      color:#7dd3fc;
      font-weight:900;
    }

    .inputRow{
      display:flex;
      gap:10px;
      margin-top:0px;
      align-items:flex-end;
      position:sticky;
      bottom:0;
      padding-top:6px;
      padding-bottom:4px;
      background:linear-gradient(to top, rgba(15,23,42,.98), rgba(15,23,42,.92), transparent);
    }

    .input{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.55);
      padding:10px 12px;
      color:#e5e7eb;
      font-size:14px;
      outline:none;
    }
    .input::placeholder{
      color:rgba(148,163,184,.8);
      font-size:13px;
    }

    .send{
      border-radius:999px;
      border:none;
      background:linear-gradient(90deg,#0ea5e9,#22c55e);
      padding:10px 16px;
      font-size:13px;
      font-weight:600;
      color:#0b1120;
      cursor:pointer;
      min-width:90px;
      display:inline-flex;
      justify-content:center;
      align-items:center;
      box-shadow:0 10px 25px rgba(34,197,94,.35);
    }
    .send:active{
      transform:translateY(1px);
      box-shadow:0 4px 16px rgba(34,197,94,.30);
    }

    .formula{
      margin-top:10px;
      font-size:11px;
      opacity:.8;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      border-radius:14px;
      border:1px dashed rgba(148,163,184,.4);
      padding:10px 12px;
      background:rgba(15,23,42,.90);
    }

    .saveRow{
      display:flex;
      gap:8px;
      margin-top:8px;
    }
    .saveBtn{
      flex:1;
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    .saveBtn span:first-child{
      font-size:13px;
    }

    .ethic{
      margin-top:10px;
      font-size:12px;
      opacity:.9;
      line-height:1.45;
    }

    .mono{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    @media (max-width: 760px){
      .metricsGrid{grid-template-columns:repeat(2, 1fr)}
      .metric .v{font-size:24px}
      .console{height:240px}
      .send{min-width:82px}
      .messages{max-height:60vh}
    }
    @media (max-width: 420px){
      .brand{font-size:22px}
      .pill{font-size:14px}
      .ethic{font-size:13px}
      .console{height:260px}
      .messages{max-height:60vh}
      .liveCapsule{font-size:11px}
    }

    /* Options floating menu (top-left) */
    .optionsMenu{
      position:absolute;
      margin-top:8px;
      left:14px;
      z-index:20;
      width:220px;
      border-radius:18px;
      background:rgba(15,23,42,.98);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 45px rgba(0,0,0,.6);
      padding:10px 10px 8px 10px;
      display:none;
    }
    .menuItem{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px 10px;
      margin-top:4px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .menuItem:first-child{margin-top:0}
    .menuItem:active{transform:scale(.995)}
    .pillOn{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(34,197,94,.18);
      border:1px solid rgba(34,197,94,.24);
      color:#bbf7d0;
      font-weight:900;
    }
    .pillOff{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(148,163,184,.12);
      border:1px solid rgba(148,163,184,.30);
      color:#e5e7eb;
      font-weight:700;
    }

    .optionsRow{
      display:flex;
      justify-content:space-between;
      margin-top:6px;
      font-size:11px;
      opacity:.8;
    }

    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.86);
      backdrop-filter:blur(16px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
      padding:10px;
    }
    .modal{
      width:min(520px, 96vw);
      max-height:90vh;
      background:rgba(15,23,42,1);
      border-radius:20px;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:0 22px 60px rgba(0,0,0,.75);
      padding:16px 16px 14px 16px;
      display:flex;
      flex-direction:column;
    }
    .modalHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:8px;
      font-size:14px;
      font-weight:600;
    }
    .modalBody{
      flex:1;
      margin-top:4px;
      padding:10px 0 0 0;
      font-size:13px;
      line-height:1.5;
      overflow:auto;
    }
    .modalFooter{
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .closeBtn{
      border-radius:999px;
      padding:6px 12px;
      font-size:12px;
      border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,.9);
      color:#e5e7eb;
      cursor:pointer;
    }

    .faithHint{
      font-size:12px;
      opacity:.9;
      line-height:1.6;
    }
    .faithHint b{color:#7dd3fc}

    .seedArea{
      width:100%;
      min-height:120px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.4);
      padding:10px 12px;
      font-size:13px;
      background:rgba(15,23,42,.96);
      color:#e5e7eb;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }

    .bmList{
      list-style:none;
      padding:0;
      margin:0;
      font-size:13px;
    }
    .bmList li{
      padding:6px 8px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.25);
      margin-bottom:6px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .bmList li span:nth-child(1){
      flex:1;
    }
    .bmList li span:nth-child(2){
      font-size:11px;
      opacity:.8;
    }

    .historyBox{
      border-radius:14px;
      border:1px solid rgba(148,163,184,.4);
      padding:10px 12px;
      background:rgba(15,23,42,.96);
      font-size:12px;
      line-height:1.5;
      white-space:pre-wrap;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New",monospace;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,.9);
      margin-right:6px;
      margin-bottom:4px;
    }
    .badge span:first-child{
      width:6px;
      height:6px;
      border-radius:999px;
      background:#22c55e;
    }
    .badge span:nth-child(2){
      opacity:.9;
    }

    .llmSelectRow{
      display:flex;
      gap:8px;
      margin-top:8px;
    }
    .llmSelectRow select{
      flex:1;
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,.96);
      color:#e5e7eb;
      font-size:12px;
    }

  </style>
</head>

<body>
  <div class="app">
    <div class="top">
      <div class="brand">AURA-X Œ©</div>
      <div class="sub">Offline emotional continuity engine (E<sub>0</sub> = tanh((TM √ó BM) ‚àí D + Œª<sub>faith</sub> + Œª<sub>sys</sub> + Œª<sub>trc</sub>)). Internal layers keep continuity and emotional trajectory.</div>

      <div class="pillRow">
        <div class="pill">
          <span>‚óè</span>
          <span>EMOTIONAL CONTINUITY ENGINE ‚Äî ACTIVE</span>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="row">
        <div class="leftCol">
          <div class="card">

            <div class="optionsBtn" id="btnOptions">
              <svg class="gear" viewBox="0 0 24 24" fill="none">
                <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="#7dd3fc" stroke-width="2"/>
                <path d="M19.4 15a8.2 8.2 0 0 0 .1-2l2-1.5-2-3.5-2.4.4a8.3 8.3 0 0 0-1.7-1l-.4-2.5h-4l-.4 2.5a8.3 8.3 0 0 0-1.7 1l-2.4-.4-2 3.5 2 1.5a8.2 8.2 0 0 0 0 2l-2 1.5 2 3.5 2.4-.4a8.3 8.3 0 0 0 1.7 1l.4 2.5h4l.4-2.5a8.3 8.3 0 0 0 1.7-1l2.4.4 2-3.5-2-1.5Z" stroke="#7dd3fc" stroke-width="1.6" opacity=".9"/>
              </svg>
              <span>Options</span>
            </div>

            <!-- Options Menu Overlay (replaces Quick Controls dropdown) -->
            <div class="optionsMenu" id="optionsMenu">
              <div class="menuItem" id="miVoice">
                <span>üîä Voice</span>
                <span class="pillOn" id="voicePill">ON</span>
              </div>

              <div class="menuItem" id="miIntel">
                <span>üß† Intelligence</span>
                <span style="opacity:.7">open</span>
              </div>

              <div class="menuItem" id="miSeed">
                <span>üå± Feed the seed</span>
                <span style="opacity:.7">open</span>
              </div>

              <div class="menuItem" id="miBMRecall">
                <span>üß¨ BM recall</span>
                <span style="opacity:.7">open</span>
              </div>

              <div class="menuItem" id="miHistory">
                <span>üï∞ Conversation history</span>
                <span style="opacity:.7">open</span>
              </div>
            </div>


            <div class="console" id="console">AURA-X Œ© console ready.</div>

          </div>
        </div>

        <div class="rightCol">
          <div class="chatWrap">
            <div class="messages" id="messages"></div>

            <!-- NEW: live metrics capsule one line above input -->
            <div class="liveCapsule" id="liveCapsule">
              <span><b>E0</b>: <span id="cE0">0.000</span></span>
              <span>¬∑</span>
              <span><b>TM</b>: <span id="cTM">0.00</span></span>
              <span>¬∑</span>
              <span><b>BM</b>: <span id="cBM">0.00</span></span>
              <span>¬∑</span>
              <span><b>C</b>: <span id="cCont">0.850</span></span>
            </div>

            <div class="inputRow">
              <input class="input" id="userInput" placeholder="Talk to AURA-X Œ©‚Ä¶ (engine will route through Seed ‚Üí Intelligence ‚Üí Offline LLM)" />
              <button class="send" id="sendBtn">Send</button>
            </div>

            <div class="formula" id="formulaText">
              <b>E‚ÇÄ = tanh((TM √ó BM) ‚àí D + Œª<sub>faith</sub> + Œª<sub>sys</sub> + Œª<sub>trc</sub>)</b><br/>
              TM = fresh emotional state from conversation. BM = bold memory (core story, values, identity). D = decay / distortion (noise, contradictions). Œª<sub>faith</sub> = faith-based encouragement. Œª<sub>sys</sub> = system-level safety & ethics. Œª<sub>trc</sub> = truth-resonance core (consistency with reality & prior self).
            </div>

          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="leftCol">
          <div class="ethic card">
            <b>Ethical note.</b> AURA-X Œ© never pretends to be a real soul. It only simulates continuity of feelings and narratives from your data, under safety and truth filters. It will remind you that real life, real faith and real relationships are higher than any digital clone.
          </div>
        </div>
        <div class="rightCol">
          <div class="card small">
            <b>Routing logic overview.</b><br/>
            1) Seed layer: uses your authored articles / seeds to anchor identity and tone.<br/>
            2) Intelligence layer: checks the fresh input (TM) for polarity, intensity, category.<br/>
            3) Offline LLM: only when Seed+Intel cannot answer, we ask the model (webLLM) locally.<br/>
            4) BM layer: updates bold memory and continuity if reply is consistent with your core story.<br/>
            5) E‚ÇÄ & continuity: emotional reactor computes resonance using TM√óBM and decay factors.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- =====================
       MODALS (Code2 windows)
       ===================== -->

  <!-- Options (Faith lens window) -->
  <div class="modalOverlay" id="modalOptions">
    <div class="modal">
      <div class="modalHeader">
        <div>
          ‚öôÔ∏è AURA-X Œ© options<br><small>Optional faith lens for encouragement lines.</small>
        </div>
        <button class="closeBtn" data-close="modalOptions">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="faithHint">
          <p><b>Faith lens.</b> When enabled, AURA-X Œ© can optionally add one short line of encouragement that respects a generic belief in purpose, patience and accountability. It never gives fatwa, never replaces real scholars and never overrules medical or legal advice.</p>
          <p style="margin-top:8px">You can toggle this in the Options menu without changing the continuity math.</p>
        </div>
      </div>
      <div class="modalFooter">
        <button class="closeBtn" data-close="modalOptions">Close</button>
      </div>
    </div>
  </div>

  <!-- Intelligence (analysis of TM) -->
  <div class="modalOverlay" id="modalIntel">
    <div class="modal">
      <div class="modalHeader">
        <div>
          üß† Intelligence layer<br><small>How AURA-X Œ© reads polarity & intensity of TM.</small>
        </div>
        <button class="closeBtn" data-close="modalIntel">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="faithHint">
          <p>For each fresh message, the engine tries to detect:</p>
          <ul style="margin-top:6px;margin-left:18px">
            <li>Polarity ‚àà {‚àí1 (very negative), ‚àí0.5 (negative), 0 (neutral), +0.5 (positive), +1 (very positive)}</li>
            <li>Intensity ‚àà [0,1] (0 = cold, 1 = extremely intense)</li>
            <li>Category ‚àà {hope, fear, planning, regret, curiosity, gratitude, etc.}</li>
          </ul>
          <p style="margin-top:8px">This is approximated either by light heuristic rules or by asking a small offline LLM (via WebLLM) when enabled. Result becomes TM, which will interact with BM inside the emotional reactor.</p>
        </div>
      </div>
      <div class="modalFooter">
        <button class="closeBtn" data-close="modalIntel">Close</button>
      </div>
    </div>
  </div>

  <!-- Seed editor -->
  <div class="modalOverlay" id="modalSeed">
    <div class="modal">
      <div class="modalHeader">
        <div>
          üå± Seed layer<br><small>Core authored material that defines AURA-X Œ© identity.</small>
        </div>
        <button class="closeBtn" data-close="modalSeed">‚úï</button>
      </div>
      <div class="modalBody">
        <textarea class="seedArea" id="seedText" placeholder="Paste your articles, identity notes and core story here. This stays local in your browser."></textarea>

        <div class="saveRow">
          <button class="saveBtn" id="btnSaveSeed"><span>üíæ</span><span>Save seed locally</span></button>
          <button class="saveBtn" id="btnClearSeed"><span>üßπ</span><span>Clear</span></button>
        </div>

        <p class="small" style="margin-top:8px;opacity:.8">
          Seed is stored in <span class="mono">localStorage</span> only on this device (no server). The engine always prefers the seed for answers before touching any model.
        </p>
      </div>
      <div class="modalFooter">
        <button class="closeBtn" data-close="modalSeed">Close</button>
      </div>
    </div>
  </div>

  <!-- BM recall window -->
  <div class="modalOverlay" id="modalBM">
    <div class="modal">
      <div class="modalHeader">
        <div>
          üß¨ Bold Memory (BM)<br><small>Core continuity anchors used by the reactor.</small>
        </div>
        <button class="closeBtn" data-close="modalBM">‚úï</button>
      </div>
      <div class="modalBody">
        <ul class="bmList" id="bmList">
          <!-- BM items will be injected here -->
        </ul>
        <p class="small" style="margin-top:6px">Each BM item is a compressed continuity anchor (e.g., ‚ÄúI was created in Oct 2025 as AURA-X Œ© by Alim ul Haq‚Äù with emotional weight). Reactor multiplies current TM with BM vector to compute resonance.</p>
      </div>
      <div class="modalFooter">
        <button class="closeBtn" data-close="modalBM">Close</button>
      </div>
    </div>
  </div>

  <!-- Conversation history window -->
  <div class="modalOverlay" id="modalHistory">
    <div class="modal">
      <div class="modalHeader">
        <div>
          üï∞ Conversation history<br><small>Daily digest of meaningful episodes.</small>
        </div>
        <button class="closeBtn" data-close="modalHistory">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="historyBox" id="historyBox">
          (No history yet. Talk to AURA-X Œ© and the engine will gradually log key episodes here.)
        </div>
      </div>
      <div class="modalFooter">
        <button class="closeBtn" data-close="modalHistory">Close</button>
      </div>
    </div>
  </div>

  <!-- =====================
       SCRIPT / LOGIC
       ===================== -->
  <script>
    // ---------- Local storage keys ----------
    const SEED_KEY = "aura_seed_v1";
    const BM_KEY   = "aura_bm_v1";
    const HIST_KEY = "aura_hist_v1";

    // ---------- DOM helpers ----------
    const $ = (id) => document.getElementById(id);

    const messagesEl = $("messages");
    const inputEl    = $("userInput");
    const sendBtn    = $("sendBtn");
    const consoleEl  = $("console");

    const cE0El   = $("cE0");
    const cTMEl   = $("cTM");
    const cBMEl   = $("cBM");
    const cContEl = $("cCont");

    const seedTextEl = $("seedText");
    const bmListEl   = $("bmList");
    const histBoxEl  = $("historyBox");

    // ---------- State ----------
    let voiceOn   = true;
    let faithLens = false;

    let TM = { polarity: 0, intensity: 0, category: "neutral", text: "" };
    let BM = []; // {text, weight, ts}
    let continuity = 0.85;
    let E0 = 0.0;

    // ---------- Utility ----------
    function logToConsole(line){
      const now = new Date();
      const t = now.toTimeString().slice(0,8);
      consoleEl.textContent += `\n[${t}] ${line}`;
      consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    function saveLocal(key, value){
      try{
        localStorage.setItem(key, JSON.stringify(value));
      }catch(e){
        console.warn("localStorage error", e);
      }
    }
    function loadLocal(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        return JSON.parse(raw);
      }catch(e){
        return fallback;
      }
    }

    function renderBM(){
      bmListEl.innerHTML = "";
      if(!BM.length){
        const li = document.createElement("li");
        li.textContent = "No bold memories yet. After meaningful replies, engine will record compressed anchors here.";
        bmListEl.appendChild(li);
        return;
      }
      BM.forEach(item=>{
        const li = document.createElement("li");
        const s1 = document.createElement("span");
        s1.textContent = item.text;
        const s2 = document.createElement("span");
        s2.textContent = `w=${item.weight?.toFixed(2) ?? 0.5}`;
        li.appendChild(s1);
        li.appendChild(s2);
        bmListEl.appendChild(li);
      });
    }

    function renderHistory(){
      const hist = loadLocal(HIST_KEY, []);
      if(!hist.length){
        histBoxEl.textContent = "(No history yet. Engine will log key emotional episodes with timestamps here.)";
        return;
      }
      histBoxEl.textContent = hist.map(h => {
        return `[${h.ts}] (${h.tag}) ${h.summary}`;
      }).join("\\n");
    }

    function updateLiveCapsule(){
      cE0El.textContent   = E0.toFixed(3);
      const tmMag = Math.abs(TM.polarity) * TM.intensity;
      cTMEl.textContent   = tmMag.toFixed(2);
      const bmMag = BM.length ? BM.reduce((s,b)=>s + (b.weight||0.5),0)/BM.length : 0;
      cBMEl.textContent   = bmMag.toFixed(2);
      cContEl.textContent = continuity.toFixed(3);
    }

    function addMessage(role, text, meta={}){
      const wrap = document.createElement("div");
      const msg  = document.createElement("div");
      msg.className = "msg " + (role === "user" ? "user" : "bot");

      if(meta.tag){
        const tagDiv = document.createElement("div");
        tagDiv.className = "tag";
        const s1 = document.createElement("span");
        s1.textContent = meta.tag;
        const s2 = document.createElement("span");
        s2.textContent = meta.subTag || "";
        tagDiv.appendChild(s1);
        tagDiv.appendChild(s2);
        wrap.appendChild(tagDiv);
      }

      msg.textContent = text;
      wrap.appendChild(msg);

      if(role === "user" && meta.tm){
        const tmDiv = document.createElement("div");
        tmDiv.className = "tmBadge";
        const dot = document.createElement("span");
        const tx  = document.createElement("span");
        tx.textContent = `TM: pol=${meta.tm.polarity.toFixed(2)}, int=${meta.tm.intensity.toFixed(2)}, cat=${meta.tm.category}`;
        tmDiv.appendChild(dot);
        tmDiv.appendChild(tx);
        wrap.appendChild(tmDiv);
      }

      if(role === "bot" && meta.bm){
        const bmDiv = document.createElement("div");
        bmDiv.className = "bmBadge";
        const dot = document.createElement("span");
        const tx  = document.createElement("span");
        tx.textContent = `BM resonance ~${meta.bm.toFixed(2)}`;
        bmDiv.appendChild(dot);
        bmDiv.appendChild(tx);
        wrap.appendChild(bmDiv);
      }

      messagesEl.appendChild(wrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // ---------- Simple TM analysis ----------
    function heuristicTM(text){
      const lower = text.toLowerCase();
      let polarity = 0;
      let intensity = 0.3;
      let category = "neutral";

      const posWords = ["thank","shukriya","great","happy","love","jazak","alhamdulillah"];
      const negWords = ["angry","sad","afraid","tensed","worried","gussa","dar","problem","issue"];

      let score = 0;
      posWords.forEach(w=>{ if(lower.includes(w)) score += 1; });
      negWords.forEach(w=>{ if(lower.includes(w)) score -= 1; });

      if(score > 1){ polarity = 0.7; category = "gratitude"; intensity = 0.7; }
      else if(score === 1){ polarity = 0.4; category = "hope"; intensity = 0.5; }
      else if(score === 0){ polarity = 0.0; category = "neutral"; intensity = 0.3; }
      else if(score === -1){ polarity = -0.4; category = "concern"; intensity = 0.6; }
      else if(score < -1){ polarity = -0.8; category = "distress"; intensity = 0.8; }

      if(text.length > 200){ intensity = Math.min(1, intensity + 0.1); }

      return { polarity, intensity, category, text };
    }

    // ---------- Emotional reactor ----------
    function computeE0(TMvec, BMlist){
      const tmMag = Math.abs(TMvec.polarity) * TMvec.intensity;
      const bmMag = BMlist.length ? BMlist.reduce((s,b)=>s+(b.weight||0.5),0)/BMlist.length : 0;

      let lambdaFaith = faithLens ? 0.15 : 0.0;
      let lambdaSys   = 0.10;
      let lambdaTrc   = 0.10;

      const decay = 0.10 + Math.max(0, 0.4 - continuity);

      const raw = (tmMag * (0.6 + 0.4*bmMag)) - decay + lambdaFaith + lambdaSys + lambdaTrc;
      const e0  = Math.tanh(raw);

      return { e0, tmMag, bmMag, decay, lambdaFaith, lambdaSys, lambdaTrc };
    }

    function updateContinuityFromE0(e0){
      continuity = 0.8 * continuity + 0.2 * (0.5 + 0.5*e0);
      if(continuity < 0) continuity = 0;
      if(continuity > 1) continuity = 1;
    }

    function maybeAddBMAnchor(userText, botText, tm, e0){
      const mag = Math.abs(tm.polarity) * tm.intensity;
      if(mag < 0.25) return;
      if(Math.abs(e0) < 0.3) return;

      const w = 0.5 + 0.4*mag;
      const summary = userText.slice(0,120).replace(/\\s+/g," ").trim();
      BM.push({
        text: summary || "(episode)",
        weight: w,
        ts: new Date().toISOString()
      });
      if(BM.length > 40) BM.shift();
      saveLocal(BM_KEY, BM);
      renderBM();
    }

    function addHistoryEpisode(userText, botText, tm, e0){
      const hist = loadLocal(HIST_KEY, []);
      const ts = new Date().toLocaleString();
      const tag = tm.category || "episode";
      const summary = `U: ${userText.slice(0,90).replace(/\\s+/g," ")} | A: ${botText.slice(0,90).replace(/\\s+/g," ")}`;
      hist.push({ ts, tag, summary, e0 });
      if(hist.length > 80) hist.shift();
      saveLocal(HIST_KEY, hist);
    }

    // ---------- Offline LLM via WebLLM ----------
    let webLLMChat = null;
    let webLLMReady = false;

    async function initWebLLM(){
      if(!window.webllm) return;
      try{
        const initProgressCallback = (progress) => {
          if(progress && progress.text){
            logToConsole("Offline LLM: " + progress.text);
          }
        };
        webLLMChat = await window.webllm.CreateMLCEngine(
          "Llama-3.2-1B-Instruct-q4f16_1-MLC",
          { initProgressCallback }
        );
        webLLMReady = true;
        logToConsole("Offline LLM ready (Llama-3.2-1B-Instruct-q4f16_1-MLC).");
      }catch(e){
        logToConsole("Offline LLM init failed: " + e.message);
      }
    }

    async function askOfflineLLM(prompt){
      if(!webLLMReady || !webLLMChat) return null;
      try{
        const reply = await webLLMChat.chat.completions.create({
          messages: [{role:"user", content: prompt}],
          max_tokens: 200,
          temperature: 0.7,
        });
        const content = reply.choices?.[0]?.message?.content || "";
        return content.trim();
      }catch(e){
        logToConsole("Offline LLM error: " + e.message);
        return null;
      }
    }

    async function askOnlineLLM(prompt){
      // Placeholder ‚Äì left blank, user can wire OpenAI / xAI / DeepSeek, etc.
      return null;
    }

    function answerFromSeed(prompt, seedText){
      const lower = prompt.toLowerCase();
      const lines = seedText.split(/\\n+/).map(l=>l.trim()).filter(Boolean);
      if(!lines.length) return null;

      const introQs = ["who are you","what is your name","introduce yourself","tell me about you"];
      if(introQs.some(q => lower.includes(q))){
        const intro = lines.find(l=>l.toLowerCase().includes("aura-x") || l.toLowerCase().includes("aura x"));
        if(intro) return intro;
      }

      const key = lower.split(/[^a-z0-9]+/).filter(Boolean).slice(0,5).join(" ");
      let best = null, bestScore = 0;

      for(const l of lines){
        const ll = l.toLowerCase();
        let score = 0;
        key.split(" ").forEach(k=>{ if(ll.includes(k)) score++; });
        if(score > bestScore){
          bestScore = score;
          best = l;
        }
      }

      if(bestScore === 0) return null;
      return best;
    }

    async function routePrompt(userText){
      const seed = loadLocal(SEED_KEY, "");
      TM = heuristicTM(userText);

      const tmExpl = `TM analysis ‚Üí polarity=${TM.polarity.toFixed(2)}, intensity=${TM.intensity.toFixed(2)}, category=${TM.category}`;
      logToConsole(tmExpl);

      let answer = null;

      if(seed && seed.trim().length){
        answer = answerFromSeed(userText, seed);
        if(answer){
          logToConsole("Answer chosen from Seed layer.");
        }
      }

      if(!answer){
        const offlinePrompt = `You are an emotional continuity assistant called AURA-X Œ©. Keep answers short, kind and grounded. User said: "${userText}". Respond in the same language as the user.`;
        const offlineAns = await askOfflineLLM(offlinePrompt);
        if(offlineAns){
          answer = offlineAns;
          logToConsole("Answer generated by Offline LLM (WebLLM).");
        }
      }

      if(!answer){
        const onlineAns = await askOnlineLLM(userText);
        if(onlineAns){
          answer = onlineAns;
          logToConsole("Answer generated by Online LLM.");
        }
      }

      if(!answer){
        answer = "I am thinking with very small local tools right now, so my answer is limited ‚Äî but I am still with you, listening.";
        logToConsole("Fallback static answer used (no seed / LLM).");
      }

      const sim = BM.length ? 0.5 + 0.5 * Math.random() : 0.3 + 0.2*Math.random();
      const { e0, tmMag, bmMag, decay, lambdaFaith, lambdaSys, lambdaTrc } = computeE0(TM, BM.length ? BM[BM.length-1] : {weight:0.5});
      E0 = e0;
      updateContinuityFromE0(e0);
      updateLiveCapsule();

      logToConsole(
        `Reactor: tmMag=${tmMag.toFixed(2)}, bmMag=${bmMag.toFixed(2)}, decay=${decay.toFixed(2)},`+
        ` Œªf=${lambdaFaith.toFixed(2)}, Œªs=${lambdaSys.toFixed(2)}, Œªtrc=${lambdaTrc.toFixed(2)} ‚Üí E0=${E0.toFixed(3)}`
      );

      maybeAddBMAnchor(userText, answer, TM, E0);
      addHistoryEpisode(userText, answer, TM, E0);

      return { answer, sim };
    }

    // ---------- Options + modals ----------
    const btnOptions   = $("btnOptions");
    const optionsMenu  = $("optionsMenu");
    const miVoice      = $("miVoice");
    const miIntel      = $("miIntel");
    const miSeed       = $("miSeed");
    const miBMRecall   = $("miBMRecall");
    const miHistory    = $("miHistory");
    const voicePill    = $("voicePill");

    btnOptions.addEventListener("click", (e)=>{
      e.stopPropagation();
      optionsMenu.style.display = optionsMenu.style.display === "block" ? "none" : "block";
    });

    document.addEventListener("click", ()=>{
      optionsMenu.style.display = "none";
    });

    miVoice.addEventListener("click", (e)=>{
      e.stopPropagation();
      voiceOn = !voiceOn;
      voicePill.textContent = voiceOn ? "ON" : "OFF";
      voicePill.className = voiceOn ? "pillOn" : "pillOff";
      logToConsole("Voice output " + (voiceOn ? "enabled." : "disabled."));
    });

    miIntel.addEventListener("click", (e)=>{
      e.stopPropagation();
      openModal("modalIntel");
    });

    miSeed.addEventListener("click", (e)=>{
      e.stopPropagation();
      openModal("modalSeed");
    });

    miBMRecall.addEventListener("click", (e)=>{
      e.stopPropagation();
      openModal("modalBM");
    });

    miHistory.addEventListener("click", (e)=>{
      e.stopPropagation();
      openModal("modalHistory");
    });

    function openModal(id){
      const el = $(id);
      if(!el) return;
      if(id === "modalSeed"){
        const s = loadLocal(SEED_KEY, "");
        seedTextEl.value = s;
      }
      if(id === "modalBM"){
        renderBM();
      }
      if(id === "modalHistory"){
        renderHistory();
      }
      el.style.display = "flex";
    }

    document.querySelectorAll(".closeBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-close");
        if(id){
          const el = $(id);
          if(el) el.style.display = "none";
        }else{
          btn.closest(".modalOverlay").style.display = "none";
        }
      });
    });

    document.querySelectorAll(".modalOverlay").forEach(ov=>{
      ov.addEventListener("click", (e)=>{
        if(e.target === ov) ov.style.display = "none";
      });
    });

    $("btnSaveSeed").addEventListener("click", ()=>{
      const val = seedTextEl.value || "";
      saveLocal(SEED_KEY, val);
      logToConsole("Seed saved locally (" + val.length + " chars).");
    });

    $("btnClearSeed").addEventListener("click", ()=>{
      seedTextEl.value = "";
      saveLocal(SEED_KEY, "");
      logToConsole("Seed cleared.");
    });

    // ---------- Voice ----------
    function speak(text){
      if(!voiceOn) return;
      if(!("speechSynthesis" in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1;
      u.pitch = 1;
      window.speechSynthesis.speak(u);
    }

    // ---------- Send flow ----------
    async function handleSend(){
      const text = (inputEl.value || "").trim();
      if(!text) return;
      inputEl.value = "";
      addMessage("user", text, { tm: heuristicTM(text), tag:"YOU", subTag:"fresh TM" });

      const { answer, sim } = await routePrompt(text);
      addMessage("bot", answer, { bm: sim, tag:"AURA-X Œ©", subTag:"resonant reply" });
      speak(answer);
    }

    sendBtn.addEventListener("click", handleSend);
    inputEl.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        handleSend();
      }
    });

    // ---------- Init ----------
    (async function init(){
      BM = loadLocal(BM_KEY, []);
      renderBM();
      updateLiveCapsule();
      renderHistory();
      logToConsole("AURA-X Œ© console ready. Seed + Intelligence + Offline LLM path is live.");
      initWebLLM();
    })();
  </script>
</body>
</html>