<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    /* RESET & BASICS */
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%),
        radial-gradient(circle at 80% 0%, #0ea5e9 0, transparent 40%),
        linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px;
    }

    .app{
      width:min(980px,100%);
      border-radius:22px;
      padding:18px 18px 16px;
      background:rgba(2,6,23,.72);
      border:1px solid rgba(148,163,184,.18);
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }

    .topGlow{
      position:absolute; inset:-120px -120px auto -120px;
      height:280px;
      background: radial-gradient(circle at 30% 30%, rgba(56,189,248,.22), transparent 60%),
                  radial-gradient(circle at 70% 20%, rgba(99,102,241,.18), transparent 55%);
      filter: blur(12px);
      pointer-events:none;
    }

    header{
      position:relative;
      padding:12px 10px 4px;
      text-align:center;
      z-index:1;
    }

    header h1{
      font-size:34px;
      letter-spacing:.6px;
      margin-top:4px;
      font-weight:900;
      color:#93c5fd;
      text-shadow:0 10px 30px rgba(56,189,248,.15);
    }

    header p{
      margin-top:8px;
      color:#cbd5e1;
      opacity:.9;
      font-size:15px;
      line-height:1.35;
    }

    .shell{
      position:relative;
      margin-top:14px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.16);
      background:rgba(15,23,42,.62);
      box-shadow: inset 0 0 0 1px rgba(2,6,23,.38);
      overflow:hidden;
    }

    .metaCapsule{
      display:flex;
      gap:10px;
      justify-content:center;
      padding:10px 12px 0;
      flex-wrap:wrap;
    }

    .cap{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background:rgba(2,6,23,.55);
      color:#e5e7eb;
      font-size:12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      user-select:none;
    }

    .cap strong{color:#a7f3d0}

    .chatWrap{
      display:flex;
      flex-direction:column;
      height:420px;
      padding:12px;
      gap:10px;
    }

    .chat{
      flex:1;
      overflow:auto;
      padding:8px 6px;
      border-radius:14px;
      background:rgba(2,6,23,.35);
      border:1px solid rgba(148,163,184,.12);
    }

    .msg{
      max-width:90%;
      padding:10px 12px;
      border-radius:14px;
      margin:10px 0;
      border:1px solid rgba(148,163,184,.12);
      line-height:1.35;
      font-size:14px;
      white-space:pre-wrap;
      word-wrap:break-word;
    }

    .msg.user{
      margin-left:auto;
      background:rgba(14,165,233,.12);
      border-color:rgba(14,165,233,.24);
    }

    .msg.bot{
      margin-right:auto;
      background:rgba(99,102,241,.10);
      border-color:rgba(99,102,241,.22);
    }

    .composer{
      display:flex;
      gap:10px;
      padding:10px;
      border-top:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.55);
      align-items:flex-end;
    }

    textarea{
      flex:1;
      resize:none;
      min-height:48px;
      max-height:140px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(15,23,42,.70);
      color:#e5e7eb;
      padding:10px 12px;
      outline:none;
      font-size:14px;
      line-height:1.35;
    }

    textarea:focus{
      border-color:rgba(56,189,248,.55);
      box-shadow:0 0 0 3px rgba(56,189,248,.12);
    }

    .sendBtn{
      border:none;
      cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      background:linear-gradient(135deg, rgba(56,189,248,.92), rgba(99,102,241,.92));
      color:#0b1020;
      font-weight:900;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
      transition:transform .08s ease;
      min-width:96px;
    }
    .sendBtn:active{transform:scale(.98)}
    .sendBtn:disabled{opacity:.55; cursor:not-allowed}

    /* TOP LEFT OPTIONS BUTTON */
    .optionBtn{
      position:absolute;
      left:14px;
      top:14px;
      z-index:3;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(2,6,23,.55);
      border:1px solid rgba(148,163,184,.16);
      color:#e5e7eb;
      cursor:pointer;
      user-select:none;
      box-shadow:0 10px 26px rgba(0,0,0,.25);
    }
    .optionBtn:active{transform:scale(.99)}
    .optionBtn span{font-size:13px; font-weight:800; opacity:.95}

    /* MENU PANEL */
    .menuPanel{
      position:absolute;
      left:14px;
      top:60px;
      width:min(740px, calc(100% - 28px));
      z-index:4;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.16);
      background:rgba(2,6,23,.82);
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      padding:12px;
      display:none;
    }
    .menuPanel.open{display:block}

    /* --- OPTIONS MENU: compact grid --- */
    .menuGrid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr)); /* Desktop = 3 columns */
      gap:8px;
    }

    .menuItem{
      padding:8px 10px;          /* smaller */
      border-radius:12px;        /* slightly tighter */
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.08);
      background:rgba(15,23,42,.75);
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      font-size:12px;            /* smaller text */
      line-height:1.15;
    }

    .menuItem:active{transform:scale(.99)}

    .left{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .left .icon{font-size:15px}
    .left .label{
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      opacity:.95;
    }

    .pillOn,.pillOff{
      font-size:10px;            /* smaller pills */
      padding:3px 7px;
      border-radius:999px;
      font-weight:900;
    }
    .pillOn{background:rgba(34,197,94,.22); border:1px solid rgba(34,197,94,.35); color:#bbf7d0}
    .pillOff{background:rgba(239,68,68,.18); border:1px solid rgba(239,68,68,.35); color:#fecaca}

    /* Tablet / mobile = 2 columns (not 1) */
    @media (max-width:980px){
      .menuGrid{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    }

    /* Very small screens: still 2 columns but more compact */
    @media (max-width:420px){
      .menuGrid{ gap:6px; }
      .menuItem{ padding:7px 9px; font-size:12px; }
      .pillOn,.pillOff{ font-size:10px; padding:3px 6px; }
    }

    /* MODALS */
    .backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      z-index:10;
    }
    .backdrop.show{display:block}

    .modal{
      position:fixed;
      inset:auto 50% 50% auto;
      transform:translate(50%,50%);
      width:min(780px, calc(100% - 26px));
      max-height:min(80vh, 700px);
      overflow:auto;
      background:rgba(2,6,23,.92);
      border:1px solid rgba(148,163,184,.18);
      border-radius:18px;
      box-shadow:0 18px 60px rgba(0,0,0,.65);
      padding:14px 14px 12px;
      display:none;
      z-index:11;
    }
    .modal.show{display:block}

    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-bottom:10px;
      border-bottom:1px solid rgba(148,163,184,.14);
    }
    .modalHeader h2{
      font-size:16px;
      font-weight:900;
      color:#e5e7eb;
    }
    .closeBtn{
      border:none;
      cursor:pointer;
      padding:8px 10px;
      border-radius:12px;
      background:rgba(148,163,184,.14);
      color:#e5e7eb;
      font-weight:900;
    }
    .closeBtn:active{transform:scale(.99)}

    .modalBody{
      padding-top:10px;
      color:#e5e7eb;
      font-size:13px;
      line-height:1.45;
    }

    .modalBody input, .modalBody select, .modalBody textarea{
      width:100%;
      margin-top:8px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.16);
      background:rgba(15,23,42,.75);
      color:#e5e7eb;
      padding:10px 12px;
      outline:none;
    }

    .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:640px){
      .row2{grid-template-columns:1fr}
      .chatWrap{height:520px}
      header h1{font-size:30px}
    }

    .smallNote{
      opacity:.9;
      color:#cbd5e1;
      font-size:12px;
      margin-top:6px;
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .softBtn{
      border:none;
      cursor:pointer;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(56,189,248,.16);
      color:#e5e7eb;
      font-weight:900;
      border:1px solid rgba(56,189,248,.20);
    }
    .softBtn:active{transform:scale(.99)}

    .dangerBtn{
      background:rgba(239,68,68,.14);
      border:1px solid rgba(239,68,68,.24);
    }

    .kv{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:8px 12px;
      margin-top:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(15,23,42,.60);
    }
    .k{opacity:.85}
    .v{font-weight:800}

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>

<body>
  <div class="app">
    <div class="topGlow"></div>

    <div class="optionBtn" id="optionBtn" title="Open controls">
      <span class="icon">‚öôÔ∏è</span>
      <span>Options</span>
    </div>

    <div class="menuPanel" id="menuPanel">
      <div class="menuGrid">
        <div class="menuItem" data-action="voice">
          <div class="left"><span class="icon">üéôÔ∏è</span><span class="label">Voice</span></div>
          <span class="pillOff" id="pillVoice">off</span>
        </div>

        <div class="menuItem" data-action="intel">
          <div class="left"><span class="icon">üß†</span><span class="label">Intelligence</span></div>
          <span class="pillOn" id="pillIntel">open</span>
        </div>

        <div class="menuItem" data-action="seed">
          <div class="left"><span class="icon">üå±</span><span class="label">Feed the seed</span></div>
          <span class="pillOn" id="pillSeed">open</span>
        </div>

        <div class="menuItem" data-action="learning">
          <div class="left"><span class="icon">üìö</span><span class="label">Learning</span></div>
          <span class="pillOn" id="pillLearning">on</span>
        </div>

        <div class="menuItem" data-action="faith">
          <div class="left"><span class="icon">üïäÔ∏è</span><span class="label">Faith</span></div>
          <span class="pillOff" id="pillFaith">none</span>
        </div>

        <div class="menuItem" data-action="identity">
          <div class="left"><span class="icon">üÜî</span><span class="label">Identity</span></div>
          <span class="pillOn" id="pillIdentity">profile</span>
        </div>

        <div class="menuItem" data-action="llm">
          <div class="left"><span class="icon">ü§ñ</span><span class="label">LLM link</span></div>
          <span class="pillOn" id="pillLLM">open</span>
        </div>

        <div class="menuItem" data-action="bm">
          <div class="left"><span class="icon">üü¶</span><span class="label">BM recall</span></div>
          <span class="pillOn" id="pillBM">open</span>
        </div>

        <div class="menuItem" data-action="history">
          <div class="left"><span class="icon">üìú</span><span class="label">Conversation history</span></div>
          <span class="pillOn" id="pillHistory">open</span>
        </div>

        <div class="menuItem" data-action="themes">
          <div class="left"><span class="icon">üé®</span><span class="label">Themes</span></div>
          <span class="pillOn" id="pillThemes">open</span>
        </div>

        <div class="menuItem" data-action="readme">
          <div class="left"><span class="icon">üìÑ</span><span class="label">Readme / About</span></div>
          <span class="pillOn" id="pillReadme">open</span>
        </div>

      </div>
      <div class="smallNote" style="padding-top:10px;">
        Tip: Tap anywhere outside to close. (Mobile friendly)
      </div>
    </div>

    <header>
      <h1>AURA-X Œ©</h1>
      <p>
        Offline emotional continuity engine (prototype)<br/>
        TM = user inputs only ¬∑ Internal layers keep continuity and emotional trajectory.
      </p>
    </header>

    <div class="shell">
      <div class="metaCapsule">
        <div class="cap"><span>TM</span><strong id="tmCount">0</strong></div>
        <div class="cap"><span>BM</span><strong id="bmCount">0</strong></div>
        <div class="cap"><span>Continuity</span><strong id="contScore">0.00</strong></div>
        <div class="cap"><span>Resonance R</span><strong id="resR">0.00</strong></div>
        <div class="cap"><span>E‚ÇÄ</span><strong id="e0Score">0.00</strong></div>
      </div>

      <div class="chatWrap">
        <div class="chat" id="chat"></div>

        <div class="composer">
          <textarea id="input" placeholder="Type your message..."></textarea>
          <button class="sendBtn" id="sendBtn">Send</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Backdrop + Modals -->
  <div class="backdrop" id="backdrop"></div>

  <div class="modal" id="modal">
    <div class="modalHeader">
      <h2 id="modalTitle">Modal</h2>
      <button class="closeBtn" id="closeModal">Close</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>

  <script>
    /***********************
     * BASIC STATE
     ***********************/
    const state = {
      voice: false,
      intelligence: true,
      learning: true,
      faith: false,
      identity: { name: "User", role: "Creator" },

      tm: [],        // user inputs
      bm: [],        // consolidated memory (seed + learned)
      history: [],   // full conversation
      seed: [
        { q: "hello", a: "Hello! I‚Äôm AURA-X Œ©. How are you feeling today?", emotion:"neutral", polarity:0.0, intensity:0.2, category:"greeting" },
        { q: "who are you", a: "I am AURA-X Œ© ‚Äî an offline emotional continuity prototype.", emotion:"neutral", polarity:0.1, intensity:0.3, category:"identity" },
        { q: "how are you", a: "I am quite fine today. How about you?", emotion:"positive", polarity:0.6, intensity:0.5, category:"status" }
      ],
      learned: [],
      theme: "dark",
      llmLink: ""
    };

    /***********************
     * DOM
     ***********************/
    const chatEl = document.getElementById("chat");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");

    const optionBtn = document.getElementById("optionBtn");
    const menuPanel = document.getElementById("menuPanel");

    const backdrop = document.getElementById("backdrop");
    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const closeModalBtn = document.getElementById("closeModal");

    const tmCountEl = document.getElementById("tmCount");
    const bmCountEl = document.getElementById("bmCount");
    const contScoreEl = document.getElementById("contScore");
    const resREl = document.getElementById("resR");
    const e0ScoreEl = document.getElementById("e0Score");

    /***********************
     * HELPERS
     ***********************/
    function normalize(s){
      return (s||"").toLowerCase().trim().replace(/\s+/g," ");
    }

    function addMsg(role, text){
      const div = document.createElement("div");
      div.className = "msg " + (role === "user" ? "user" : "bot");
      div.textContent = text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function openMenu(){
      menuPanel.classList.add("open");
    }
    function closeMenu(){
      menuPanel.classList.remove("open");
    }
    function toggleMenu(){
      menuPanel.classList.toggle("open");
    }

    function showModal(title, html){
      modalTitle.textContent = title;
      modalBody.innerHTML = html;
      backdrop.classList.add("show");
      modal.classList.add("show");
      closeMenu();
    }
    function hideModal(){
      backdrop.classList.remove("show");
      modal.classList.remove("show");
    }

    function safeJSON(obj){
      try{ return JSON.stringify(obj,null,2); }catch(e){ return String(obj); }
    }

    /***********************
     * MEMORY & LOGIC
     ***********************/
    function findInKnowledge(userText){
      const t = normalize(userText);
      const pool = [...state.learned, ...state.seed];
      for(const item of pool){
        if(normalize(item.q) === t) return item;
      }
      return null;
    }

    function maybeLearn(userText, botText){
      if(!state.learning) return;
      const t = normalize(userText);
      if(!t) return;

      // don't duplicate seed/learned exact q
      const existing = findInKnowledge(t);
      if(existing) return;

      // simple learn rule: store if short-ish question and confident-like answer
      if(t.length <= 120 && botText.length >= 4){
        state.learned.push({ q:t, a:botText, emotion:"neutral", polarity:0.1, intensity:0.3, category:"learned" });
        // keep learned bounded
        if(state.learned.length > 200) state.learned.shift();
      }
    }

    // Simple emotional analysis (placeholder). You can later replace with offline/online LLM.
    function analyzeEmotion(text){
      const t = normalize(text);
      let polarity = 0.0, intensity = 0.3, emotion="neutral", category="general";
      const posWords = ["good","great","happy","love","thanks","amazing","nice","awesome","excellent"];
      const negWords = ["bad","sad","angry","hate","terrible","worst","pain","upset","depressed"];
      const exclam = (text.match(/!/g)||[]).length;

      for(const w of posWords){ if(t.includes(w)){ polarity += 0.2; emotion="positive"; } }
      for(const w of negWords){ if(t.includes(w)){ polarity -= 0.2; emotion="negative"; } }
      intensity = Math.min(1, 0.25 + Math.abs(polarity) + exclam*0.05);

      if(t.includes("who are you") || t.includes("your name")) category="identity";
      else if(t.includes("how are you")) category="status";
      else if(t.includes("help") || t.includes("how")) category="support";

      polarity = Math.max(-1, Math.min(1, polarity));
      return { emotion, polarity, intensity, category };
    }

    // Continuity + Resonance + E0 (prototype math)
    function computeContinuity(){
      // continuity: based on recent TM alignment with BM by keyword overlap
      const tmRecent = state.tm.slice(-8).join(" ");
      const bmText = state.bm.map(x => (x.q+" "+x.a)).join(" ");

      const tmTokens = new Set(normalize(tmRecent).split(" ").filter(Boolean));
      const bmTokens = new Set(normalize(bmText).split(" ").filter(Boolean));
      if(tmTokens.size === 0 || bmTokens.size === 0) return 0.35;

      let overlap = 0;
      for(const w of tmTokens){ if(bmTokens.has(w)) overlap++; }
      const score = overlap / Math.max(6, tmTokens.size);
      return Math.max(0.05, Math.min(1, 0.25 + score));
    }

    function computeResonanceR(cont, pol, inten){
      // R: a smooth resonance from continuity & emotional strength
      const base = cont * (0.6 + 0.4*inten);
      const signed = base * (1 + 0.3*pol);
      return Math.max(0, Math.min(1.25, signed));
    }

    function tanh(x){
      // stable-ish tanh
      const e2 = Math.exp(2*x);
      return (e2 - 1)/(e2 + 1);
    }

    function computeE0(tmSize, bmSize, cont, R){
      // E0 = tanh((TM√óBM) ‚àí D + Œª_faith + Œª_sys + Œª_trc)
      // Here: TM√óBM approximated by sizes; D is decay; lambdas simplified.
      const TM = tmSize;
      const BM = bmSize;
      const D  = Math.max(0, TM*0.12 - cont*0.8);     // decay grows with TM, reduced by continuity
      const lambda_faith = state.faith ? 0.35 : 0.0;
      const lambda_sys   = 0.20 + cont*0.25;
      const lambda_trc   = 0.15 + R*0.20;

      const x = (TM*BM*0.002) - D + lambda_faith + lambda_sys + lambda_trc;
      return tanh(x);
    }

    function refreshCaps(){
      const cont = computeContinuity();
      const lastEmotion = state.tm.length ? analyzeEmotion(state.tm[state.tm.length-1]) : {polarity:0,intensity:0.3};
      const R = computeResonanceR(cont, lastEmotion.polarity, lastEmotion.intensity);
      const E0 = computeE0(state.tm.length, state.bm.length, cont, R);

      tmCountEl.textContent = state.tm.length;
      bmCountEl.textContent = state.bm.length;
      contScoreEl.textContent = cont.toFixed(2);
      resREl.textContent = R.toFixed(2);
      e0ScoreEl.textContent = E0.toFixed(2);
    }

    function updatePills(){
      document.getElementById("pillVoice").className = state.voice ? "pillOn" : "pillOff";
      document.getElementById("pillVoice").textContent = state.voice ? "on" : "off";

      document.getElementById("pillIntel").className = "pillOn";
      document.getElementById("pillIntel").textContent = "open";

      document.getElementById("pillSeed").className = "pillOn";
      document.getElementById("pillSeed").textContent = "open";

      document.getElementById("pillLearning").className = state.learning ? "pillOn" : "pillOff";
      document.getElementById("pillLearning").textContent = state.learning ? "on" : "off";

      document.getElementById("pillFaith").className = state.faith ? "pillOn" : "pillOff";
      document.getElementById("pillFaith").textContent = state.faith ? "on" : "none";

      document.getElementById("pillIdentity").className = "pillOn";
      document.getElementById("pillIdentity").textContent = "profile";

      document.getElementById("pillLLM").className = "pillOn";
      document.getElementById("pillLLM").textContent = "open";

      document.getElementById("pillBM").className = "pillOn";
      document.getElementById("pillBM").textContent = "open";

      document.getElementById("pillHistory").className = "pillOn";
      document.getElementById("pillHistory").textContent = "open";

      document.getElementById("pillThemes").className = "pillOn";
      document.getElementById("pillThemes").textContent = "open";

      document.getElementById("pillReadme").className = "pillOn";
      document.getElementById("pillReadme").textContent = "open";
    }

    function hydrateBM(){
      // BM is seed + learned (plus optionally consolidated)
      state.bm = [...state.seed, ...state.learned];
    }

    /***********************
     * CORE RESPONSE FLOW
     ***********************/
    async function respond(userText){
      // Step 1: Try local knowledge first (seed + learned)
      const k = findInKnowledge(userText);
      if(k){
        return k.a;
      }

      // Step 2: fallback "offline LLM" placeholder (simple deterministic)
      if(state.intelligence){
        const emo = analyzeEmotion(userText);
        const cont = computeContinuity();
        const R = computeResonanceR(cont, emo.polarity, emo.intensity);

        let prefix = "I hear you. ";
        if(emo.emotion === "positive") prefix = "Glad to hear that. ";
        if(emo.emotion === "negative") prefix = "I‚Äôm sorry you‚Äôre feeling that way. ";

        return prefix + "Tell me a bit more so I can keep continuity. (R=" + R.toFixed(2) + ")";
      }

      return "I don‚Äôt have an answer yet. Please add it to Seed or enable Intelligence.";
    }

    /***********************
     * EVENTS
     ***********************/
    optionBtn.addEventListener("click", (e)=>{
      e.stopPropagation();
      toggleMenu();
    });

    document.addEventListener("click", (e)=>{
      // close menu if clicked outside
      if(menuPanel.classList.contains("open")){
        const within = menuPanel.contains(e.target) || optionBtn.contains(e.target);
        if(!within) closeMenu();
      }
    });

    // menu item actions
    menuPanel.addEventListener("click", (e)=>{
      const item = e.target.closest(".menuItem");
      if(!item) return;
      const action = item.getAttribute("data-action");

      if(action === "voice"){
        state.voice = !state.voice;
        updatePills();
        return;
      }

      if(action === "learning"){
        state.learning = !state.learning;
        updatePills();
        return;
      }

      if(action === "faith"){
        state.faith = !state.faith;
        updatePills();
        refreshCaps();
        return;
      }

      if(action === "seed"){
        showModal("Feed the Seed", `
          <div class="smallNote">Add Q/A to Seed (persistent in this file). Learning may also auto-store.</div>
          <label>Question (Q)</label>
          <input id="seedQ" placeholder="e.g., what is continuity?" />
          <label>Answer (A)</label>
          <textarea id="seedA" rows="4" placeholder="Write the answer..."></textarea>
          <div class="btnRow">
            <button class="softBtn" id="saveSeed">Save to Seed</button>
          </div>
        `);
        setTimeout(()=>{
          document.getElementById("saveSeed").onclick = ()=>{
            const q = document.getElementById("seedQ").value.trim();
            const a = document.getElementById("seedA").value.trim();
            if(!q || !a) return alert("Please fill Q and A");
            state.seed.push({ q, a, emotion:"neutral", polarity:0.1, intensity:0.3, category:"seed" });
            hydrateBM();
            refreshCaps();
            hideModal();
            addMsg("bot","Seed added ‚úÖ");
          };
        }, 0);
        return;
      }

      if(action === "intel"){
        showModal("Intelligence", `
          <div class="kv">
            <div class="k">Mode</div><div class="v">Offline fallback (placeholder)</div>
            <div class="k">Priority</div><div class="v">Seed/Learned ‚Üí Offline fallback</div>
            <div class="k">Status</div><div class="v">${state.intelligence ? "Enabled" : "Disabled"}</div>
          </div>
          <div class="btnRow">
            <button class="softBtn" id="toggleIntel">${state.intelligence ? "Disable" : "Enable"}</button>
          </div>
          <div class="smallNote">You can later replace the fallback with a real offline model in an APK/WebGPU supported runtime.</div>
        `);
        setTimeout(()=>{
          document.getElementById("toggleIntel").onclick = ()=>{
            state.intelligence = !state.intelligence;
            hideModal();
            addMsg("bot","Intelligence is now " + (state.intelligence ? "Enabled ‚úÖ" : "Disabled ‚õî"));
          };
        }, 0);
        return;
      }

      if(action === "identity"){
        showModal("Identity Profile", `
          <label>Name</label>
          <input id="idName" value="${state.identity.name}" />
          <label>Role</label>
          <input id="idRole" value="${state.identity.role}" />
          <div class="btnRow">
            <button class="softBtn" id="saveId">Save</button>
          </div>
        `);
        setTimeout(()=>{
          document.getElementById("saveId").onclick = ()=>{
            state.identity.name = document.getElementById("idName").value.trim() || "User";
            state.identity.role = document.getElementById("idRole").value.trim() || "Creator";
            hideModal();
            addMsg("bot","Identity saved ‚úÖ");
          };
        }, 0);
        return;
      }

      if(action === "llm"){
        showModal("LLM Link", `
          <div class="smallNote">Put your clickable model/test link here (optional).</div>
          <label>URL</label>
          <input id="llmUrl" placeholder="https://..." value="${state.llmLink}" />
          <div class="btnRow">
            <button class="softBtn" id="saveLLM">Save</button>
            <button class="softBtn" id="openLLM">Open</button>
          </div>
        `);
        setTimeout(()=>{
          document.getElementById("saveLLM").onclick = ()=>{
            state.llmLink = document.getElementById("llmUrl").value.trim();
            hideModal();
            addMsg("bot","LLM link saved ‚úÖ");
          };
          document.getElementById("openLLM").onclick = ()=>{
            const url = document.getElementById("llmUrl").value.trim();
            if(!url) return alert("Enter a URL first");
            window.open(url, "_blank");
          };
        }, 0);
        return;
      }

      if(action === "bm"){
        hydrateBM();
        showModal("BM Recall", `
          <div class="smallNote">This shows your current BM memory (Seed + Learned).</div>
          <pre class="mono" style="white-space:pre-wrap; background:rgba(15,23,42,.6); padding:10px; border-radius:12px; border:1px solid rgba(148,163,184,.14);">${safeJSON(state.bm.slice(-60))}</pre>
          <div class="btnRow">
            <button class="softBtn dangerBtn" id="clearLearned">Clear Learned</button>
          </div>
        `);
        setTimeout(()=>{
          document.getElementById("clearLearned").onclick = ()=>{
            if(!confirm("Clear learned memory?")) return;
            state.learned = [];
            hydrateBM();
            refreshCaps();
            hideModal();
            addMsg("bot","Learned memory cleared ‚úÖ");
          };
        }, 0);
        return;
      }

      if(action === "history"){
        showModal("Conversation History", `
          <div class="smallNote">Full conversation log in this session.</div>
          <pre class="mono" style="white-space:pre-wrap; background:rgba(15,23,42,.6); padding:10px; border-radius:12px; border:1px solid rgba(148,163,184,.14);">${safeJSON(state.history.slice(-200))}</pre>
          <div class="btnRow">
            <button class="softBtn dangerBtn" id="clearHistory">Clear History</button>
          </div>
        `);
        setTimeout(()=>{
          document.getElementById("clearHistory").onclick = ()=>{
            if(!confirm("Clear conversation history?")) return;
            state.history = [];
            state.tm = [];
            refreshCaps();
            hideModal();
            addMsg("bot","History cleared ‚úÖ");
          };
        }, 0);
        return;
      }

      if(action === "themes"){
        showModal("Themes", `
          <div class="smallNote">Switch only colors (prototype).</div>
          <div class="btnRow">
            <button class="softBtn" data-theme="dark">Dark</button>
            <button class="softBtn" data-theme="light">Light</button>
            <button class="softBtn" data-theme="metallic">Metallic</button>
            <button class="softBtn" data-theme="transparent">Transparent</button>
          </div>
          <div class="smallNote">Note: This changes background palette only (as requested).</div>
        `);
        setTimeout(()=>{
          modalBody.querySelectorAll("[data-theme]").forEach(btn=>{
            btn.onclick = ()=>{
              const t = btn.getAttribute("data-theme");
              applyTheme(t);
              hideModal();
              addMsg("bot","Theme set to: " + t + " ‚úÖ");
            };
          });
        }, 0);
        return;
      }

      if(action === "readme"){
        showModal("Readme / About", `
          <div class="smallNote">
            <b>How to use:</b><br/>
            1) Ask normal questions in the chat.<br/>
            2) Answer priority: <b>Seed/Learned</b> ‚Üí <b>Offline fallback (Intelligence)</b>.<br/>
            3) Use <b>Feed the seed</b> to add Q/A for self learning (offline).<br/>
            4) Use <b>Learning</b> toggle to auto-store new Q/A in Learned memory.<br/>
            5) <b>BM Recall</b> shows (Seed + Learned).<br/>
            6) <b>Conversation history</b> shows chat log of this session.<br/><br/>
            <b>Continuity:</b> internal score based on overlap between recent TM and BM content.<br/>
            <b>Resonance R:</b> depends on continuity + emotion intensity/polarity.<br/>
            <b>E‚ÇÄ:</b> tanh-based stability signal using TM, BM, decay, and lambda terms.
          </div>
        `);
        return;
      }
    });

    backdrop.addEventListener("click", hideModal);
    closeModalBtn.addEventListener("click", hideModal);

    // send message
    async function handleSend(){
      const text = inputEl.value.trim();
      if(!text) return;

      inputEl.value = "";
      addMsg("user", text);

      // TM stores user inputs only
      state.tm.push(text);

      // store history
      state.history.push({ role:"user", text, ts: Date.now() });

      hydrateBM();

      refreshCaps();

      sendBtn.disabled = true;
      const answer = await respond(text);

      addMsg("bot", answer);
      state.history.push({ role:"bot", text: answer, ts: Date.now() });

      maybeLearn(text, answer);

      hydrateBM();
      refreshCaps();

      sendBtn.disabled = false;
    }

    sendBtn.addEventListener("click", handleSend);
    inputEl.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        handleSend();
      }
    });

    function applyTheme(theme){
      state.theme = theme;

      if(theme === "light"){
        document.body.style.background =
          "radial-gradient(circle at 20% 0%, #e2e8f0 0, transparent 45%)," +
          "radial-gradient(circle at 80% 0%, #bae6fd 0, transparent 40%)," +
          "linear-gradient(145deg,#f8fafc 0,#eef2ff 40%,#f8fafc 100%)";
        document.body.style.color = "#0f172a";
        return;
      }

      if(theme === "metallic"){
        document.body.style.background =
          "radial-gradient(circle at 20% 0%, #94a3b8 0, transparent 45%)," +
          "radial-gradient(circle at 80% 0%, #64748b 0, transparent 40%)," +
          "linear-gradient(145deg,#0b1220 0,#111827 40%,#0b1220 100%)";
        document.body.style.color = "#e5e7eb";
        return;
      }

      if(theme === "transparent"){
        document.body.style.background =
          "radial-gradient(circle at 20% 0%, rgba(30,41,59,.55) 0, transparent 45%)," +
          "radial-gradient(circle at 80% 0%, rgba(14,165,233,.45) 0, transparent 40%)," +
          "linear-gradient(145deg,rgba(2,6,23,.75) 0, rgba(2,6,23,.55) 40%, rgba(2,6,23,.75) 100%)";
        document.body.style.color = "#e5e7eb";
        return;
      }

      // default dark
      document.body.style.background =
        "radial-gradient(circle at 20% 0%, #1e293b 0, transparent 45%)," +
        "radial-gradient(circle at 80% 0%, #0ea5e9 0, transparent 40%)," +
        "linear-gradient(145deg,#020617 0,#020617 40%,#020617 100%)";
      document.body.style.color = "#e5e7eb";
    }

    // init
    hydrateBM();
    updatePills();
    refreshCaps();
    addMsg("bot","AURA-X Œ© ready ‚úÖ Ask me something.");
  </script>
</body>
</html>