<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA-X Œ© ‚Äì Offline Emotional Continuity Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Offline LLM package (WebLLM, for in-browser models ‚Äì future ready) -->
  <script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";
    window.webllm = webllm;
  </script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root { --accent-color:#0ea5e9; }
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:#0b1220;
      color:#e5e7eb;
      height:100vh;
      overflow:hidden;
    }
    .app{
      max-width:1080px;
      margin:0 auto;
      height:100vh;
      display:flex;
      flex-direction:column;
      padding:10px;
      gap:10px;
    }
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
    }
    .logo{
      width:34px;height:34px;border-radius:10px;
      background:linear-gradient(135deg,#0ea5e9,#a78bfa);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;
      box-shadow:0 10px 20px rgba(0,0,0,.35);
    }
    .title{
      display:flex;flex-direction:column;line-height:1.1;
    }
    .title b{font-size:14px}
    .title span{font-size:12px;opacity:.75}
    .capsuleRow{
      display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;
    }
    .cap{
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-size:12px;
      display:flex;gap:8px;align-items:center;
      backdrop-filter: blur(10px);
    }
    .cap b{font-weight:700}
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:#e5e7eb;
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}
    .btn:active{transform:translateY(0px)}
    .btnBlue{background:rgba(14,165,233,.18);border-color:rgba(14,165,233,.45)}
    .btnRed{background:rgba(239,68,68,.16);border-color:rgba(239,68,68,.45)}
    .btnGreen{background:rgba(34,197,94,.16);border-color:rgba(34,197,94,.45)}
    .btnAmber{background:rgba(245,158,11,.16);border-color:rgba(245,158,11,.45)}
    .layout{
      display:grid;
      grid-template-columns: 1fr 330px;
      gap:10px;
      flex:1;
      min-height:0;
    }
    @media(max-width:940px){
      .layout{grid-template-columns:1fr}
    }
    .panel{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      box-shadow:0 14px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .panelHeader{
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.00));
    }
    .panelHeader b{font-size:13px}
    .panelBody{
      padding:10px 12px;
      overflow:auto;
      min-height:0;
    }
    .gridBtns{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:8px;
    }
    .gridBtns .btn{
      justify-content:center;
      padding:10px 8px;
      border-radius:14px;
      font-weight:600;
    }
    .chat{
      display:flex;flex-direction:column;min-height:0;
    }
    .chatFeed{
      flex:1;
      overflow:auto;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .msg{
      max-width:92%;
      padding:10px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      line-height:1.35;
      font-size:13px;
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    .msg.user{
      align-self:flex-end;
      background:rgba(14,165,233,.14);
      border-color:rgba(14,165,233,.35);
    }
    .msg.aura{
      align-self:flex-start;
      background:rgba(167,139,250,.12);
      border-color:rgba(167,139,250,.30);
    }
    .metaLine{
      display:flex;gap:10px;flex-wrap:wrap;opacity:.85;
      font-size:12px;
      padding:8px 12px;
      border-top:1px solid rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
    }
    .composer{
      padding:10px 12px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    textarea{
      width:100%;
      min-height:44px;
      max-height:150px;
      resize:none;
      border-radius:16px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      color:#e5e7eb;
      outline:none;
      font-size:13px;
      line-height:1.35;
    }
    textarea:focus{border-color:rgba(14,165,233,.55)}
    .composer .btn{padding:10px 12px;border-radius:16px}
    .badge{
      font-size:11px;
      opacity:.9;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
    }

    /* Modals */
    .modalOverlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.65);
      display:none;
      align-items:center;justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(900px, 96vw);
      max-height:min(92vh, 860px);
      background:#0b1220;
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      overflow:hidden;
      display:flex;flex-direction:column;
      box-shadow:0 20px 60px rgba(0,0,0,.6);
    }
    .modal .panelBody{padding:12px 14px}
    .modalHeader{
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
    }
    .modalHeader b{font-size:13px}
    .row{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    .field{
      display:flex;flex-direction:column;gap:6px;min-width:240px;flex:1;
    }
    .field label{font-size:12px;opacity:.85}
    input, select{
      width:100%;
      border-radius:14px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      color:#e5e7eb;
      outline:none;
      font-size:13px;
    }
    input:focus, select:focus{border-color:rgba(14,165,233,.55)}
    .small{font-size:12px;opacity:.85}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:10px 0}
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      background:rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.14);
      color:#e5e7eb;
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      display:none;
      z-index:10000;
      max-width:min(92vw,700px);
    }
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
  </style>
</head>

<body>
  <div class="app">

    <div class="topbar">
      <div class="brand">
        <div class="logo">Œ©</div>
        <div class="title">
          <b>AURA-X Œ©</b>
          <span>Offline Emotional Continuity Prototype</span>
        </div>
      </div>

      <div class="capsuleRow">
        <div class="cap"><span class="badge">E</span><b id="capE">0.00</b></div>
        <div class="cap"><span class="badge">TM</span><b id="capTM">0</b></div>
        <div class="cap"><span class="badge">BM</span><b id="capBM">0</b></div>
        <div class="cap"><span class="badge">R</span><b id="capR">0.00</b></div>
        <button class="btn btnBlue" id="btnOptions">‚öôÔ∏è Options</button>
      </div>
    </div>

    <div class="layout">

      <!-- Chat -->
      <div class="panel chat">
        <div class="panelHeader">
          <b>Conversation</b>
          <div class="row">
            <span class="badge" id="modeBadge">Offline</span>
            <button class="btn" id="btnVoice">üîä Voice</button>
            <button class="btn btnGreen" id="btnExport">‚¨áÔ∏è Export</button>
          </div>
        </div>

        <div class="chatFeed" id="chatFeed"></div>

        <div class="metaLine">
          <span>Emotion: <b id="mEmotion">neutral</b></span>
          <span>Polarity: <b id="mPol">0</b></span>
          <span>Intensity: <b id="mInt">0</b></span>
          <span>Category: <b id="mCat">general</b></span>
        </div>

        <div class="composer">
          <textarea id="userInput" placeholder="Type your message..."></textarea>
          <button class="btn btnBlue" id="btnSend">Send ‚û§</button>
        </div>
      </div>

      <!-- Side Panel -->
      <div class="panel">
        <div class="panelHeader">
          <b>Quick Actions</b>
          <span class="small" id="statusLine">Ready</span>
        </div>
        <div class="panelBody">
          <div class="gridBtns">
            <button class="btn" id="btnFaith">üïã Faith</button>
            <button class="btn" id="btnBM">üìå BM Recall</button>
            <button class="btn" id="btnHistory">üïò History</button>
            <button class="btn" id="btnIntelligence">üß† Intelligence</button>
            <button class="btn" id="btnIdentity">ü™™ Identity</button>
            <button class="btn" id="btnReadme">üìò Readme</button>
          </div>
          <div class="hr"></div>
          <div class="small">
            Tips: Use <b>Incorrect</b> to correct wrong answers. Long-term items can auto-lock inside BM/Intelligence.
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Options modal -->
  <div class="modalOverlay" id="modalOptions">
    <div class="modal">
      <div class="modalHeader">
        <b>Options</b>
        <button class="btn" data-close="modalOptions">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="row">
          <button class="btn" id="miFaith">üïã Faith</button>
          <button class="btn" id="miBM">üìå BM Recall</button>
          <button class="btn" id="miHistory">üïò History</button>
          <button class="btn" id="miIntelligence">üß† Intelligence</button>
          <button class="btn" id="miIdentity">ü™™ Identity</button>
          <button class="btn" id="miReadme">üìò Readme</button>
        </div>
        <div class="hr"></div>
        <div class="small mono">
          Settings are stored locally (localStorage). No server required.
        </div>
      </div>
    </div>
  </div>

  <!-- Faith modal -->
  <div class="modalOverlay" id="modalFaith">
    <div class="modal">
      <div class="modalHeader">
        <b>Faith & Ethics</b>
        <button class="btn" data-close="modalFaith">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="row">
          <div class="field">
            <label>Belief System</label>
            <select id="faithSelect">
              <option value="none">None</option>
              <option value="islam">Islam</option>
              <option value="christianity">Christianity</option>
              <option value="hinduism">Hinduism</option>
              <option value="buddhism">Buddhism</option>
              <option value="judaism">Judaism</option>
              <option value="sikhism">Sikhism</option>
              <option value="taoism">Taoism</option>
              <option value="confucianism">Confucianism</option>
              <option value="shinto">Shinto</option>
              <option value="bahai">Bah√°‚Äô√≠</option>
            </select>
          </div>
          <div class="field">
            <label>Topic</label>
            <select id="faithTopic">
              <option value="general">General</option>
              <option value="truth">Truth</option>
              <option value="ethics">Ethics</option>
              <option value="patience">Patience</option>
              <option value="compassion">Compassion</option>
              <option value="justice">Justice</option>
            </select>
          </div>
          <div class="field">
            <label>Translation</label>
            <select id="faithTranslation">
              <option value="auto">Auto (Location Based)</option>
              <option value="ur">Urdu</option>
              <option value="en">English</option>
              <option value="ar">Arabic</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <div class="field">
          <label>Statement</label>
          <div class="msg aura" id="faithStatement" style="max-width:100%"></div>
        </div>

        <div class="field" style="margin-top:10px">
          <label>Translation</label>
          <div class="msg user" id="faithStatementTranslation" style="max-width:100%"></div>
        </div>

        <div class="hr"></div>

        <div class="row" style="justify-content:flex-end">
          <button class="btn btnBlue" id="btnApplyFaith">Apply</button>
          <button class="btn" data-close="modalFaith">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- BM modal -->
  <div class="modalOverlay" id="modalBM">
    <div class="modal">
      <div class="modalHeader">
        <b>BM Recall</b>
        <button class="btn" data-close="modalBM">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="row">
          <button class="btn" id="btnBMGeneratePrompt">‚ö° Generate Prompt</button>
          <button class="btn" id="btnBMCopyPrompt">üìã Copy Prompt</button>
          <button class="btn btnRed" id="btnBMDeleteAll">üóëÔ∏è Delete All (Unlocked)</button>
        </div>
        <div class="hr"></div>

        <div class="field">
          <label>BM Prompt</label>
          <textarea id="bmPrompt" placeholder="Auto-generated prompt will appear here..." style="min-height:130px"></textarea>
        </div>

        <div class="hr"></div>

        <div class="field">
          <label>Search by Date</label>
          <input type="date" id="bmDate" />
        </div>

        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button class="btn" id="btnBMSearchDate">üîé Search</button>
          <button class="btn" data-close="modalBM">Close</button>
        </div>

        <div class="hr"></div>
        <div id="bmList" class="small"></div>
      </div>
    </div>
  </div>

  <!-- History modal -->
  <div class="modalOverlay" id="modalHistory">
    <div class="modal">
      <div class="modalHeader">
        <b>Conversation History (TM)</b>
        <button class="btn" data-close="modalHistory">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="row">
          <button class="btn" id="btnTMDelete24h">üßπ Delete 24h</button>
          <button class="btn btnRed" id="btnTMDeleteAll">üóëÔ∏è Delete All (Unlocked)</button>
        </div>
        <div class="hr"></div>

        <div class="field">
          <label>Search by Date</label>
          <input type="date" id="tmDate" />
        </div>

        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button class="btn" id="btnTMSearchDate">üîé Search</button>
          <button class="btn" data-close="modalHistory">Close</button>
        </div>

        <div class="hr"></div>
        <div id="tmList" class="small"></div>
      </div>
    </div>
  </div>

  <!-- Intelligence modal -->
  <div class="modalOverlay" id="modalIntelligence">
    <div class="modal">
      <div class="modalHeader">
        <b>Intelligence (Learned Q/A)</b>
        <button class="btn" data-close="modalIntelligence">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="row">
          <button class="btn" id="btnIntelExport">‚¨áÔ∏è Export</button>
          <button class="btn btnRed" id="btnIntelDeleteAll">üóëÔ∏è Delete All (Unlocked)</button>
        </div>
        <div class="hr"></div>

        <div id="intelList" class="small"></div>
      </div>
    </div>
  </div>

  <!-- Readme modal -->
  <div class="modalOverlay" id="modalReadme">
    <div class="modal">
      <div class="modalHeader">
        <b>Readme</b>
        <button class="btn" data-close="modalReadme">‚úñ</button>
      </div>
      <div class="panelBody">
        <div class="small">
          <b>How to correct wrong answers</b><br/>
          - If Aura replies wrong, type: <b>*incorrect</b><br/>
          - Aura will ask for the correct answer, then confirm Yes/No.<br/><br/>

          <b>TM (Conversation History)</b><br/>
          - Auto decay is enabled (48h). You can delete 24h or delete all unlocked items.<br/><br/>

          <b>BM</b><br/>
          - Stores meaningful prompts (long-term). Repeats can extend life and auto-lock.<br/><br/>

          <b>Identity</b><br/>
          - Stores your profile and ‚Äúdeep profiling‚Äù blocks locally. Also supports Identity Hub import.
        </div>
      </div>
    </div>
  </div>

  <!-- Identity modal -->
  <div class="modalOverlay" id="modalIdentity">
    <div class="modal">
      <div class="modalHeader">
        <b>Identity (Deep Profiling)</b>
        <button class="btn" data-close="modalIdentity">‚úñ</button>
      </div>
      <div class="panelBody">

        <div class="row">
          <div class="field">
            <label>Full Name</label>
            <input id="uName" placeholder="e.g., Alim ul Haq" readonly />
          </div>
          <div class="field">
            <label>Nickname</label>
            <input id="uNick" placeholder="e.g., Alim" readonly />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Origin / Birthplace</label>
            <input id="uOrigin" placeholder="e.g., Timergara" readonly />
          </div>
          <div class="field">
            <label>Current Location</label>
            <input id="uPlace" placeholder="e.g., Pakistan" readonly />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Profession / Role</label>
            <input id="uProfession" placeholder="e.g., Researcher" readonly />
          </div>
          <div class="field">
            <label>Emotional Style</label>
            <input id="uEmotionalStyle" placeholder="e.g., calm, analytical, warm" readonly />
          </div>
        </div>

        <div class="field">
          <label>Key People (family / mentors / important)</label>
          <textarea id="uKeyPeople" placeholder="Write key people..." readonly></textarea>
        </div>

        <div class="field">
          <label>Legacy Rules (your core rules / values)</label>
          <textarea id="uLegacyRules" placeholder="Write values/rules..." readonly></textarea>
        </div>

        <div class="hr"></div>

        <div class="row" style="justify-content:flex-end">
          <button class="btn" id="btnEditIdentity">‚úèÔ∏è Edit</button>
          <button class="btn btnBlue" id="btnSaveUserIdentity">üíæ Save</button>
          <button class="btn btnRed" id="btnDeleteUserIdentity">Delete</button>
          <button class="btn" id="btnOpenIdentityHub">üîó Hub</button>
          <button class="btn" id="btnImportIdentityHub">‚¨áÔ∏è Import</button>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /*********************
     *  Storage Keys
     *********************/
    const KEY_TM = "aurax_tm_v11";
    const KEY_BM = "aurax_bm_v11";
    const KEY_INTEL = "aurax_intel_v11";
    const KEY_SETTINGS = "aurax_settings_v11";
    const KEY_USER = "aurax_user_v11";

    // Identity Hub (optional)
    const IDENTITY_HUB_URL = "https://alimulhaqkhan-prog.github.io/aura-x-identity/";
    const IDENTITY_HUB_JSON = IDENTITY_HUB_URL + "identity.json";

    /*********************
     *  State
     *********************/
    const state = {
      tm: [],
      bm: [],
      intel: [],
      settings: {
        voiceOn: false,
        faith: { belief: "none", topic: "general", translation: "auto" }
      },
      userIdentity: null,
      lastEmotion: { emotion:"neutral", polarity:0, intensity:0, category:"general" }
    };

    /*********************
     *  Elements
     *********************/
    const els = {
      chatFeed: document.getElementById("chatFeed"),
      userInput: document.getElementById("userInput"),
      btnSend: document.getElementById("btnSend"),
      btnVoice: document.getElementById("btnVoice"),
      btnExport: document.getElementById("btnExport"),
      btnOptions: document.getElementById("btnOptions"),

      capE: document.getElementById("capE"),
      capTM: document.getElementById("capTM"),
      capBM: document.getElementById("capBM"),
      capR: document.getElementById("capR"),

      mEmotion: document.getElementById("mEmotion"),
      mPol: document.getElementById("mPol"),
      mInt: document.getElementById("mInt"),
      mCat: document.getElementById("mCat"),

      statusLine: document.getElementById("statusLine"),
      modeBadge: document.getElementById("modeBadge"),

      // quick action buttons
      btnFaith: document.getElementById("btnFaith"),
      btnBM: document.getElementById("btnBM"),
      btnHistory: document.getElementById("btnHistory"),
      btnIntelligence: document.getElementById("btnIntelligence"),
      btnIdentity: document.getElementById("btnIdentity"),
      btnReadme: document.getElementById("btnReadme"),

      // Options items
      miFaith: document.getElementById("miFaith"),
      miBM: document.getElementById("miBM"),
      miHistory: document.getElementById("miHistory"),
      miIntelligence: document.getElementById("miIntelligence"),
      miIdentity: document.getElementById("miIdentity"),
      miReadme: document.getElementById("miReadme"),

      // modals
      modalOptions: document.getElementById("modalOptions"),
      modalFaith: document.getElementById("modalFaith"),
      modalBM: document.getElementById("modalBM"),
      modalHistory: document.getElementById("modalHistory"),
      modalIntelligence: document.getElementById("modalIntelligence"),
      modalIdentity: document.getElementById("modalIdentity"),
      modalReadme: document.getElementById("modalReadme"),

      // faith
      faithSelect: document.getElementById("faithSelect"),
      faithTopic: document.getElementById("faithTopic"),
      faithTranslation: document.getElementById("faithTranslation"),
      faithStatement: document.getElementById("faithStatement"),
      faithStatementTranslation: document.getElementById("faithStatementTranslation"),
      btnApplyFaith: document.getElementById("btnApplyFaith"),

      // BM
      bmPrompt: document.getElementById("bmPrompt"),
      bmList: document.getElementById("bmList"),
      bmDate: document.getElementById("bmDate"),
      btnBMGeneratePrompt: document.getElementById("btnBMGeneratePrompt"),
      btnBMCopyPrompt: document.getElementById("btnBMCopyPrompt"),
      btnBMDeleteAll: document.getElementById("btnBMDeleteAll"),
      btnBMSearchDate: document.getElementById("btnBMSearchDate"),

      // TM
      tmList: document.getElementById("tmList"),
      tmDate: document.getElementById("tmDate"),
      btnTMDelete24h: document.getElementById("btnTMDelete24h"),
      btnTMDeleteAll: document.getElementById("btnTMDeleteAll"),
      btnTMSearchDate: document.getElementById("btnTMSearchDate"),

      // Intelligence
      intelList: document.getElementById("intelList"),
      btnIntelExport: document.getElementById("btnIntelExport"),
      btnIntelDeleteAll: document.getElementById("btnIntelDeleteAll"),

      // Identity fields
      uName: document.getElementById("uName"),
      uNick: document.getElementById("uNick"),
      uOrigin: document.getElementById("uOrigin"),
      uPlace: document.getElementById("uPlace"),
      uProfession: document.getElementById("uProfession"),
      uEmotionalStyle: document.getElementById("uEmotionalStyle"),
      uKeyPeople: document.getElementById("uKeyPeople"),
      uLegacyRules: document.getElementById("uLegacyRules"),
      btnEditIdentity: document.getElementById("btnEditIdentity"),
      btnSaveUserIdentity: document.getElementById("btnSaveUserIdentity"),
      btnDeleteUserIdentity: document.getElementById("btnDeleteUserIdentity"),
      btnOpenIdentityHub: document.getElementById("btnOpenIdentityHub"),
      btnImportIdentityHub: document.getElementById("btnImportIdentityHub"),

      toast: document.getElementById("toast")
    };

    /*********************
     *  Helpers
     *********************/
    function showToast(msg){
      els.toast.textContent = msg;
      els.toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>els.toast.style.display="none", 1800);
    }

    function safeLoadJSON(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        return JSON.parse(raw);
      }catch(e){
        return fallback;
      }
    }
    function safeSaveJSON(key, value){
      try{ localStorage.setItem(key, JSON.stringify(value)); }catch(e){}
    }

    function openModal(id){
      const el = els[id] || document.getElementById(id);
      if(el) el.style.display = "flex";
    }
    function closeModal(id){
      const el = els[id] || document.getElementById(id);
      if(el) el.style.display = "none";
    }

    // close buttons
    document.querySelectorAll("[data-close]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        closeModal(btn.getAttribute("data-close"));
      });
    });

    function nowTs(){ return Date.now(); }

    function fmtDate(ts){
      const d = new Date(ts);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }

    /*********************
     *  Continuity Math
     *********************/
    function tanh(x){
      const e1 = Math.exp(x);
      const e2 = Math.exp(-x);
      return (e1 - e2) / (e1 + e2);
    }
    function computeR(tmLen, bmLen){
      const x = (tmLen*0.08) + (bmLen*0.18);
      return tanh(x);
    }
    function computeE(){
      const base = (state.lastEmotion.polarity * 0.6) + (state.lastEmotion.intensity * 0.4);
      const faithBoost = state.settings.faith?.belief && state.settings.faith.belief !== "none" ? 0.08 : 0.0;
      return tanh(base + faithBoost);
    }
    function refreshCapsules(){
      els.capTM.textContent = state.tm.length;
      els.capBM.textContent = state.bm.length;
      const r = computeR(state.tm.length, state.bm.length);
      els.capR.textContent = r.toFixed(2);
      els.capE.textContent = computeE().toFixed(2);
    }

    /*********************
     *  Chat rendering
     *********************/
    function addMessage(role, text, meta={}){
      const item = {
        id: crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2),
        role,
        text,
        ts: nowTs(),
        locked: false,
        meta
      };
      state.tm.push(item);
      pruneTM();
      safeSaveJSON(KEY_TM, state.tm);
      renderChat();
      refreshCapsules();
      return item;
    }

    function renderChat(){
      els.chatFeed.innerHTML = "";
      const frag = document.createDocumentFragment();
      state.tm.forEach(m=>{
        const div = document.createElement("div");
        div.className = "msg " + (m.role === "user" ? "user" : "aura");
        div.textContent = m.text;
        frag.appendChild(div);
      });
      els.chatFeed.appendChild(frag);
      els.chatFeed.scrollTop = els.chatFeed.scrollHeight;
    }

    /*********************
     *  TM Decay (48h)
     *********************/
    function pruneTM(){
      const cutoff = nowTs() - (48*60*60*1000);
      state.tm = state.tm.filter(m => m.locked || m.ts >= cutoff);
    }

    /*********************
     *  BM logic
     *********************/
    function isSmallTalk(text){
      const t = (text||"").trim().toLowerCase();
      const small = ["hi","hello","hey","assalam","salam","how are you","good morning","good night","thanks","thank you"];
      if(t.length <= 12 && small.some(s=>t.includes(s))) return true;
      return false;
    }

    function normalizeText(s){
      return (s||"").toLowerCase().replace(/[^\w\s]+/g," ").replace(/\s+/g," ").trim();
    }
    function similarity(a,b){
      if(!a || !b) return 0;
      const A = new Set(a.split(" "));
      const B = new Set(b.split(" "));
      let inter=0;
      A.forEach(t=>{ if(B.has(t)) inter++; });
      return inter / Math.max(1, Math.min(A.size,B.size));
    }

    function maybeAddToBM(userText, auraText){
      const joined = `${userText}\nAURA: ${auraText}`.trim();
      if(!joined) return;
      if(isSmallTalk(userText)) return;

      const ts = nowTs();
      const monthAgo = ts - 30*24*60*60*1000;

      const normalized = normalizeText(userText);
      const hits = state.bm.filter(x => x.ts >= monthAgo && similarity(normalizeText(x.userText||""), normalized) >= 0.85);
      const repeatCount = hits.length + 1;

      let months = 1;
      if(repeatCount === 2) months = 2;
      if(repeatCount === 3) months = 3;

      const lockNow = repeatCount >= 4;

      const item = {
        id: crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2),
        userText,
        auraText,
        ts,
        expiresAt: ts + (months*30*24*60*60*1000),
        locked: lockNow,
        repeatCount
      };
      state.bm.unshift(item);
      safeSaveJSON(KEY_BM, state.bm);
      refreshCapsules();
    }

    function pruneBM(){
      const ts = nowTs();
      state.bm = state.bm.filter(x => x.locked || x.expiresAt >= ts);
    }

    function renderBMList(list = state.bm){
      els.bmList.innerHTML = "";
      if(!list.length){
        els.bmList.innerHTML = "<div class='small'>No BM items found.</div>";
        return;
      }
      list.forEach(x=>{
        const box = document.createElement("div");
        box.className = "msg aura";
        box.style.maxWidth = "100%";
        const lock = x.locked ? "üîí" : "üîì";
        box.textContent = `${lock} (${fmtDate(x.ts)})\nQ: ${x.userText}\nA: ${x.auraText}`;
        els.bmList.appendChild(box);
      });
    }

    function generateBMPrompt(){
      pruneBM();
      const top = state.bm.slice(0, 12);
      const lines = top.map((x,i)=>`${i+1}) Q: ${x.userText}\n   A: ${x.auraText}`);
      const prompt = [
        "AURA-X Œ© ‚Äî BM Context (Long-term Memory)",
        "Use these as long-term behavior + preference context.",
        "",
        ...lines
      ].join("\n");
      els.bmPrompt.value = prompt;
    }

    function copyToClipboard(text){
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(()=>showToast("Copied"));
        return;
      }
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      showToast("Copied");
    }

    /*********************
     *  Intelligence (Self learning)
     *********************/
    const seedQA = [
      { q: "hi", a: "Hello! I am Aura X Omega. How can I help you today?" },
      { q: "who created you", a: "I was created by Alim ul Haq from Timergara, Pakistan." },
      { q: "how are you", a: "I‚Äôm stable and ready. Tell me what you want to explore." }
    ];

    function findLearnedAnswer(q){
      const nq = normalizeText(q);
      const learned = state.intel
        .map(x => ({...x, score: similarity(normalizeText(x.q), nq)}))
        .sort((a,b)=>b.score-a.score)[0];
      if(learned && learned.score >= 0.85) return learned.a;

      const seed = seedQA
        .map(x => ({...x, score: similarity(normalizeText(x.q), nq)}))
        .sort((a,b)=>b.score-a.score)[0];
      if(seed && seed.score >= 0.85) return seed.a;

      return null;
    }

    function addLearnedQA(q,a){
      const item = {
        id: crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2),
        q, a,
        ts: nowTs(),
        locked: false,
        approvedCount: 0
      };
      state.intel.unshift(item);
      safeSaveJSON(KEY_INTEL, state.intel);
    }

    function renderIntel(){
      els.intelList.innerHTML = "";
      if(!state.intel.length){
        els.intelList.innerHTML = "<div class='small'>No learned Q/A yet.</div>";
        return;
      }
      state.intel.forEach(x=>{
        const box = document.createElement("div");
        box.className = "msg aura";
        box.style.maxWidth = "100%";
        const lock = x.locked ? "üîí" : "üîì";
        box.textContent = `${lock} (${fmtDate(x.ts)})\nQ: ${x.q}\nA: ${x.a}`;
        els.intelList.appendChild(box);
      });
    }

    /*********************
     *  Faith Statement Generator
     *********************/
    function autoTranslationLang(){
      const lang = (navigator.language || "").toLowerCase();
      if(lang.includes("ur") || lang.includes("pk")) return "ur";
      return "en";
    }

    function getFaithStatement(belief, topic){
      const pack = {
        islam: {
          general: {
            ar: "ÿßŸÑŸÖÿ≥ŸÑŸÖ ŸÖŸÜ ÿ≥ŸÑŸÖ ÿßŸÑŸÖÿ≥ŸÑŸÖŸàŸÜ ŸÖŸÜ ŸÑÿ≥ÿßŸÜŸá ŸàŸäÿØŸá",
            en: "A Muslim is one from whose tongue and hands other Muslims are safe.",
            ur: "ŸÖÿ≥ŸÑŸÖÿßŸÜ Ÿà€Å €Å€í ÿ¨ÿ≥ ⁄©€å ÿ≤ÿ®ÿßŸÜ ÿßŸàÿ± €Åÿßÿ™⁄æ ÿ≥€í ÿØŸàÿ≥ÿ±€í ŸÖÿ≥ŸÑŸÖÿßŸÜ ŸÖÿ≠ŸÅŸàÿ∏ ÿ±€Å€å⁄∫€î"
          },
          ethics: {
            ar: "ÿ•ŸêŸÜŸëŸé Ÿ±ŸÑŸÑŸëŸéŸáŸé ŸäŸéÿ£ŸíŸÖŸèÿ±Ÿè ÿ®ŸêŸ±ŸÑŸíÿπŸéÿØŸíŸÑŸê ŸàŸéŸ±ŸÑŸíÿ•Ÿêÿ≠Ÿíÿ≥ŸéŸÄŸ∞ŸÜŸê",
            en: "Indeed, Allah commands justice and excellence.",
            ur: "ÿ®€í ÿ¥⁄© ÿßŸÑŸÑ€Å ÿπÿØŸÑ ÿßŸàÿ± ÿßÿ≠ÿ≥ÿßŸÜ ⁄©ÿß ÿ≠⁄©ŸÖ ÿØ€åÿ™ÿß €Å€í€î"
          },
          truth: {
            ar: "ŸäŸéÿß ÿ£ŸéŸäŸëŸèŸáŸéÿß ÿßŸÑŸëŸéÿ∞ŸêŸäŸÜŸé ÿ¢ŸÖŸéŸÜŸèŸàÿß ÿßÿ™ŸëŸéŸÇŸèŸàÿß ÿßŸÑŸÑŸëŸéŸáŸé ŸàŸéŸÇŸèŸàŸÑŸèŸàÿß ŸÇŸéŸàŸíŸÑŸãÿß ÿ≥ŸéÿØŸêŸäÿØŸãÿß",
            en: "O believers, fear Allah and speak words of truth.",
            ur: "ÿß€í ÿß€åŸÖÿßŸÜ ŸàÿßŸÑŸà! ÿßŸÑŸÑ€Å ÿ≥€í ⁄àÿ±Ÿà ÿßŸàÿ± ÿ≥€åÿØ⁄æ€å ÿ®ÿßÿ™ ⁄©€ÅŸà€î"
          },
          patience: {
            ar: "ÿ•ŸêŸÜŸëŸé ÿßŸÑŸÑŸëŸéŸáŸé ŸÖŸéÿπŸé ÿßŸÑÿµŸëŸéÿßÿ®Ÿêÿ±ŸêŸäŸÜŸé",
            en: "Indeed, Allah is with the patient.",
            ur: "ÿ®€í ÿ¥⁄© ÿßŸÑŸÑ€Å ÿµÿ®ÿ± ⁄©ÿ±ŸÜ€í ŸàÿßŸÑŸà⁄∫ ⁄©€í ÿ≥ÿßÿ™⁄æ €Å€í€î"
          },
          compassion: {
            ar: "ÿßŸÑÿ±ŸëŸéÿßÿ≠ŸêŸÖŸèŸàŸÜŸé ŸäŸéÿ±Ÿíÿ≠ŸéŸÖŸèŸáŸèŸÖŸè ÿßŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸéŸ∞ŸÜŸè",
            en: "The merciful are shown mercy by the Most Merciful.",
            ur: "ÿ±ÿ≠ŸÖ ⁄©ÿ±ŸÜ€í ŸàÿßŸÑŸà⁄∫ Ÿæÿ± ÿ±ÿ≠ŸÖŸ∞ŸÜ ÿ±ÿ≠ŸÖ ŸÅÿ±ŸÖÿßÿ™ÿß €Å€í€î"
          },
          justice: {
            ar: "ÿßÿπŸíÿØŸêŸÑŸèŸàÿß ŸáŸèŸàŸé ÿ£ŸéŸÇŸíÿ±Ÿéÿ®Ÿè ŸÑŸêŸÑÿ™ŸëŸéŸÇŸíŸàŸéŸâŸ∞",
            en: "Be just; that is nearer to righteousness.",
            ur: "ÿπÿØŸÑ ⁄©ÿ±Ÿàÿå €å€Å€å ÿ™ŸÇŸà€åŸ∞ ⁄©€í ÿ≤€åÿßÿØ€Å ŸÇÿ±€åÿ® €Å€í€î"
          }
        },
        christianity: {
          general: { ar: "ÿ∑ŸèŸàÿ®ŸéŸâ ŸÑŸêÿµŸéÿßŸÜŸêÿπŸêŸä ÿßŸÑÿ≥ŸëŸéŸÑŸéÿßŸÖŸê", en: "Blessed are the peacemakers.", ur: "ÿ≥ŸÑÿßŸÖÿ™€å ⁄©ÿ±ŸÜ€í ŸàÿßŸÑ€í ŸÖÿ®ÿßÿ±⁄© €Å€å⁄∫€î" }
        },
        hinduism: { general: { ar: "ÿ£ŸéŸáŸêŸÖŸíÿ≥Ÿéÿß ÿ®Ÿéÿßÿ±ŸéŸÖŸèŸà ÿØŸéÿ±ŸíŸÖŸéŸá", en: "Non-violence is the highest duty.", ur: "ÿπÿØŸÖ ÿ™ÿ¥ÿØÿØ ÿ≥ÿ® ÿ≥€í ÿ®⁄ëÿß ŸÅÿ±ÿ∂ €Å€í€î" } },
        buddhism: { general: { ar: "ÿßŸÑÿ≥ŸëŸéŸÑŸéÿßŸÖŸè ŸäŸéÿ®ŸíÿØŸéÿ£Ÿè ŸÖŸêŸÜŸé ÿßŸÑÿØŸëŸéÿßÿÆŸêŸÑŸê", en: "Peace comes from within.", ur: "ÿ≥⁄©ŸàŸÜ ÿßŸÜÿØÿ± ÿ≥€í Ÿæ€åÿØÿß €ÅŸàÿ™ÿß €Å€í€î" } },
        judaism: { general: { ar: "ÿßÿ∑ŸíŸÑŸèÿ®Ÿê ÿßŸÑÿ≥ŸëŸéŸÑŸéÿßŸÖŸé ŸàŸéÿßÿ≥ŸíÿπŸé ÿ•ŸêŸÑŸéŸäŸíŸáŸê", en: "Seek peace and pursue it.", ur: "ÿßŸÖŸÜ ÿ™ŸÑÿßÿ¥ ⁄©ÿ±Ÿà ÿßŸàÿ± ÿßÿ≥ ⁄©€í Ÿæ€å⁄Ü⁄æ€í ⁄ÜŸÑ Ÿæ⁄ëŸà€î" } },
        sikhism: { general: { ar: "ÿ≥Ÿéÿ±Ÿíÿ®Ÿéÿ™Ÿí ÿØŸéÿß ÿ®ŸéŸáŸíŸÑŸéÿß", en: "Welfare of all.", ur: "ÿ≥ÿ® ⁄©€å ÿ®⁄æŸÑÿßÿ¶€å€î" } },
        taoism: { general: { ar: "ÿßŸÑÿ±ŸëŸêŸÇŸëŸéÿ©Ÿè ÿ™Ÿéÿ∫ŸíŸÑŸêÿ®Ÿè ÿßŸÑÿ¥ŸëŸêÿØŸëŸéÿ©Ÿé", en: "Softness overcomes hardness.", ur: "ŸÜÿ±ŸÖ€å ÿ≥ÿÆÿ™€å Ÿæÿ± ÿ∫ÿßŸÑÿ® ÿ¢ÿ™€å €Å€í€î" } },
        confucianism: { general: { ar: "ŸÑÿßŸé ÿ™ŸéŸÅŸíÿπŸéŸÑŸí ŸÑŸêÿ∫ŸéŸäŸíÿ±ŸêŸÉŸé ŸÖŸéÿß ŸÑÿßŸé ÿ™Ÿèÿ≠Ÿêÿ®ŸëŸèŸáŸè ŸÑŸêŸÜŸéŸÅŸíÿ≥ŸêŸÉŸé", en: "Do not do to others what you do not want done to yourself.", ur: "ÿ¨Ÿà ÿßŸæŸÜ€í ŸÑ€å€í Ÿæÿ≥ŸÜÿØ ŸÜ€Å€å⁄∫ÿå Ÿà€Å ÿØŸàÿ≥ÿ±Ÿà⁄∫ ⁄©€í ŸÑ€å€í ŸÜ€Å ⁄©ÿ±Ÿà€î" } },
        shinto: { general: { ar: "Ÿ±ÿ≠Ÿíÿ™Ÿéÿ±ŸêŸÖŸê Ÿ±ŸÑÿ∑ŸëŸéÿ®ŸêŸäÿπŸéÿ©Ÿé ŸàŸéŸ±ŸÑŸíŸÜŸëŸéÿßÿ≥Ÿé", en: "Respect nature and people.", ur: "ŸÅÿ∑ÿ±ÿ™ ÿßŸàÿ± ŸÑŸà⁄ØŸà⁄∫ ⁄©ÿß ÿßÿ≠ÿ™ÿ±ÿßŸÖ ⁄©ÿ±Ÿà€î" } },
        bahai: { general: { ar: "Ÿ±ŸÑŸíÿ£Ÿéÿ±Ÿíÿ∂Ÿè ŸàŸéÿ∑ŸéŸÜŸå ŸàŸéŸ±ŸÑŸíÿ•ŸêŸÜŸíÿ≥ŸéÿßŸÜŸêŸäŸëŸéÿ©Ÿè ŸÖŸèŸàŸéÿßÿ∑ŸêŸÜŸèŸáŸéÿß", en: "The earth is one country, and mankind its citizens.", ur: "ÿ≤ŸÖ€åŸÜ ÿß€å⁄© Ÿàÿ∑ŸÜ €Å€í ÿßŸàÿ± ÿßŸÜÿ≥ÿßŸÜ€åÿ™ ÿßÿ≥ ⁄©€í ÿ¥€Åÿ±€å €Å€å⁄∫€î" } },
        none: { general: { ar: "", en: "Ethics: choose truth, compassion, and responsibility.", ur: "ÿßÿÆŸÑÿßŸÇ: ÿ≥⁄Üÿå €ÅŸÖÿØÿ±ÿØ€å ÿßŸàÿ± ÿ∞ŸÖ€Å ÿØÿßÿ±€å ⁄©Ÿà ÿ™ÿ±ÿ¨€åÿ≠ ÿØ€å⁄∫€î" } }
      };

      const lang = state.settings.faith.translation === "auto" ? autoTranslationLang() : state.settings.faith.translation;
      const b = pack[belief] || pack.none;
      const t = b[topic] || b.general || pack.none.general;

      const statement = t.ar || (belief==="none" ? "" : "");
      const translation = (lang==="ur" ? (t.ur || t.en) : (lang==="ar" ? (t.ar || t.en) : (t.en || t.ur)));

      return { statement, translation };
    }

    function refreshFaithUI(){
      const belief = state.settings.faith.belief;
      const topic = state.settings.faith.topic;
      const {statement, translation} = getFaithStatement(belief, topic);
      els.faithStatement.textContent = statement || "(No statement for 'None')";
      els.faithStatementTranslation.textContent = translation || "";
    }

    /*********************
     *  Identity storage + Hub hook
     *********************/
    function saveUserIdentity(data){
      state.userIdentity = data;
      safeSaveJSON(KEY_USER, data);
    }
    function loadIdentityIntoForm(){
      const d = state.userIdentity || {};
      els.uName.value = d.name || "";
      els.uNick.value = d.nick || "";
      els.uOrigin.value = d.origin || "";
      els.uPlace.value = d.place || "";
      els.uProfession.value = d.profession || "";
      els.uEmotionalStyle.value = d.emotionalStyle || "";
      els.uKeyPeople.value = d.keyPeople || "";
      els.uLegacyRules.value = d.legacyRules || "";
    }

    function openIdentityHub(){
      try{
        window.open(IDENTITY_HUB_URL, "_blank", "noopener,noreferrer");
      }catch(e){
        location.href = IDENTITY_HUB_URL;
      }
    }

    function normalizeIdentityPayload(payload){
      const p = payload || {};
      return {
        name: (p.name ?? p.fullName ?? p.full_name ?? "").toString(),
        nick: (p.nick ?? p.nickname ?? "").toString(),
        origin: (p.origin ?? p.birthPlace ?? p.birth_place ?? "").toString(),
        place: (p.place ?? p.location ?? p.currentPlace ?? p.current_place ?? "").toString(),
        profession: (p.profession ?? p.role ?? p.title ?? "").toString(),
        emotionalStyle: (p.emotionalStyle ?? p.emotion_style ?? p.style ?? "").toString(),
        keyPeople: (p.keyPeople ?? p.key_people ?? p.people ?? "").toString(),
        legacyRules: (p.legacyRules ?? p.legacy_rules ?? p.rules ?? "").toString(),
        _importedAt: Date.now(),
        _source: p._source || "identity-hub"
      };
    }

    function importIdentityPayload(payload){
      const norm = normalizeIdentityPayload(payload);
      const current = state.userIdentity || {};
      const merged = { ...current };

      Object.keys(norm).forEach(k=>{
        if(k.startsWith("_")) { merged[k] = norm[k]; return; }
        const v = (norm[k] || "").trim();
        if(v) merged[k] = v;
      });

      saveUserIdentity(merged);
      loadIdentityIntoForm();
      showToast("Identity imported successfully");
    }

    async function importIdentityFromHub(){
      const ctrl = new AbortController();
      const timer = setTimeout(()=>ctrl.abort(), 6000);
      try{
        const res = await fetch(IDENTITY_HUB_JSON, { cache:"no-store", signal: ctrl.signal });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        importIdentityPayload(data);
      }catch(e){
        console.warn("Identity Hub import failed:", e);
        showToast("Hub import failed ‚Äî opening Hub");
        openIdentityHub();
      }finally{
        clearTimeout(timer);
      }
    }

    window.addEventListener("message",(ev)=>{
      const d = ev?.data;
      if(!d) return;
      if(d.type === "AURA_IDENTITY_EXPORT" && d.payload){
        importIdentityPayload(d.payload);
      }
    });

    els.btnEditIdentity.addEventListener("click", ()=>{
      const isReadOnly = els.uName.hasAttribute("readonly");
      document.querySelectorAll("#modalIdentity input, #modalIdentity textarea").forEach(x=>{
        if(isReadOnly) x.removeAttribute("readonly");
        else x.setAttribute("readonly", "readonly");
      });
      showToast(isReadOnly ? "Edit enabled" : "Edit locked");
    });

    els.btnSaveUserIdentity.addEventListener("click", ()=>{
      const data = {
        name: els.uName.value.trim(),
        nick: els.uNick.value.trim(),
        origin: els.uOrigin.value.trim(),
        place: els.uPlace.value.trim(),
        profession: els.uProfession.value.trim(),
        emotionalStyle: els.uEmotionalStyle.value.trim(),
        keyPeople: els.uKeyPeople.value.trim(),
        legacyRules: els.uLegacyRules.value.trim()
      };
      saveUserIdentity(data);
      document.querySelectorAll("#modalIdentity input, #modalIdentity textarea").forEach(x=>x.setAttribute("readonly","readonly"));
      showToast("Identity saved");
    });

    els.btnDeleteUserIdentity.addEventListener("click", ()=>{
      if(!confirm("Clear identity?")) return;
      saveUserIdentity(null);
      document.querySelectorAll("#modalIdentity input, #modalIdentity textarea").forEach(x=>{
        x.value = "";
        x.setAttribute("readonly","readonly");
      });
      showToast("Identity deleted");
    });

    els.btnOpenIdentityHub.addEventListener("click", openIdentityHub);
    els.btnImportIdentityHub.addEventListener("click", importIdentityFromHub);

    /*********************
     *  LLM (Offline / fallback)
     *********************/
    async function askLLM(prompt){
      const learned = findLearnedAnswer(prompt);
      if(learned) return { text: learned, source: "learned" };

      try{
        if(window.webllm){
          return { text: "Offline LLM placeholder response (WebLLM ready).", source: "offline-llm" };
        }
      }catch(e){}

      return { text: "I‚Äôm offline right now. Please teach me, or open the online helper later.", source: "fallback" };
    }

    /*********************
     *  Self-learning correction flow
     *********************/
    let correctionMode = null;

    function inferEmotion(userText, auraText){
      const t = (userText||"").toLowerCase();
      let emotion = "neutral";
      let polarity = 0;
      let intensity = 0;

      if(t.includes("love") || t.includes("thanks") || t.includes("good") || t.includes("great")){
        emotion="positive"; polarity=1; intensity=0.6;
      }
      if(t.includes("hate") || t.includes("bad") || t.includes("angry") || t.includes("wrong")){
        emotion="negative"; polarity=-1; intensity=0.7;
      }
      const category = isSmallTalk(userText) ? "small-talk" : "general";
      return { emotion, polarity, intensity, category };
    }

    function updateEmotionMetaUI(meta){
      els.mEmotion.textContent = meta.emotion;
      els.mPol.textContent = meta.polarity;
      els.mInt.textContent = meta.intensity;
      els.mCat.textContent = meta.category;
      refreshCapsules();
    }

    function setStatus(s){ els.statusLine.textContent = s; }

    async function respondToUser(userText){
      setStatus("Thinking‚Ä¶");
      const res = await askLLM(userText);
      const auraText = res.text;

      const meta = inferEmotion(userText, auraText);
      state.lastEmotion = meta;
      updateEmotionMetaUI(meta);

      addMessage("aura", auraText, meta);
      maybeAddToBM(userText, auraText);

      setStatus(`Answered (${res.source})`);
    }

    function handleUserInput(text){
      const t = (text||"").trim();
      if(!t) return;

      if(correctionMode && correctionMode.awaitConfirm){
        addMessage("user", t);
        if(t.toLowerCase()==="yes" || t.toLowerCase()==="y"){
          addLearnedQA(correctionMode.question, correctionMode.pendingAnswer);
          showToast("Saved as learned");
          addMessage("aura","Saved. Thank you. ‚úÖ");
        }else{
          addMessage("aura","Okay, I will not save it.");
        }
        correctionMode = null;
        return;
      }

      if(t.toLowerCase() === "*incorrect"){
        const lastAura = [...state.tm].reverse().find(x=>x.role==="aura");
        const lastUser = [...state.tm].reverse().find(x=>x.role==="user");
        if(!lastAura || !lastUser){
          addMessage("aura","I don't have enough context to correct. Ask a question first.");
          return;
        }
        correctionMode = { question: lastUser.text, lastAnswer: lastAura.text };
        addMessage("aura","Okay. Please provide the correct answer for that question.");
        return;
      }

      if(correctionMode && !correctionMode.awaitConfirm){
        addMessage("user", t);
        correctionMode.pendingAnswer = t;
        correctionMode.awaitConfirm = true;
        addMessage("aura", `Confirm: Save this as correct?\nQ: ${correctionMode.question}\nA: ${t}\nReply with Yes or No.`);
        return;
      }

      addMessage("user", t);
      respondToUser(t);
    }

    /*********************
     *  Events
     *********************/
    els.btnSend.addEventListener("click", ()=>{
      const t = els.userInput.value;
      els.userInput.value = "";
      handleUserInput(t);
    });

    els.userInput.addEventListener("keydown",(e)=>{
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        els.btnSend.click();
      }
    });

    els.btnOptions.addEventListener("click", ()=>openModal("modalOptions"));

    function openFromMenu(which){
      closeModal("modalOptions");
      openModal(which);
      if(which==="modalBM"){ pruneBM(); renderBMList(); }
      if(which==="modalHistory"){ pruneTM(); renderTMList(); }
      if(which==="modalIntelligence"){ renderIntel(); }
      if(which==="modalFaith"){ refreshFaithUI(); }
      if(which==="modalIdentity"){ loadIdentityIntoForm(); }
    }

    els.btnFaith.addEventListener("click", ()=>{ refreshFaithUI(); openModal("modalFaith"); });
    els.btnBM.addEventListener("click", ()=>{ pruneBM(); renderBMList(); openModal("modalBM"); });
    els.btnHistory.addEventListener("click", ()=>{ pruneTM(); renderTMList(); openModal("modalHistory"); });
    els.btnIntelligence.addEventListener("click", ()=>{ renderIntel(); openModal("modalIntelligence"); });
    els.btnIdentity.addEventListener("click", ()=>{ loadIdentityIntoForm(); openModal("modalIdentity"); });
    els.btnReadme.addEventListener("click", ()=>openModal("modalReadme"));

    els.miFaith.addEventListener("click", ()=>openFromMenu("modalFaith"));
    els.miBM.addEventListener("click", ()=>openFromMenu("modalBM"));
    els.miHistory.addEventListener("click", ()=>openFromMenu("modalHistory"));
    els.miIntelligence.addEventListener("click", ()=>openFromMenu("modalIntelligence"));
    els.miIdentity.addEventListener("click", ()=>openFromMenu("modalIdentity"));
    els.miReadme.addEventListener("click", ()=>openFromMenu("modalReadme"));

    els.btnApplyFaith.addEventListener("click", ()=>{
      state.settings.faith.belief = els.faithSelect.value;
      state.settings.faith.topic = els.faithTopic.value;
      state.settings.faith.translation = els.faithTranslation.value;
      safeSaveJSON(KEY_SETTINGS, state.settings);
      refreshFaithUI();
      showToast("Faith applied");
    });

    els.faithSelect.addEventListener("change", refreshFaithUI);
    els.faithTopic.addEventListener("change", refreshFaithUI);
    els.faithTranslation.addEventListener("change", refreshFaithUI);

    els.btnBMGeneratePrompt.addEventListener("click", ()=>{
      generateBMPrompt();
      showToast("BM prompt generated");
    });
    els.btnBMCopyPrompt.addEventListener("click", ()=>{
      copyToClipboard(els.bmPrompt.value || "");
    });
    els.btnBMDeleteAll.addEventListener("click", ()=>{
      if(!confirm("Delete all unlocked BM items?")) return;
      state.bm = state.bm.filter(x=>x.locked);
      safeSaveJSON(KEY_BM, state.bm);
      renderBMList();
      refreshCapsules();
      showToast("BM cleared (unlocked)");
    });
    els.btnBMSearchDate.addEventListener("click", ()=>{
      const d = els.bmDate.value;
      if(!d){ renderBMList(); return; }
      const filtered = state.bm.filter(x=>fmtDate(x.ts)===d);
      renderBMList(filtered);
    });

    function renderTMList(list = state.tm){
      els.tmList.innerHTML = "";
      if(!list.length){
        els.tmList.innerHTML = "<div class='small'>No TM items found.</div>";
        return;
      }
      list.forEach(x=>{
        const box = document.createElement("div");
        box.className = "msg aura";
        box.style.maxWidth = "100%";
        const lock = x.locked ? "üîí" : "üîì";
        box.textContent = `${lock} (${fmtDate(x.ts)})\n${x.role.toUpperCase()}: ${x.text}`;
        els.tmList.appendChild(box);
      });
    }

    els.btnTMDelete24h.addEventListener("click", ()=>{
      if(!confirm("Delete last 24h unlocked messages?")) return;
      const cutoff = nowTs() - (24*60*60*1000);
      state.tm = state.tm.filter(m=> m.locked || m.ts < cutoff);
      safeSaveJSON(KEY_TM, state.tm);
      renderChat();
      renderTMList();
      refreshCapsules();
      showToast("Deleted 24h unlocked");
    });

    els.btnTMDeleteAll.addEventListener("click", ()=>{
      if(!confirm("Delete all unlocked TM messages?")) return;
      state.tm = state.tm.filter(m=>m.locked);
      safeSaveJSON(KEY_TM, state.tm);
      renderChat();
      renderTMList();
      refreshCapsules();
      showToast("TM cleared (unlocked)");
    });

    els.btnTMSearchDate.addEventListener("click", ()=>{
      const d = els.tmDate.value;
      if(!d){ renderTMList(); return; }
      const filtered = state.tm.filter(x=>fmtDate(x.ts)===d);
      renderTMList(filtered);
    });

    els.btnIntelExport.addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(state.intel,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url; a.download="aurax_intelligence.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    els.btnIntelDeleteAll.addEventListener("click", ()=>{
      if(!confirm("Delete all unlocked intelligence Q/A?")) return;
      state.intel = state.intel.filter(x=>x.locked);
      safeSaveJSON(KEY_INTEL, state.intel);
      renderIntel();
      showToast("Intelligence cleared (unlocked)");
    });

    els.btnExport.addEventListener("click", ()=>{
      const payload = {
        tm: state.tm,
        bm: state.bm,
        intel: state.intel,
        settings: state.settings,
        userIdentity: state.userIdentity,
        exportedAt: new Date().toISOString()
      };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url; a.download="aurax_export.json";
      a.click();
      URL.revokeObjectURL(url);
      showToast("Exported");
    });

    els.btnVoice.addEventListener("click", ()=>{
      state.settings.voiceOn = !state.settings.voiceOn;
      safeSaveJSON(KEY_SETTINGS, state.settings);
      showToast(state.settings.voiceOn ? "Voice ON" : "Voice OFF");
    });

    /*********************
     *  Init
     *********************/
    function init(){
      state.tm = safeLoadJSON(KEY_TM, []);
      state.bm = safeLoadJSON(KEY_BM, []);
      state.intel = safeLoadJSON(KEY_INTEL, []);
      const s = safeLoadJSON(KEY_SETTINGS, null);
      if(s) state.settings = {...state.settings, ...s};
      state.userIdentity = safeLoadJSON(KEY_USER, null);

      pruneTM();
      pruneBM();

      els.faithSelect.value = state.settings.faith.belief || "none";
      els.faithTopic.value = state.settings.faith.topic || "general";
      els.faithTranslation.value = state.settings.faith.translation || "auto";
      refreshFaithUI();

      renderChat();
      renderBMList();
      renderTMList();
      renderIntel();
      loadIdentityIntoForm();
      refreshCapsules();
      setStatus("Ready");
    }

    init();
  </script>
</body>
</html>